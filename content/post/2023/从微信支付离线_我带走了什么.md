+++
title = "从微信支付离职，我带走了什么"
date = 2023-04-06T18:31:00-07:00
lastmod = 2023-04-07T17:45:19-07:00
tags = ["summary"]
categories = ["summary"]
draft = false
toc = true
+++

## <span class="section-num">1</span> 前言 {#前言}

从微信支付离职，我带走了什么？文档，代码，设计方案还是微信支付的漏洞？

如果我带走这些资产，那我现在就在深圳的看守所里面吃着公家饭了。

既然这些资产不能带走，那么我能带走什么？

如果沉下心思考，就会发现，这些资产价值并不大，对于工程师而言，也没有领导想象中的那么重要，除非我们试图将代码放在黑市售卖。

对于业务开发而言，也可能是同样的道理。业务开发每天对着业务需求做CRUD，可能会羡慕开发底层组件的工程师，可以学习并提升技术水平，而自己技术水平还是在原地打转，能学习到的东西随着时间的推移，越来越少。

王安石的《游褒禅山记》有这样的感叹：

> 夫夷以近，则遊者众；险以远，则至者少；而世之奇伟瑰怪非常之观，常在于险远，而人之所罕至焉；故非有志者，不能至也。

所谓的「险以远」，并不特指深奥难懂的底层组件技术，也指思考的深度；

如果多去思考技术和业务，挖掘背后的本质，我们也可以看到许多「世之奇伟瑰怪非常之观」


### <span class="section-num">1.1</span> 鱼与渔 {#鱼与渔}

文档，代码，设计都是针对特定问题的解决方案，如果离职到新公司之后，我们遇到的问题肯定不会完全一样，或者手头可用的工具不一样，那么这些资产的价值就会打折扣。

更何况这些资产都是「一次性的」，用完即止；是属于「授人以鱼不如授人以渔」中的「鱼」；是「生产线」上的「成品」，而我对能生产「成品」的「生产线」更感兴趣。

二战结束以后，美国把1600多名德国科学家、工程师、技术人员带到美国，包括沃纳.冯.布劳恩和他的V-2火箭研究团队；

而苏联凭借地理位置靠近德国占领了一些重要的工厂，比如著名的德国光学巨头卡尔蔡司公司，苏联几乎搬空了该公司的设备，把1万多台设备中的9000多台都搬到了苏联。

有人对现成的「鱼」感兴趣，也有人对未来的「渔」感兴趣，我属于后者。


## <span class="section-num">2</span> 思路 {#思路}

既然选择「渔」，那么，要怎么挑选适合的「渔」来丰富自己的「渔库」呢？

两千多年前的老师孔子就已经给出自己的答案：

> 见贤思齐焉，见不贤而内自省也

见到那些优秀的实践和思路，就学下来；对于有弊端的实践，就要分析弊端形成的原因，再想办法避免和改进，别人掉进去的坑，我们就不要进去凑热闹了。


## <span class="section-num">3</span> 贤 {#贤}


### <span class="section-num">3.1</span> 模式化 {#模式化}

1994年，4个博士合著了一本书，书中对常见的设计问题进行了分类，归纳与总结，并且针对每一类问题，给出可重用的解决方案。他们将这些可以复用的解决方案，称之为设计模式(design pattern)。

这本书也成为软件工程和面向对象设计经久不衰的经典。

这本书即是《设计模式：可复用面向对象软件的基础》(Design Patterns:
Elements of Reusable Object-Oriented Software)，这四位博士也被称为Gang of Four (GoF)

> A design pattern is the re-usable form of a solution to a design problem.

那么什么是模式呢？

按照另外一本经典名著《面向模式的软件架构卷一》的定义：

> 当专家求解一个问题时，他们一般不会发明一种和已有解决方案完全不同的方案来处理这个问题。他们往往想起已解决过的相似的问题，并重用其解法的精华来解决新问题。

在微信支付研发理念中，程序设计和开发，很多问题都是类似，或者是重复出现的。

针对此类重复问题，直接复制代码来解决，是下下策。

对代码进行抽象，复用代码来解决重复问题，也是下策。因为使用公共库会导致代码之间无法隔离，并且把逻辑隐藏在公共库，会导致无法分析代码的调用关系。

微信支付研发理念推崇的上策是对问题进行抽象，归纳出这类问题的通用解法，即模式；更进一步的是，为模式定义对应的代码模板，直接生成代码。

即使不生成代码，也可以将模式实现成对应的组件或库，方便直接调用。

具体例子如：

微信支付就总结常见的分布式事务场景，设计和开发了分布式事务编排中间件。通过在画板编排事务资源，即可生成对应的代码模板，开发者只需要在指定的地方编写个性化代码即可。

针对常见的领域服务，抽象了基于状态机和事件驱动的模型，设计了领域服务的代码生成组件。可通过绘制状态机UML图，直接生成接口代码，由开发者填充实现。

以上算是技术组件的模式化，对业务开发而言，还有对业务的模式化。

比如对扣款模式进行抽象，扣款时开启事务，进行风控校验，创建（或不创建）业务单，查询支付方式，轮询支付方式进行扣款，异常关单等。

当时组里的大神龙哥，就是对已有的扣款模式进行了抽象，基于面向对象，设计成同步扣款框架，定义了以上的接口，由业务进行继承和扩展。再使用同步扣款框架对已有的3个类似但不完全一致的代扣扣款业务进行了重构，把扣款模式都统一了。


### <span class="section-num">3.2</span> 复盘 {#复盘}

没有人能保证自己写的代码绝对不会出错，当错误与问题不期而至的时候，我们能做的就是将「错误」的效益最大化，即从「错误」中吸引教训，做到「不二过」。

复盘，就是在「错误」中吸引教训，做到「不二过」的手段。Amazon 也有类似的概念与机制，称为 Correctness Of Error(COE)

我们一直说「失败是成功之母」，但根据生物学常识，只有「成功才是成功之母」，或者说「小步的成功才是大步成功之母」，别人踩过的坑，我们就不要进去了。

复盘的一般步骤：

1.  回顾目标
2.  故障影响
3.  时间精确到分钟（甚至秒级别）的过程回顾。比如是新需求写出一级故障的bug, 就从拿到需求，设计方案，开发，部署上线，流量灰度，问题告警，处理手段，到故障排除，每个时间点操作都写下来。
4.  分析问题原因，挖掘导致故障的表面原因与根本原因
5.  总结针对问题的改进措施。
6.  落实改进措施

通过这样的复盘过程，确保同样的问题不会再次出现。

这样的工作方式和理念，无论是对个人还是组织，才同样适用。


### <span class="section-num">3.3</span> 全栈 {#全栈}

微信支付一直在推广全栈工程师，认为只从自己做的事情来思考问题，容易导致盲维和短板，看待问题的眼光容易受限。

此外，根据《人月神话》的理念，工程师之间的沟通成本，会随着人数的增加，呈指数水平上涨。而成为全栈工程师，可以一个人处理完需求，沟通成本就下降到0，极大地提交工作效率。

微信支付的全栈工程师定义是前端工程师 + 服务端工程师 + 数据开发工程师。

当然，某一端的开发工程师，不会某天突然自己变成全栈工程师，这些都是需要持续学习的，人总是需要不断提升自己的。

此外，全栈工程师是一个人能干三个人的活，而不是一个人要干三个人的活，不要把全栈当作让研发工程师加班的借口。


### <span class="section-num">3.4</span> 需求分析 {#需求分析}

每个工程师都需要做需求，与正确地做需求相比，做正确的需求显然更重要。

如何确保做正确的需求呢？

微信支付选择的方法论是：​需求分析与业务建模，脱胎自UML专家潘家宇的著作《软件方法》。大概的流程是：

1.  寻找老大（需要满足谁的诉求）
2.  寻找业务用例（业务执行者做什么事情，比如QQ音乐用户购买QQ音乐会员，就是一个业务用例）
3.  根据业务用例，寻找系统用例。（例如商户发起扣款是一个系统用例；扣款成功回调通知商户也是一个系统用例）
4.  将需求的业务规则，总结归纳成系统用例的规则。

当然，业务用例和系统用例这套东西，可能只有微信支付用。但找准客户，帮客户解决真正的痛点，创造真正的价值，这个是有普适性的。

做需求时，可以多问这两个问题：

1.  谁是我们的客户。
2.  我们在帮他们解决什么问题。


### <span class="section-num">3.5</span> “云雨伞” {#云雨伞}

“云雨伞”这个概念来自内部的一份PPT，讲述的是如何更好地向别人提出建议，内容大概是：

> 屋外乌云密布，儿子要出门，妈妈对儿子说，马上要下雨，淋雨容易生病，把伞带上吧。

“云雨伞”的步骤就是：

1.  指出现状：乌云密布，马上要下雨
2.  导致的问题与影响：淋雨容易生病
3.  提出措施和建议：把伞带上。

通过这样的表述方式，会比「把伞带上」这样直接命令的话，更容易让人接受。

当然，如果阅读过《非暴力沟通》，会发现“云雨伞”的表述，其实是《非暴力沟通》总结的有效沟通方式的简化版本：

1.  清楚地表达观察结果
2.  表达感受
3.  说出是什么需求和原因导致了这样的感受
4.  具体的请求

当然，总是强调「云雨伞」的做法，把问题归咎到提问者身上，我是不赞同的。

经常会出现的一种场景就是，好用的工具微信支付不让用，基于安全，闭环的原因，微信支付要自己基于已有接口封装一套。

比如腾讯的数据开发IDE Idex不被允许, 一定要切换到微信支付自己基于数平API包装的数据开发平台Xdata, 说有员工直接访问数据的风险，只能自己搞一套。

> 我：这个xx工具不好用，缺失了xx功能，Idex这个功能就做得很好。领导：那你给他们提需求阿！怎么不给他们提需求？让他们抄Idex嘛
>
> 你怎么知道我没有给他们提需求？
>
> 有个现成的Idex不能用，还要提需求让他们来抄Idex。
>
> 提了需求他们又不做不过来。
>
> 三轮车要抄多少东西，才能抄成卡罗拉。

领导经常说，提问题的时候，要把自己的解决方案也提出来，没有人喜欢听吐槽。

话虽如此，但是我想起之间还在蚂蚁时，一位P10工程师的文章，《没有答案，也可以提问题》。

提问题是为了帮助组织发现问题，如果不能吐槽的话，很多问题也不会被发现，自然也得不到解决，毕竟也没有人喜欢帮别人的问题提解决方案。


### <span class="section-num">3.6</span> 一致性 {#一致性}

领导总说，软件工程的本质就是管理和控制复杂度，而一致性就是减少复杂度的有力工具。所谓的一致性，可以理解成统一的流程，统一的组件等等

在这种理念的驱动下，微信支付内部使用统一的编程语言，统一的工具库，统一的存储组件（使用别的存储需要特殊审批和说明），统一的数据访问组件，使用统一的研发流程。

保证每个研发工程师，即使调到微信支付的其他团队，也是使用同样的工具，即插即用，和车床生产的螺丝一样。

开始我对这样的理念是持支持态度的，但到AWS以后，我的想法发生了动摇。

因为我发现AWS的工具真的是琳琅满目，应有尽有，而Amazon也并未对使用什么样的组件作要求。

反正AWS对各种组件的支持都很好，所以业务团队可以自行选择适合自身业务的任意组件，能完成需求就好。

所以我现在不确定，通过追求一致性来降低复杂度这样的做法是否合理。


### <span class="section-num">3.7</span> 设计优于实现 {#设计优于实现}

从2020年初起，微信支付内部的需求都需要先写设计文档，Leader 评审通过才能开发。

设计时有个非常关键的点，就是列出所有能想到的可行方法，而后比较各个方案的优劣，再作出取舍，选择最终方案。

软件工程没有银弹，系统/软件设计就是不断地在做取舍，当然，人生也是。

设计才是最重要的，而编码和实现都是简单的，因为这只是水到渠成的事（我也不是说可以不用重视代码质量，毕竟这是吃饭的手艺）

我个人觉得，对于业务开发（或者对于软件工程师）而言，不要过多花时间关注在编码上，而应该是花时间思考需求和问题，找到好的设计上。

良好设计带来的红利，是要多于良好编码带来的红利的。

如果把编码比作战术，设计就是战略，不要让战术的勤奋，掩盖了战略上的懒惰。

编码算是建筑的外墙和玻璃，而设计就是承重墙和地基，毕竟换皮容易换根难。

微信支付对于业务代码的态度是，能生成就尽量生成，就不要人写了，要多花些时间在设计上。

当然，这不应该是缩减开发排期，让开发加班的借口。


## <span class="section-num">4</span> 不贤 {#不贤}


### <span class="section-num">4.1</span> 重审批流 {#重审批流}

微信支付的流程都非常重，开发的流程都会有审批流，如代码部署上线，需要两级审批，直属Leader 审批 + 二级Leader（总监）审批。

或者在DevOps 系统申请新增某个模块的备份负责人，也需要总监审批；

非模块负责人发布某个模块，申请临时发布权限，需要总监审批；发布时，又要两级审批。

微信支付被认定为「关键金融基础设施」，以及是国民支付应用，需要通过审批来降低和控制风险。

按照领导的话，审批的目的是：

1.  领导知情，评估风险
2.  出事领导帮忙担责。

话虽如此，但个人认为通过人肉审批来控制和降低风险，是一件很不可靠的事。

像现在这样事事需要审批，加个模块备份负责人都需要审批，一个中心40人，每人每天提3个审批单，总监就需要审批120 个审批单，总监是否真的能Review 到每个审批单的变更内容和风险呢？

另外一个是对效率的影响，总监成为流程的潜在阻塞点。当然，也可以电话或企业微信催总监审批，但不是十万火急，谁又会电话催二级主管审批呢。

这样的审批只会造成一种「虚假」的忙碌，提审批单和审批的人都很繁忙地工作，但是这是必要的吗，又起到多大的作用的呢，是否有其他更优解？

如果每个环节都有人工审批，又如何做持续部署呢（Continuous Deployment ）？

所以微信支付只有CI，没有CD。

窃以为应该通过工具来控制和降低风险，这个又和后面的「工具文化」话题相关了。


### <span class="section-num">4.2</span> 半自动化 {#半自动化}

领导一直在微信支付强调，流程要闭环，做事要有始有终，发现的问题要及时处理。

为了贯彻领导的理念，及时发现和处理问题，微信支付内部研发了「SOA治理系统」，会定义各种的扫描和检测规则，发生工单推送给研发人员。

例如服务配置文件使用错误或者废弃的配置值；配置文件超过1000行；或者监控告警中包含已离职的员工，都会给负责的员工发送工单。

并且对应的企业微信机器人每天推送工单信息，督促研发人员处理；也提供了一键拉群功能，把研发人员的Leader，总监拉到一个新群，督促研发人员处理。

{{< figure src="/ox-hugo/任务提醒.png" >}}

问题检测能使用脚本自动扫描，问题推送能使用机器人自动推送，但是解决问题就需要研发人员手动解决。

这种自动化发活，催活；人肉处理的机制，我愿将此称之为「 ****半自动化**** 」机制。

{{< figure src="/ox-hugo/数据治理告警.png" >}}

如果都能提供工具扫描出问题了，为什么不能提供工具一键修复呢？

起码做个工具，帮忙一键生成发布单，并包含需要修改的内容。

而不是像现状那样，工具告诉研发需要修改什么内容，由研发手动生成发布单，手动修改配置，再手动发布；又因为各种高压线的要求，发布时一定要盯着各种监控，工作效率自然降低了。

类似的情况还不是少数。

比如2022年新定义了一个指标，叫「发布前置时间」，即合并到master 后未发布的代码等待时间，不能超过7天。

代码合并太久未发布，容易夹带其他特性，扩大变更的影响面。所以又搞了一个机器人，每天定时催促研发发布已合并的代码。

{{< figure src="/ox-hugo/发布前置.png" >}}

搞这么多指标和概念，还不如把持续部署（Continuous Deployment）搞上去，那才是解决问题的方向嘛。

不要做南辕北辙，似是而非的事。

按照「SOA治理系统」团队的话，我们只帮忙发现问题，不负责解决问题，解决问题是业务团队自己的事。

管杀不管埋了


### <span class="section-num">4.3</span> 缺失工具文化 {#缺失工具文化}

无可否认，微信支付在业务上获得巨大的成功，即使放之全球，所取得的成就也是令人瞩目的。

但是取得的成功不是通过技术达成的，又因为业务的成果相当部分来源于当初产品的快速上线试错，就会导致领导对工具重视度不高，有种「又不是又不能用的」的文化。

此外，领导觉得「工具」不用花太多时间，去做得太完美，80分就够了。所谓求其上者得其中，求其中者得其下，求其下者无所得。

而微信支付又偏偏喜欢自己造工具，微信支付是「关键金融基础设施」，需要很多自己的研发支撑工具，不使用微信或腾讯的已有工具

兼之内部的「又不是不能用」+「先人肉顶着，后面再优化」的思路，就导致缺少好用的工具。

---
一个关于微信支付工具的小彩蛋，微信支付内部的工具和平台，都是 `x` 开头的，如 `xphp`, `xcgi`, `xcontract`, `xboard` 等等。

但很多微信支付内部的同学都不知道以 `x` 开头的缘由。

因为领导说，微信支付不止业务要做到世界前列，技术也要做到世界前列。

所以我们要做「牛x」的工具，但我们现在的工具还不「牛」，所以先把「牛」去掉，所以就只剩下 `x` 了。

---

当然不是说「工具文化」应该是我们追求的目标，只是说「工具文化」可以推动，促进产出让工程师更易用的工具和组件，进而提高工程师的工作效率，节省下来的时间又可以投入开发其他需求或工具。

Perl语言之父Larry Wall 有句广为人知的名言：「程序员要有三大美德：急躁，懒惰，自大」。

-   急躁意味着不愿意花时间等待缓慢的程序，会想办法优化程序；
-   自大意味着不愿让人指谪，对自身要求强，要写出高质量的代码；
-   懒惰意味着不想花精心做重复无用的事情，会想办法自动化，让电脑帮忙处理。

> "We will encourage you to develop the three great virtues of a programmer: laziness, impatience, and hubris." -- LarryWall


### <span class="section-num">4.4</span> 权力驱动 {#权力驱动}

微信支付要推广某样东西，常见的做法就是总经理向总监和组长宣讲，组长再回小组同步，然后大群周知，然后在微信支付内部全量发布，再和晋升考核挂钩。

举例，微信支付要求大家都要写出高质量的代码，然后会在晋升考核时，由代码评审委员会对晋升者代码进行评审和打分，分成S,A,B,C四级，如果打分是C的，即使答辩通过，也不能晋升。

后来对Merge Request的描述也有要求了，描述为空，或者未按标准把需求单，变更描述，测试方法写上，代码评审也是不通过，答辩通过也没法晋升。

再举例，微信支付要推广数据治理，要求数据告警都要及时被处理，7天未处理就当逾期，然后就有一个告警处理及时率，又会和晋升挂钩。

{{< figure src="/ox-hugo/质量告警.png" >}}

除此之外，还有各种的研发高压线，触摸到这样的高压线，绩效就要被打差，年终就基本等于没有。比如部署代码后，要观察30分钟不能走开；上线必须要有领导审批；主干代码不能有任何的桩(Mock/Stub)代码等等。

但我理解，通过代码评审打分只是手段，而不是目的。

目的是为了提高代码质量，数据治理也是同样的道理，应该开发更多的工具，前置作检查和拦截，更早地给研发反馈（比如Jetbrains家的IDE，就能实时分析项目的复杂度和复杂度，实时给出重构的建议），而不是后面再回来算账。

何况这样的手段强推某个措施，只会让研发觉得生硬与缺乏尊重。

如前文提到的「数据告警处理及时率」，直至宣布和晋升挂钩，都没有周知给一线研发。负责人称已经周知给总监，虽然总监既不做数据开发，也不会自己配置告警。

前面提到的「SOA治理」工单也是类似的处理思路。领导会在例会上质询总监，为什么所负责的中心还有这么SOA工单未处理，总监又把压力传导到组长，组长再把压力给到一线研发。

如果解决问题的驱动力都是权力或者晋升这样的强制力量，那么一旦这样的驱动力消失，这套机制就有可能会瓦解。

最好的驱动力应该是自驱力。


## <span class="section-num">5</span> 总结 {#总结}

拿走「代码，文档」终究是术，拿走「思想和理念」才是道。

这些就是我从微信支付拿走的资产。
