+++
title = "ä¸€æ¡ç»å…¸é¢è¯•é¢˜çš„é”™è¯¯ç­”æ¡ˆå¼•å‘çš„æ€è€ƒ"
date = 2019-03-21T11:04:00+08:00
lastmod = 2022-02-25T09:54:27+08:00
tags = ["java"]
categories = ["java"]
draft = false
toc = true
showQuote = true
+++

æµ…è°ˆJavaå…¬å¹³é”ä¸å†…å­˜æ¨¡å‹


## <span class="section-num">1</span> å‰è¨€ {#å‰è¨€}

æ˜¥å¤©æ¥äº†ï¼Œæ˜¥æ‹›è¿˜ä¼šè¿œä¹ˆ? åˆåˆ°äº†æ˜¥æ‹›çš„å­£èŠ‚ï¼Œéšä¹‹è€Œæ¥çš„æ˜¯å„ç§çš„é¢è¯•é¢˜ã€‚ä»Šå¤©å°±çœ‹åˆ°ç»„å†…å¤§ä½¬é¢è¯•å®ä¹ ç”Ÿçš„ä¸€é“Javaé¢˜ç›®:

> ç¼–å†™ä¸€ä¸ªç¨‹åºï¼Œå¼€å¯ 3 ä¸ªçº¿ç¨‹A,B,Cï¼Œè¿™ä¸‰ä¸ªçº¿ç¨‹çš„è¾“å‡ºåˆ†åˆ«ä¸º
> Aã€Bã€Cï¼Œæ¯ä¸ªçº¿ç¨‹å°†è‡ªå·±çš„ è¾“å‡ºåœ¨å±å¹•ä¸Šæ‰“å° 10
> éï¼Œè¦æ±‚è¾“å‡ºçš„ç»“æœå¿…é¡»æŒ‰é¡ºåºæ˜¾ç¤ºã€‚å¦‚ï¼šABCABCABC....


## <span class="section-num">2</span> ç»è¿‡ {#ç»è¿‡}

å‡ºäºå¥½å¥‡çš„å¿ƒæ€ï¼Œæˆ‘èŠ±äº†ç‚¹æ—¶é—´æ¥å°è¯•è§£å†³è¿™ä¸ªé—®é¢˜, ä¸»è¦çš„éš¾ç‚¹æ˜¯è®©çº¿ç¨‹é¡ºåºåœ°å¦‚ä½•é¡ºåºåœ°è¾“å‡ºï¼Œçº¿ç¨‹ä¹‹é—´å¦‚ä½•äº¤æ¢ã€‚

å¾ˆå¿«å°±æŒ‰ç€æ€è·¯å†™å‡ºäº†ä¸€ä¸ªç‰ˆæœ¬ï¼Œç”¨Lock æ¥æ§åˆ¶çº¿ç¨‹çš„é¡ºåºï¼ŒA,B,Cçº¿ç¨‹ä¾æ¬¡å¯åŠ¨ï¼Œå› ä¸ºAçº¿ç¨‹å…ˆå¯åŠ¨ï¼Œæ‰€ä»¥Açº¿ç¨‹ä¼šæœ€å…ˆæ‹¿åˆ°é”ï¼ŒB,Cé˜»å¡ï¼›ä½†æ˜¯Aè¾“å‡ºå®Œå­—ç¬¦ä¸²ï¼Œé‡Šæ”¾é”ï¼ŒB çº¿ç¨‹è·å¾—é”ï¼ŒC,Açº¿ç¨‹é˜»å¡; ä¾æ­¤å¾ªç¯:

```java
public void Test(){
    private static Integer index = 0;

    Lock lock = new ReentrantLock();

    @Test
	public void testLock(){
	Thread threadA = work(i -> i % 3 == 0, () -> System.out.println("A"));
	Thread threadB = work(i -> i % 3 == 1, () -> System.out.println("B"));
	Thread threadC = work(i -> i % 3 == 2, () -> System.out.println("C"));
	threadA.start();
	threadB.start();
	threadC.start();
    }

    private Thread work(Predicate<Integer> condition, Runnable function) {
	return new Thread(() -> {
		while (index < 30) {
		    lock.lock();
		    if (condition.test(index)) {
			function.run();
			index++;
		    }
		    lock.unlock();
		}
	});
    }
}
```

è¾“å…¥ç»“æœå¦‚æˆ‘é¢„æœŸé‚£èˆ¬ï¼ŒABCABCäº¤æ›¿è¾“å‡ºï¼Œä¹ŸæˆåŠŸè¾“å‡ºäº†10æ¬¡ï¼Œå¥‡æ€ªçš„æ˜¯A,Bå´å¤šè¾“å‡ºäº†ä¸€æ¬¡ï¼Ÿ
![](https://imgur.com/3lolbwK.png)

ä¸ºä»€ä¹ˆä¼šå¤šè¾“å‡ºä¸€æ¬¡ï¼Œä¸æ˜¯åº”è¯¥æ°å¥½æ˜¯è¾“å‡º30æ¬¡ä¹ˆ, ä¸ºä»€ä¹ˆä¼šå¤šè¾“å‡ºä¸€æ¬¡A,B
çœŸçš„ç™¾æ€ä¸å¾—å…¶è§£. æ‰€ä»¥æˆ‘æŠŠ`index` ä¹Ÿæ‰“å°å‡ºæ¥æŸ¥çœ‹, ç»“æœç›¸å½“å¥‡æ€ª:

```java
...
    function.run();
System.out.println(index);
....
```

ä¸ºä»€ä¹ˆA ä¼šæ˜¯30, Bä¼šæ˜¯31, ä¸æ˜¯æœ‰(index.intvalue&lt;30) çš„æ¡ä»¶åˆ¤æ–­ä¹ˆ,
ä¸ºä»€ä¹ˆè¿˜ä¼šå‡ºç°è¿™æ ·çš„æ•°æ®ï¼Ÿçµå¼‚äº‹ä»¶? ![](https://imgur.com/fhurKt5.png)


## <span class="section-num">3</span> è§£æƒ‘ {#è§£æƒ‘}

çµå¼‚äº‹ä»¶è‡ªç„¶æ˜¯ä¸å­˜åœ¨çš„ï¼Œä»”ç»†åˆ†æäº†ä¸€ç•ªä»£ç ä¹‹åï¼Œå‘ç°äº†é—®é¢˜ï¼š

```java
while (index.intValue() < 30) {  // 1
    lock.lock(); // 2
    if (condition.test(index.intValue())) {
	function.run();
	index++;
    }
    lock.unlock();
}
```

å°†1ï¼Œ2è¡Œçš„æ“ä½œåšäº†è¿™ä¸‰ä»¶äº‹ï¼Œå¦‚ä¸‹:

1.  **çº¿ç¨‹è¯»å–indexçš„å€¼**
2.  æ¯”è¾ƒindexçš„å€¼æ˜¯å¦å¤§äº30 3. å¦‚æœå°äº30, å°è¯•è·å–é”

æ¢è¨€ä¹‹ï¼Œå½“index=29æ—¶ï¼Œçº¿ç¨‹CæŒæœ‰é”ï¼Œä½†æ˜¯é”åªèƒ½é˜»æ­¢çº¿ç¨‹A,çº¿ç¨‹Bä¿®æ”¹indexçš„å€¼ï¼Œå¹¶ä¸èƒ½é˜»æ­¢çº¿ç¨‹A,çº¿ç¨‹Båœ¨è·å–é”ä¹‹å‰è¯»å–indexçš„å€¼ï¼Œæ‰€ä»¥çº¿ç¨‹Aè¯»å–index=29,å¹¶æŠŠå€¼ä¿æŒåˆ°çº¿ç¨‹çš„å†…éƒ¨ï¼Œå¦‚ä¸‹å›¾:

{{< figure src="https://imgur.com/tI8NTgO.png" >}}

**å½“çº¿ç¨‹Cæ‰§è¡Œå®Œï¼Œè¿˜æ²¡é‡Šæ”¾é”çš„æ—¶å€™ï¼Œçº¿ç¨‹Açš„indexå€¼ä¸º29ï¼›å½“çº¿ç¨‹Cé‡Šæ”¾é”ï¼Œçº¿ç¨‹Aè·å–é”ï¼Œè¿›å…¥åŒæ­¥å—çš„æ—¶å€™ï¼Œå› ä¸º [Javaå†…å­˜æ¨¡å‹æœ‰å†…å­˜å¯è§æ€§çš„è¦æ±‚](https://en.wikipedia.org/wiki/Memory_barrier#Multithreaded_programming_and_memory_visibility), å…¼ä¹‹Lockçš„å®ç°ç±»å®ç°äº†[å†…å­˜å¯è§](https://stackoverflow.com/questions/12429818/does-explicit-lock-automatically-provide-memory-visibility)ï¼Œæ‰€ä»¥çº¿ç¨‹Açš„indexå€¼ä¼šå˜æˆ30**,

è¿™å°±è§£æäº†ä¸ºä»€ä¹ˆçº¿ç¨‹A index=30çš„æ—¶å€™èƒ½è·³è¿‡`(index.intValue<30)`çš„åˆ¤æ–­æ¡ä»¶ï¼Œå› ä¸ºæ‰§è¡Œè¿™ä¸ªåˆ¤æ–­æ¡ä»¶çš„æ—¶å€™çº¿ç¨‹A index=29, è¿›å…¥åŒæ­¥å—ä¹‹åå˜æˆäº†30:

{{< figure src="https://imgur.com/xaA4Q0y.png" >}}

æŠŠé—®é¢˜å‰–ææ¸…æ¥šä¹‹åï¼Œè§£å†³æ–¹æ¡ˆå°±å‘¼ä¹‹æ¬²å‡ºäº†:

```java
while (index.intValue() < 30) {  // 1
    lock.lock(); // 2
    if(index>=30){
	continue;
    }
    if (condition.test(index.intValue())) {
	function.run();
	index++;
    }
    lock.unlock();
}
```

è¿™ç§è§£å†³æ–¹æ³•ä¸ç¦è®©æˆ‘æƒ³èµ·å•ä¾‹æ¨¡å¼é‡Œé¢çš„åŒé‡æ ¡éªŒ:

```java
public static Singleton getSingleton() {
    if (instance == null) {                         //Single Checked
	synchronized (Singleton.class) {
	    if (instance == null) {                 //Double Checked
		instance = new Singleton();
	    }
	}
    }
    return instance ;
}
```

åªæ˜¯å½“æ—¶å¹¶ä¸æ¸…æ¥šDouble Checkedçš„ä½œç”¨ï¼Œç©¶ç«Ÿè§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ

åªæ˜¯çŸ¥é“ä¸åŠ è¿™æ¡è¯­å¥å°±ä¼šé€ æˆåˆå§‹åŒ–å¤šä¸ªç¤ºä¾‹ï¼Œçš„ç¡®æ˜¯éœ€è¦**çŸ¥å…¶ç„¶çŸ¥å…¶æ‰€ä»¥ç„¶**.


## <span class="section-num">4</span> å…¬å¹³é”é—®é¢˜ {#å…¬å¹³é”é—®é¢˜}

å‰æ–‡è¯´åˆ°ï¼Œ

> è¿™ä¸ªç¨‹åºæ˜¯ç”¨Lock æ¥æ§åˆ¶çº¿ç¨‹çš„é¡ºåºï¼ŒA,B,Cçº¿ç¨‹ä¾æ¬¡å¯åŠ¨ï¼Œå› ä¸ºAçº¿ç¨‹å…ˆå¯åŠ¨ï¼Œæ‰€ä»¥Açº¿ç¨‹ä¼šæœ€å…ˆæ‹¿åˆ°é”ï¼ŒB,Cé˜»å¡ï¼›
>
> ä½†æ˜¯Aè¾“å‡ºå®Œå­—ç¬¦ä¸²ï¼Œé‡Šæ”¾é”ï¼ŒB çº¿ç¨‹è·å¾—é”ï¼ŒC,Açº¿ç¨‹é˜»å¡; ä¾æ­¤å¾ªç¯ã€‚

ç²—çœ‹ä¼¼ä¹æ²¡ä»€ä¹ˆé—®é¢˜, ä½†æ˜¯è¿™é‡Œæ˜¯å­˜åœ¨ç€ä¸€ä¸ªé—®é¢˜: å½“çº¿ç¨‹Aé‡Šæ”¾é”çš„æ—¶å€™ï¼Œè·å–é”çš„æ˜¯å¦ä¸€å®šæ˜¯çº¿ç¨‹B, è€Œä¸æ˜¯çº¿ç¨‹C,
çº¿ç¨‹Cæ˜¯å¦èƒ½å¤Ÿâ€æ’é˜Ÿâ€æŠ¢å é”?

è¿™ä¸ªå°±æ¶‰åŠåˆ°äº†å…¬å¹³é”å’Œéå…¬å¹³é”çš„å®šä¹‰äº†:

-   å…¬å¹³é”: çº¿ç¨‹Cä¸èƒ½æŠ¢å ï¼Œåªèƒ½æ’é˜Ÿç­‰å¾…çº¿ç¨‹B è·å–å¹¶é‡Šæ”¾é”
-   éå…¬å¹³é”ï¼šçº¿ç¨‹Cèƒ½æŠ¢å ï¼ŒæŠ¢åˆ°é”ä¹‹åçº¿ç¨‹Båªèƒ½ç»§ç»­ç­‰(æœ‰ç‚¹æƒ¨!)

    è€ŒReentrantLocké»˜è®¤æ°å¥½æ˜¯éå…¬å¹³é”, æŸ¥çœ‹æºç å¯çŸ¥:

    ```java
    /**
    â€‹ * Creates an instance of {@code ReentrantLock}.
    â€‹ * This is equivalent to using {@code ReentrantLock(false)}.
     */
    public ReentrantLock() {
        sync = new NonfairSync();
    }
    ```

    å› æ­¤ä¸ºäº†è§„é¿éå…¬å¹³é”æŠ¢å çš„é—®é¢˜, ä¸Šè¿°çš„ä»£ç åœ¨åŒæ­¥å—å¢åŠ äº†åˆ¤æ–­æ¡ä»¶:

    ```java
    if (condition.test(index.intValue())) {
        ....
    	}
    ```

    åªæœ‰ç¬¦åˆæ¡ä»¶çš„çº¿ç¨‹æ‰èƒ½è¿›è¡Œæ“ä½œï¼Œå¦åˆ™å°±æ˜¯çº¿ç¨‹è‡ªæ—‹.(ä½†æ˜¯åŠ é”+è‡ªæ—‹å®ç°èµ·æ¥ï¼Œæ•ˆç‡ä¸ä¼šå¤ªé«˜æ•ˆ!)


## <span class="section-num">5</span> å°ç»“ {#å°ç»“}

å†™ä¸€æ¡é¢è¯•é¢˜çš„ç­”æ¡ˆéƒ½å†™å¾—æ˜¯é—®é¢˜å¤šå¤šçš„ï¼Œä¸ç¦ä»¤äººæ²®ä¸§ï¼Œè¯´æ˜è‡ªå·±å¯¹Javaçš„å¹¶å‘æ¨¡å‹ç†è§£è¿˜æœ‰å¾ˆå¤§çš„æé«˜ã€‚
ä¸è¿‡åœ¨æ’æŸ¥é—®é¢˜çš„è¿‡ç¨‹ä¸­ï¼Œé€šè¿‡å®è·µæœ‰ä½“æ„Ÿåœ°ç†è§£äº†Javaçš„å†…å­˜æ¨¡å‹ï¼Œå‘ç°Javaå†…å­˜æ¨¡å‹å¹¶ä¸æ˜¯é‚£ä¹ˆåœ°æ›²é«˜å’Œå¯¡ï¼Œåœ¨æ—¥å¸¸çš„å¼€å‘ä¸­ä¹Ÿæ˜¯å¾ˆå¸¸è§çš„.

è´¹äº†ä¸€ç•ªå·¥å¤«æ’æŸ¥ä¹‹åï¼Œç»ˆç©¶æ˜¯æœ‰æ–°çš„æ”¶è·çš„

<div center class="qr-container">
<img src="/ox-hugo/qrcode_gh_e06d750e626f_1.jpg" alt="qrcode_gh_e06d750e626f_1.jpg" width="160px" height="160px" center="t" class="qr-container" />
å…¬å·åŒæ­¥æ›´æ–°ï¼Œæ¬¢è¿å…³æ³¨ğŸ‘»
</div>

