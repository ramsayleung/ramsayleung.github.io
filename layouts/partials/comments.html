<section>
  <h2>Comments</h2>
  <div id="comments-giscus"></div>
</section>

<script type="text/javascript">

function getCurrentTheme() {
  return document.documentElement.getAttribute('data-theme') || document.body.classList.contains('dark') ? 'dark' : 'light';
}

function loadComment(darkMode=false) {
  const currentUrl = URL.parse(window.location.href); 
  const paths = currentUrl.pathname.split('/').filter(x => x!= '');
  const isChinese = paths.length > 0 && paths[0] == "zh";
  const commentContainer = document.getElementById("comments-giscus");
  if (commentContainer !== null) {
    commentContainer.innerHTML = ''
    const commentScript = document.createElement("script");
    commentScript.setAttribute("src", "https://giscus.app/client.js");
    commentScript.setAttribute("data-repo", "ramsayleung/comment");
    commentScript.setAttribute("data-repo-id", "MDEwOlJlcG9zaXRvcnkzMDk2NjQ1NDk=");
    commentScript.setAttribute("data-category", "General");
    commentScript.setAttribute("data-category-id", "DIC_kwDOEnUbJc4Cltnz");
    commentScript.setAttribute("data-mapping", "pathname");
    commentScript.setAttribute("data-strict", "0");
    commentScript.setAttribute("data-reactions-enabled", "1");
    commentScript.setAttribute("data-emit-metadata", "0");
    commentScript.setAttribute("data-input-position", "bottom");
    commentScript.setAttribute("data-theme", darkMode ? "dark" : "light");
    commentScript.setAttribute("crossorigin", "anonymous");
    commentScript.setAttribute("data-lang", isChinese ? "zh-CN": "en");
    commentScript.setAttribute("async", "true");
    commentContainer.appendChild(commentScript);
  }
}

const isDarkMode = getCurrentTheme() === 'dark';
loadComment(isDarkMode);

// Watch for theme changes
const themeObserver = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
          const isDarkMode = getCurrentTheme() === 'dark';
          loadComment(isDarkMode);
          console.log(`changing theme`);
        }
    });
});

// Start observing the body element for class changes
themeObserver.observe(document.body, { 
    attributes: true, 
    attributeFilter: ['class'] 
});

</script>
