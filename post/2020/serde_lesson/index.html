<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge,chrome=1">
<title>Serde Tricks - In Pursuit of Hubris</title>
<meta name=renderer content="webkit">
<meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1">
<meta http-equiv=cache-control content="no-transform">
<meta http-equiv=cache-control content="no-siteapp">
<meta name=theme-color content="#f8f5ec">
<meta name=msapplication-navbutton-color content="#f8f5ec">
<meta name=apple-mobile-web-app-capable content="yes">
<meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec">
<meta name=author content="Ramsay Leung"><meta name=description content="The lesson learned from refactoring rspotify
1 Preface Recently, I and Mario are working on refactoring rspotify, trying to improve performance, documentation, error-handling, data model and reduce compile time, to make it easier to use. (For those who has never heard about rspotify, it is a Spotify HTTP SDK implemented in Rust).
I am partly focusing on polishing the data model, based on the issue created by Koxiaet.
Since rspotify is API client for Spotify, it has to handle the request and response from Spotify HTTP API."><meta name=keywords content="Blog,Software,Enginering">
<meta name=generator content="Hugo 0.92.2 with theme even">
<link rel=canonical href=https://ramsayleung.github.io/post/2020/serde_lesson/>
<link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png>
<link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png>
<link rel=manifest href=/manifest.json>
<link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5>
<script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
<link href=/sass/main.min.b5a744db6de49a86cadafb3b70f555ab443f83c307a483402259e94726b045ff.css rel=stylesheet>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin=anonymous>
<meta property="og:title" content="Serde Tricks">
<meta property="og:description" content="The lesson learned from refactoring rspotify
1 Preface Recently, I and Mario are working on refactoring rspotify, trying to improve performance, documentation, error-handling, data model and reduce compile time, to make it easier to use. (For those who has never heard about rspotify, it is a Spotify HTTP SDK implemented in Rust).
I am partly focusing on polishing the data model, based on the issue created by Koxiaet.
Since rspotify is API client for Spotify, it has to handle the request and response from Spotify HTTP API.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://ramsayleung.github.io/post/2020/serde_lesson/"><meta property="article:section" content="post">
<meta property="article:published_time" content="2020-12-13T22:29:00+08:00">
<meta property="article:modified_time" content="2022-02-24T14:56:34+08:00">
<meta itemprop=name content="Serde Tricks">
<meta itemprop=description content="The lesson learned from refactoring rspotify
1 Preface Recently, I and Mario are working on refactoring rspotify, trying to improve performance, documentation, error-handling, data model and reduce compile time, to make it easier to use. (For those who has never heard about rspotify, it is a Spotify HTTP SDK implemented in Rust).
I am partly focusing on polishing the data model, based on the issue created by Koxiaet.
Since rspotify is API client for Spotify, it has to handle the request and response from Spotify HTTP API."><meta itemprop=datePublished content="2020-12-13T22:29:00+08:00">
<meta itemprop=dateModified content="2022-02-24T14:56:34+08:00">
<meta itemprop=wordCount content="1900">
<meta itemprop=keywords content="rust,rspotify,serde,"><meta name=twitter:card content="summary">
<meta name=twitter:title content="Serde Tricks">
<meta name=twitter:description content="The lesson learned from refactoring rspotify
1 Preface Recently, I and Mario are working on refactoring rspotify, trying to improve performance, documentation, error-handling, data model and reduce compile time, to make it easier to use. (For those who has never heard about rspotify, it is a Spotify HTTP SDK implemented in Rust).
I am partly focusing on polishing the data model, based on the issue created by Koxiaet.
Since rspotify is API client for Spotify, it has to handle the request and response from Spotify HTTP API."><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]-->
</head>
<body>
<div id=mobile-navbar class=mobile-navbar>
<div class=mobile-header-logo>
<a href=/ class=logo>In Pursuit of Hubris</a>
</div>
<div class=mobile-navbar-icon>
<span></span>
<span></span>
<span></span>
</div>
</div>
<nav id=mobile-menu class="mobile-menu slideout-menu">
<ul class=mobile-menu-list>
<a href=/>
<li class=mobile-menu-item>Home</li>
</a><a href=/post/>
<li class=mobile-menu-item>Archives</li>
</a><a href=/tags/>
<li class=mobile-menu-item>Tags</li>
</a><a href=/about_me>
<li class=mobile-menu-item>About</li>
</a>
</ul>
</nav>
<div class=container id=mobile-panel>
<header id=header class=header>
<div class=logo-wrapper>
<a href=/ class=logo>In Pursuit of Hubris</a>
</div>
<nav class=site-navbar>
<ul id=menu class=menu>
<li class=menu-item>
<a class=menu-item-link href=/>Home</a>
</li><li class=menu-item>
<a class=menu-item-link href=/post/>Archives</a>
</li><li class=menu-item>
<a class=menu-item-link href=/tags/>Tags</a>
</li><li class=menu-item>
<a class=menu-item-link href=/about_me>About</a>
</li>
</ul>
</nav>
</header>
<main id=main class=main>
<div class=content-wrapper>
<div id=content class=content>
<article class=post>
<header class=post-header>
<h1 class=post-title>Serde Tricks</h1>
<div class=post-meta>
<span class=post-time> 2020-12-13 </span>
<div class=post-category>
<a href=/categories/rust/> rust </a>
</div>
<span id=busuanzi_container_page_pv class=more-meta> <span id=busuanzi_value_page_pv><img src=/img/spinner.svg alt=spinner.svg></span> times read </span>
</div>
</header>
<div class=post-toc id=post-toc>
<h2 class=post-toc-title>Contents</h2>
<div class="post-toc-content always-active">
<nav id=TableOfContents>
<ul>
<li><a href=#preface><span class=section-num>1</span> Preface</a></li>
<li><a href=#serde-lesson><span class=section-num>2</span> Serde Lesson</a>
<ul>
<li><a href=#deserialize-json-map-to-vec-based-on-its-value-dot><span class=section-num>2.1</span> Deserialize JSON map to Vec based on its value.</a></li>
<li><a href=#deserialize-unix-milliseconds-timestamp-to-datetime><span class=section-num>2.2</span> Deserialize Unix milliseconds timestamp to Datetime</a></li>
<li><a href=#deserialize-milliseconds-to-duration><span class=section-num>2.3</span> Deserialize milliseconds to Duration</a></li>
<li><a href=#deserialize-milliseconds-to-option><span class=section-num>2.4</span> Deserialize milliseconds to Option</a></li>
<li><a href=#deserialize-enum-from-number><span class=section-num>2.5</span> Deserialize enum from number</a></li>
</ul>
</li>
<li><a href=#move-into-module><span class=section-num>3</span> Move into module</a></li>
<li><a href=#summary><span class=section-num>4</span> Summary</a></li>
<li><a href=#reference><span class=section-num>5</span> Reference</a></li>
</ul>
</nav>
</div>
</div>
<div class=post-content>
<p>The lesson learned from refactoring rspotify</p>
<h2 id=preface><span class=section-num>1</span> Preface</h2>
<p>Recently, I and <a href=https://github.com/marioortizmanero>Mario</a> are working on refactoring <a href=https://github.com/ramsayleung/rspotify><code>rspotify</code></a>, trying to improve performance, documentation, error-handling, data model and reduce compile time, to make it easier to use. (For those who has never heard about <code>rspotify</code>, it is a Spotify HTTP SDK implemented in Rust).</p>
<p>I am partly focusing on polishing the data model, based on the <a href=https://github.com/ramsayleung/rspotify/issues/127>issue</a> created by <a href=https://github.com/Koxiaet>Koxiaet</a>.</p>
<p>Since <code>rspotify</code> is API client for Spotify, it has to handle the request and response from Spotify HTTP API.</p>
<p>Generally speaking, the data model is something about how to structure the response data, and used <a href=http://serde.rs/><code>Serde</code></a> to parse JSON response from HTTP API to Rust <code>struct</code>, and I have learnt a lot Serde tricks from refactoring.</p>
<h2 id=serde-lesson><span class=section-num>2</span> Serde Lesson</h2>
<h3 id=deserialize-json-map-to-vec-based-on-its-value-dot><span class=section-num>2.1</span> Deserialize JSON map to Vec based on its value.</h3>
<p>An actions object which contains a <code>disallows</code> object, allows to update the user interface based on which playback actions are available within the current context.</p>
<p>The response JSON data from HTTP API:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=p>{</span>
    <span class=err>...</span>
	<span class=nt>&#34;disallows&#34;</span><span class=p>:</span> <span class=p>{</span>
	    <span class=nt>&#34;resuming&#34;</span><span class=p>:</span> <span class=kc>true</span>
	<span class=p>}</span>
    <span class=err>...</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>The original model representing actions was:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=cp>#[derive(Clone, Debug, Serialize, PartialEq, Eq)]</span><span class=w>
</span><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>struct</span> <span class=nc>Actions</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>disallows</span>: <span class=nc>HashMap</span><span class=o>&lt;</span><span class=n>DisallowKey</span><span class=p>,</span><span class=w> </span><span class=kt>bool</span><span class=o>&gt;</span><span class=w>
</span><span class=w></span><span class=p>}</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=cp>#[derive(Clone, Serialize, Deserialize, Copy, PartialEq, Eq, Debug, Hash, ToString)]</span><span class=w>
</span><span class=w></span><span class=cp>#[serde(rename_all = </span><span class=s>&#34;snake_case&#34;</span><span class=cp>)]</span><span class=w>
</span><span class=w></span><span class=cp>#[strum(serialize_all = </span><span class=s>&#34;snake_case&#34;</span><span class=cp>)]</span><span class=w>
</span><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>enum</span> <span class=nc>DisallowKey</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>    </span><span class=n>InterruptingPlayback</span><span class=p>,</span><span class=w>
</span><span class=w>    </span><span class=n>Pausing</span><span class=p>,</span><span class=w>
</span><span class=w>    </span><span class=n>Resuming</span><span class=p>,</span><span class=w>
</span><span class=w>    </span><span class=o>..</span><span class=p>.</span><span class=w>
</span><span class=w></span><span class=p>}</span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div><p>And Koxiaet gave great advice about how to polish <code>Actions</code>:</p>
<blockquote>
<p><code>Actions::disallows</code> can be replaced with a <code>Vec&lt;DisallowKey></code> or <code>HashSet&lt;DisallowKey></code> by removing all entires whose value is false, which will result in a simpler API.</p>
</blockquote>
<p>To be honest, I was not that familiar with <code>Serde</code> before, after digging in its official documentation for a while, it seems there is now a built-in way to convert JSON map to <code>Vec&lt;T></code> base on map&rsquo;s value.</p>
<p>After reading the <a href=https://serde.rs/custom-serialization.html>Custom serialization</a> from documentation, there was a simple solution came to my mind, so I wrote my first customized deserialize function.</p>
<p>I created a dumb <code>Actions</code> struct inside the <code>deserialize</code> function, and converted <code>HashMap</code> to <code>Vec</code> by filtering its value.</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=cp>#[derive(Clone, Debug, Serialize, PartialEq, Eq)]</span><span class=w>
</span><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>struct</span> <span class=nc>Actions</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>disallows</span>: <span class=nb>Vec</span><span class=o>&lt;</span><span class=n>DisallowKey</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span><span class=w></span><span class=p>}</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=k>impl</span><span class=o>&lt;&#39;</span><span class=na>de</span><span class=o>&gt;</span><span class=w> </span><span class=n>Deserialize</span><span class=o>&lt;&#39;</span><span class=na>de</span><span class=o>&gt;</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>Actions</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>    </span><span class=k>fn</span> <span class=nf>deserialize</span><span class=o>&lt;</span><span class=n>D</span><span class=o>&gt;</span><span class=p>(</span><span class=n>deserializer</span>: <span class=nc>D</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=bp>Self</span><span class=p>,</span><span class=w> </span><span class=n>D</span>::<span class=n>Error</span><span class=o>&gt;</span><span class=w>
</span><span class=w>    </span><span class=k>where</span><span class=w>
</span><span class=w>	</span><span class=n>D</span>: <span class=nc>Deserializer</span><span class=o>&lt;&#39;</span><span class=na>de</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span><span class=w>    </span><span class=p>{</span><span class=w>
</span><span class=w>	</span><span class=cp>#[derive(Deserialize)]</span><span class=w>
</span><span class=w>	</span><span class=k>struct</span> <span class=nc>OriginalActions</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>	    </span><span class=k>pub</span><span class=w> </span><span class=n>disallows</span>: <span class=nc>HashMap</span><span class=o>&lt;</span><span class=n>DisallowKey</span><span class=p>,</span><span class=w> </span><span class=kt>bool</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span><span class=w>	</span><span class=p>}</span><span class=w>
</span><span class=w>
</span><span class=w>	</span><span class=kd>let</span><span class=w> </span><span class=n>orignal_actions</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>OriginalActions</span>::<span class=n>deserialize</span><span class=p>(</span><span class=n>deserializer</span><span class=p>)</span><span class=o>?</span><span class=p>;</span><span class=w>
</span><span class=w>	</span><span class=nb>Ok</span><span class=p>(</span><span class=n>Actions</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>	    </span><span class=n>disallows</span>: <span class=nc>orignal_actions</span><span class=w>
</span><span class=w>		</span><span class=p>.</span><span class=n>disallows</span><span class=w>
</span><span class=w>		</span><span class=p>.</span><span class=n>into_iter</span><span class=p>()</span><span class=w>
</span><span class=w>		</span><span class=p>.</span><span class=n>filter</span><span class=p>(</span><span class=o>|</span><span class=p>(</span><span class=n>_</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=p>)</span><span class=o>|</span><span class=w> </span><span class=o>*</span><span class=n>value</span><span class=p>)</span><span class=w>
</span><span class=w>		</span><span class=p>.</span><span class=n>map</span><span class=p>(</span><span class=o>|</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>_</span><span class=p>)</span><span class=o>|</span><span class=w> </span><span class=n>key</span><span class=p>)</span><span class=w>
</span><span class=w>		</span><span class=p>.</span><span class=n>collect</span><span class=p>(),</span><span class=w>
</span><span class=w>	</span><span class=p>})</span><span class=w>
</span><span class=w>    </span><span class=p>}</span><span class=w>
</span><span class=w></span><span class=p>}</span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div><p>The types should be familiar if you&rsquo;ve used <code>Serde</code> before.</p>
<p>If you&rsquo;re not used to Rust then the function signature will likely look a little strange. What it&rsquo;s trying to tell is that d will be something that implements <code>Serde</code>&rsquo;s <code>Deserializer</code> trait, and that any references to memory will live for the <code>'de</code> lifetime.</p>
<h3 id=deserialize-unix-milliseconds-timestamp-to-datetime><span class=section-num>2.2</span> Deserialize Unix milliseconds timestamp to Datetime</h3>
<p>A currently playing object which contains information about currently playing item, and the <code>timestamp</code> field is an integer, representing the Unix millisecond timestamp when data was fetched.</p>
<p>The response JSON data from HTTP API:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=p>{</span>
    <span class=err>...</span>
	<span class=nt>&#34;timestamp&#34;</span><span class=p>:</span> <span class=mi>1490252122574</span><span class=p>,</span>
    <span class=nt>&#34;progress_ms&#34;</span><span class=p>:</span> <span class=mi>44272</span><span class=p>,</span>
    <span class=nt>&#34;is_playing&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
    <span class=nt>&#34;currently_playing_type&#34;</span><span class=p>:</span> <span class=s2>&#34;track&#34;</span><span class=p>,</span>
    <span class=nt>&#34;actions&#34;</span><span class=p>:</span> <span class=p>{</span>
	<span class=nt>&#34;disallows&#34;</span><span class=p>:</span> <span class=p>{</span>
	    <span class=nt>&#34;resuming&#34;</span><span class=p>:</span> <span class=kc>true</span>
	<span class=p>}</span>
    <span class=p>}</span>
    <span class=err>...</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>The original model was:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=sd>/// Currently playing object
</span><span class=sd>///
</span><span class=sd>/// [Reference](https://developer.spotify.com/documentation/web-api/reference/player/get-the-users-currently-playing-track/)
</span><span class=sd></span><span class=cp>#[derive(Clone, Debug, Serialize, Deserialize, PartialEq, Eq)]</span><span class=w>
</span><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>struct</span> <span class=nc>CurrentlyPlayingContext</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>timestamp</span>: <span class=kt>u64</span><span class=p>,</span><span class=w>
</span><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>progress_ms</span>: <span class=nb>Option</span><span class=o>&lt;</span><span class=kt>u32</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>is_playing</span>: <span class=kt>bool</span><span class=p>,</span><span class=w>
</span><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>item</span>: <span class=nb>Option</span><span class=o>&lt;</span><span class=n>PlayingItem</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>currently_playing_type</span>: <span class=nc>CurrentlyPlayingType</span><span class=p>,</span><span class=w>
</span><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>actions</span>: <span class=nc>Actions</span><span class=p>,</span><span class=w>
</span><span class=w></span><span class=p>}</span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div><p>As before, Koxiaet made a great point about <code>timestamp</code> and =progress_ms=(I will talk about it later):</p>
<blockquote>
<p><code>CurrentlyPlayingContext::timestamp</code> should be a <code>chrono::DateTime&lt;Utc></code>, which could be easier to use.</p>
</blockquote>
<p>The polished struct looks like:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=cp>#[derive(Clone, Debug, Serialize, Deserialize, PartialEq, Eq)]</span><span class=w>
</span><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>struct</span> <span class=nc>CurrentlyPlayingContext</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>context</span>: <span class=nb>Option</span><span class=o>&lt;</span><span class=n>Context</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span><span class=w>    </span><span class=cp>#[serde(
</span><span class=cp>	deserialize_with = </span><span class=s>&#34;from_millisecond_timestamp&#34;</span><span class=cp>,
</span><span class=cp>	serialize_with = </span><span class=s>&#34;to_millisecond_timestamp&#34;</span><span class=cp>
</span><span class=cp>    )]</span><span class=w>
</span><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>timestamp</span>: <span class=nc>DateTime</span><span class=o>&lt;</span><span class=n>Utc</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>progress_ms</span>: <span class=nb>Option</span><span class=o>&lt;</span><span class=kt>u32</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>is_playing</span>: <span class=kt>bool</span><span class=p>,</span><span class=w>
</span><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>item</span>: <span class=nb>Option</span><span class=o>&lt;</span><span class=n>PlayingItem</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>currently_playing_type</span>: <span class=nc>CurrentlyPlayingType</span><span class=p>,</span><span class=w>
</span><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>actions</span>: <span class=nc>Actions</span><span class=p>,</span><span class=w>
</span><span class=w></span><span class=p>}</span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div><p>Using the <code>deserialize_with</code> attribute tells <code>Serde</code> to use custom deserialization code for the <code>timestamp</code> field. The
<code>from_millisecond_timestamp</code> code is:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=sd>/// Deserialize Unix millisecond timestamp to `DateTime&lt;Utc&gt;`
</span><span class=sd></span><span class=k>pub</span><span class=p>(</span><span class=k>in</span><span class=w> </span><span class=k>crate</span><span class=p>)</span><span class=w> </span><span class=k>fn</span> <span class=nf>from_millisecond_timestamp</span><span class=o>&lt;&#39;</span><span class=na>de</span><span class=p>,</span><span class=w> </span><span class=n>D</span><span class=o>&gt;</span><span class=p>(</span><span class=n>d</span>: <span class=nc>D</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=n>DateTime</span><span class=o>&lt;</span><span class=n>Utc</span><span class=o>&gt;</span><span class=p>,</span><span class=w> </span><span class=n>D</span>::<span class=n>Error</span><span class=o>&gt;</span><span class=w>
</span><span class=w></span><span class=k>where</span><span class=w>
</span><span class=w>    </span><span class=n>D</span>: <span class=nc>de</span>::<span class=n>Deserializer</span><span class=o>&lt;&#39;</span><span class=na>de</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span><span class=w></span><span class=p>{</span><span class=w>
</span><span class=w>    </span><span class=n>d</span><span class=p>.</span><span class=n>deserialize_u64</span><span class=p>(</span><span class=n>DateTimeVisitor</span><span class=p>)</span><span class=w>
</span><span class=w></span><span class=p>}</span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div><p>The code calls <code>d.deserialize_u64</code> passing in a struct. The passed in struct implements <code>Serde</code>&rsquo;s <code>Visitor</code>, and look like:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=c1>// Vistor to help deserialize unix millisecond timestamp to `chrono::DateTime`
</span><span class=c1></span><span class=k>struct</span> <span class=nc>DateTimeVisitor</span><span class=p>;</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=k>impl</span><span class=o>&lt;&#39;</span><span class=na>de</span><span class=o>&gt;</span><span class=w> </span><span class=n>de</span>::<span class=n>Visitor</span><span class=o>&lt;&#39;</span><span class=na>de</span><span class=o>&gt;</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>DateTimeVisitor</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>    </span><span class=k>type</span> <span class=nc>Value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>DateTime</span><span class=o>&lt;</span><span class=n>Utc</span><span class=o>&gt;</span><span class=p>;</span><span class=w>
</span><span class=w>    </span><span class=k>fn</span> <span class=nf>expecting</span><span class=p>(</span><span class=o>&amp;</span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>formatter</span>: <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=n>fmt</span>::<span class=n>Formatter</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>fmt</span>::<span class=nb>Result</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>	</span><span class=fm>write!</span><span class=p>(</span><span class=w>
</span><span class=w>	    </span><span class=n>formatter</span><span class=p>,</span><span class=w>
</span><span class=w>	    </span><span class=s>&#34;an unix millisecond timestamp represents DataTime&lt;UTC&gt;&#34;</span><span class=w>
</span><span class=w>	</span><span class=p>)</span><span class=w>
</span><span class=w>    </span><span class=p>}</span><span class=w>
</span><span class=w>    </span><span class=k>fn</span> <span class=nf>visit_u64</span><span class=o>&lt;</span><span class=n>E</span><span class=o>&gt;</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>v</span>: <span class=kt>u64</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=bp>Self</span>::<span class=n>Value</span><span class=p>,</span><span class=w> </span><span class=n>E</span><span class=o>&gt;</span><span class=w>
</span><span class=w>    </span><span class=k>where</span><span class=w>
</span><span class=w>	</span><span class=n>E</span>: <span class=nc>de</span>::<span class=n>Error</span><span class=p>,</span><span class=w>
</span><span class=w>    </span><span class=p>{</span><span class=w>
</span><span class=w>	</span><span class=o>..</span><span class=p>.</span><span class=w>
</span><span class=w>    </span><span class=p>}</span><span class=w>
</span><span class=w></span><span class=p>}</span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div><p>The struct <code>DateTimeVisitor</code> doesn&rsquo;t have any fields, it just a type implemented the custom visitor which delegates to parse the <code>u64</code>.</p>
<p>Since there is no way to construct <code>DataTime</code> directly from Unix millisecond timestamp, I have to figure out how to handle the
construction. And it turns out that there is a way to construct <code>DateTime</code> from seconds and nanoseconds:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=k>use</span><span class=w> </span><span class=n>chrono</span>::<span class=p>{</span><span class=n>DateTime</span><span class=p>,</span><span class=w> </span><span class=n>TimeZone</span><span class=p>,</span><span class=w> </span><span class=n>NaiveDateTime</span><span class=p>,</span><span class=w> </span><span class=n>Utc</span><span class=p>};</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=kd>let</span><span class=w> </span><span class=n>dt</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>DateTime</span>::<span class=o>&lt;</span><span class=n>Utc</span><span class=o>&gt;</span>::<span class=n>from_utc</span><span class=p>(</span><span class=n>NaiveDateTime</span>::<span class=n>from_timestamp</span><span class=p>(</span><span class=mi>61</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>),</span><span class=w> </span><span class=n>Utc</span><span class=p>);</span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div><p>Thus, what I need to do is just convert millisecond to second and nanosecond:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=k>fn</span> <span class=nf>visit_u64</span><span class=o>&lt;</span><span class=n>E</span><span class=o>&gt;</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>v</span>: <span class=kt>u64</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=bp>Self</span>::<span class=n>Value</span><span class=p>,</span><span class=w> </span><span class=n>E</span><span class=o>&gt;</span><span class=w>
</span><span class=w></span><span class=k>where</span><span class=w>
</span><span class=w>    </span><span class=n>E</span>: <span class=nc>de</span>::<span class=n>Error</span><span class=p>,</span><span class=w>
</span><span class=w></span><span class=p>{</span><span class=w>
</span><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>second</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>v</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>v</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=mi>1000</span><span class=p>)</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=mi>1000</span><span class=p>;</span><span class=w>
</span><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>nanosecond</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>((</span><span class=n>v</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=mi>1000</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>1000000</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>u32</span><span class=p>;</span><span class=w>
</span><span class=w>    </span><span class=c1>// The maximum value of i64 is large enough to hold millisecond, so it would be safe to convert it i64
</span><span class=c1></span><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>dt</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>DateTime</span>::<span class=o>&lt;</span><span class=n>Utc</span><span class=o>&gt;</span>::<span class=n>from_utc</span><span class=p>(</span><span class=w>
</span><span class=w>	</span><span class=n>NaiveDateTime</span>::<span class=n>from_timestamp</span><span class=p>(</span><span class=n>second</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>i64</span><span class=p>,</span><span class=w> </span><span class=n>nanosecond</span><span class=p>),</span><span class=w>
</span><span class=w>	</span><span class=n>Utc</span><span class=p>,</span><span class=w>
</span><span class=w>    </span><span class=p>);</span><span class=w>
</span><span class=w>    </span><span class=nb>Ok</span><span class=p>(</span><span class=n>dt</span><span class=p>)</span><span class=w>
</span><span class=w></span><span class=p>}</span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div><p>The <code>to_millisecond_timestamp</code> function is similar to <code>from_millisecond_timestamp</code>, but it&rsquo;s eaiser to implement, check
<a href=https://github.com/ramsayleung/rspotify/pull/157/files#>this PR</a> for more detail.</p>
<h3 id=deserialize-milliseconds-to-duration><span class=section-num>2.3</span> Deserialize milliseconds to Duration</h3>
<p>The simplified episode object contains the simplified episode information, and the <code>duration_ms</code> field is an integer, which represents the episode length in milliseconds.</p>
<p>The response JSON data from HTTP API:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=p>{</span>
    <span class=err>...</span>
	<span class=nt>&#34;audio_preview_url&#34;</span> <span class=p>:</span> <span class=s2>&#34;https://p.scdn.co/mp3-preview/83bc7f2d40e850582a4ca118b33c256358de06ff&#34;</span><span class=p>,</span>
    <span class=nt>&#34;description&#34;</span> <span class=p>:</span> <span class=s2>&#34;Följ med Tobias Svanelid till Sveriges äldsta tegelkyrka&#34;</span>
    <span class=s2>&#34;duration_ms&#34;</span> <span class=p>:</span> <span class=mi>2685023</span><span class=p>,</span>
    <span class=nt>&#34;explicit&#34;</span> <span class=p>:</span> <span class=kc>false</span><span class=p>,</span>
    <span class=err>...</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>The original model was</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=cp>#[derive(Clone, Debug, Serialize, Deserialize, PartialEq, Eq)]</span><span class=w>
</span><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>struct</span> <span class=nc>SimplifiedEpisode</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>audio_preview_url</span>: <span class=nb>Option</span><span class=o>&lt;</span><span class=nb>String</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>description</span>: <span class=nb>String</span><span class=p>,</span><span class=w>
</span><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>duration_ms</span>: <span class=kt>u32</span><span class=p>,</span><span class=w>
</span><span class=w>    </span><span class=o>..</span><span class=p>.</span><span class=w>
</span><span class=w></span><span class=p>}</span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div><p>As before without saying, Koxiaet pointed out that</p>
<blockquote>
<p><code>SimplifiedEpisode::duration_ms</code> should be replaced with a <code>duration</code> of type <code>Duration</code>, since a built-in <code>Duration</code> type works better than primitive type.</p>
</blockquote>
<p>Since I have worked with <code>Serde</code>&rsquo;s custome deserialization, it&rsquo;s not a hard job for me any more. I easily figure out how to deserialize <code>u64</code> to <code>Duration</code>:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=cp>#[derive(Clone, Debug, Serialize, Deserialize, PartialEq, Eq)]</span><span class=w>
</span><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>struct</span> <span class=nc>SimplifiedEpisode</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>audio_preview_url</span>: <span class=nb>Option</span><span class=o>&lt;</span><span class=nb>String</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>description</span>: <span class=nb>String</span><span class=p>,</span><span class=w>
</span><span class=w>    </span><span class=cp>#[serde(
</span><span class=cp>	deserialize_with = </span><span class=s>&#34;from_duration_ms&#34;</span><span class=cp>,
</span><span class=cp>	serialize_with = </span><span class=s>&#34;to_duration_ms&#34;</span><span class=cp>,
</span><span class=cp>	rename = </span><span class=s>&#34;duration_ms&#34;</span><span class=cp>
</span><span class=cp>    )]</span><span class=w>
</span><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>duration</span>: <span class=nc>Duration</span><span class=p>,</span><span class=w>
</span><span class=w>    </span><span class=o>..</span><span class=p>.</span><span class=w>
</span><span class=w></span><span class=p>}</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=sd>/// Vistor to help deserialize duration represented as millisecond to `std::time::Duration`
</span><span class=sd></span><span class=k>struct</span> <span class=nc>DurationVisitor</span><span class=p>;</span><span class=w>
</span><span class=w></span><span class=k>impl</span><span class=o>&lt;&#39;</span><span class=na>de</span><span class=o>&gt;</span><span class=w> </span><span class=n>de</span>::<span class=n>Visitor</span><span class=o>&lt;&#39;</span><span class=na>de</span><span class=o>&gt;</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>DurationVisitor</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>    </span><span class=k>type</span> <span class=nc>Value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Duration</span><span class=p>;</span><span class=w>
</span><span class=w>    </span><span class=k>fn</span> <span class=nf>expecting</span><span class=p>(</span><span class=o>&amp;</span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>formatter</span>: <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=n>fmt</span>::<span class=n>Formatter</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>fmt</span>::<span class=nb>Result</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>	</span><span class=fm>write!</span><span class=p>(</span><span class=n>formatter</span><span class=p>,</span><span class=w> </span><span class=s>&#34;a milliseconds represents std::time::Duration&#34;</span><span class=p>)</span><span class=w>
</span><span class=w>    </span><span class=p>}</span><span class=w>
</span><span class=w>    </span><span class=k>fn</span> <span class=nf>visit_u64</span><span class=o>&lt;</span><span class=n>E</span><span class=o>&gt;</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>v</span>: <span class=kt>u64</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=bp>Self</span>::<span class=n>Value</span><span class=p>,</span><span class=w> </span><span class=n>E</span><span class=o>&gt;</span><span class=w>
</span><span class=w>    </span><span class=k>where</span><span class=w>
</span><span class=w>	</span><span class=n>E</span>: <span class=nc>de</span>::<span class=n>Error</span><span class=p>,</span><span class=w>
</span><span class=w>    </span><span class=p>{</span><span class=w>
</span><span class=w>	</span><span class=nb>Ok</span><span class=p>(</span><span class=n>Duration</span>::<span class=n>from_millis</span><span class=p>(</span><span class=n>v</span><span class=p>))</span><span class=w>
</span><span class=w>    </span><span class=p>}</span><span class=w>
</span><span class=w></span><span class=p>}</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=sd>/// Deserialize `std::time::Duration` from millisecond(represented as u64)
</span><span class=sd></span><span class=k>pub</span><span class=p>(</span><span class=k>in</span><span class=w> </span><span class=k>crate</span><span class=p>)</span><span class=w> </span><span class=k>fn</span> <span class=nf>from_duration_ms</span><span class=o>&lt;&#39;</span><span class=na>de</span><span class=p>,</span><span class=w> </span><span class=n>D</span><span class=o>&gt;</span><span class=p>(</span><span class=n>d</span>: <span class=nc>D</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=n>Duration</span><span class=p>,</span><span class=w> </span><span class=n>D</span>::<span class=n>Error</span><span class=o>&gt;</span><span class=w>
</span><span class=w></span><span class=k>where</span><span class=w>
</span><span class=w>    </span><span class=n>D</span>: <span class=nc>de</span>::<span class=n>Deserializer</span><span class=o>&lt;&#39;</span><span class=na>de</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span><span class=w></span><span class=p>{</span><span class=w>
</span><span class=w>    </span><span class=n>d</span><span class=p>.</span><span class=n>deserialize_u64</span><span class=p>(</span><span class=n>DurationVisitor</span><span class=p>)</span><span class=w>
</span><span class=w></span><span class=p>}</span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div><p>Now, the life is easier than before.</p>
<h3 id=deserialize-milliseconds-to-option><span class=section-num>2.4</span> Deserialize milliseconds to Option</h3>
<p>Let&rsquo;s go back to <code>CurrentlyPlayingContext</code> model, since we have replaced millisecond (represents as <code>u32</code>) with <code>Duration</code>, it makes sense to replace all millisecond fields to <code>Duration</code>.</p>
<p>But hold on, it seems <code>progress_ms</code> field is a bit different.</p>
<p>The <code>progress_ms</code> field is either not present or a millisecond, the <code>u32</code> handles the milliseconds, as its value might not be present in the response, it&rsquo;s an <code>Option&lt;u32></code>, so it won&rsquo;t work with <code>from_duration_ms</code>.</p>
<p>Thus, it&rsquo;s necessary to figure out how to handle the <code>Option</code> type, and the answer is in the documentation, the <code>deserialize_option</code> function:</p>
<blockquote>
<p>Hint that the <code>Deserialize</code> type is expecting an optional value.</p>
</blockquote>
<blockquote>
<p>This allows deserializers that encode an optional value as a nullable value to convert the null value into <code>None</code> and a regular value into <code>Some(value)</code>.</p>
</blockquote>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=cp>#[derive(Clone, Debug, Serialize, Deserialize, PartialEq, Eq)]</span><span class=w>
</span><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>struct</span> <span class=nc>CurrentlyPlayingContext</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>context</span>: <span class=nb>Option</span><span class=o>&lt;</span><span class=n>Context</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span><span class=w>    </span><span class=cp>#[serde(
</span><span class=cp>	deserialize_with = </span><span class=s>&#34;from_millisecond_timestamp&#34;</span><span class=cp>,
</span><span class=cp>	serialize_with = </span><span class=s>&#34;to_millisecond_timestamp&#34;</span><span class=cp>
</span><span class=cp>    )]</span><span class=w>
</span><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>timestamp</span>: <span class=nc>DateTime</span><span class=o>&lt;</span><span class=n>Utc</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span><span class=w>    </span><span class=cp>#[serde(default)]</span><span class=w>
</span><span class=w>    </span><span class=cp>#[serde(
</span><span class=cp>	deserialize_with = </span><span class=s>&#34;from_option_duration_ms&#34;</span><span class=cp>,
</span><span class=cp>	serialize_with = </span><span class=s>&#34;to_option_duration_ms&#34;</span><span class=cp>,
</span><span class=cp>	rename = </span><span class=s>&#34;progress_ms&#34;</span><span class=cp>
</span><span class=cp>    )]</span><span class=w>
</span><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>progress</span>: <span class=nb>Option</span><span class=o>&lt;</span><span class=n>Duration</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span><span class=w></span><span class=p>}</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=sd>/// Deserialize `Option&lt;std::time::Duration&gt;` from millisecond(represented as u64)
</span><span class=sd></span><span class=k>pub</span><span class=p>(</span><span class=k>in</span><span class=w> </span><span class=k>crate</span><span class=p>)</span><span class=w> </span><span class=k>fn</span> <span class=nf>from_option_duration_ms</span><span class=o>&lt;&#39;</span><span class=na>de</span><span class=p>,</span><span class=w> </span><span class=n>D</span><span class=o>&gt;</span><span class=p>(</span><span class=n>d</span>: <span class=nc>D</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=nb>Option</span><span class=o>&lt;</span><span class=n>Duration</span><span class=o>&gt;</span><span class=p>,</span><span class=w> </span><span class=n>D</span>::<span class=n>Error</span><span class=o>&gt;</span><span class=w>
</span><span class=w></span><span class=k>where</span><span class=w>
</span><span class=w>    </span><span class=n>D</span>: <span class=nc>de</span>::<span class=n>Deserializer</span><span class=o>&lt;&#39;</span><span class=na>de</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span><span class=w></span><span class=p>{</span><span class=w>
</span><span class=w>    </span><span class=n>d</span><span class=p>.</span><span class=n>deserialize_option</span><span class=p>(</span><span class=n>OptionDurationVisitor</span><span class=p>)</span><span class=w>
</span><span class=w></span><span class=p>}</span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div><p>As before, the <code>OptionDurationVisitor</code> is an empty struct implemented <code>Visitor</code> trait, but key point is in order to work with
<code>deserialize_option</code>, the <code>OptionDurationVisitor</code> has to implement the <code>visit_none</code> and <code>visit_some</code> method:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=k>impl</span><span class=o>&lt;&#39;</span><span class=na>de</span><span class=o>&gt;</span><span class=w> </span><span class=n>de</span>::<span class=n>Visitor</span><span class=o>&lt;&#39;</span><span class=na>de</span><span class=o>&gt;</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>OptionDurationVisitor</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>    </span><span class=k>type</span> <span class=nc>Value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>Option</span><span class=o>&lt;</span><span class=n>Duration</span><span class=o>&gt;</span><span class=p>;</span><span class=w>
</span><span class=w>    </span><span class=k>fn</span> <span class=nf>expecting</span><span class=p>(</span><span class=o>&amp;</span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>formatter</span>: <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=n>fmt</span>::<span class=n>Formatter</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>fmt</span>::<span class=nb>Result</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>	</span><span class=fm>write!</span><span class=p>(</span><span class=w>
</span><span class=w>	    </span><span class=n>formatter</span><span class=p>,</span><span class=w>
</span><span class=w>	    </span><span class=s>&#34;a optional milliseconds represents std::time::Duration&#34;</span><span class=w>
</span><span class=w>	</span><span class=p>)</span><span class=w>
</span><span class=w>    </span><span class=p>}</span><span class=w>
</span><span class=w>    </span><span class=k>fn</span> <span class=nf>visit_none</span><span class=o>&lt;</span><span class=n>E</span><span class=o>&gt;</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=bp>Self</span>::<span class=n>Value</span><span class=p>,</span><span class=w> </span><span class=n>E</span><span class=o>&gt;</span><span class=w>
</span><span class=w>    </span><span class=k>where</span><span class=w>
</span><span class=w>	</span><span class=n>E</span>: <span class=nc>de</span>::<span class=n>Error</span><span class=p>,</span><span class=w>
</span><span class=w>    </span><span class=p>{</span><span class=w>
</span><span class=w>	</span><span class=nb>Ok</span><span class=p>(</span><span class=nb>None</span><span class=p>)</span><span class=w>
</span><span class=w>    </span><span class=p>}</span><span class=w>
</span><span class=w>
</span><span class=w>    </span><span class=k>fn</span> <span class=nf>visit_some</span><span class=o>&lt;</span><span class=n>D</span><span class=o>&gt;</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>deserializer</span>: <span class=nc>D</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=bp>Self</span>::<span class=n>Value</span><span class=p>,</span><span class=w> </span><span class=n>D</span>::<span class=n>Error</span><span class=o>&gt;</span><span class=w>
</span><span class=w>    </span><span class=k>where</span><span class=w>
</span><span class=w>	</span><span class=n>D</span>: <span class=nc>de</span>::<span class=n>Deserializer</span><span class=o>&lt;&#39;</span><span class=na>de</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span><span class=w>    </span><span class=p>{</span><span class=w>
</span><span class=w>	</span><span class=nb>Ok</span><span class=p>(</span><span class=nb>Some</span><span class=p>(</span><span class=n>deserializer</span><span class=p>.</span><span class=n>deserialize_u64</span><span class=p>(</span><span class=n>DurationVisitor</span><span class=p>)</span><span class=o>?</span><span class=p>))</span><span class=w>
</span><span class=w>    </span><span class=p>}</span><span class=w>
</span><span class=w></span><span class=p>}</span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div><p>The <code>visit_none</code> method return <code>Ok(None)</code> so the <code>progress</code> value in the struct will be None, and the <code>visit_some</code> delegates the parsing logic to <code>DurationVisitor</code> via the <code>deserialize_u64</code> call, so deserializing <code>Some(u64)</code> works like the <code>u64</code>.</p>
<h3 id=deserialize-enum-from-number><span class=section-num>2.5</span> Deserialize enum from number</h3>
<p>An <code>AudioAnalysisSection</code> model contains a <code>mode</code> field, which indicates the modality(major or minor) of a track, the type of scle from which its melodic content is derived. This field will contain a 0 for <code>minor</code>, a 1 for <code>major</code>, or a -1 for no result.</p>
<p>The response JSON data from HTTP API:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=p>{</span>
    <span class=err>...</span>
	<span class=nt>&#34;mode&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
    <span class=nt>&#34;mode_confidence&#34;</span><span class=p>:</span> <span class=mf>0.414</span><span class=p>,</span>
    <span class=err>...</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>The original struct representing <code>AudioAnalysisSection</code> was like this, since <code>mode</code> field was stored into a <code>f32=(=f8</code> was a better choice for this case):</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=cp>#[derive(Clone, Debug, Serialize, Deserialize, PartialEq)]</span><span class=w>
</span><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>struct</span> <span class=nc>AudioAnalysisSection</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>    </span><span class=o>..</span><span class=p>.</span><span class=w>
</span><span class=w>	</span><span class=k>pub</span><span class=w> </span><span class=n>mode</span>: <span class=kt>f32</span><span class=p>,</span><span class=w>
</span><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>mode_confidence</span>: <span class=kt>f32</span><span class=p>,</span><span class=w>
</span><span class=w>    </span><span class=o>..</span><span class=p>.</span><span class=w>
</span><span class=w></span><span class=p>}</span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div><p>Koxiaet made a great point about <code>mode</code> field:</p>
<blockquote>
<p><code>AudioAnalysisSection::mode</code> and <code>AudioFeatures::mode</code> are <code>f32=s but should be =Option&lt;Mode>=s where =enum Mode { Major, Minor }</code> as it is more useful.</p>
</blockquote>
<p>In this case, we don&rsquo;t need the <code>Opiton</code> type and in order to deserialize enum from number, we firstly need to define a C-like enum:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=k>pub</span><span class=w> </span><span class=k>enum</span> <span class=nc>Modality</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>    </span><span class=cp>#[serde(rename = </span><span class=s>&#34;0&#34;</span><span class=cp>)]</span><span class=w>
</span><span class=w>    </span><span class=n>Minor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w>
</span><span class=w>    </span><span class=cp>#[serde(rename = </span><span class=s>&#34;1&#34;</span><span class=cp>)]</span><span class=w>
</span><span class=w>    </span><span class=n>Major</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=w>
</span><span class=w>    </span><span class=cp>#[serde(rename = </span><span class=s>&#34;1&#34;</span><span class=cp>)]</span><span class=w>
</span><span class=w>    </span><span class=n>NoResult</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>-</span><span class=mi>1</span><span class=p>,</span><span class=w>
</span><span class=w></span><span class=p>}</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>struct</span> <span class=nc>AudioAnalysisSection</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>    </span><span class=o>..</span><span class=p>.</span><span class=w>
</span><span class=w>	</span><span class=k>pub</span><span class=w> </span><span class=n>mode</span>: <span class=nc>Modality</span><span class=p>,</span><span class=w>
</span><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>mode_confidence</span>: <span class=kt>f32</span><span class=p>,</span><span class=w>
</span><span class=w>    </span><span class=o>..</span><span class=p>.</span><span class=w>
</span><span class=w></span><span class=p>}</span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div><p>And then, what&rsquo;s the next step? It seems serde doesn&rsquo;t allow C-like enums to be formatted as integers rather that strings in JSON natively:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=err>working</span> <span class=err>version:</span>
<span class=p>{</span>
    <span class=err>...</span>
	<span class=nt>&#34;mode&#34;</span><span class=p>:</span> <span class=s2>&#34;0&#34;</span><span class=p>,</span>
    <span class=nt>&#34;mode_confidence&#34;</span><span class=p>:</span> <span class=mf>0.414</span><span class=p>,</span>
    <span class=err>...</span>
<span class=p>}</span>

<span class=err>failed</span> <span class=err>version:</span>
<span class=p>{</span>
    <span class=err>...</span>
	<span class=nt>&#34;mode&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
    <span class=nt>&#34;mode_confidence&#34;</span><span class=p>:</span> <span class=mf>0.414</span><span class=p>,</span>
    <span class=err>...</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>Then the failed version is exactly what we want. I know that the serde&rsquo;s official documentation has a solution for this case, the <a href=https://github.com/dtolnay/serde-repr>serde_repr</a> crate provides alternative derive macros that derive the same Serialize and Deserialize traits but delegate to the underlying representation of a C-like enum.</p>
<p>Since we are trying to reduce the compiled time of rspotify, so we are cautious about introducing new dependencies. So a custom-made serialize function would be a better choice, it just needs to <code>match</code> the number, and convert to a related enum value.</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=sd>/// Deserialize/Serialize `Modality` to integer(0, 1, -1).
</span><span class=sd></span><span class=k>pub</span><span class=p>(</span><span class=k>in</span><span class=w> </span><span class=k>crate</span><span class=p>)</span><span class=w> </span><span class=k>mod</span> <span class=nn>modality</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>    </span><span class=k>use</span><span class=w> </span><span class=k>super</span>::<span class=n>enums</span>::<span class=n>Modality</span><span class=p>;</span><span class=w>
</span><span class=w>    </span><span class=k>use</span><span class=w> </span><span class=n>serde</span>::<span class=p>{</span><span class=n>de</span><span class=p>,</span><span class=w> </span><span class=n>Deserialize</span><span class=p>,</span><span class=w> </span><span class=n>Serializer</span><span class=p>};</span><span class=w>
</span><span class=w>
</span><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>deserialize</span><span class=o>&lt;&#39;</span><span class=na>de</span><span class=p>,</span><span class=w> </span><span class=n>D</span><span class=o>&gt;</span><span class=p>(</span><span class=n>d</span>: <span class=nc>D</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=n>Modality</span><span class=p>,</span><span class=w> </span><span class=n>D</span>::<span class=n>Error</span><span class=o>&gt;</span><span class=w>
</span><span class=w>    </span><span class=k>where</span><span class=w>
</span><span class=w>	</span><span class=n>D</span>: <span class=nc>de</span>::<span class=n>Deserializer</span><span class=o>&lt;&#39;</span><span class=na>de</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span><span class=w>    </span><span class=p>{</span><span class=w>
</span><span class=w>	</span><span class=kd>let</span><span class=w> </span><span class=n>v</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kt>i8</span>::<span class=n>deserialize</span><span class=p>(</span><span class=n>d</span><span class=p>)</span><span class=o>?</span><span class=p>;</span><span class=w>
</span><span class=w>	</span><span class=k>match</span><span class=w> </span><span class=n>v</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>	    </span><span class=mi>0</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=nb>Ok</span><span class=p>(</span><span class=n>Modality</span>::<span class=n>Minor</span><span class=p>),</span><span class=w>
</span><span class=w>	    </span><span class=mi>1</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=nb>Ok</span><span class=p>(</span><span class=n>Modality</span>::<span class=n>Major</span><span class=p>),</span><span class=w>
</span><span class=w>	    </span><span class=o>-</span><span class=mi>1</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=nb>Ok</span><span class=p>(</span><span class=n>Modality</span>::<span class=n>NoResult</span><span class=p>),</span><span class=w>
</span><span class=w>	    </span><span class=n>_</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=nb>Err</span><span class=p>(</span><span class=n>de</span>::<span class=n>Error</span>::<span class=n>invalid_value</span><span class=p>(</span><span class=w>
</span><span class=w>		</span><span class=n>de</span>::<span class=n>Unexpected</span>::<span class=n>Signed</span><span class=p>(</span><span class=n>v</span><span class=p>.</span><span class=n>into</span><span class=p>()),</span><span class=w>
</span><span class=w>		</span><span class=o>&amp;</span><span class=s>&#34;valid value: 0, 1, -1&#34;</span><span class=p>,</span><span class=w>
</span><span class=w>	    </span><span class=p>)),</span><span class=w>
</span><span class=w>	</span><span class=p>}</span><span class=w>
</span><span class=w>    </span><span class=p>}</span><span class=w>
</span><span class=w>
</span><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>serialize</span><span class=o>&lt;</span><span class=n>S</span><span class=o>&gt;</span><span class=p>(</span><span class=n>x</span>: <span class=kp>&amp;</span><span class=nc>Modality</span><span class=p>,</span><span class=w> </span><span class=n>s</span>: <span class=nc>S</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=n>S</span>::<span class=nb>Ok</span><span class=p>,</span><span class=w> </span><span class=n>S</span>::<span class=n>Error</span><span class=o>&gt;</span><span class=w>
</span><span class=w>    </span><span class=k>where</span><span class=w>
</span><span class=w>	</span><span class=n>S</span>: <span class=nc>Serializer</span><span class=p>,</span><span class=w>
</span><span class=w>    </span><span class=p>{</span><span class=w>
</span><span class=w>	</span><span class=k>match</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>	    </span><span class=n>Modality</span>::<span class=n>Minor</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=n>serialize_i8</span><span class=p>(</span><span class=mi>0</span><span class=p>),</span><span class=w>
</span><span class=w>	    </span><span class=n>Modality</span>::<span class=n>Major</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=n>serialize_i8</span><span class=p>(</span><span class=mi>1</span><span class=p>),</span><span class=w>
</span><span class=w>	    </span><span class=n>Modality</span>::<span class=n>NoResult</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=n>serialize_i8</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>),</span><span class=w>
</span><span class=w>	</span><span class=p>}</span><span class=w>
</span><span class=w>    </span><span class=p>}</span><span class=w>
</span><span class=w></span><span class=p>}</span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div><h2 id=move-into-module><span class=section-num>3</span> Move into module</h2>
<p>Update:</p>
<p>2021-01-15</p>
<ul>
<li><code>from(to)_millisecond_timestamp</code> have been moved into its module <code>millisecond_timestamp</code> and rename them to <code>deserialize</code> & <code>serialize</code></li>
<li><code>from(to)_duration_ms</code> have been moved into its module <code>duration_ms</code> and rename them to <code>deserialize</code> & <code>serialize</code></li>
<li><code>from(to)_option_duration_ms</code> have been moved into its module <code>option_duration_ms</code> and rename them to <code>deserialize</code> & <code>serialize</code></li>
</ul>
<h2 id=summary><span class=section-num>4</span> Summary</h2>
<p>To be honest, it&rsquo;s the first time I have needed some customized works, which took me some time to understand how does <code>Serde</code> works. Finally, all investments paid off, it works great now.</p>
<p>Serde is such an awesome deserialize/serialize framework which I have learnt a lot of from and still have a lot of to learn from.</p>
<h2 id=reference><span class=section-num>5</span> Reference</h2>
<ul>
<li><a href=https://chrismcg.com/2019/04/30/deserializing-optional-datetimes-with-serde/>Deserializing optional datetimes with serde</a></li>
<li><a href=https://github.com/ramsayleung/rspotify/pull/157>PR: Keep polishing the models</a></li>
<li><a href=https://github.com/ramsayleung/rspotify/pull/145>PR: Refactor model</a></li>
<li><a href=https://github.com/ramsayleung/rspotify/pull/177>PR: Deserialize enum from number</a></li>
</ul>
</div>
<div class=post-copyright>
<p class=copyright-item>
<span class=item-title>Author</span>
<span class=item-content>Ramsay Leung</span>
</p>
<p class=copyright-item>
<span class=item-title>LastMod</span>
<span class=item-content>
2022-02-24
</span>
</p>
</div>
<footer class=post-footer>
<div class=post-tags>
<a href=/tags/rust/>rust</a>
<a href=/tags/rspotify/>rspotify</a>
<a href=/tags/serde/>serde</a>
</div>
<nav class=post-nav>
<a class=prev href=/post/2021/iterate_through_pagination_api/>
<i class="iconfont icon-left"></i>
<span class="prev-text nav-default">Let's make everything iterable</span>
<span class="prev-text nav-mobile">Prev</span>
</a>
<a class=next href=/post/2020/996%E6%88%90%E5%9B%A0/>
<span class="next-text nav-default">为什么我们要996</span>
<span class="next-text nav-mobile">Next</span>
<i class="iconfont icon-right"></i>
</a>
</nav>
</footer>
</article>
</div>
<div id=gitalk-container></div>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css crossorigin=anonymous>
<script src=https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js crossorigin=anonymous></script>
<script type=text/javascript>var gitalk=new Gitalk({id:'2020-12-13 22:29:00 \u002b0800 \u002b0800',title:'Serde Tricks',clientID:'3c034c97f0926fafd2d6',clientSecret:'192051927d267ce83eb2ef10955890b7db2720ad',repo:'comment',owner:'ramsayleung',admin:['ramsayleung'],body:decodeURI(location.href)});gitalk.render('gitalk-container')</script>
<noscript>Please enable JavaScript to view the <a href=https://github.com/gitalk/gitalk>comments powered by gitalk.</a></noscript>
</div>
</main>
<footer id=footer class=footer>
<div class=social-links>
<a href=mailto:ramsayleung@email.com class="iconfont icon-email" title=email></a>
<a href=https://stackoverflow.com/users/5738112/ramsay class="iconfont icon-stack-overflow" title=stack-overflow></a>
<a href=http://localhost:1313 class="iconfont icon-twitter" title=twitter></a>
<a href=https://github.com/ramsayleung class="iconfont icon-github" title=github></a>
<a href=https://ramsayleung.github.io/index.xml type=application/rss+xml class="iconfont icon-rss" title=rss></a>
</div>
<div class=copyright>
<span class=power-by>
Powered by <a class=hexo-link href=https://gohugo.io>Hugo</a>
</span>
<span class=division>|</span>
<span class=theme-info>
Theme -
<a class=theme-link href=https://github.com/olOwOlo/hugo-theme-even>Even</a>
</span>
<div class=busuanzi-footer>
<span id=busuanzi_container_site_pv> site pv: <span id=busuanzi_value_site_pv><img src=/img/spinner.svg alt=spinner.svg></span> </span>
<span class=division>|</span>
<span id=busuanzi_container_site_uv> site uv: <span id=busuanzi_value_site_uv><img src=/img/spinner.svg alt=spinner.svg></span> </span>
</div>
<span class=copyright-year>
&copy;
2017 -
2022<span class=heart><i class="iconfont icon-heart"></i></span><span>Ramsay Leung</span>
</span>
</div>
</footer>
<div class=back-to-top id=back-to-top>
<i class="iconfont icon-up"></i>
</div>
</div>
<script src=https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin=anonymous></script>
<script type=text/javascript src=/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js></script>
</body>
</html>