<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>linux on 花生地</title>
    <link>https://ramsayleung.github.io/zh/categories/linux/</link>
    <description>Recent content in linux on 花生地</description>
    <image>
      <title>花生地</title>
      <url>https://ramsayleung.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E</url>
      <link>https://ramsayleung.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E</link>
    </image>
    <generator>Hugo -- 0.120.4</generator>
    <language>zh</language>
    <copyright>See this site&amp;rsquo;s source code here, licensed under GPLv3 ·</copyright>
    <lastBuildDate>Sat, 20 May 2023 08:32:35 -0700</lastBuildDate>
    <atom:link href="https://ramsayleung.github.io/zh/categories/linux/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>Linux下如何避免蓝牙音箱自动关机</title>
      <link>https://ramsayleung.github.io/zh/post/2023/linux%E4%B8%8B%E5%A6%82%E4%BD%95%E9%81%BF%E5%85%8D%E8%93%9D%E7%89%99%E9%9F%B3%E7%AE%B1%E8%87%AA%E5%8A%A8%E5%85%B3%E6%9C%BA/</link>
      <pubDate>Mon, 15 May 2023 20:48:00 -0700</pubDate>
      <guid>https://ramsayleung.github.io/zh/post/2023/linux%E4%B8%8B%E5%A6%82%E4%BD%95%E9%81%BF%E5%85%8D%E8%93%9D%E7%89%99%E9%9F%B3%E7%AE%B1%E8%87%AA%E5%8A%A8%E5%85%B3%E6%9C%BA/</guid>
      <description>1 问题 最近整理了桌上乱糟糟的线，把原来使用aux 线连接的蓝牙音响换成通过蓝牙连接。 然后就发现一个问题，只要音响没有发出声音超过30分钟，蓝牙</description>
      <content:encoded><![CDATA[<h2 id="问题"><span class="section-num">1</span> 问题</h2>
<p>最近整理了桌上乱糟糟的线，把原来使用aux 线连接的蓝牙音响换成通过蓝牙连接。 <br/></p>
<p>然后就发现一个问题，只要音响没有发出声音超过30分钟，蓝牙音响就会断开连接，并且自动关机，即使蓝牙音响连接着电源。 <br/></p>
<p>一番搜索之后，就在知乎上发现了这个问题：<a href="https://www.zhihu.com/question/41682642">求问如何避免蓝牙音箱自动关机？</a> <br/></p>
<p>但里面提到的解决方案，大多只适用于特定平台，例如Windows 或者Macos, 没有提到 Linux 上的解决方案。 <br/></p>
<p>每过半个小时手动打开蓝牙音响再连接的方式，实在是太蠢了。 <br/></p>
<h2 id="灵感"><span class="section-num">2</span> 灵感</h2>
<p>但是知乎问题里面的部分回答给了我灵感，让我们想起国内某些APP 为了保活，避免被系统kill 掉，在后台播放无声音频的操作。 <br/></p>
<p>我可以以低音量循环播放一段音频，以实现保活的作用： <br/></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">mpg123 -f <span class="m">1000</span> ~/music/listen_to_the_sea.mp3 --loop -1
</span></span></code></pre></td></tr></table>
</div>
</div><p>mpg123 是mp3 播放命令行， <code>-f 1000</code> 参数的含义是：100%的音量是32768, 1000 约等于是1000/32768 = 3% 的音量， <code>-loop -1</code> 就是指无限循环播放。 <br/></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">man mpg123
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">-f factor, --scale factor
</span></span><span class="line"><span class="cl">Change scale factor <span class="o">(</span>default: 32768<span class="o">)</span>.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">--loop <span class="nb">times</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> looping track<span class="o">(</span>s<span class="o">)</span> a certain number of times, &lt; <span class="m">0</span> means infinite loop <span class="o">(</span>not with --random!<span class="o">)</span>.
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="优化"><span class="section-num">3</span> 优化</h2>
<p>这样就实现了一个可用的版本，只是还要依赖一个 mp3 文件，肯定还有优化的空间。 <br/></p>
<p>一番调研之后发现， <code>play/sox</code> 命令可以播放指定频率和时长的声音，可以播放20 hz以下的声音，这个频率下的声音人耳是听不到的： <br/></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">play -q -n synth <span class="m">10</span> sin <span class="m">20</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><code>-q</code>: 不显示播放进度条 <br/></li>
<li><code>-n synth 10</code> 播放10秒的音频 <br/></li>
<li><code>sin 20</code> 频率为20 hz(如果听到了，可以设置成更低) <br/></li>
</ul>
<p>执行命令之后，可以使用 <code>pavucontrol</code> 命令查看声音输出，应该是类似这样的效果： <br/></p>
<p><figure>
    <img loading="lazy" src="/ox-hugo/sox_pavucontrol.png"/> 
</figure>
 <br/></p>
<h2 id="定时执行"><span class="section-num">4</span> 定时执行</h2>
<p>一直开着个terminal 窗口运行命令有点麻烦，这种重复性的工作，就可以交给 crontab, 让它每分钟执行一次，每次播放10秒。 <br/></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">* * * * * play -q -n synth <span class="m">10</span> sin <span class="m">20</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>但实际运行，发现声音不能如预期那样播放。一番搜索之后，发现 <a href="https://askubuntu.com/questions/832072/can-i-use-cron-to-chime-at-top-of-hour-like-a-grandfather-clock">StackExchange</a> 上有个答案提到需要 export 个环境变量，所以最好创建个脚本 <code>play_beep.sh</code>: <br/></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="cp">#!/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="nb">export</span> <span class="nv">XDG_RUNTIME_DIR</span><span class="o">=</span>/run/user/1000
</span></span><span class="line"><span class="cl">play -q -n synth <span class="m">10</span> sin <span class="m">10</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="k">$(</span>date<span class="k">)</span> <span class="c1"># 打印日期，主要是为了方便排查</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后再安装一个 crontab 任务: <br/></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">* * * * * /usr/bin/sh /home/ramsay/code/shell/play_beep.sh &gt;&gt; /tmp/beep.log 2&gt;<span class="p">&amp;</span><span class="m">1</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>经过验证，一天都没有断开过蓝牙，自动关机了。 <br/></p>
<h2 id="参考"><span class="section-num">5</span> 参考</h2>
<ul>
<li><a href="https://www.zhihu.com/question/41682642">求问如何避免蓝牙音箱自动关机？</a> <br/></li>
<li><a href="https://askubuntu.com/questions/832072/can-i-use-cron-to-chime-at-top-of-hour-like-a-grandfather-clock/832266#832266">Can I use cron to chime at top of hour like a grandfather clock?</a> <br/></li>
</ul>
]]></content:encoded>
    </item>
    <item>
      <title>lsof can&#39;t identify protocol</title>
      <link>https://ramsayleung.github.io/zh/post/2018/lsof_cant_identify_protocol/</link>
      <pubDate>Wed, 11 Apr 2018 15:24:00 +0800</pubDate>
      <guid>https://ramsayleung.github.io/zh/post/2018/lsof_cant_identify_protocol/</guid>
      <description>Socket 泄漏引起的Tomcat 宕机问题分析 在2018年4月9号下午，收到反馈：测试集群部分接口访问有问题，请求时而正常，时而超时。 最近的测试环境真</description>
      <content:encoded><![CDATA[<p>Socket 泄漏引起的Tomcat 宕机问题分析</p>
<p>在2018年4月9号下午，收到反馈：测试集群部分接口访问有问题，请求时而正常，时而超时。</p>
<p>最近的测试环境真的是问题多多，可是测试环境就是我搭建的，冏。查看日志发现87 这台 服务器的Tomcat 无法访问：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">2018-04-09 17:41:31,568 - [ERROR] - from org.apache.tomcat.util.net.NioEndpoint in http-nio-47001-Acceptor-0
</span></span><span class="line"><span class="cl">Socket accept failed
</span></span><span class="line"><span class="cl">java.io.IOException: Too many open files
</span></span><span class="line"><span class="cl">at sun.nio.ch.ServerSocketChannelImpl.accept0(Native Method)
</span></span><span class="line"><span class="cl">at sun.nio.ch.ServerSocketChannelImpl.accept(ServerSocketChannelImpl.java:422)
</span></span><span class="line"><span class="cl">at sun.nio.ch.ServerSocketChannelImpl.accept(ServerSocketChannelImpl.java:250)
</span></span><span class="line"><span class="cl">at org.apache.tomcat.util.net.NioEndpoint$Acceptor.run(NioEndpoint.java:825)
</span></span><span class="line"><span class="cl">at java.lang.Thread.run(Thread.java:745)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">2018-04-09 17:41:33,168 - [ERROR] - from org.apache.tomcat.util.net.NioEndpoint in http-nio-47001-Acceptor-0
</span></span><span class="line"><span class="cl">Socket accept failed
</span></span><span class="line"><span class="cl">java.io.IOException: Too many open files
</span></span><span class="line"><span class="cl">at sun.nio.ch.ServerSocketChannelImpl.accept0(Native Method)
</span></span><span class="line"><span class="cl">at sun.nio.ch.ServerSocketChannelImpl.accept(ServerSocketChannelImpl.java:422)
</span></span><span class="line"><span class="cl">at sun.nio.ch.ServerSocketChannelImpl.accept(ServerSocketChannelImpl.java:250)
</span></span><span class="line"><span class="cl">at org.apache.tomcat.util.net.NioEndpoint$Acceptor.run(NioEndpoint.java:825)
</span></span><span class="line"><span class="cl">at java.lang.Thread.run(Thread.java:745)
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="linux-文件句柄限制"><span class="section-num">1</span> Linux 文件句柄限制</h2>
<p>报错看起来像是进程打开文件句柄的个数达到了linux的限制。而这种限制是分为系统层面的和用户层面的</p>
<h3 id="系统层面"><span class="section-num">1.1</span> 系统层面</h3>
<p>系统层面的在：/proc/sys/fs/file-max里设置</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">cat /proc/sys/fs/file-max
</span></span><span class="line"><span class="cl"><span class="m">2442976</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="用户层面"><span class="section-num">1.2</span> 用户层面</h3>
<p>用户层面的限制在：/etc/security/limits.conf里设定。通过<code>ulimit -a</code> 查看系统允许单个进程打开的最大文件数：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nb">ulimit</span> -a
</span></span><span class="line"><span class="cl">core file size          <span class="o">(</span>blocks, -c<span class="o">)</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">data seg size           <span class="o">(</span>kbytes, -d<span class="o">)</span> unlimited
</span></span><span class="line"><span class="cl">scheduling priority             <span class="o">(</span>-e<span class="o">)</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">file size               <span class="o">(</span>blocks, -f<span class="o">)</span> unlimited
</span></span><span class="line"><span class="cl">pending signals                 <span class="o">(</span>-i<span class="o">)</span> <span class="m">192059</span>
</span></span><span class="line"><span class="cl">max locked memory       <span class="o">(</span>kbytes, -l<span class="o">)</span> <span class="m">64</span>
</span></span><span class="line"><span class="cl">max memory size         <span class="o">(</span>kbytes, -m<span class="o">)</span> unlimited
</span></span><span class="line"><span class="cl">open files                      <span class="o">(</span>-n<span class="o">)</span> <span class="m">65536</span>
</span></span><span class="line"><span class="cl">pipe size            <span class="o">(</span><span class="m">512</span> bytes, -p<span class="o">)</span> <span class="m">8</span>
</span></span><span class="line"><span class="cl">POSIX message queues     <span class="o">(</span>bytes, -q<span class="o">)</span> <span class="m">819200</span>
</span></span><span class="line"><span class="cl">real-time priority              <span class="o">(</span>-r<span class="o">)</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">stack size              <span class="o">(</span>kbytes, -s<span class="o">)</span> <span class="m">10240</span>
</span></span><span class="line"><span class="cl">cpu <span class="nb">time</span>               <span class="o">(</span>seconds, -t<span class="o">)</span> unlimited
</span></span><span class="line"><span class="cl">max user processes              <span class="o">(</span>-u<span class="o">)</span> <span class="m">65535</span>
</span></span><span class="line"><span class="cl">virtual memory          <span class="o">(</span>kbytes, -v<span class="o">)</span> unlimited
</span></span><span class="line"><span class="cl">file locks                      <span class="o">(</span>-x<span class="o">)</span> unlimited
</span></span></code></pre></td></tr></table>
</div>
</div><p>单个进程可以打开的最大文件数是 65536</p>
<h2 id="lsof-显示大量open-file"><span class="section-num">2</span> lsof 显示大量open file</h2>
<p>按照Tomcat 给出的报错信息，登录87 这台服务器检查打开的文件数，发现打开的文件超过70000:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">lsof <span class="p">|</span>wc -l
</span></span><span class="line"><span class="cl"><span class="m">75924</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后找出打开文件数最多的进程，按文件数降序排列，左边是 open file 的数量，右边是进程ID：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">lsof -n<span class="p">|</span>awk <span class="s1">&#39;{print $2}&#39;</span><span class="p">|</span> sort <span class="p">|</span> uniq -c <span class="p">|</span> sort -nr <span class="p">|</span> head
</span></span><span class="line"><span class="cl"><span class="m">65966</span> <span class="m">25204</span>
</span></span><span class="line"><span class="cl"><span class="m">5374</span> <span class="m">20179</span>
</span></span><span class="line"><span class="cl"><span class="m">184</span> <span class="m">27275</span>
</span></span><span class="line"><span class="cl"><span class="m">65</span> <span class="m">5361</span>
</span></span><span class="line"><span class="cl"><span class="m">61</span> <span class="m">29421</span>
</span></span><span class="line"><span class="cl"><span class="m">16</span> <span class="m">22177</span>
</span></span><span class="line"><span class="cl"><span class="m">14</span> <span class="m">19751</span>
</span></span><span class="line"><span class="cl"><span class="m">12</span> <span class="m">22181</span>
</span></span><span class="line"><span class="cl"><span class="m">12</span> <span class="m">22179</span>
</span></span><span class="line"><span class="cl"><span class="m">12</span> <span class="m">22178</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>发现 <code>25204</code> 这个进程打开了大量的文件，已经超过了单个进程的最大文件数限制。而这个进程就是部署的java 应用对应的进程。打开的文件句柄数量已经超过Linux 限制，
Tomcat 无法创建新的socket 连接。</p>
<h2 id="can-t-identify-protocol"><span class="section-num">3</span> can&rsquo;t identify protocol</h2>
<p>用 lsof 查看 java 应用打开的文件的时候，发现有非常多奇怪的输出：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">java    <span class="m">25204</span> nemo *516u  sock                0,6       0t0 <span class="m">215137625</span> can<span class="s1">&#39;t identify protocol
</span></span></span><span class="line"><span class="cl"><span class="s1">java    25204 nemo *517u  sock                0,6       0t0 215137626 can&#39;</span>t identify protocol
</span></span><span class="line"><span class="cl">java    <span class="m">25204</span> nemo *518u  sock                0,6       0t0 <span class="m">215137627</span> can<span class="s1">&#39;t identify protocol
</span></span></span><span class="line"><span class="cl"><span class="s1">java    25204 nemo *519u  sock                0,6       0t0 215137628 can&#39;</span>t identify protocol
</span></span><span class="line"><span class="cl">java    <span class="m">25204</span> nemo *520u  sock                0,6       0t0 <span class="m">215137629</span> can<span class="s1">&#39;t identify protocol
</span></span></span><span class="line"><span class="cl"><span class="s1">java    25204 nemo *521u  sock                0,6       0t0 215137630 can&#39;</span>t identify protocol
</span></span><span class="line"><span class="cl">java    <span class="m">25204</span> nemo *522u  sock                0,6       0t0 <span class="m">215137631</span> can<span class="s1">&#39;t identify protocol
</span></span></span><span class="line"><span class="cl"><span class="s1">java    25204 nemo *523u  sock                0,6       0t0 215137634 can&#39;</span>t identify protocol
</span></span><span class="line"><span class="cl">java    <span class="m">25204</span> nemo *524u  sock                0,6       0t0 <span class="m">215137635</span> can<span class="s1">&#39;t identify protocol
</span></span></span><span class="line"><span class="cl"><span class="s1">java    25204 nemo *525u  sock                0,6       0t0 215137636 can&#39;</span>t identify protocol
</span></span><span class="line"><span class="cl">java    <span class="m">25204</span> nemo *526u  sock                0,6       0t0 <span class="m">215137637</span> can<span class="s1">&#39;t identify protocol
</span></span></span><span class="line"><span class="cl"><span class="s1">java    25204 nemo *527u  sock                0,6       0t0 215137638 can&#39;</span>t identify protocol
</span></span><span class="line"><span class="cl">java    <span class="m">25204</span> nemo *528u  sock                0,6       0t0 <span class="m">215137639</span> can<span class="s1">&#39;t identify protocol
</span></span></span><span class="line"><span class="cl"><span class="s1">java    25204 nemo *529u  sock                0,6       0t0 215137640 can&#39;</span>t identify protocol
</span></span><span class="line"><span class="cl">java    <span class="m">25204</span> nemo *530u  sock                0,6       0t0 <span class="m">215137641</span> can<span class="s1">&#39;t identify protocol
</span></span></span><span class="line"><span class="cl"><span class="s1">java    25204 nemo *531u  sock                0,6       0t0 215137642 can&#39;</span>t identify protocol
</span></span><span class="line"><span class="cl">java    <span class="m">25204</span> nemo *532u  sock                0,6       0t0 <span class="m">215137644</span> can<span class="s1">&#39;t identify protocol
</span></span></span><span class="line"><span class="cl"><span class="s1">java    25204 nemo *533u  sock                0,6       0t0 215137646 can&#39;</span>t identify protocol
</span></span></code></pre></td></tr></table>
</div>
</div><p>统计之后发现， <code>can't identify protocol</code> 这样的文件数量非常多：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">lsof -p 25204<span class="p">|</span>grep <span class="s2">&#34;can&#39;t identify protocol&#34;</span><span class="p">|</span>wc -l
</span></span><span class="line"><span class="cl"><span class="m">64214</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>也就是大部份打开的文件都是属于 <code>cant' identify  protocol</code> 的文件。</p>
<h2 id="问题定位"><span class="section-num">4</span> 问题定位</h2>
<p>Google 搜索之后发现，这个 <code>cant' identify protocol</code> 的东东出现的原因是因为 这些
sockets 处于 <code>CLOSED</code> 的状态，但是却没有真正close 掉，正处于 <code>half-close</code> 状态。因此，如果使用 <code>netstat</code> 来查看socket 状态，是不会显示这些 <code>half-close</code>的 socket 的：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">netstat  -nat <span class="p">|</span>wc -l
</span></span><span class="line"><span class="cl"><span class="m">881</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>使用 <code>netstat</code> 的改进版本 <code>ss</code> 就能发现大量处于 <code>Closed</code> 状态的 socket:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">ss -s
</span></span><span class="line"><span class="cl">Total: <span class="m">76052</span> <span class="o">(</span>kernel 76254<span class="o">)</span>
</span></span><span class="line"><span class="cl">TCP:   <span class="m">75924</span> <span class="o">(</span>estab 123, closed 75524, orphaned 0, synrecv 0, timewait 173/0<span class="o">)</span>, ports <span class="m">104</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Transport Total     IP        IPv6
</span></span><span class="line"><span class="cl">*         <span class="m">76254</span>    -         -
</span></span><span class="line"><span class="cl">RAW       <span class="m">0</span>         <span class="m">0</span>         <span class="m">0</span>
</span></span><span class="line"><span class="cl">UDP       <span class="m">9</span>         <span class="m">6</span>         <span class="m">3</span>
</span></span><span class="line"><span class="cl">TCP       <span class="m">116</span>       <span class="m">80</span>        <span class="m">36</span>
</span></span><span class="line"><span class="cl">INET      <span class="m">125</span>       <span class="m">86</span>        <span class="m">39</span>
</span></span><span class="line"><span class="cl">FRAG      <span class="m">0</span>         <span class="m">0</span>         <span class="m">0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>接着查看内核的 socket 情况：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">cat /proc/net/sockstat
</span></span><span class="line"><span class="cl">sockets: used <span class="m">75724</span>
</span></span><span class="line"><span class="cl">TCP: inuse <span class="m">886</span> orphan <span class="m">0</span> tw <span class="m">0</span> alloc <span class="m">72134</span> mem <span class="m">222</span>
</span></span><span class="line"><span class="cl">UDP: inuse <span class="m">5</span> mem <span class="m">0</span>
</span></span><span class="line"><span class="cl">UDPLITE: inuse <span class="m">0</span>
</span></span><span class="line"><span class="cl">RAW: inuse <span class="m">0</span>
</span></span><span class="line"><span class="cl">FRAG: inuse <span class="m">0</span> memory <span class="m">0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>很多的 socket 处于 <code>alloc</code>, 只有少量的 socket 处于 <code>inuse</code>. 可以确认是 java 应用出现了 socket fd 的泄漏。 但是为什么会有那么多的socket 泄漏呢？</p>
<h2 id="大胆假设"><span class="section-num">5</span> 大胆假设</h2>
<p>现在可以确定的是 java应用出现了问题，导致了socket 泄漏，让 Tomcat 无法建立新连接，最终宕机。既然导致问题出现的是 java 应用，那么就应该去检查应用日志。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">2018-04-09 17:41:31,491 - [ERROR] - from com.alibaba.druid.pool.DruidDataSource in Druid-ConnectionPool-CreateScheduler--4-thread-214
</span></span><span class="line"><span class="cl">create connection error, url: jdbc:mysql://test-server-host:3306/db_name?readOnlyPropagatesToServer=false&amp;rewriteBatchedStatements=true&amp;failOverReadOnly=false&amp;socketTimeout=6000&amp;connectTimeout=20000&amp;zeroDateTimeBehavior=convertToNull&amp;allowMultiQueries=true&amp;characterEncoding=utf-8&amp;autoReconnect=true
</span></span><span class="line"><span class="cl">com.mysql.jdbc.exceptions.jdbc4.MySQLNonTransientConnectionException: Could not create connection to database server. Attempted reconnect 3 times. Giving up.
</span></span><span class="line"><span class="cl">at sun.reflect.GeneratedConstructorAccessor169.newInstance(Unknown Source)
</span></span><span class="line"><span class="cl">at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)
</span></span><span class="line"><span class="cl">at java.lang.reflect.Constructor.newInstance(Constructor.java:423)
</span></span><span class="line"><span class="cl">at com.mysql.jdbc.Util.handleNewInstance(Util.java:425)
</span></span><span class="line"><span class="cl">at com.mysql.jdbc.Util.getInstance(Util.java:408)
</span></span><span class="line"><span class="cl">at com.mysql.jdbc.SQLError.createSQLException(SQLError.java:918)
</span></span><span class="line"><span class="cl">at com.mysql.jdbc.SQLError.createSQLException(SQLError.java:897)
</span></span><span class="line"><span class="cl">at com.mysql.jdbc.SQLError.createSQLException(SQLError.java:886)
</span></span><span class="line"><span class="cl">at com.mysql.jdbc.SQLError.createSQLException(SQLError.java:860)
</span></span><span class="line"><span class="cl">at com.mysql.jdbc.ConnectionImpl.connectWithRetries(ConnectionImpl.java:2163)
</span></span><span class="line"><span class="cl">at com.mysql.jdbc.ConnectionImpl.createNewIO(ConnectionImpl.java:2088)
</span></span><span class="line"><span class="cl">at com.mysql.jdbc.ConnectionImpl.&lt;init&gt;(ConnectionImpl.java:806)
</span></span><span class="line"><span class="cl">at com.mysql.jdbc.JDBC4Connection.&lt;init&gt;(JDBC4Connection.java:47)
</span></span><span class="line"><span class="cl">at sun.reflect.GeneratedConstructorAccessor152.newInstance(Unknown Source)
</span></span><span class="line"><span class="cl">at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)
</span></span><span class="line"><span class="cl">at java.lang.reflect.Constructor.newInstance(Constructor.java:423)
</span></span><span class="line"><span class="cl">at com.mysql.jdbc.Util.handleNewInstance(Util.java:425)
</span></span><span class="line"><span class="cl">at com.mysql.jdbc.ConnectionImpl.getInstance(ConnectionImpl.java:410)
</span></span><span class="line"><span class="cl">at com.mysql.jdbc.NonRegisteringDriver.connect(NonRegisteringDriver.java:328)
</span></span><span class="line"><span class="cl">at com.alibaba.druid.filter.FilterChainImpl.connection_connect(FilterChainImpl.java:148)
</span></span><span class="line"><span class="cl">at com.alibaba.druid.filter.stat.StatFilter.connection_connect(StatFilter.java:211)
</span></span><span class="line"><span class="cl">at com.alibaba.druid.filter.FilterChainImpl.connection_connect(FilterChainImpl.java:142)
</span></span><span class="line"><span class="cl">at com.alibaba.druid.pool.DruidAbstractDataSource.createPhysicalConnection(DruidAbstractDataSource.java:1423)
</span></span><span class="line"><span class="cl">at com.alibaba.druid.pool.DruidAbstractDataSource.createPhysicalConnection(DruidAbstractDataSource.java:1477)
</span></span><span class="line"><span class="cl">at com.alibaba.druid.pool.DruidDataSource$CreateConnectionTask.runInternal(DruidDataSource.java:1884)
</span></span><span class="line"><span class="cl">at com.alibaba.druid.pool.DruidDataSource$CreateConnectionTask.run(DruidDataSource.java:1849)
</span></span><span class="line"><span class="cl">at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
</span></span><span class="line"><span class="cl">at java.util.concurrent.FutureTask.run(FutureTask.java:266)
</span></span><span class="line"><span class="cl">at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
</span></span><span class="line"><span class="cl">at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
</span></span><span class="line"><span class="cl">at java.lang.Thread.run(Thread.java:745)
</span></span><span class="line"><span class="cl">Caused by: com.mysql.jdbc.exceptions.jdbc4.CommunicationsException: Communications link failure
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">The last packet sent successfully to the server was 0 milliseconds ago. The driver has not received any packets from the server.
</span></span><span class="line"><span class="cl">at sun.reflect.GeneratedConstructorAccessor157.newInstance(Unknown Source)
</span></span><span class="line"><span class="cl">at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)
</span></span><span class="line"><span class="cl">at java.lang.reflect.Constructor.newInstance(Constructor.java:423)
</span></span><span class="line"><span class="cl">at com.mysql.jdbc.Util.handleNewInstance(Util.java:425)
</span></span><span class="line"><span class="cl">at com.mysql.jdbc.SQLError.createCommunicationsException(SQLError.java:989)
</span></span><span class="line"><span class="cl">at com.mysql.jdbc.MysqlIO.&lt;init&gt;(MysqlIO.java:341)
</span></span><span class="line"><span class="cl">at com.mysql.jdbc.ConnectionImpl.coreConnect(ConnectionImpl.java:2251)
</span></span><span class="line"><span class="cl">at com.mysql.jdbc.ConnectionImpl.connectWithRetries(ConnectionImpl.java:2104)
</span></span><span class="line"><span class="cl">... 21 common frames omitted
</span></span><span class="line"><span class="cl">Caused by: java.net.SocketException: Too many open files
</span></span><span class="line"><span class="cl">at java.net.Socket.createImpl(Socket.java:460)
</span></span><span class="line"><span class="cl">at java.net.Socket.getImpl(Socket.java:520)
</span></span><span class="line"><span class="cl">at java.net.Socket.setTcpNoDelay(Socket.java:980)
</span></span><span class="line"><span class="cl">at com.mysql.jdbc.StandardSocketFactory.configureSocket(StandardSocketFactory.java:132)
</span></span><span class="line"><span class="cl">at com.mysql.jdbc.StandardSocketFactory.connect(StandardSocketFactory.java:203)
</span></span><span class="line"><span class="cl">at com.mysql.jdbc.MysqlIO.&lt;init&gt;(MysqlIO.java:300)
</span></span><span class="line"><span class="cl">... 23 common frames omitted
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">2018-04-09 17:41:31,568 - [ERROR] - from org.apache.tomcat.util.net.NioEndpoint in http-nio-47001-Acceptor-0
</span></span><span class="line"><span class="cl">Socket accept failed
</span></span><span class="line"><span class="cl">java.io.IOException: Too many open files
</span></span><span class="line"><span class="cl">at sun.nio.ch.ServerSocketChannelImpl.accept0(Native Method)
</span></span><span class="line"><span class="cl">at sun.nio.ch.ServerSocketChannelImpl.accept(ServerSocketChannelImpl.java:422)
</span></span><span class="line"><span class="cl">at sun.nio.ch.ServerSocketChannelImpl.accept(ServerSocketChannelImpl.java:250)
</span></span><span class="line"><span class="cl">at org.apache.tomcat.util.net.NioEndpoint$Acceptor.run(NioEndpoint.java:825)
</span></span><span class="line"><span class="cl">at java.lang.Thread.run(Thread.java:745)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">2018-04-09 17:41:33,168 - [ERROR] - from org.apache.tomcat.util.net.NioEndpoint in http-nio-47001-Acceptor-0
</span></span><span class="line"><span class="cl">Socket accept failed
</span></span><span class="line"><span class="cl">java.io.IOException: Too many open files
</span></span><span class="line"><span class="cl">at sun.nio.ch.ServerSocketChannelImpl.accept0(Native Method)
</span></span><span class="line"><span class="cl">at sun.nio.ch.ServerSocketChannelImpl.accept(ServerSocketChannelImpl.java:422)
</span></span><span class="line"><span class="cl">at sun.nio.ch.ServerSocketChannelImpl.accept(ServerSocketChannelImpl.java:250)
</span></span><span class="line"><span class="cl">at org.apache.tomcat.util.net.NioEndpoint$Acceptor.run(NioEndpoint.java:825)
</span></span><span class="line"><span class="cl">at java.lang.Thread.run(Thread.java:745)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">2018-04-09 17:41:34,470 - [ERROR] - from com.alibaba.druid.pool.DruidDataSource in Druid-ConnectionPool-CreateScheduler--4-thread-216
</span></span><span class="line"><span class="cl">create connection error, url: jdbc:mysql://test-server-url:3306/db_name?readOnlyPropagatesToServer=false&amp;rewriteBatchedStatements=true&amp;failOverReadOnly=false&amp;socketTimeout=6000&amp;connectTimeout=20000&amp;zeroDateTimeBehavior=convertToNull&amp;allowMultiQueries=true&amp;characterEncoding=utf-8&amp;autoReconnect=true
</span></span><span class="line"><span class="cl">com.mysql.jdbc.exceptions.jdbc4.MySQLNonTransientConnectionException: Could not create connection to database server. Attempted reconnect 3 times. Giving up.
</span></span><span class="line"><span class="cl">at sun.reflect.GeneratedConstructorAccessor169.newInstance(Unknown Source)
</span></span><span class="line"><span class="cl">at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)
</span></span><span class="line"><span class="cl">at java.lang.reflect.Constructor.newInstance(Constructor.java:423)
</span></span><span class="line"><span class="cl">at com.mysql.jdbc.Util.handleNewInstance(Util.java:425)
</span></span><span class="line"><span class="cl">at com.mysql.jdbc.Util.getInstance(Util.java:408)
</span></span><span class="line"><span class="cl">at com.mysql.jdbc.SQLError.createSQLException(SQLError.java:918)
</span></span><span class="line"><span class="cl">at com.mysql.jdbc.SQLError.createSQLException(SQLError.java:897)
</span></span><span class="line"><span class="cl">at com.mysql.jdbc.SQLError.createSQLException(SQLError.java:886)
</span></span><span class="line"><span class="cl">at com.mysql.jdbc.SQLError.createSQLException(SQLError.java:860)
</span></span><span class="line"><span class="cl">at com.mysql.jdbc.ConnectionImpl.connectWithRetries(ConnectionImpl.java:2163)
</span></span><span class="line"><span class="cl">at com.mysql.jdbc.ConnectionImpl.createNewIO(ConnectionImpl.java:2088)
</span></span><span class="line"><span class="cl">at com.mysql.jdbc.ConnectionImpl.&lt;init&gt;(ConnectionImpl.java:806)
</span></span><span class="line"><span class="cl">at com.mysql.jdbc.JDBC4Connection.&lt;init&gt;(JDBC4Connection.java:47)
</span></span><span class="line"><span class="cl">at sun.reflect.GeneratedConstructorAccessor152.newInstance(Unknown Source)
</span></span><span class="line"><span class="cl">at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)
</span></span><span class="line"><span class="cl">at java.lang.reflect.Constructor.newInstance(Constructor.java:423)
</span></span><span class="line"><span class="cl">at com.mysql.jdbc.Util.handleNewInstance(Util.java:425)
</span></span><span class="line"><span class="cl">at com.mysql.jdbc.ConnectionImpl.getInstance(ConnectionImpl.java:410)
</span></span><span class="line"><span class="cl">at com.mysql.jdbc.NonRegisteringDriver.connect(NonRegisteringDriver.java:328)
</span></span><span class="line"><span class="cl">at com.alibaba.druid.filter.FilterChainImpl.connection_connect(FilterChainImpl.java:148)
</span></span><span class="line"><span class="cl">at com.alibaba.druid.filter.stat.StatFilter.connection_connect(StatFilter.java:211)
</span></span><span class="line"><span class="cl">at com.alibaba.druid.filter.FilterChainImpl.connection_connect(FilterChainImpl.java:142)
</span></span><span class="line"><span class="cl">at com.alibaba.druid.pool.DruidAbstractDataSource.createPhysicalConnection(DruidAbstractDataSource.java:1423)
</span></span><span class="line"><span class="cl">at com.alibaba.druid.pool.DruidAbstractDataSource.createPhysicalConnection(DruidAbstractDataSource.java:1477)
</span></span><span class="line"><span class="cl">at com.alibaba.druid.pool.DruidDataSource$CreateConnectionTask.runInternal(DruidDataSource.java:1884)
</span></span><span class="line"><span class="cl">at com.alibaba.druid.pool.DruidDataSource$CreateConnectionTask.run(DruidDataSource.java:1849)
</span></span><span class="line"><span class="cl">at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
</span></span><span class="line"><span class="cl">at java.util.concurrent.FutureTask.run(FutureTask.java:266)
</span></span><span class="line"><span class="cl">at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$201(ScheduledThreadPoolExecutor.java:180)
</span></span><span class="line"><span class="cl">at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:293)
</span></span><span class="line"><span class="cl">at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
</span></span><span class="line"><span class="cl">at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
</span></span><span class="line"><span class="cl">at java.lang.Thread.run(Thread.java:745)
</span></span><span class="line"><span class="cl">Caused by: com.mysql.jdbc.exceptions.jdbc4.CommunicationsException: Communications link failure
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">The last packet sent successfully to the server was 0 milliseconds ago. The driver has not received any packets from the server.
</span></span><span class="line"><span class="cl">at sun.reflect.GeneratedConstructorAccessor157.newInstance(Unknown Source)
</span></span><span class="line"><span class="cl">at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)
</span></span><span class="line"><span class="cl">at java.lang.reflect.Constructor.newInstance(Constructor.java:423)
</span></span><span class="line"><span class="cl">at com.mysql.jdbc.Util.handleNewInstance(Util.java:425)
</span></span><span class="line"><span class="cl">at com.mysql.jdbc.SQLError.createCommunicationsException(SQLError.java:989)
</span></span><span class="line"><span class="cl">at com.mysql.jdbc.MysqlIO.&lt;init&gt;(MysqlIO.java:341)
</span></span><span class="line"><span class="cl">at com.mysql.jdbc.ConnectionImpl.coreConnect(ConnectionImpl.java:2251)
</span></span><span class="line"><span class="cl">at com.mysql.jdbc.ConnectionImpl.connectWithRetries(ConnectionImpl.java:2104)
</span></span><span class="line"><span class="cl">... 23 common frames omitted
</span></span><span class="line"><span class="cl">Caused by: java.net.SocketException: Too many open files
</span></span><span class="line"><span class="cl">at java.net.Socket.createImpl(Socket.java:460)
</span></span><span class="line"><span class="cl">at java.net.Socket.getImpl(Socket.java:520)
</span></span><span class="line"><span class="cl">at java.net.Socket.setTcpNoDelay(Socket.java:980)
</span></span><span class="line"><span class="cl">at com.mysql.jdbc.StandardSocketFactory.configureSocket(StandardSocketFactory.java:132)
</span></span><span class="line"><span class="cl">at com.mysql.jdbc.StandardSocketFactory.connect(StandardSocketFactory.java:203)
</span></span><span class="line"><span class="cl">at com.mysql.jdbc.MysqlIO.&lt;init&gt;(MysqlIO.java:300)
</span></span><span class="line"><span class="cl">... 25 common frames omitted
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">2018-04-09 17:41:34,769 - [ERROR] - from org.apache.tomcat.util.net.NioEndpoint in http-nio-47001-Acceptor-0
</span></span><span class="line"><span class="cl">Socket accept failed
</span></span><span class="line"><span class="cl">java.io.IOException: Too many open files
</span></span><span class="line"><span class="cl">at sun.nio.ch.ServerSocketChannelImpl.accept0(Native Method)
</span></span><span class="line"><span class="cl">at sun.nio.ch.ServerSocketChannelImpl.accept(ServerSocketChannelImpl.java:422)
</span></span><span class="line"><span class="cl">at sun.nio.ch.ServerSocketChannelImpl.accept(ServerSocketChannelImpl.java:250)
</span></span><span class="line"><span class="cl">at org.apache.tomcat.util.net.NioEndpoint$Acceptor.run(NioEndpoint.java:825)
</span></span><span class="line"><span class="cl">at java.lang.Thread.run(Thread.java:745)
</span></span></code></pre></td></tr></table>
</div>
</div><p>检查日志发现，在 Tomcat 彻底挂机之前，曾经有比较大量的数据源连接池出错，无法访问 Mysql, 但是非常奇怪的是，在87 这台机器上面，是可以使用 mysql 命令行连接到测试数据库的，说明 Mysql 的连接是没有问题。</p>
<p>但是数据源连接就会出错！！ 真的是很奇怪，为什么连接池会报错，有没有可能是这些异常导致 socket 泄漏呢？后来，在本地运行应用，有时候会发现IDE 的控制台报错：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span><span class="lnt">97
</span><span class="lnt">98
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="mi">2018</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">11</span> <span class="mi">09</span><span class="p">:</span><span class="mi">43</span><span class="p">:</span><span class="mi">48</span><span class="p">,</span><span class="mi">363</span> <span class="o">-</span> <span class="p">[</span><span class="n">ERROR</span><span class="p">]</span> <span class="o">-</span> <span class="n">from</span> <span class="n">com</span><span class="o">.</span><span class="n">alibaba</span><span class="o">.</span><span class="n">druid</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">DruidDataSource</span> <span class="ow">in</span> <span class="n">poolTaskScheduler</span><span class="o">-</span><span class="mi">11</span>
</span></span><span class="line"><span class="cl"><span class="n">discard</span> <span class="n">connection</span>
</span></span><span class="line"><span class="cl"><span class="n">com</span><span class="o">.</span><span class="n">mysql</span><span class="o">.</span><span class="n">jdbc</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">jdbc4</span><span class="o">.</span><span class="n">CommunicationsException</span><span class="p">:</span> <span class="n">Communications</span> <span class="n">link</span> <span class="n">failure</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">The</span> <span class="n">last</span> <span class="n">packet</span> <span class="n">successfully</span> <span class="n">received</span> <span class="n">from</span> <span class="n">the</span> <span class="n">server</span> <span class="n">was</span> <span class="mi">100</span><span class="p">,</span><span class="mi">610</span> <span class="n">milliseconds</span> <span class="n">ago</span><span class="o">.</span>  <span class="n">The</span> <span class="n">last</span> <span class="n">packet</span> <span class="n">sent</span> <span class="n">successfully</span> <span class="n">to</span> <span class="n">the</span> <span class="n">server</span> <span class="n">was</span> <span class="mi">0</span> <span class="n">milliseconds</span> <span class="n">ago</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">sun</span><span class="o">.</span><span class="n">reflect</span><span class="o">.</span><span class="n">GeneratedConstructorAccessor108</span><span class="o">.</span><span class="n">newInstance</span><span class="p">(</span><span class="n">Unknown</span> <span class="n">Source</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">sun</span><span class="o">.</span><span class="n">reflect</span><span class="o">.</span><span class="n">DelegatingConstructorAccessorImpl</span><span class="o">.</span><span class="n">newInstance</span><span class="p">(</span><span class="n">DelegatingConstructorAccessorImpl</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">45</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="n">lang</span><span class="o">.</span><span class="n">reflect</span><span class="o">.</span><span class="n">Constructor</span><span class="o">.</span><span class="n">newInstance</span><span class="p">(</span><span class="n">Constructor</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">423</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="n">mysql</span><span class="o">.</span><span class="n">jdbc</span><span class="o">.</span><span class="n">Util</span><span class="o">.</span><span class="n">handleNewInstance</span><span class="p">(</span><span class="n">Util</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">425</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="n">mysql</span><span class="o">.</span><span class="n">jdbc</span><span class="o">.</span><span class="n">SQLError</span><span class="o">.</span><span class="n">createCommunicationsException</span><span class="p">(</span><span class="n">SQLError</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">989</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="n">mysql</span><span class="o">.</span><span class="n">jdbc</span><span class="o">.</span><span class="n">MysqlIO</span><span class="o">.</span><span class="n">reuseAndReadPacket</span><span class="p">(</span><span class="n">MysqlIO</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">3556</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="n">mysql</span><span class="o">.</span><span class="n">jdbc</span><span class="o">.</span><span class="n">MysqlIO</span><span class="o">.</span><span class="n">reuseAndReadPacket</span><span class="p">(</span><span class="n">MysqlIO</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">3456</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="n">mysql</span><span class="o">.</span><span class="n">jdbc</span><span class="o">.</span><span class="n">MysqlIO</span><span class="o">.</span><span class="n">checkErrorPacket</span><span class="p">(</span><span class="n">MysqlIO</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">3897</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="n">mysql</span><span class="o">.</span><span class="n">jdbc</span><span class="o">.</span><span class="n">MysqlIO</span><span class="o">.</span><span class="n">sendCommand</span><span class="p">(</span><span class="n">MysqlIO</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">2524</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="n">mysql</span><span class="o">.</span><span class="n">jdbc</span><span class="o">.</span><span class="n">MysqlIO</span><span class="o">.</span><span class="n">sqlQueryDirect</span><span class="p">(</span><span class="n">MysqlIO</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">2677</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="n">mysql</span><span class="o">.</span><span class="n">jdbc</span><span class="o">.</span><span class="n">ConnectionImpl</span><span class="o">.</span><span class="n">execSQL</span><span class="p">(</span><span class="n">ConnectionImpl</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">2545</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="n">mysql</span><span class="o">.</span><span class="n">jdbc</span><span class="o">.</span><span class="n">ConnectionImpl</span><span class="o">.</span><span class="n">execSQL</span><span class="p">(</span><span class="n">ConnectionImpl</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">2503</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="n">mysql</span><span class="o">.</span><span class="n">jdbc</span><span class="o">.</span><span class="n">StatementImpl</span><span class="o">.</span><span class="n">executeQuery</span><span class="p">(</span><span class="n">StatementImpl</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">1369</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="n">alibaba</span><span class="o">.</span><span class="n">druid</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">FilterChainImpl</span><span class="o">.</span><span class="n">statement_executeQuery</span><span class="p">(</span><span class="n">FilterChainImpl</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">2363</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="n">alibaba</span><span class="o">.</span><span class="n">druid</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">FilterAdapter</span><span class="o">.</span><span class="n">statement_executeQuery</span><span class="p">(</span><span class="n">FilterAdapter</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">2481</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="n">alibaba</span><span class="o">.</span><span class="n">druid</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">FilterEventAdapter</span><span class="o">.</span><span class="n">statement_executeQuery</span><span class="p">(</span><span class="n">FilterEventAdapter</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">302</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="n">alibaba</span><span class="o">.</span><span class="n">druid</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">FilterChainImpl</span><span class="o">.</span><span class="n">statement_executeQuery</span><span class="p">(</span><span class="n">FilterChainImpl</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">2360</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="n">alibaba</span><span class="o">.</span><span class="n">druid</span><span class="o">.</span><span class="n">proxy</span><span class="o">.</span><span class="n">jdbc</span><span class="o">.</span><span class="n">StatementProxyImpl</span><span class="o">.</span><span class="n">executeQuery</span><span class="p">(</span><span class="n">StatementProxyImpl</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">211</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="n">alibaba</span><span class="o">.</span><span class="n">druid</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">DruidPooledStatement</span><span class="o">.</span><span class="n">executeQuery</span><span class="p">(</span><span class="n">DruidPooledStatement</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">138</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="n">taobao</span><span class="o">.</span><span class="n">tddl</span><span class="o">.</span><span class="n">atom</span><span class="o">.</span><span class="n">jdbc</span><span class="o">.</span><span class="n">TStatementWrapper</span><span class="o">.</span><span class="n">executeQuery</span><span class="p">(</span><span class="n">TStatementWrapper</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">315</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="n">taobao</span><span class="o">.</span><span class="n">tddl</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">jdbc</span><span class="o">.</span><span class="n">TGroupStatement</span><span class="o">.</span><span class="n">executeQueryOnConnection</span><span class="p">(</span><span class="n">TGroupStatement</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">549</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="n">taobao</span><span class="o">.</span><span class="n">tddl</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">jdbc</span><span class="o">.</span><span class="n">TGroupStatement</span><span class="o">$</span><span class="mf">4.</span><span class="n">tryOnDataSource</span><span class="p">(</span><span class="n">TGroupStatement</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">633</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="n">taobao</span><span class="o">.</span><span class="n">tddl</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">jdbc</span><span class="o">.</span><span class="n">TGroupStatement</span><span class="o">$</span><span class="mf">4.</span><span class="n">tryOnDataSource</span><span class="p">(</span><span class="n">TGroupStatement</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">615</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="n">taobao</span><span class="o">.</span><span class="n">tddl</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">dbselector</span><span class="o">.</span><span class="n">AbstractDBSelector</span><span class="o">.</span><span class="n">tryOnDataSourceHolder</span><span class="p">(</span><span class="n">AbstractDBSelector</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">155</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="n">taobao</span><span class="o">.</span><span class="n">tddl</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">dbselector</span><span class="o">.</span><span class="n">OneDBSelector</span><span class="o">.</span><span class="n">tryExecuteInternal</span><span class="p">(</span><span class="n">OneDBSelector</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">52</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="n">taobao</span><span class="o">.</span><span class="n">tddl</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">dbselector</span><span class="o">.</span><span class="n">AbstractDBSelector</span><span class="o">.</span><span class="n">tryExecute</span><span class="p">(</span><span class="n">AbstractDBSelector</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">405</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="n">taobao</span><span class="o">.</span><span class="n">tddl</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">dbselector</span><span class="o">.</span><span class="n">AbstractDBSelector</span><span class="o">.</span><span class="n">tryExecute</span><span class="p">(</span><span class="n">AbstractDBSelector</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">412</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="n">taobao</span><span class="o">.</span><span class="n">tddl</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">jdbc</span><span class="o">.</span><span class="n">TGroupStatement</span><span class="o">.</span><span class="n">executeQuery</span><span class="p">(</span><span class="n">TGroupStatement</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">488</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="n">taobao</span><span class="o">.</span><span class="n">tddl</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">jdbc</span><span class="o">.</span><span class="n">TGroupStatement</span><span class="o">.</span><span class="n">executeInternal</span><span class="p">(</span><span class="n">TGroupStatement</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">131</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="n">taobao</span><span class="o">.</span><span class="n">tddl</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">jdbc</span><span class="o">.</span><span class="n">TGroupStatement</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">TGroupStatement</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">101</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="n">taobao</span><span class="o">.</span><span class="n">tddl</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">mysql</span><span class="o">.</span><span class="n">spi</span><span class="o">.</span><span class="n">My_JdbcHandler</span><span class="o">.</span><span class="n">executeQuery</span><span class="p">(</span><span class="n">My_JdbcHandler</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">521</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="n">taobao</span><span class="o">.</span><span class="n">tddl</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">mysql</span><span class="o">.</span><span class="n">spi</span><span class="o">.</span><span class="n">My_Cursor</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">My_Cursor</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">106</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="n">taobao</span><span class="o">.</span><span class="n">tddl</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">mysql</span><span class="o">.</span><span class="n">handler</span><span class="o">.</span><span class="n">QueryMyHandler</span><span class="o">.</span><span class="n">handle</span><span class="p">(</span><span class="n">QueryMyHandler</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">89</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="n">taobao</span><span class="o">.</span><span class="n">tddl</span><span class="o">.</span><span class="n">executor</span><span class="o">.</span><span class="n">AbstractGroupExecutor</span><span class="o">.</span><span class="n">executeInner</span><span class="p">(</span><span class="n">AbstractGroupExecutor</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">47</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="n">taobao</span><span class="o">.</span><span class="n">tddl</span><span class="o">.</span><span class="n">executor</span><span class="o">.</span><span class="n">AbstractGroupExecutor</span><span class="o">.</span><span class="n">execByExecPlanNode</span><span class="p">(</span><span class="n">AbstractGroupExecutor</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">36</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="n">taobao</span><span class="o">.</span><span class="n">tddl</span><span class="o">.</span><span class="n">executor</span><span class="o">.</span><span class="n">TopologyExecutor</span><span class="o">.</span><span class="n">execByExecPlanNode</span><span class="p">(</span><span class="n">TopologyExecutor</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">66</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="n">taobao</span><span class="o">.</span><span class="n">tddl</span><span class="o">.</span><span class="n">executor</span><span class="o">.</span><span class="n">MatrixExecutor</span><span class="o">.</span><span class="n">execByExecPlanNodeByOne</span><span class="p">(</span><span class="n">MatrixExecutor</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">670</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="n">taobao</span><span class="o">.</span><span class="n">tddl</span><span class="o">.</span><span class="n">executor</span><span class="o">.</span><span class="n">MatrixExecutor</span><span class="o">.</span><span class="n">execByExecPlanNode</span><span class="p">(</span><span class="n">MatrixExecutor</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">659</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="n">taobao</span><span class="o">.</span><span class="n">tddl</span><span class="o">.</span><span class="n">executor</span><span class="o">.</span><span class="n">MatrixExecutor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">MatrixExecutor</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">137</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="n">taobao</span><span class="o">.</span><span class="n">tddl</span><span class="o">.</span><span class="n">matrix</span><span class="o">.</span><span class="n">jdbc</span><span class="o">.</span><span class="n">TConnection</span><span class="o">.</span><span class="n">executeSQL</span><span class="p">(</span><span class="n">TConnection</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">241</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="n">taobao</span><span class="o">.</span><span class="n">tddl</span><span class="o">.</span><span class="n">matrix</span><span class="o">.</span><span class="n">jdbc</span><span class="o">.</span><span class="n">TPreparedStatement</span><span class="o">.</span><span class="n">executeSQL</span><span class="p">(</span><span class="n">TPreparedStatement</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">64</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="n">taobao</span><span class="o">.</span><span class="n">tddl</span><span class="o">.</span><span class="n">matrix</span><span class="o">.</span><span class="n">jdbc</span><span class="o">.</span><span class="n">TStatement</span><span class="o">.</span><span class="n">executeInternal</span><span class="p">(</span><span class="n">TStatement</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">133</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="n">taobao</span><span class="o">.</span><span class="n">tddl</span><span class="o">.</span><span class="n">matrix</span><span class="o">.</span><span class="n">jdbc</span><span class="o">.</span><span class="n">TPreparedStatement</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">TPreparedStatement</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">49</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">sun</span><span class="o">.</span><span class="n">reflect</span><span class="o">.</span><span class="n">GeneratedMethodAccessor148</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">Unknown</span> <span class="n">Source</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">sun</span><span class="o">.</span><span class="n">reflect</span><span class="o">.</span><span class="n">DelegatingMethodAccessorImpl</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">DelegatingMethodAccessorImpl</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">43</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="n">lang</span><span class="o">.</span><span class="n">reflect</span><span class="o">.</span><span class="n">Method</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">Method</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">498</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="n">apache</span><span class="o">.</span><span class="n">ibatis</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">jdbc</span><span class="o">.</span><span class="n">PreparedStatementLogger</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">PreparedStatementLogger</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">59</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="n">sun</span><span class="o">.</span><span class="n">proxy</span><span class="o">.$</span><span class="n">Proxy102</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">Unknown</span> <span class="n">Source</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="n">apache</span><span class="o">.</span><span class="n">ibatis</span><span class="o">.</span><span class="n">executor</span><span class="o">.</span><span class="n">statement</span><span class="o">.</span><span class="n">PreparedStatementHandler</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">PreparedStatementHandler</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">63</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="n">apache</span><span class="o">.</span><span class="n">ibatis</span><span class="o">.</span><span class="n">executor</span><span class="o">.</span><span class="n">statement</span><span class="o">.</span><span class="n">RoutingStatementHandler</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">RoutingStatementHandler</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">79</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="n">apache</span><span class="o">.</span><span class="n">ibatis</span><span class="o">.</span><span class="n">executor</span><span class="o">.</span><span class="n">SimpleExecutor</span><span class="o">.</span><span class="n">doQuery</span><span class="p">(</span><span class="n">SimpleExecutor</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">63</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="n">apache</span><span class="o">.</span><span class="n">ibatis</span><span class="o">.</span><span class="n">executor</span><span class="o">.</span><span class="n">BaseExecutor</span><span class="o">.</span><span class="n">queryFromDatabase</span><span class="p">(</span><span class="n">BaseExecutor</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">325</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="n">apache</span><span class="o">.</span><span class="n">ibatis</span><span class="o">.</span><span class="n">executor</span><span class="o">.</span><span class="n">BaseExecutor</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">BaseExecutor</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">156</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="n">apache</span><span class="o">.</span><span class="n">ibatis</span><span class="o">.</span><span class="n">executor</span><span class="o">.</span><span class="n">CachingExecutor</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">CachingExecutor</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">109</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="n">apache</span><span class="o">.</span><span class="n">ibatis</span><span class="o">.</span><span class="n">executor</span><span class="o">.</span><span class="n">CachingExecutor</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">CachingExecutor</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">83</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">sun</span><span class="o">.</span><span class="n">reflect</span><span class="o">.</span><span class="n">GeneratedMethodAccessor146</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">Unknown</span> <span class="n">Source</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">sun</span><span class="o">.</span><span class="n">reflect</span><span class="o">.</span><span class="n">DelegatingMethodAccessorImpl</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">DelegatingMethodAccessorImpl</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">43</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="n">lang</span><span class="o">.</span><span class="n">reflect</span><span class="o">.</span><span class="n">Method</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">Method</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">498</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="n">apache</span><span class="o">.</span><span class="n">ibatis</span><span class="o">.</span><span class="n">plugin</span><span class="o">.</span><span class="n">Invocation</span><span class="o">.</span><span class="n">proceed</span><span class="p">(</span><span class="n">Invocation</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">49</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">fastfish</span><span class="o">.</span><span class="n">interceptor</span><span class="o">.</span><span class="n">DbLogInterceptor</span><span class="o">.</span><span class="n">intercept</span><span class="p">(</span><span class="n">DbLogInterceptor</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">49</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="n">apache</span><span class="o">.</span><span class="n">ibatis</span><span class="o">.</span><span class="n">plugin</span><span class="o">.</span><span class="n">Plugin</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">Plugin</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">61</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="n">sun</span><span class="o">.</span><span class="n">proxy</span><span class="o">.$</span><span class="n">Proxy100</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Unknown</span> <span class="n">Source</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="n">apache</span><span class="o">.</span><span class="n">ibatis</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">DefaultSqlSession</span><span class="o">.</span><span class="n">selectList</span><span class="p">(</span><span class="n">DefaultSqlSession</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">148</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="n">apache</span><span class="o">.</span><span class="n">ibatis</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">DefaultSqlSession</span><span class="o">.</span><span class="n">selectList</span><span class="p">(</span><span class="n">DefaultSqlSession</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">141</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">sun</span><span class="o">.</span><span class="n">reflect</span><span class="o">.</span><span class="n">GeneratedMethodAccessor145</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">Unknown</span> <span class="n">Source</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">sun</span><span class="o">.</span><span class="n">reflect</span><span class="o">.</span><span class="n">DelegatingMethodAccessorImpl</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">DelegatingMethodAccessorImpl</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">43</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="n">lang</span><span class="o">.</span><span class="n">reflect</span><span class="o">.</span><span class="n">Method</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">Method</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">498</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="n">mybatis</span><span class="o">.</span><span class="n">spring</span><span class="o">.</span><span class="n">SqlSessionTemplate</span><span class="o">$</span><span class="n">SqlSessionInterceptor</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">SqlSessionTemplate</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">434</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="n">sun</span><span class="o">.</span><span class="n">proxy</span><span class="o">.$</span><span class="n">Proxy87</span><span class="o">.</span><span class="n">selectList</span><span class="p">(</span><span class="n">Unknown</span> <span class="n">Source</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="n">mybatis</span><span class="o">.</span><span class="n">spring</span><span class="o">.</span><span class="n">SqlSessionTemplate</span><span class="o">.</span><span class="n">selectList</span><span class="p">(</span><span class="n">SqlSessionTemplate</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">231</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="n">apache</span><span class="o">.</span><span class="n">ibatis</span><span class="o">.</span><span class="n">binding</span><span class="o">.</span><span class="n">MapperMethod</span><span class="o">.</span><span class="n">executeForMany</span><span class="p">(</span><span class="n">MapperMethod</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">128</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="n">apache</span><span class="o">.</span><span class="n">ibatis</span><span class="o">.</span><span class="n">binding</span><span class="o">.</span><span class="n">MapperMethod</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">MapperMethod</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">68</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="n">apache</span><span class="o">.</span><span class="n">ibatis</span><span class="o">.</span><span class="n">binding</span><span class="o">.</span><span class="n">MapperProxy</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">MapperProxy</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">53</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="n">sun</span><span class="o">.</span><span class="n">proxy</span><span class="o">.$</span><span class="n">Proxy124</span><span class="o">.</span><span class="n">selectAll</span><span class="p">(</span><span class="n">Unknown</span> <span class="n">Source</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">fastfish</span><span class="o">.</span><span class="n">services</span><span class="o">.</span><span class="n">BusinessService</span><span class="o">.</span><span class="n">getAll</span><span class="p">(</span><span class="n">BusinessService</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">73</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">fastfish</span><span class="o">.</span><span class="n">services</span><span class="o">.</span><span class="n">BusinessService</span><span class="o">.</span><span class="n">loadDB</span><span class="p">(</span><span class="n">BusinessService</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">38</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">sun</span><span class="o">.</span><span class="n">reflect</span><span class="o">.</span><span class="n">GeneratedMethodAccessor190</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">Unknown</span> <span class="n">Source</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">sun</span><span class="o">.</span><span class="n">reflect</span><span class="o">.</span><span class="n">DelegatingMethodAccessorImpl</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">DelegatingMethodAccessorImpl</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">43</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="n">lang</span><span class="o">.</span><span class="n">reflect</span><span class="o">.</span><span class="n">Method</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">Method</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">498</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="n">springframework</span><span class="o">.</span><span class="n">scheduling</span><span class="o">.</span><span class="n">support</span><span class="o">.</span><span class="n">ScheduledMethodRunnable</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">ScheduledMethodRunnable</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">65</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="n">springframework</span><span class="o">.</span><span class="n">scheduling</span><span class="o">.</span><span class="n">support</span><span class="o">.</span><span class="n">DelegatingErrorHandlingRunnable</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">DelegatingErrorHandlingRunnable</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">54</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">concurrent</span><span class="o">.</span><span class="n">Executors</span><span class="o">$</span><span class="n">RunnableAdapter</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">Executors</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">511</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">concurrent</span><span class="o">.</span><span class="n">FutureTask</span><span class="o">.</span><span class="n">runAndReset</span><span class="o">$$$</span><span class="n">capture</span><span class="p">(</span><span class="n">FutureTask</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">308</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">concurrent</span><span class="o">.</span><span class="n">FutureTask</span><span class="o">.</span><span class="n">runAndReset</span><span class="p">(</span><span class="n">FutureTask</span><span class="o">.</span><span class="n">java</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">concurrent</span><span class="o">.</span><span class="n">ScheduledThreadPoolExecutor</span><span class="o">$</span><span class="n">ScheduledFutureTask</span><span class="o">.</span><span class="n">access</span><span class="o">$</span><span class="mi">301</span><span class="p">(</span><span class="n">ScheduledThreadPoolExecutor</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">180</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">concurrent</span><span class="o">.</span><span class="n">ScheduledThreadPoolExecutor</span><span class="o">$</span><span class="n">ScheduledFutureTask</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">ScheduledThreadPoolExecutor</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">294</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">concurrent</span><span class="o">.</span><span class="n">ThreadPoolExecutor</span><span class="o">.</span><span class="n">runWorker</span><span class="p">(</span><span class="n">ThreadPoolExecutor</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">1149</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">concurrent</span><span class="o">.</span><span class="n">ThreadPoolExecutor</span><span class="o">$</span><span class="n">Worker</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">ThreadPoolExecutor</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">624</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="n">lang</span><span class="o">.</span><span class="n">Thread</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="ne">Thread</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">748</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Caused</span> <span class="n">by</span><span class="p">:</span> <span class="n">java</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">EOFException</span><span class="p">:</span> <span class="n">Can</span> <span class="ow">not</span> <span class="n">read</span> <span class="n">response</span> <span class="n">from</span> <span class="n">server</span><span class="o">.</span> <span class="n">Expected</span> <span class="n">to</span> <span class="n">read</span> <span class="mi">4</span> <span class="n">bytes</span><span class="p">,</span> <span class="n">read</span> <span class="mi">0</span> <span class="n">bytes</span> <span class="n">before</span> <span class="n">connection</span> <span class="n">was</span> <span class="n">unexpectedly</span> <span class="n">lost</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="n">mysql</span><span class="o">.</span><span class="n">jdbc</span><span class="o">.</span><span class="n">MysqlIO</span><span class="o">.</span><span class="n">readFully</span><span class="p">(</span><span class="n">MysqlIO</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">3008</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="n">mysql</span><span class="o">.</span><span class="n">jdbc</span><span class="o">.</span><span class="n">MysqlIO</span><span class="o">.</span><span class="n">reuseAndReadPacket</span><span class="p">(</span><span class="n">MysqlIO</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">3466</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span> <span class="mi">83</span> <span class="n">common</span> <span class="n">frames</span> <span class="n">omitted</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>是数据池连接出错。但是我本地的应用确实是可以访问测试数据库的， 比较有趣的异常就是</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Caused by: java.io.EOFException: Can not read response from server. Expected to read 4 bytes, read 0 bytes before connection was unexpectedly lost.
</span></span></code></pre></td></tr></table>
</div>
</div><p>数据还没有读完， Connection 就丢了。为什么会 lost connection 呢，可能数据库出问题，也可能是网络出了问题。</p>
<p>我还能从数据库读到数据，说明数据库没问题的，兼之这个异常只是偶尔出现，所以可能就是网络出问题了。</p>
<p>如此说来，是否可能是因为测试环境网络不稳定，连接池无法和 Mysql 保持连接，在丢掉 Connection 之后，连接池重新发起连接，但是因为网络不稳定又丢掉了Connection, 不断循环这个过程，导致建立的 socket 连接越 来越多，但是建立的 socket 很快就被Close 掉了，内核又没有把这些 Close 掉的 socket 资源回收掉，因此打开的 socket 文件越来越多，最后导致 Tomcat 因为打开的文件过多无法建立新的 socket 连接。</p>
<h2 id="小心求证"><span class="section-num">6</span> 小心求证</h2>
<p>如果连接池真的不断尝试连接Mysql 的话，必定会建立很多的连接，而Mysql 是会将这些记录保存下来的，检查Mysql 的变量：</p>
<figure>
    <img loading="lazy" src="https://imgur.com/gAxepYH.png"/> 
</figure>

<p>查看Mysql 的文档关于 <code>Connection</code> 和 <code>Thread_connected</code> 的说明：</p>
<ul>
<li>
<p>Connections</p>
<blockquote>
<p>The number of connection attempts (successful or not) to the MySQL server.</p>
</blockquote>
</li>
<li>
<p>Threads_connected</p>
<blockquote>
<p>The number of currently open connections.</p>
</blockquote>
</li>
</ul>
<p>也就是说，当时共有20000 多的连接请求，但是真正被 Mysql accpet 并且服务的只有 28 个连接。看来的确是因为连接池的连接导致 socket 泄漏</p>
<h3 id="更新"><span class="section-num">6.1</span> 更新</h3>
<p>和运维同学沟通之后，发现丢连接的原因不是网络不稳定，而是测试集群都是虚拟机，内存 用光，导致无法建立新的连接，内核释放一部分资源之后又可以建立连接了。内存用完，我能怎么办，我也很无奈。</p>
<h2 id="解决方法"><span class="section-num">7</span> 解决方法</h2>
<p>虽说基本确定了 socket 泄漏的源头，但是对于内核为什么无法回收已经关闭 socket 的原因依然不明确。</p>
<p>最令人百思不得其解的是，部署了应用的测试服务器有两台，另外一 台服务器也有同样的连接池问题，但是却没有出现 socket 泄漏问题， 出现泄漏的只有 87 这台机器。真的令人费解. 所以最后解决方法就是撤下 87 服务器的应用，换一台服务器来部署。</p>
<p>新的服务器部署应用之后虽说也有同样的数据库连接池异常，但是却没有出现 socket 泄漏，初步定位是 87这台机器的内核环境存在问题。</p>
<h2 id="参考"><span class="section-num">8</span> 参考</h2>
<ul>
<li><a href="http://mdba.cn/2015/03/10/tcp-socket%E6%96%87%E4%BB%B6%E5%8F%A5%E6%9F%84%E6%B3%84%E6%BC%8F/">tcp-socket文件句柄泄漏/</a></li>
<li><a href="https://idea.popcount.org/2012-12-09-lsof-cant-identify-protocol/">lsof-cant-identify-protocol/</a></li>
</ul>
]]></content:encoded>
    </item>
    <item>
      <title>大话Linux文件系统</title>
      <link>https://ramsayleung.github.io/zh/post/2017/linux_file_system/</link>
      <pubDate>Thu, 30 Mar 2017 00:00:00 +0800</pubDate>
      <guid>https://ramsayleung.github.io/zh/post/2017/linux_file_system/</guid>
      <description>an discussion about linux file system</description>
      <content:encoded><![CDATA[<p>不久前，Apple 的文件系统 (Apple File System) 新推出，然后各方便一起挤身向前对APFS &ldquo;评头品足&rdquo;,我是不了解 APFS ,所以也没有什么发言权嘛，不过话分两头；</p>
<p>对Linux的文件系统，我还是有了解过的，所以可以聊聊Linux 的文件系统；与Windows 和Apple 两家商业公司不同，Linux 是开源的，因此，只要你有足够的时间和能力，你就可以自己写一个文件系统，这个也是Linux 文件系统众多的主要原因。</p>
<p>那么有众多的Linux 文件系统，它们的差异,优缺点又是什么呢？</p>
<h2 id="file-system"><span class="section-num">1</span> File System</h2>
<p>在开始 &ldquo;大话&rdquo; 各种文件系统的时候，我先想谈谈什么是文件系统。</p>
<p>一般用户平时都会有上百G 的数据，那么多的数据，应该怎么保存呢？</p>
<p>不知道怎么回答，可以先类比一下，想象一下你有很多书，你会怎么放置你的书籍呢？直接丢在客厅中间？或者是按书内容分类 放到书架上？如果分类的话，是按怎么划分呢？你买回来的书架一次可以放置多少书籍呢？怎么才能更快地找到你要找的书呢？</p>
<p>其实文件系统处理，检索文件和你放置，查找书籍是类似的！此外,在Windows 下常见到的格式化，其实就是在不同的文件系统之间切换，那么为什么数据会丢失呢？</p>
<p>你可以类比成你家里装修，想换新的书架，但是如果不把原来书架上的书籍搬出准备装修的屋子，装修时肯定会损坏书籍嘛！</p>
<h2 id="journaling"><span class="section-num">2</span> Journaling</h2>
<p>在比较文件系统之前，先聊聊文件系统中的日志 (Journaling), 而有些文件系统是有日志功能的，而有些是没有日志功能的；</p>
<p>为了了解它们之间的差异，就需要先了解一下什么是日志。日志的出现本质而言都是为了更好地保存数据。</p>
<p>假设你正在向磁盘里写入文件，突然间断电了，但是你的文件是没有完成写入磁盘的，而你的电脑是不知道是否已经完成写入，所以下次重新来电启动电脑的时候，是没有“人”告知电脑是否要重新写数据的？这样数据就丢失了。</p>
<p>能不能在文件还没有完成写回磁盘又中途出现错误的时候，告诉系统你的 目标文件还有数据没有写回磁盘，你要记得完成这项工作阿？</p>
<p>当然可以，这就是文件系统中日志的功能，在日志的协助下，你的电脑会在日志中记着，“我要把某某文件写入到磁盘”，如果顺利完成写入磁盘工作，日志的这项记录就会被删除，如果中途出现异常，例 如断电了，重新启动的时候，你的系统就会发现，我要写入某某文件的工作还没完成，它就会继续未了的事业，这样就可以保障数据不会丢失。</p>
<p>(而你日常工作生活中，数据的丢失是因为你没有保存数据，即没有把数据写入到磁盘). 如图：</p>
<figure>
    <img loading="lazy" src="https://www.howtogeek.com/wp-content/uploads/2017/02/img_58af43716360e.png%20"/> 
</figure>

<p>因为写入日志需要额外的工作，所以需要额外的资源，但是这样的消耗是相当值得地。</p>
<h2 id="comparison"><span class="section-num">3</span> Comparison</h2>
<p>下面对比一下 各种文件系统的特性</p>
<figure>
    <img loading="lazy" src="/ox-hugo/comparison_file_system.png"
         alt="Figure 1: 图来自archwiki"/> <figcaption>
            <p><span class="figure-number">Figure 1: </span>图来自archwiki</p>
        </figcaption>
</figure>

<p>如果你想了解你的Linux 内核所支持的文件系统，你可以</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">cat /proc/filesystems
</span></span></code></pre></td></tr></table>
</div>
</div><p>现在就来比较一下各种常见的Linux文件系统</p>
<h3 id="ext"><span class="section-num">3.1</span> Ext</h3>
<p>Ext 是指&quot;Extended file system(扩展文件系统)&quot;,应该算是Linux 文件系统里面的老大爷了，它是从经典的 Minix 的文件系统衍生过来的，为Linux 专门设计的，但是它缺乏很多重要的特性，比如上面提到的日志功能，所以大部份的Linux 发行版本都是不支持 Ext 了</p>
<h3 id="ext2"><span class="section-num">3.2</span> Ext2</h3>
<p>Ext2 也是不支持日志的，但是它是第一个支持扩展文件属性和2T 容量的Linux 文件系统，但是正由于Ext2 不支持日志功能，它可以更少地写磁盘，所以它适合像USB 这种闪存，但是Ext2 无法被Windows 识别的，所以它的闪存功能更多地被FAT32和exFAT所代替，换言之，Ext2 用的也不多</p>
<h3 id="ext3"><span class="section-num">3.3</span> Ext3</h3>
<p>Ext3 就是Ext2 带有日志功能的扩展，并且Ext3 也向后兼容Ext2,所以你在Ext2 和Ext3 之间切换也是不需要重新格式化滴，但是最常用的还不是Ext3,而是Ext4 :)</p>
<h3 id="ext4"><span class="section-num">3.4</span> Ext4</h3>
<p>Ext4 也是向后兼容 Ext3 和Ext2 的，所以你是可以在Ext4,Ext3,Ext2 之间切换而无需格式化文件系统。</p>
<p>Ext4 包含很多新的特性，例如支持存储更大的文件，支持延迟分配以 改进对闪存的支持，还能有效地减少文件的碎片化，提高利用效率。</p>
<p>显而易见，Ext4 是最先进的 Ext 系列的文件系统，也是大部分Linux 发行版本的默认文件系统</p>
<h3 id="zfs"><span class="section-num">3.5</span> ZFS</h3>
<p>ZFS 最初是给Sun 的Solaris 设计的，Sun 被收购后，现在是属于Oracle 的，ZFS 支持 大量非常先进的特性，比如说 快照 (snapshot),动态存储 (dynamic disk striping), 驱动池等 (drive pool);</p>
<p>此外ZFS 文件的每个文件都是有校验和的，所以通过检查校验和，就能确定文件的完整性。但是，虽说ZFS 非常强大，却因为ZFS license 的缘故， ZFS 无法添加到 Linux 内核的。如果你非常想要尝试ZFS 的话，你可以自行添加对Linux 发行版本上面添加ZFS 的支持</p>
<h3 id="brtfs"><span class="section-num">3.6</span> BrtFS</h3>
<p>Brtfs 是由Oracle 设计的一个支持写时复制 (copy on write) 的现代文件系统;</p>
<p>而Btrfs 的意思是 B 树文件系统 (B-Tree File System),它支持大量非常先进的特性，例如 动态inode 分配，数据校验和，有效的增量备份，驱动池，最大支持 2^64 byte 容量即16 Eib 大的文件。</p>
<p>BtrFS 是被设计成取代Ext 系列的文件系统的，只不过因为现在的BtrFS 还没有足够成熟，所以还没有大公司在生产环境使用 BtrFS,但是BtrFS 的未来可期</p>
<h3 id="jfs"><span class="section-num">3.7</span> JFS</h3>
<p>JFS 是IBM 为IBM 自家的AIX 操作系统设计的日志文件系统 (Journaled File System), 后来迁移到了Linux 系统上 (HP-UX 也有一个叫做JFS 的文件系统).</p>
<p>在AIX 系统上是存在过两代的JFS文件系统的，分别是 JFS1和JFS2,而Linux 上就只有JFS2了(Linux 上的JFS都是指JFS2)。</p>
<p>JFS 无论在处理大文件还是小文件都有非常不错的表现，并且CPU 占用也是比较低的；JFS 也是支持非常多的特性的，例如 B+ 树，动态Inode 分配，并发IO等。</p>
<p>JFS 也是一个设计优秀的文件系统并且支持大部分的Linux 发行版本，但是因为它最初是为AIX 设计，所以在处于生产环境上的Linux服务器的测试就不如Ext :(.</p>
<h3 id="reiserfs"><span class="section-num">3.8</span> ReiserFS</h3>
<p>ReiserFs 是第一个被引进Linux 标准内核的日志文件系统(在内核版本为2.4.1的时候引进),也是Linux 文件系统的一次飞跃，那时的ReiserFS 包含了很多Ext 没有的新特性。</p>
<p>虽说 ReiserFS 在Linux 有一个非常华丽的开头，但是后来ReiserFS 的开发就陷入了停滞，因为ReiserFS 的核心开发者Hans Reiser(ReiserFS 名字的来由)因为谋杀妻子而被收监 :(。</p>
<p>而后来的ReiserFS 也没有出现在主要的Linux 内核版本里面，虽说ReiserFS是非常好的文件系统，但是它前景如何，我们也只能拭目以待了</p>
<h3 id="xfs"><span class="section-num">3.9</span> XFS</h3>
<p>XFS 最初是Silicon Graphics 为SGI IRX 操作系统设计的64位高性能文件系统，在2001 年迁移到了Linux.</p>
<p>得益于XFS 基于 allocation groups 的设计，XFS 拥有非常优秀的并行IO 能力，并支持延迟分配 (delayed allocation) 以改进文件碎片化，在某种程度上，XFS 和Ext 有一定的相似；</p>
<p>此外，虽说XFS 是高性能的文件系统，但是那只是针对大文件而言的，对于小文件XFS 就有点力所不能及 (当然，这是相对而言).</p>
<p>所以如果是需要 经常处理大文件的服务器，XFS 会是一个很好的选择</p>
<h2 id="小结"><span class="section-num">4</span> 小结</h2>
<p>如果将Linux 的文件系统进行分类的话，还可以分成 FUSE (Filesystem in Userspace,
让用户在没有权限的情况下，创建自己的文件系统), Stackable file System (先进的多层次统一文件系统), Read-only file systems (只读文件系统), Clustered file systems
(集群文件系统)等等。</p>
<p>Linux 的文件系统还有很多，每一种都有自己的特点；但是如果你想问：&ldquo;Linux 最好的文件系统是什么？&quot;;这个问题就跟 &ldquo;最好的Linux 发行版本是什么？&rdquo;, &ldquo;最好的文本编辑器是什么？&rdquo; 一样，是没有标准答案，一千个人都有一千个哈姆雷特了，你的哈姆雷特是什么样子，只有你自己清楚。</p>
<p>不同的文件系统对应不同的场景，只有针对特定场景的最优解决方案！如果还不知道怎么选择，那就选择Ext4 吧，无法做出选 择时，默认的就是最好 :)</p>
<h2 id="参考"><span class="section-num">5</span> 参考</h2>
<ul>
<li><a href="https://en.wikipedia.org/wiki/File_system">https://en.wikipedia.org/wiki/File_system</a></li>
<li><a href="https://btrfs.wiki.kernel.org/index.php/Main_Page">https://btrfs.wiki.kernel.org/index.php/Main_Page</a></li>
<li><a href="https://en.wikipedia.org/wiki/JFS_(file_system)">https://en.wikipedia.org/wiki/JFS_(file_system)</a></li>
<li><a href="https://en.wikipedia.org/wiki/ReiserFS">https://en.wikipedia.org/wiki/ReiserFS</a></li>
<li><a href="https://www.howtogeek.com/howto/33552/htg-explains-which-linux-file-system-should-you-choose/">https://www.howtogeek.com/howto/33552/htg-explains-which-linux-file-system-should-you-choose/</a></li>
<li><a href="https://en.wikipedia.org/wiki/ZFS">https://en.wikipedia.org/wiki/ZFS</a></li>
<li><a href="https://en.wikipedia.org/wiki/XFS">https://en.wikipedia.org/wiki/XFS</a></li>
<li><a href="https://wiki.archlinux.org/index.php/file_systems">https://wiki.archlinux.org/index.php/file_systems</a></li>
</ul>
]]></content:encoded>
    </item>
    <item>
      <title>枯树逢春之ArchLinux领风骚</title>
      <link>https://ramsayleung.github.io/zh/post/2017/install_archlinux/</link>
      <pubDate>Mon, 27 Feb 2017 00:00:00 +0800</pubDate>
      <guid>https://ramsayleung.github.io/zh/post/2017/install_archlinux/</guid>
      <description>An description about how to install arch linux in an old machine</description>
      <content:encoded><![CDATA[<h2 id="枯树"><span class="section-num">1</span> 枯树</h2>
<p>周末回了一趟家，没带自己的笔记本，在家闲来无事，无意中看到墙角的电脑，已经尘封已久反正无事，何不玩玩这台老古董呢？于是把电脑拿去修理店把坏了的硬件修好。</p>
<p>离开店的时候，老板说：“你的系统有问题，我看到你自己也有Ghost,就不帮搞这系统了， 你自己都能解决的，推荐你还是用XP吧，这电脑配置低，还是XP好用”。我忍不住回头对老板一笑 :)</p>
<h2 id="春至"><span class="section-num">2</span> 春至</h2>
<p>像我这种Linuxer,这么可能再装回XP呢，最初装Win7,也是考虑到老爹的技术 hold 不住 Linux, 现在手机那么发达，他就不需要电脑了，所以，此时不装Linux,更待何时呢？</p>
<h2 id="arch-linux"><span class="section-num">3</span> Arch Linux</h2>
<p>我没有选择 Xubuntu 这种适合老机器的 Ubuntu 衍生发行版本，因为我不喜欢Ubuntu, 所以我最后选择的是 Arch linux,官网说最低配置只需500MB内存，800MB的 硬盘存储空间，正适合家里的老家伙</p>
<h3 id="安装过程"><span class="section-num">3.1</span> 安装过程</h3>
<h4 id="下载镜像"><span class="section-num">3.1.1</span> 下载镜像</h4>
<p><a href="https://www.archlinux.org/download/">Download Link</a> ,在网易的镜像下载ISO, 然后用dd刻录到U盘，Windows 可以选择 <a href="http://sourceforge.net/projects/usbwriter">USBwriter</a></p>
<h4 id="分区"><span class="section-num">3.1.2</span> 分区</h4>
<p>使用fdisk, 我的硬盘是/dev/sda,如果还有一块硬盘，那应该就是/dev/sdb</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">fdisk /dev/sda
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>n:新建一个分区，p 指主分区，e 是指扩展分区(逻辑分区是建立在扩展分区上的)
一块硬盘主分区加上扩展分区最多只能是4个</li>
<li>d: 删除</li>
<li>m: 查询其他命令，不知道怎么操作就输入m 吧</li>
</ul>
<p>分区结束以后，输入 <code>w</code> 完成分区 (我分了三个分区 /dev/sda1 -&gt; swap
/dev/sda2 -&gt; / /dev/sda3 -&gt; /home)</p>
<h4 id="格式化分区"><span class="section-num">3.1.3</span> 格式化分区</h4>
<p>格式化 sda2 sda3为ext4格式：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">mkfs.ext4 /dev/sda2
</span></span><span class="line"><span class="cl">mkfs.ext4 /dev/sda3
</span></span></code></pre></td></tr></table>
</div>
</div><p>格式化sda1 为swap(虚拟内存),一般是内存的两倍，当然如果你的内存很大的话就不用划这个分区了</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">mkswap /dev/sda1
</span></span></code></pre></td></tr></table>
</div>
</div><p>激活swap</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">swapon /dev/sda1
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="挂载"><span class="section-num">3.1.4</span> 挂载</h4>
<p>将sda2挂载到/mnt,其实就是让sda2分区做系统的根分区，/mnt/home同理</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">mount /dev/sda2 /mnt
</span></span><span class="line"><span class="cl">mount /dev/sda3 /mnt/home
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="更新pacman源"><span class="section-num">3.1.5</span> 更新pacman源</h4>
<p>网易的源不错，编辑 <code>/etc/pacman.d/mirrorlist</code> 添加 <code>Server = http://mirrors.163.com/archlinux/$repo/os/$arch</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">vim /etc/pacman.d/mirrorlist
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后添加；添加完之后，更新一下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">pacman -Syy
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="安装基本系统"><span class="section-num">3.1.6</span> 安装基本系统</h4>
<p>安装基本系统到 /mnt,即sda2分区</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">pacstrap /mnt base base-devel
</span></span></code></pre></td></tr></table>
</div>
</div><p>需要安装的都安装吧，然后走开煮一杯咖啡，慢慢品尝</p>
<h4 id="生成fstab"><span class="section-num">3.1.7</span> 生成fstab</h4>
<p>fstab 的作用：</p>
<blockquote>
<p>The fstab(5) file can be used to define how disk partitions, various other block devices, or remote filesystems should be mounted into the filesystem</p>
</blockquote>
<p>生成fstab,并且查看是否正确生成fstab</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">genfstab -U -p /mnt &gt;&gt; /mnt/etc/fstab
</span></span><span class="line"><span class="cl">cat /mnt/etc/fstab
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="配置系统"><span class="section-num">3.1.8</span> 配置系统</h4>
<p>切换到新的系统，然后你会发现命令行提示符发生了改变</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">arch-chroot /mnt
</span></span></code></pre></td></tr></table>
</div>
</div><!--list-separator-->
<ol>
<li>
<p>设置地区</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">ln -s /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
<!--list-separator-->
<ol start="2">
<li>
<p>设置语言</p>
<p>编辑 <code>/etc/locale.gen</code>,因为该文件所有的信息都是被注释滴，所以在最上面添加<code>en_US.UTF-8 UTF-8</code> 即可</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">vim /etc/locale.gen
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后添加；添加完成后，执行 <code>locale-gen</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">locale-gen
</span></span></code></pre></td></tr></table>
</div>
</div><p>接着配置 <code>locale.conf</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="nb">echo</span> <span class="nv">LANG</span><span class="o">=</span>en_US.UTF-8 &gt; /etc/locale.conf
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">LANG</span><span class="o">=</span>en_US.UTF-8
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
<!--list-separator-->
<ol start="3">
<li>
<p>设置主机名</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="nb">echo</span> samray-arch &gt; /etc/hostname
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
<!--list-separator-->
<ol start="4">
<li>
<p>设置密码</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">passwd
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
<!--list-separator-->
<ol start="5">
<li>
<p>配置网络</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">pacman -S net-tools
</span></span><span class="line"><span class="cl">systemctl <span class="nb">enable</span> dhcpcd.service
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
<!--list-separator-->
<ol start="6">
<li>
<p>安装GRUB</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">pacman -S grub-bios
</span></span></code></pre></td></tr></table>
</div>
</div><p>把grub 安装到硬盘sda,如果双系统的话，还要视情况做更改</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">grub-install --recheck /dev/sda
</span></span><span class="line"><span class="cl">grub-mkconfig -o /boot/grub/grub.cfg
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
<h4 id="收尾工作"><span class="section-num">3.1.9</span> 收尾工作</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="nb">exit</span>
</span></span><span class="line"><span class="cl">umount /mnt/home
</span></span><span class="line"><span class="cl">umount /mnt
</span></span><span class="line"><span class="cl">reboot
</span></span></code></pre></td></tr></table>
</div>
</div><p>这样Arch linux 就装好了，不过你重启会发现，你的系统是没有图形化界面的</p>
<h3 id="安装桌面环境"><span class="section-num">3.2</span> 安装桌面环境</h3>
<h4 id="安装x服务"><span class="section-num">3.2.1</span> 安装x服务</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">pacman -S xorg-server xorg-server-utils xorg-xinit
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="安装显卡驱动"><span class="section-num">3.2.2</span> 安装显卡驱动</h4>
<p>查找自己的显卡类型</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">ispci <span class="p">|</span>grep VGA
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后搜索匹配自己显卡的驱动</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">pacman -Ss xf86-video <span class="p">|</span>less
</span></span></code></pre></td></tr></table>
</div>
</div><p>Intel 集成显卡：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">pacman -S xf86-video-intel
</span></span></code></pre></td></tr></table>
</div>
</div><p>虚拟机显卡：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">pacman -S xf86-video-vesa
</span></span></code></pre></td></tr></table>
</div>
</div><p>笔记本触摸板驱动 (老家伙是台式，不需要了):</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">pacman -S xf86-input-synaptics
</span></span></code></pre></td></tr></table>
</div>
</div><p>安装输入法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">pacman -S scim-pinyin
</span></span></code></pre></td></tr></table>
</div>
</div><p>先安装 slim(图像登录管理器)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">pacman -S slim
</span></span></code></pre></td></tr></table>
</div>
</div><p>安装xfce4</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">pacman -S xfce4
</span></span></code></pre></td></tr></table>
</div>
</div><p>启动xfce4</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">startxfce4
</span></span></code></pre></td></tr></table>
</div>
</div><p>基本就大功告成了，因为我的台式电脑是bios, 所以不用折腾uefi, 还有无线网络。</p>
<p><strong>Action is louder than words</strong>,还是多动手才行，我都装了三次才成功，内核空指针和段错误都遇到了 :）</p>
<h3 id="参考"><span class="section-num">3.3</span> 参考</h3>
<p><a href="https://wiki.archlinux.org/index.php/installation_guide">https://wiki.archlinux.org/index.php/installation_guide</a></p>
]]></content:encoded>
    </item>
  </channel>
</rss>
