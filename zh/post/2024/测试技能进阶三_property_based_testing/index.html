<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>测试技能进阶(三): Property Based Testing | 自由庄园</title>
<meta name=keywords content="testing,rust"><meta name=description content="1 前言 1.1 test case的局限 想要更好地理解什么是 Property based testing, 就来先看下已有 test case 的局限，再来观察它解决了什么问题。 用之前《测试技能进阶(二): Parameterized Test"><meta name=author content="Ramsay Leung"><link rel=canonical href=https://ramsayleung.github.io/zh/post/2024/%E6%B5%8B%E8%AF%95%E6%8A%80%E8%83%BD%E8%BF%9B%E9%98%B6%E4%B8%89_property_based_testing/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.3d10f26c6b18e09ce1513987c692d1b5c576d18f039138546633643284448f11.css integrity="sha256-PRDybGsY4JzhUTmHxpLRtcV20Y8DkThUZjNkMoREjxE=" rel="preload stylesheet" as=style><link rel=icon href=https://ramsayleung.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://ramsayleung.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://ramsayleung.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://ramsayleung.github.io/apple-touch-icon.png><link rel=mask-icon href=https://ramsayleung.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://ramsayleung.github.io/zh/post/2024/%E6%B5%8B%E8%AF%95%E6%8A%80%E8%83%BD%E8%BF%9B%E9%98%B6%E4%B8%89_property_based_testing/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-9MG65HQHEL"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-9MG65HQHEL",{anonymize_ip:!1})}</script><meta property="og:title" content="测试技能进阶(三): Property Based Testing"><meta property="og:description" content="1 前言 1.1 test case的局限 想要更好地理解什么是 Property based testing, 就来先看下已有 test case 的局限，再来观察它解决了什么问题。 用之前《测试技能进阶(二): Parameterized Test"><meta property="og:type" content="article"><meta property="og:url" content="https://ramsayleung.github.io/zh/post/2024/%E6%B5%8B%E8%AF%95%E6%8A%80%E8%83%BD%E8%BF%9B%E9%98%B6%E4%B8%89_property_based_testing/"><meta property="og:image" content="https://ramsayleung.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="post"><meta property="article:published_time" content="2024-10-14T09:37:00-07:00"><meta property="article:modified_time" content="2024-10-14T15:28:08-07:00"><meta property="og:site_name" content="Ramsay's Blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://ramsayleung.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="测试技能进阶(三): Property Based Testing"><meta name=twitter:description content="1 前言 1.1 test case的局限 想要更好地理解什么是 Property based testing, 就来先看下已有 test case 的局限，再来观察它解决了什么问题。 用之前《测试技能进阶(二): Parameterized Test"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://ramsayleung.github.io/zh/post/"},{"@type":"ListItem","position":2,"name":"测试技能进阶(三): Property Based Testing","item":"https://ramsayleung.github.io/zh/post/2024/%E6%B5%8B%E8%AF%95%E6%8A%80%E8%83%BD%E8%BF%9B%E9%98%B6%E4%B8%89_property_based_testing/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"测试技能进阶(三): Property Based Testing","name":"测试技能进阶(三): Property Based Testing","description":"1 前言 1.1 test case的局限 想要更好地理解什么是 Property based testing, 就来先看下已有 test case 的局限，再来观察它解决了什么问题。 用之前《测试技能进阶(二): Parameterized Test","keywords":["testing","rust"],"articleBody":"1 前言 1.1 test case的局限 想要更好地理解什么是 Property based testing, 就来先看下已有 test case 的局限，再来观察它解决了什么问题。\n用之前《测试技能进阶(二): Parameterized Tests》中计算折扣的函数为例：\n1 2 3 4 5 6 7 8 9 10 11 def calculate_discount(price, discount_percentage): if price \u003c 0: raise ValueError(f\"Price must be greater than zero: {price}\") if discount_percentage \u003c 0: raise ValueError(f\"Discount_percentage must be greater than zero: {discount_percentage}\") if price \u003e 50000: return price - (price * (discount_percentage * 1.15) / 100) elif price \u003e 100000: return price - (price * (discount_percentage * 1.18) / 100) else: return price - (price * discount_percentage / 100) 即使我们使用了 Parameterized Test, 把测试逻辑和测试数据集作了分离，但是还是有两个缺点：\n我们的测试数据集还是要手工构造，即使现在不需要写新的 test case, 手工构造数据集还是很麻烦 第二个问题更严重，就是我们的构建的数据集可能不是完备的，如果数据集没有办法覆盖所有的条件分支，那我们仍然可能发现不了代码中的Bug 2 Property Based Testing 而 Property Based Testing 就是想解决这个问题，它希望可以结合人脑对特定问题域的理解和机器的运算能力，使用更少的时间来生成更优的测试case.\nProperty Based Testing 这个概念是由 Haskell 项目 QuickCheck 1在1999年引入的，它的理念是，程序员应该只定义某个测试case, 参数需要满足的标准(specification), 然后程序就会自动生成大量满足这个标准的随机数，用这些随机数来测试这个 test case。\n而因为测试数据是随机生成的，所以你意料之内的数据，或者意料之外的数据都会被用来测试， 既省去了费时费力构造不同数据作数据集来测试的烦恼，又能保证数据集的完备性, 经常可以帮助你发现意想不到的bug.\n这就是声明式定义的一种，你只需要声明你想干什么(用什么样的数据测试什么函数)，而非命令式定义（你需要定义你要怎么做）.\n人力应该是很珍贵，而机器的计算资源却是很便宜，应该让机器代替人去做生成数据的事。\n举例来说, 以上面的 calculate_discount 函数为例，如果我们告诉程序, price 和 discount_percentage 应该是整数（specification）, 那么 Quickcheck 就会生成各种整数, 从 Integer.Min 到 Integer.Max 不等，用来测试我们的程序.\n如果还是觉得这个概念比较抽象，可以来看下具体的例子：\n3 Hypothesis Python Property Based Testing的测试框架叫 Hypothesis 2(假想)，这个项目名字也是起得非常有水平，结合Property Based Testing的哲学，可谓信雅达.\n假设我们现在要实现一个简单的数据压缩的算法： Run-length Encoding 3(RLE)，通常用于压缩包含连续重复数据的序列, 这种编码方法特别适用于那些有大量重复字符或值的数据.\n它的基本原理是：\n统计连续重复的数据元素的数量。 用一个计数值和数据值的组合来替代这些重复的数据。 比如字符串: AABBBCCCC, RLE 编码后: 2A3B4C. 2A 表示两个连续的 A, 3B 表示三个连续的 B, 4C 表示四个连续的 C 。\nPython实现如下:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 def encode(input_string): count = 1 prev = \"\" lst = [] for character in input_string: if character != prev: if prev: entry = (prev, count) lst.append(entry) count = 1 prev = character else: count += 1 entry = (character, count) lst.append(entry) return lst def decode(lst): q = \"\" for character, count in lst: q += character * count return q 如果我们的代码实现没有问题的话，对于任意的字符串，编码后的字符串，解码后的结果应该和原来的字符串一致的，这个就是我们的测试逻辑:\n1 2 3 4 5 6 7 from hypothesis import given from hypothesis.strategies import text @given(text()) # 入参的标准是：任意的字符串，hypothesis 框架就会自动生成随机数，并调用test_decode_inverts_encode def test_decode_inverts_encode(s): assert decode(encode(s)) == s 使用 pytest 运行上面的用例，结果如下:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 \u003e pytest property_based_testing.py =================================== test session starts ==================================== platform darwin -- Python 3.12.6, pytest-8.3.3, pluggy-1.5.0 rootdir: /Users/ramsayleung/code/python/test_technique plugins: hypothesis-6.115.0 collected 1 item property_based_testing.py F [100%] ========================================= FAILURES ========================================= ________________________________ test_decode_inverts_encode ________________________________ @given(text()) \u003e def test_decode_inverts_encode(s): property_based_testing.py:29: _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ property_based_testing.py:30: in test_decode_inverts_encode assert decode(encode(s)) == s _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ input_string = '' def encode(input_string): count = 1 prev = \"\" lst = [] for character in input_string: if character != prev: if prev: entry = (prev, count) lst.append(entry) count = 1 prev = character else: count += 1 \u003e entry = (character, count) E UnboundLocalError: cannot access local variable 'character' where it is not associated with a value E Falsifying example: test_decode_inverts_encode( E s='', E ) property_based_testing.py:17: UnboundLocalError ================================= short test summary info ================================== FAILED property_based_testing.py::test_decode_inverts_encode - UnboundLocalError: cannot access local variable 'character' where it is not associated ... ==================================== 1 failed in 0.14s ===================================== 可以看到，当 input_string ='' 是空字符串的时候， encode 函数抛出异常了，说 character 变量未定义。原来是 encode 函数没有对空字符串这个 corner case 作处理，那么就加个判断条件，修复一下:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 def encode(input_string): if not input_string: return [] count = 1 prev = \"\" lst = [] for character in input_string: if character != prev: if prev: entry = (prev, count) lst.append(entry) count = 1 prev = character else: count += 1 entry = (character, count) lst.append(entry) return lst 既然我们知道空字符串是个特殊的 case, 因为 hypothesis 生成的都是任意的随机数，不一定每次都会测到空字符串，那我们就自己指定一个 case:\n1 2 3 4 5 6 7 from hypothesis import example, given, strategies as st @given(st.text()) @example(\"\") # 手工指定空字符串这个 corner case def test_decode_inverts_encode(s): assert decode(encode(s)) == s pytest 重新运行，测试就通过了。但是，对 hypothesis 框架还没有建立信心的你我就不确定，它是否真的生成很多随机来运行这个 test case 呢？\n有两个方法可以验证：\n方法一：最简单粗暴的方式，把 s 变量给打印出来，毕竟眼见为实:\n1 2 3 4 5 @given(st.text()) @example(\"\") def test_decode_inverts_encode(s): print(s) assert decode(encode(s)) == s 然后通过 pytest -s 参数要求 pytest 将写入到 stdout 的内容给打印出来\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 \u003e pytest property_based_testing.py -s ======================================= test session starts ======================================= platform darwin -- Python 3.12.6, pytest-8.3.3, pluggy-1.5.0 rootdir: /Users/ramsayleung/code/python/test_technique plugins: hypothesis-6.115.0 collected 1 item property_based_testing.py O ¶ \\å񢄏« 𥛗Îbó 𜆮å 񰘰9 gah󭾔𛧁 i򼯜+ó»򮩸b񝕨 S!ÕTå\u0026𰵩í¤ýäó÷F øôyµ Äª sLz$ï _𠵈 Ü A R󃝷{©¾ ìõ æ􂐛BÝ1*􅄢ëóg𮎈¼ ?𩓁 Òör @PP􎾂ö񳱊ûÁ½¬HÈ6# a𣽗¶󿅌𧑁x~󗜬韹ûð󴯮#Z󅖫\\©𳖅ûf\u003e i .... ======================================== 1 passed in 0.15s ======================================== 这一堆都是什么字符呢, 都乱码了。\n毕竟我们告诉 hypothesis 框架的是，我们参数接受的标准是任意的字符串， hypothesis 就非常尽职地帮我们生成了各种字符串，这个测试数据集可比我们自己手工构建的范围大得多，这就是 property based testing 的优势所在.\n第二种方法是使用 hypothesis 框架提供的命令行参数 =–hypothesis-show-statistics=，用于打印统计信息:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 \u003e pytest property_based_testing.py --hypothesis-show-statistics ======================================= test session starts ======================================= platform darwin -- Python 3.12.6, pytest-8.3.3, pluggy-1.5.0 rootdir: /Users/ramsayleung/code/python/test_technique plugins: hypothesis-6.115.0 collected 1 item property_based_testing.py . [100%] ====================================== Hypothesis Statistics ====================================== property_based_testing.py::test_decode_inverts_encode: - during generate phase (0.03 seconds): - Typical runtimes: \u003c 1ms, of which \u003c 1ms in data generation - 100 passing examples, 0 failing examples, 0 invalid examples - Stopped because settings.max_examples=100 ======================================== 1 passed in 0.05s ======================================== 上面运行了 100 条数据，如果你觉得还想跑更多，可以通过 settings 装饰器指定更多:\n1 @settings(max_examples=500) 4 Quickcheck \u0026 Proptest 而在Rust生态，就有两个 Property Based Testing 的库，一个是由Rust社区知名开发者，ripgrep 4和 regex 库作者移植自 Haskell Quickcheck 库的 quickcheck 5(名字也一并移植了), 另外一个是思路继承自 Python Hypothesis 的 Proptest 6(这位直接用property based testing技术来命名了，不得不说，命名真的是门艺术)\n两者的社区接受度都相差无几(star, 使用者数量), 而在公司内部，我也发现 quickcheck 和 proptest 都有人用，坐我旁边的Principle Engineer 用的是 proptest, 而另外一个现在和我共事的同事，她的之前团队用的就是 quickcheck，看到都势均力敌嘛。\n翻开 quickcheck 和 proptest 的API 文档之后，我发现我更喜欢 quickcheck 的接口风格，虽说它的活跃度更低一些，我最后还是选择了使用 quickcheck.\n下面就来介绍一下我在Rust上使用 quickcheck 的心得:\n假设我们现在有一个可以反转列表的函数 reverse:\n1 2 3 4 5 6 7 fn reverse\u003cT: Clone\u003e(xs: \u0026[T]) -\u003e Vec\u003cT\u003e { let mut rev = vec!(); for x in xs { rev.insert(0, x.clone()) } rev } 对于任意类型的列表，反转之后再反转的结果，肯定是和原结果一样的，那么我们就可以开始声明我们的标准(specification), 那就是任意的列表，可以是字符串列表，整型列表或者是其他的结构体列表:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 #[cfg(test)] mod tests{ use quickcheck_macros::quickcheck; use crate::reverse; #[quickcheck] fn double_reversal_is_identity_isize(xs: Vec\u003cisize\u003e) -\u003e bool { xs == reverse(\u0026reverse(\u0026xs)) } #[quickcheck] fn double_reversal_is_identity_string(xs: Vec\u003cString\u003e) -\u003e bool { xs == reverse(\u0026reverse(\u0026xs)) } } Rust 的unit test 是不支持带参数的，=#[quickcheck]= 这个宏就会自动将 double_reversal_is_identity_isize 转换成 property based test case, 而得益于Rust的类型系统, quickcheck 就能推断出入参就是我们声明的标准 Vec, 任意 isize 类型的数组.\n4.1 Struct with quickcheck 如果上面的例子觉得过于简单的话，现在就让我们看个复杂一点的例子, 一个简单的图书管理系统，支持会员，借书，还书功能：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 use chrono::{Duration, NaiveDate}; use std::collections::HashMap; #[derive(Debug, Clone, PartialEq)] struct Book { isbn: String, title: String, author: String, publication_year: u16, } #[derive(Debug, Clone, PartialEq)] struct Member { id: u32, name: String, email: String, } #[derive(Debug, Clone)] struct Loan { book_isbn: String, member_id: u32, due_date: NaiveDate, } #[derive(Debug, Clone)] struct Library { books: HashMap\u003cString, Book\u003e, members: HashMap\u003cu32, Member\u003e, loans: Vec\u003cLoan\u003e, current_date: NaiveDate, } impl Library { fn new(current_date: NaiveDate) -\u003e Self { Library { books: HashMap::new(), members: HashMap::new(), loans: Vec::new(), current_date, } } fn add_book(\u0026mut self, book: Book) -\u003e Result\u003c(), String\u003e { if self.books.contains_key(\u0026book.isbn) { Err(\"Book with this ISBN already exists\".to_string()) } else { self.books.insert(book.isbn.clone(), book); Ok(()) } } fn add_member(\u0026mut self, member: Member) -\u003e Result\u003c(), String\u003e { if self.members.contains_key(\u0026member.id) { Err(\"Member with this ID already exists\".to_string()) } else { self.members.insert(member.id, member); Ok(()) } } fn loan_book(\u0026mut self, book_isbn: \u0026str, member_id: u32) -\u003e Result\u003c(), String\u003e { if !self.books.contains_key(book_isbn) { return Err(\"Book not found\".to_string()); } if !self.members.contains_key(\u0026member_id) { return Err(\"Member not found\".to_string()); } if self.loans.iter().any(|loan| loan.book_isbn == book_isbn) { return Err(\"Book is already on loan\".to_string()); } let due_date = self.current_date + Duration::days(14); self.loans.push(Loan { book_isbn: book_isbn.to_string(), member_id, due_date, }); Ok(()) } fn return_book(\u0026mut self, book_isbn: \u0026str) -\u003e Result\u003c(), String\u003e { if let Some(index) = self .loans .iter() .position(|loan| loan.book_isbn == book_isbn) { self.loans.remove(index); Ok(()) } else { Err(\"Book is not currently on loan\".to_string()) } } } 通过上面的简单代码，就实现了新增图书，新增会员，借书，和还书功能。现在就让我们来结合 quickcheck 的 Arbitrary 接口，实现生成任意的图书和会员，以便用于测试:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 use quickcheck::{Arbitrary, Gen}; impl Arbitrary for Book { fn arbitrary(g: \u0026mut Gen) -\u003e Self { Book { // isbn必须以`ISBN` 开头，后接任意的大于等于0，小于uint32.max_value // 的整型 isbn: format!(\"ISBN-{}\", u32::arbitrary(g)), title: String::arbitrary(g), // 任意的字符串 author: String::arbitrary(g), // 任意的字符串 publication_year: *g.choose(\u0026[2014_u16, 2022_u16, 2025_u16]).unwrap(), // 2014,2022或2025年出版的书 } } } impl Arbitrary for Member { fn arbitrary(g: \u0026mut Gen) -\u003e Self { Member { id: u32::arbitrary(g), // 任意大于0，小于uint32.max_value的整型 name: String::arbitrary(g), // 任意字符串 // 任意字符开头, 以@example.com 结尾的字符 email: format!(\"{}@example.com\", String::arbitrary(g)), } } } 现在就让我们来看下借助 quickcheck 编写的 test case, 注意参数为 Book 和 Member 类型的 case, quickcheck 就会以我们上面定义的标准，自动给我们生成符合规定的 Book 和 Member 参数.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 #[cfg(test)] mod tests { use chrono::NaiveDate; use quickcheck_macros::quickcheck; use crate::book::Member; use super::{Book, Library}; #[quickcheck] fn adding_book_increases_book_count(book: Book) -\u003e bool { let mut library = Library::new(NaiveDate::from_ymd_opt(2024, 10, 14).unwrap()); let initial_count = library.books.len(); library.add_book(book.clone()).unwrap(); library.books.len() == initial_count + 1 \u0026\u0026 library.books.contains_key(\u0026book.isbn) } #[quickcheck] fn cannot_loan_nonexistent_book(book_isbn: String, member_id: u32) -\u003e bool { let mut library = Library::new(NaiveDate::from_ymd_opt(2024, 10, 14).unwrap()); library.loan_book(\u0026book_isbn, member_id).is_err() } #[quickcheck] fn can_return_loaned_book(book: Book, member: Member) -\u003e bool { let mut library = Library::new(NaiveDate::from_ymd_opt(2024, 10, 14).unwrap()); library.add_book(book.clone()).unwrap(); library.add_member(member.clone()).unwrap(); library.loan_book(\u0026book.isbn, member.id).unwrap(); library.return_book(\u0026book.isbn).is_ok() } } 通过 quickcheck 我们就可以只专注测试逻辑，可以假定测试数据集是完备的了。可能看到 Book 和 Member, 你会觉得 quickcheck 并没有做太多事情，你手工也可以构造。\n但是我在的实际工作中，我就需要构造一个超过23个成员变量的 struct, 大部分还是 optional, 然后需要将这个 struct 写入到 parquet 文件，然后再测试读取逻辑。 不同成员变量的值可取的范围实在太多了，再叠加上 optional 的可能性，构造数据的代码写得相当恶心.\n所以有了 quickcheck 之后，我只需要为这个 struct 实现 Arbitrary 接口，剩下的就由 quickcheck 替我生成，所以我直接和PE大佬说:\nproperty test saves me life, now I couldn’t live without it.\n5 总结 本来想抒发感想写点结语，但是看到 Hypothesis 作者写的 The purpose of Hypothesis7 来说明他开发的 Hypothesis 的动机，他的文章甚至用来给这个《测试技能进阶》系列总结都相当妥当。\n我就试翻译下他文章的部分段落, 更推荐阅读原文，可谓是用心良苦，字字珠玑:\n请容我狂妄一下，Hypothesis 的目标是希望可以让这个世界迈进到一个全新，由高质量软件打造的新世代。\n正如人们所说，软件正在吞噬整个世界。但软件本身却很烂，它充满bug，又不安全，还经常被设计得很烂，这样的软件可谓是万恶之源.\n而软件测试的状况甚至更糟糕，虽然大家都认同应该对代码进行测试，但是你能问心无愧地说，你经手过的代码都有被充分测试么？\n问题在于，实在是太难写出好的测试了， 你写测试用例的时候，通常持有和你写代码时一样的假设与误区，你写的测试用例自然无法发现你当初埋下的bug (精辟)\n与此同时，有各种各样让测试变成更好的工具却基本无人使用，最初的 Quickcheck 是1999年推出的，但是大多数开发者甚至从未听说过它，更别提使用了（开山始祖的Quickcheck在GitHub只有700多个Star，就知道作者所言不虚）。 虽然其他语言有些半成品的实现，但是大部分都不值得一试。\n而 Hypothesis 的目标正是正本清源，把先进的测试技术传递给大众，并提供一个高质量的实现，让人们可以接纳它。\n希望可以集百家之所长，附以个人微薄之力，让软件测试变得更好。\n系列文章:\n测试技能进阶(一): 软件质量认知 测试技能进阶(二): Parameterized Tests 测试技能进阶(三): Property Based Testing https://en.wikipedia.org/wiki/QuickCheck ↩︎\nhttps://hypothesis.works/ ↩︎\nhttps://en.wikipedia.org/wiki/Run-length_encoding ↩︎\nhttps://github.com/BurntSushi/ripgrep ↩︎\nhttps://github.com/BurntSushi/quickcheck ↩︎\nhttps://github.com/proptest-rs/proptest ↩︎\nhttps://hypothesis.readthedocs.io/en/latest/manifesto.html ↩︎\n","wordCount":"4659","inLanguage":"zh","image":"https://ramsayleung.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2024-10-14T09:37:00-07:00","dateModified":"2024-10-14T15:28:08-07:00","author":{"@type":"Person","name":"Ramsay Leung"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://ramsayleung.github.io/zh/post/2024/%E6%B5%8B%E8%AF%95%E6%8A%80%E8%83%BD%E8%BF%9B%E9%98%B6%E4%B8%89_property_based_testing/"},"publisher":{"@type":"Organization","name":"自由庄园","logo":{"@type":"ImageObject","url":"https://ramsayleung.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://ramsayleung.github.io/zh/ accesskey=h title="Home (Alt + H)"><img src=https://ramsayleung.github.io/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://ramsayleung.github.io/en/ title=English aria-label=English>En</a></li></ul></div></div><ul id=menu><li><a href=https://ramsayleung.github.io/zh/archives/ title=归档><span>归档</span></a></li><li><a href=https://ramsayleung.github.io/zh/search/ title=搜索><span>搜索</span></a></li><li><a href=https://ramsayleung.github.io/zh/categories/ title=目录><span>目录</span></a></li><li><a href=https://ramsayleung.github.io/zh/tags/ title=标签><span>标签</span></a></li><li><a href=https://ramsayleung.github.io/zh/about_me_zh/ title=关于><span>关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://ramsayleung.github.io/zh/>主页</a>&nbsp;»&nbsp;<a href=https://ramsayleung.github.io/zh/post/>Posts</a></div><h1 class="post-title entry-hint-parent">测试技能进阶(三): Property Based Testing</h1><div class=post-meta><span title='2024-10-14 09:37:00 -0700 -0700'>十月 14, 2024</span>&nbsp;·&nbsp;10 分钟&nbsp;·&nbsp;4659 字&nbsp;·&nbsp;Ramsay Leung&nbsp;|&nbsp;<a href=https://github.com/ramsayleung/ramsayleung.github.io/blob/master/content/post/2024/%e6%b5%8b%e8%af%95%e6%8a%80%e8%83%bd%e8%bf%9b%e9%98%b6%e4%b8%89_property_based_testing.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#前言><span class=section-num>1</span> 前言</a><ul><li><a href=#test-case的局限><span class=section-num>1.1</span> test case的局限</a></li></ul></li><li><a href=#property-based-testing><span class=section-num>2</span> Property Based Testing</a></li><li><a href=#hypothesis><span class=section-num>3</span> Hypothesis</a></li><li><a href=#quickcheck-and-proptest><span class=section-num>4</span> Quickcheck & Proptest</a><ul><li><a href=#struct-with-quickcheck><span class=section-num>4.1</span> Struct with quickcheck</a></li></ul></li><li><a href=#总结><span class=section-num>5</span> 总结</a></li></ul></nav></div></details></div><div class=post-content><h2 id=前言><span class=section-num>1</span> 前言<a hidden class=anchor aria-hidden=true href=#前言>#</a></h2><h3 id=test-case的局限><span class=section-num>1.1</span> test case的局限<a hidden class=anchor aria-hidden=true href=#test-case的局限>#</a></h3><p>想要更好地理解什么是 Property based testing, 就来先看下已有 test case 的局限，再来观察它解决了什么问题。</p><p>用之前<a href=https://ramsayleung.github.io/zh/post/2024/%E6%B5%8B%E8%AF%95%E6%8A%80%E8%83%BD%E8%BF%9B%E9%98%B6%E4%BA%8C_parameterized_tests/>《测试技能进阶(二): Parameterized Tests》</a>中计算折扣的函数为例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>calculate_discount</span><span class=p>(</span><span class=n>price</span><span class=p>,</span> <span class=n>discount_percentage</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>price</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Price must be greater than zero: </span><span class=si>{</span><span class=n>price</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>discount_percentage</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Discount_percentage must be greater than zero: </span><span class=si>{</span><span class=n>discount_percentage</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>price</span> <span class=o>&gt;</span> <span class=mi>50000</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>price</span> <span class=o>-</span> <span class=p>(</span><span class=n>price</span> <span class=o>*</span> <span class=p>(</span><span class=n>discount_percentage</span> <span class=o>*</span> <span class=mf>1.15</span><span class=p>)</span> <span class=o>/</span> <span class=mi>100</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=n>price</span> <span class=o>&gt;</span> <span class=mi>100000</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>price</span> <span class=o>-</span> <span class=p>(</span><span class=n>price</span> <span class=o>*</span> <span class=p>(</span><span class=n>discount_percentage</span> <span class=o>*</span> <span class=mf>1.18</span><span class=p>)</span> <span class=o>/</span> <span class=mi>100</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>price</span> <span class=o>-</span> <span class=p>(</span><span class=n>price</span> <span class=o>*</span> <span class=n>discount_percentage</span> <span class=o>/</span> <span class=mi>100</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>即使我们使用了 Parameterized Test, 把测试逻辑和测试数据集作了分离，但是还是有两个缺点：</p><ol><li>我们的测试数据集还是要手工构造，即使现在不需要写新的 test case, 手工构造数据集还是很麻烦</li><li>第二个问题更严重，就是我们的构建的数据集可能不是完备的，如果数据集没有办法覆盖所有的条件分支，那我们仍然可能发现不了代码中的Bug</li></ol><h2 id=property-based-testing><span class=section-num>2</span> Property Based Testing<a hidden class=anchor aria-hidden=true href=#property-based-testing>#</a></h2><p>而 Property Based Testing 就是想解决这个问题，它希望可以结合人脑对特定问题域的理解和机器的运算能力，使用更少的时间来生成更优的测试case.</p><p>Property Based Testing 这个概念是由 Haskell 项目 <a href=https://en.wikipedia.org/wiki/QuickCheck>QuickCheck</a> <sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>在1999年引入的，它的理念是，程序员应该只定义某个测试case, 参数需要满足的标准(specification), 然后程序就会自动生成大量满足这个标准的随机数，用这些随机数来测试这个 test case。</p><p>而因为测试数据是随机生成的，所以你意料之内的数据，或者意料之外的数据都会被用来测试，
既省去了费时费力构造不同数据作数据集来测试的烦恼，又能保证数据集的完备性, 经常可以帮助你发现意想不到的bug.</p><p>这就是声明式定义的一种，你只需要声明你想干什么(用什么样的数据测试什么函数)，而非命令式定义（你需要定义你要怎么做）.</p><p>人力应该是很珍贵，而机器的计算资源却是很便宜，应该让机器代替人去做生成数据的事。</p><p>举例来说, 以上面的 <code>calculate_discount</code> 函数为例，如果我们告诉程序, <code>price</code> 和 <code>discount_percentage</code> 应该是整数（specification）, 那么 Quickcheck 就会生成各种整数, 从 Integer.Min 到 Integer.Max 不等，用来测试我们的程序.</p><p>如果还是觉得这个概念比较抽象，可以来看下具体的例子：</p><h2 id=hypothesis><span class=section-num>3</span> Hypothesis<a hidden class=anchor aria-hidden=true href=#hypothesis>#</a></h2><p>Python Property Based Testing的测试框架叫 <a href=https://hypothesis.works/>Hypothesis </a><sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>(假想)，这个项目名字也是起得非常有水平，结合Property Based Testing的哲学，可谓信雅达.</p><p>假设我们现在要实现一个简单的数据压缩的算法： <a href=https://en.wikipedia.org/wiki/Run-length_encoding>Run-length Encoding</a> <sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>(RLE)，通常用于压缩包含连续重复数据的序列, 这种编码方法特别适用于那些有大量重复字符或值的数据.</p><p>它的基本原理是：</p><ol><li>统计连续重复的数据元素的数量。</li><li>用一个计数值和数据值的组合来替代这些重复的数据。</li></ol><p>比如字符串: <code>AABBBCCCC</code>, RLE 编码后: <code>2A3B4C</code>. <code>2A</code> 表示两个连续的 <code>A</code>, <code>3B</code> 表示三个连续的 <code>B</code>, <code>4C</code> 表示四个连续的 <code>C</code> 。</p><p>Python实现如下:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>encode</span><span class=p>(</span><span class=n>input_string</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>count</span> <span class=o>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=n>prev</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>lst</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>character</span> <span class=ow>in</span> <span class=n>input_string</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>character</span> <span class=o>!=</span> <span class=n>prev</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>prev</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>entry</span> <span class=o>=</span> <span class=p>(</span><span class=n>prev</span><span class=p>,</span> <span class=n>count</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>lst</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>entry</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>count</span> <span class=o>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            <span class=n>prev</span> <span class=o>=</span> <span class=n>character</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>count</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=n>entry</span> <span class=o>=</span> <span class=p>(</span><span class=n>character</span><span class=p>,</span> <span class=n>count</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>lst</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>entry</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>lst</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>decode</span><span class=p>(</span><span class=n>lst</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>q</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>character</span><span class=p>,</span> <span class=n>count</span> <span class=ow>in</span> <span class=n>lst</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>q</span> <span class=o>+=</span> <span class=n>character</span> <span class=o>*</span> <span class=n>count</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>q</span>
</span></span></code></pre></td></tr></table></div></div><p>如果我们的代码实现没有问题的话，对于任意的字符串，编码后的字符串，解码后的结果应该和原来的字符串一致的，这个就是我们的测试逻辑:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>hypothesis</span> <span class=kn>import</span> <span class=n>given</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>hypothesis.strategies</span> <span class=kn>import</span> <span class=n>text</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@given</span><span class=p>(</span><span class=n>text</span><span class=p>())</span> <span class=c1># 入参的标准是：任意的字符串，hypothesis 框架就会自动生成随机数，并调用test_decode_inverts_encode</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_decode_inverts_encode</span><span class=p>(</span><span class=n>s</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>decode</span><span class=p>(</span><span class=n>encode</span><span class=p>(</span><span class=n>s</span><span class=p>))</span> <span class=o>==</span> <span class=n>s</span>
</span></span></code></pre></td></tr></table></div></div><p>使用 <code>pytest</code> 运行上面的用例，结果如下:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>&gt; pytest property_based_testing.py
</span></span><span class=line><span class=cl><span class=o>===================================</span> <span class=nb>test</span> session <span class=nv>starts</span> <span class=o>====================================</span>
</span></span><span class=line><span class=cl>platform darwin -- Python 3.12.6, pytest-8.3.3, pluggy-1.5.0
</span></span><span class=line><span class=cl>rootdir: /Users/ramsayleung/code/python/test_technique
</span></span><span class=line><span class=cl>plugins: hypothesis-6.115.0
</span></span><span class=line><span class=cl>collected <span class=m>1</span> item
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>property_based_testing.py F                                                          <span class=o>[</span>100%<span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>=========================================</span> <span class=nv>FAILURES</span> <span class=o>=========================================</span>
</span></span><span class=line><span class=cl>________________________________ test_decode_inverts_encode ________________________________
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>@given<span class=o>(</span>text<span class=o>())</span>
</span></span><span class=line><span class=cl>&gt;   def test_decode_inverts_encode<span class=o>(</span>s<span class=o>)</span>:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>property_based_testing.py:29:
</span></span><span class=line><span class=cl>_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
</span></span><span class=line><span class=cl>property_based_testing.py:30: in test_decode_inverts_encode
</span></span><span class=line><span class=cl>assert decode<span class=o>(</span>encode<span class=o>(</span>s<span class=o>))</span> <span class=o>==</span> s
</span></span><span class=line><span class=cl>_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>input_string</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>def encode<span class=o>(</span>input_string<span class=o>)</span>:
</span></span><span class=line><span class=cl><span class=nv>count</span> <span class=o>=</span> <span class=m>1</span>
</span></span><span class=line><span class=cl><span class=nv>prev</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>lst</span> <span class=o>=</span> <span class=o>[]</span>
</span></span><span class=line><span class=cl><span class=k>for</span> character in input_string:
</span></span><span class=line><span class=cl>                 <span class=k>if</span> character !<span class=o>=</span> prev:
</span></span><span class=line><span class=cl>                    <span class=k>if</span> prev:
</span></span><span class=line><span class=cl>                       <span class=nv>entry</span> <span class=o>=</span> <span class=o>(</span>prev, count<span class=o>)</span>
</span></span><span class=line><span class=cl>                       lst.append<span class=o>(</span>entry<span class=o>)</span>
</span></span><span class=line><span class=cl>                       <span class=nv>count</span> <span class=o>=</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>                       <span class=nv>prev</span> <span class=o>=</span> character
</span></span><span class=line><span class=cl>                       <span class=k>else</span>:
</span></span><span class=line><span class=cl>                       <span class=nv>count</span> <span class=o>+=</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>                       &gt;       <span class=nv>entry</span> <span class=o>=</span> <span class=o>(</span>character, count<span class=o>)</span>
</span></span><span class=line><span class=cl>                       E       UnboundLocalError: cannot access <span class=nb>local</span> variable <span class=s1>&#39;character&#39;</span> where it is not associated with a value
</span></span><span class=line><span class=cl>                       E       Falsifying example: test_decode_inverts_encode<span class=o>(</span>
</span></span><span class=line><span class=cl>                           E           <span class=nv>s</span><span class=o>=</span><span class=s1>&#39;&#39;</span>,
</span></span><span class=line><span class=cl>                           E       <span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                       property_based_testing.py:17: <span class=nv>UnboundLocalError</span>
</span></span><span class=line><span class=cl>                       <span class=o>=================================</span> short <span class=nb>test</span> summary <span class=nv>info</span> <span class=o>==================================</span>
</span></span><span class=line><span class=cl>                       FAILED property_based_testing.py::test_decode_inverts_encode - UnboundLocalError: cannot access <span class=nb>local</span> variable <span class=s1>&#39;character&#39;</span> where it is not associated ...
</span></span><span class=line><span class=cl>                       <span class=o>====================================</span> <span class=m>1</span> failed in 0.14s <span class=o>=====================================</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到，当 <code>input_string =''</code> 是空字符串的时候， <code>encode</code> 函数抛出异常了，说 <code>character</code> 变量未定义。原来是 <code>encode</code> 函数没有对空字符串这个 corner case 作处理，那么就加个判断条件，修复一下:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>encode</span><span class=p>(</span><span class=n>input_string</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>input_string</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=n>count</span> <span class=o>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=n>prev</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>lst</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>character</span> <span class=ow>in</span> <span class=n>input_string</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>character</span> <span class=o>!=</span> <span class=n>prev</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>prev</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>entry</span> <span class=o>=</span> <span class=p>(</span><span class=n>prev</span><span class=p>,</span> <span class=n>count</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>lst</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>entry</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>count</span> <span class=o>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            <span class=n>prev</span> <span class=o>=</span> <span class=n>character</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>count</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=n>entry</span> <span class=o>=</span> <span class=p>(</span><span class=n>character</span><span class=p>,</span> <span class=n>count</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>lst</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>entry</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>lst</span>
</span></span></code></pre></td></tr></table></div></div><p>既然我们知道空字符串是个特殊的 case, 因为 hypothesis 生成的都是任意的随机数，不一定每次都会测到空字符串，那我们就自己指定一个 case:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>hypothesis</span> <span class=kn>import</span> <span class=n>example</span><span class=p>,</span> <span class=n>given</span><span class=p>,</span> <span class=n>strategies</span> <span class=k>as</span> <span class=n>st</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@given</span><span class=p>(</span><span class=n>st</span><span class=o>.</span><span class=n>text</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=nd>@example</span><span class=p>(</span><span class=s2>&#34;&#34;</span><span class=p>)</span> <span class=c1># 手工指定空字符串这个 corner case</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_decode_inverts_encode</span><span class=p>(</span><span class=n>s</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>decode</span><span class=p>(</span><span class=n>encode</span><span class=p>(</span><span class=n>s</span><span class=p>))</span> <span class=o>==</span> <span class=n>s</span>
</span></span></code></pre></td></tr></table></div></div><p><code>pytest</code> 重新运行，测试就通过了。但是，对 <code>hypothesis</code> 框架还没有建立信心的你我就不确定，它是否真的生成很多随机来运行这个 test case 呢？</p><p>有两个方法可以验证：</p><p>方法一：最简单粗暴的方式，把 <code>s</code> 变量给打印出来，毕竟眼见为实:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@given</span><span class=p>(</span><span class=n>st</span><span class=o>.</span><span class=n>text</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=nd>@example</span><span class=p>(</span><span class=s2>&#34;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_decode_inverts_encode</span><span class=p>(</span><span class=n>s</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>s</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>decode</span><span class=p>(</span><span class=n>encode</span><span class=p>(</span><span class=n>s</span><span class=p>))</span> <span class=o>==</span> <span class=n>s</span>
</span></span></code></pre></td></tr></table></div></div><p>然后通过 <code>pytest -s</code> 参数要求 <code>pytest</code> 将写入到 <code>stdout</code> 的内容给打印出来</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>&gt; pytest property_based_testing.py -s
</span></span><span class=line><span class=cl><span class=o>=======================================</span> <span class=nb>test</span> session <span class=nv>starts</span> <span class=o>=======================================</span>
</span></span><span class=line><span class=cl>platform darwin -- Python 3.12.6, pytest-8.3.3, pluggy-1.5.0
</span></span><span class=line><span class=cl>rootdir: /Users/ramsayleung/code/python/test_technique
</span></span><span class=line><span class=cl>plugins: hypothesis-6.115.0
</span></span><span class=line><span class=cl>collected <span class=m>1</span> item
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>property_based_testing.py
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>O
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>¶
</span></span><span class=line><span class=cl><span class=se>\å</span>񢄏«
</span></span><span class=line><span class=cl>𥛗Îbó
</span></span><span class=line><span class=cl>𜆮å
</span></span><span class=line><span class=cl>񰘰9
</span></span><span class=line><span class=cl>gah󭾔𛧁
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>i򼯜+ó»򮩸b񝕨
</span></span><span class=line><span class=cl>S!ÕTå<span class=p>&amp;</span>𰵩í¤ýäó÷F
</span></span><span class=line><span class=cl>øôyµ
</span></span><span class=line><span class=cl>Äª
</span></span><span class=line><span class=cl>sLz$ï
</span></span><span class=line><span class=cl>_𠵈
</span></span><span class=line><span class=cl>Ü
</span></span><span class=line><span class=cl>A
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>R󃝷<span class=o>{</span>©¾
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   ìõ
</span></span><span class=line><span class=cl>   æ􂐛BÝ1*􅄢ëóg𮎈¼ ?𩓁
</span></span><span class=line><span class=cl>   Òör @PP􎾂ö񳱊ûÁ½¬HÈ6#
</span></span><span class=line><span class=cl>   a𣽗¶󿅌𧑁x~󗜬韹ûð󴯮#Z󅖫<span class=se>\©</span>𳖅ûf&gt;
</span></span><span class=line><span class=cl>   i
</span></span><span class=line><span class=cl>   ....
</span></span><span class=line><span class=cl>   <span class=o>========================================</span> <span class=m>1</span> passed in 0.15s <span class=o>========================================</span>
</span></span></code></pre></td></tr></table></div></div><p>这一堆都是什么字符呢, 都乱码了。</p><p>毕竟我们告诉 <code>hypothesis</code> 框架的是，我们参数接受的标准是任意的字符串， <code>hypothesis</code> 就非常尽职地帮我们生成了各种字符串，这个测试数据集可比我们自己手工构建的范围大得多，这就是 property based testing 的优势所在.</p><p>第二种方法是使用 <code>hypothesis</code> 框架提供的命令行参数 =&ndash;hypothesis-show-statistics=，用于打印统计信息:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>&gt; pytest property_based_testing.py --hypothesis-show-statistics
</span></span><span class=line><span class=cl><span class=o>=======================================</span> <span class=nb>test</span> session <span class=nv>starts</span> <span class=o>=======================================</span>
</span></span><span class=line><span class=cl>platform darwin -- Python 3.12.6, pytest-8.3.3, pluggy-1.5.0
</span></span><span class=line><span class=cl>rootdir: /Users/ramsayleung/code/python/test_technique
</span></span><span class=line><span class=cl>plugins: hypothesis-6.115.0
</span></span><span class=line><span class=cl>collected <span class=m>1</span> item
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>property_based_testing.py .                                                                 <span class=o>[</span>100%<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>======================================</span> Hypothesis <span class=nv>Statistics</span> <span class=o>======================================</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>property_based_testing.py::test_decode_inverts_encode:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>- during generate phase <span class=o>(</span>0.03 seconds<span class=o>)</span>:
</span></span><span class=line><span class=cl>- Typical runtimes: &lt; 1ms, of which &lt; 1ms in data generation
</span></span><span class=line><span class=cl>- <span class=m>100</span> passing examples, <span class=m>0</span> failing examples, <span class=m>0</span> invalid examples
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>- Stopped because settings.max_examples<span class=o>=</span><span class=nv>100</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>========================================</span> <span class=m>1</span> passed in 0.05s <span class=o>========================================</span>
</span></span></code></pre></td></tr></table></div></div><p>上面运行了 100 条数据，如果你觉得还想跑更多，可以通过 <code>settings</code> 装饰器指定更多:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@settings</span><span class=p>(</span><span class=n>max_examples</span><span class=o>=</span><span class=mi>500</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=quickcheck-and-proptest><span class=section-num>4</span> Quickcheck & Proptest<a hidden class=anchor aria-hidden=true href=#quickcheck-and-proptest>#</a></h2><p>而在Rust生态，就有两个 Property Based Testing 的库，一个是由Rust社区知名开发者，<a href=https://github.com/BurntSushi/ripgrep>ripgrep</a> <sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup>和 regex 库作者移植自 Haskell Quickcheck 库的 <a href=https://github.com/BurntSushi/quickcheck>quickcheck</a> <sup id=fnref:5><a href=#fn:5 class=footnote-ref role=doc-noteref>5</a></sup>(名字也一并移植了), 另外一个是思路继承自 Python Hypothesis 的 <a href=https://github.com/proptest-rs/proptest>Proptest</a> <sup id=fnref:6><a href=#fn:6 class=footnote-ref role=doc-noteref>6</a></sup>(这位直接用property based testing技术来命名了，不得不说，命名真的是门艺术)</p><p>两者的社区接受度都相差无几(star, 使用者数量), 而在公司内部，我也发现 quickcheck 和 proptest 都有人用，坐我旁边的Principle Engineer 用的是 proptest, 而另外一个现在和我共事的同事，她的之前团队用的就是 quickcheck，看到都势均力敌嘛。</p><p>翻开 quickcheck 和 proptest 的API 文档之后，我发现我更喜欢 quickcheck 的接口风格，虽说它的活跃度更低一些，我最后还是选择了使用 quickcheck.</p><p>下面就来介绍一下我在Rust上使用 quickcheck 的心得:</p><p>假设我们现在有一个可以反转列表的函数 <code>reverse</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>fn</span> <span class=nf>reverse</span><span class=o>&lt;</span><span class=n>T</span>: <span class=nb>Clone</span><span class=o>&gt;</span><span class=p>(</span><span class=n>xs</span>: <span class=kp>&amp;</span><span class=p>[</span><span class=n>T</span><span class=p>])</span><span class=w> </span>-&gt; <span class=nb>Vec</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>rev</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=fm>vec!</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=n>xs</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>rev</span><span class=p>.</span><span class=n>insert</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=n>x</span><span class=p>.</span><span class=n>clone</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>rev</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>对于任意类型的列表，反转之后再反转的结果，肯定是和原结果一样的，那么我们就可以开始声明我们的标准(specification), 那就是任意的列表，可以是字符串列表，整型列表或者是其他的结构体列表:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=cp>#[cfg(test)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>mod</span> <span class=nn>tests</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>use</span><span class=w> </span><span class=n>quickcheck_macros</span>::<span class=n>quickcheck</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>use</span><span class=w> </span><span class=k>crate</span>::<span class=n>reverse</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cp>#[quickcheck]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>double_reversal_is_identity_isize</span><span class=p>(</span><span class=n>xs</span>: <span class=nb>Vec</span><span class=o>&lt;</span><span class=kt>isize</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span>-&gt; <span class=kt>bool</span> <span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>xs</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>reverse</span><span class=p>(</span><span class=o>&amp;</span><span class=n>reverse</span><span class=p>(</span><span class=o>&amp;</span><span class=n>xs</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cp>#[quickcheck]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>double_reversal_is_identity_string</span><span class=p>(</span><span class=n>xs</span>: <span class=nb>Vec</span><span class=o>&lt;</span><span class=nb>String</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span>-&gt; <span class=kt>bool</span> <span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>xs</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>reverse</span><span class=p>(</span><span class=o>&amp;</span><span class=n>reverse</span><span class=p>(</span><span class=o>&amp;</span><span class=n>xs</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Rust 的unit test 是不支持带参数的，=#[quickcheck]= 这个宏就会自动将 <code>double_reversal_is_identity_isize</code> 转换成 property based test case, 而得益于Rust的类型系统, <code>quickcheck</code> 就能推断出入参就是我们声明的标准 <code>Vec&lt;isze></code>, 任意 <code>isize</code> 类型的数组.</p><h3 id=struct-with-quickcheck><span class=section-num>4.1</span> Struct with quickcheck<a hidden class=anchor aria-hidden=true href=#struct-with-quickcheck>#</a></h3><p>如果上面的例子觉得过于简单的话，现在就让我们看个复杂一点的例子, 一个简单的图书管理系统，支持会员，借书，还书功能：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span><span class=lnt>92
</span><span class=lnt>93
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>chrono</span>::<span class=p>{</span><span class=n>Duration</span><span class=p>,</span><span class=w> </span><span class=n>NaiveDate</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>collections</span>::<span class=n>HashMap</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[derive(Debug, Clone, PartialEq)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>struct</span> <span class=nc>Book</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>isbn</span>: <span class=nb>String</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>title</span>: <span class=nb>String</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>author</span>: <span class=nb>String</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>publication_year</span>: <span class=kt>u16</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[derive(Debug, Clone, PartialEq)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>struct</span> <span class=nc>Member</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>id</span>: <span class=kt>u32</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>name</span>: <span class=nb>String</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>email</span>: <span class=nb>String</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[derive(Debug, Clone)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>struct</span> <span class=nc>Loan</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>book_isbn</span>: <span class=nb>String</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>member_id</span>: <span class=kt>u32</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>due_date</span>: <span class=nc>NaiveDate</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[derive(Debug, Clone)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>struct</span> <span class=nc>Library</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>books</span>: <span class=nc>HashMap</span><span class=o>&lt;</span><span class=nb>String</span><span class=p>,</span><span class=w> </span><span class=n>Book</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>members</span>: <span class=nc>HashMap</span><span class=o>&lt;</span><span class=kt>u32</span><span class=p>,</span><span class=w> </span><span class=n>Member</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>loans</span>: <span class=nb>Vec</span><span class=o>&lt;</span><span class=n>Loan</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>current_date</span>: <span class=nc>NaiveDate</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>impl</span><span class=w> </span><span class=n>Library</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>new</span><span class=p>(</span><span class=n>current_date</span>: <span class=nc>NaiveDate</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>Self</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Library</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>books</span>: <span class=nc>HashMap</span>::<span class=n>new</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>members</span>: <span class=nc>HashMap</span>::<span class=n>new</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>loans</span>: <span class=nb>Vec</span>::<span class=n>new</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>current_date</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>add_book</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>book</span>: <span class=nc>Book</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=p>(),</span><span class=w> </span><span class=nb>String</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>books</span><span class=p>.</span><span class=n>contains_key</span><span class=p>(</span><span class=o>&amp;</span><span class=n>book</span><span class=p>.</span><span class=n>isbn</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nb>Err</span><span class=p>(</span><span class=s>&#34;Book with this ISBN already exists&#34;</span><span class=p>.</span><span class=n>to_string</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=bp>self</span><span class=p>.</span><span class=n>books</span><span class=p>.</span><span class=n>insert</span><span class=p>(</span><span class=n>book</span><span class=p>.</span><span class=n>isbn</span><span class=p>.</span><span class=n>clone</span><span class=p>(),</span><span class=w> </span><span class=n>book</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nb>Ok</span><span class=p>(())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>add_member</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>member</span>: <span class=nc>Member</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=p>(),</span><span class=w> </span><span class=nb>String</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>members</span><span class=p>.</span><span class=n>contains_key</span><span class=p>(</span><span class=o>&amp;</span><span class=n>member</span><span class=p>.</span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nb>Err</span><span class=p>(</span><span class=s>&#34;Member with this ID already exists&#34;</span><span class=p>.</span><span class=n>to_string</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=bp>self</span><span class=p>.</span><span class=n>members</span><span class=p>.</span><span class=n>insert</span><span class=p>(</span><span class=n>member</span><span class=p>.</span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>member</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nb>Ok</span><span class=p>(())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>loan_book</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>book_isbn</span>: <span class=kp>&amp;</span><span class=kt>str</span><span class=p>,</span><span class=w> </span><span class=n>member_id</span>: <span class=kt>u32</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=p>(),</span><span class=w> </span><span class=nb>String</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=o>!</span><span class=bp>self</span><span class=p>.</span><span class=n>books</span><span class=p>.</span><span class=n>contains_key</span><span class=p>(</span><span class=n>book_isbn</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=nb>Err</span><span class=p>(</span><span class=s>&#34;Book not found&#34;</span><span class=p>.</span><span class=n>to_string</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=o>!</span><span class=bp>self</span><span class=p>.</span><span class=n>members</span><span class=p>.</span><span class=n>contains_key</span><span class=p>(</span><span class=o>&amp;</span><span class=n>member_id</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=nb>Err</span><span class=p>(</span><span class=s>&#34;Member not found&#34;</span><span class=p>.</span><span class=n>to_string</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>loans</span><span class=p>.</span><span class=n>iter</span><span class=p>().</span><span class=n>any</span><span class=p>(</span><span class=o>|</span><span class=n>loan</span><span class=o>|</span><span class=w> </span><span class=n>loan</span><span class=p>.</span><span class=n>book_isbn</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>book_isbn</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=nb>Err</span><span class=p>(</span><span class=s>&#34;Book is already on loan&#34;</span><span class=p>.</span><span class=n>to_string</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>due_date</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>current_date</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>Duration</span>::<span class=n>days</span><span class=p>(</span><span class=mi>14</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>loans</span><span class=p>.</span><span class=n>push</span><span class=p>(</span><span class=n>Loan</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>book_isbn</span>: <span class=nc>book_isbn</span><span class=p>.</span><span class=n>to_string</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>member_id</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>due_date</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nb>Ok</span><span class=p>(())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>return_book</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>book_isbn</span>: <span class=kp>&amp;</span><span class=kt>str</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=p>(),</span><span class=w> </span><span class=nb>String</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=kd>let</span><span class=w> </span><span class=nb>Some</span><span class=p>(</span><span class=n>index</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>loans</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>iter</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>position</span><span class=p>(</span><span class=o>|</span><span class=n>loan</span><span class=o>|</span><span class=w> </span><span class=n>loan</span><span class=p>.</span><span class=n>book_isbn</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>book_isbn</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=bp>self</span><span class=p>.</span><span class=n>loans</span><span class=p>.</span><span class=n>remove</span><span class=p>(</span><span class=n>index</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nb>Ok</span><span class=p>(())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nb>Err</span><span class=p>(</span><span class=s>&#34;Book is not currently on loan&#34;</span><span class=p>.</span><span class=n>to_string</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>通过上面的简单代码，就实现了新增图书，新增会员，借书，和还书功能。现在就让我们来结合 <code>quickcheck</code> 的 <code>Arbitrary</code> 接口，实现生成任意的图书和会员，以便用于测试:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>quickcheck</span>::<span class=p>{</span><span class=n>Arbitrary</span><span class=p>,</span><span class=w> </span><span class=n>Gen</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>impl</span><span class=w> </span><span class=n>Arbitrary</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>Book</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>arbitrary</span><span class=p>(</span><span class=n>g</span>: <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=n>Gen</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>Self</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Book</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// isbn必须以`ISBN` 开头，后接任意的大于等于0，小于uint32.max_value
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=c1>// 的整型
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=n>isbn</span>: <span class=nc>format</span><span class=o>!</span><span class=p>(</span><span class=s>&#34;ISBN-{}&#34;</span><span class=p>,</span><span class=w> </span><span class=kt>u32</span>::<span class=n>arbitrary</span><span class=p>(</span><span class=n>g</span><span class=p>)),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>title</span>: <span class=nb>String</span>::<span class=n>arbitrary</span><span class=p>(</span><span class=n>g</span><span class=p>),</span><span class=w> </span><span class=c1>// 任意的字符串
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=n>author</span>: <span class=nb>String</span>::<span class=n>arbitrary</span><span class=p>(</span><span class=n>g</span><span class=p>),</span><span class=w> </span><span class=c1>// 任意的字符串
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=n>publication_year</span>: <span class=o>*</span><span class=n>g</span><span class=p>.</span><span class=n>choose</span><span class=p>(</span><span class=o>&amp;</span><span class=p>[</span><span class=mi>2014_</span><span class=k>u16</span><span class=p>,</span><span class=w> </span><span class=mi>2022_</span><span class=k>u16</span><span class=p>,</span><span class=w> </span><span class=mi>2025_</span><span class=k>u16</span><span class=p>]).</span><span class=n>unwrap</span><span class=p>(),</span><span class=w> </span><span class=c1>// 2014,2022或2025年出版的书
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>impl</span><span class=w> </span><span class=n>Arbitrary</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>Member</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>arbitrary</span><span class=p>(</span><span class=n>g</span>: <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=n>Gen</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>Self</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Member</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>id</span>: <span class=kt>u32</span>::<span class=n>arbitrary</span><span class=p>(</span><span class=n>g</span><span class=p>),</span><span class=w> </span><span class=c1>// 任意大于0，小于uint32.max_value的整型
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=n>name</span>: <span class=nb>String</span>::<span class=n>arbitrary</span><span class=p>(</span><span class=n>g</span><span class=p>),</span><span class=w> </span><span class=c1>// 任意字符串
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=c1>// 任意字符开头, 以@example.com 结尾的字符
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=n>email</span>: <span class=nc>format</span><span class=o>!</span><span class=p>(</span><span class=s>&#34;{}@example.com&#34;</span><span class=p>,</span><span class=w> </span><span class=nb>String</span>::<span class=n>arbitrary</span><span class=p>(</span><span class=n>g</span><span class=p>)),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>现在就让我们来看下借助 quickcheck 编写的 test case, 注意参数为 <code>Book</code> 和 <code>Member</code> 类型的 case, quickcheck 就会以我们上面定义的标准，自动给我们生成符合规定的 <code>Book</code> 和 <code>Member</code> 参数.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=cp>#[cfg(test)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>mod</span> <span class=nn>tests</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>use</span><span class=w> </span><span class=n>chrono</span>::<span class=n>NaiveDate</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>use</span><span class=w> </span><span class=n>quickcheck_macros</span>::<span class=n>quickcheck</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>use</span><span class=w> </span><span class=k>crate</span>::<span class=n>book</span>::<span class=n>Member</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>use</span><span class=w> </span><span class=k>super</span>::<span class=p>{</span><span class=n>Book</span><span class=p>,</span><span class=w> </span><span class=n>Library</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cp>#[quickcheck]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>adding_book_increases_book_count</span><span class=p>(</span><span class=n>book</span>: <span class=nc>Book</span><span class=p>)</span><span class=w> </span>-&gt; <span class=kt>bool</span> <span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>library</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Library</span>::<span class=n>new</span><span class=p>(</span><span class=n>NaiveDate</span>::<span class=n>from_ymd_opt</span><span class=p>(</span><span class=mi>2024</span><span class=p>,</span><span class=w> </span><span class=mi>10</span><span class=p>,</span><span class=w> </span><span class=mi>14</span><span class=p>).</span><span class=n>unwrap</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>initial_count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>library</span><span class=p>.</span><span class=n>books</span><span class=p>.</span><span class=n>len</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>library</span><span class=p>.</span><span class=n>add_book</span><span class=p>(</span><span class=n>book</span><span class=p>.</span><span class=n>clone</span><span class=p>()).</span><span class=n>unwrap</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>library</span><span class=p>.</span><span class=n>books</span><span class=p>.</span><span class=n>len</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>initial_count</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>library</span><span class=p>.</span><span class=n>books</span><span class=p>.</span><span class=n>contains_key</span><span class=p>(</span><span class=o>&amp;</span><span class=n>book</span><span class=p>.</span><span class=n>isbn</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cp>#[quickcheck]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>cannot_loan_nonexistent_book</span><span class=p>(</span><span class=n>book_isbn</span>: <span class=nb>String</span><span class=p>,</span><span class=w> </span><span class=n>member_id</span>: <span class=kt>u32</span><span class=p>)</span><span class=w> </span>-&gt; <span class=kt>bool</span> <span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>library</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Library</span>::<span class=n>new</span><span class=p>(</span><span class=n>NaiveDate</span>::<span class=n>from_ymd_opt</span><span class=p>(</span><span class=mi>2024</span><span class=p>,</span><span class=w> </span><span class=mi>10</span><span class=p>,</span><span class=w> </span><span class=mi>14</span><span class=p>).</span><span class=n>unwrap</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>library</span><span class=p>.</span><span class=n>loan_book</span><span class=p>(</span><span class=o>&amp;</span><span class=n>book_isbn</span><span class=p>,</span><span class=w> </span><span class=n>member_id</span><span class=p>).</span><span class=n>is_err</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cp>#[quickcheck]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>can_return_loaned_book</span><span class=p>(</span><span class=n>book</span>: <span class=nc>Book</span><span class=p>,</span><span class=w> </span><span class=n>member</span>: <span class=nc>Member</span><span class=p>)</span><span class=w> </span>-&gt; <span class=kt>bool</span> <span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>library</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Library</span>::<span class=n>new</span><span class=p>(</span><span class=n>NaiveDate</span>::<span class=n>from_ymd_opt</span><span class=p>(</span><span class=mi>2024</span><span class=p>,</span><span class=w> </span><span class=mi>10</span><span class=p>,</span><span class=w> </span><span class=mi>14</span><span class=p>).</span><span class=n>unwrap</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>library</span><span class=p>.</span><span class=n>add_book</span><span class=p>(</span><span class=n>book</span><span class=p>.</span><span class=n>clone</span><span class=p>()).</span><span class=n>unwrap</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>library</span><span class=p>.</span><span class=n>add_member</span><span class=p>(</span><span class=n>member</span><span class=p>.</span><span class=n>clone</span><span class=p>()).</span><span class=n>unwrap</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>library</span><span class=p>.</span><span class=n>loan_book</span><span class=p>(</span><span class=o>&amp;</span><span class=n>book</span><span class=p>.</span><span class=n>isbn</span><span class=p>,</span><span class=w> </span><span class=n>member</span><span class=p>.</span><span class=n>id</span><span class=p>).</span><span class=n>unwrap</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>library</span><span class=p>.</span><span class=n>return_book</span><span class=p>(</span><span class=o>&amp;</span><span class=n>book</span><span class=p>.</span><span class=n>isbn</span><span class=p>).</span><span class=n>is_ok</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>通过 <code>quickcheck</code> 我们就可以只专注测试逻辑，可以假定测试数据集是完备的了。可能看到 <code>Book</code> 和 <code>Member</code>, 你会觉得 quickcheck 并没有做太多事情，你手工也可以构造。</p><p>但是我在的实际工作中，我就需要构造一个超过23个成员变量的 struct, 大部分还是 optional, 然后需要将这个 struct 写入到 parquet 文件，然后再测试读取逻辑。
不同成员变量的值可取的范围实在太多了，再叠加上 optional 的可能性，构造数据的代码写得相当恶心.</p><p>所以有了 quickcheck 之后，我只需要为这个 struct 实现 <code>Arbitrary</code> 接口，剩下的就由 <code>quickcheck</code> 替我生成，所以我直接和PE大佬说:</p><blockquote><p>property test saves me life, now I couldn&rsquo;t live without it.</p></blockquote><h2 id=总结><span class=section-num>5</span> 总结<a hidden class=anchor aria-hidden=true href=#总结>#</a></h2><p>本来想抒发感想写点结语，但是看到 Hypothesis 作者写的 <a href=https://hypothesis.readthedocs.io/en/latest/manifesto.html>The purpose of Hypothesis</a><sup id=fnref:7><a href=#fn:7 class=footnote-ref role=doc-noteref>7</a></sup> 来说明他开发的 Hypothesis 的动机，他的文章甚至用来给这个《测试技能进阶》系列总结都相当妥当。</p><p>我就试翻译下他文章的部分段落, 更推荐阅读原文，可谓是用心良苦，字字珠玑:</p><blockquote><p>请容我狂妄一下，Hypothesis 的目标是希望可以让这个世界迈进到一个全新，由高质量软件打造的新世代。</p><p>正如人们所说，软件正在吞噬整个世界。但软件本身却很烂，它充满bug，又不安全，还经常被设计得很烂，这样的软件可谓是万恶之源.</p><p>而软件测试的状况甚至更糟糕，虽然大家都认同应该对代码进行测试，但是你能问心无愧地说，你经手过的代码都有被充分测试么？</p><p>问题在于，实在是太难写出好的测试了，
<strong><strong>你写测试用例的时候，通常持有和你写代码时一样的假设与误区，你写的测试用例自然无法发现你当初埋下的bug</strong></strong> (精辟)</p><p>与此同时，有各种各样让测试变成更好的工具却基本无人使用，最初的 Quickcheck 是1999年推出的，但是大多数开发者甚至从未听说过它，更别提使用了（开山始祖的Quickcheck在GitHub只有700多个Star，就知道作者所言不虚）。
虽然其他语言有些半成品的实现，但是大部分都不值得一试。</p><p>而 Hypothesis 的目标正是正本清源，把先进的测试技术传递给大众，并提供一个高质量的实现，让人们可以接纳它。</p><p>希望可以集百家之所长，附以个人微薄之力，让软件测试变得更好。</p></blockquote><p>系列文章:</p><ul><li><a href=https://ramsayleung.github.io/zh/post/2024/%E6%B5%8B%E8%AF%95%E6%8A%80%E8%83%BD%E8%BF%9B%E9%98%B6%E4%B8%80_%E8%BD%AF%E4%BB%B6%E8%B4%A8%E9%87%8F%E8%AE%A4%E7%9F%A5/>测试技能进阶(一): 软件质量认知</a></li><li><a href=https://ramsayleung.github.io/zh/post/2024/%E6%B5%8B%E8%AF%95%E6%8A%80%E8%83%BD%E8%BF%9B%E9%98%B6%E4%BA%8C_parameterized_tests/>测试技能进阶(二): Parameterized Tests</a></li><li><a href=https://ramsayleung.github.io/zh/post/2024/%E6%B5%8B%E8%AF%95%E6%8A%80%E8%83%BD%E8%BF%9B%E9%98%B6%E4%B8%89_property_based_testing/>测试技能进阶(三): Property Based Testing</a></li></ul><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=https://en.wikipedia.org/wiki/QuickCheck>https://en.wikipedia.org/wiki/QuickCheck</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p><a href=https://hypothesis.works/>https://hypothesis.works/</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p><a href=https://en.wikipedia.org/wiki/Run-length_encoding>https://en.wikipedia.org/wiki/Run-length_encoding</a>&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4><p><a href=https://github.com/BurntSushi/ripgrep>https://github.com/BurntSushi/ripgrep</a>&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:5><p><a href=https://github.com/BurntSushi/quickcheck>https://github.com/BurntSushi/quickcheck</a>&#160;<a href=#fnref:5 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:6><p><a href=https://github.com/proptest-rs/proptest>https://github.com/proptest-rs/proptest</a>&#160;<a href=#fnref:6 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:7><p><a href=https://hypothesis.readthedocs.io/en/latest/manifesto.html>https://hypothesis.readthedocs.io/en/latest/manifesto.html</a>&#160;<a href=#fnref:7 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://ramsayleung.github.io/zh/tags/testing/>testing</a></li><li><a href=https://ramsayleung.github.io/zh/tags/rust/>rust</a></li></ul><nav class=paginav><a class=prev href=https://ramsayleung.github.io/zh/post/2024/%E6%97%81%E8%A7%82%E8%80%85%E7%9C%BC%E4%B8%AD%E7%9A%84%E5%8A%A0%E6%8B%BF%E5%A4%A7%E7%9C%81%E8%AE%AE%E4%BC%9A%E9%80%89%E4%B8%BE/><span class=title>« 上一页</span><br><span>旁观者眼中的加拿大省议会选举</span>
</a><a class=next href=https://ramsayleung.github.io/zh/post/2024/%E6%B5%8B%E8%AF%95%E6%8A%80%E8%83%BD%E8%BF%9B%E9%98%B6%E4%BA%8C_parameterized_tests/><span class=title>下一页 »</span><br><span>测试技能进阶(二): Parameterized Tests</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share 测试技能进阶(三): Property Based Testing on x" href="https://x.com/intent/tweet/?text=%e6%b5%8b%e8%af%95%e6%8a%80%e8%83%bd%e8%bf%9b%e9%98%b6%28%e4%b8%89%29%3a%20Property%20Based%20Testing&amp;url=https%3a%2f%2framsayleung.github.io%2fzh%2fpost%2f2024%2f%25E6%25B5%258B%25E8%25AF%2595%25E6%258A%2580%25E8%2583%25BD%25E8%25BF%259B%25E9%2598%25B6%25E4%25B8%2589_property_based_testing%2f&amp;hashtags=testing%2crust"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 测试技能进阶(三): Property Based Testing on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2framsayleung.github.io%2fzh%2fpost%2f2024%2f%25E6%25B5%258B%25E8%25AF%2595%25E6%258A%2580%25E8%2583%25BD%25E8%25BF%259B%25E9%2598%25B6%25E4%25B8%2589_property_based_testing%2f&amp;title=%e6%b5%8b%e8%af%95%e6%8a%80%e8%83%bd%e8%bf%9b%e9%98%b6%28%e4%b8%89%29%3a%20Property%20Based%20Testing&amp;summary=%e6%b5%8b%e8%af%95%e6%8a%80%e8%83%bd%e8%bf%9b%e9%98%b6%28%e4%b8%89%29%3a%20Property%20Based%20Testing&amp;source=https%3a%2f%2framsayleung.github.io%2fzh%2fpost%2f2024%2f%25E6%25B5%258B%25E8%25AF%2595%25E6%258A%2580%25E8%2583%25BD%25E8%25BF%259B%25E9%2598%25B6%25E4%25B8%2589_property_based_testing%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 测试技能进阶(三): Property Based Testing on reddit" href="https://reddit.com/submit?url=https%3a%2f%2framsayleung.github.io%2fzh%2fpost%2f2024%2f%25E6%25B5%258B%25E8%25AF%2595%25E6%258A%2580%25E8%2583%25BD%25E8%25BF%259B%25E9%2598%25B6%25E4%25B8%2589_property_based_testing%2f&title=%e6%b5%8b%e8%af%95%e6%8a%80%e8%83%bd%e8%bf%9b%e9%98%b6%28%e4%b8%89%29%3a%20Property%20Based%20Testing"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 测试技能进阶(三): Property Based Testing on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2framsayleung.github.io%2fzh%2fpost%2f2024%2f%25E6%25B5%258B%25E8%25AF%2595%25E6%258A%2580%25E8%2583%25BD%25E8%25BF%259B%25E9%2598%25B6%25E4%25B8%2589_property_based_testing%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 测试技能进阶(三): Property Based Testing on whatsapp" href="https://api.whatsapp.com/send?text=%e6%b5%8b%e8%af%95%e6%8a%80%e8%83%bd%e8%bf%9b%e9%98%b6%28%e4%b8%89%29%3a%20Property%20Based%20Testing%20-%20https%3a%2f%2framsayleung.github.io%2fzh%2fpost%2f2024%2f%25E6%25B5%258B%25E8%25AF%2595%25E6%258A%2580%25E8%2583%25BD%25E8%25BF%259B%25E9%2598%25B6%25E4%25B8%2589_property_based_testing%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 测试技能进阶(三): Property Based Testing on telegram" href="https://telegram.me/share/url?text=%e6%b5%8b%e8%af%95%e6%8a%80%e8%83%bd%e8%bf%9b%e9%98%b6%28%e4%b8%89%29%3a%20Property%20Based%20Testing&amp;url=https%3a%2f%2framsayleung.github.io%2fzh%2fpost%2f2024%2f%25E6%25B5%258B%25E8%25AF%2595%25E6%258A%2580%25E8%2583%25BD%25E8%25BF%259B%25E9%2598%25B6%25E4%25B8%2589_property_based_testing%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 测试技能进阶(三): Property Based Testing on ycombinator" href="https://news.ycombinator.com/submitlink?t=%e6%b5%8b%e8%af%95%e6%8a%80%e8%83%bd%e8%bf%9b%e9%98%b6%28%e4%b8%89%29%3a%20Property%20Based%20Testing&u=https%3a%2f%2framsayleung.github.io%2fzh%2fpost%2f2024%2f%25E6%25B5%258B%25E8%25AF%2595%25E6%258A%2580%25E8%2583%25BD%25E8%25BF%259B%25E9%2598%25B6%25E4%25B8%2589_property_based_testing%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer><script src=https://utteranc.es/client.js repo=ramsayleung/comment issue-term=title theme=github-light crossorigin=anonymous async></script></article></main><footer class=footer><span>See this site&rsquo;s source code <a href=https://github.com/ramsayleung/ramsayleung.github.io>here</a>, licensed under GPLv3 ·</span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>