<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>RSpotify: 一个用爱发电五年的开源项目 | 花生地</title>
<meta name=keywords content="rspotify,rust"><meta name=description content="1 前言 一周前看到个新闻，Spotify在其第四季度财报中披露，截至2022年12月31日，它的付费订阅用户数达到了2.05亿，同比增长14%"><meta name=author content="Ramsay Leung"><link rel=canonical href=https://ramsayleung.github.io/zh/post/2023/rspotify_%E4%B8%80%E4%B8%AA%E7%94%A8%E7%88%B1%E5%8F%91%E7%94%B5%E4%BA%94%E5%B9%B4%E7%9A%84%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.46cc5df5cea4f9e605aee3c1fe8081c8321fd3b05c5be578186176264814ef44.css integrity="sha256-Rsxd9c6k+eYFruPB/oCByDIf07BcW+V4GGF2JkgU70Q=" rel="preload stylesheet" as=style><link rel=icon href=https://ramsayleung.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://ramsayleung.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://ramsayleung.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://ramsayleung.github.io/apple-touch-icon.png><link rel=mask-icon href=https://ramsayleung.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://ramsayleung.github.io/zh/post/2023/rspotify_%E4%B8%80%E4%B8%AA%E7%94%A8%E7%88%B1%E5%8F%91%E7%94%B5%E4%BA%94%E5%B9%B4%E7%9A%84%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-9MG65HQHEL"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-9MG65HQHEL",{anonymize_ip:!1})}</script><meta property="og:title" content="RSpotify: 一个用爱发电五年的开源项目"><meta property="og:description" content="1 前言 一周前看到个新闻，Spotify在其第四季度财报中披露，截至2022年12月31日，它的付费订阅用户数达到了2.05亿，同比增长14%"><meta property="og:type" content="article"><meta property="og:url" content="https://ramsayleung.github.io/zh/post/2023/rspotify_%E4%B8%80%E4%B8%AA%E7%94%A8%E7%88%B1%E5%8F%91%E7%94%B5%E4%BA%94%E5%B9%B4%E7%9A%84%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/"><meta property="og:image" content="https://ramsayleung.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="post"><meta property="article:published_time" content="2023-02-07T15:40:00-08:00"><meta property="article:modified_time" content="2025-01-09T20:06:55-08:00"><meta property="og:site_name" content="Ramsay's Blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://ramsayleung.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="RSpotify: 一个用爱发电五年的开源项目"><meta name=twitter:description content="1 前言 一周前看到个新闻，Spotify在其第四季度财报中披露，截至2022年12月31日，它的付费订阅用户数达到了2.05亿，同比增长14%"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://ramsayleung.github.io/zh/post/"},{"@type":"ListItem","position":2,"name":"RSpotify: 一个用爱发电五年的开源项目","item":"https://ramsayleung.github.io/zh/post/2023/rspotify_%E4%B8%80%E4%B8%AA%E7%94%A8%E7%88%B1%E5%8F%91%E7%94%B5%E4%BA%94%E5%B9%B4%E7%9A%84%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"RSpotify: 一个用爱发电五年的开源项目","name":"RSpotify: 一个用爱发电五年的开源项目","description":"1 前言 一周前看到个新闻，Spotify在其第四季度财报中披露，截至2022年12月31日，它的付费订阅用户数达到了2.05亿，同比增长14%","keywords":["rspotify","rust"],"articleBody":"1 前言 一周前看到个新闻，Spotify在其第四季度财报中披露，截至2022年12月31日，它的付费订阅用户数达到了2.05亿，同比增长14%； 月活用户4.89亿。Spotify成为第一家订阅用户数突破2亿的音乐流服务。\n而我突然意识到，我那个使用Rust, 为Spotify开发，挂在Sptofiy官网的library：RSpotify，已经维护有五年了：\n一件用爱发电的开源项目要坚持维护五年，也是有很多话可以说的。\n2 起源 还记得大三暑假时，也就是2017年，当时找好了实习，并且拿到了Return Offer. 在拿到Offer之后，实习还没有离职，就想学习一门新的编程语言。\n因为之前用的是都是Java，Python之类的带GC的编程语言，就想学习点硬核，偏底层的编程语言。 本来是想学C++，结果在知乎看了一圈之后，大家都说C++要没落了，推荐学习Rust。（然后我现在靠写C++混饭吃）\n搜索了Rust的信息，发现它性能媲美C/C++, 又不需要手动管理内存，还连续几年荣膺Stackoverflow的 Most Loved Programming Language, 就它了。就开始了一边实习一边摸鱼学习了Rust的旅程。\n因为大学前三年把学分都已经修满了，所以大四一整个学年都不需要上课了，就有时间折腾。\n在学了2-3个月之后，就想拿Rust来写些项目。 但因为我只会写Web应用，又没有想到能写什么，到时就用Rust写了个博客，并将博客从原来的Github Pages迁移到自建的博客上。\n很臭屁地在 V2ex 和 Reddit 分享用Rust重写博客的经历，V2ex 一群人问我为什么不用PHP/xxx语言写，Reddit社区就友好很多。 （然后过了5年之后，服务器欠费，又把自建博客迁移回Github Pages。当然，那是后话了。）\n在花了2-3个月写完博客之后，觉得自己入门Rust，就想写个开源项目，感受下与其他开发者协作的场景。\n当时看到个网易云音乐命令行版本的播放器 musicbox, 当时我在用的是Spotify，就希望可以为Spotify写个类似的播放器。\n虽说Spotify API是对外开放，但直接使用HttpClient来请求HTTP API有点太祼，所以就希望使用先封装个library，方便后续的Rust应用直接调用，就不需要自己操心Http请求了。\n这就是RSpotify这个库的来源。\n这次，我就只在 Reddit和博客 上分享使用Rust来写library 的经历了。\nReddit: My first crate– rspotify, Spotify API wrapper implemented in Rust 博客: RSpotify– 我的第一个Rust crate 3 演进 3.1 野蛮生长阶段 刚开始写RSpotify的时候，对于如何设计一个易用，友好的library 完全没有头绪，毕竟设计好用的类库需要相当的经验沉淀。\n对于没有设计思路的我而言，当时能想来的解决方案是去Spotify官方列出来的library看下，哪个语言的library看得懂，star又多，就把这个library 翻译到Rust上。\n就把目光瞄准到Python版本的 spotipy 上。\n在2018-01-08 提交了第一个commit, 经过一个多月的日夜施工，终于在2018-02-18 完成了所有的API接口开发，发布了 0.1版本\n虽然这是我这个学生写的第一个Rust库，但是开源项目需要的标准配置，我还是都加上了：\n自动化流水线，Travis（当时Github Action还没有出现） 齐全的文档说明 完整的单元测试用例 使用示例 README说明与License 为了吸引其他开发者来协作开发，所有的资料都是英文的。\n不过从Rust 包托管网站 crates.io 的数据可以看到，0.1版本只有300+的下载量，几乎没有什么人在用。\n3.2 async 阶段 时间来到2019年，对于Rust社区来说，最激动人心的应该是Rust 1.39版本，将正式包含 async/await 特性，自那天起，Rust正式支持异步编程。\n自此之后，Rust社区在做的事情，就是把已有Rust代码疯狂升级到async await，RSpotify虽迟，但也赶上了这波潮流。\n当时RSpotify 请求Spotify的API使用的HTTP库是 reqwest=，在 =reqwest 支持异步模式之后，开发者 Alexander就提了一个超大的PR，把所有已有的api全部修改成=async=, 我就乐见其成，就把这个PR合并了。\n有社区的同学抱怨说异步模式的代码不好使用，他对性能没有什么要求，能否保留同步模式的接口调用。\n后来为了兼顾同步模式和异步模式这两种调用方式，Alexander 又提了一个超大超大的PR，把现有的异步模式代码复制一份，然后把=async= 关键字去掉。\n从此以后，RSpotify就需要同时维护两份几乎相同的代码，每次新增，修改，删除都需要确保同时变更两份代码。 着实痛苦不堪，但我也没有思考出更优解。\n这时候，后来和我共同维护RSpotify 的开发者 Mario 出现了。\n3.3 maybe_async 阶段 当时RSpotify最大的问题在于有两份几乎一样，但是使用同步调用和异步调用模式的代码。\n而异步调用的代码，返回参数都是一个 Future ，将真正的响应结果封装在一个 Future 结构里面。\n所以当时Mario 提出的第一个解决思路，是将对异步代码进行封装，使用同步调用的runtime调用异步函数，然后再把响应结果返回回去：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 // 异步代码 async fn original() -\u003e Result\u003cString, reqwest::Error\u003e { reqwest::get(\"https://www.rust-lang.org\") .await? .text() .await } lazy_static! { // Mutex to have mutable access and Arc so that it's thread-safe. static ref RT: Arc\u003cMutex\u003cruntime::Runtime\u003e\u003e = Arc::new(Mutex::new(runtime::Builder::new() .basic_scheduler() .enable_all() .build() .unwrap())); } // 同步版本代码 fn with_block_on() -\u003e Result\u003cString, reqwest::Error\u003e { RT.lock().unwrap().block_on(async move { original().await }) } 再通过Rust macro来为每个async 函数生成一个block_on 版本的函数。\n但实际上，发现编写macro太复杂，并且这种方案不够灵活，实现起来也相当复杂。\n然后Mario 又调研出一种新方案，通过 maybe_async 这个库在同步和异步模式之间切换。 默认是异步模式，但可以通过 features = [\"is_sync\"] 编译选项来切换到同步模式，=maybe_async= 就会把所有的=async/await= 关键字给去掉。\n这个方案简单，可读性高，易于扩展，也不需要维护复杂的 macro 代码。\n这也是我们最终采取的方案，重构之后，把 blocking 目录的近万行复制粘贴而来的代码删除掉，就非常爽。\n3.4 二次重构 阶段 前面提到，RSpotify最开始是直接翻译spotipy的代码。 因为Python是弱类型，而Rust是强类型，直接翻译，难免会有不少代码，写法没有纯正的Rust味道。\n社区的Kestrer同学就在一个issue里面，给RSpotify提了近90条优化建议，指出了RSpotify中设计的各种问题，包括强类型运用不当，使用过多的原始类型，函数出入参设计不够优雅，授权流程设计不够易用等等。\n这么多的优化建议，可以看出Kestrer真的花了很多时间来阅读和改善RSpotify的代码，盛情难却（可见原来的代码是+多烂+, 有非常多激发社区同学参与改进的空间）.\n别人指出问题，就要好好优化。\n所以我和Mario就分别对每个接口返回的数据模型，数据模型与Json间转换的序列化方式，授权流程作了改进。 并对RSpotify这个library作了拆分，按照功能，拆分成 model, http, macros 三个单独的library。\n期间提了大概20多个PR，花了超过一年的时间，才处理完Kestrer 提的所有建议。\n3.5 pre-release 阶级 在开源社区里面，有一个约定俗成的规范： 当一个library 发布1.0 之后，就代表这个库已经处于稳定状态，不会再出现大量breaking change 的情况了。（py2, py3不在此约束内）\n而经过4年的开发，RSpotify 已经步入一个相对稳定的开发状态，没有太多的breaking change 或重构了，开始为发布正式的1.0release 版本作准备。\n当功能与架构相对稳定后，近一年时间，我和Mario就开始优化RSpotify的易用性，比如\n添加更多，针对不同场景的 examples； 尽可能地去掉 unsafe 代码； 为返回列表的API提供同步及异步版本的Iterator支持; 保持向前兼容的情况下，尽量使已有接口更加Rust化； 添加更多的自动化检查，如检查代码中文档的链接是否404； 性能优化，减少不必要的内存分配 目前版本已经去到了 0.11.6, 功能也相对稳定, 预计不久后就会正式发布1.0版本。\n4 感悟 4.1 开源协作 截至到2023-02-09，RSpotify一共有1673次commit, 但我和Mario都只贡献了1/3的commit，剩下的commit都是社区的其他开发者提交的。\n从RSpotify的演进历程也可以看出，我只是从0开发了最初版本的RSpotify，后面都是随着Rust的演进，有不同的开发者帮忙优化与迭代，我做的事情就从单纯的creator, developer 变成maintainer, reviewer，负责review其他开发者的PR。\n可以说，如果没有其他开发者的贡献与协作，RSpotify不会演进成现在的样子。\n如何吸引更多的开发者加入，让他们乐于为项目作贡献，我个人的见解是：\n所有文档，注释，commit message, issue, CHANGELOG等材料，都只使用英文。 标准的开源协作流程； issue, PR, CHANGELOG 都提供标准模板 要添加新特性，修改已有功能的时候，新建issue讨论动机与可行性 每个PR都需要一个Peer Reviewer review后才能合并 每次发新版本，都需要在 CHANGELOG 注明大的特性变更，以及breaking change 文档，示例，开发指引，测试case完备，降低新开发者参与的成本。 be nice，态度友好，针对issue，PR都尽量回复，理性，友善讨论。 开源协作的一个感受就是，在Github讨论问题的时候，可能突然有位大佬也加入群聊。\n比如和Mario讨论, 增加更多更严格cargo clippy 的rule，以便让编译器帮我们发现更多潜在问题时，cargo clippy 的maintainer 也加入讨论，就什么rule 更合适，给出自己的建议。\n4.2 收获 我用C++已经混了三年的饭吃了，但还只能看到C++的门槛，没法说入了C++的门。\n同理，虽然距离我学习Rust已经过去6年了，我依然感觉我还不会Rust，都是编译器教我写代码。\n在Review别人代码的过程中，我也学习到非常多「地道」和高级的Rust用法，项目维护的经验.\n想到的点：\n使用Rust的macro来减少copy-paste的代码（但复杂的 macro，基本不具备可读性。） 使用 serde 自定义序列化函数； 以workspace 模式管理多个crates; 编写 async/await 的异步代码； 使用标准库的Trait, 风格契合标准库； 结合thiserror 和anyhow 处理异常； 通过自动化和模式化，减少项目维护的成本（能用机器做的，就不要用人做）。 规范的开发流程，包括commit message, issue, PR, CHANGELOG, release note 等等 期间把收获与心得写了两篇文章：\nThe lesson learned from refactoring rspotify Let’s make everything iterable 4.3 关于开源 维护这个项目5年之后，对于「开源」有了些不一样的理解。\n在1970 年代，Richard Stallman发起自由软件运动，旨在推广用户有使用，复制，研究，修改和分发软件的社会运动。 自由软件运动人士认为自由软件的精神应该贯彻到所有软件。\n在90年代，又兴起了开源软件运动，则计算机软件的源代码是可以公开，随意获取的。 （自由软件与开源软件不是同一个概念，自由软件定义更为严格）\n在那个崇尚黑客精神的年代，开源是「目的」，是为了贯彻自由的精神。\n以前听到某某公司内部有好用的工具，组件，框架时，总会问一句，为什么他们不像Google一样把它们开源出来。\n现在的想法可能是，为什么要开源出来，价值和收益是什么？\n开源一个项目的目的可能是：\n我做了个很有用，很有趣的东西，就想分享出来。但是我个人人力有限，大家一起来帮忙做大做好。(Linux, Ruby On Rails等) 我们做了个好东西，我们要抢占市场。我们就开源，搞人海战术，让竞品淹没在人民群众的汪洋大海中，让我们的东西成为事实的标准。（Android，Chromium, Kubernetes, Vscode） 就想开源让你们见识下大佬是怎么样子的。 对于商业公司而言，如果没有收益，为什么要把花钱雇的人写的内部组件开源出来呢？总不成是为了在B站上博取小朋友的称赞吧。\n而公司内部的组件，往往是与业务共生，高度适配的，藕断丝连，没有那么容易开源的。\n商业公司，只谈收益与预期，如果名声能卖钱，估计也会拿来换取利润。\n更重要的是，开源并不是简单把代码公开出来。\n软件和生物一样，是有生命的，需要长期维护的，而不是一个commit把所有代码一把push 到Github就完事了，或者然后过了几年又push一把，更新几百个文件。\n开源是一个技术与管理结合的决定，需要把开发模式都切换到开源社区，决策过程与动机要对社区可见。\n不仅让人能从代码中读懂功能是「什么」，也要从动机讨论中知道「为什么」要这么改。\n4.4 些许成果 在Github上，被1108个仓库及18个package 所依赖，而其中Alexander的 spotify-tui 就是我期望做的终端版本的Spotify。\n开源的好处就是，在开发好基础设施之后，自然就会有其他有相同想法的同学，把应用开发出来。\ncrates.io 的统计，总计被下载23w次，当然包括很多CI的重复下载。\n对于有Rust，Spotify，Library等诸多定语的RSpotify来说，目标受众本来就不多，能有现在这样的用户量也算是个挺不错的成果了。\n5 总结 虽然我未曾从这个项目上获得到一分物质上的回报，但在创建这个项目的时候，我可能不会想到，我能维护它长达五年。\n天上的云，飘来又飘走；开源的项目，挖坑又弃坑。\n视线望不穿下一个五年，唯有且行且看。\n6 参考 Spotify is first music streaming service to surpass 200M paid subscribers RSpotify 公号同步更新，欢迎关注👻 ","wordCount":"5363","inLanguage":"zh","image":"https://ramsayleung.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2023-02-07T15:40:00-08:00","dateModified":"2025-01-09T20:06:55-08:00","author":{"@type":"Person","name":"Ramsay Leung"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://ramsayleung.github.io/zh/post/2023/rspotify_%E4%B8%80%E4%B8%AA%E7%94%A8%E7%88%B1%E5%8F%91%E7%94%B5%E4%BA%94%E5%B9%B4%E7%9A%84%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/"},"publisher":{"@type":"Organization","name":"花生地","logo":{"@type":"ImageObject","url":"https://ramsayleung.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://ramsayleung.github.io/zh/ accesskey=h title="Home (Alt + H)"><img src=https://ramsayleung.github.io/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://ramsayleung.github.io/en/ title=English aria-label=English>En</a></li></ul></div></div><ul id=menu><li class=dropdown><a href=https://ramsayleung.github.io/zh/categories/ title="系列 "><span>系列 ▾</span></a><div class="menu-more-content dropdown-content"><a href=https://ramsayleung.github.io/zh/categories/%E5%BE%97%E5%A4%B1%E6%84%9F%E6%82%9F/ title=得失感悟><span>得失感悟
</span></a><a href=https://ramsayleung.github.io/zh/categories/%E6%B5%8B%E8%AF%95%E6%8A%80%E8%83%BD%E8%BF%9B%E9%98%B6/ title=测试技能进阶><span>测试技能进阶
</span></a><a href=https://ramsayleung.github.io/zh/categories/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E7%A8%8B%E5%B8%88%E7%9A%84%E8%BD%AF%E6%8A%80%E8%83%BD%E6%8C%87%E5%8C%97/ title=软件工程师的软技能指北><span>软件工程师的软技能指北
</span></a><a href=https://ramsayleung.github.io/zh/categories/%E5%B7%A5%E4%BD%9C%E6%B5%81/ title=我的工作流><span>我的工作流
</span></a><a href=https://ramsayleung.github.io/zh/categories/%E6%97%85%E5%8A%A0%E7%BB%8F%E5%8E%86 title=旅加经历><span>旅加经历</span></a></div></li><li><a href=https://ramsayleung.github.io/zh/archives/ title=归档><span>归档</span></a></li><li><a href=https://ramsayleung.github.io/zh/search/ title=搜索><span>搜索</span></a></li><li><a href=https://ramsayleung.github.io/zh/tags/ title=标签><span>标签</span></a></li><li><a href=https://ramsayleung.github.io/zh/about_me_zh/ title=关于><span>关于</span></a></li><li><a href=https://ramsayleung.github.io/zh/index.xml title=RSS><span>RSS</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://ramsayleung.github.io/zh/>主页</a>&nbsp;»&nbsp;<a href=https://ramsayleung.github.io/zh/post/>Posts</a></div><h1 class="post-title entry-hint-parent">RSpotify: 一个用爱发电五年的开源项目</h1><div class=post-meta><span title='2023-02-07 15:40:00 -0800 -0800'>二月 7, 2023</span>&nbsp;·&nbsp;11 分钟&nbsp;·&nbsp;5363 字&nbsp;·&nbsp;Ramsay Leung&nbsp;|&nbsp;<a href=https://github.com/ramsayleung/ramsayleung.github.io/blob/master/content/post/2023/rspotify_%e4%b8%80%e4%b8%aa%e7%94%a8%e7%88%b1%e5%8f%91%e7%94%b5%e4%ba%94%e5%b9%b4%e7%9a%84%e5%bc%80%e6%ba%90%e9%a1%b9%e7%9b%ae.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#前言><span class=section-num>1</span> 前言</a></li><li><a href=#起源><span class=section-num>2</span> 起源</a></li><li><a href=#演进><span class=section-num>3</span> 演进</a><ul><li><a href=#野蛮生长阶段><span class=section-num>3.1</span> 野蛮生长阶段</a></li><li><a href=#async-阶段><span class=section-num>3.2</span> async 阶段</a></li><li><a href=#maybe-async-阶段><span class=section-num>3.3</span> maybe_async 阶段</a></li><li><a href=#二次重构-阶段><span class=section-num>3.4</span> 二次重构 阶段</a></li><li><a href=#pre-release-阶级><span class=section-num>3.5</span> pre-release 阶级</a></li></ul></li><li><a href=#感悟><span class=section-num>4</span> 感悟</a><ul><li><a href=#开源协作><span class=section-num>4.1</span> 开源协作</a></li><li><a href=#收获><span class=section-num>4.2</span> 收获</a></li><li><a href=#关于开源><span class=section-num>4.3</span> 关于开源</a></li><li><a href=#些许成果><span class=section-num>4.4</span> 些许成果</a></li></ul></li><li><a href=#总结><span class=section-num>5</span> 总结</a></li><li><a href=#参考><span class=section-num>6</span> 参考</a></li></ul></nav></div></details></div><div class=post-content><h2 id=前言><span class=section-num>1</span> 前言<a hidden class=anchor aria-hidden=true href=#前言>#</a></h2><p>一周前看到个<a href=https://www.theverge.com/2023/1/31/23577499/spotify-q4-2022-earnings-release-subscriber-growth-layoffs>新闻</a>，Spotify在其第四季度财报中披露，截至2022年12月31日，它的付费订阅用户数达到了2.05亿，同比增长14%；
月活用户4.89亿。Spotify成为第一家订阅用户数突破2亿的音乐流服务。</p><p>而我突然意识到，我那个使用Rust, 为Spotify开发，挂在Sptofiy官网的<a href=https://developer.spotify.com/documentation/web-api/libraries/>library</a>：<a href=https://github.com/ramsayleung/rspotify>RSpotify</a>，已经维护有五年了：</p><figure><a href=/ox-hugo/web_api_wrapper.png><img loading=lazy src=/ox-hugo/web_api_wrapper.png></a></figure><figure><a href=/ox-hugo/commit.png><img loading=lazy src=/ox-hugo/commit.png></a></figure><p>一件用爱发电的开源项目要坚持维护五年，也是有很多话可以说的。</p><h2 id=起源><span class=section-num>2</span> 起源<a hidden class=anchor aria-hidden=true href=#起源>#</a></h2><p>还记得大三暑假时，也就是2017年，当时找好了实习，并且拿到了Return Offer.
在拿到Offer之后，实习还没有离职，就想学习一门新的编程语言。</p><p>因为之前用的是都是Java，Python之类的带GC的编程语言，就想学习点硬核，偏底层的编程语言。
本来是想学C++，结果在知乎看了一圈之后，大家都说C++要没落了，推荐学习Rust。（然后我现在靠写C++混饭吃）</p><p>搜索了Rust的信息，发现它性能媲美C/C++, 又不需要手动管理内存，还连续几年荣膺Stackoverflow的<a href=https://insights.stackoverflow.com/survey/2017#technology-_-most-loved-dreaded-and-wanted-languages> Most Loved Programming Language</a>, 就它了。就开始了一边实习一边摸鱼学习了Rust的旅程。</p><p>因为大学前三年把学分都已经修满了，所以大四一整个学年都不需要上课了，就有时间折腾。</p><p>在学了2-3个月之后，就想拿Rust来写些项目。
但因为我只会写Web应用，又没有想到能写什么，到时就用Rust写了个<a href=https://github.com/ramsayleung/blog>博客</a>，并将博客从原来的Github Pages迁移到自建的博客上。</p><p>很臭屁地在 <a href=https://www.v2ex.com/t/394146>V2ex</a> 和 <a href=https://www.reddit.com/r/rust/comments/72rr96/i_rewrite_my_blog_with_rust_thanks_for_all/>Reddit</a> 分享用Rust重写博客的经历，V2ex 一群人问我为什么不用PHP/xxx语言写，Reddit社区就友好很多。
（然后过了5年之后，服务器欠费，又把自建博客迁移回Github Pages。当然，那是后话了。）</p><p>在花了2-3个月写完博客之后，觉得自己入门Rust，就想写个开源项目，感受下与其他开发者协作的场景。</p><p>当时看到个网易云音乐命令行版本的播放器 <a href=https://github.com/darknessomi/musicbox>musicbox</a>, 当时我在用的是Spotify，就希望可以为Spotify写个类似的播放器。</p><p>虽说Spotify API是对外开放，但直接使用HttpClient来请求HTTP API有点太祼，所以就希望使用先封装个library，方便后续的Rust应用直接调用，就不需要自己操心Http请求了。</p><p>这就是RSpotify这个库的来源。</p><p>这次，我就只在 Reddit和博客 上分享使用Rust来写library 的经历了。</p><ul><li>Reddit: <a href=https://www.reddit.com/r/rust/comments/7xn9mh/my_first_crate_rspotify_spotify_api_wrapper/>My first crate&ndash; rspotify, Spotify API wrapper implemented in Rust</a></li><li>博客: <a href=https://ramsayleung.github.io/zh/post/2018/rspotify/>RSpotify– 我的第一个Rust crate</a></li></ul><h2 id=演进><span class=section-num>3</span> 演进<a hidden class=anchor aria-hidden=true href=#演进>#</a></h2><h3 id=野蛮生长阶段><span class=section-num>3.1</span> 野蛮生长阶段<a hidden class=anchor aria-hidden=true href=#野蛮生长阶段>#</a></h3><p>刚开始写RSpotify的时候，对于如何设计一个易用，友好的library 完全没有头绪，毕竟设计好用的类库需要相当的经验沉淀。</p><p>对于没有设计思路的我而言，当时能想来的解决方案是去Spotify官方列出来的<a href=https://developer.spotify.com/documentation/web-api/libraries/>library</a>看下，哪个语言的library看得懂，star又多，就把这个library 翻译到Rust上。</p><p>就把目光瞄准到Python版本的 <a href=https://github.com/spotipy-dev/spotipy>spotipy</a> 上。</p><p>在2018-01-08 提交了第一个commit, 经过一个多月的日夜施工，终于在<a href=https://github.com/ramsayleung/rspotify/commit/bb93cc9cc52d5ee62e72b8be1c33a5e3e3ae60ac>2018-02-18</a> 完成了所有的API接口开发，发布了<a href=https://crates.io/crates/rspotify/0.1.0> 0.1版本</a></p><p>虽然这是我这个学生写的第一个Rust库，但是开源项目需要的标准配置，我还是都加上了：</p><ul><li>自动化流水线，Travis（当时Github Action还没有出现）</li><li>齐全的<a href=https://docs.rs/rspotify/0.1.1/rspotify/index.html>文档说明</a></li><li>完整的单元测试用例</li><li>使用示例</li><li>README说明与License</li></ul><p>为了吸引其他开发者来协作开发，所有的资料都是英文的。</p><p>不过从Rust 包托管网站 <a href=https://crates.io/crates/rspotify/0.1.0>crates.io</a> 的数据可以看到，0.1版本只有300+的下载量，几乎没有什么人在用。</p><figure><a href=/ox-hugo/stats_0.10.png><img loading=lazy src=/ox-hugo/stats_0.10.png></a></figure><h3 id=async-阶段><span class=section-num>3.2</span> async 阶段<a hidden class=anchor aria-hidden=true href=#async-阶段>#</a></h3><p>时间来到2019年，对于Rust社区来说，<a href=https://www.reddit.com/r/rust/comments/ct7aus/stabilize_async_await_in_rust_1390/>最激动人心</a>的应该是Rust 1.39版本，将正式包含 <code>async/await</code> 特性，自那天起，Rust正式支持异步编程。</p><p>自此之后，Rust社区在做的事情，就是把已有Rust代码疯狂升级到async await，RSpotify虽迟，但也赶上了这波潮流。</p><p>当时RSpotify 请求Spotify的API使用的HTTP库是 <code>reqwest=，在 =reqwest</code> 支持异步模式之后，开发者 <a href=https://github.com/Rigellute>Alexander</a>就提了一个超大的<a href=https://github.com/ramsayleung/rspotify/pull/81>PR</a>，把所有已有的api全部修改成=async=, 我就乐见其成，就把这个PR合并了。</p><figure><a href=/ox-hugo/add_async_await_1.png><img loading=lazy src=/ox-hugo/add_async_await_1.png></a></figure><p>有社区的同学抱怨说异步模式的代码不好使用，他对性能没有什么要求，能否保留同步模式的接口调用。</p><p>后来为了兼顾同步模式和异步模式这两种调用方式，Alexander 又提了一个超大超大的<a href=https://github.com/ramsayleung/rspotify/pull/82/files>PR</a>，把现有的异步模式代码复制一份，然后把=async= 关键字去掉。</p><figure><a href=/ox-hugo/add_async_await_2.png><img loading=lazy src=/ox-hugo/add_async_await_2.png></a></figure><p>从此以后，RSpotify就需要同时维护两份几乎相同的代码，每次新增，修改，删除都需要确保同时变更两份代码。
着实痛苦不堪，但我也没有思考出更优解。</p><p>这时候，后来和我共同维护RSpotify 的开发者 <a href=https://github.com/ramsayleung/rspotify/pull/102>Mario</a> 出现了。</p><h3 id=maybe-async-阶段><span class=section-num>3.3</span> maybe_async 阶段<a hidden class=anchor aria-hidden=true href=#maybe-async-阶段>#</a></h3><p>当时RSpotify最大的问题在于有两份几乎一样，但是使用同步调用和异步调用模式的代码。</p><p>而异步调用的代码，返回参数都是一个 <code>Future&lt;T></code> ，将真正的响应结果封装在一个 <code>Future</code> 结构里面。</p><p>所以当时Mario 提出的第一个<a href=https://github.com/ramsayleung/rspotify/issues/112>解决思路</a>，是将对异步代码进行封装，使用同步调用的runtime调用异步函数，然后再把响应结果返回回去：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=c1>// 异步代码
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>original</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=nb>String</span><span class=p>,</span><span class=w> </span><span class=n>reqwest</span>::<span class=n>Error</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>reqwest</span>::<span class=n>get</span><span class=p>(</span><span class=s>&#34;https://www.rust-lang.org&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=k>await</span><span class=o>?</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>text</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=k>await</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=fm>lazy_static!</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Mutex to have mutable access and Arc so that it&#39;s thread-safe.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=k>static</span><span class=w> </span><span class=k>ref</span><span class=w> </span><span class=no>RT</span>: <span class=nc>Arc</span><span class=o>&lt;</span><span class=n>Mutex</span><span class=o>&lt;</span><span class=n>runtime</span>::<span class=n>Runtime</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Arc</span>::<span class=n>new</span><span class=p>(</span><span class=n>Mutex</span>::<span class=n>new</span><span class=p>(</span><span class=n>runtime</span>::<span class=n>Builder</span>::<span class=n>new</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                                                      </span><span class=p>.</span><span class=n>basic_scheduler</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                                                      </span><span class=p>.</span><span class=n>enable_all</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                                                      </span><span class=p>.</span><span class=n>build</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                                                      </span><span class=p>.</span><span class=n>unwrap</span><span class=p>()));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 同步版本代码
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>fn</span> <span class=nf>with_block_on</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=nb>String</span><span class=p>,</span><span class=w> </span><span class=n>reqwest</span>::<span class=n>Error</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=no>RT</span><span class=p>.</span><span class=n>lock</span><span class=p>().</span><span class=n>unwrap</span><span class=p>().</span><span class=n>block_on</span><span class=p>(</span><span class=k>async</span><span class=w> </span><span class=k>move</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>original</span><span class=p>().</span><span class=k>await</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>再通过Rust macro来为每个async 函数生成一个block_on 版本的函数。</p><p>但实际上，发现编写<a href=https://github.com/ramsayleung/rspotify/pull/120>macro太复杂</a>，并且这种方案不够灵活，实现起来也相当复杂。</p><p>然后Mario 又调研出一种<a href=https://github.com/ramsayleung/rspotify/pull/129>新方案</a>，通过 <a href=https://github.com/fMeow/maybe-async-rs><code>maybe_async</code></a> 这个库在同步和异步模式之间切换。
默认是异步模式，但可以通过 <code>features = ["is_sync"]</code> 编译选项来切换到同步模式，=maybe_async= 就会把所有的=async/await= 关键字给去掉。</p><p>这个方案简单，可读性高，易于扩展，也不需要维护复杂的 macro 代码。</p><p>这也是我们最终采取的方案，重构之后，把 <code>blocking</code> 目录的近万行复制粘贴而来的代码删除掉，就非常爽。</p><h3 id=二次重构-阶段><span class=section-num>3.4</span> 二次重构 阶段<a hidden class=anchor aria-hidden=true href=#二次重构-阶段>#</a></h3><p>前面提到，RSpotify最开始是直接翻译spotipy的代码。
因为Python是弱类型，而Rust是强类型，直接翻译，难免会有不少代码，写法没有纯正的Rust味道。</p><p>社区的Kestrer同学就在一个<a href=https://github.com/ramsayleung/rspotify/issues/127>issue</a>里面，给RSpotify提了近90条优化建议，指出了RSpotify中设计的各种问题，包括强类型运用不当，使用过多的原始类型，函数出入参设计不够优雅，授权流程设计不够易用等等。</p><figure><a href=/ox-hugo/meta-issue.png><img loading=lazy src=/ox-hugo/meta-issue.png></a></figure><p>这么多的优化建议，可以看出Kestrer真的花了很多时间来阅读和改善RSpotify的代码，盛情难却（可见原来的代码是+多烂+, 有非常多激发社区同学参与改进的空间）.</p><p>别人指出问题，就要好好优化。</p><p>所以我和Mario就分别对每个接口返回的数据模型，数据模型与Json间转换的序列化方式，授权流程作了改进。
并对RSpotify这个library作了拆分，按照功能，拆分成 <code>model</code>, <code>http</code>, <code>macros</code> 三个单独的library。</p><figure><a href=/ox-hugo/trait_hierarchy.png><img loading=lazy src=/ox-hugo/trait_hierarchy.png></a></figure><figure><a href=/ox-hugo/crate_hierarchy.png><img loading=lazy src=/ox-hugo/crate_hierarchy.png></a></figure><p>期间提了大概20多个PR，花了超过一年的时间，才处理完Kestrer 提的所有建议。</p><h3 id=pre-release-阶级><span class=section-num>3.5</span> pre-release 阶级<a hidden class=anchor aria-hidden=true href=#pre-release-阶级>#</a></h3><p>在开源社区里面，有一个约定俗成的规范：
当一个library 发布1.0 之后，就代表这个库已经处于稳定状态，不会再出现大量breaking change 的情况了。（py2, py3不在此约束内）</p><p>而经过4年的开发，RSpotify 已经步入一个相对稳定的开发状态，没有太多的breaking change 或重构了，开始为发布正式的1.0release 版本作准备。</p><p>当功能与架构相对稳定后，近一年时间，我和Mario就开始优化RSpotify的易用性，比如</p><ol><li>添加更多，针对不同场景的 <a href=https://github.com/ramsayleung/rspotify/tree/master/examples>examples</a>；</li><li>尽可能地去掉 <code>unsafe</code> 代码；</li><li>为返回列表的API提供同步及异步版本的<a href=https://github.com/ramsayleung/rspotify/pull/166>Iterator支持</a>;</li><li>保持向前兼容的情况下，尽量使已有接口更加Rust化；</li><li>添加更多的自动化检查，如检查代码中文档的链接是否404；</li><li>性能优化，减少不必要的内存分配</li></ol><p>目前版本已经去到了 <code>0.11.6</code>, 功能也相对稳定, 预计不久后就会正式发布1.0版本。</p><h2 id=感悟><span class=section-num>4</span> 感悟<a hidden class=anchor aria-hidden=true href=#感悟>#</a></h2><h3 id=开源协作><span class=section-num>4.1</span> 开源协作<a hidden class=anchor aria-hidden=true href=#开源协作>#</a></h3><p>截至到2023-02-09，RSpotify一共有1673次commit, 但我和Mario都只贡献了1/3的commit，剩下的commit都是社区的其他开发者提交的。</p><figure><a href=/ox-hugo/1673.png><img loading=lazy src=/ox-hugo/1673.png></a></figure><figure><a href=/ox-hugo/contributor.png><img loading=lazy src=/ox-hugo/contributor.png></a></figure><p>从RSpotify的演进历程也可以看出，我只是从0开发了最初版本的RSpotify，后面都是随着Rust的演进，有不同的开发者帮忙优化与迭代，我做的事情就从单纯的creator, developer 变成maintainer, reviewer，负责review其他开发者的PR。</p><p>可以说，如果没有其他开发者的贡献与协作，RSpotify不会演进成现在的样子。</p><p>如何吸引更多的开发者加入，让他们乐于为项目作贡献，我个人的见解是：</p><ol><li>所有文档，注释，commit message, issue, CHANGELOG等材料，都只使用英文。</li><li>标准的开源协作流程；<ul><li><a href=https://github.com/ramsayleung/rspotify/tree/master/.github/ISSUE_TEMPLATE>issue</a>, <a href=https://github.com/ramsayleung/rspotify/blob/master/.github/pull_request_template.md>PR</a>, <a href=https://github.com/ramsayleung/rspotify/blob/master/CHANGELOG.md>CHANGELOG</a> 都提供标准模板</li><li>要添加新特性，修改已有功能的时候，新建issue讨论动机与可行性</li><li>每个PR都需要一个Peer Reviewer review后才能合并</li><li>每次发新版本，都需要在 <a href=https://github.com/ramsayleung/rspotify/blob/master/CHANGELOG.md>CHANGELOG</a> 注明大的特性变更，以及breaking change</li></ul></li><li>文档，示例，开发指引，测试case完备，降低新开发者参与的成本。</li><li>be nice，态度友好，针对issue，PR都尽量回复，理性，友善讨论。</li></ol><p>开源协作的一个感受就是，在Github讨论问题的时候，可能突然有位大佬也加入群聊。</p><p>比如和<a href=https://github.com/ramsayleung/rspotify/issues/204>Mario讨论</a>, 增加更多更严格cargo clippy 的rule，以便让编译器帮我们发现更多潜在问题时，cargo clippy 的maintainer 也加入讨论，就什么rule 更合适，给出自己的建议。</p><h3 id=收获><span class=section-num>4.2</span> 收获<a hidden class=anchor aria-hidden=true href=#收获>#</a></h3><p>我用C++已经混了三年的饭吃了，但还只能看到C++的门槛，没法说入了C++的门。</p><p>同理，虽然距离我学习Rust已经过去6年了，我依然感觉我还不会Rust，都是编译器教我写代码。</p><p>在Review别人代码的过程中，我也学习到非常多「地道」和高级的Rust用法，项目维护的经验.</p><p>想到的点：</p><ol><li>使用Rust的macro来减少copy-paste的代码（但复杂的 macro，基本不具备可读性。）</li><li>使用 serde 自定义序列化函数；</li><li>以workspace 模式管理多个crates;</li><li>编写 async/await 的异步代码；</li><li>使用标准库的Trait, 风格契合标准库；</li><li>结合thiserror 和anyhow 处理异常；</li><li>通过自动化和模式化，减少项目维护的成本（能用机器做的，就不要用人做）。</li><li>规范的开发流程，包括commit message, issue, PR, CHANGELOG, release note 等等</li></ol><p>期间把收获与心得写了两篇文章：</p><ul><li><a href=https://ramsayleung.github.io/post/2020/serde_lesson/>The lesson learned from refactoring rspotify</a></li><li><a href=https://ramsayleung.github.io/post/2021/iterate_through_pagination_api/>Let&rsquo;s make everything iterable</a></li></ul><h3 id=关于开源><span class=section-num>4.3</span> 关于开源<a hidden class=anchor aria-hidden=true href=#关于开源>#</a></h3><p>维护这个项目5年之后，对于「开源」有了些不一样的理解。</p><p>在1970 年代，Richard Stallman发起自由软件运动，旨在推广用户有使用，复制，研究，修改和分发软件的社会运动。
自由软件运动人士认为自由软件的精神应该贯彻到所有软件。</p><p>在90年代，又兴起了开源软件运动，则计算机软件的源代码是可以公开，随意获取的。
（自由软件与开源软件不是同一个概念，自由软件定义更为严格）</p><p>在那个崇尚黑客精神的年代，开源是「目的」，是为了贯彻自由的精神。</p><p>以前听到某某公司内部有好用的工具，组件，框架时，总会问一句，为什么他们不像Google一样把它们开源出来。</p><p>现在的想法可能是，为什么要开源出来，价值和收益是什么？</p><p>开源一个项目的目的可能是：</p><ol><li>我做了个很有用，很有趣的东西，就想分享出来。但是我个人人力有限，大家一起来帮忙做大做好。(Linux, Ruby On Rails等)</li><li>我们做了个好东西，我们要抢占市场。我们就开源，搞人海战术，让竞品淹没在人民群众的汪洋大海中，让我们的东西成为事实的标准。（Android，Chromium, Kubernetes, Vscode）</li><li>就想开源让你们见识下大佬是怎么样子的。</li></ol><p>对于商业公司而言，如果没有收益，为什么要把花钱雇的人写的内部组件开源出来呢？总不成是为了在B站上博取小朋友的称赞吧。</p><p>而公司内部的组件，往往是与业务共生，高度适配的，藕断丝连，没有那么容易开源的。</p><p>商业公司，只谈收益与预期，如果名声能卖钱，估计也会拿来换取利润。</p><p>更重要的是，开源并不是简单把代码公开出来。</p><p>软件和生物一样，是有生命的，需要长期维护的，而不是一个commit把所有代码一把push 到Github就完事了，或者然后过了几年又push一把，更新几百个文件。</p><p>开源是一个技术与管理结合的决定，需要把开发模式都切换到开源社区，决策过程与动机要对社区可见。</p><p>不仅让人能从代码中读懂功能是「什么」，也要从动机讨论中知道「为什么」要这么改。</p><h3 id=些许成果><span class=section-num>4.4</span> 些许成果<a hidden class=anchor aria-hidden=true href=#些许成果>#</a></h3><p>在Github上，被1108个仓库及18个package 所依赖，而其中Alexander的 <a href=https://github.com/Rigellute/spotify-tui>spotify-tui</a> 就是我期望做的终端版本的Spotify。</p><p>开源的好处就是，在开发好基础设施之后，自然就会有其他有相同想法的同学，把应用开发出来。</p><figure><a href=/ox-hugo/dependent_packages.png><img loading=lazy src=/ox-hugo/dependent_packages.png></a></figure><p>crates.io 的统计，总计被下载23w次，当然包括很多CI的重复下载。</p><figure><a href=/ox-hugo/stats.png><img loading=lazy src=/ox-hugo/stats.png></a></figure><p>对于有Rust，Spotify，Library等诸多定语的RSpotify来说，目标受众本来就不多，能有现在这样的用户量也算是个挺不错的成果了。</p><h2 id=总结><span class=section-num>5</span> 总结<a hidden class=anchor aria-hidden=true href=#总结>#</a></h2><p>虽然我未曾从这个项目上获得到一分物质上的回报，但在创建这个项目的时候，我可能不会想到，我能维护它长达五年。</p><p>天上的云，飘来又飘走；开源的项目，挖坑又弃坑。</p><p>视线望不穿下一个五年，唯有且行且看。</p><h2 id=参考><span class=section-num>6</span> 参考<a hidden class=anchor aria-hidden=true href=#参考>#</a></h2><ul><li><a href=https://www.theverge.com/2023/1/31/23577499/spotify-q4-2022-earnings-release-subscriber-growth-layoffs>Spotify is first music streaming service to surpass 200M paid subscribers</a></li><li><a href=https://github.com/ramsayleung/rspotify>RSpotify</a></li></ul><div center class=qr-container><img src=/ox-hugo/qrcode_gh_e06d750e626f_1.jpg alt=qrcode_gh_e06d750e626f_1.jpg width=160px height=160px center=t class=qr-container>
公号同步更新，欢迎关注👻</div></div><footer class=post-footer><ul class=post-tags><li><a href=https://ramsayleung.github.io/zh/tags/rspotify/>rspotify</a></li><li><a href=https://ramsayleung.github.io/zh/tags/rust/>rust</a></li></ul><nav class=paginav><a class=prev href=https://ramsayleung.github.io/zh/post/2023/%E6%B3%84%E5%AF%86/><span class=title>« 上一页</span><br><span>泄密</span>
</a><a class=next href=https://ramsayleung.github.io/zh/post/2023/%E6%80%9D%E8%80%83_%E5%85%AC%E4%BC%97%E5%8F%B7%E8%83%8C%E5%90%8E%E7%9A%84%E4%BA%A7%E5%93%81%E9%80%BB%E8%BE%91/><span class=title>下一页 »</span><br><span>思考：公众号背后的产品逻辑</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share RSpotify: 一个用爱发电五年的开源项目 on x" href="https://x.com/intent/tweet/?text=RSpotify%3a%20%e4%b8%80%e4%b8%aa%e7%94%a8%e7%88%b1%e5%8f%91%e7%94%b5%e4%ba%94%e5%b9%b4%e7%9a%84%e5%bc%80%e6%ba%90%e9%a1%b9%e7%9b%ae&amp;url=https%3a%2f%2framsayleung.github.io%2fzh%2fpost%2f2023%2frspotify_%25E4%25B8%2580%25E4%25B8%25AA%25E7%2594%25A8%25E7%2588%25B1%25E5%258F%2591%25E7%2594%25B5%25E4%25BA%2594%25E5%25B9%25B4%25E7%259A%2584%25E5%25BC%2580%25E6%25BA%2590%25E9%25A1%25B9%25E7%259B%25AE%2f&amp;hashtags=rspotify%2crust"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share RSpotify: 一个用爱发电五年的开源项目 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2framsayleung.github.io%2fzh%2fpost%2f2023%2frspotify_%25E4%25B8%2580%25E4%25B8%25AA%25E7%2594%25A8%25E7%2588%25B1%25E5%258F%2591%25E7%2594%25B5%25E4%25BA%2594%25E5%25B9%25B4%25E7%259A%2584%25E5%25BC%2580%25E6%25BA%2590%25E9%25A1%25B9%25E7%259B%25AE%2f&amp;title=RSpotify%3a%20%e4%b8%80%e4%b8%aa%e7%94%a8%e7%88%b1%e5%8f%91%e7%94%b5%e4%ba%94%e5%b9%b4%e7%9a%84%e5%bc%80%e6%ba%90%e9%a1%b9%e7%9b%ae&amp;summary=RSpotify%3a%20%e4%b8%80%e4%b8%aa%e7%94%a8%e7%88%b1%e5%8f%91%e7%94%b5%e4%ba%94%e5%b9%b4%e7%9a%84%e5%bc%80%e6%ba%90%e9%a1%b9%e7%9b%ae&amp;source=https%3a%2f%2framsayleung.github.io%2fzh%2fpost%2f2023%2frspotify_%25E4%25B8%2580%25E4%25B8%25AA%25E7%2594%25A8%25E7%2588%25B1%25E5%258F%2591%25E7%2594%25B5%25E4%25BA%2594%25E5%25B9%25B4%25E7%259A%2584%25E5%25BC%2580%25E6%25BA%2590%25E9%25A1%25B9%25E7%259B%25AE%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share RSpotify: 一个用爱发电五年的开源项目 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2framsayleung.github.io%2fzh%2fpost%2f2023%2frspotify_%25E4%25B8%2580%25E4%25B8%25AA%25E7%2594%25A8%25E7%2588%25B1%25E5%258F%2591%25E7%2594%25B5%25E4%25BA%2594%25E5%25B9%25B4%25E7%259A%2584%25E5%25BC%2580%25E6%25BA%2590%25E9%25A1%25B9%25E7%259B%25AE%2f&title=RSpotify%3a%20%e4%b8%80%e4%b8%aa%e7%94%a8%e7%88%b1%e5%8f%91%e7%94%b5%e4%ba%94%e5%b9%b4%e7%9a%84%e5%bc%80%e6%ba%90%e9%a1%b9%e7%9b%ae"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share RSpotify: 一个用爱发电五年的开源项目 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2framsayleung.github.io%2fzh%2fpost%2f2023%2frspotify_%25E4%25B8%2580%25E4%25B8%25AA%25E7%2594%25A8%25E7%2588%25B1%25E5%258F%2591%25E7%2594%25B5%25E4%25BA%2594%25E5%25B9%25B4%25E7%259A%2584%25E5%25BC%2580%25E6%25BA%2590%25E9%25A1%25B9%25E7%259B%25AE%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share RSpotify: 一个用爱发电五年的开源项目 on whatsapp" href="https://api.whatsapp.com/send?text=RSpotify%3a%20%e4%b8%80%e4%b8%aa%e7%94%a8%e7%88%b1%e5%8f%91%e7%94%b5%e4%ba%94%e5%b9%b4%e7%9a%84%e5%bc%80%e6%ba%90%e9%a1%b9%e7%9b%ae%20-%20https%3a%2f%2framsayleung.github.io%2fzh%2fpost%2f2023%2frspotify_%25E4%25B8%2580%25E4%25B8%25AA%25E7%2594%25A8%25E7%2588%25B1%25E5%258F%2591%25E7%2594%25B5%25E4%25BA%2594%25E5%25B9%25B4%25E7%259A%2584%25E5%25BC%2580%25E6%25BA%2590%25E9%25A1%25B9%25E7%259B%25AE%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share RSpotify: 一个用爱发电五年的开源项目 on telegram" href="https://telegram.me/share/url?text=RSpotify%3a%20%e4%b8%80%e4%b8%aa%e7%94%a8%e7%88%b1%e5%8f%91%e7%94%b5%e4%ba%94%e5%b9%b4%e7%9a%84%e5%bc%80%e6%ba%90%e9%a1%b9%e7%9b%ae&amp;url=https%3a%2f%2framsayleung.github.io%2fzh%2fpost%2f2023%2frspotify_%25E4%25B8%2580%25E4%25B8%25AA%25E7%2594%25A8%25E7%2588%25B1%25E5%258F%2591%25E7%2594%25B5%25E4%25BA%2594%25E5%25B9%25B4%25E7%259A%2584%25E5%25BC%2580%25E6%25BA%2590%25E9%25A1%25B9%25E7%259B%25AE%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share RSpotify: 一个用爱发电五年的开源项目 on ycombinator" href="https://news.ycombinator.com/submitlink?t=RSpotify%3a%20%e4%b8%80%e4%b8%aa%e7%94%a8%e7%88%b1%e5%8f%91%e7%94%b5%e4%ba%94%e5%b9%b4%e7%9a%84%e5%bc%80%e6%ba%90%e9%a1%b9%e7%9b%ae&u=https%3a%2f%2framsayleung.github.io%2fzh%2fpost%2f2023%2frspotify_%25E4%25B8%2580%25E4%25B8%25AA%25E7%2594%25A8%25E7%2588%25B1%25E5%258F%2591%25E7%2594%25B5%25E4%25BA%2594%25E5%25B9%25B4%25E7%259A%2584%25E5%25BC%2580%25E6%25BA%2590%25E9%25A1%25B9%25E7%259B%25AE%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer><section><h2>Comments</h2><div id=comments-giscus></div></section><script type=text/javascript>function getCurrentTheme(){return document.documentElement.getAttribute("data-theme")||document.body.classList.contains("dark")?"dark":"light"}function setGiscusTheme(e=!1){const s=e?"dark":"light";var n,t=document.querySelector(".giscus-frame");t&&(n=new URL(t.src),n.searchParams.set("theme",s),t.src=n.toString())}function loadComment(e=!1){const n="zh"=="zh",t=document.getElementById("comments-giscus");if(t!==null&&!t.hasAttribute("data-giscus-loaded")){console.log("Initial giscus load");const s=document.createElement("script");s.setAttribute("src","https://giscus.app/client.js"),s.setAttribute("data-repo","ramsayleung/comment"),s.setAttribute("data-repo-id","MDEwOlJlcG9zaXRvcnkzMDk2NjQ1NDk="),s.setAttribute("data-category","General"),s.setAttribute("data-category-id","DIC_kwDOEnUbJc4Cltnz"),s.setAttribute("data-mapping","pathname"),s.setAttribute("data-strict","0"),s.setAttribute("data-reactions-enabled","1"),s.setAttribute("data-emit-metadata","0"),s.setAttribute("data-input-position","bottom"),s.setAttribute("data-theme",e?"dark":"light"),s.setAttribute("crossorigin","anonymous"),s.setAttribute("data-lang",n?"zh-CN":"en"),s.setAttribute("async","true"),t.appendChild(s),t.setAttribute("data-giscus-loaded","true")}}let currentTheme=getCurrentTheme();loadComment(currentTheme==="dark");const themeObserver=new MutationObserver(e=>{e.forEach(e=>{if(e.type==="attributes"&&e.attributeName==="class"){const e=getCurrentTheme();e!==currentTheme&&(currentTheme=e,setGiscusTheme(currentTheme==="dark"))}})});themeObserver.observe(document.body,{attributes:!0,attributeFilter:["class"]})</script></article></main><footer class=footer><span>See this site&rsquo;s source code <a href=https://github.com/ramsayleung/ramsayleung.github.io>here</a>, licensed under GPLv3 ·</span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script src=https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin=anonymous referrerpolicy=no-referrer></script><script>const images=Array.from(document.querySelectorAll(".post-content img"));images.forEach(e=>{mediumZoom(e,{margin:0,scrollOffset:40,container:null,template:null})})</script><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>