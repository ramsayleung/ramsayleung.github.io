<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>重新造轮子系列(一)：单元测试框架 | 过河卒</title>
<meta name=keywords content="reinvent"><meta name=description content="项目 GitHub 地址: Unit Test 1 前言 单元测试的重要性无须多言，它是保证项目质量的基石. 如果没有单元测试，根本没有信心说自己开发的功能是符合要求的，更没法在"><meta name=author content="Ramsay Leung"><link rel=canonical href=https://ramsayleung.github.io/zh/post/2025/reinvent_unit_test/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.a4a99a31823c5fb400c5486f9eeacbdb2fe3f0a60577136c53b4354303c674e8.css integrity="sha256-pKmaMYI8X7QAxUhvnurL2y/j8KYFdxNsU7Q1QwPGdOg=" rel="preload stylesheet" as=style><link rel=icon href=https://ramsayleung.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://ramsayleung.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://ramsayleung.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://ramsayleung.github.io/apple-touch-icon.png><link rel=mask-icon href=https://ramsayleung.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://ramsayleung.github.io/zh/post/2025/reinvent_unit_test/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-9MG65HQHEL"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-9MG65HQHEL",{anonymize_ip:!1})}</script><meta property="og:title" content="重新造轮子系列(一)：单元测试框架"><meta property="og:description" content="项目 GitHub 地址: Unit Test 1 前言 单元测试的重要性无须多言，它是保证项目质量的基石. 如果没有单元测试，根本没有信心说自己开发的功能是符合要求的，更没法在"><meta property="og:type" content="article"><meta property="og:url" content="https://ramsayleung.github.io/zh/post/2025/reinvent_unit_test/"><meta property="og:image" content="https://ramsayleung.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="post"><meta property="article:published_time" content="2025-02-16T22:27:00-08:00"><meta property="article:modified_time" content="2025-03-03T17:57:56-08:00"><meta property="og:site_name" content="Ramsay's Blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://ramsayleung.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="重新造轮子系列(一)：单元测试框架"><meta name=twitter:description content="项目 GitHub 地址: Unit Test 1 前言 单元测试的重要性无须多言，它是保证项目质量的基石. 如果没有单元测试，根本没有信心说自己开发的功能是符合要求的，更没法在"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://ramsayleung.github.io/zh/post/"},{"@type":"ListItem","position":2,"name":"重新造轮子系列(一)：单元测试框架","item":"https://ramsayleung.github.io/zh/post/2025/reinvent_unit_test/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"重新造轮子系列(一)：单元测试框架","name":"重新造轮子系列(一)：单元测试框架","description":"项目 GitHub 地址: Unit Test 1 前言 单元测试的重要性无须多言，它是保证项目质量的基石. 如果没有单元测试，根本没有信心说自己开发的功能是符合要求的，更没法在","keywords":["reinvent"],"articleBody":"项目 GitHub 地址: Unit Test\n1 前言 单元测试的重要性无须多言，它是保证项目质量的基石.\n如果没有单元测试，根本没有信心说自己开发的功能是符合要求的，更没法在没有测试的保证进行项目的重构。\n既然单元测试如此重要，今天就用Typescript来写一个简单但五脏俱全的单元测试框架。\n2 历史 Javascript 比较流行的测试框架是 Mocha 和 Jest , Java 具有统治地位的单元测试框架就是 JUnit, 现在做单元测试的框架, 一般称为 xUnit 家族, 而 xUnit 家族最早的成员, 不是 JUnit, 而是 SUnit(Smalltalk Unit), SUnit 的历史比 Junit 悠久得多, 大约在1994年的时候, Kent Beck, 也就是 Junit 的作者之一, 写了 SUnit, 而后才有了 JUnit (1998).\n所以, 在 SUnit 的网站上, 极其显摆的写着”一切单元测试框架之母” (The mother of all unit testing frameworks).\n事实上这是大实话 — 所有单元测试框架里面的名词术语, 都从 Sunit 来的, 如 TestCase, Fixture 等等.\n3 实现 3.1 需求 先定义需求, 一个单元测试框架应该可以做到下面的事:\n找到包含测试的文件 找到上述文件的测试 case 运行测试case 捕获测试运行结果，并输出所有的测试的运行总结 3.2 原型 一条 assert 语句就可以看作是最简单的测试 case, 对于测试case, 我们会有以下三种结果：\nPass: 运行成功, 测试结果与预期一致 Fail: 运行失败, 测试结果与预期不一致 Error: 运行测试过程中出现错误，我们不确定测试结果是否与预期一致 我们用以下的状态机来判断测试的结果:\n我们把要实现的单元测试框架命名为 Hope, 根据上面的状态机，我们很快就可以写出一个原型：\n单元测试用例接收一个函数作为参数，然后又集中运行所有的测试用例，并根据是否抛出异常以及异常的类型来判断结果:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 import assert from 'assert'; const HopeTests: [string, () =\u003e void][] = []; let HopePass = 0; let HopeFail = 0; let HopeError = 0; // Record a single test for running later. const hopeThat = (message: string, callback: () =\u003e void) =\u003e { HopeTests.push([message, callback]); } const main = () =\u003e { HopeTests.forEach(([message, test]) =\u003e { try { test(); HopePass += 1; } catch (e) { if (e instanceof assert.AssertionError) { HopeFail += 1; } else { HopeError += 1; } } }); console.log(`pass ${HopePass}`); console.log(`fail ${HopeFail}`); console.log(`error ${HopeError}`); } 让我们编写点代码来测试下我们的「单元测试框架」:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 // Something to test(doesn't handle zero properly) const sign = (value: number) =\u003e { if (value \u003c 0) { return -1; } else { return 1; } } // These two should pass hopeThat('Sign of negative is -1', () =\u003e assert(sign(-3) === -1)); hopeThat('Sign of positive is 1', () =\u003e assert(sign(10) === 1)); // This one should fail. hopeThat('Sign of zero is 0', () =\u003e assert(sign(0) === 0)); // This one is an error. hopeThat('Sign mispelled is erorr', () =\u003e assert(sign(sgn(1) === 1))); // Call the main driver main() 输出的结果是:\n1 2 3 4 -\u003e npx tsx dry_run.ts pass 2 fail 1 error 1 我们的第一版单元测试框架 Hope 能正常运行了，不过它有几个问题：\n它只是输出结果，但没有告诉我们是哪个单元测试成功了，哪个失败了，哪个报错，没法 debug 可变全局变量通常是有很大副作用的，我们应该把它封装起来 如果我们要测的函数里面，预期是要抛出 assert.AssertionError, 那么这个函数对应的测试用例就会被识别成失败的测试用例，也就是意味着我们不应该依赖 assert.AssertError 来作运行结果判断。 3.3 单例版本 我们可以将上面的测试代码地址封装在一个类里，然后通过单例设计模式(Singleton pattern)来确保只初始化出一个实例，这样就可以模拟出全局变量的效果，以此来解决前面的两个问题。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 import assert from \"assert\"; import caller from 'caller'; class Hope { private todo: [string, () =\u003e void][] = []; // 记录所有需要运行的测试case. private passes: string[] = []; private fails: string[] = []; private errors: string[] = []; constructor() { this.todo = []; this.passes = []; this.fails = []; this.errors = []; } test(comment: string, callback: () =\u003e void) { // 通过caller 获取单元测试用例对应的文件名 this.todo.push([`${caller()}::${comment}`, callback]); } run() { this.todo.forEach(([comment, test]) =\u003e { try { test(); this.passes.push(comment); } catch (e) { if (e instanceof assert.AssertionError) { this.fails.push(comment); } else { this.errors.push(comment); } } }) } } export default new Hope() 上面的代码又是如何实现单例模式的呢？依靠的是 Node 的两个运行机制:\n在加载一个 module 的时候, 它就会解释并执行 module 的代码，这意味着它会运行 new Hope() 并且导出新创建的实例 那么是否意味着，每个 import 语句都会运行一下 new Hope() 呢? 并不是，Node会缓存导入的 module ，也就是说无论一个 module 被导入多少次, 它也只会执行一次代码。 只要导入 hope.ts 之后, 就可以使用 hope.test() 会注册单元测试用例，以便后续执行:\n最后， 我们只需要再实现下输出测试结果的功能，既支持输出一行的简短结果，又可以支持详尽的输出. 如果需要的话，后续还可以支持输出JSON, CSV, 或者HTML 格式的结果:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 terse() { return this.cases() .map(([title, results]) =\u003e `${title}: ${results.length}`) .join(' '); } verbose() { let report = ''; let prefix = ''; for (const [title, results] of this.cases()) { report += `${prefix}${title}:`; prefix = '\\n'; for (const r of results) { report += `${prefix} ${r}` } } return report; } cases() { return [ ['passes', this.passes], ['fails', this.fails], ['errors', this.errors] ] } 万事具备，接下来就让我们写个函数验证下 Hope 框架:\n1 2 3 4 import assert from \"assert\"; import hope from \"./hope\"; hope.test('Sum of 1 and 2', () =\u003e assert((1 + 2) === 3)); 看起来挺不错，但是要怎么运行这个测试case 呢? 总不能每个测试文件都调用下 hope.run() 嘛? 人家 Jest 都可以自动扫描并运行测试用例。\n让我们参考 Jest, 实现一个 Runner, 也实现动态加载测试文件.\nimport 不仅可以用来导入其他的模块，它可以当作是一个 async 函数，加载指定路径的文件, 如:\n1 await import(module_path); 为了更好地控制我们的单元测试, 我们可以给 Hope 框架增加上一些命令行参数以控制其行为, CLI + Runner 的实现如下:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 import minimist from 'minimist'; import { glob } from 'glob'; import hope from './hope'; import { fileURLToPath } from 'url'; const parse = (args: string[]) =\u003e { const parsed = minimist(args) return { // Default root directory is current directory if not specified root: parsed.root || '.', // Output format can be 'terse' or 'verbose' (default) output: parsed.output || 'verbose', // Array of test filenames if explicitly provided filenames: parsed._ || [] } } const main = async (args: Array\u003cstring\u003e) =\u003e { const options = parse(args); if (options.filenames.length == 0) { options.filenames = await glob(`${options.root}/**/test*.{ts,js}`); } for (const f of options.filenames) { const absolutePath = fileURLToPath(new URL(f, import.meta.url)); await import(absolutePath); } hope.run() const result = (options.output === 'terse') ? hope.terse() : hope.verbose(); console.log(result); } main(process.argv.slice(2)) 我们默认会匹配所有以 test 为前缀的 ts 和 js 文件, 然后通过 import 导入, 因为 hope 是单例模式，所以所有的测试文件用的都是同一个实例, hope.run 就将注册的所有单元测试运行.\n整个框架的工作流程如下:\n大功告成，现在就来运行下我们的单元测试:\n1 2 3 4 5 \u003e npx tsx pray.ts passes: file:///private/tmp/reinvent/unit_test/test_add.ts::Sum of 1 and 2 fails: errors: 3.4 优化 3.4.1 增加运行时间 我们还可以记录每个测试用例的运行时间, 纳秒有点太小了，就精确到微秒即可:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 run() { this.todo.forEach(([comment, test]) =\u003e { try { const now = process.hrtime.bigint(); test(); const elapsedInMicro = (process.hrtime.bigint() - now) / (BigInt(1000)); this.passes.push(comment + `, execution time: ${elapsedInMicro}us`); } catch (e) { if (e instanceof assert.AssertionError) { this.fails.push(comment); } else { this.errors.push(comment); } } }) } 1 2 3 4 5 \u003e npx tsx pray.ts passes: file:///private/tmp/reinvent/unit_test/test_add.ts::Sum of 1 and 2, execution time: 5us fails: errors: 3.4.2 增加 assert 函数 内置的 assert 函数只支持比较输入值是否为 True, 现代的测试框架都有很多的 helper 函数来简化 assert 语句，就让我们来实现下 assertEqual, assertThrows, assertMapEqual, assertSetEqual, assertArraySame 这几个函数:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 /** * assert 抛出指定的异常 */ export function assertThrows\u003cT extends Error\u003e(expectedType: new (...args: any[]) =\u003e T, func: () =\u003e void) { try { // expected to throw exception func(); // unreachable assert(false, `Expected function to throw ${expectedType.name} but it did not throw`); } catch (error) { assert(error instanceof expectedType, `Expected function to throw ${expectedType.name} but it threw ${error instanceof Error ? error.constructor.name : typeof error}`); } } /** * assert 两个元素相等 */ export function assertEqual\u003cT\u003e(actual: T, expected: T, message: string) { assert(actual === expected, message); } /** * assert 两个 Set 相同 */ export function assertSetEqual\u003cT\u003e(actual: Set\u003cT\u003e, expected: Set\u003cT\u003e, message: string) { assert(actual.size == expected.size, message); for (const element of actual) { assert(expected.has(element), message); } } /** * assert 两个 Map 相同 */ export function assertMapEqual\u003cK extends string | number | symbol, V\u003e(actual: Record\u003cK, V\u003e, expected: Record\u003cK, V\u003e, message: string) { const actualKeys = Object.keys(actual) as K[]; const expectedKeys = Object.keys(expected) as K[]; assert(actualKeys.length === expectedKeys.length, message); for (const actualKey of actualKeys) { assert(expected[actualKey] \u0026\u0026 actual[actualKey] == expected[actualKey], message); } } /** * assert两个列举的值相等，如元素相等，但是顺序不同也被视为相同 */ export function assertArraySame\u003cT\u003e(actual: Array\u003cT\u003e, expected: Array\u003cT\u003e, message: string) { assert(actual.length === expected.length, message); assertSetEqual(new Set(actual), new Set(expected), message); } 针对上述函数的测试:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 import assert from \"assert\"; import hope, { assertArraySame, assertMapEqual, assertSetEqual, assertThrows } from \"./hope\"; hope.test('test assertSetEqual happy path', () =\u003e { const setA = new Set([1, 2, 3, 4, 5]); const setB = new Set([5, 1, 2, 4, 3]); assertSetEqual(setA, setB, 'Set supposed to be equal'); assertSetEqual(new Set([]), new Set([]), 'Empty Set'); }); hope.test('test assertMapEqual unhappy path', () =\u003e { assertThrows(assert.AssertionError, () =\u003e { const setA = new Set([1, 2, 3, 4, 5]); const setB = new Set([1, 2, 4, 3]); assertSetEqual(setA, setB, 'Set supposed to be equal'); }) }); hope.test('test assertMapEqual happy path', () =\u003e { const mapA = { 'a': 1, 'b': 2, }; const mapB = { 'b': 2, 'a': 1 }; assertMapEqual(mapA, mapB, 'Map supposed to be map'); }); hope.test('test assertMapEqual unhappy path', () =\u003e { const mapA = { 'a': 1, 'b': 3 }; const mapB = { 'b': 2, 'a': 1 }; assertThrows(assert.AssertionError, () =\u003e { assertMapEqual(mapA, mapB, 'Map supposed to be map'); }); }); hope.test('test assertArraySame happy path', () =\u003e { const arr1 = [1, 2, 3, 2]; const arr2 = [2, 1, 2, 3]; assertArraySame(arr1, arr2, \"Arrays should have same elements\"); // Passe }); hope.test('test assertArraySame unhappy path', () =\u003e { const arr1 = [1, 2, 3, 2]; const arr2 = [2, 1, 2, 4]; assertThrows(assert.AssertionError, () =\u003e { assertArraySame(arr1, arr2, \"Arrays should have same elements\"); // Passe }); }); 3.4.3 增加 -s/–select 参数指定测试文件 我们的 Runner 默认匹配的是以 test 为前缀的测试文件, 我们可以增加一个 -s/--select 参数，用来指定需要匹配的测试文件名：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 const parse = (args: string[]) =\u003e { const parsed = minimist(args) return { ... select: parsed.select || parsed.s // 增加select 参数 } } const main = async (args: Array\u003cstring\u003e) =\u003e { const options = parse(args); if (options.filenames.length == 0) { const namePattern = options.select ?? 'test*'; // 使用传入的模式 options.filenames = await glob(`${options.root}/**/${namePattern}.{ts,js}`); } ... } 运行结果:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 \u003e ls -al test* -rw-r--r--@ 1 ramsayleung wheel 115 17 Feb 10:01 test_add.ts -rw-r--r--@ 1 ramsayleung wheel 762 17 Feb 10:01 test_approx_equal.ts -rw-r--r--@ 1 ramsayleung wheel 1536 17 Feb 10:38 test_assert.ts -rw-r--r--@ 1 ramsayleung wheel 187 17 Feb 10:38 test_async.ts -rw-r--r--@ 1 ramsayleung wheel 275 17 Feb 10:38 test_setup_teardown.ts -rw-r--r--@ 1 ramsayleung wheel 140 17 Feb 10:38 test_tag.ts \u003e npx tsx pray.ts -s \"test_a*\" passes: file:///private/tmp/reinvent/unit_test/test_async.ts::delayed test, execution time: 412us file:///private/tmp/reinvent/unit_test/test_assert.ts::test assertSetEqual happy path, execution time: 31us file:///private/tmp/reinvent/unit_test/test_assert.ts::test assertMapEqual unhappy path, execution time: 1175us file:///private/tmp/reinvent/unit_test/test_assert.ts::test assertMapEqual happy path, execution time: 32us file:///private/tmp/reinvent/unit_test/test_assert.ts::test assertMapEqual unhappy path, execution time: 85us file:///private/tmp/reinvent/unit_test/test_assert.ts::test assertArraySame happy path, execution time: 17us file:///private/tmp/reinvent/unit_test/test_assert.ts::test assertArraySame unhappy path, execution time: 54us file:///private/tmp/reinvent/unit_test/test_approx_equal.ts::Default margin throws exception, execution time: 111us file:///private/tmp/reinvent/unit_test/test_approx_equal.ts::Large margin not throws exception, execution time: 6us file:///private/tmp/reinvent/unit_test/test_approx_equal.ts::Relative error throw exception, execution time: 51us file:///private/tmp/reinvent/unit_test/test_approx_equal.ts::Default Relative error not throw exception: , execution time: 5us file:///private/tmp/reinvent/unit_test/test_add.ts::Sum of 1 and 2, execution time: 4us fails: errors: 3.4.4 增加 -t/–tag 参数按标签运行测试case 对于 hope.test 函数，我们还可以提供一个额外的参数，用于给这个test case 打标签:\n1 2 3 hope.test('Difference of 1 and 2', () =\u003e assert((1 - 2) === -1), ['math', 'fast']) 然后通过 -t/--tag 按指定的tag来运行测试用例, 实现起来很容易:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 test(comment: string, callback: () =\u003e void, tags: Array\u003cstring\u003e = []) { this.todo.push([`${caller()}::${comment}`, callback, tags]); } run(tag: string = '') { this.todo .filter(([comment, test, tags]) =\u003e { if (tag.length === 0) { return true; } return tags.indexOf(tag) \u003e - 1; }) .forEach(([comment, test, tags]) =\u003e { // run the test, nothing change }) } 1 2 3 4 5 6 7 8 9 10 11 12 13 const parse = (args: string[]) =\u003e { const parsed = minimist(args) return { ... tag: parsed.tag || parsed.t } const main = async (args: Array\u003cstring\u003e) =\u003e { ... hope.run(options.tag); ... } test_tag.ts:\n1 2 3 import assert from \"assert\"; import hope from \"./hope\"; hope.test('Differene of 1 and 2', () =\u003e assert((1 - 2) === -1), ['math', 'fast']); 1 2 3 4 5 \u003e npx tsx pray.ts -t \"math\" passes: file:///private/tmp/reinvent/unit_test/test_tag.ts::Differene of 1 and 2, execution time: 5us fails: errors: 3.4.5 setup与teardown 正常的测试框架都是有 setup 与 teardown 函数的，可以指定在每个测试case 运行之前或之后的函数，比如运行测试case 前的数据准备，以为运行结束时的数据清理，我们的测试框架也可以支持这个功能：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 type CallbackType = () =\u003e void; class Hope { ... private setupFn: CallbackType | null = null; private teardownFn: CallbackType | null = null; setup(setupFn: CallbackType) { this.setupFn = setupFn; } teardown(teardownFn: CallbackType) { this.teardownFn = teardownFn; } run(tag: string = '') { this.todo .filter(([comment, test, tags]) =\u003e { if (tag.length === 0) { return true; } return tags.indexOf(tag) \u003e - 1; }) .forEach(([comment, test, tags]) =\u003e { try { if (this.setupFn) { this.setupFn(); } const now = microtime.now(); test(); const elapsedInMicro = microtime.now() - now; this.passes.push(comment + `, execution time: ${elapsedInMicro}us`); if (this.teardownFn) { this.teardownFn(); } } catch (e) { if (e instanceof assert.AssertionError) { this.fails.push(comment); } else { this.errors.push(comment); } } }) } } 针对上述函数的测试:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 import hope, { assertEqual } from \"./hope\"; let x = 0; const createFixtures = () =\u003e { x = 1; } hope.setup(createFixtures); hope.test('Validate x should be 1', () =\u003e { assertEqual(x, 1, 'X should be 1'); }); const cleanUp = () =\u003e { x = 0; } hope.teardown(cleanUp); 3.4.6 增加对 async 测试case 的支持 目前我们的test case 都只支持同步的函数, 我们可以增加上对 Promise 的支持, 这样我们可以使用以下的语法:\n1 hope.test('delayed test', async () =\u003e {...}) 实现方式也很直接: 一种就是判断传入函数的类型, 如果是同步函数则直接调用，如果是 async 函数, 那么就加上 await:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 type SyncCallbackType = () =\u003e void; type AsyncCallbackType = () =\u003e Promise\u003cvoid\u003e; type CallbackType = SyncCallbackType | AsyncCallbackType; class Hope { private todo: [string, CallbackType, Array\u003cstring\u003e][] = []; private setupFn: CallbackType | null = null; private teardownFn: CallbackType | null = null; setup(setupFn: CallbackType) { this.setupFn = setupFn; } teardown(teardownFn: CallbackType) { this.teardownFn = teardownFn; } test(comment: string, callback: () =\u003e void, tags: Array\u003cstring\u003e = []) { this.todo.push([`${caller()}::${comment}`, callback, tags]); } private async runTest(comment: string, test: CallbackType, tags: string[]) { try { if (this.setupFn) { if (this.isAsync(this.setupFn)) { await this.setupFn(); } else { this.setupFn(); } } const now = process.hrtime.bigint() if (this.isAsync(test)) { await test(); } else { test(); } const elapsedInMicro = (process.hrtime.bigint() - now) / (BigInt(1000)); this.passes.push(comment + `, execution time: ${elapsedInMicro}us`); if (this.teardownFn) { if (this.isAsync(this.teardownFn)) { await this.teardownFn(); } else { this.teardownFn(); } } } catch (e) { if (e instanceof assert.AssertionError) { this.fails.push(comment); } else { this.errors.push(comment); } } } async run(tag: string = '') { const tests = this.todo .filter(([comment, test, tags]) =\u003e { if (tag.length === 0) { return true; } return tags.indexOf(tag) \u003e - 1; }); for (const [comment, test, tags] of tests) { await this.runTest(comment, test, tags); } } private isAsync(fn: CallbackType): fn is AsyncCallbackType { return fn.constructor.name === 'AsyncFunction'; } } pray.ts:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 const main = async (args: Array\u003cstring\u003e) =\u003e { const options = parse(args); if (options.filenames.length == 0) { const namePattern = options.select ?? 'test*'; options.filenames = await glob(`${options.root}/**/${namePattern}.{ts,js}`); } for (const f of options.filenames) { const absolutePath = fileURLToPath(new URL(f, import.meta.url)); await import(absolutePath); } await hope.run(options.tag); // 增加上await const result = (options.output === 'terse') ? hope.terse() : hope.verbose(); console.log(result); }await hope.run(options.tag); 4 参考 回到本系列的目录\nhttps://third-bit.com/sdxjs/unit-test/ https://blog.youxu.info/2008/11/30/pearl-in-smalltal/ ","wordCount":"4363","inLanguage":"zh","image":"https://ramsayleung.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2025-02-16T22:27:00-08:00","dateModified":"2025-03-03T17:57:56-08:00","author":{"@type":"Person","name":"Ramsay Leung"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://ramsayleung.github.io/zh/post/2025/reinvent_unit_test/"},"publisher":{"@type":"Organization","name":"过河卒","logo":{"@type":"ImageObject","url":"https://ramsayleung.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://ramsayleung.github.io/zh/ accesskey=h title="Home (Alt + H)"><img src=https://ramsayleung.github.io/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://ramsayleung.github.io/en/ title=English aria-label=English>En</a></li></ul></div></div><ul id=menu><li class=dropdown><a href=https://ramsayleung.github.io/zh/categories/ title="系列 "><span>系列 ▾</span></a><div class="menu-more-content dropdown-content"><a href=https://ramsayleung.github.io/zh/categories/%E5%BE%97%E5%A4%B1%E6%84%9F%E6%82%9F/ title=得失感悟><span>得失感悟
</span></a><a href=https://ramsayleung.github.io/zh/categories/%E6%97%85%E5%8A%A0%E7%BB%8F%E5%8E%86 title=旅加经历><span>旅加经历
</span></a><a href=https://ramsayleung.github.io/zh/categories/%E5%B7%A5%E4%BD%9C%E6%B5%81/ title=我的工作流><span>我的工作流
</span></a><a href=https://ramsayleung.github.io/zh/categories/%E6%B5%8B%E8%AF%95%E6%8A%80%E8%83%BD%E8%BF%9B%E9%98%B6/ title=测试技能进阶><span>测试技能进阶
</span></a><a href=https://ramsayleung.github.io/zh/categories/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E7%A8%8B%E5%B8%88%E7%9A%84%E8%BD%AF%E6%8A%80%E8%83%BD%E6%8C%87%E5%8C%97/ title=软件工程师的软技能指北><span>软件工程师的软技能指北
</span></a><a href=https://ramsayleung.github.io/zh/categories/reinvent-%E9%87%8D%E6%96%B0%E9%80%A0%E8%BD%AE%E5%AD%90%E7%B3%BB%E5%88%97 title=Reinvent-重新造轮子系列><span>Reinvent-重新造轮子系列</span></a></div></li><li><a href=https://ramsayleung.github.io/zh/archives/ title=归档><span>归档</span></a></li><li><a href=https://ramsayleung.github.io/zh/search/ title=搜索><span>搜索</span></a></li><li><a href=https://ramsayleung.github.io/zh/tags/ title=标签><span>标签</span></a></li><li><a href=https://ramsayleung.github.io/zh/about_me_zh/ title=关于><span>关于</span></a></li><li><a href=https://ramsayleung.github.io/zh/index.xml title=RSS><span>RSS</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://ramsayleung.github.io/zh/>主页</a>&nbsp;»&nbsp;<a href=https://ramsayleung.github.io/zh/post/>Posts</a></div><h1 class="post-title entry-hint-parent">重新造轮子系列(一)：单元测试框架</h1><div class=post-meta><span title='2025-02-16 22:27:00 -0800 -0800'>二月 16, 2025</span>&nbsp;·&nbsp;9 分钟&nbsp;·&nbsp;4363 字&nbsp;·&nbsp;Ramsay Leung&nbsp;|&nbsp;<a href=https://github.com/ramsayleung/ramsayleung.github.io/blob/master/content/post/2025/reinvent_unit_test.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#前言><span class=section-num>1</span> 前言</a></li><li><a href=#历史><span class=section-num>2</span> 历史</a></li><li><a href=#实现><span class=section-num>3</span> 实现</a><ul><li><a href=#需求><span class=section-num>3.1</span> 需求</a></li><li><a href=#原型><span class=section-num>3.2</span> 原型</a></li><li><a href=#单例版本><span class=section-num>3.3</span> 单例版本</a></li><li><a href=#优化><span class=section-num>3.4</span> 优化</a></li></ul></li><li><a href=#参考><span class=section-num>4</span> 参考</a></li></ul></nav></div></details></div><div class=post-content><p>项目 GitHub 地址: <a href=https://github.com/ramsayleung/reinvent/tree/master/unit_test>Unit Test</a></p><h2 id=前言><span class=section-num>1</span> 前言<a hidden class=anchor aria-hidden=true href=#前言>#</a></h2><p>单元测试的重要性无须多言，它是保证项目质量的基石.</p><p>如果没有单元测试，根本没有信心说自己开发的功能是符合要求的，更没法在没有测试的保证进行项目的重构。</p><p>既然单元测试如此重要，今天就用Typescript来写一个简单但五脏俱全的单元测试框架。</p><h2 id=历史><span class=section-num>2</span> 历史<a hidden class=anchor aria-hidden=true href=#历史>#</a></h2><p>Javascript 比较流行的测试框架是 <a href=https://mochajs.org/>Mocha</a> 和 <a href=https://jestjs.io/>Jest</a> , Java 具有统治地位的单元测试框架就是 <a href=https://junit.org/junit5/>JUnit</a>, 现在做单元测试的框架, 一般称为 xUnit 家族, 而 xUnit 家族最早的成员, 不是 JUnit, 而是 SUnit(Smalltalk Unit), SUnit 的历史比 Junit 悠久得多, 大约在1994年的时候, <a href=https://en.wikipedia.org/wiki/Kent_Beck>Kent Beck</a>, 也就是 Junit 的作者之一, 写了 <a href=https://sunit.sourceforge.net/>SUnit</a>, 而后才有了 JUnit (1998).</p><p>所以, 在 <a href=https://sunit.sourceforge.net/>SUnit</a> 的网站上, 极其显摆的写着”一切单元测试框架之母” (The mother of all unit testing frameworks).</p><p>事实上这是大实话 — 所有单元测试框架里面的名词术语, 都从 Sunit 来的, 如 TestCase, Fixture 等等.</p><h2 id=实现><span class=section-num>3</span> 实现<a hidden class=anchor aria-hidden=true href=#实现>#</a></h2><h3 id=需求><span class=section-num>3.1</span> 需求<a hidden class=anchor aria-hidden=true href=#需求>#</a></h3><p>先定义需求, 一个单元测试框架应该可以做到下面的事:</p><ol><li>找到包含测试的文件</li><li>找到上述文件的测试 case</li><li>运行测试case</li><li>捕获测试运行结果，并输出所有的测试的运行总结</li></ol><h3 id=原型><span class=section-num>3.2</span> 原型<a hidden class=anchor aria-hidden=true href=#原型>#</a></h3><p>一条 <code>assert</code> 语句就可以看作是最简单的测试 case, 对于测试case, 我们会有以下三种结果：</p><ul><li>Pass: 运行成功, 测试结果与预期一致</li><li>Fail: 运行失败, 测试结果与预期不一致</li><li>Error: 运行测试过程中出现错误，我们不确定测试结果是否与预期一致</li></ul><p>我们用以下的状态机来判断测试的结果:</p><figure><input type=checkbox id=zoomCheck-44b21 hidden>
<label for=zoomCheck-44b21><img class=zoomCheck loading=lazy src=/ox-hugo/unit_test_result_state.png></label></figure><p>我们把要实现的单元测试框架命名为 <code>Hope</code>, 根据上面的状态机，我们很快就可以写出一个原型：</p><p>单元测试用例接收一个函数作为参数，然后又集中运行所有的测试用例，并根据是否抛出异常以及异常的类型来判断结果:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>import</span> <span class=nx>assert</span> <span class=nx>from</span> <span class=s1>&#39;assert&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>HopeTests</span><span class=o>:</span> <span class=p>[</span><span class=nx>string</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=k>void</span><span class=p>][]</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl><span class=kd>let</span> <span class=nx>HopePass</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kd>let</span> <span class=nx>HopeFail</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kd>let</span> <span class=nx>HopeError</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Record a single test for running later.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>hopeThat</span> <span class=o>=</span> <span class=p>(</span><span class=nx>message</span><span class=o>:</span> <span class=nx>string</span><span class=p>,</span> <span class=nx>callback</span><span class=o>:</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=k>void</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>HopeTests</span><span class=p>.</span><span class=nx>push</span><span class=p>([</span><span class=nx>message</span><span class=p>,</span> <span class=nx>callback</span><span class=p>]);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>main</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>HopeTests</span><span class=p>.</span><span class=nx>forEach</span><span class=p>(([</span><span class=nx>message</span><span class=p>,</span> <span class=nx>test</span><span class=p>])</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>test</span><span class=p>();</span>
</span></span><span class=line><span class=cl>            <span class=nx>HopePass</span> <span class=o>+=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>e</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nx>e</span> <span class=k>instanceof</span> <span class=nx>assert</span><span class=p>.</span><span class=nx>AssertionError</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>HopeFail</span> <span class=o>+=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>HopeError</span> <span class=o>+=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=sb>`pass </span><span class=si>${</span><span class=nx>HopePass</span><span class=si>}</span><span class=sb>`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=sb>`fail </span><span class=si>${</span><span class=nx>HopeFail</span><span class=si>}</span><span class=sb>`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=sb>`error </span><span class=si>${</span><span class=nx>HopeError</span><span class=si>}</span><span class=sb>`</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>让我们编写点代码来测试下我们的「单元测试框架」:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=c1>// Something to test(doesn&#39;t handle zero properly)
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>sign</span> <span class=o>=</span> <span class=p>(</span><span class=nx>value</span><span class=o>:</span> <span class=nx>number</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>value</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// These two should pass
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>hopeThat</span><span class=p>(</span><span class=s1>&#39;Sign of negative is -1&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=nx>assert</span><span class=p>(</span><span class=nx>sign</span><span class=p>(</span><span class=o>-</span><span class=mi>3</span><span class=p>)</span> <span class=o>===</span> <span class=o>-</span><span class=mi>1</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=nx>hopeThat</span><span class=p>(</span><span class=s1>&#39;Sign of positive is 1&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=nx>assert</span><span class=p>(</span><span class=nx>sign</span><span class=p>(</span><span class=mi>10</span><span class=p>)</span> <span class=o>===</span> <span class=mi>1</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// This one should fail.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>hopeThat</span><span class=p>(</span><span class=s1>&#39;Sign of zero is 0&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=nx>assert</span><span class=p>(</span><span class=nx>sign</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=o>===</span> <span class=mi>0</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// This one is an error.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>hopeThat</span><span class=p>(</span><span class=s1>&#39;Sign mispelled is erorr&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=nx>assert</span><span class=p>(</span><span class=nx>sign</span><span class=p>(</span><span class=nx>sgn</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=o>===</span> <span class=mi>1</span><span class=p>)));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Call the main driver
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>main</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>输出的结果是:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>-&gt; npx tsx dry_run.ts
</span></span><span class=line><span class=cl>pass <span class=m>2</span>
</span></span><span class=line><span class=cl>fail <span class=m>1</span>
</span></span><span class=line><span class=cl>error <span class=m>1</span>
</span></span></code></pre></td></tr></table></div></div><p>我们的第一版单元测试框架 <code>Hope</code> 能正常运行了，不过它有几个问题：</p><ol><li>它只是输出结果，但没有告诉我们是哪个单元测试成功了，哪个失败了，哪个报错，没法 debug</li><li>可变全局变量通常是有很大副作用的，我们应该把它封装起来</li><li>如果我们要测的函数里面，预期是要抛出 <code>assert.AssertionError</code>, 那么这个函数对应的测试用例就会被识别成失败的测试用例，也就是意味着我们不应该依赖 <code>assert.AssertError</code> 来作运行结果判断。</li></ol><h3 id=单例版本><span class=section-num>3.3</span> 单例版本<a hidden class=anchor aria-hidden=true href=#单例版本>#</a></h3><p>我们可以将上面的测试代码地址封装在一个类里，然后通过单例设计模式(<a href=https://refactoring.guru/design-patterns/singleton>Singleton pattern</a>)来确保只初始化出一个实例，这样就可以模拟出全局变量的效果，以此来解决前面的两个问题。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>import</span> <span class=nx>assert</span> <span class=nx>from</span> <span class=s2>&#34;assert&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>caller</span> <span class=nx>from</span> <span class=s1>&#39;caller&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>class</span> <span class=nx>Hope</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=nx>todo</span><span class=o>:</span> <span class=p>[</span><span class=nx>string</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=k>void</span><span class=p>][]</span> <span class=o>=</span> <span class=p>[];</span> <span class=c1>// 记录所有需要运行的测试case.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>private</span> <span class=nx>passes</span><span class=o>:</span> <span class=nx>string</span><span class=p>[]</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=nx>fails</span><span class=o>:</span> <span class=nx>string</span><span class=p>[]</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=nx>errors</span><span class=o>:</span> <span class=nx>string</span><span class=p>[]</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>  <span class=nx>constructor</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>todo</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>passes</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>fails</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>errors</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>test</span><span class=p>(</span><span class=nx>comment</span><span class=o>:</span> <span class=nx>string</span><span class=p>,</span> <span class=nx>callback</span><span class=o>:</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=k>void</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 通过caller 获取单元测试用例对应的文件名
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>this</span><span class=p>.</span><span class=nx>todo</span><span class=p>.</span><span class=nx>push</span><span class=p>([</span><span class=sb>`</span><span class=si>${</span><span class=nx>caller</span><span class=p>()</span><span class=si>}</span><span class=sb>::</span><span class=si>${</span><span class=nx>comment</span><span class=si>}</span><span class=sb>`</span><span class=p>,</span> <span class=nx>callback</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>run</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>todo</span><span class=p>.</span><span class=nx>forEach</span><span class=p>(([</span><span class=nx>comment</span><span class=p>,</span> <span class=nx>test</span><span class=p>])</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>test</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>passes</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>comment</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>e</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>e</span> <span class=k>instanceof</span> <span class=nx>assert</span><span class=p>.</span><span class=nx>AssertionError</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>this</span><span class=p>.</span><span class=nx>fails</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>comment</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>this</span><span class=p>.</span><span class=nx>errors</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>comment</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=k>new</span> <span class=nx>Hope</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>上面的代码又是如何实现单例模式的呢？依靠的是 Node 的两个运行机制:</p><ol><li>在加载一个 <code>module</code> 的时候, 它就会解释并执行 <code>module</code> 的代码，这意味着它会运行 <code>new Hope()</code> 并且导出新创建的实例</li><li>那么是否意味着，每个 <code>import</code> 语句都会运行一下 <code>new Hope()</code> 呢? 并不是，Node会缓存导入的 <code>module</code> ，也就是说无论一个 <code>module</code> 被导入多少次, 它也只会执行一次代码。</li></ol><p>只要导入 <code>hope.ts</code> 之后, 就可以使用 <code>hope.test()</code> 会注册单元测试用例，以便后续执行:</p><figure><input type=checkbox id=zoomCheck-5712b hidden>
<label for=zoomCheck-5712b><img class=zoomCheck loading=lazy src=/ox-hugo/unit_test_hope_structure.svg></label></figure><p>最后， 我们只需要再实现下输出测试结果的功能，既支持输出一行的简短结果，又可以支持详尽的输出. 如果需要的话，后续还可以支持输出JSON, CSV, 或者HTML 格式的结果:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=nx>terse</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>cases</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nx>map</span><span class=p>(([</span><span class=nx>title</span><span class=p>,</span> <span class=nx>results</span><span class=p>])</span> <span class=p>=&gt;</span> <span class=sb>`</span><span class=si>${</span><span class=nx>title</span><span class=si>}</span><span class=sb>: </span><span class=si>${</span><span class=nx>results</span><span class=p>.</span><span class=nx>length</span><span class=si>}</span><span class=sb>`</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nx>join</span><span class=p>(</span><span class=s1>&#39; &#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>verbose</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>report</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>prefix</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=kr>const</span> <span class=p>[</span><span class=nx>title</span><span class=p>,</span> <span class=nx>results</span><span class=p>]</span> <span class=k>of</span> <span class=k>this</span><span class=p>.</span><span class=nx>cases</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>report</span> <span class=o>+=</span> <span class=sb>`</span><span class=si>${</span><span class=nx>prefix</span><span class=si>}${</span><span class=nx>title</span><span class=si>}</span><span class=sb>:`</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>prefix</span> <span class=o>=</span> <span class=s1>&#39;\n&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kr>const</span> <span class=nx>r</span> <span class=k>of</span> <span class=nx>results</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>report</span> <span class=o>+=</span> <span class=sb>`</span><span class=si>${</span><span class=nx>prefix</span><span class=si>}</span><span class=sb> </span><span class=si>${</span><span class=nx>r</span><span class=si>}</span><span class=sb>`</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>report</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>cases</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=s1>&#39;passes&#39;</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=nx>passes</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=s1>&#39;fails&#39;</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=nx>fails</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=s1>&#39;errors&#39;</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=nx>errors</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>万事具备，接下来就让我们写个函数验证下 <code>Hope</code> 框架:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>import</span> <span class=nx>assert</span> <span class=nx>from</span> <span class=s2>&#34;assert&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>hope</span> <span class=nx>from</span> <span class=s2>&#34;./hope&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>hope</span><span class=p>.</span><span class=nx>test</span><span class=p>(</span><span class=s1>&#39;Sum of 1 and 2&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=nx>assert</span><span class=p>((</span><span class=mi>1</span> <span class=o>+</span> <span class=mi>2</span><span class=p>)</span> <span class=o>===</span> <span class=mi>3</span><span class=p>));</span>
</span></span></code></pre></td></tr></table></div></div><p>看起来挺不错，但是要怎么运行这个测试case 呢? 总不能每个测试文件都调用下 <code>hope.run()</code> 嘛? 人家 <code>Jest</code> 都可以自动扫描并运行测试用例。</p><p>让我们参考 Jest, 实现一个 <code>Runner</code>, 也实现动态加载测试文件.</p><p><code>import</code> 不仅可以用来导入其他的模块，它可以当作是一个 async 函数，加载指定路径的文件, 如:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>await</span> <span class=kr>import</span><span class=p>(</span><span class=nx>module_path</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>为了更好地控制我们的单元测试, 我们可以给 <code>Hope</code> 框架增加上一些命令行参数以控制其行为, CLI + Runner 的实现如下:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>import</span> <span class=nx>minimist</span> <span class=nx>from</span> <span class=s1>&#39;minimist&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>glob</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;glob&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>hope</span> <span class=nx>from</span> <span class=s1>&#39;./hope&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>fileURLToPath</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;url&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>parse</span> <span class=o>=</span> <span class=p>(</span><span class=nx>args</span><span class=o>:</span> <span class=nx>string</span><span class=p>[])</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>parsed</span> <span class=o>=</span> <span class=nx>minimist</span><span class=p>(</span><span class=nx>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Default root directory is current directory if not specified
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>root</span><span class=o>:</span> <span class=nx>parsed</span><span class=p>.</span><span class=nx>root</span> <span class=o>||</span> <span class=s1>&#39;.&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Output format can be &#39;terse&#39; or &#39;verbose&#39; (default)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>output</span><span class=o>:</span> <span class=nx>parsed</span><span class=p>.</span><span class=nx>output</span> <span class=o>||</span> <span class=s1>&#39;verbose&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Array of test filenames if explicitly provided
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>filenames</span><span class=o>:</span> <span class=nx>parsed</span><span class=p>.</span><span class=nx>_</span> <span class=o>||</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>main</span> <span class=o>=</span> <span class=kr>async</span> <span class=p>(</span><span class=nx>args</span><span class=o>:</span> <span class=nb>Array</span><span class=o>&lt;</span><span class=nx>string</span><span class=o>&gt;</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>options</span> <span class=o>=</span> <span class=nx>parse</span><span class=p>(</span><span class=nx>args</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>filenames</span><span class=p>.</span><span class=nx>length</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>options</span><span class=p>.</span><span class=nx>filenames</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>glob</span><span class=p>(</span><span class=sb>`</span><span class=si>${</span><span class=nx>options</span><span class=p>.</span><span class=nx>root</span><span class=si>}</span><span class=sb>/**/test*.{ts,js}`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=kr>const</span> <span class=nx>f</span> <span class=k>of</span> <span class=nx>options</span><span class=p>.</span><span class=nx>filenames</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>absolutePath</span> <span class=o>=</span> <span class=nx>fileURLToPath</span><span class=p>(</span><span class=k>new</span> <span class=nx>URL</span><span class=p>(</span><span class=nx>f</span><span class=p>,</span> <span class=kr>import</span><span class=p>.</span><span class=nx>meta</span><span class=p>.</span><span class=nx>url</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=kr>await</span> <span class=kr>import</span><span class=p>(</span><span class=nx>absolutePath</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>hope</span><span class=p>.</span><span class=nx>run</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>result</span> <span class=o>=</span> <span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>output</span> <span class=o>===</span> <span class=s1>&#39;terse&#39;</span><span class=p>)</span> <span class=o>?</span> <span class=nx>hope</span><span class=p>.</span><span class=nx>terse</span><span class=p>()</span> <span class=o>:</span> <span class=nx>hope</span><span class=p>.</span><span class=nx>verbose</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>result</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>main</span><span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>argv</span><span class=p>.</span><span class=nx>slice</span><span class=p>(</span><span class=mi>2</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><p>我们默认会匹配所有以 <code>test</code> 为前缀的 ts 和 js 文件, 然后通过 <code>import</code> 导入, 因为 <code>hope</code> 是单例模式，所以所有的测试文件用的都是同一个实例, <code>hope.run</code> 就将注册的所有单元测试运行.</p><p>整个框架的工作流程如下:</p><figure><input type=checkbox id=zoomCheck-d335a hidden>
<label for=zoomCheck-d335a><img class=zoomCheck loading=lazy src=/ox-hugo/unit_test_workflow.png></label></figure><p>大功告成，现在就来运行下我们的单元测试:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>&gt; npx tsx pray.ts
</span></span><span class=line><span class=cl>passes:
</span></span><span class=line><span class=cl> file:///private/tmp/reinvent/unit_test/test_add.ts::Sum of <span class=m>1</span> and <span class=m>2</span>
</span></span><span class=line><span class=cl>fails:
</span></span><span class=line><span class=cl>errors:
</span></span></code></pre></td></tr></table></div></div><h3 id=优化><span class=section-num>3.4</span> 优化<a hidden class=anchor aria-hidden=true href=#优化>#</a></h3><h4 id=增加运行时间><span class=section-num>3.4.1</span> 增加运行时间<a hidden class=anchor aria-hidden=true href=#增加运行时间>#</a></h4><p>我们还可以记录每个测试用例的运行时间, 纳秒有点太小了，就精确到微秒即可:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>run</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>this</span><span class=p>.</span><span class=nx>todo</span><span class=p>.</span><span class=nx>forEach</span><span class=p>(([</span><span class=nx>comment</span><span class=p>,</span> <span class=nx>test</span><span class=p>])</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>now</span> <span class=o>=</span> <span class=nx>process</span><span class=p>.</span><span class=nx>hrtime</span><span class=p>.</span><span class=nx>bigint</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=nx>test</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>elapsedInMicro</span> <span class=o>=</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>hrtime</span><span class=p>.</span><span class=nx>bigint</span><span class=p>()</span> <span class=o>-</span> <span class=nx>now</span><span class=p>)</span> <span class=o>/</span> <span class=p>(</span><span class=nx>BigInt</span><span class=p>(</span><span class=mi>1000</span><span class=p>));</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>passes</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>comment</span> <span class=o>+</span> <span class=sb>`, execution time: </span><span class=si>${</span><span class=nx>elapsedInMicro</span><span class=si>}</span><span class=sb>us`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>e</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>e</span> <span class=k>instanceof</span> <span class=nx>assert</span><span class=p>.</span><span class=nx>AssertionError</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>fails</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>comment</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>errors</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>comment</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>&gt; npx tsx pray.ts
</span></span><span class=line><span class=cl>passes:
</span></span><span class=line><span class=cl> file:///private/tmp/reinvent/unit_test/test_add.ts::Sum of <span class=m>1</span> and 2, execution time: 5us
</span></span><span class=line><span class=cl>fails:
</span></span><span class=line><span class=cl>errors:
</span></span></code></pre></td></tr></table></div></div><h4 id=增加-assert-函数><span class=section-num>3.4.2</span> 增加 assert 函数<a hidden class=anchor aria-hidden=true href=#增加-assert-函数>#</a></h4><p>内置的 <code>assert</code> 函数只支持比较输入值是否为 True, 现代的测试框架都有很多的 <code>helper</code> 函数来简化 <code>assert</code> 语句，就让我们来实现下 <code>assertEqual</code>, <code>assertThrows</code>, <code>assertMapEqual</code>, <code>assertSetEqual</code>, <code>assertArraySame</code> 这几个函数:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * assert 抛出指定的异常
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>assertThrows</span><span class=o>&lt;</span><span class=nx>T</span> <span class=kr>extends</span> <span class=nb>Error</span><span class=o>&gt;</span><span class=p>(</span><span class=nx>expectedType</span><span class=o>:</span> <span class=k>new</span> <span class=p>(...</span><span class=nx>args</span><span class=o>:</span> <span class=nx>any</span><span class=p>[])</span> <span class=p>=&gt;</span> <span class=nx>T</span><span class=p>,</span> <span class=nx>func</span><span class=o>:</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=k>void</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// expected to throw exception
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>func</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=c1>// unreachable
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>assert</span><span class=p>(</span><span class=kc>false</span><span class=p>,</span> <span class=sb>`Expected function to throw </span><span class=si>${</span><span class=nx>expectedType</span><span class=p>.</span><span class=nx>name</span><span class=si>}</span><span class=sb> but it did not throw`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>assert</span><span class=p>(</span><span class=nx>error</span> <span class=k>instanceof</span> <span class=nx>expectedType</span><span class=p>,</span> <span class=sb>`Expected function to throw </span><span class=si>${</span><span class=nx>expectedType</span><span class=p>.</span><span class=nx>name</span><span class=si>}</span><span class=sb> but it threw </span><span class=si>${</span><span class=nx>error</span> <span class=k>instanceof</span> <span class=nb>Error</span> <span class=o>?</span> <span class=nx>error</span><span class=p>.</span><span class=nx>constructor</span><span class=p>.</span><span class=nx>name</span> <span class=o>:</span> <span class=k>typeof</span> <span class=nx>error</span><span class=si>}</span><span class=sb>`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * assert 两个元素相等
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>assertEqual</span><span class=o>&lt;</span><span class=nx>T</span><span class=o>&gt;</span><span class=p>(</span><span class=nx>actual</span><span class=o>:</span> <span class=nx>T</span><span class=p>,</span> <span class=nx>expected</span><span class=o>:</span> <span class=nx>T</span><span class=p>,</span> <span class=nx>message</span><span class=o>:</span> <span class=nx>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>assert</span><span class=p>(</span><span class=nx>actual</span> <span class=o>===</span> <span class=nx>expected</span><span class=p>,</span> <span class=nx>message</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * assert 两个 Set 相同
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>assertSetEqual</span><span class=o>&lt;</span><span class=nx>T</span><span class=o>&gt;</span><span class=p>(</span><span class=nx>actual</span><span class=o>:</span> <span class=nx>Set</span><span class=o>&lt;</span><span class=nx>T</span><span class=o>&gt;</span><span class=p>,</span> <span class=nx>expected</span><span class=o>:</span> <span class=nx>Set</span><span class=o>&lt;</span><span class=nx>T</span><span class=o>&gt;</span><span class=p>,</span> <span class=nx>message</span><span class=o>:</span> <span class=nx>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>assert</span><span class=p>(</span><span class=nx>actual</span><span class=p>.</span><span class=nx>size</span> <span class=o>==</span> <span class=nx>expected</span><span class=p>.</span><span class=nx>size</span><span class=p>,</span> <span class=nx>message</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kr>const</span> <span class=nx>element</span> <span class=k>of</span> <span class=nx>actual</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>assert</span><span class=p>(</span><span class=nx>expected</span><span class=p>.</span><span class=nx>has</span><span class=p>(</span><span class=nx>element</span><span class=p>),</span> <span class=nx>message</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * assert 两个 Map 相同
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>assertMapEqual</span><span class=o>&lt;</span><span class=nx>K</span> <span class=kr>extends</span> <span class=nx>string</span> <span class=o>|</span> <span class=nx>number</span> <span class=o>|</span> <span class=nx>symbol</span><span class=p>,</span> <span class=nx>V</span><span class=o>&gt;</span><span class=p>(</span><span class=nx>actual</span><span class=o>:</span> <span class=nx>Record</span><span class=o>&lt;</span><span class=nx>K</span><span class=p>,</span> <span class=nx>V</span><span class=o>&gt;</span><span class=p>,</span> <span class=nx>expected</span><span class=o>:</span> <span class=nx>Record</span><span class=o>&lt;</span><span class=nx>K</span><span class=p>,</span> <span class=nx>V</span><span class=o>&gt;</span><span class=p>,</span> <span class=nx>message</span><span class=o>:</span> <span class=nx>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>actualKeys</span> <span class=o>=</span> <span class=nb>Object</span><span class=p>.</span><span class=nx>keys</span><span class=p>(</span><span class=nx>actual</span><span class=p>)</span> <span class=nx>as</span> <span class=nx>K</span><span class=p>[];</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>expectedKeys</span> <span class=o>=</span> <span class=nb>Object</span><span class=p>.</span><span class=nx>keys</span><span class=p>(</span><span class=nx>expected</span><span class=p>)</span> <span class=nx>as</span> <span class=nx>K</span><span class=p>[];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>assert</span><span class=p>(</span><span class=nx>actualKeys</span><span class=p>.</span><span class=nx>length</span> <span class=o>===</span> <span class=nx>expectedKeys</span><span class=p>.</span><span class=nx>length</span><span class=p>,</span> <span class=nx>message</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kr>const</span> <span class=nx>actualKey</span> <span class=k>of</span> <span class=nx>actualKeys</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>assert</span><span class=p>(</span><span class=nx>expected</span><span class=p>[</span><span class=nx>actualKey</span><span class=p>]</span> <span class=o>&amp;&amp;</span> <span class=nx>actual</span><span class=p>[</span><span class=nx>actualKey</span><span class=p>]</span> <span class=o>==</span> <span class=nx>expected</span><span class=p>[</span><span class=nx>actualKey</span><span class=p>],</span> <span class=nx>message</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * assert两个列举的值相等，如元素相等，但是顺序不同也被视为相同
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>assertArraySame</span><span class=o>&lt;</span><span class=nx>T</span><span class=o>&gt;</span><span class=p>(</span><span class=nx>actual</span><span class=o>:</span> <span class=nb>Array</span><span class=o>&lt;</span><span class=nx>T</span><span class=o>&gt;</span><span class=p>,</span> <span class=nx>expected</span><span class=o>:</span> <span class=nb>Array</span><span class=o>&lt;</span><span class=nx>T</span><span class=o>&gt;</span><span class=p>,</span> <span class=nx>message</span><span class=o>:</span> <span class=nx>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>assert</span><span class=p>(</span><span class=nx>actual</span><span class=p>.</span><span class=nx>length</span> <span class=o>===</span> <span class=nx>expected</span><span class=p>.</span><span class=nx>length</span><span class=p>,</span> <span class=nx>message</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>assertSetEqual</span><span class=p>(</span><span class=k>new</span> <span class=nx>Set</span><span class=p>(</span><span class=nx>actual</span><span class=p>),</span> <span class=k>new</span> <span class=nx>Set</span><span class=p>(</span><span class=nx>expected</span><span class=p>),</span> <span class=nx>message</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>针对上述函数的测试:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>import</span> <span class=nx>assert</span> <span class=nx>from</span> <span class=s2>&#34;assert&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>hope</span><span class=p>,</span> <span class=p>{</span> <span class=nx>assertArraySame</span><span class=p>,</span> <span class=nx>assertMapEqual</span><span class=p>,</span> <span class=nx>assertSetEqual</span><span class=p>,</span> <span class=nx>assertThrows</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;./hope&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>hope</span><span class=p>.</span><span class=nx>test</span><span class=p>(</span><span class=s1>&#39;test assertSetEqual happy path&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>setA</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Set</span><span class=p>([</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>5</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>setB</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Set</span><span class=p>([</span><span class=mi>5</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>3</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>  <span class=nx>assertSetEqual</span><span class=p>(</span><span class=nx>setA</span><span class=p>,</span> <span class=nx>setB</span><span class=p>,</span> <span class=s1>&#39;Set supposed to be equal&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>assertSetEqual</span><span class=p>(</span><span class=k>new</span> <span class=nx>Set</span><span class=p>([]),</span> <span class=k>new</span> <span class=nx>Set</span><span class=p>([]),</span> <span class=s1>&#39;Empty Set&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>hope</span><span class=p>.</span><span class=nx>test</span><span class=p>(</span><span class=s1>&#39;test assertMapEqual unhappy path&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>assertThrows</span><span class=p>(</span><span class=nx>assert</span><span class=p>.</span><span class=nx>AssertionError</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>setA</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Set</span><span class=p>([</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>5</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>setB</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Set</span><span class=p>([</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>3</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=nx>assertSetEqual</span><span class=p>(</span><span class=nx>setA</span><span class=p>,</span> <span class=nx>setB</span><span class=p>,</span> <span class=s1>&#39;Set supposed to be equal&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>hope</span><span class=p>.</span><span class=nx>test</span><span class=p>(</span><span class=s1>&#39;test assertMapEqual happy path&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>mapA</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;a&#39;</span><span class=o>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;b&#39;</span><span class=o>:</span> <span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>mapB</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;b&#39;</span><span class=o>:</span> <span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;a&#39;</span><span class=o>:</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=nx>assertMapEqual</span><span class=p>(</span><span class=nx>mapA</span><span class=p>,</span> <span class=nx>mapB</span><span class=p>,</span> <span class=s1>&#39;Map supposed to be map&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>hope</span><span class=p>.</span><span class=nx>test</span><span class=p>(</span><span class=s1>&#39;test assertMapEqual unhappy path&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>mapA</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;a&#39;</span><span class=o>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;b&#39;</span><span class=o>:</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>mapB</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;b&#39;</span><span class=o>:</span> <span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;a&#39;</span><span class=o>:</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=nx>assertThrows</span><span class=p>(</span><span class=nx>assert</span><span class=p>.</span><span class=nx>AssertionError</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>assertMapEqual</span><span class=p>(</span><span class=nx>mapA</span><span class=p>,</span> <span class=nx>mapB</span><span class=p>,</span> <span class=s1>&#39;Map supposed to be map&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>hope</span><span class=p>.</span><span class=nx>test</span><span class=p>(</span><span class=s1>&#39;test assertArraySame happy path&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>arr1</span> <span class=o>=</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>2</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>arr2</span> <span class=o>=</span> <span class=p>[</span><span class=mi>2</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=nx>assertArraySame</span><span class=p>(</span><span class=nx>arr1</span><span class=p>,</span> <span class=nx>arr2</span><span class=p>,</span> <span class=s2>&#34;Arrays should have same elements&#34;</span><span class=p>);</span> <span class=c1>// Passe
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>hope</span><span class=p>.</span><span class=nx>test</span><span class=p>(</span><span class=s1>&#39;test assertArraySame unhappy path&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>arr1</span> <span class=o>=</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>2</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>arr2</span> <span class=o>=</span> <span class=p>[</span><span class=mi>2</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>4</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>assertThrows</span><span class=p>(</span><span class=nx>assert</span><span class=p>.</span><span class=nx>AssertionError</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>assertArraySame</span><span class=p>(</span><span class=nx>arr1</span><span class=p>,</span> <span class=nx>arr2</span><span class=p>,</span> <span class=s2>&#34;Arrays should have same elements&#34;</span><span class=p>);</span> <span class=c1>// Passe
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=增加-s-select-参数指定测试文件><span class=section-num>3.4.3</span> 增加 -s/&ndash;select 参数指定测试文件<a hidden class=anchor aria-hidden=true href=#增加-s-select-参数指定测试文件>#</a></h4><p>我们的 <code>Runner</code> 默认匹配的是以 <code>test</code> 为前缀的测试文件, 我们可以增加一个 <code>-s/--select</code> 参数，用来指定需要匹配的测试文件名：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>parse</span> <span class=o>=</span> <span class=p>(</span><span class=nx>args</span><span class=o>:</span> <span class=nx>string</span><span class=p>[])</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>parsed</span> <span class=o>=</span> <span class=nx>minimist</span><span class=p>(</span><span class=nx>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl>    <span class=nx>select</span><span class=o>:</span> <span class=nx>parsed</span><span class=p>.</span><span class=nx>select</span> <span class=o>||</span> <span class=nx>parsed</span><span class=p>.</span><span class=nx>s</span> <span class=c1>// 增加select 参数
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>main</span> <span class=o>=</span> <span class=kr>async</span> <span class=p>(</span><span class=nx>args</span><span class=o>:</span> <span class=nb>Array</span><span class=o>&lt;</span><span class=nx>string</span><span class=o>&gt;</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>options</span> <span class=o>=</span> <span class=nx>parse</span><span class=p>(</span><span class=nx>args</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>filenames</span><span class=p>.</span><span class=nx>length</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>namePattern</span> <span class=o>=</span> <span class=nx>options</span><span class=p>.</span><span class=nx>select</span> <span class=o>??</span> <span class=s1>&#39;test*&#39;</span><span class=p>;</span> <span class=c1>// 使用传入的模式
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>options</span><span class=p>.</span><span class=nx>filenames</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>glob</span><span class=p>(</span><span class=sb>`</span><span class=si>${</span><span class=nx>options</span><span class=p>.</span><span class=nx>root</span><span class=si>}</span><span class=sb>/**/</span><span class=si>${</span><span class=nx>namePattern</span><span class=si>}</span><span class=sb>.{ts,js}`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>运行结果:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>&gt; ls -al test*
</span></span><span class=line><span class=cl>-rw-r--r--@ <span class=m>1</span> ramsayleung  wheel   <span class=m>115</span> <span class=m>17</span> Feb 10:01 test_add.ts
</span></span><span class=line><span class=cl>-rw-r--r--@ <span class=m>1</span> ramsayleung  wheel   <span class=m>762</span> <span class=m>17</span> Feb 10:01 test_approx_equal.ts
</span></span><span class=line><span class=cl>-rw-r--r--@ <span class=m>1</span> ramsayleung  wheel  <span class=m>1536</span> <span class=m>17</span> Feb 10:38 test_assert.ts
</span></span><span class=line><span class=cl>-rw-r--r--@ <span class=m>1</span> ramsayleung  wheel   <span class=m>187</span> <span class=m>17</span> Feb 10:38 test_async.ts
</span></span><span class=line><span class=cl>-rw-r--r--@ <span class=m>1</span> ramsayleung  wheel   <span class=m>275</span> <span class=m>17</span> Feb 10:38 test_setup_teardown.ts
</span></span><span class=line><span class=cl>-rw-r--r--@ <span class=m>1</span> ramsayleung  wheel   <span class=m>140</span> <span class=m>17</span> Feb 10:38 test_tag.ts
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&gt; npx tsx pray.ts -s <span class=s2>&#34;test_a*&#34;</span>
</span></span><span class=line><span class=cl>passes:
</span></span><span class=line><span class=cl> file:///private/tmp/reinvent/unit_test/test_async.ts::delayed test, execution time: 412us
</span></span><span class=line><span class=cl> file:///private/tmp/reinvent/unit_test/test_assert.ts::test assertSetEqual happy path, execution time: 31us
</span></span><span class=line><span class=cl> file:///private/tmp/reinvent/unit_test/test_assert.ts::test assertMapEqual unhappy path, execution time: 1175us
</span></span><span class=line><span class=cl> file:///private/tmp/reinvent/unit_test/test_assert.ts::test assertMapEqual happy path, execution time: 32us
</span></span><span class=line><span class=cl> file:///private/tmp/reinvent/unit_test/test_assert.ts::test assertMapEqual unhappy path, execution time: 85us
</span></span><span class=line><span class=cl> file:///private/tmp/reinvent/unit_test/test_assert.ts::test assertArraySame happy path, execution time: 17us
</span></span><span class=line><span class=cl> file:///private/tmp/reinvent/unit_test/test_assert.ts::test assertArraySame unhappy path, execution time: 54us
</span></span><span class=line><span class=cl> file:///private/tmp/reinvent/unit_test/test_approx_equal.ts::Default margin throws exception, execution time: 111us
</span></span><span class=line><span class=cl> file:///private/tmp/reinvent/unit_test/test_approx_equal.ts::Large margin not throws exception, execution time: 6us
</span></span><span class=line><span class=cl> file:///private/tmp/reinvent/unit_test/test_approx_equal.ts::Relative error throw exception, execution time: 51us
</span></span><span class=line><span class=cl> file:///private/tmp/reinvent/unit_test/test_approx_equal.ts::Default Relative error not throw exception: , execution time: 5us
</span></span><span class=line><span class=cl> file:///private/tmp/reinvent/unit_test/test_add.ts::Sum of <span class=m>1</span> and 2, execution time: 4us
</span></span><span class=line><span class=cl>fails:
</span></span><span class=line><span class=cl>errors:
</span></span></code></pre></td></tr></table></div></div><h4 id=增加-t-tag-参数按标签运行测试case><span class=section-num>3.4.4</span> 增加 -t/&ndash;tag 参数按标签运行测试case<a hidden class=anchor aria-hidden=true href=#增加-t-tag-参数按标签运行测试case>#</a></h4><p>对于 <code>hope.test</code> 函数，我们还可以提供一个额外的参数，用于给这个test case 打标签:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>hope</span><span class=p>.</span><span class=nx>test</span><span class=p>(</span><span class=s1>&#39;Difference of 1 and 2&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=p>()</span> <span class=p>=&gt;</span> <span class=nx>assert</span><span class=p>((</span><span class=mi>1</span> <span class=o>-</span> <span class=mi>2</span><span class=p>)</span> <span class=o>===</span> <span class=o>-</span><span class=mi>1</span><span class=p>),</span>
</span></span><span class=line><span class=cl>          <span class=p>[</span><span class=s1>&#39;math&#39;</span><span class=p>,</span> <span class=s1>&#39;fast&#39;</span><span class=p>])</span>
</span></span></code></pre></td></tr></table></div></div><p>然后通过 <code>-t/--tag</code> 按指定的tag来运行测试用例, 实现起来很容易:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>test</span><span class=p>(</span><span class=nx>comment</span><span class=o>:</span> <span class=nx>string</span><span class=p>,</span> <span class=nx>callback</span><span class=o>:</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=k>void</span><span class=p>,</span> <span class=nx>tags</span><span class=o>:</span> <span class=nb>Array</span><span class=o>&lt;</span><span class=nx>string</span><span class=o>&gt;</span> <span class=o>=</span> <span class=p>[])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>todo</span><span class=p>.</span><span class=nx>push</span><span class=p>([</span><span class=sb>`</span><span class=si>${</span><span class=nx>caller</span><span class=p>()</span><span class=si>}</span><span class=sb>::</span><span class=si>${</span><span class=nx>comment</span><span class=si>}</span><span class=sb>`</span><span class=p>,</span> <span class=nx>callback</span><span class=p>,</span> <span class=nx>tags</span><span class=p>]);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>run</span><span class=p>(</span><span class=nx>tag</span><span class=o>:</span> <span class=nx>string</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>todo</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=nx>filter</span><span class=p>(([</span><span class=nx>comment</span><span class=p>,</span> <span class=nx>test</span><span class=p>,</span> <span class=nx>tags</span><span class=p>])</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nx>tag</span><span class=p>.</span><span class=nx>length</span> <span class=o>===</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span> <span class=k>return</span> <span class=kc>true</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=nx>tags</span><span class=p>.</span><span class=nx>indexOf</span><span class=p>(</span><span class=nx>tag</span><span class=p>)</span> <span class=o>&gt;</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=nx>forEach</span><span class=p>(([</span><span class=nx>comment</span><span class=p>,</span> <span class=nx>test</span><span class=p>,</span> <span class=nx>tags</span><span class=p>])</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// run the test, nothing change
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>parse</span> <span class=o>=</span> <span class=p>(</span><span class=nx>args</span><span class=o>:</span> <span class=nx>string</span><span class=p>[])</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>parsed</span> <span class=o>=</span> <span class=nx>minimist</span><span class=p>(</span><span class=nx>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=p>...</span>
</span></span><span class=line><span class=cl>            <span class=nx>tag</span><span class=o>:</span> <span class=nx>parsed</span><span class=p>.</span><span class=nx>tag</span> <span class=o>||</span> <span class=nx>parsed</span><span class=p>.</span><span class=nx>t</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>main</span> <span class=o>=</span> <span class=kr>async</span> <span class=p>(</span><span class=nx>args</span><span class=o>:</span> <span class=nb>Array</span><span class=o>&lt;</span><span class=nx>string</span><span class=o>&gt;</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=p>...</span>
</span></span><span class=line><span class=cl>            <span class=nx>hope</span><span class=p>.</span><span class=nx>run</span><span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>tag</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>...</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>test_tag.ts</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>import</span> <span class=nx>assert</span> <span class=nx>from</span> <span class=s2>&#34;assert&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>hope</span> <span class=nx>from</span> <span class=s2>&#34;./hope&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nx>hope</span><span class=p>.</span><span class=nx>test</span><span class=p>(</span><span class=s1>&#39;Differene of 1 and 2&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=nx>assert</span><span class=p>((</span><span class=mi>1</span> <span class=o>-</span> <span class=mi>2</span><span class=p>)</span> <span class=o>===</span> <span class=o>-</span><span class=mi>1</span><span class=p>),</span> <span class=p>[</span><span class=s1>&#39;math&#39;</span><span class=p>,</span> <span class=s1>&#39;fast&#39;</span><span class=p>]);</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>&gt; npx tsx pray.ts -t <span class=s2>&#34;math&#34;</span>
</span></span><span class=line><span class=cl>passes:
</span></span><span class=line><span class=cl> file:///private/tmp/reinvent/unit_test/test_tag.ts::Differene of <span class=m>1</span> and 2, execution time: 5us
</span></span><span class=line><span class=cl>fails:
</span></span><span class=line><span class=cl>errors:
</span></span></code></pre></td></tr></table></div></div><h4 id=setup与teardown><span class=section-num>3.4.5</span> setup与teardown<a hidden class=anchor aria-hidden=true href=#setup与teardown>#</a></h4><p>正常的测试框架都是有 <code>setup</code> 与 <code>teardown</code> 函数的，可以指定在每个测试case 运行之前或之后的函数，比如运行测试case 前的数据准备，以为运行结束时的数据清理，我们的测试框架也可以支持这个功能：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>type</span> <span class=nx>CallbackType</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=k>void</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>class</span> <span class=nx>Hope</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=nx>setupFn</span><span class=o>:</span> <span class=nx>CallbackType</span> <span class=o>|</span> <span class=kc>null</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=nx>teardownFn</span><span class=o>:</span> <span class=nx>CallbackType</span> <span class=o>|</span> <span class=kc>null</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>setup</span><span class=p>(</span><span class=nx>setupFn</span><span class=o>:</span> <span class=nx>CallbackType</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>setupFn</span> <span class=o>=</span> <span class=nx>setupFn</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>teardown</span><span class=p>(</span><span class=nx>teardownFn</span><span class=o>:</span> <span class=nx>CallbackType</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>teardownFn</span> <span class=o>=</span> <span class=nx>teardownFn</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>run</span><span class=p>(</span><span class=nx>tag</span><span class=o>:</span> <span class=nx>string</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>todo</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>filter</span><span class=p>(([</span><span class=nx>comment</span><span class=p>,</span> <span class=nx>test</span><span class=p>,</span> <span class=nx>tags</span><span class=p>])</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>tag</span><span class=p>.</span><span class=nx>length</span> <span class=o>===</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span> <span class=k>return</span> <span class=kc>true</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>tags</span><span class=p>.</span><span class=nx>indexOf</span><span class=p>(</span><span class=nx>tag</span><span class=p>)</span> <span class=o>&gt;</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>})</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>forEach</span><span class=p>(([</span><span class=nx>comment</span><span class=p>,</span> <span class=nx>test</span><span class=p>,</span> <span class=nx>tags</span><span class=p>])</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>setupFn</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>this</span><span class=p>.</span><span class=nx>setupFn</span><span class=p>();</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>          <span class=kr>const</span> <span class=nx>now</span> <span class=o>=</span> <span class=nx>microtime</span><span class=p>.</span><span class=nx>now</span><span class=p>();</span>
</span></span><span class=line><span class=cl>          <span class=nx>test</span><span class=p>();</span>
</span></span><span class=line><span class=cl>          <span class=kr>const</span> <span class=nx>elapsedInMicro</span> <span class=o>=</span> <span class=nx>microtime</span><span class=p>.</span><span class=nx>now</span><span class=p>()</span> <span class=o>-</span> <span class=nx>now</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=k>this</span><span class=p>.</span><span class=nx>passes</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>comment</span> <span class=o>+</span> <span class=sb>`, execution time: </span><span class=si>${</span><span class=nx>elapsedInMicro</span><span class=si>}</span><span class=sb>us`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>teardownFn</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>this</span><span class=p>.</span><span class=nx>teardownFn</span><span class=p>();</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>e</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=nx>e</span> <span class=k>instanceof</span> <span class=nx>assert</span><span class=p>.</span><span class=nx>AssertionError</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>this</span><span class=p>.</span><span class=nx>fails</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>comment</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>this</span><span class=p>.</span><span class=nx>errors</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>comment</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>针对上述函数的测试:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>import</span> <span class=nx>hope</span><span class=p>,</span> <span class=p>{</span> <span class=nx>assertEqual</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;./hope&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>let</span> <span class=nx>x</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>createFixtures</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>x</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>hope</span><span class=p>.</span><span class=nx>setup</span><span class=p>(</span><span class=nx>createFixtures</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>hope</span><span class=p>.</span><span class=nx>test</span><span class=p>(</span><span class=s1>&#39;Validate x should be 1&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>assertEqual</span><span class=p>(</span><span class=nx>x</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=s1>&#39;X should be 1&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>cleanUp</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>x</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>hope</span><span class=p>.</span><span class=nx>teardown</span><span class=p>(</span><span class=nx>cleanUp</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=增加对-async-测试case-的支持><span class=section-num>3.4.6</span> 增加对 async 测试case 的支持<a hidden class=anchor aria-hidden=true href=#增加对-async-测试case-的支持>#</a></h4><p>目前我们的test case 都只支持同步的函数, 我们可以增加上对 <code>Promise</code> 的支持, 这样我们可以使用以下的语法:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>hope</span><span class=p>.</span><span class=nx>test</span><span class=p>(</span><span class=s1>&#39;delayed test&#39;</span><span class=p>,</span> <span class=kr>async</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{...})</span>
</span></span></code></pre></td></tr></table></div></div><p>实现方式也很直接: 一种就是判断传入函数的类型, 如果是同步函数则直接调用，如果是 async 函数, 那么就加上 <code>await</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>type</span> <span class=nx>SyncCallbackType</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=k>void</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nx>type</span> <span class=nx>AsyncCallbackType</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=nb>Promise</span><span class=o>&lt;</span><span class=k>void</span><span class=o>&gt;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nx>type</span> <span class=nx>CallbackType</span> <span class=o>=</span> <span class=nx>SyncCallbackType</span> <span class=o>|</span> <span class=nx>AsyncCallbackType</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>class</span> <span class=nx>Hope</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>private</span> <span class=nx>todo</span><span class=o>:</span> <span class=p>[</span><span class=nx>string</span><span class=p>,</span> <span class=nx>CallbackType</span><span class=p>,</span> <span class=nb>Array</span><span class=o>&lt;</span><span class=nx>string</span><span class=o>&gt;</span><span class=p>][]</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>    <span class=kr>private</span> <span class=nx>setupFn</span><span class=o>:</span> <span class=nx>CallbackType</span> <span class=o>|</span> <span class=kc>null</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kr>private</span> <span class=nx>teardownFn</span><span class=o>:</span> <span class=nx>CallbackType</span> <span class=o>|</span> <span class=kc>null</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>setup</span><span class=p>(</span><span class=nx>setupFn</span><span class=o>:</span> <span class=nx>CallbackType</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>setupFn</span> <span class=o>=</span> <span class=nx>setupFn</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>teardown</span><span class=p>(</span><span class=nx>teardownFn</span><span class=o>:</span> <span class=nx>CallbackType</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>teardownFn</span> <span class=o>=</span> <span class=nx>teardownFn</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>test</span><span class=p>(</span><span class=nx>comment</span><span class=o>:</span> <span class=nx>string</span><span class=p>,</span> <span class=nx>callback</span><span class=o>:</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=k>void</span><span class=p>,</span> <span class=nx>tags</span><span class=o>:</span> <span class=nb>Array</span><span class=o>&lt;</span><span class=nx>string</span><span class=o>&gt;</span> <span class=o>=</span> <span class=p>[])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>todo</span><span class=p>.</span><span class=nx>push</span><span class=p>([</span><span class=sb>`</span><span class=si>${</span><span class=nx>caller</span><span class=p>()</span><span class=si>}</span><span class=sb>::</span><span class=si>${</span><span class=nx>comment</span><span class=si>}</span><span class=sb>`</span><span class=p>,</span> <span class=nx>callback</span><span class=p>,</span> <span class=nx>tags</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kr>private</span> <span class=kr>async</span> <span class=nx>runTest</span><span class=p>(</span><span class=nx>comment</span><span class=o>:</span> <span class=nx>string</span><span class=p>,</span> <span class=nx>test</span><span class=o>:</span> <span class=nx>CallbackType</span><span class=p>,</span> <span class=nx>tags</span><span class=o>:</span> <span class=nx>string</span><span class=p>[])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>setupFn</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>isAsync</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>setupFn</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=kr>await</span> <span class=k>this</span><span class=p>.</span><span class=nx>setupFn</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>this</span><span class=p>.</span><span class=nx>setupFn</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=kr>const</span> <span class=nx>now</span> <span class=o>=</span> <span class=nx>process</span><span class=p>.</span><span class=nx>hrtime</span><span class=p>.</span><span class=nx>bigint</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>isAsync</span><span class=p>(</span><span class=nx>test</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=kr>await</span> <span class=nx>test</span><span class=p>();</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>test</span><span class=p>();</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=kr>const</span> <span class=nx>elapsedInMicro</span> <span class=o>=</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>hrtime</span><span class=p>.</span><span class=nx>bigint</span><span class=p>()</span> <span class=o>-</span> <span class=nx>now</span><span class=p>)</span> <span class=o>/</span> <span class=p>(</span><span class=nx>BigInt</span><span class=p>(</span><span class=mi>1000</span><span class=p>));</span>
</span></span><span class=line><span class=cl>            <span class=k>this</span><span class=p>.</span><span class=nx>passes</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>comment</span> <span class=o>+</span> <span class=sb>`, execution time: </span><span class=si>${</span><span class=nx>elapsedInMicro</span><span class=si>}</span><span class=sb>us`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>teardownFn</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>isAsync</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>teardownFn</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=kr>await</span> <span class=k>this</span><span class=p>.</span><span class=nx>teardownFn</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>this</span><span class=p>.</span><span class=nx>teardownFn</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>e</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nx>e</span> <span class=k>instanceof</span> <span class=nx>assert</span><span class=p>.</span><span class=nx>AssertionError</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>this</span><span class=p>.</span><span class=nx>fails</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>comment</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>this</span><span class=p>.</span><span class=nx>errors</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>comment</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kr>async</span> <span class=nx>run</span><span class=p>(</span><span class=nx>tag</span><span class=o>:</span> <span class=nx>string</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>tests</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>todo</span>
</span></span><span class=line><span class=cl>              <span class=p>.</span><span class=nx>filter</span><span class=p>(([</span><span class=nx>comment</span><span class=p>,</span> <span class=nx>test</span><span class=p>,</span> <span class=nx>tags</span><span class=p>])</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                  <span class=k>if</span> <span class=p>(</span><span class=nx>tag</span><span class=p>.</span><span class=nx>length</span> <span class=o>===</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span> <span class=k>return</span> <span class=kc>true</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>                  <span class=k>return</span> <span class=nx>tags</span><span class=p>.</span><span class=nx>indexOf</span><span class=p>(</span><span class=nx>tag</span><span class=p>)</span> <span class=o>&gt;</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>              <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kr>const</span> <span class=p>[</span><span class=nx>comment</span><span class=p>,</span> <span class=nx>test</span><span class=p>,</span> <span class=nx>tags</span><span class=p>]</span> <span class=k>of</span> <span class=nx>tests</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kr>await</span> <span class=k>this</span><span class=p>.</span><span class=nx>runTest</span><span class=p>(</span><span class=nx>comment</span><span class=p>,</span> <span class=nx>test</span><span class=p>,</span> <span class=nx>tags</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kr>private</span> <span class=nx>isAsync</span><span class=p>(</span><span class=nx>fn</span><span class=o>:</span> <span class=nx>CallbackType</span><span class=p>)</span><span class=o>:</span> <span class=nx>fn</span> <span class=nx>is</span> <span class=nx>AsyncCallbackType</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>fn</span><span class=p>.</span><span class=nx>constructor</span><span class=p>.</span><span class=nx>name</span> <span class=o>===</span> <span class=s1>&#39;AsyncFunction&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>pray.ts</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>main</span> <span class=o>=</span> <span class=kr>async</span> <span class=p>(</span><span class=nx>args</span><span class=o>:</span> <span class=nb>Array</span><span class=o>&lt;</span><span class=nx>string</span><span class=o>&gt;</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>options</span> <span class=o>=</span> <span class=nx>parse</span><span class=p>(</span><span class=nx>args</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>filenames</span><span class=p>.</span><span class=nx>length</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>namePattern</span> <span class=o>=</span> <span class=nx>options</span><span class=p>.</span><span class=nx>select</span> <span class=o>??</span> <span class=s1>&#39;test*&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>options</span><span class=p>.</span><span class=nx>filenames</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>glob</span><span class=p>(</span><span class=sb>`</span><span class=si>${</span><span class=nx>options</span><span class=p>.</span><span class=nx>root</span><span class=si>}</span><span class=sb>/**/</span><span class=si>${</span><span class=nx>namePattern</span><span class=si>}</span><span class=sb>.{ts,js}`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=kr>const</span> <span class=nx>f</span> <span class=k>of</span> <span class=nx>options</span><span class=p>.</span><span class=nx>filenames</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>absolutePath</span> <span class=o>=</span> <span class=nx>fileURLToPath</span><span class=p>(</span><span class=k>new</span> <span class=nx>URL</span><span class=p>(</span><span class=nx>f</span><span class=p>,</span> <span class=kr>import</span><span class=p>.</span><span class=nx>meta</span><span class=p>.</span><span class=nx>url</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=kr>await</span> <span class=kr>import</span><span class=p>(</span><span class=nx>absolutePath</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>await</span> <span class=nx>hope</span><span class=p>.</span><span class=nx>run</span><span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>tag</span><span class=p>);</span> <span class=c1>// 增加上await
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>result</span> <span class=o>=</span> <span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>output</span> <span class=o>===</span> <span class=s1>&#39;terse&#39;</span><span class=p>)</span> <span class=o>?</span> <span class=nx>hope</span><span class=p>.</span><span class=nx>terse</span><span class=p>()</span> <span class=o>:</span> <span class=nx>hope</span><span class=p>.</span><span class=nx>verbose</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>result</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span><span class=kr>await</span> <span class=nx>hope</span><span class=p>.</span><span class=nx>run</span><span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>tag</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=参考><span class=section-num>4</span> 参考<a hidden class=anchor aria-hidden=true href=#参考>#</a></h2><p><a href=/zh/post/2025/reinvent_project/>回到本系列的目录</a></p><ul><li><a href=https://third-bit.com/sdxjs/unit-test/>https://third-bit.com/sdxjs/unit-test/</a></li><li><a href=https://blog.youxu.info/2008/11/30/pearl-in-smalltal/>https://blog.youxu.info/2008/11/30/pearl-in-smalltal/</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://ramsayleung.github.io/zh/tags/reinvent/>reinvent</a></li></ul><nav class=paginav><a class=prev href=https://ramsayleung.github.io/zh/post/2025/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E7%A8%8B%E5%B8%88%E7%9A%84%E8%BD%AF%E6%8A%80%E8%83%BD%E6%8C%87%E5%8C%97_%E8%B0%88%E8%96%AA%E7%AF%87/><span class=title>« 上一页</span><br><span>软件工程师的软技能指北（六）：谈薪篇</span>
</a><a class=next href=https://ramsayleung.github.io/zh/post/2025/reinvent_project/><span class=title>下一页 »</span><br><span>ReInvent: 重新造轮子系列(序言)</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share 重新造轮子系列(一)：单元测试框架 on x" href="https://x.com/intent/tweet/?text=%e9%87%8d%e6%96%b0%e9%80%a0%e8%bd%ae%e5%ad%90%e7%b3%bb%e5%88%97%28%e4%b8%80%29%ef%bc%9a%e5%8d%95%e5%85%83%e6%b5%8b%e8%af%95%e6%a1%86%e6%9e%b6&amp;url=https%3a%2f%2framsayleung.github.io%2fzh%2fpost%2f2025%2freinvent_unit_test%2f&amp;hashtags=reinvent"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 重新造轮子系列(一)：单元测试框架 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2framsayleung.github.io%2fzh%2fpost%2f2025%2freinvent_unit_test%2f&amp;title=%e9%87%8d%e6%96%b0%e9%80%a0%e8%bd%ae%e5%ad%90%e7%b3%bb%e5%88%97%28%e4%b8%80%29%ef%bc%9a%e5%8d%95%e5%85%83%e6%b5%8b%e8%af%95%e6%a1%86%e6%9e%b6&amp;summary=%e9%87%8d%e6%96%b0%e9%80%a0%e8%bd%ae%e5%ad%90%e7%b3%bb%e5%88%97%28%e4%b8%80%29%ef%bc%9a%e5%8d%95%e5%85%83%e6%b5%8b%e8%af%95%e6%a1%86%e6%9e%b6&amp;source=https%3a%2f%2framsayleung.github.io%2fzh%2fpost%2f2025%2freinvent_unit_test%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 重新造轮子系列(一)：单元测试框架 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2framsayleung.github.io%2fzh%2fpost%2f2025%2freinvent_unit_test%2f&title=%e9%87%8d%e6%96%b0%e9%80%a0%e8%bd%ae%e5%ad%90%e7%b3%bb%e5%88%97%28%e4%b8%80%29%ef%bc%9a%e5%8d%95%e5%85%83%e6%b5%8b%e8%af%95%e6%a1%86%e6%9e%b6"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 重新造轮子系列(一)：单元测试框架 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2framsayleung.github.io%2fzh%2fpost%2f2025%2freinvent_unit_test%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 重新造轮子系列(一)：单元测试框架 on whatsapp" href="https://api.whatsapp.com/send?text=%e9%87%8d%e6%96%b0%e9%80%a0%e8%bd%ae%e5%ad%90%e7%b3%bb%e5%88%97%28%e4%b8%80%29%ef%bc%9a%e5%8d%95%e5%85%83%e6%b5%8b%e8%af%95%e6%a1%86%e6%9e%b6%20-%20https%3a%2f%2framsayleung.github.io%2fzh%2fpost%2f2025%2freinvent_unit_test%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 重新造轮子系列(一)：单元测试框架 on telegram" href="https://telegram.me/share/url?text=%e9%87%8d%e6%96%b0%e9%80%a0%e8%bd%ae%e5%ad%90%e7%b3%bb%e5%88%97%28%e4%b8%80%29%ef%bc%9a%e5%8d%95%e5%85%83%e6%b5%8b%e8%af%95%e6%a1%86%e6%9e%b6&amp;url=https%3a%2f%2framsayleung.github.io%2fzh%2fpost%2f2025%2freinvent_unit_test%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 重新造轮子系列(一)：单元测试框架 on ycombinator" href="https://news.ycombinator.com/submitlink?t=%e9%87%8d%e6%96%b0%e9%80%a0%e8%bd%ae%e5%ad%90%e7%b3%bb%e5%88%97%28%e4%b8%80%29%ef%bc%9a%e5%8d%95%e5%85%83%e6%b5%8b%e8%af%95%e6%a1%86%e6%9e%b6&u=https%3a%2f%2framsayleung.github.io%2fzh%2fpost%2f2025%2freinvent_unit_test%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer><section><h2>Comments</h2><div id=comments-giscus></div></section><script type=text/javascript>function getCurrentTheme(){return document.documentElement.getAttribute("data-theme")||document.body.classList.contains("dark")?"dark":"light"}function setGiscusTheme(e=!1){const s=e?"dark":"light";var n,t=document.querySelector(".giscus-frame");t&&(n=new URL(t.src),n.searchParams.set("theme",s),t.src=n.toString())}function loadComment(e=!1){const n="zh"=="zh",t=document.getElementById("comments-giscus");if(t!==null&&!t.hasAttribute("data-giscus-loaded")){console.log("Initial giscus load");const s=document.createElement("script");s.setAttribute("src","https://giscus.app/client.js"),s.setAttribute("data-repo","ramsayleung/comment"),s.setAttribute("data-repo-id","MDEwOlJlcG9zaXRvcnkzMDk2NjQ1NDk="),s.setAttribute("data-category","General"),s.setAttribute("data-category-id","DIC_kwDOEnUbJc4Cltnz"),s.setAttribute("data-mapping","pathname"),s.setAttribute("data-strict","0"),s.setAttribute("data-reactions-enabled","1"),s.setAttribute("data-emit-metadata","0"),s.setAttribute("data-input-position","bottom"),s.setAttribute("data-theme",e?"dark":"light"),s.setAttribute("crossorigin","anonymous"),s.setAttribute("data-lang",n?"zh-CN":"en"),s.setAttribute("async","true"),t.appendChild(s),t.setAttribute("data-giscus-loaded","true")}}let currentTheme=getCurrentTheme();loadComment(currentTheme==="dark");const themeObserver=new MutationObserver(e=>{e.forEach(e=>{if(e.type==="attributes"&&e.attributeName==="class"){const e=getCurrentTheme();e!==currentTheme&&(currentTheme=e,setGiscusTheme(currentTheme==="dark"))}})});themeObserver.observe(document.body,{attributes:!0,attributeFilter:["class"]})</script></article></main><footer class=footer><span>See this site&rsquo;s source code <a href=https://github.com/ramsayleung/ramsayleung.github.io>here</a>, licensed under GPLv3 ·</span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>