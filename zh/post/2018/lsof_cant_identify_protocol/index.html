<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>lsof can't identify protocol | 自由庄园</title><meta name=keywords content="linux"><meta name=description content="Socket 泄漏引起的Tomcat 宕机问题分析 在2018年4月9号下午，收到反馈：测试集群部分接口访问有问题，请求时而正常，时而超时。 最近的测试环境真"><meta name=author content="Ramsay Leung"><link rel=canonical href=https://ramsayleung.github.io/zh/post/2018/lsof_cant_identify_protocol/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.14f7bc7e839b71d3629f916de9b92c7bce4699050f17672261861b72916e5d3a.css integrity="sha256-FPe8foObcdNin5Ft6bkse85GmQUPF2ciYYYbcpFuXTo=" rel="preload stylesheet" as=style><link rel=icon href=https://ramsayleung.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://ramsayleung.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://ramsayleung.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://ramsayleung.github.io/apple-touch-icon.png><link rel=mask-icon href=https://ramsayleung.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://ramsayleung.github.io/zh/post/2018/lsof_cant_identify_protocol/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-9MG65HQHEL"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-9MG65HQHEL",{anonymize_ip:!1})}</script><meta property="og:title" content="lsof can't identify protocol"><meta property="og:description" content="Socket 泄漏引起的Tomcat 宕机问题分析 在2018年4月9号下午，收到反馈：测试集群部分接口访问有问题，请求时而正常，时而超时。 最近的测试环境真"><meta property="og:type" content="article"><meta property="og:url" content="https://ramsayleung.github.io/zh/post/2018/lsof_cant_identify_protocol/"><meta property="og:image" content="https://ramsayleung.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="post"><meta property="article:published_time" content="2018-04-11T15:24:00+08:00"><meta property="article:modified_time" content="2022-02-24T23:04:29+08:00"><meta property="og:site_name" content="自由庄园"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://ramsayleung.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="lsof can't identify protocol"><meta name=twitter:description content="Socket 泄漏引起的Tomcat 宕机问题分析 在2018年4月9号下午，收到反馈：测试集群部分接口访问有问题，请求时而正常，时而超时。 最近的测试环境真"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":4,"name":"lsof can't identify protocol","item":"https://ramsayleung.github.io/zh/post/2018/lsof_cant_identify_protocol/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"lsof can't identify protocol","name":"lsof can\u0027t identify protocol","description":"Socket 泄漏引起的Tomcat 宕机问题分析 在2018年4月9号下午，收到反馈：测试集群部分接口访问有问题，请求时而正常，时而超时。 最近的测试环境真","keywords":["linux"],"articleBody":"Socket 泄漏引起的Tomcat 宕机问题分析\n在2018年4月9号下午，收到反馈：测试集群部分接口访问有问题，请求时而正常，时而超时。\n最近的测试环境真的是问题多多，可是测试环境就是我搭建的，冏。查看日志发现87 这台 服务器的Tomcat 无法访问：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 2018-04-09 17:41:31,568 - [ERROR] - from org.apache.tomcat.util.net.NioEndpoint in http-nio-47001-Acceptor-0 Socket accept failed java.io.IOException: Too many open files at sun.nio.ch.ServerSocketChannelImpl.accept0(Native Method) at sun.nio.ch.ServerSocketChannelImpl.accept(ServerSocketChannelImpl.java:422) at sun.nio.ch.ServerSocketChannelImpl.accept(ServerSocketChannelImpl.java:250) at org.apache.tomcat.util.net.NioEndpoint$Acceptor.run(NioEndpoint.java:825) at java.lang.Thread.run(Thread.java:745) 2018-04-09 17:41:33,168 - [ERROR] - from org.apache.tomcat.util.net.NioEndpoint in http-nio-47001-Acceptor-0 Socket accept failed java.io.IOException: Too many open files at sun.nio.ch.ServerSocketChannelImpl.accept0(Native Method) at sun.nio.ch.ServerSocketChannelImpl.accept(ServerSocketChannelImpl.java:422) at sun.nio.ch.ServerSocketChannelImpl.accept(ServerSocketChannelImpl.java:250) at org.apache.tomcat.util.net.NioEndpoint$Acceptor.run(NioEndpoint.java:825) at java.lang.Thread.run(Thread.java:745) 1 Linux 文件句柄限制 报错看起来像是进程打开文件句柄的个数达到了linux的限制。而这种限制是分为系统层面的和用户层面的\n1.1 系统层面 系统层面的在：/proc/sys/fs/file-max里设置\n1 2 cat /proc/sys/fs/file-max 2442976 1.2 用户层面 用户层面的限制在：/etc/security/limits.conf里设定。通过ulimit -a 查看系统允许单个进程打开的最大文件数：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 ulimit -a core file size (blocks, -c) 0 data seg size (kbytes, -d) unlimited scheduling priority (-e) 0 file size (blocks, -f) unlimited pending signals (-i) 192059 max locked memory (kbytes, -l) 64 max memory size (kbytes, -m) unlimited open files (-n) 65536 pipe size (512 bytes, -p) 8 POSIX message queues (bytes, -q) 819200 real-time priority (-r) 0 stack size (kbytes, -s) 10240 cpu time (seconds, -t) unlimited max user processes (-u) 65535 virtual memory (kbytes, -v) unlimited file locks (-x) unlimited 单个进程可以打开的最大文件数是 65536\n2 lsof 显示大量open file 按照Tomcat 给出的报错信息，登录87 这台服务器检查打开的文件数，发现打开的文件超过70000:\n1 2 lsof |wc -l 75924 然后找出打开文件数最多的进程，按文件数降序排列，左边是 open file 的数量，右边是进程ID：\n1 2 3 4 5 6 7 8 9 10 11 lsof -n|awk '{print $2}'| sort | uniq -c | sort -nr | head 65966 25204 5374 20179 184 27275 65 5361 61 29421 16 22177 14 19751 12 22181 12 22179 12 22178 发现 25204 这个进程打开了大量的文件，已经超过了单个进程的最大文件数限制。而这个进程就是部署的java 应用对应的进程。打开的文件句柄数量已经超过Linux 限制， Tomcat 无法创建新的socket 连接。\n3 can’t identify protocol 用 lsof 查看 java 应用打开的文件的时候，发现有非常多奇怪的输出：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 java 25204 nemo *516u sock 0,6 0t0 215137625 can't identify protocol java 25204 nemo *517u sock 0,6 0t0 215137626 can't identify protocol java 25204 nemo *518u sock 0,6 0t0 215137627 can't identify protocol java 25204 nemo *519u sock 0,6 0t0 215137628 can't identify protocol java 25204 nemo *520u sock 0,6 0t0 215137629 can't identify protocol java 25204 nemo *521u sock 0,6 0t0 215137630 can't identify protocol java 25204 nemo *522u sock 0,6 0t0 215137631 can't identify protocol java 25204 nemo *523u sock 0,6 0t0 215137634 can't identify protocol java 25204 nemo *524u sock 0,6 0t0 215137635 can't identify protocol java 25204 nemo *525u sock 0,6 0t0 215137636 can't identify protocol java 25204 nemo *526u sock 0,6 0t0 215137637 can't identify protocol java 25204 nemo *527u sock 0,6 0t0 215137638 can't identify protocol java 25204 nemo *528u sock 0,6 0t0 215137639 can't identify protocol java 25204 nemo *529u sock 0,6 0t0 215137640 can't identify protocol java 25204 nemo *530u sock 0,6 0t0 215137641 can't identify protocol java 25204 nemo *531u sock 0,6 0t0 215137642 can't identify protocol java 25204 nemo *532u sock 0,6 0t0 215137644 can't identify protocol java 25204 nemo *533u sock 0,6 0t0 215137646 can't identify protocol 统计之后发现， can't identify protocol 这样的文件数量非常多：\n1 2 lsof -p 25204|grep \"can't identify protocol\"|wc -l 64214 也就是大部份打开的文件都是属于 cant' identify protocol 的文件。\n4 问题定位 Google 搜索之后发现，这个 cant' identify protocol 的东东出现的原因是因为 这些 sockets 处于 CLOSED 的状态，但是却没有真正close 掉，正处于 half-close 状态。因此，如果使用 netstat 来查看socket 状态，是不会显示这些 half-close的 socket 的：\n1 2 netstat -nat |wc -l 881 使用 netstat 的改进版本 ss 就能发现大量处于 Closed 状态的 socket:\n1 2 3 4 5 6 7 8 9 10 11 ss -s Total: 76052 (kernel 76254) TCP: 75924 (estab 123, closed 75524, orphaned 0, synrecv 0, timewait 173/0), ports 104 Transport Total IP IPv6 * 76254 - - RAW 0 0 0 UDP 9 6 3 TCP 116 80 36 INET 125 86 39 FRAG 0 0 0 接着查看内核的 socket 情况：\n1 2 3 4 5 6 7 cat /proc/net/sockstat sockets: used 75724 TCP: inuse 886 orphan 0 tw 0 alloc 72134 mem 222 UDP: inuse 5 mem 0 UDPLITE: inuse 0 RAW: inuse 0 FRAG: inuse 0 memory 0 很多的 socket 处于 alloc, 只有少量的 socket 处于 inuse. 可以确认是 java 应用出现了 socket fd 的泄漏。 但是为什么会有那么多的socket 泄漏呢？\n5 大胆假设 现在可以确定的是 java应用出现了问题，导致了socket 泄漏，让 Tomcat 无法建立新连接，最终宕机。既然导致问题出现的是 java 应用，那么就应该去检查应用日志。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 2018-04-09 17:41:31,491 - [ERROR] - from com.alibaba.druid.pool.DruidDataSource in Druid-ConnectionPool-CreateScheduler--4-thread-214 create connection error, url: jdbc:mysql://test-server-host:3306/db_name?readOnlyPropagatesToServer=false\u0026rewriteBatchedStatements=true\u0026failOverReadOnly=false\u0026socketTimeout=6000\u0026connectTimeout=20000\u0026zeroDateTimeBehavior=convertToNull\u0026allowMultiQueries=true\u0026characterEncoding=utf-8\u0026autoReconnect=true com.mysql.jdbc.exceptions.jdbc4.MySQLNonTransientConnectionException: Could not create connection to database server. Attempted reconnect 3 times. Giving up. at sun.reflect.GeneratedConstructorAccessor169.newInstance(Unknown Source) at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45) at java.lang.reflect.Constructor.newInstance(Constructor.java:423) at com.mysql.jdbc.Util.handleNewInstance(Util.java:425) at com.mysql.jdbc.Util.getInstance(Util.java:408) at com.mysql.jdbc.SQLError.createSQLException(SQLError.java:918) at com.mysql.jdbc.SQLError.createSQLException(SQLError.java:897) at com.mysql.jdbc.SQLError.createSQLException(SQLError.java:886) at com.mysql.jdbc.SQLError.createSQLException(SQLError.java:860) at com.mysql.jdbc.ConnectionImpl.connectWithRetries(ConnectionImpl.java:2163) at com.mysql.jdbc.ConnectionImpl.createNewIO(ConnectionImpl.java:2088) at com.mysql.jdbc.ConnectionImpl.(ConnectionImpl.java:806) at com.mysql.jdbc.JDBC4Connection.(JDBC4Connection.java:47) at sun.reflect.GeneratedConstructorAccessor152.newInstance(Unknown Source) at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45) at java.lang.reflect.Constructor.newInstance(Constructor.java:423) at com.mysql.jdbc.Util.handleNewInstance(Util.java:425) at com.mysql.jdbc.ConnectionImpl.getInstance(ConnectionImpl.java:410) at com.mysql.jdbc.NonRegisteringDriver.connect(NonRegisteringDriver.java:328) at com.alibaba.druid.filter.FilterChainImpl.connection_connect(FilterChainImpl.java:148) at com.alibaba.druid.filter.stat.StatFilter.connection_connect(StatFilter.java:211) at com.alibaba.druid.filter.FilterChainImpl.connection_connect(FilterChainImpl.java:142) at com.alibaba.druid.pool.DruidAbstractDataSource.createPhysicalConnection(DruidAbstractDataSource.java:1423) at com.alibaba.druid.pool.DruidAbstractDataSource.createPhysicalConnection(DruidAbstractDataSource.java:1477) at com.alibaba.druid.pool.DruidDataSource$CreateConnectionTask.runInternal(DruidDataSource.java:1884) at com.alibaba.druid.pool.DruidDataSource$CreateConnectionTask.run(DruidDataSource.java:1849) at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) at java.util.concurrent.FutureTask.run(FutureTask.java:266) at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) at java.lang.Thread.run(Thread.java:745) Caused by: com.mysql.jdbc.exceptions.jdbc4.CommunicationsException: Communications link failure The last packet sent successfully to the server was 0 milliseconds ago. The driver has not received any packets from the server. at sun.reflect.GeneratedConstructorAccessor157.newInstance(Unknown Source) at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45) at java.lang.reflect.Constructor.newInstance(Constructor.java:423) at com.mysql.jdbc.Util.handleNewInstance(Util.java:425) at com.mysql.jdbc.SQLError.createCommunicationsException(SQLError.java:989) at com.mysql.jdbc.MysqlIO.(MysqlIO.java:341) at com.mysql.jdbc.ConnectionImpl.coreConnect(ConnectionImpl.java:2251) at com.mysql.jdbc.ConnectionImpl.connectWithRetries(ConnectionImpl.java:2104) ... 21 common frames omitted Caused by: java.net.SocketException: Too many open files at java.net.Socket.createImpl(Socket.java:460) at java.net.Socket.getImpl(Socket.java:520) at java.net.Socket.setTcpNoDelay(Socket.java:980) at com.mysql.jdbc.StandardSocketFactory.configureSocket(StandardSocketFactory.java:132) at com.mysql.jdbc.StandardSocketFactory.connect(StandardSocketFactory.java:203) at com.mysql.jdbc.MysqlIO.(MysqlIO.java:300) ... 23 common frames omitted 2018-04-09 17:41:31,568 - [ERROR] - from org.apache.tomcat.util.net.NioEndpoint in http-nio-47001-Acceptor-0 Socket accept failed java.io.IOException: Too many open files at sun.nio.ch.ServerSocketChannelImpl.accept0(Native Method) at sun.nio.ch.ServerSocketChannelImpl.accept(ServerSocketChannelImpl.java:422) at sun.nio.ch.ServerSocketChannelImpl.accept(ServerSocketChannelImpl.java:250) at org.apache.tomcat.util.net.NioEndpoint$Acceptor.run(NioEndpoint.java:825) at java.lang.Thread.run(Thread.java:745) 2018-04-09 17:41:33,168 - [ERROR] - from org.apache.tomcat.util.net.NioEndpoint in http-nio-47001-Acceptor-0 Socket accept failed java.io.IOException: Too many open files at sun.nio.ch.ServerSocketChannelImpl.accept0(Native Method) at sun.nio.ch.ServerSocketChannelImpl.accept(ServerSocketChannelImpl.java:422) at sun.nio.ch.ServerSocketChannelImpl.accept(ServerSocketChannelImpl.java:250) at org.apache.tomcat.util.net.NioEndpoint$Acceptor.run(NioEndpoint.java:825) at java.lang.Thread.run(Thread.java:745) 2018-04-09 17:41:34,470 - [ERROR] - from com.alibaba.druid.pool.DruidDataSource in Druid-ConnectionPool-CreateScheduler--4-thread-216 create connection error, url: jdbc:mysql://test-server-url:3306/db_name?readOnlyPropagatesToServer=false\u0026rewriteBatchedStatements=true\u0026failOverReadOnly=false\u0026socketTimeout=6000\u0026connectTimeout=20000\u0026zeroDateTimeBehavior=convertToNull\u0026allowMultiQueries=true\u0026characterEncoding=utf-8\u0026autoReconnect=true com.mysql.jdbc.exceptions.jdbc4.MySQLNonTransientConnectionException: Could not create connection to database server. Attempted reconnect 3 times. Giving up. at sun.reflect.GeneratedConstructorAccessor169.newInstance(Unknown Source) at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45) at java.lang.reflect.Constructor.newInstance(Constructor.java:423) at com.mysql.jdbc.Util.handleNewInstance(Util.java:425) at com.mysql.jdbc.Util.getInstance(Util.java:408) at com.mysql.jdbc.SQLError.createSQLException(SQLError.java:918) at com.mysql.jdbc.SQLError.createSQLException(SQLError.java:897) at com.mysql.jdbc.SQLError.createSQLException(SQLError.java:886) at com.mysql.jdbc.SQLError.createSQLException(SQLError.java:860) at com.mysql.jdbc.ConnectionImpl.connectWithRetries(ConnectionImpl.java:2163) at com.mysql.jdbc.ConnectionImpl.createNewIO(ConnectionImpl.java:2088) at com.mysql.jdbc.ConnectionImpl.(ConnectionImpl.java:806) at com.mysql.jdbc.JDBC4Connection.(JDBC4Connection.java:47) at sun.reflect.GeneratedConstructorAccessor152.newInstance(Unknown Source) at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45) at java.lang.reflect.Constructor.newInstance(Constructor.java:423) at com.mysql.jdbc.Util.handleNewInstance(Util.java:425) at com.mysql.jdbc.ConnectionImpl.getInstance(ConnectionImpl.java:410) at com.mysql.jdbc.NonRegisteringDriver.connect(NonRegisteringDriver.java:328) at com.alibaba.druid.filter.FilterChainImpl.connection_connect(FilterChainImpl.java:148) at com.alibaba.druid.filter.stat.StatFilter.connection_connect(StatFilter.java:211) at com.alibaba.druid.filter.FilterChainImpl.connection_connect(FilterChainImpl.java:142) at com.alibaba.druid.pool.DruidAbstractDataSource.createPhysicalConnection(DruidAbstractDataSource.java:1423) at com.alibaba.druid.pool.DruidAbstractDataSource.createPhysicalConnection(DruidAbstractDataSource.java:1477) at com.alibaba.druid.pool.DruidDataSource$CreateConnectionTask.runInternal(DruidDataSource.java:1884) at com.alibaba.druid.pool.DruidDataSource$CreateConnectionTask.run(DruidDataSource.java:1849) at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) at java.util.concurrent.FutureTask.run(FutureTask.java:266) at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$201(ScheduledThreadPoolExecutor.java:180) at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:293) at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) at java.lang.Thread.run(Thread.java:745) Caused by: com.mysql.jdbc.exceptions.jdbc4.CommunicationsException: Communications link failure The last packet sent successfully to the server was 0 milliseconds ago. The driver has not received any packets from the server. at sun.reflect.GeneratedConstructorAccessor157.newInstance(Unknown Source) at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45) at java.lang.reflect.Constructor.newInstance(Constructor.java:423) at com.mysql.jdbc.Util.handleNewInstance(Util.java:425) at com.mysql.jdbc.SQLError.createCommunicationsException(SQLError.java:989) at com.mysql.jdbc.MysqlIO.(MysqlIO.java:341) at com.mysql.jdbc.ConnectionImpl.coreConnect(ConnectionImpl.java:2251) at com.mysql.jdbc.ConnectionImpl.connectWithRetries(ConnectionImpl.java:2104) ... 23 common frames omitted Caused by: java.net.SocketException: Too many open files at java.net.Socket.createImpl(Socket.java:460) at java.net.Socket.getImpl(Socket.java:520) at java.net.Socket.setTcpNoDelay(Socket.java:980) at com.mysql.jdbc.StandardSocketFactory.configureSocket(StandardSocketFactory.java:132) at com.mysql.jdbc.StandardSocketFactory.connect(StandardSocketFactory.java:203) at com.mysql.jdbc.MysqlIO.(MysqlIO.java:300) ... 25 common frames omitted 2018-04-09 17:41:34,769 - [ERROR] - from org.apache.tomcat.util.net.NioEndpoint in http-nio-47001-Acceptor-0 Socket accept failed java.io.IOException: Too many open files at sun.nio.ch.ServerSocketChannelImpl.accept0(Native Method) at sun.nio.ch.ServerSocketChannelImpl.accept(ServerSocketChannelImpl.java:422) at sun.nio.ch.ServerSocketChannelImpl.accept(ServerSocketChannelImpl.java:250) at org.apache.tomcat.util.net.NioEndpoint$Acceptor.run(NioEndpoint.java:825) at java.lang.Thread.run(Thread.java:745) 检查日志发现，在 Tomcat 彻底挂机之前，曾经有比较大量的数据源连接池出错，无法访问 Mysql, 但是非常奇怪的是，在87 这台机器上面，是可以使用 mysql 命令行连接到测试数据库的，说明 Mysql 的连接是没有问题。\n但是数据源连接就会出错！！ 真的是很奇怪，为什么连接池会报错，有没有可能是这些异常导致 socket 泄漏呢？后来，在本地运行应用，有时候会发现IDE 的控制台报错：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 2018-04-11 09:43:48,363 - [ERROR] - from com.alibaba.druid.pool.DruidDataSource in poolTaskScheduler-11 discard connection com.mysql.jdbc.exceptions.jdbc4.CommunicationsException: Communications link failure The last packet successfully received from the server was 100,610 milliseconds ago. The last packet sent successfully to the server was 0 milliseconds ago. at sun.reflect.GeneratedConstructorAccessor108.newInstance(Unknown Source) at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45) at java.lang.reflect.Constructor.newInstance(Constructor.java:423) at com.mysql.jdbc.Util.handleNewInstance(Util.java:425) at com.mysql.jdbc.SQLError.createCommunicationsException(SQLError.java:989) at com.mysql.jdbc.MysqlIO.reuseAndReadPacket(MysqlIO.java:3556) at com.mysql.jdbc.MysqlIO.reuseAndReadPacket(MysqlIO.java:3456) at com.mysql.jdbc.MysqlIO.checkErrorPacket(MysqlIO.java:3897) at com.mysql.jdbc.MysqlIO.sendCommand(MysqlIO.java:2524) at com.mysql.jdbc.MysqlIO.sqlQueryDirect(MysqlIO.java:2677) at com.mysql.jdbc.ConnectionImpl.execSQL(ConnectionImpl.java:2545) at com.mysql.jdbc.ConnectionImpl.execSQL(ConnectionImpl.java:2503) at com.mysql.jdbc.StatementImpl.executeQuery(StatementImpl.java:1369) at com.alibaba.druid.filter.FilterChainImpl.statement_executeQuery(FilterChainImpl.java:2363) at com.alibaba.druid.filter.FilterAdapter.statement_executeQuery(FilterAdapter.java:2481) at com.alibaba.druid.filter.FilterEventAdapter.statement_executeQuery(FilterEventAdapter.java:302) at com.alibaba.druid.filter.FilterChainImpl.statement_executeQuery(FilterChainImpl.java:2360) at com.alibaba.druid.proxy.jdbc.StatementProxyImpl.executeQuery(StatementProxyImpl.java:211) at com.alibaba.druid.pool.DruidPooledStatement.executeQuery(DruidPooledStatement.java:138) at com.taobao.tddl.atom.jdbc.TStatementWrapper.executeQuery(TStatementWrapper.java:315) at com.taobao.tddl.group.jdbc.TGroupStatement.executeQueryOnConnection(TGroupStatement.java:549) at com.taobao.tddl.group.jdbc.TGroupStatement$4.tryOnDataSource(TGroupStatement.java:633) at com.taobao.tddl.group.jdbc.TGroupStatement$4.tryOnDataSource(TGroupStatement.java:615) at com.taobao.tddl.group.dbselector.AbstractDBSelector.tryOnDataSourceHolder(AbstractDBSelector.java:155) at com.taobao.tddl.group.dbselector.OneDBSelector.tryExecuteInternal(OneDBSelector.java:52) at com.taobao.tddl.group.dbselector.AbstractDBSelector.tryExecute(AbstractDBSelector.java:405) at com.taobao.tddl.group.dbselector.AbstractDBSelector.tryExecute(AbstractDBSelector.java:412) at com.taobao.tddl.group.jdbc.TGroupStatement.executeQuery(TGroupStatement.java:488) at com.taobao.tddl.group.jdbc.TGroupStatement.executeInternal(TGroupStatement.java:131) at com.taobao.tddl.group.jdbc.TGroupStatement.execute(TGroupStatement.java:101) at com.taobao.tddl.repo.mysql.spi.My_JdbcHandler.executeQuery(My_JdbcHandler.java:521) at com.taobao.tddl.repo.mysql.spi.My_Cursor.init(My_Cursor.java:106) at com.taobao.tddl.repo.mysql.handler.QueryMyHandler.handle(QueryMyHandler.java:89) at com.taobao.tddl.executor.AbstractGroupExecutor.executeInner(AbstractGroupExecutor.java:47) at com.taobao.tddl.executor.AbstractGroupExecutor.execByExecPlanNode(AbstractGroupExecutor.java:36) at com.taobao.tddl.executor.TopologyExecutor.execByExecPlanNode(TopologyExecutor.java:66) at com.taobao.tddl.executor.MatrixExecutor.execByExecPlanNodeByOne(MatrixExecutor.java:670) at com.taobao.tddl.executor.MatrixExecutor.execByExecPlanNode(MatrixExecutor.java:659) at com.taobao.tddl.executor.MatrixExecutor.execute(MatrixExecutor.java:137) at com.taobao.tddl.matrix.jdbc.TConnection.executeSQL(TConnection.java:241) at com.taobao.tddl.matrix.jdbc.TPreparedStatement.executeSQL(TPreparedStatement.java:64) at com.taobao.tddl.matrix.jdbc.TStatement.executeInternal(TStatement.java:133) at com.taobao.tddl.matrix.jdbc.TPreparedStatement.execute(TPreparedStatement.java:49) at sun.reflect.GeneratedMethodAccessor148.invoke(Unknown Source) at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) at java.lang.reflect.Method.invoke(Method.java:498) at org.apache.ibatis.logging.jdbc.PreparedStatementLogger.invoke(PreparedStatementLogger.java:59) at com.sun.proxy.$Proxy102.execute(Unknown Source) at org.apache.ibatis.executor.statement.PreparedStatementHandler.query(PreparedStatementHandler.java:63) at org.apache.ibatis.executor.statement.RoutingStatementHandler.query(RoutingStatementHandler.java:79) at org.apache.ibatis.executor.SimpleExecutor.doQuery(SimpleExecutor.java:63) at org.apache.ibatis.executor.BaseExecutor.queryFromDatabase(BaseExecutor.java:325) at org.apache.ibatis.executor.BaseExecutor.query(BaseExecutor.java:156) at org.apache.ibatis.executor.CachingExecutor.query(CachingExecutor.java:109) at org.apache.ibatis.executor.CachingExecutor.query(CachingExecutor.java:83) at sun.reflect.GeneratedMethodAccessor146.invoke(Unknown Source) at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) at java.lang.reflect.Method.invoke(Method.java:498) at org.apache.ibatis.plugin.Invocation.proceed(Invocation.java:49) at fastfish.interceptor.DbLogInterceptor.intercept(DbLogInterceptor.java:49) at org.apache.ibatis.plugin.Plugin.invoke(Plugin.java:61) at com.sun.proxy.$Proxy100.query(Unknown Source) at org.apache.ibatis.session.defaults.DefaultSqlSession.selectList(DefaultSqlSession.java:148) at org.apache.ibatis.session.defaults.DefaultSqlSession.selectList(DefaultSqlSession.java:141) at sun.reflect.GeneratedMethodAccessor145.invoke(Unknown Source) at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) at java.lang.reflect.Method.invoke(Method.java:498) at org.mybatis.spring.SqlSessionTemplate$SqlSessionInterceptor.invoke(SqlSessionTemplate.java:434) at com.sun.proxy.$Proxy87.selectList(Unknown Source) at org.mybatis.spring.SqlSessionTemplate.selectList(SqlSessionTemplate.java:231) at org.apache.ibatis.binding.MapperMethod.executeForMany(MapperMethod.java:128) at org.apache.ibatis.binding.MapperMethod.execute(MapperMethod.java:68) at org.apache.ibatis.binding.MapperProxy.invoke(MapperProxy.java:53) at com.sun.proxy.$Proxy124.selectAll(Unknown Source) at fastfish.services.BusinessService.getAll(BusinessService.java:73) at fastfish.services.BusinessService.loadDB(BusinessService.java:38) at sun.reflect.GeneratedMethodAccessor190.invoke(Unknown Source) at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) at java.lang.reflect.Method.invoke(Method.java:498) at org.springframework.scheduling.support.ScheduledMethodRunnable.run(ScheduledMethodRunnable.java:65) at org.springframework.scheduling.support.DelegatingErrorHandlingRunnable.run(DelegatingErrorHandlingRunnable.java:54) at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) at java.util.concurrent.FutureTask.runAndReset$$$capture(FutureTask.java:308) at java.util.concurrent.FutureTask.runAndReset(FutureTask.java) at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$301(ScheduledThreadPoolExecutor.java:180) at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:294) at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) at java.lang.Thread.run(Thread.java:748) Caused by: java.io.EOFException: Can not read response from server. Expected to read 4 bytes, read 0 bytes before connection was unexpectedly lost. at com.mysql.jdbc.MysqlIO.readFully(MysqlIO.java:3008) at com.mysql.jdbc.MysqlIO.reuseAndReadPacket(MysqlIO.java:3466) ... 83 common frames omitted 是数据池连接出错。但是我本地的应用确实是可以访问测试数据库的， 比较有趣的异常就是\n1 Caused by: java.io.EOFException: Can not read response from server. Expected to read 4 bytes, read 0 bytes before connection was unexpectedly lost. 数据还没有读完， Connection 就丢了。为什么会 lost connection 呢，可能数据库出问题，也可能是网络出了问题。\n我还能从数据库读到数据，说明数据库没问题的，兼之这个异常只是偶尔出现，所以可能就是网络出问题了。\n如此说来，是否可能是因为测试环境网络不稳定，连接池无法和 Mysql 保持连接，在丢掉 Connection 之后，连接池重新发起连接，但是因为网络不稳定又丢掉了Connection, 不断循环这个过程，导致建立的 socket 连接越 来越多，但是建立的 socket 很快就被Close 掉了，内核又没有把这些 Close 掉的 socket 资源回收掉，因此打开的 socket 文件越来越多，最后导致 Tomcat 因为打开的文件过多无法建立新的 socket 连接。\n6 小心求证 如果连接池真的不断尝试连接Mysql 的话，必定会建立很多的连接，而Mysql 是会将这些记录保存下来的，检查Mysql 的变量：\n查看Mysql 的文档关于 Connection 和 Thread_connected 的说明：\nConnections\nThe number of connection attempts (successful or not) to the MySQL server.\nThreads_connected\nThe number of currently open connections.\n也就是说，当时共有20000 多的连接请求，但是真正被 Mysql accpet 并且服务的只有 28 个连接。看来的确是因为连接池的连接导致 socket 泄漏\n6.1 更新 和运维同学沟通之后，发现丢连接的原因不是网络不稳定，而是测试集群都是虚拟机，内存 用光，导致无法建立新的连接，内核释放一部分资源之后又可以建立连接了。内存用完，我能怎么办，我也很无奈。\n7 解决方法 虽说基本确定了 socket 泄漏的源头，但是对于内核为什么无法回收已经关闭 socket 的原因依然不明确。\n最令人百思不得其解的是，部署了应用的测试服务器有两台，另外一 台服务器也有同样的连接池问题，但是却没有出现 socket 泄漏问题， 出现泄漏的只有 87 这台机器。真的令人费解. 所以最后解决方法就是撤下 87 服务器的应用，换一台服务器来部署。\n新的服务器部署应用之后虽说也有同样的数据库连接池异常，但是却没有出现 socket 泄漏，初步定位是 87这台机器的内核环境存在问题。\n8 参考 tcp-socket文件句柄泄漏/ lsof-cant-identify-protocol/ ","wordCount":"3281","inLanguage":"zh","datePublished":"2018-04-11T15:24:00+08:00","dateModified":"2022-02-24T23:04:29+08:00","author":{"@type":"Person","name":"Ramsay Leung"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://ramsayleung.github.io/zh/post/2018/lsof_cant_identify_protocol/"},"publisher":{"@type":"Organization","name":"自由庄园","logo":{"@type":"ImageObject","url":"https://ramsayleung.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://ramsayleung.github.io/zh/ accesskey=h title="Home (Alt + H)"><img src=https://ramsayleung.github.io/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://ramsayleung.github.io/en/ title=English aria-label=English>En</a></li></ul></div></div><ul id=menu><li><a href=https://ramsayleung.github.io/zh/archives/ title=归档><span>归档</span></a></li><li><a href=https://ramsayleung.github.io/zh/search/ title=搜索><span>搜索</span></a></li><li><a href=https://ramsayleung.github.io/zh/categories/ title=目录><span>目录</span></a></li><li><a href=https://ramsayleung.github.io/zh/tags/ title=标签><span>标签</span></a></li><li><a href=https://ramsayleung.github.io/zh/about_me_zh/ title=关于><span>关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://ramsayleung.github.io/zh/>主页</a></div><h1 class=post-title>lsof can't identify protocol</h1><div class=post-meta><span title='2018-04-11 15:24:00 +0800 +0800'>四月 11, 2018</span>&nbsp;·&nbsp;7 分钟&nbsp;·&nbsp;3281 字&nbsp;·&nbsp;Ramsay Leung&nbsp;|&nbsp;<a href=https://github.com/ramsayleung/ramsayleung.github.io/blob/master/content/post/2018/lsof_cant_identify_protocol.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#linux-文件句柄限制><span class=section-num>1</span> Linux 文件句柄限制</a><ul><li><a href=#系统层面><span class=section-num>1.1</span> 系统层面</a></li><li><a href=#用户层面><span class=section-num>1.2</span> 用户层面</a></li></ul></li><li><a href=#lsof-显示大量open-file><span class=section-num>2</span> lsof 显示大量open file</a></li><li><a href=#can-t-identify-protocol><span class=section-num>3</span> can&rsquo;t identify protocol</a></li><li><a href=#问题定位><span class=section-num>4</span> 问题定位</a></li><li><a href=#大胆假设><span class=section-num>5</span> 大胆假设</a></li><li><a href=#小心求证><span class=section-num>6</span> 小心求证</a><ul><li><a href=#更新><span class=section-num>6.1</span> 更新</a></li></ul></li><li><a href=#解决方法><span class=section-num>7</span> 解决方法</a></li><li><a href=#参考><span class=section-num>8</span> 参考</a></li></ul></nav></div></details></div><div class=post-content><p>Socket 泄漏引起的Tomcat 宕机问题分析</p><p>在2018年4月9号下午，收到反馈：测试集群部分接口访问有问题，请求时而正常，时而超时。</p><p>最近的测试环境真的是问题多多，可是测试环境就是我搭建的，冏。查看日志发现87 这台 服务器的Tomcat 无法访问：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>2018-04-09 17:41:31,568 - [ERROR] - from org.apache.tomcat.util.net.NioEndpoint in http-nio-47001-Acceptor-0
</span></span><span class=line><span class=cl>Socket accept failed
</span></span><span class=line><span class=cl>java.io.IOException: Too many open files
</span></span><span class=line><span class=cl>at sun.nio.ch.ServerSocketChannelImpl.accept0(Native Method)
</span></span><span class=line><span class=cl>at sun.nio.ch.ServerSocketChannelImpl.accept(ServerSocketChannelImpl.java:422)
</span></span><span class=line><span class=cl>at sun.nio.ch.ServerSocketChannelImpl.accept(ServerSocketChannelImpl.java:250)
</span></span><span class=line><span class=cl>at org.apache.tomcat.util.net.NioEndpoint$Acceptor.run(NioEndpoint.java:825)
</span></span><span class=line><span class=cl>at java.lang.Thread.run(Thread.java:745)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>2018-04-09 17:41:33,168 - [ERROR] - from org.apache.tomcat.util.net.NioEndpoint in http-nio-47001-Acceptor-0
</span></span><span class=line><span class=cl>Socket accept failed
</span></span><span class=line><span class=cl>java.io.IOException: Too many open files
</span></span><span class=line><span class=cl>at sun.nio.ch.ServerSocketChannelImpl.accept0(Native Method)
</span></span><span class=line><span class=cl>at sun.nio.ch.ServerSocketChannelImpl.accept(ServerSocketChannelImpl.java:422)
</span></span><span class=line><span class=cl>at sun.nio.ch.ServerSocketChannelImpl.accept(ServerSocketChannelImpl.java:250)
</span></span><span class=line><span class=cl>at org.apache.tomcat.util.net.NioEndpoint$Acceptor.run(NioEndpoint.java:825)
</span></span><span class=line><span class=cl>at java.lang.Thread.run(Thread.java:745)
</span></span></code></pre></td></tr></table></div></div><h2 id=linux-文件句柄限制><span class=section-num>1</span> Linux 文件句柄限制<a hidden class=anchor aria-hidden=true href=#linux-文件句柄限制>#</a></h2><p>报错看起来像是进程打开文件句柄的个数达到了linux的限制。而这种限制是分为系统层面的和用户层面的</p><h3 id=系统层面><span class=section-num>1.1</span> 系统层面<a hidden class=anchor aria-hidden=true href=#系统层面>#</a></h3><p>系统层面的在：/proc/sys/fs/file-max里设置</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>cat /proc/sys/fs/file-max
</span></span><span class=line><span class=cl><span class=m>2442976</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=用户层面><span class=section-num>1.2</span> 用户层面<a hidden class=anchor aria-hidden=true href=#用户层面>#</a></h3><p>用户层面的限制在：/etc/security/limits.conf里设定。通过<code>ulimit -a</code> 查看系统允许单个进程打开的最大文件数：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=nb>ulimit</span> -a
</span></span><span class=line><span class=cl>core file size          <span class=o>(</span>blocks, -c<span class=o>)</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>data seg size           <span class=o>(</span>kbytes, -d<span class=o>)</span> unlimited
</span></span><span class=line><span class=cl>scheduling priority             <span class=o>(</span>-e<span class=o>)</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>file size               <span class=o>(</span>blocks, -f<span class=o>)</span> unlimited
</span></span><span class=line><span class=cl>pending signals                 <span class=o>(</span>-i<span class=o>)</span> <span class=m>192059</span>
</span></span><span class=line><span class=cl>max locked memory       <span class=o>(</span>kbytes, -l<span class=o>)</span> <span class=m>64</span>
</span></span><span class=line><span class=cl>max memory size         <span class=o>(</span>kbytes, -m<span class=o>)</span> unlimited
</span></span><span class=line><span class=cl>open files                      <span class=o>(</span>-n<span class=o>)</span> <span class=m>65536</span>
</span></span><span class=line><span class=cl>pipe size            <span class=o>(</span><span class=m>512</span> bytes, -p<span class=o>)</span> <span class=m>8</span>
</span></span><span class=line><span class=cl>POSIX message queues     <span class=o>(</span>bytes, -q<span class=o>)</span> <span class=m>819200</span>
</span></span><span class=line><span class=cl>real-time priority              <span class=o>(</span>-r<span class=o>)</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>stack size              <span class=o>(</span>kbytes, -s<span class=o>)</span> <span class=m>10240</span>
</span></span><span class=line><span class=cl>cpu <span class=nb>time</span>               <span class=o>(</span>seconds, -t<span class=o>)</span> unlimited
</span></span><span class=line><span class=cl>max user processes              <span class=o>(</span>-u<span class=o>)</span> <span class=m>65535</span>
</span></span><span class=line><span class=cl>virtual memory          <span class=o>(</span>kbytes, -v<span class=o>)</span> unlimited
</span></span><span class=line><span class=cl>file locks                      <span class=o>(</span>-x<span class=o>)</span> unlimited
</span></span></code></pre></td></tr></table></div></div><p>单个进程可以打开的最大文件数是 65536</p><h2 id=lsof-显示大量open-file><span class=section-num>2</span> lsof 显示大量open file<a hidden class=anchor aria-hidden=true href=#lsof-显示大量open-file>#</a></h2><p>按照Tomcat 给出的报错信息，登录87 这台服务器检查打开的文件数，发现打开的文件超过70000:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>lsof <span class=p>|</span>wc -l
</span></span><span class=line><span class=cl><span class=m>75924</span>
</span></span></code></pre></td></tr></table></div></div><p>然后找出打开文件数最多的进程，按文件数降序排列，左边是 open file 的数量，右边是进程ID：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>lsof -n<span class=p>|</span>awk <span class=s1>&#39;{print $2}&#39;</span><span class=p>|</span> sort <span class=p>|</span> uniq -c <span class=p>|</span> sort -nr <span class=p>|</span> head
</span></span><span class=line><span class=cl><span class=m>65966</span> <span class=m>25204</span>
</span></span><span class=line><span class=cl><span class=m>5374</span> <span class=m>20179</span>
</span></span><span class=line><span class=cl><span class=m>184</span> <span class=m>27275</span>
</span></span><span class=line><span class=cl><span class=m>65</span> <span class=m>5361</span>
</span></span><span class=line><span class=cl><span class=m>61</span> <span class=m>29421</span>
</span></span><span class=line><span class=cl><span class=m>16</span> <span class=m>22177</span>
</span></span><span class=line><span class=cl><span class=m>14</span> <span class=m>19751</span>
</span></span><span class=line><span class=cl><span class=m>12</span> <span class=m>22181</span>
</span></span><span class=line><span class=cl><span class=m>12</span> <span class=m>22179</span>
</span></span><span class=line><span class=cl><span class=m>12</span> <span class=m>22178</span>
</span></span></code></pre></td></tr></table></div></div><p>发现 <code>25204</code> 这个进程打开了大量的文件，已经超过了单个进程的最大文件数限制。而这个进程就是部署的java 应用对应的进程。打开的文件句柄数量已经超过Linux 限制，
Tomcat 无法创建新的socket 连接。</p><h2 id=can-t-identify-protocol><span class=section-num>3</span> can&rsquo;t identify protocol<a hidden class=anchor aria-hidden=true href=#can-t-identify-protocol>#</a></h2><p>用 lsof 查看 java 应用打开的文件的时候，发现有非常多奇怪的输出：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>java    <span class=m>25204</span> nemo *516u  sock                0,6       0t0 <span class=m>215137625</span> can<span class=s1>&#39;t identify protocol
</span></span></span><span class=line><span class=cl><span class=s1>java    25204 nemo *517u  sock                0,6       0t0 215137626 can&#39;</span>t identify protocol
</span></span><span class=line><span class=cl>java    <span class=m>25204</span> nemo *518u  sock                0,6       0t0 <span class=m>215137627</span> can<span class=s1>&#39;t identify protocol
</span></span></span><span class=line><span class=cl><span class=s1>java    25204 nemo *519u  sock                0,6       0t0 215137628 can&#39;</span>t identify protocol
</span></span><span class=line><span class=cl>java    <span class=m>25204</span> nemo *520u  sock                0,6       0t0 <span class=m>215137629</span> can<span class=s1>&#39;t identify protocol
</span></span></span><span class=line><span class=cl><span class=s1>java    25204 nemo *521u  sock                0,6       0t0 215137630 can&#39;</span>t identify protocol
</span></span><span class=line><span class=cl>java    <span class=m>25204</span> nemo *522u  sock                0,6       0t0 <span class=m>215137631</span> can<span class=s1>&#39;t identify protocol
</span></span></span><span class=line><span class=cl><span class=s1>java    25204 nemo *523u  sock                0,6       0t0 215137634 can&#39;</span>t identify protocol
</span></span><span class=line><span class=cl>java    <span class=m>25204</span> nemo *524u  sock                0,6       0t0 <span class=m>215137635</span> can<span class=s1>&#39;t identify protocol
</span></span></span><span class=line><span class=cl><span class=s1>java    25204 nemo *525u  sock                0,6       0t0 215137636 can&#39;</span>t identify protocol
</span></span><span class=line><span class=cl>java    <span class=m>25204</span> nemo *526u  sock                0,6       0t0 <span class=m>215137637</span> can<span class=s1>&#39;t identify protocol
</span></span></span><span class=line><span class=cl><span class=s1>java    25204 nemo *527u  sock                0,6       0t0 215137638 can&#39;</span>t identify protocol
</span></span><span class=line><span class=cl>java    <span class=m>25204</span> nemo *528u  sock                0,6       0t0 <span class=m>215137639</span> can<span class=s1>&#39;t identify protocol
</span></span></span><span class=line><span class=cl><span class=s1>java    25204 nemo *529u  sock                0,6       0t0 215137640 can&#39;</span>t identify protocol
</span></span><span class=line><span class=cl>java    <span class=m>25204</span> nemo *530u  sock                0,6       0t0 <span class=m>215137641</span> can<span class=s1>&#39;t identify protocol
</span></span></span><span class=line><span class=cl><span class=s1>java    25204 nemo *531u  sock                0,6       0t0 215137642 can&#39;</span>t identify protocol
</span></span><span class=line><span class=cl>java    <span class=m>25204</span> nemo *532u  sock                0,6       0t0 <span class=m>215137644</span> can<span class=s1>&#39;t identify protocol
</span></span></span><span class=line><span class=cl><span class=s1>java    25204 nemo *533u  sock                0,6       0t0 215137646 can&#39;</span>t identify protocol
</span></span></code></pre></td></tr></table></div></div><p>统计之后发现， <code>can't identify protocol</code> 这样的文件数量非常多：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>lsof -p 25204<span class=p>|</span>grep <span class=s2>&#34;can&#39;t identify protocol&#34;</span><span class=p>|</span>wc -l
</span></span><span class=line><span class=cl><span class=m>64214</span>
</span></span></code></pre></td></tr></table></div></div><p>也就是大部份打开的文件都是属于 <code>cant' identify protocol</code> 的文件。</p><h2 id=问题定位><span class=section-num>4</span> 问题定位<a hidden class=anchor aria-hidden=true href=#问题定位>#</a></h2><p>Google 搜索之后发现，这个 <code>cant' identify protocol</code> 的东东出现的原因是因为 这些
sockets 处于 <code>CLOSED</code> 的状态，但是却没有真正close 掉，正处于 <code>half-close</code> 状态。因此，如果使用 <code>netstat</code> 来查看socket 状态，是不会显示这些 <code>half-close</code>的 socket 的：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>netstat  -nat <span class=p>|</span>wc -l
</span></span><span class=line><span class=cl><span class=m>881</span>
</span></span></code></pre></td></tr></table></div></div><p>使用 <code>netstat</code> 的改进版本 <code>ss</code> 就能发现大量处于 <code>Closed</code> 状态的 socket:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>ss -s
</span></span><span class=line><span class=cl>Total: <span class=m>76052</span> <span class=o>(</span>kernel 76254<span class=o>)</span>
</span></span><span class=line><span class=cl>TCP:   <span class=m>75924</span> <span class=o>(</span>estab 123, closed 75524, orphaned 0, synrecv 0, timewait 173/0<span class=o>)</span>, ports <span class=m>104</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Transport Total     IP        IPv6
</span></span><span class=line><span class=cl>*         <span class=m>76254</span>    -         -
</span></span><span class=line><span class=cl>RAW       <span class=m>0</span>         <span class=m>0</span>         <span class=m>0</span>
</span></span><span class=line><span class=cl>UDP       <span class=m>9</span>         <span class=m>6</span>         <span class=m>3</span>
</span></span><span class=line><span class=cl>TCP       <span class=m>116</span>       <span class=m>80</span>        <span class=m>36</span>
</span></span><span class=line><span class=cl>INET      <span class=m>125</span>       <span class=m>86</span>        <span class=m>39</span>
</span></span><span class=line><span class=cl>FRAG      <span class=m>0</span>         <span class=m>0</span>         <span class=m>0</span>
</span></span></code></pre></td></tr></table></div></div><p>接着查看内核的 socket 情况：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>cat /proc/net/sockstat
</span></span><span class=line><span class=cl>sockets: used <span class=m>75724</span>
</span></span><span class=line><span class=cl>TCP: inuse <span class=m>886</span> orphan <span class=m>0</span> tw <span class=m>0</span> alloc <span class=m>72134</span> mem <span class=m>222</span>
</span></span><span class=line><span class=cl>UDP: inuse <span class=m>5</span> mem <span class=m>0</span>
</span></span><span class=line><span class=cl>UDPLITE: inuse <span class=m>0</span>
</span></span><span class=line><span class=cl>RAW: inuse <span class=m>0</span>
</span></span><span class=line><span class=cl>FRAG: inuse <span class=m>0</span> memory <span class=m>0</span>
</span></span></code></pre></td></tr></table></div></div><p>很多的 socket 处于 <code>alloc</code>, 只有少量的 socket 处于 <code>inuse</code>. 可以确认是 java 应用出现了 socket fd 的泄漏。 但是为什么会有那么多的socket 泄漏呢？</p><h2 id=大胆假设><span class=section-num>5</span> 大胆假设<a hidden class=anchor aria-hidden=true href=#大胆假设>#</a></h2><p>现在可以确定的是 java应用出现了问题，导致了socket 泄漏，让 Tomcat 无法建立新连接，最终宕机。既然导致问题出现的是 java 应用，那么就应该去检查应用日志。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>2018-04-09 17:41:31,491 - [ERROR] - from com.alibaba.druid.pool.DruidDataSource in Druid-ConnectionPool-CreateScheduler--4-thread-214
</span></span><span class=line><span class=cl>create connection error, url: jdbc:mysql://test-server-host:3306/db_name?readOnlyPropagatesToServer=false&amp;rewriteBatchedStatements=true&amp;failOverReadOnly=false&amp;socketTimeout=6000&amp;connectTimeout=20000&amp;zeroDateTimeBehavior=convertToNull&amp;allowMultiQueries=true&amp;characterEncoding=utf-8&amp;autoReconnect=true
</span></span><span class=line><span class=cl>com.mysql.jdbc.exceptions.jdbc4.MySQLNonTransientConnectionException: Could not create connection to database server. Attempted reconnect 3 times. Giving up.
</span></span><span class=line><span class=cl>at sun.reflect.GeneratedConstructorAccessor169.newInstance(Unknown Source)
</span></span><span class=line><span class=cl>at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)
</span></span><span class=line><span class=cl>at java.lang.reflect.Constructor.newInstance(Constructor.java:423)
</span></span><span class=line><span class=cl>at com.mysql.jdbc.Util.handleNewInstance(Util.java:425)
</span></span><span class=line><span class=cl>at com.mysql.jdbc.Util.getInstance(Util.java:408)
</span></span><span class=line><span class=cl>at com.mysql.jdbc.SQLError.createSQLException(SQLError.java:918)
</span></span><span class=line><span class=cl>at com.mysql.jdbc.SQLError.createSQLException(SQLError.java:897)
</span></span><span class=line><span class=cl>at com.mysql.jdbc.SQLError.createSQLException(SQLError.java:886)
</span></span><span class=line><span class=cl>at com.mysql.jdbc.SQLError.createSQLException(SQLError.java:860)
</span></span><span class=line><span class=cl>at com.mysql.jdbc.ConnectionImpl.connectWithRetries(ConnectionImpl.java:2163)
</span></span><span class=line><span class=cl>at com.mysql.jdbc.ConnectionImpl.createNewIO(ConnectionImpl.java:2088)
</span></span><span class=line><span class=cl>at com.mysql.jdbc.ConnectionImpl.&lt;init&gt;(ConnectionImpl.java:806)
</span></span><span class=line><span class=cl>at com.mysql.jdbc.JDBC4Connection.&lt;init&gt;(JDBC4Connection.java:47)
</span></span><span class=line><span class=cl>at sun.reflect.GeneratedConstructorAccessor152.newInstance(Unknown Source)
</span></span><span class=line><span class=cl>at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)
</span></span><span class=line><span class=cl>at java.lang.reflect.Constructor.newInstance(Constructor.java:423)
</span></span><span class=line><span class=cl>at com.mysql.jdbc.Util.handleNewInstance(Util.java:425)
</span></span><span class=line><span class=cl>at com.mysql.jdbc.ConnectionImpl.getInstance(ConnectionImpl.java:410)
</span></span><span class=line><span class=cl>at com.mysql.jdbc.NonRegisteringDriver.connect(NonRegisteringDriver.java:328)
</span></span><span class=line><span class=cl>at com.alibaba.druid.filter.FilterChainImpl.connection_connect(FilterChainImpl.java:148)
</span></span><span class=line><span class=cl>at com.alibaba.druid.filter.stat.StatFilter.connection_connect(StatFilter.java:211)
</span></span><span class=line><span class=cl>at com.alibaba.druid.filter.FilterChainImpl.connection_connect(FilterChainImpl.java:142)
</span></span><span class=line><span class=cl>at com.alibaba.druid.pool.DruidAbstractDataSource.createPhysicalConnection(DruidAbstractDataSource.java:1423)
</span></span><span class=line><span class=cl>at com.alibaba.druid.pool.DruidAbstractDataSource.createPhysicalConnection(DruidAbstractDataSource.java:1477)
</span></span><span class=line><span class=cl>at com.alibaba.druid.pool.DruidDataSource$CreateConnectionTask.runInternal(DruidDataSource.java:1884)
</span></span><span class=line><span class=cl>at com.alibaba.druid.pool.DruidDataSource$CreateConnectionTask.run(DruidDataSource.java:1849)
</span></span><span class=line><span class=cl>at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
</span></span><span class=line><span class=cl>at java.util.concurrent.FutureTask.run(FutureTask.java:266)
</span></span><span class=line><span class=cl>at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
</span></span><span class=line><span class=cl>at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
</span></span><span class=line><span class=cl>at java.lang.Thread.run(Thread.java:745)
</span></span><span class=line><span class=cl>Caused by: com.mysql.jdbc.exceptions.jdbc4.CommunicationsException: Communications link failure
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>The last packet sent successfully to the server was 0 milliseconds ago. The driver has not received any packets from the server.
</span></span><span class=line><span class=cl>at sun.reflect.GeneratedConstructorAccessor157.newInstance(Unknown Source)
</span></span><span class=line><span class=cl>at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)
</span></span><span class=line><span class=cl>at java.lang.reflect.Constructor.newInstance(Constructor.java:423)
</span></span><span class=line><span class=cl>at com.mysql.jdbc.Util.handleNewInstance(Util.java:425)
</span></span><span class=line><span class=cl>at com.mysql.jdbc.SQLError.createCommunicationsException(SQLError.java:989)
</span></span><span class=line><span class=cl>at com.mysql.jdbc.MysqlIO.&lt;init&gt;(MysqlIO.java:341)
</span></span><span class=line><span class=cl>at com.mysql.jdbc.ConnectionImpl.coreConnect(ConnectionImpl.java:2251)
</span></span><span class=line><span class=cl>at com.mysql.jdbc.ConnectionImpl.connectWithRetries(ConnectionImpl.java:2104)
</span></span><span class=line><span class=cl>... 21 common frames omitted
</span></span><span class=line><span class=cl>Caused by: java.net.SocketException: Too many open files
</span></span><span class=line><span class=cl>at java.net.Socket.createImpl(Socket.java:460)
</span></span><span class=line><span class=cl>at java.net.Socket.getImpl(Socket.java:520)
</span></span><span class=line><span class=cl>at java.net.Socket.setTcpNoDelay(Socket.java:980)
</span></span><span class=line><span class=cl>at com.mysql.jdbc.StandardSocketFactory.configureSocket(StandardSocketFactory.java:132)
</span></span><span class=line><span class=cl>at com.mysql.jdbc.StandardSocketFactory.connect(StandardSocketFactory.java:203)
</span></span><span class=line><span class=cl>at com.mysql.jdbc.MysqlIO.&lt;init&gt;(MysqlIO.java:300)
</span></span><span class=line><span class=cl>... 23 common frames omitted
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>2018-04-09 17:41:31,568 - [ERROR] - from org.apache.tomcat.util.net.NioEndpoint in http-nio-47001-Acceptor-0
</span></span><span class=line><span class=cl>Socket accept failed
</span></span><span class=line><span class=cl>java.io.IOException: Too many open files
</span></span><span class=line><span class=cl>at sun.nio.ch.ServerSocketChannelImpl.accept0(Native Method)
</span></span><span class=line><span class=cl>at sun.nio.ch.ServerSocketChannelImpl.accept(ServerSocketChannelImpl.java:422)
</span></span><span class=line><span class=cl>at sun.nio.ch.ServerSocketChannelImpl.accept(ServerSocketChannelImpl.java:250)
</span></span><span class=line><span class=cl>at org.apache.tomcat.util.net.NioEndpoint$Acceptor.run(NioEndpoint.java:825)
</span></span><span class=line><span class=cl>at java.lang.Thread.run(Thread.java:745)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>2018-04-09 17:41:33,168 - [ERROR] - from org.apache.tomcat.util.net.NioEndpoint in http-nio-47001-Acceptor-0
</span></span><span class=line><span class=cl>Socket accept failed
</span></span><span class=line><span class=cl>java.io.IOException: Too many open files
</span></span><span class=line><span class=cl>at sun.nio.ch.ServerSocketChannelImpl.accept0(Native Method)
</span></span><span class=line><span class=cl>at sun.nio.ch.ServerSocketChannelImpl.accept(ServerSocketChannelImpl.java:422)
</span></span><span class=line><span class=cl>at sun.nio.ch.ServerSocketChannelImpl.accept(ServerSocketChannelImpl.java:250)
</span></span><span class=line><span class=cl>at org.apache.tomcat.util.net.NioEndpoint$Acceptor.run(NioEndpoint.java:825)
</span></span><span class=line><span class=cl>at java.lang.Thread.run(Thread.java:745)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>2018-04-09 17:41:34,470 - [ERROR] - from com.alibaba.druid.pool.DruidDataSource in Druid-ConnectionPool-CreateScheduler--4-thread-216
</span></span><span class=line><span class=cl>create connection error, url: jdbc:mysql://test-server-url:3306/db_name?readOnlyPropagatesToServer=false&amp;rewriteBatchedStatements=true&amp;failOverReadOnly=false&amp;socketTimeout=6000&amp;connectTimeout=20000&amp;zeroDateTimeBehavior=convertToNull&amp;allowMultiQueries=true&amp;characterEncoding=utf-8&amp;autoReconnect=true
</span></span><span class=line><span class=cl>com.mysql.jdbc.exceptions.jdbc4.MySQLNonTransientConnectionException: Could not create connection to database server. Attempted reconnect 3 times. Giving up.
</span></span><span class=line><span class=cl>at sun.reflect.GeneratedConstructorAccessor169.newInstance(Unknown Source)
</span></span><span class=line><span class=cl>at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)
</span></span><span class=line><span class=cl>at java.lang.reflect.Constructor.newInstance(Constructor.java:423)
</span></span><span class=line><span class=cl>at com.mysql.jdbc.Util.handleNewInstance(Util.java:425)
</span></span><span class=line><span class=cl>at com.mysql.jdbc.Util.getInstance(Util.java:408)
</span></span><span class=line><span class=cl>at com.mysql.jdbc.SQLError.createSQLException(SQLError.java:918)
</span></span><span class=line><span class=cl>at com.mysql.jdbc.SQLError.createSQLException(SQLError.java:897)
</span></span><span class=line><span class=cl>at com.mysql.jdbc.SQLError.createSQLException(SQLError.java:886)
</span></span><span class=line><span class=cl>at com.mysql.jdbc.SQLError.createSQLException(SQLError.java:860)
</span></span><span class=line><span class=cl>at com.mysql.jdbc.ConnectionImpl.connectWithRetries(ConnectionImpl.java:2163)
</span></span><span class=line><span class=cl>at com.mysql.jdbc.ConnectionImpl.createNewIO(ConnectionImpl.java:2088)
</span></span><span class=line><span class=cl>at com.mysql.jdbc.ConnectionImpl.&lt;init&gt;(ConnectionImpl.java:806)
</span></span><span class=line><span class=cl>at com.mysql.jdbc.JDBC4Connection.&lt;init&gt;(JDBC4Connection.java:47)
</span></span><span class=line><span class=cl>at sun.reflect.GeneratedConstructorAccessor152.newInstance(Unknown Source)
</span></span><span class=line><span class=cl>at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)
</span></span><span class=line><span class=cl>at java.lang.reflect.Constructor.newInstance(Constructor.java:423)
</span></span><span class=line><span class=cl>at com.mysql.jdbc.Util.handleNewInstance(Util.java:425)
</span></span><span class=line><span class=cl>at com.mysql.jdbc.ConnectionImpl.getInstance(ConnectionImpl.java:410)
</span></span><span class=line><span class=cl>at com.mysql.jdbc.NonRegisteringDriver.connect(NonRegisteringDriver.java:328)
</span></span><span class=line><span class=cl>at com.alibaba.druid.filter.FilterChainImpl.connection_connect(FilterChainImpl.java:148)
</span></span><span class=line><span class=cl>at com.alibaba.druid.filter.stat.StatFilter.connection_connect(StatFilter.java:211)
</span></span><span class=line><span class=cl>at com.alibaba.druid.filter.FilterChainImpl.connection_connect(FilterChainImpl.java:142)
</span></span><span class=line><span class=cl>at com.alibaba.druid.pool.DruidAbstractDataSource.createPhysicalConnection(DruidAbstractDataSource.java:1423)
</span></span><span class=line><span class=cl>at com.alibaba.druid.pool.DruidAbstractDataSource.createPhysicalConnection(DruidAbstractDataSource.java:1477)
</span></span><span class=line><span class=cl>at com.alibaba.druid.pool.DruidDataSource$CreateConnectionTask.runInternal(DruidDataSource.java:1884)
</span></span><span class=line><span class=cl>at com.alibaba.druid.pool.DruidDataSource$CreateConnectionTask.run(DruidDataSource.java:1849)
</span></span><span class=line><span class=cl>at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
</span></span><span class=line><span class=cl>at java.util.concurrent.FutureTask.run(FutureTask.java:266)
</span></span><span class=line><span class=cl>at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$201(ScheduledThreadPoolExecutor.java:180)
</span></span><span class=line><span class=cl>at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:293)
</span></span><span class=line><span class=cl>at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
</span></span><span class=line><span class=cl>at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
</span></span><span class=line><span class=cl>at java.lang.Thread.run(Thread.java:745)
</span></span><span class=line><span class=cl>Caused by: com.mysql.jdbc.exceptions.jdbc4.CommunicationsException: Communications link failure
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>The last packet sent successfully to the server was 0 milliseconds ago. The driver has not received any packets from the server.
</span></span><span class=line><span class=cl>at sun.reflect.GeneratedConstructorAccessor157.newInstance(Unknown Source)
</span></span><span class=line><span class=cl>at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)
</span></span><span class=line><span class=cl>at java.lang.reflect.Constructor.newInstance(Constructor.java:423)
</span></span><span class=line><span class=cl>at com.mysql.jdbc.Util.handleNewInstance(Util.java:425)
</span></span><span class=line><span class=cl>at com.mysql.jdbc.SQLError.createCommunicationsException(SQLError.java:989)
</span></span><span class=line><span class=cl>at com.mysql.jdbc.MysqlIO.&lt;init&gt;(MysqlIO.java:341)
</span></span><span class=line><span class=cl>at com.mysql.jdbc.ConnectionImpl.coreConnect(ConnectionImpl.java:2251)
</span></span><span class=line><span class=cl>at com.mysql.jdbc.ConnectionImpl.connectWithRetries(ConnectionImpl.java:2104)
</span></span><span class=line><span class=cl>... 23 common frames omitted
</span></span><span class=line><span class=cl>Caused by: java.net.SocketException: Too many open files
</span></span><span class=line><span class=cl>at java.net.Socket.createImpl(Socket.java:460)
</span></span><span class=line><span class=cl>at java.net.Socket.getImpl(Socket.java:520)
</span></span><span class=line><span class=cl>at java.net.Socket.setTcpNoDelay(Socket.java:980)
</span></span><span class=line><span class=cl>at com.mysql.jdbc.StandardSocketFactory.configureSocket(StandardSocketFactory.java:132)
</span></span><span class=line><span class=cl>at com.mysql.jdbc.StandardSocketFactory.connect(StandardSocketFactory.java:203)
</span></span><span class=line><span class=cl>at com.mysql.jdbc.MysqlIO.&lt;init&gt;(MysqlIO.java:300)
</span></span><span class=line><span class=cl>... 25 common frames omitted
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>2018-04-09 17:41:34,769 - [ERROR] - from org.apache.tomcat.util.net.NioEndpoint in http-nio-47001-Acceptor-0
</span></span><span class=line><span class=cl>Socket accept failed
</span></span><span class=line><span class=cl>java.io.IOException: Too many open files
</span></span><span class=line><span class=cl>at sun.nio.ch.ServerSocketChannelImpl.accept0(Native Method)
</span></span><span class=line><span class=cl>at sun.nio.ch.ServerSocketChannelImpl.accept(ServerSocketChannelImpl.java:422)
</span></span><span class=line><span class=cl>at sun.nio.ch.ServerSocketChannelImpl.accept(ServerSocketChannelImpl.java:250)
</span></span><span class=line><span class=cl>at org.apache.tomcat.util.net.NioEndpoint$Acceptor.run(NioEndpoint.java:825)
</span></span><span class=line><span class=cl>at java.lang.Thread.run(Thread.java:745)
</span></span></code></pre></td></tr></table></div></div><p>检查日志发现，在 Tomcat 彻底挂机之前，曾经有比较大量的数据源连接池出错，无法访问 Mysql, 但是非常奇怪的是，在87 这台机器上面，是可以使用 mysql 命令行连接到测试数据库的，说明 Mysql 的连接是没有问题。</p><p>但是数据源连接就会出错！！ 真的是很奇怪，为什么连接池会报错，有没有可能是这些异常导致 socket 泄漏呢？后来，在本地运行应用，有时候会发现IDE 的控制台报错：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span><span class=lnt>92
</span><span class=lnt>93
</span><span class=lnt>94
</span><span class=lnt>95
</span><span class=lnt>96
</span><span class=lnt>97
</span><span class=lnt>98
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>2018-04-11 09:43:48,363 - [ERROR] - from com.alibaba.druid.pool.DruidDataSource in poolTaskScheduler-11
</span></span><span class=line><span class=cl>discard connection
</span></span><span class=line><span class=cl>com.mysql.jdbc.exceptions.jdbc4.CommunicationsException: Communications link failure
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>The last packet successfully received from the server was 100,610 milliseconds ago.  The last packet sent successfully to the server was 0 milliseconds ago.
</span></span><span class=line><span class=cl>at sun.reflect.GeneratedConstructorAccessor108.newInstance(Unknown Source)
</span></span><span class=line><span class=cl>at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)
</span></span><span class=line><span class=cl>at java.lang.reflect.Constructor.newInstance(Constructor.java:423)
</span></span><span class=line><span class=cl>at com.mysql.jdbc.Util.handleNewInstance(Util.java:425)
</span></span><span class=line><span class=cl>at com.mysql.jdbc.SQLError.createCommunicationsException(SQLError.java:989)
</span></span><span class=line><span class=cl>at com.mysql.jdbc.MysqlIO.reuseAndReadPacket(MysqlIO.java:3556)
</span></span><span class=line><span class=cl>at com.mysql.jdbc.MysqlIO.reuseAndReadPacket(MysqlIO.java:3456)
</span></span><span class=line><span class=cl>at com.mysql.jdbc.MysqlIO.checkErrorPacket(MysqlIO.java:3897)
</span></span><span class=line><span class=cl>at com.mysql.jdbc.MysqlIO.sendCommand(MysqlIO.java:2524)
</span></span><span class=line><span class=cl>at com.mysql.jdbc.MysqlIO.sqlQueryDirect(MysqlIO.java:2677)
</span></span><span class=line><span class=cl>at com.mysql.jdbc.ConnectionImpl.execSQL(ConnectionImpl.java:2545)
</span></span><span class=line><span class=cl>at com.mysql.jdbc.ConnectionImpl.execSQL(ConnectionImpl.java:2503)
</span></span><span class=line><span class=cl>at com.mysql.jdbc.StatementImpl.executeQuery(StatementImpl.java:1369)
</span></span><span class=line><span class=cl>at com.alibaba.druid.filter.FilterChainImpl.statement_executeQuery(FilterChainImpl.java:2363)
</span></span><span class=line><span class=cl>at com.alibaba.druid.filter.FilterAdapter.statement_executeQuery(FilterAdapter.java:2481)
</span></span><span class=line><span class=cl>at com.alibaba.druid.filter.FilterEventAdapter.statement_executeQuery(FilterEventAdapter.java:302)
</span></span><span class=line><span class=cl>at com.alibaba.druid.filter.FilterChainImpl.statement_executeQuery(FilterChainImpl.java:2360)
</span></span><span class=line><span class=cl>at com.alibaba.druid.proxy.jdbc.StatementProxyImpl.executeQuery(StatementProxyImpl.java:211)
</span></span><span class=line><span class=cl>at com.alibaba.druid.pool.DruidPooledStatement.executeQuery(DruidPooledStatement.java:138)
</span></span><span class=line><span class=cl>at com.taobao.tddl.atom.jdbc.TStatementWrapper.executeQuery(TStatementWrapper.java:315)
</span></span><span class=line><span class=cl>at com.taobao.tddl.group.jdbc.TGroupStatement.executeQueryOnConnection(TGroupStatement.java:549)
</span></span><span class=line><span class=cl>at com.taobao.tddl.group.jdbc.TGroupStatement$4.tryOnDataSource(TGroupStatement.java:633)
</span></span><span class=line><span class=cl>at com.taobao.tddl.group.jdbc.TGroupStatement$4.tryOnDataSource(TGroupStatement.java:615)
</span></span><span class=line><span class=cl>at com.taobao.tddl.group.dbselector.AbstractDBSelector.tryOnDataSourceHolder(AbstractDBSelector.java:155)
</span></span><span class=line><span class=cl>at com.taobao.tddl.group.dbselector.OneDBSelector.tryExecuteInternal(OneDBSelector.java:52)
</span></span><span class=line><span class=cl>at com.taobao.tddl.group.dbselector.AbstractDBSelector.tryExecute(AbstractDBSelector.java:405)
</span></span><span class=line><span class=cl>at com.taobao.tddl.group.dbselector.AbstractDBSelector.tryExecute(AbstractDBSelector.java:412)
</span></span><span class=line><span class=cl>at com.taobao.tddl.group.jdbc.TGroupStatement.executeQuery(TGroupStatement.java:488)
</span></span><span class=line><span class=cl>at com.taobao.tddl.group.jdbc.TGroupStatement.executeInternal(TGroupStatement.java:131)
</span></span><span class=line><span class=cl>at com.taobao.tddl.group.jdbc.TGroupStatement.execute(TGroupStatement.java:101)
</span></span><span class=line><span class=cl>at com.taobao.tddl.repo.mysql.spi.My_JdbcHandler.executeQuery(My_JdbcHandler.java:521)
</span></span><span class=line><span class=cl>at com.taobao.tddl.repo.mysql.spi.My_Cursor.init(My_Cursor.java:106)
</span></span><span class=line><span class=cl>at com.taobao.tddl.repo.mysql.handler.QueryMyHandler.handle(QueryMyHandler.java:89)
</span></span><span class=line><span class=cl>at com.taobao.tddl.executor.AbstractGroupExecutor.executeInner(AbstractGroupExecutor.java:47)
</span></span><span class=line><span class=cl>at com.taobao.tddl.executor.AbstractGroupExecutor.execByExecPlanNode(AbstractGroupExecutor.java:36)
</span></span><span class=line><span class=cl>at com.taobao.tddl.executor.TopologyExecutor.execByExecPlanNode(TopologyExecutor.java:66)
</span></span><span class=line><span class=cl>at com.taobao.tddl.executor.MatrixExecutor.execByExecPlanNodeByOne(MatrixExecutor.java:670)
</span></span><span class=line><span class=cl>at com.taobao.tddl.executor.MatrixExecutor.execByExecPlanNode(MatrixExecutor.java:659)
</span></span><span class=line><span class=cl>at com.taobao.tddl.executor.MatrixExecutor.execute(MatrixExecutor.java:137)
</span></span><span class=line><span class=cl>at com.taobao.tddl.matrix.jdbc.TConnection.executeSQL(TConnection.java:241)
</span></span><span class=line><span class=cl>at com.taobao.tddl.matrix.jdbc.TPreparedStatement.executeSQL(TPreparedStatement.java:64)
</span></span><span class=line><span class=cl>at com.taobao.tddl.matrix.jdbc.TStatement.executeInternal(TStatement.java:133)
</span></span><span class=line><span class=cl>at com.taobao.tddl.matrix.jdbc.TPreparedStatement.execute(TPreparedStatement.java:49)
</span></span><span class=line><span class=cl>at sun.reflect.GeneratedMethodAccessor148.invoke(Unknown Source)
</span></span><span class=line><span class=cl>at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
</span></span><span class=line><span class=cl>at java.lang.reflect.Method.invoke(Method.java:498)
</span></span><span class=line><span class=cl>at org.apache.ibatis.logging.jdbc.PreparedStatementLogger.invoke(PreparedStatementLogger.java:59)
</span></span><span class=line><span class=cl>at com.sun.proxy.$Proxy102.execute(Unknown Source)
</span></span><span class=line><span class=cl>at org.apache.ibatis.executor.statement.PreparedStatementHandler.query(PreparedStatementHandler.java:63)
</span></span><span class=line><span class=cl>at org.apache.ibatis.executor.statement.RoutingStatementHandler.query(RoutingStatementHandler.java:79)
</span></span><span class=line><span class=cl>at org.apache.ibatis.executor.SimpleExecutor.doQuery(SimpleExecutor.java:63)
</span></span><span class=line><span class=cl>at org.apache.ibatis.executor.BaseExecutor.queryFromDatabase(BaseExecutor.java:325)
</span></span><span class=line><span class=cl>at org.apache.ibatis.executor.BaseExecutor.query(BaseExecutor.java:156)
</span></span><span class=line><span class=cl>at org.apache.ibatis.executor.CachingExecutor.query(CachingExecutor.java:109)
</span></span><span class=line><span class=cl>at org.apache.ibatis.executor.CachingExecutor.query(CachingExecutor.java:83)
</span></span><span class=line><span class=cl>at sun.reflect.GeneratedMethodAccessor146.invoke(Unknown Source)
</span></span><span class=line><span class=cl>at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
</span></span><span class=line><span class=cl>at java.lang.reflect.Method.invoke(Method.java:498)
</span></span><span class=line><span class=cl>at org.apache.ibatis.plugin.Invocation.proceed(Invocation.java:49)
</span></span><span class=line><span class=cl>at fastfish.interceptor.DbLogInterceptor.intercept(DbLogInterceptor.java:49)
</span></span><span class=line><span class=cl>at org.apache.ibatis.plugin.Plugin.invoke(Plugin.java:61)
</span></span><span class=line><span class=cl>at com.sun.proxy.$Proxy100.query(Unknown Source)
</span></span><span class=line><span class=cl>at org.apache.ibatis.session.defaults.DefaultSqlSession.selectList(DefaultSqlSession.java:148)
</span></span><span class=line><span class=cl>at org.apache.ibatis.session.defaults.DefaultSqlSession.selectList(DefaultSqlSession.java:141)
</span></span><span class=line><span class=cl>at sun.reflect.GeneratedMethodAccessor145.invoke(Unknown Source)
</span></span><span class=line><span class=cl>at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
</span></span><span class=line><span class=cl>at java.lang.reflect.Method.invoke(Method.java:498)
</span></span><span class=line><span class=cl>at org.mybatis.spring.SqlSessionTemplate$SqlSessionInterceptor.invoke(SqlSessionTemplate.java:434)
</span></span><span class=line><span class=cl>at com.sun.proxy.$Proxy87.selectList(Unknown Source)
</span></span><span class=line><span class=cl>at org.mybatis.spring.SqlSessionTemplate.selectList(SqlSessionTemplate.java:231)
</span></span><span class=line><span class=cl>at org.apache.ibatis.binding.MapperMethod.executeForMany(MapperMethod.java:128)
</span></span><span class=line><span class=cl>at org.apache.ibatis.binding.MapperMethod.execute(MapperMethod.java:68)
</span></span><span class=line><span class=cl>at org.apache.ibatis.binding.MapperProxy.invoke(MapperProxy.java:53)
</span></span><span class=line><span class=cl>at com.sun.proxy.$Proxy124.selectAll(Unknown Source)
</span></span><span class=line><span class=cl>at fastfish.services.BusinessService.getAll(BusinessService.java:73)
</span></span><span class=line><span class=cl>at fastfish.services.BusinessService.loadDB(BusinessService.java:38)
</span></span><span class=line><span class=cl>at sun.reflect.GeneratedMethodAccessor190.invoke(Unknown Source)
</span></span><span class=line><span class=cl>at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
</span></span><span class=line><span class=cl>at java.lang.reflect.Method.invoke(Method.java:498)
</span></span><span class=line><span class=cl>at org.springframework.scheduling.support.ScheduledMethodRunnable.run(ScheduledMethodRunnable.java:65)
</span></span><span class=line><span class=cl>at org.springframework.scheduling.support.DelegatingErrorHandlingRunnable.run(DelegatingErrorHandlingRunnable.java:54)
</span></span><span class=line><span class=cl>at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
</span></span><span class=line><span class=cl>at java.util.concurrent.FutureTask.runAndReset$$$capture(FutureTask.java:308)
</span></span><span class=line><span class=cl>at java.util.concurrent.FutureTask.runAndReset(FutureTask.java)
</span></span><span class=line><span class=cl>at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$301(ScheduledThreadPoolExecutor.java:180)
</span></span><span class=line><span class=cl>at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:294)
</span></span><span class=line><span class=cl>at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
</span></span><span class=line><span class=cl>at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
</span></span><span class=line><span class=cl>at java.lang.Thread.run(Thread.java:748)
</span></span><span class=line><span class=cl>Caused by: java.io.EOFException: Can not read response from server. Expected to read 4 bytes, read 0 bytes before connection was unexpectedly lost.
</span></span><span class=line><span class=cl>at com.mysql.jdbc.MysqlIO.readFully(MysqlIO.java:3008)
</span></span><span class=line><span class=cl>at com.mysql.jdbc.MysqlIO.reuseAndReadPacket(MysqlIO.java:3466)
</span></span><span class=line><span class=cl>... 83 common frames omitted
</span></span></code></pre></td></tr></table></div></div><p>是数据池连接出错。但是我本地的应用确实是可以访问测试数据库的， 比较有趣的异常就是</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Caused by: java.io.EOFException: Can not read response from server. Expected to read 4 bytes, read 0 bytes before connection was unexpectedly lost.
</span></span></code></pre></td></tr></table></div></div><p>数据还没有读完， Connection 就丢了。为什么会 lost connection 呢，可能数据库出问题，也可能是网络出了问题。</p><p>我还能从数据库读到数据，说明数据库没问题的，兼之这个异常只是偶尔出现，所以可能就是网络出问题了。</p><p>如此说来，是否可能是因为测试环境网络不稳定，连接池无法和 Mysql 保持连接，在丢掉 Connection 之后，连接池重新发起连接，但是因为网络不稳定又丢掉了Connection, 不断循环这个过程，导致建立的 socket 连接越 来越多，但是建立的 socket 很快就被Close 掉了，内核又没有把这些 Close 掉的 socket 资源回收掉，因此打开的 socket 文件越来越多，最后导致 Tomcat 因为打开的文件过多无法建立新的 socket 连接。</p><h2 id=小心求证><span class=section-num>6</span> 小心求证<a hidden class=anchor aria-hidden=true href=#小心求证>#</a></h2><p>如果连接池真的不断尝试连接Mysql 的话，必定会建立很多的连接，而Mysql 是会将这些记录保存下来的，检查Mysql 的变量：</p><figure><img loading=lazy src=https://imgur.com/gAxepYH.png></figure><p>查看Mysql 的文档关于 <code>Connection</code> 和 <code>Thread_connected</code> 的说明：</p><ul><li><p>Connections</p><blockquote><p>The number of connection attempts (successful or not) to the MySQL server.</p></blockquote></li><li><p>Threads_connected</p><blockquote><p>The number of currently open connections.</p></blockquote></li></ul><p>也就是说，当时共有20000 多的连接请求，但是真正被 Mysql accpet 并且服务的只有 28 个连接。看来的确是因为连接池的连接导致 socket 泄漏</p><h3 id=更新><span class=section-num>6.1</span> 更新<a hidden class=anchor aria-hidden=true href=#更新>#</a></h3><p>和运维同学沟通之后，发现丢连接的原因不是网络不稳定，而是测试集群都是虚拟机，内存 用光，导致无法建立新的连接，内核释放一部分资源之后又可以建立连接了。内存用完，我能怎么办，我也很无奈。</p><h2 id=解决方法><span class=section-num>7</span> 解决方法<a hidden class=anchor aria-hidden=true href=#解决方法>#</a></h2><p>虽说基本确定了 socket 泄漏的源头，但是对于内核为什么无法回收已经关闭 socket 的原因依然不明确。</p><p>最令人百思不得其解的是，部署了应用的测试服务器有两台，另外一 台服务器也有同样的连接池问题，但是却没有出现 socket 泄漏问题， 出现泄漏的只有 87 这台机器。真的令人费解. 所以最后解决方法就是撤下 87 服务器的应用，换一台服务器来部署。</p><p>新的服务器部署应用之后虽说也有同样的数据库连接池异常，但是却没有出现 socket 泄漏，初步定位是 87这台机器的内核环境存在问题。</p><h2 id=参考><span class=section-num>8</span> 参考<a hidden class=anchor aria-hidden=true href=#参考>#</a></h2><ul><li><a href=http://mdba.cn/2015/03/10/tcp-socket%E6%96%87%E4%BB%B6%E5%8F%A5%E6%9F%84%E6%B3%84%E6%BC%8F/>tcp-socket文件句柄泄漏/</a></li><li><a href=https://idea.popcount.org/2012-12-09-lsof-cant-identify-protocol/>lsof-cant-identify-protocol/</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://ramsayleung.github.io/zh/tags/linux/>linux</a></li></ul><nav class=paginav><a class=prev href=https://ramsayleung.github.io/zh/post/2018/farewell_to_my_university_time/><span class=title>« 上一页</span><br><span>恰同学少年</span></a>
<a class=next href=https://ramsayleung.github.io/zh/post/2018/hbase_crash/><span class=title>下一页 »</span><br><span>记一次Hbase 宕机原因分析</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share lsof can't identify protocol on x" href="https://x.com/intent/tweet/?text=lsof%20can%27t%20identify%20protocol&url=https%3a%2f%2framsayleung.github.io%2fzh%2fpost%2f2018%2flsof_cant_identify_protocol%2f&hashtags=linux"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share lsof can't identify protocol on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2framsayleung.github.io%2fzh%2fpost%2f2018%2flsof_cant_identify_protocol%2f&title=lsof%20can%27t%20identify%20protocol&summary=lsof%20can%27t%20identify%20protocol&source=https%3a%2f%2framsayleung.github.io%2fzh%2fpost%2f2018%2flsof_cant_identify_protocol%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share lsof can't identify protocol on reddit" href="https://reddit.com/submit?url=https%3a%2f%2framsayleung.github.io%2fzh%2fpost%2f2018%2flsof_cant_identify_protocol%2f&title=lsof%20can%27t%20identify%20protocol"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share lsof can't identify protocol on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2framsayleung.github.io%2fzh%2fpost%2f2018%2flsof_cant_identify_protocol%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share lsof can't identify protocol on whatsapp" href="https://api.whatsapp.com/send?text=lsof%20can%27t%20identify%20protocol%20-%20https%3a%2f%2framsayleung.github.io%2fzh%2fpost%2f2018%2flsof_cant_identify_protocol%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share lsof can't identify protocol on telegram" href="https://telegram.me/share/url?text=lsof%20can%27t%20identify%20protocol&url=https%3a%2f%2framsayleung.github.io%2fzh%2fpost%2f2018%2flsof_cant_identify_protocol%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share lsof can't identify protocol on ycombinator" href="https://news.ycombinator.com/submitlink?t=lsof%20can%27t%20identify%20protocol&u=https%3a%2f%2framsayleung.github.io%2fzh%2fpost%2f2018%2flsof_cant_identify_protocol%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></div></footer><script src=https://utteranc.es/client.js repo=ramsayleung/comment issue-term=title theme=github-light crossorigin=anonymous async></script></article></main><footer class=footer><span>See this site&rsquo;s source code <a href=https://github.com/ramsayleung/ramsayleung.github.io>here</a>, licensed under GPLv3 ·</span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>