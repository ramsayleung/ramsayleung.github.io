<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>Python on è èæ²¹ä¸å¤©å…‰å¢Ÿ</title>
    <link>https://ramsayleung.github.io/zh/tags/python/</link>
    <description>Recent content in Python on è èæ²¹ä¸å¤©å…‰å¢Ÿ</description>
    <image>
      <title>è èæ²¹ä¸å¤©å…‰å¢Ÿ</title>
      <url>https://ramsayleung.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E</url>
      <link>https://ramsayleung.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E</link>
    </image>
    <generator>Hugo -- 0.146.7</generator>
    <language>zh</language>
    <copyright>See this site&amp;rsquo;s source code here, licensed under GPLv3 Â·</copyright>
    <lastBuildDate>Tue, 06 Jan 2026 21:33:25 -0800</lastBuildDate>
    <atom:link href="https://ramsayleung.github.io/zh/tags/python/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>æµ‹è¯•æŠ€èƒ½è¿›é˜¶(äºŒ): Parameterized Tests</title>
      <link>https://ramsayleung.github.io/zh/post/2024/%E6%B5%8B%E8%AF%95%E6%8A%80%E8%83%BD%E8%BF%9B%E9%98%B6%E4%BA%8C_parameterized_tests/</link>
      <pubDate>Sun, 13 Oct 2024 09:35:00 -0700</pubDate>
      <guid>https://ramsayleung.github.io/zh/post/2024/%E6%B5%8B%E8%AF%95%E6%8A%80%E8%83%BD%E8%BF%9B%E9%98%B6%E4%BA%8C_parameterized_tests/</guid>
      <description>&lt;h2 id=&#34;å‰è¨€&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;1&lt;/span&gt; å‰è¨€&lt;/h2&gt;
&lt;p&gt;æµ‹è¯•æŠ€å·§å…·æœ‰æ™®é€‚æ€§ï¼Œå¤§å¤šæ˜¯ä¸è¯­è¨€æ— å…³çš„ï¼Œåªæ˜¯ä¸åŒè¯­è¨€çš„ç”Ÿæ€å¯èƒ½å¯¹æµ‹è¯•æŠ€æœ¯çš„æ”¯æŒå„ä¸ä¸€æ ·ï¼Œ
æ¯”å¦‚Pythonå’ŒJavaï¼ŒåŸºæœ¬ä»€ä¹ˆåº“éƒ½æœ‰ï¼Œè€ŒåƒC++ï¼Œæœ‰é¡ºæ‰‹çš„å•å…ƒæµ‹è¯•å’ŒMockåº“èƒ½ç”¨å°±å¾ˆä¸é”™äº†ã€‚&lt;/p&gt;</description>
      <content:encoded><![CDATA[<h2 id="å‰è¨€"><span class="section-num">1</span> å‰è¨€</h2>
<p>æµ‹è¯•æŠ€å·§å…·æœ‰æ™®é€‚æ€§ï¼Œå¤§å¤šæ˜¯ä¸è¯­è¨€æ— å…³çš„ï¼Œåªæ˜¯ä¸åŒè¯­è¨€çš„ç”Ÿæ€å¯èƒ½å¯¹æµ‹è¯•æŠ€æœ¯çš„æ”¯æŒå„ä¸ä¸€æ ·ï¼Œ
æ¯”å¦‚Pythonå’ŒJavaï¼ŒåŸºæœ¬ä»€ä¹ˆåº“éƒ½æœ‰ï¼Œè€ŒåƒC++ï¼Œæœ‰é¡ºæ‰‹çš„å•å…ƒæµ‹è¯•å’ŒMockåº“èƒ½ç”¨å°±å¾ˆä¸é”™äº†ã€‚</p>
<p>å› ä¸ºPythonæ¯”è¾ƒé€‚åˆå†™POC(proof of concept), è€Œæˆ‘æ—¥å¸¸å·¥ä½œçš„è¯­è¨€æ˜¯Java+Rustï¼Œæ‰€ä»¥æˆ‘ä¼šç©¿æ’ç€å¼•ç”¨è¿™ä¸‰ç§è¯­è¨€ã€‚</p>
<h2 id="parameterized-test"><span class="section-num">2</span> Parameterized Test</h2>
<p>åœ¨ä»‹ç» Parameterized Test ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆæ¥çœ‹ä¸ªç®€å•çš„è®¡ç®—ä»·æ ¼ä¸æŠ˜æ‰£çš„å‡½æ•°ï¼ˆå®é™…çš„ç”Ÿäº§ä»£ç è‚¯å®šä¼šæ›´å¤æ‚ï¼Œä½†æ˜¯èƒŒåçš„æ€è·¯æ˜¯ç›¸é€šçš„ï¼‰ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">calculate_discount</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="n">discount_percentage</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">price</span> <span class="o">-</span> <span class="p">(</span><span class="n">price</span> <span class="o">*</span> <span class="n">discount_percentage</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>é’ˆå¯¹è¿™ä¸ªå‡½æ•°ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šç¼–å†™å¤šä¸ª test case, æ¯”å¦‚ä»·æ ¼æ˜¯ 100, ç»™10%çš„æŠ˜æ‰£; ä»·æ ¼æ˜¯200, ç»™20%çš„æŠ˜æ‰£; ä»·æ ¼æ˜¯50, ç»™0çš„æŠ˜æ‰£ï¼›è¿˜æœ‰å¼‚å¸¸caseï¼Œæ¯”å¦‚ä»·æ ¼ä¸ºè´Ÿæ•°çš„æ—¶å€™ï¼Œæˆ–è€…æŠ˜æ‰£ä¸ºè´Ÿæ•°çš„æ—¶å€™.</p>
<h3 id="å•ä¸ª-test-case"><span class="section-num">2.1</span> å•ä¸ª test case</h3>
<p>å¯¹äºè¿™ä¹ˆå¤šçš„ case, ä¸€ä¸ªç®€å•ç²—æš´çš„æ–¹å¼å°±æ˜¯æŠŠæ‰€æœ‰çš„ case éƒ½å†™åœ¨ä¸€ä¸ª test case é‡Œï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">pytest</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">test_calculate_discount</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># happy path</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="n">calculate_discount</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">==</span> <span class="mi">90</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="n">calculate_discount</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span> <span class="o">==</span> <span class="mi">160</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="n">calculate_discount</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">50</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># unhappy path</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># assert calculate_discount(-2, 10)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># assert calculate_discount(10, -2)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä½†æ˜¯è¿™æ ·çš„åšæ³•ä¸€èˆ¬æ˜¯ä¸æ¨èçš„ï¼ŒBest Practiceæ˜¯ä¸€ä¸ª test case åªæµ‹ä¸€ç§æƒ…å†µï¼Œå› ä¸ºå¦‚æœä¸€ä¸ª test case åŒ…å«å¤šä¸ªæµ‹è¯•æ¡ä»¶ï¼Œå¦‚æœ test case fail äº†ï¼Œé‚£ä¹ˆä¸çœ‹æºç æˆ–è€…å †æ ˆï¼Œä¸€èˆ¬è¿˜çœ‹ä¸å‡ºæ˜¯ä»€ä¹ˆ case å¤±è´¥äº†ï¼Œä¸å¥½æ’æŸ¥ã€‚</p>
<h3 id="å¤šä¸ª-test-case"><span class="section-num">2.2</span> å¤šä¸ª test case</h3>
<p>æ¨èåšæ³•å°±æ˜¯æ¯ä¸ªæµ‹è¯•æ¡ä»¶ä¸€ä¸ªå•ç‹¬çš„ test caseã€‚</p>
<p>å¦å¤–æˆ‘ä»¬é€šè¿‡test caseå‘ç°ä¸Šé¢çš„ä»£ç æ²¡æœ‰å¤„ç†å¼‚å¸¸æƒ…å†µï¼Œæˆ‘ä»¬ç°åœ¨è¦ä¼˜åŒ–ä¸‹æˆ‘ä»¬çš„ä»£ç ï¼Œå¢åŠ å¼‚å¸¸å¤„ç†é€»è¾‘(è¿™ä¸ªå°±æ˜¯TDDæ‰€æ¨å´‡çš„å¼€å‘å“²å­¦, test case å…ˆè¡Œï¼Œé€šè¿‡test caseå‘ç°é—®é¢˜ï¼Œè®©test case failæ‰ï¼Œç„¶åä¿®æ­£ä¸šåŠ¡é€»è¾‘ï¼Œtest caseå†è¿è¡Œé€šè¿‡).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">pytest</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">calculate_discount</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="n">discount_percentage</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">price</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Price must be greater than zero: </span><span class="si">{</span><span class="n">price</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">discount_percentage</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Discount_percentage must be greater than zero: </span><span class="si">{</span><span class="n">discount_percentage</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">price</span> <span class="o">-</span> <span class="p">(</span><span class="n">price</span> <span class="o">*</span> <span class="n">discount_percentage</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">TestClassCalculateDiscount</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># happy path</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">test_calculate_discount_with_10_discount_percentage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="n">calculate_discount</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">==</span> <span class="mi">90</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">test_calculate_discount_with_20_discount_percentage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="n">calculate_discount</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span> <span class="o">==</span> <span class="mi">160</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">test_calculate_discount_with_0_discount_percentage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="n">calculate_discount</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">50</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># unhappy path</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">test_calculate_discount_with_negative_price</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">assert</span> <span class="n">calculate_discount</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">test_calculate_discount_with_negative_discount</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">assert</span> <span class="n">calculate_discount</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä»£ç çš„ç¡®æ˜¯æ•´æ´æ˜“è¯»äº†ï¼Œä½†è¯è™½å¦‚æ­¤ï¼Œæˆ‘ä»¬è¦å¤šå†™äº†å¾ˆå¤šçš„ test case.</p>
<p>å¦‚æœ <code>calculate_discount</code> å˜å¾—æ›´å¤æ‚ï¼Œæˆ‘ä»¬è¦å†™çš„ test case è‚¯å®šæ˜¯æ›´å¤šæ›´å¤æ‚ï¼Œæ€»ä¸èƒ½éƒ½ copy-paste test caseå§ã€‚</p>
<h3 id="parameterized-test"><span class="section-num">2.3</span> Parameterized Test</h3>
<p>è¯é¢˜å°±å›åˆ° Parameterized Test äº†, å®ƒå°±æ˜¯ç”¨æ¥è§£å†³è¿™ä¸ªé—®é¢˜çš„ï¼Œå®ƒå¯ä»¥è®©ä½ ç”¨ä¸åŒçš„æµ‹è¯•æ•°æ®é›†ä¼šè¿è¡Œç›¸åŒçš„æµ‹è¯•é€»è¾‘.
è¿˜æ˜¯ä»¥ä¸Šé¢çš„ä»£ç ä¸ºä¾‹å­ï¼Œä½ ä¼šå‘ç° <code>test_calculate_discount_with_10_discount_percentage</code> å’Œ <code>test_calculate_discount_with_20_discount_percentage</code> çš„æµ‹è¯•é€»è¾‘æ˜¯å®Œå…¨ä¸€æ ·çš„ï¼Œä½†åªæ˜¯æ•°æ®é›†ä¸åŒï¼Œæ‰€ä»¥æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ Parameterized Test æ¥ä¼˜åŒ–ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">pytest</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">TestClassCalculateDiscount</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Parameterized test for valid cases (happy path)</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@pytest.mark.parametrize</span><span class="p">(</span><span class="s2">&#34;price, discount, expected&#34;</span><span class="p">,</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">90</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">160</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">test_calculate_discount</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">discount</span><span class="p">,</span> <span class="n">expected</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="n">calculate_discount</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="n">discount</span><span class="p">)</span> <span class="o">==</span> <span class="n">expected</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Parameterized test for invalid cases (unhappy path)</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@pytest.mark.parametrize</span><span class="p">(</span><span class="s2">&#34;price, discount&#34;</span><span class="p">,</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>   <span class="c1"># Invalid price</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>    <span class="c1"># Invalid discount percentage</span>
</span></span><span class="line"><span class="cl">    <span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">test_calculate_discount_invalid_cases</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">discount</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">calculate_discount</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="n">discount</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å…¶å®å°±æ˜¯æŠŠæµ‹è¯•é€»è¾‘å’Œæ•°æ®è¿›è¡Œäº†åˆ†ç¦»ï¼Œåé¢éœ€è¦æµ‹è¯•æ–°çš„æ•°æ®é›†ï¼Œåªéœ€è¦å‘æ•°æ®é›†é‡Œé¢æ·»åŠ æ•°æ®å³å¯ã€‚</p>
<p>ç”±æ­¤å¯è§ï¼Œä½¿ç”¨ Parameterized Test æœ‰å‡ ä¸ªæ˜¾è€Œæ˜“è§çš„å¥½å¤„ï¼š</p>
<p>é¦–å…ˆæ˜¯å‡å°‘ä»£ç å†—ä½™ï¼Œä¸éœ€è¦ç±»ä¼¼çš„ä»£ç  copy-paste å¾ˆå¤šæ¬¡ï¼›å…¶æ¬¡æ˜¯æ–¹ä¾¿æåˆ°æµ‹è¯•è¦†ç›–ç‡ï¼Œè¿™ä¸ªåœ¨ä¸Šé¢çš„ä¾‹å­å¯èƒ½ä¸æ˜æ˜¾ï¼Œæˆ‘ä»¬å¯ä»¥å†ä¿®æ”¹ä¸€ä¸‹ <code>calculate_discount</code> å‡½æ•°ï¼Œå¢åŠ ä¸¤ä¸ªåˆ†æ”¯ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">calculate_discount</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="n">discount_percentage</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">price</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Price must be greater than zero: </span><span class="si">{</span><span class="n">price</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">discount_percentage</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Discount_percentage must be greater than zero: </span><span class="si">{</span><span class="n">discount_percentage</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">price</span> <span class="o">&gt;</span> <span class="mi">50000</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">price</span> <span class="o">-</span> <span class="p">(</span><span class="n">price</span> <span class="o">*</span> <span class="p">(</span><span class="n">discount_percentage</span> <span class="o">*</span> <span class="mf">1.15</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">price</span> <span class="o">&gt;</span> <span class="mi">100000</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">price</span> <span class="o">-</span> <span class="p">(</span><span class="n">price</span> <span class="o">*</span> <span class="p">(</span><span class="n">discount_percentage</span> <span class="o">*</span> <span class="mf">1.18</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">price</span> <span class="o">-</span> <span class="p">(</span><span class="n">price</span> <span class="o">*</span> <span class="n">discount_percentage</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä»·æ ¼è¶…è¿‡50000, åœ¨å·²æœ‰æŠ˜æ‰£åŸºç¡€ä¸Šï¼Œå†é¢å¤–ç»™æŠ˜æ‰£çš„15%ä½œä¸ºæŠ˜æ‰£ï¼›ä»·æ ¼è¶…è¿‡100000ï¼Œåœ¨å·²æœ‰æŠ˜æ‰£çš„åŸºç¡€ä¸Šï¼Œå†é¢å¤–ç»™æŠ˜æ‰£çš„18%ä½œä¸ºæŠ˜æ‰£. å¦‚æœè¦è¦†ç›–è¿™ä¸¤ä¸ªæ–°çš„åˆ†æ”¯ï¼Œåªéœ€è¦åœ¨æ•°æ®é›†ä¸Šæ·»åŠ å¤§äº50000 å’Œå¤§äº100000çš„æ•°æ®é›†ï¼Œå°±å¯ä»¥ç›´æ¥è¦†ç›–åˆ°äº†.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="nd">@pytest.mark.parametrize</span><span class="p">(</span><span class="s2">&#34;price, discount, expected&#34;</span><span class="p">,</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">90</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">160</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="mi">50001</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mf">44250.885</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="mi">100001</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mf">88500.885</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">test_calculate_discount</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">discount</span><span class="p">,</span> <span class="n">expected</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="n">calculate_discount</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="n">discount</span><span class="p">)</span> <span class="o">==</span> <span class="n">expected</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç„¶åæµ‹è¯•è¿™æ®µä»£ç çš„æ—¶å€™ï¼Œæˆ‘åˆå‘ç°ä¸€ä¸ªæ–°çš„é—®é¢˜ï¼Œè¿™é‡Œçš„ä»·æ ¼å˜æˆæµ®ç‚¹æ•°åï¼Œæ²¡æœ‰ä½œå°æ•°ç‚¹åå‡ ä½çš„å–æ•´ã€‚</p>
<p>ï¼ˆå¯¹äºè¿™æ ·ç®€å•çš„å‡½æ•°ï¼Œä¹Ÿèƒ½ä¸æ–­åœ°é€šè¿‡å†™ test case å‘ç°æ–°é—®é¢˜ï¼Œè¿™æ— ç–‘å°±æ˜¯ test case æœ€å¤§çš„ä»·å€¼æ‰€åœ¨äº†ï¼‰</p>
<p>ä½¿ç”¨ Parameterized Test è¿˜å¯ä»¥æé«˜æµ‹è¯•ä»£ç çš„å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ï¼Œè¿™éƒ¨åˆ†å†…å®¹è¿˜æ˜¯æ˜¾è€Œæ˜“è§çš„ï¼Œå°±ä¸å±•å¼€äº†ã€‚</p>
<h3 id="junit"><span class="section-num">2.4</span> Junit</h3>
<p>åœ¨Javaçš„æµ‹è¯•ç”Ÿæ€ä¸­ï¼ŒJunitæ˜¯æ¯«æ— ç–‘é—®çš„é¾™å¤´å¤§å“¥ï¼Œè€Œåœ¨Junit5 ï¼ŒJunitä¹Ÿå¼•å…¥äº†å¯¹ Parameterized Test çš„æ”¯æŒï¼Œé€šè¿‡ <code>@ParameterizedTest</code> è¿™ä¸ªæšä¸¾å°±å¯ä»¥å°†æŸä¸ª test case æ ‡æ³¨æˆ Parameterized Test, é€šè¿‡ <code>@ValueSource</code> ä¼ å…¥å¾…æµ‹è¯•æ•°æ®é›†ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Numbers</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isOdd</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">number</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">2</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@ParameterizedTest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@ValueSource</span><span class="p">(</span><span class="n">ints</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">1</span><span class="p">,</span><span class="w"> </span><span class="n">3</span><span class="p">,</span><span class="w"> </span><span class="n">5</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">3</span><span class="p">,</span><span class="w"> </span><span class="n">15</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="p">.</span><span class="na">MAX_VALUE</span><span class="p">})</span><span class="w"> </span><span class="c1">// six numbers</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kt">void</span><span class="w"> </span><span class="nf">isOdd_ShouldReturnTrueForOddNumbers</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">number</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">assertTrue</span><span class="p">(</span><span class="n">Numbers</span><span class="p">.</span><span class="na">isOdd</span><span class="p">(</span><span class="n">number</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™åªæ˜¯æœ€åŸºæœ¬çš„ç”¨æ³•ï¼ŒJunitè¿˜æ”¯æŒé€šè¿‡å‡½æ•°ï¼Œæšä¸¾ï¼ŒCSVæ ¼å¼ç”šè‡³æ–‡ä»¶æ¥ä¼ å…¥å¾…æµ‹è¯•æ•°æ®é›†ï¼Œå¯è°“æ˜¯åŒ…ç½—ä¸‡æœ‰ï¼Œå…·ä½“çš„ç”¨æ³•å¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼š<a href="https://www.baeldung.com/parameterized-tests-junit-5">Guide to JUnit 5 Parameterized Tests</a><sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup> å’Œ <a href="https://junit.org/junit5/docs/current/user-guide/#writing-tests-parameterized-tests">Junitå®˜æ–¹æ–‡æ¡£</a>Â <sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup></p>
<h3 id="rstest-and-test-case"><span class="section-num">2.5</span> rstest &amp; test_case</h3>
<p>Rust ä¹Ÿæœ‰å¯¹Parameterized Testæ”¯æŒçš„åº“ï¼Œä¸€ä¸ªå°±æ˜¯ <a href="https://github.com/la10736/rstest"><code>rstest</code></a><sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup>, å¦å¤–ä¸€ä¸ªå°±æ˜¯ <a href="https://github.com/frondeus/test-case"><code>test_case</code></a>Â <sup id="fnref:4"><a href="#fn:4" class="footnote-ref" role="doc-noteref">4</a></sup>, ä¸¤è€…éƒ½å¯¹ Parameterized Test æœ‰è¾ƒå¥½çš„æ”¯æŒï¼Œåœ¨å…¬å¸çš„ä»£ç åº“ä¸­ï¼Œä¸¤è€…æˆ‘éƒ½è§è¿‡æœ‰é¡¹ç›®åœ¨ä½¿ç”¨ï¼Œè€Œæˆ‘åœ¨å·¥ä½œä¸­ä½¿ç”¨çš„æ˜¯ <code>rstest</code>, å› ä¸ºå®ƒçš„åŠŸèƒ½æ›´åŠ å¼ºå¤§ï¼Œç»´æŠ¤è€…ä¹Ÿæ›´åŠ æ´»è·ƒ.</p>
<h2 id="æ€»ç»“"><span class="section-num">3</span> æ€»ç»“</h2>
<p>åœ¨äº†è§£ Parameterized Test ä¹‹å‰ï¼Œæˆ‘çš„æ¯ä¸ªCRåŸºæœ¬éƒ½æœ‰ test case è¦†ç›–ï¼Œä½†æ˜¯åæˆ‘æ—è¾¹ Principle Engineer å·¨ä½¬ review æˆ‘ä»£ç çš„æ—¶å€™ï¼Œæ€»ä¼šè¯´æˆ‘çš„ test case å¤ª verbose å’Œ heavy, æˆ‘åœ¨æƒ³test caseå¤šè¿˜ä¸å¥½å˜›ï¼Œæˆ‘çš„ code coverage éƒ½è¶…è¿‡80%äº†.</p>
<p>ç„¶è€Œä»–çš„æ„æ€æ˜¯ï¼Œä¸æ˜¯è¯´æˆ‘çš„ test case æ²¡æœ‰è¦†ç›–åˆ°ä»£ç ï¼Œæˆ‘100è¡Œçš„å˜æ›´ï¼Œé™„ä¸Š200è¡Œçš„ test case ä¹Ÿæ²¡æœ‰é—®é¢˜ï¼Œåªä¸è¿‡æˆ‘çš„test caseå¤§å¤šåªæ˜¯æ•°æ®ä¸ä¸€æ ·ï¼Œæµ‹è¯•é€»è¾‘åŸºæœ¬ç›¸åŒï¼Œèƒ½å¦æŠ½è±¡ä¸‹ï¼Œå‡å°‘ä¸‹code redundancy, ç„¶åå°±å¼ºçƒˆå»ºè®®æˆ‘å»çœ‹ä¸‹ <code>Parameterized Test</code> ä»¥åŠ <code>Property Based Test</code>.</p>
<p>å¤§ä½¬çš„ç¡®ä¸€é’ˆè§è¡€ï¼Œæˆ‘çš„ test case å¤§å¤šæ˜¯å¤åˆ¶å·²æœ‰çš„ test case, ä¿®æ”¹ä¸‹å‡½æ•°åï¼Œå†åŠ åŠ å‡å‡æ”¹ä¸‹æ•°æ®é›†ã€‚</p>
<p>ç»ä»–æŒ‡ç‚¹ï¼Œåœ¨äº†è§£ <code>Parameterized Test</code> ä¹‹åï¼Œæˆ‘çš„ç¡®å†ä¹Ÿæ²¡æœ‰å¤åˆ¶ test caseï¼Œæ¯æ¬¡CRçš„test caseä¹Ÿæ›´ç²¾ç®€äº†ï¼ŒCRä¹Ÿæ›´å®¹æ˜“é€šè¿‡äº†.</p>
<p>è€Œä»–æåˆ°çš„ <code>Property Based Test</code> åˆ™æ˜¯ä¸€é¡¹æ›´å¼ºå¤§çš„æµ‹è¯•æŠ€æœ¯ï¼Œä¸‹å›å†åˆ†è§£äº†ã€‚</p>
<p>ç³»åˆ—æ–‡ç« :</p>
<ul>
<li><a href="https://ramsayleung.github.io/zh/post/2024/%E6%B5%8B%E8%AF%95%E6%8A%80%E8%83%BD%E8%BF%9B%E9%98%B6%E4%B8%80_%E8%BD%AF%E4%BB%B6%E8%B4%A8%E9%87%8F%E8%AE%A4%E7%9F%A5/">æµ‹è¯•æŠ€èƒ½è¿›é˜¶(ä¸€): è½¯ä»¶è´¨é‡è®¤çŸ¥</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2024/%E6%B5%8B%E8%AF%95%E6%8A%80%E8%83%BD%E8%BF%9B%E9%98%B6%E4%BA%8C_parameterized_tests/">æµ‹è¯•æŠ€èƒ½è¿›é˜¶(äºŒ): Parameterized Tests</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2024/%E6%B5%8B%E8%AF%95%E6%8A%80%E8%83%BD%E8%BF%9B%E9%98%B6%E4%B8%89_property_based_testing/">æµ‹è¯•æŠ€èƒ½è¿›é˜¶(ä¸‰): Property Based Testing</a></li>
</ul>
<div center class="qr-container">
<img src="/ox-hugo/qrcode_gh_e06d750e626f_1.jpg" alt="qrcode_gh_e06d750e626f_1.jpg" width="160px" height="160px" center="t" class="qr-container" />
å…¬å·åŒæ­¥æ›´æ–°ï¼Œæ¬¢è¿å…³æ³¨ğŸ‘»
</div>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p><a href="https://www.baeldung.com/parameterized-tests-junit-5">https://www.baeldung.com/parameterized-tests-junit-5</a>&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2">
<p><a href="https://junit.org/junit5/docs/current/user-guide/#writing-tests-parameterized-tests">https://junit.org/junit5/docs/current/user-guide/#writing-tests-parameterized-tests</a>&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:3">
<p><a href="https://github.com/la10736/rstest">https://github.com/la10736/rstest</a>&#160;<a href="#fnref:3" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:4">
<p><a href="https://github.com/frondeus/test-case">https://github.com/frondeus/test-case</a>&#160;<a href="#fnref:4" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>
]]></content:encoded>
    </item>
    <item>
      <title>ç”¨python æ¥æ“æ§ sqlite3</title>
      <link>https://ramsayleung.github.io/zh/post/2017/python_with_sqlite3/</link>
      <pubDate>Sun, 12 Nov 2017 07:05:00 +0800</pubDate>
      <guid>https://ramsayleung.github.io/zh/post/2017/python_with_sqlite3/</guid>
      <description>&lt;p&gt;python ä¸åµŒå…¥å¼å…³ç³»æ•°æ®åº“ sqlite3çš„é‚‚é€…&lt;/p&gt;
&lt;p&gt;&lt;code&gt;SQLite&lt;/code&gt; æ˜¯ä¸€ä¸ªéå¸¸ä¼˜ç§€çš„åµŒå…¥å¼æ•°æ®åº“ï¼Œéå¸¸è½»é‡ï¼Œå¯ä»¥ä¸ Mysql, PostgreSQL è¿™æ ·çš„ å¤§å‹æ•°æ®åº“äº’è¡¥ä½¿ç”¨. è€Œ Python æ ‡å‡†åº“ä¸­çš„ &lt;code&gt;sqlite3&lt;/code&gt; æ¨¡å—å®ç°äº†å…¼å®¹ SQLite çš„ &lt;a href=&#34;https://www.python.org/dev/peps/pep-0249/&#34;&gt;Python DB-API 2.0&lt;/a&gt;æ¥å£, å› æ­¤æˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ ä¾¿åœ°ä½¿ç”¨ &lt;code&gt;sqlite3&lt;/code&gt; æ¨¡å—æ¥æ“ä½œ &lt;code&gt;SQLite&lt;/code&gt;&lt;/p&gt;</description>
      <content:encoded><![CDATA[<p>python ä¸åµŒå…¥å¼å…³ç³»æ•°æ®åº“ sqlite3çš„é‚‚é€…</p>
<p><code>SQLite</code> æ˜¯ä¸€ä¸ªéå¸¸ä¼˜ç§€çš„åµŒå…¥å¼æ•°æ®åº“ï¼Œéå¸¸è½»é‡ï¼Œå¯ä»¥ä¸ Mysql, PostgreSQL è¿™æ ·çš„ å¤§å‹æ•°æ®åº“äº’è¡¥ä½¿ç”¨. è€Œ Python æ ‡å‡†åº“ä¸­çš„ <code>sqlite3</code> æ¨¡å—å®ç°äº†å…¼å®¹ SQLite çš„ <a href="https://www.python.org/dev/peps/pep-0249/">Python DB-API 2.0</a>æ¥å£, å› æ­¤æˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ ä¾¿åœ°ä½¿ç”¨ <code>sqlite3</code> æ¨¡å—æ¥æ“ä½œ <code>SQLite</code></p>
<h2 id="å…¥é—¨"><span class="section-num">1</span> å…¥é—¨</h2>
<h3 id="åˆ›å»ºæ•°æ®åº“"><span class="section-num">1.1</span> åˆ›å»ºæ•°æ®åº“</h3>
<p><code>SQLite</code> æ•°æ®åº“æ˜¯å­˜å‚¨åœ¨æ–‡ä»¶ç³»ç»Ÿçš„å•ä¸ªæ–‡ä»¶ä¸Šçš„ï¼Œæ‰€ä»¥å¦‚æœæ•°æ®åº“æ–‡ä»¶ä¸å­˜åœ¨ï¼Œé‚£ä¹ˆåœ¨ç¬¬ä¸€æ¬¡è®¿é—®è¿™ä¸ªæ•°æ®åº“ï¼Œå°±ä¼šåˆ›å»ºç›¸åº”çš„æ•°æ®åº“æ–‡ä»¶ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">sqlite3</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">db_filename</span> <span class="o">=</span> <span class="s1">&#39;sqlite3_demo.db&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">db_exist</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">db_filename</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_filename</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="n">db_exist</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Database exists&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Database does not exist&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸Šé¢çš„ä¾‹å­ä¼šåœ¨è¿æ¥æ•°æ®åº“ä¹‹å‰æ£€æŸ¥ä¸€ä¸‹æ•°æ®åº“æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œç„¶åä½¿ç”¨ <code>connect()</code> å‡½æ•°è¿æ¥æ•°æ®åº“ã€‚</p>
<p>ä½ åœ¨æ‰§è¡Œè¯¥ä»£ç ä¹‹å‰æŸ¥çœ‹ä¸€ä¸‹å½“å‰ç›®å½•çš„è¯ï¼Œå¦‚æœä¸å­˜åœ¨ <code>sqlite3_demo.db</code> çš„è¯ï¼Œé‚£ä¹ˆè·‘å®Œè¿™æ®µä»£ç ï¼Œä½ åº”è¯¥ä¼šçœ‹åˆ° <code>sqlite3_demo.db</code>
æ–‡ä»¶çš„.</p>
<p>è¿™æ®µä»£ç æœ¬èº«æ˜¯æ²¡æœ‰åšå¤šå°‘äº‹ï¼Œæˆ‘åªæ˜¯ç”¨å®ƒæ¥é˜è¿°ä¸€ä¸‹ <code>SQLite</code> çš„åŸç†</p>
<h3 id="åˆ›å»ºè¡¨"><span class="section-num">1.2</span> åˆ›å»ºè¡¨</h3>
<p>é‚£ä¹ˆï¼Œç°åœ¨ï¼Œè®©æˆ‘ä»¬ç”¨ <code>SQLite</code> æ¥åšç‚¹æ•°æ®åº“çš„æœ¬ä»½å·¥ä½œã€‚å…ˆåˆ›å»ºä¸€å¼ è¡¨ï¼Œæ¥ä¸‹æ¥çš„æ“ä½œéƒ½ä¼šå›´ç»•ç€è¿™å¼ è¡¨è¿›è¡Œã€‚</p>
<p><code>user.sql</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="k">role</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">name</span><span class="w">         </span><span class="nb">text</span><span class="w"> </span><span class="k">primary</span><span class="w"> </span><span class="k">key</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">description</span><span class="w">  </span><span class="nb">text</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="k">user</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">id</span><span class="w">           </span><span class="nb">integer</span><span class="w"> </span><span class="k">primary</span><span class="w"> </span><span class="k">key</span><span class="w"> </span><span class="n">autoincrement</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">name</span><span class="w">         </span><span class="nb">text</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">phone_number</span><span class="w"> </span><span class="nb">integer</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">birthday</span><span class="w">     </span><span class="nb">date</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">role</span><span class="w">      </span><span class="nb">text</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="k">references</span><span class="w"> </span><span class="k">role</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>ç„¶åä½¿ç”¨ <code>Connection</code> å¯¹è±¡çš„ <code>executescript()</code> å‡½æ•°æ¥åˆ›å»ºè¡¨ä»¥åŠæ’å…¥å¯¹åº”çš„æ•°æ®</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">sqlite3</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">db_filename</span> <span class="o">=</span> <span class="s1">&#39;sqlite3_demo.db&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">schema_filename</span> <span class="o">=</span> <span class="s1">&#39;user.sql&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">db_exists</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">db_filename</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">with</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">db_exists</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Creating schema&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">schema_filename</span><span class="p">,</span> <span class="s1">&#39;rt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	    <span class="n">schema</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="n">conn</span><span class="o">.</span><span class="n">executescript</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Inserting initial data&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">conn</span><span class="o">.</span><span class="n">executescript</span><span class="p">(</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">	insert into role (name,description)
</span></span></span><span class="line"><span class="cl"><span class="s2">	values (&#39;student&#39;,&#39;This is a student&#39;);
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">	insert into role (name,description)
</span></span></span><span class="line"><span class="cl"><span class="s2">	values (&#39;teacher&#39;,&#39;This is a teacher&#39;);
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">	insert into user (id,name,phone_number,birthday,role)
</span></span></span><span class="line"><span class="cl"><span class="s2">	values (1,&#39;Samray&#39;,12345678,&#39;2017-11-10&#39;,&#39;student&#39;);
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">	insert into user (id,name,phone_number,birthday,role)
</span></span></span><span class="line"><span class="cl"><span class="s2">	values (2,&#39;Paul&#39;,3231546,&#39;2017-11-11&#39;,&#39;student&#39;);
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">	insert into user (id,name,phone_number,birthday,role)
</span></span></span><span class="line"><span class="cl"><span class="s2">	values (3,&#39;Trump&#39;,13254768,&#39;2017-11-12&#39;,&#39;teacher&#39;);
</span></span></span><span class="line"><span class="cl"><span class="s2">			   &#34;&#34;&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="æ£€ç´¢æ•°æ®"><span class="section-num">1.3</span> æ£€ç´¢æ•°æ®</h3>
<p>å¦‚æœæƒ³è¦ä½¿ç”¨æ£€ç´¢å­˜å‚¨åœ¨ <code>user</code> è¡¨ä¸­çš„æ•°æ®ï¼Œé‚£ä¹ˆå°±éœ€è¦ä»æ•°æ®åº“è¿æ¥å¯¹è±¡ <code>Connection</code> ä¸­åˆ›å»ºä¸€ä¸ª <code>Cursor</code>å¯¹è±¡ã€‚</p>
<p>è€Œ<code>Cursor</code> å¯¹è±¡è´Ÿè´£ä¸æ•°æ®åº“è¿›è¡Œäº¤äº’å¹¶è·å– æ•°æ®</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">sqlite3</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">db_filename</span> <span class="o">=</span> <span class="s1">&#39;sqlite3_demo.db&#39;</span>
</span></span><span class="line"><span class="cl"><span class="k">with</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    select id,name,phone_number,birthday from user
</span></span></span><span class="line"><span class="cl"><span class="s2">    where role=&#39;student&#39;
</span></span></span><span class="line"><span class="cl"><span class="s2">		   &#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">	<span class="nb">id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">phone_number</span><span class="p">,</span> <span class="n">birthday</span> <span class="o">=</span> <span class="n">row</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:2d}</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> </span><span class="si">{:&lt;10}</span><span class="s1"> [</span><span class="si">{:&lt;8}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="nb">id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">phone_number</span><span class="p">,</span> <span class="n">birthday</span><span class="p">))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>SQLite3</code> æ•°æ®åº“çš„æŸ¥è¯¢åˆ†æˆä¸¤æ­¥ã€‚é¦–å…ˆï¼Œä½¿ç”¨ <code>Cursor</code> å¯¹è±¡çš„ <code>execute()</code> å¯¹è±¡æ‰§è¡ŒæŸ¥è¯¢è¯­å¥ï¼Œå‘Šè¯‰æ•°æ®åº“å¼•æ“æˆ‘ä»¬éœ€è¦ä»€ä¹ˆæ ·çš„æ•°æ®ï¼Œç„¶åï¼Œä½¿ç”¨ <code>fetchall()</code> å‡½æ•°æŠŠæ•°æ®é›†ä»æ•°æ®åº“çš„è¿”å›ç»“æœä¸­å–å‡ºæ¥ã€‚</p>
<p>è¿”å›ç»“æœæ˜¯åŒ…å«ç€ä¸€ç³»åˆ— <code>tuple</code> çš„åˆ—è¡¨ï¼Œè€Œ<code>tuple</code> ä¸­å¯¹åº”ç€çš„æ•°æ®å°±æ˜¯ <code>select</code> è¯­å¥æŒ‡å®šè¿”å›çš„å­—æ®µå€¼ã€‚</p>
<p><code>fetchall()</code>å‡½æ•°æ˜¯æŠŠæ‰€æœ‰ç¬¦åˆ æ¡ä»¶çš„ç»“æœä¸€æ¬¡æ€§è¿”å›ï¼Œå¦‚æœéœ€è¦çš„è¯ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>fetchone()</code>å‡½æ•°è¿”å›å•æ¡è®°å½•ï¼Œ æˆ–è€…ä½¿ç”¨<code>fetchmany()</code>è¿”å›å›ºå®šæ•°é‡çš„è®°å½•</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">sqlite3</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">db_filename</span> <span class="o">=</span> <span class="s1">&#39;sqlite3_demo.db&#39;</span>
</span></span><span class="line"><span class="cl"><span class="k">with</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    select name, description from role
</span></span></span><span class="line"><span class="cl"><span class="s2">    where name=&#39;teacher&#39;
</span></span></span><span class="line"><span class="cl"><span class="s2">		   &#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">name</span><span class="p">,</span> <span class="n">description</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Role details for </span><span class="si">{}</span><span class="s1"> (</span><span class="si">{}</span><span class="s1">) </span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">description</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    select id,name,phone_number,birthday from user
</span></span></span><span class="line"><span class="cl"><span class="s2">    where role=&#39;student&#39;
</span></span></span><span class="line"><span class="cl"><span class="s2">		   &#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;/nNext 10 tasks:&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchmany</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">	<span class="nb">id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">phone_number</span><span class="p">,</span> <span class="n">birthday</span> <span class="o">=</span> <span class="n">row</span>
</span></span><span class="line"><span class="cl">	<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:2d}</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> </span><span class="si">{:&lt;10}</span><span class="s1"> [</span><span class="si">{:&lt;8}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">	    <span class="nb">id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">phone_number</span><span class="p">,</span> <span class="n">birthday</span><span class="p">))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä½¿ç”¨ <code>fetchmany()</code> å‡½æ•°éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“ä½ æŒ‡å®šçš„æ•°é‡è¶…è¿‡äº†ç¬¦åˆæ¡ä»¶çš„å…¨éƒ¨è®°å½•çš„æ•°é‡çš„æ—¶å€™ï¼Œ<code>fetchmany()</code>åªä¼šè¿”å›å…¨éƒ¨è®°å½•çš„æ•°é‡ã€‚</p>
<p>ä¾‹å¦‚ä¸Šé¢çš„ä»£ç é‡Œé¢ï¼Œæˆ‘æƒ³è¦ <code>fetchmany()</code> è¿”å›10æ¡è®°å½•ï¼Œä½†æ˜¯æˆ‘çš„æ•°æ®åº“åªæœ‰2æ¡ç¬¦åˆæ¡ä»¶çš„æ•°æ®ï¼Œè€Œ <code>fetchmany()</code> ä¹‹åè¿”å›ä¸¤æ¡è®°å½•</p>
<h3 id="row-å¯¹è±¡"><span class="section-num">1.4</span> Row å¯¹è±¡</h3>
<p>åœ¨å…ˆå‰çš„å†…å®¹å†…ï¼Œæˆ‘å·²ç»æåˆ°ï¼Œæ•°æ®åº“è¿”å›çš„æ•°æ®è¡Œéƒ½æ˜¯ä»¥ <code>tuple</code>çš„å½¢å¼è¿”å›çš„ï¼Œæ‰€ä»¥ ç¨‹åºè°ƒç”¨è€…å¿…é¡»çŸ¥é“æŸ¥è¯¢è¯­å¥å­—æ®µçš„é¡ºåºï¼Œç„¶ååœ¨<code>tuple</code>å–å‡ºè®°å½•çš„æ—¶å€™æŠŠå­—æ®µåå’Œå˜é‡åä¸€ä¸€å¯¹åº”ä¸Šï¼Œä¾‹å¦‚
<code>name, description = cursor.fetchone()</code>.</p>
<p>æŸ¥è¯¢è¯­å¥ä¸­å­—æ®µä¸å¤šçš„æ—¶å€™æˆ–è®¸è¿˜èƒ½è®°ä½ï¼Œä½†æ˜¯å¦‚æœå­—æ®µå€¼å¤šäº†èµ·æ¥ï¼Œå°±å¾ˆå®¹æ˜“å‡ºç°é—®é¢˜.</p>
<p>å¦‚æœå¯ä»¥åƒ<code>value=dict['key']</code> é‚£æ ·ä½¿ç”¨é”®å€¼å¯¹çš„å½¢å¼è·å–æ•°æ®ï¼Œé‚£æ ·å°±æ–¹ä¾¿å¾ˆå¤š.</p>
<p>è€Œ<code>sqlite3</code>ä¹Ÿæœ‰ä¸ºä½ æä¾›è¿™æ ·ä¾¿åˆ©çš„æ“ä½œï¼Œè¯€çªå°±åœ¨ä½¿ç”¨ <code>Row</code> å¯¹è±¡ã€‚<code>sqlite3</code> å¯ä»¥æŠŠæŸ¥è¯¢ç»“æœæ˜  å°„åˆ° Row å¯¹è±¡ï¼Œç„¶åæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡<code>Row[å­—æ®µå']</code> è¿™ç§æ–¹å¼æ¥è·å–æŒ‡å®šå­—æ®µå¯¹åº”çš„å€¼ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">import sqlite3
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">db_filename = &#39;sqlite3_demo.db&#39;
</span></span><span class="line"><span class="cl">with sqlite3.connect(db_filename) as conn:
</span></span><span class="line"><span class="cl">    conn.row_factory = sqlite3.Row
</span></span><span class="line"><span class="cl">    cursor = conn.cursor()
</span></span><span class="line"><span class="cl">    cursor.execute(&#34;&#34;&#34;
</span></span><span class="line"><span class="cl">    select name, description from role
</span></span><span class="line"><span class="cl">    where name=&#39;teacher&#39;
</span></span><span class="line"><span class="cl">		   &#34;&#34;&#34;)
</span></span><span class="line"><span class="cl">    name, description = cursor.fetchone()
</span></span><span class="line"><span class="cl">    print(&#39;Role details for {} ({}) \n&#39;.format(name, description))
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    cursor.execute(&#34;&#34;&#34;
</span></span><span class="line"><span class="cl">    select id,name,phone_number,birthday from user
</span></span><span class="line"><span class="cl">    where role=&#39;student&#39;
</span></span><span class="line"><span class="cl">		   &#34;&#34;&#34;)
</span></span><span class="line"><span class="cl">    print(&#39;/nNext 10 tasks:&#39;)
</span></span><span class="line"><span class="cl">    for row in cursor.fetchmany(10):
</span></span><span class="line"><span class="cl">	print(&#39;{:2d} {} {:&lt;10} [{:&lt;8}]&#39;.format(
</span></span><span class="line"><span class="cl">	    row[&#39;id&#39;], row[&#39;name&#39;], row[&#39;phone_number&#39;], row[&#39;birthday&#39;]))
</span></span></code></pre></td></tr></table>
</div>
</div><p>é€šè¿‡æŒ‡å®š <code>Connection</code> å¯¹è±¡çš„ <code>row_factory</code> å±æ€§å°±å¯ä»¥æ§åˆ¶æŸ¥è¯¢ç»“æœé›†è¿”å›çš„å¯¹è±¡ã€‚</p>
<p>åœ¨ä¸Šé¢çš„ä»£ç ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† <code>Row</code> å¯¹è±¡è€Œä¸æ˜¯ <code>tuple</code> æ¥è·å–æ•°æ®ï¼Œè€Œç¨‹åºçš„æ‰§è¡Œç»“æœéƒ½æ˜¯ç›¸åŒï¼Œä½†æ˜¯ç¨‹åºçš„å¥å£®æ€§å°±å¾—åˆ°äº†æé«˜ã€‚</p>
<h3 id="åœ¨æŸ¥è¯¢ä¸­ä½¿ç”¨å˜é‡"><span class="section-num">1.5</span> åœ¨æŸ¥è¯¢ä¸­ä½¿ç”¨å˜é‡</h3>
<p>æˆ‘ä»¬ä¸Šé¢çš„ä»£ç é‡Œé¢çš„æŸ¥è¯¢è¯­å¥éƒ½æ˜¯ç¡¬ç¼–ç çš„ï¼Œä¸åˆ©äºæ‰©å±•ã€‚å¦‚æœä½ å¸Œæœ›å¯ä»¥ä½¿ç”¨æ›´çµæ´»çš„æŸ¥è¯¢è¯­å¥ï¼Œä½ å¯èƒ½ä¼šå»ç”¨å­—ç¬¦ä¸²æ‹¼æ¥æŸ¥è¯¢è¯­å¥ã€‚</p>
<p>ä½†æ˜¯è¿™æ ·çš„åšæ³•æ˜¯ä¸è¢«æå€¡çš„ï¼Œå› ä¸ºå¾ˆå®¹æ˜“å‡ºç°å®‰å…¨é—®é¢˜ï¼Œæ¯”å¦‚è¯´ SQL æ³¨å…¥. æ¯”è¾ƒæå€¡çš„æ–¹å¼æ˜¯åœ¨æ‰§è¡Œ <code>execute()</code> å‡½æ•°çš„æ—¶å€™è¿›è¡Œ å˜é‡æ›¿æ¢ï¼Œä½¿ç”¨å˜é‡æ›¿æ¢å¯ä»¥é¿å…SQLæ³¨å…¥æ”»å‡»ï¼Œå› ä¸ºé‚£äº›ä¸è¢«ä¿¡ä»»çš„ä»£ç æ²¡åŠæ³•è¢«è§£æã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">sqlite3</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">db_filename</span> <span class="o">=</span> <span class="s1">&#39;sqlite3_demo.db&#39;</span>
</span></span><span class="line"><span class="cl"><span class="k">with</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">conn</span><span class="o">.</span><span class="n">row_factory</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Row</span>
</span></span><span class="line"><span class="cl">    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">sql</span> <span class="o">=</span> <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    select id,name,phone_number,birthday from user
</span></span></span><span class="line"><span class="cl"><span class="s2">    where role=:role_name
</span></span></span><span class="line"><span class="cl"><span class="s2">		   &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;role_name&#39;</span><span class="p">:</span> <span class="s1">&#39;student&#39;</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;/nNext 10 tasks:&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchmany</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">	<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:2d}</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> </span><span class="si">{:&lt;10}</span><span class="s1"> [</span><span class="si">{:&lt;8}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">	    <span class="n">row</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;phone_number&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;birthday&#39;</span><span class="p">]))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¦‚ä¸Šé¢çš„ä»£ç æ‰€ç¤ºï¼Œä½¿ç”¨ <code>:role_name</code> å ä½ç¬¦æ¥è¡¨ç¤º <code>role_name</code>å˜é‡, ç„¶ååœ¨æ‰§è¡Œ SQL è¯­å¥çš„æ—¶å€™æŠŠ <code>role_name</code>çš„å€¼ä¼ åˆ° SQL è¯­å¥é‡Œé¢å»ã€‚</p>
<h3 id="æ‰¹é‡æ’å…¥"><span class="section-num">1.6</span> æ‰¹é‡æ’å…¥</h3>
<p>æˆ‘ä»¬ä¹‹å‰æåˆ°çš„æ’å…¥éƒ½æ˜¯ä½¿ç”¨ <code>execute()</code> å‡½æ•°é€æ¡æ’å…¥çš„ï¼Œä½†æ˜¯ <code>sqlite3</code> ä¹Ÿæ˜¯æ”¯æŒæ‰¹ é‡æ’å…¥çš„, ä½¿ç”¨ <code>executemany()</code>å‡½æ•°å°±å¯ä»¥å®ç°ä¸€æ¬¡æ’å…¥æ‰¹é‡çš„æ•°æ®ï¼Œè€Œå‡½æ•°çš„åº•å±‚ä¹Ÿ æ˜¯å¯¹æ’å…¥å¤šæ¡æ•°æ®çš„å¾ªç¯è¿›è¡Œäº†ä¼˜åŒ–çš„ï¼Œè¿™äº›å°±æ— éœ€è°ƒç”¨è€…æ“å¿ƒäº†ã€‚</p>
<p>user.csv</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csv" data-lang="csv"><span class="line"><span class="cl"><span class="s">birthday</span><span class="p">,</span><span class="s">name</span><span class="p">,</span><span class="s">id</span><span class="p">,</span><span class="s">phone_number</span><span class="p">
</span></span></span><span class="line"><span class="cl"><span class="p"></span><span class="s">2018-11-30</span><span class="p">,</span><span class="s">Torres</span><span class="p">,</span><span class="s">22</span><span class="p">,</span><span class="s">98564311</span><span class="p">
</span></span></span><span class="line"><span class="cl"><span class="p"></span><span class="s">2010-08-10</span><span class="p">,</span><span class="s">Messi</span><span class="p">,</span><span class="s">12</span><span class="p">,</span><span class="s">81582236</span><span class="p">
</span></span></span><span class="line"><span class="cl"><span class="p"></span><span class="s">2018-11-21</span><span class="p">,</span><span class="s">Saul</span><span class="p">,</span><span class="s">9</span><span class="p">,</span><span class="s">23564548</span><span class="p">
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">csv</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">sqlite3</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">db_filename</span> <span class="o">=</span> <span class="s1">&#39;sqlite3_demo.db&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">data_filename</span> <span class="o">=</span> <span class="s1">&#39;users.csv&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">SQL</span> <span class="o">=</span> <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">insert into user (id,name,phone_number,birthday,role)
</span></span></span><span class="line"><span class="cl"><span class="s2">values (:id,:name,:phone_number,:birthday,&#39;student&#39;)
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">data_filename</span><span class="p">,</span> <span class="s1">&#39;rt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csv_file</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">csv_reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictReader</span><span class="p">(</span><span class="n">csv_file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="n">cursor</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="n">SQL</span><span class="p">,</span> <span class="n">csv_reader</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æˆ‘ä»¬ä» csv æ–‡ä»¶ä¸­æ‰¹é‡å¯¼å…¥æ•°æ®ï¼Œè€ŒPython çš„æ ‡å‡†åº“ä¹Ÿå†…ç½®äº† CSV çš„è§£æå™¨ï¼Œä½¿ç”¨ <code>DictReader</code> å°±æ˜¯å°† csv æ–‡ä»¶è§£ææˆ
<code>{'id':22,'birthday':'2018-11-30','name':'Torres','phone_number':98564311}</code>çš„å½¢å¼
ç„¶åé…åˆä¸Šé¢æåˆ°çš„å‘½åå˜é‡ï¼ŒæŠŠæ‰€æœ‰æ•°æ®æ’å…¥åˆ°æ•°æ®åº“ã€‚</p>
<h2 id="è¿›é˜¶"><span class="section-num">2</span> è¿›é˜¶</h2>
<p>è‡ªå®šä¹‰æ•°æ®åº“åˆ—ç±»å‹ <code>SQLite</code> çš„æ•°æ®åˆ—åŸç”Ÿæ”¯æŒæ•´å‹(integer), æµ®ç‚¹æ•°(floating point), æ–‡æœ¬ç±»å‹ (text), å¹¶ä¸”ç”± <code>sqlite3</code> è½¬æ¢æˆ Pythonå†…ç½®çš„æ•°æ®ç±»å‹ã€‚</p>
<p>ä¾‹å¦‚ï¼šæ•°æ®åº“çš„æ•´å‹å¯ä»¥è½¬ æ¢æˆPython çš„ <code>int</code> æˆ–è€…æ˜¯ <code>long</code>, å…·ä½“å–å†³äºå€¼çš„å¤§å°ï¼›æ–‡æœ¬ç±»å‹é»˜è®¤ä¼šè½¬æ¢æˆ <code>str</code>
ç±»å‹ï¼Œé™¤éæˆ‘ä»¬ä¿®æ”¹äº† <code>Connection</code> å¯¹è±¡çš„ <code>text_factory</code> å±æ€§ã€‚</p>
<p>è™½ç„¶ <code>SQLite</code> å†…éƒ¨æ”¯æŒçš„æ•°æ®ç±»å‹ä¸å¤šï¼Œä½†æ˜¯å¾—ç›Šäº <code>sqlite3</code> çš„å†…ç½®æœºåˆ¶çš„æ”¯æŒï¼Œæˆ‘ä»¬å¯ä»¥ å®šä¹‰ç¨‹åºè‡ªå·±çš„æ•°æ®åˆ—ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">sqlite3</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">sys</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">db_filename</span> <span class="o">=</span> <span class="s1">&#39;sqlite3_demo.db&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">sql</span> <span class="o">=</span> <span class="s1">&#39;select id,name,birthday from user&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">show_birthday</span><span class="p">(</span><span class="n">conn</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">conn</span><span class="o">.</span><span class="n">row_factory</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Row</span>
</span></span><span class="line"><span class="cl">    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">row</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;birthday&#39;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">	<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:&lt;8}</span><span class="s1"> </span><span class="si">{:&lt;10}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="nb">type</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">col</span><span class="p">])))</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Without type detection:&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">with</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">show_birthday</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">With type detection:&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">with</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_filename</span><span class="p">,</span> <span class="n">detect_types</span><span class="o">=</span><span class="n">sqlite3</span><span class="o">.</span><span class="n">PARSE_DECLTYPES</span><span class="p">,)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">show_birthday</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¦‚ä¸Šé¢çš„ä»£ç æ‰€ç¤ºï¼Œå¦‚æœä½ æƒ³åœ¨Python æ•°æ®ç±»å‹å’Œ <code>SQLite</code> æ•°æ®åˆ—è½¬æ¢çš„æ—¶å€™ä½¿ç”¨ <code>SQLite</code> åŸæœ¬ä¸æ”¯æŒçš„ç±»å‹ï¼Œä½ å¯ä»¥åœ¨è°ƒç”¨ <code>connect()</code> å‡½æ•°çš„æ—¶å€™ï¼Œä¼ ä¸€ä¸ª <code>detect_types</code> å‚æ•°è¿›å»ï¼Œè€Œ <code>PARSE_DECLTYPES</code> çš„æ„æ€æ˜¯æŒ‡è½¬æ¢æˆå­—æ®µå£°æ˜æ—¶å€™çš„ç±»å‹ï¼Œ æ¯”å¦‚ <code>birthday</code> å£°æ˜æˆ <code>datetime</code>ç±»å‹ï¼Œä½†æ˜¯æ²¡æœ‰æŒ‡å®šæˆ <code>PAESE_DECLTYPES</code> çš„æ—¶å€™ï¼Œ è½¬æ¢æˆ <code>str</code>, æŒ‡å®šåï¼Œè½¬æ¢æˆ <code>datetime</code>.</p>
<p>ç°åœ¨æˆ‘ä»¬å°±æ¥è¯´è¯´æ€ä¹ˆå®šä¹‰è‡ªå·±çš„æ•°æ®åˆ—ç±»å‹:</p>
<p>æˆ‘ä»¬éœ€è¦æ³¨å†Œä¸¤ä¸ªå‡½æ•°ï¼Œä¸€ä¸ªå‡½æ•°æŠŠ Python å¯¹è±¡è½¬æ¢æˆ <code>byte string</code> å­˜å‚¨åˆ°æ•°æ® åº“é‡Œé¢å»ï¼Œè¿™ä¸ªå‡½æ•°è¢«ç§°ä¸º <code>adapter(é€‚é…å™¨)</code>; æ—¢ç„¶æœ‰ä»Python å¯¹è±¡è½¬æ¢åˆ°æ•°æ®åº“å­˜å‚¨ å¯¹è±¡çš„å‡½æ•°ï¼Œé‚£ä¹ˆè‡ªç„¶å°±æœ‰ä»æ•°æ®åº“å­˜å‚¨è½¬æ¢æˆ Python å¯¹è±¡çš„å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°è¢«ç§°ä¸º <code>converter(è½¬æ¢å™¨)</code>.</p>
<p>ç„¶åå°±éœ€è¦ä½¿ç”¨ <code>register_adapter()</code> å‡½æ•°å°†ä¸€ä¸ªå‡½æ•°æ³¨å†Œæˆ <code>adapter</code> å‡½æ•°ï¼Œè‡³äº<code>register_converter()</code>å‡½æ•°ï¼Œä¹Ÿæ˜¯åŒç†å¯å¾—äº†ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">pickle</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">sqlite3</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">db_filename</span> <span class="o">=</span> <span class="s1">&#39;sqlite3_demo.db&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">adapter_func</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Covert from python to sqlite3 representation
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;adapter_func(</span><span class="si">{}</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">converter_func</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Convert from sqlite3 to python representation
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;converter_func(</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># custom type</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">MyObj</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">	<span class="bp">self</span><span class="o">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">arg</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="s1">&#39;MyObj(</span><span class="si">{!r}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Register functions</span>
</span></span><span class="line"><span class="cl"><span class="n">sqlite3</span><span class="o">.</span><span class="n">register_adapter</span><span class="p">(</span><span class="n">MyObj</span><span class="p">,</span> <span class="n">adapter_func</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sqlite3</span><span class="o">.</span><span class="n">register_converter</span><span class="p">(</span><span class="s2">&#34;MyObj&#34;</span><span class="p">,</span> <span class="n">converter_func</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create some objects to save</span>
</span></span><span class="line"><span class="cl"><span class="n">to_save</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="n">MyObj</span><span class="p">(</span><span class="s1">&#39;this is a value to save&#39;</span><span class="p">),),</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="n">MyObj</span><span class="p">(</span><span class="mi">42</span><span class="p">),)</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="k">with</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_filename</span><span class="p">,</span> <span class="n">detect_types</span><span class="o">=</span><span class="n">sqlite3</span><span class="o">.</span><span class="n">PARSE_DECLTYPES</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">     create table if not exists obj (
</span></span></span><span class="line"><span class="cl"><span class="s2">	id    integer primary key autoincrement not null,
</span></span></span><span class="line"><span class="cl"><span class="s2">	data  MyObj
</span></span></span><span class="line"><span class="cl"><span class="s2">    )
</span></span></span><span class="line"><span class="cl"><span class="s2">		 &#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">cursor</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="s2">&#34;insert into obj (data) values (?)&#34;</span><span class="p">,</span> <span class="n">to_save</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Query the database for the objects just saved</span>
</span></span><span class="line"><span class="cl">    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&#34;select id, data from obj&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">obj_id</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">	<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Retrieved&#39;</span><span class="p">,</span> <span class="n">obj_id</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  with type&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="nb">print</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸Šé¢çš„ä¾‹å­ä½¿ç”¨äº†Python æ ‡å‡†åº“çš„ <code>pickle</code> æ¨¡å—ï¼Œå°†ä¸€ä¸ª Python å¯¹è±¡è½¬æ¢æˆå¯ä»¥ä¿å­˜ åˆ°æ•°æ®åº“çš„å­—ç¬¦ä¸²ï¼Œç„¶åä½¿ç”¨ <code>pickle</code>
æŠŠå­—ç¬¦ä¸²è½¬æ¢æˆPython å¯¹è±¡ã€‚</p>
<p>è¿™å°±åŸºæœ¬å®ç°äº†è‡ªå®šä¹‰çš„æ•°æ®ç±»å‹ã€‚ä¸è¿‡æˆ‘ä»¬è‡ªå·±å®ç°çš„è¿™ç§è‡ªå®šä¹‰æ•°æ®ç±»å‹æ˜¯æœ‰å±€é™çš„ï¼Œæˆ‘ä»¬åªèƒ½æŠŠæ•´ä¸ª Python å¯¹è±¡å½“ä½œå­—ç¬¦ä¸²æ¥æŸ¥è¯¢ï¼Œè€Œæ²¡åŠæ³•é’ˆå¯¹ Python å¯¹è±¡çš„å±æ€§è¿›è¡ŒæŸ¥è¯¢ï¼Œå¦‚æœä½ æ„Ÿå…´è¶£çš„è¯ï¼Œä½ å¯ä»¥çœ‹çœ‹ Python ORM
æ¡†æ¶æ˜¯æ€ä¹ˆå®ç°è¿™äº›åŠŸèƒ½çš„ã€‚</p>
<h3 id="äº‹åŠ¡"><span class="section-num">2.1</span> äº‹åŠ¡</h3>
<p>è°ˆåŠå…³ç³»å‹æ•°æ®åº“ï¼Œå¿…ä¸å¯å°‘çš„ä¸€å®šæ˜¯äº‹åŠ¡ã€‚å¯¹äºäº‹åŠ¡çš„è§è§£ï¼Œç½‘ä¸Šçš„èµ„æ–™éƒ½å·²ç»æµ©å¦‚çƒŸæµ· äº†ï¼Œé‚£ä¹ˆï¼Œå°±è¦æˆ‘ä»¬ç›´æ¥æ¥è¯´ä¸€ä¸‹ <code>SQLite</code> äº‹åŠ¡çš„ä½¿ç”¨</p>
<h4 id="commit"><span class="section-num">2.1.1</span> commit</h4>
<p>å¯¹æ•°æ®åº“çš„ä¿®æ”¹æ“ä½œï¼Œæ— è®ºæ˜¯æ–°å¢(insert) è¿˜æ˜¯æ›´æ–° (update), éƒ½éœ€è¦è°ƒç”¨ <code>commit()</code> æ¥ä¿å­˜ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">sqlite3</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">db_filename</span> <span class="o">=</span> <span class="s1">&#39;sqlite3_demo.db&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">show_role</span><span class="p">(</span><span class="n">conn</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;select name, description from role&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">description</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">	<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">with</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Before changes:&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">show_role</span><span class="p">(</span><span class="n">conn1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Insert in one cursor</span>
</span></span><span class="line"><span class="cl">    <span class="n">cursor1</span> <span class="o">=</span> <span class="n">conn1</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">cursor1</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    insert into role (name, description)
</span></span></span><span class="line"><span class="cl"><span class="s2">    values (&#39;president&#39;,&#39;well, this is a president&#39;)
</span></span></span><span class="line"><span class="cl"><span class="s2">		    &#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">After changes in conn1:&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">show_role</span><span class="p">(</span><span class="n">conn1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># åœ¨æ²¡æœ‰æäº¤äº‹åŠ¡ä¹‹å‰ï¼Œä½¿ç”¨å…¶å®ƒçš„æ•°æ®åº“è¿æ¥è¿›è¡ŒæŸ¥è¯¢</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Before commit:&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn2</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="n">show_role</span><span class="p">(</span><span class="n">conn2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># æäº¤äº‹åŠ¡ï¼Œç„¶åä½¿ç”¨å¦å¤–çš„æ•°æ®åº“è¿æ¥è¿›è¡ŒæŸ¥è¯¢</span>
</span></span><span class="line"><span class="cl">    <span class="n">conn1</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">After commit:&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn3</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="n">show_role</span><span class="p">(</span><span class="n">conn3</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>commit()</code> å‡½æ•°çš„è°ƒç”¨ç»“æœå¯ä»¥è¢«ä½¿ç”¨è‹¥å¹²ä¸ªæ•°æ®åº“è¿æ¥çš„ç¨‹åºæŸ¥è¯¢åˆ°ï¼Œåœ¨ç¬¬ä¸€ä¸ªæ•°æ®åº“è¿æ¥æ’å…¥äº†ä¸€è¡Œæ–°çš„æ•°æ®ï¼Œå¦å¤–ä¸¤ä¸ªæ•°æ®åº“è¿æ¥å°è¯•è¯»å–åˆ°æ–°æ’å…¥çš„æ•°æ®ã€‚</p>
<p>å½“ <code>show_role()</code> å‡½æ•°åœ¨ <code>conn1</code> æäº¤äº‹åŠ¡ä¹‹å‰è¢«è°ƒç”¨ï¼Œè¿”å›ç»“æœå°±å–å†³äºè°ƒç”¨ <code>show_role()</code> æ˜¯å“ªä¸ªæ•°æ®è¿æ¥äº†ã€‚</p>
<p>å› ä¸ºæ˜¯é€šè¿‡ <code>conn1</code>æ¥ä¿®æ”¹æ•°æ®åº“ï¼Œæ‰€ä»¥å®ƒå¯ä»¥çœ‹åˆ°ä¿®æ”¹åçš„æ•°æ®ï¼Œä½†æ˜¯ <code>conn2</code>çœ‹ä¸åˆ°ã€‚åœ¨æäº¤äº‹åŠ¡ä¹‹å(<code>commit()</code>) ,é€šè¿‡å…¶ä»–çš„æ•°æ®åº“è¿æ¥ (conn3)ä¹Ÿå¯ä»¥çœ‹åˆ°ä¿®æ”¹ç»“æœäº†</p>
<h4 id="rollback"><span class="section-num">2.1.2</span> rollback</h4>
<p>æœªæäº¤çš„ä¿®æ”¹å¯ä»¥é€šè¿‡è°ƒç”¨<code>rollback()</code> å‡½æ•°å…¨éƒ¨ä¸¢å¼ƒã€‚é€šå¸¸ <code>commit()</code> å’Œ <code>rollback()</code> å‡½æ•°éƒ½æ˜¯åœ¨ <code>try-except</code> è¯­å¥å—çš„ä¸åŒåœ°æ–¹è¢«è°ƒç”¨çš„ï¼Œä¾‹å¦‚é”™è¯¯å¼‚å¸¸è§¦å‘, äº‹åŠ¡å›æ»š(rollback)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">sqlite3</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">db_filename</span> <span class="o">=</span> <span class="s1">&#39;sqlite3_demo.db&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">show_role</span><span class="p">(</span><span class="n">conn</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;select name, description from role&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">description</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">	<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">with</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Before changes:&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">show_role</span><span class="p">(</span><span class="n">conn1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="c1"># Delete</span>
</span></span><span class="line"><span class="cl">	<span class="n">cursor1</span> <span class="o">=</span> <span class="n">conn1</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="n">cursor1</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">	delete from role where name=&#39;president&#39;
</span></span></span><span class="line"><span class="cl"><span class="s2">			&#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">After delete&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">show_role</span><span class="p">(</span><span class="n">conn1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1"># æ¨¡æ‹Ÿæ¥ä¸‹æ¥çš„æ“ä½œå‡ºç°äº†é”™è¯¯</span>
</span></span><span class="line"><span class="cl">	<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;This is an error&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="c1"># ä¸¢å¼ƒä¹‹å‰çš„ä¿®æ”¹</span>
</span></span><span class="line"><span class="cl">	<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error:&#39;</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">conn1</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="c1"># ä¿å­˜ä¿®æ”¹ï¼Œæäº¤äº‹åŠ¡</span>
</span></span><span class="line"><span class="cl">	<span class="n">conn1</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">After rollback:&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">show_role</span><span class="p">(</span><span class="n">conn1</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨è°ƒç”¨ <code>rollback()</code> å‡½æ•°å›æ»šäº‹åŠ¡ä¹‹åï¼Œå¯¹æ•°æ®åº“çš„ä¿®æ”¹éƒ½ä¸¢å¼ƒäº†ã€‚</p>
<h3 id="å†…å­˜å‹æ•°æ®åº“"><span class="section-num">2.2</span> å†…å­˜å‹æ•°æ®åº“</h3>
<p>æ­£å¦‚æˆ‘ä»¬å…ˆå‰æåˆ°çš„ï¼Œ<code>SQLite</code> æ˜¯æ–‡ä»¶å‹æ•°æ®åº“ï¼Œå®ƒé€šè¿‡æ–‡ä»¶ç³»ç»Ÿæ¥ç®¡ç†æ•°æ®åº“ã€‚ä½†æ˜¯ <code>SQLite</code> ä¹Ÿå¯ä»¥æŠŠæ•´ä¸ªæ•°æ®åº“æ”¾åˆ°å†…å­˜ä¸­å»ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">sqlite3</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">schema_filename</span> <span class="o">=</span> <span class="s1">&#39;user.sql&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">with</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;:memory:&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">conn</span><span class="o">.</span><span class="n">row_factory</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Row</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Creating schema&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">schema_filename</span><span class="p">,</span> <span class="s1">&#39;rt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="n">schema</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">conn</span><span class="o">.</span><span class="n">executescript</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Inserting initial data&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    insert into role (name,description)
</span></span></span><span class="line"><span class="cl"><span class="s2">    values (&#39;Admin&#39;, &#39;wow, administrator&#39;
</span></span></span><span class="line"><span class="cl"><span class="s2">	    )
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">	<span class="p">(</span><span class="s1">&#39;Xi&#39;</span><span class="p">,</span> <span class="mi">119</span><span class="p">,</span> <span class="s1">&#39;1910-10-03&#39;</span><span class="p">,</span><span class="s1">&#39;president&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="p">(</span><span class="s1">&#39;Jiang&#39;</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="s1">&#39;2020-10-10&#39;</span><span class="p">,</span><span class="s1">&#39;president&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="p">(</span><span class="s1">&#39;Mao&#39;</span><span class="p">,</span> <span class="mi">10086</span><span class="p">,</span> <span class="s1">&#39;2010-10-17&#39;</span><span class="p">,</span><span class="s1">&#39;president&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">conn</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    insert into user (name, phone_number, birthday,role)
</span></span></span><span class="line"><span class="cl"><span class="s2">    values (?, ?, ?,?)
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Dumping:&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">conn</span><span class="o">.</span><span class="n">iterdump</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">	<span class="nb">print</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æƒ³è¦æŠŠ <code>SQLite</code> å½“ä½œå†…å­˜å‹æ•°æ®åº“ï¼Œåªéœ€åœ¨è°ƒç”¨ <code>connect()</code> å‡½æ•°çš„æ—¶å€™ï¼Œä½¿ç”¨ <code>:memory:</code> å‚æ•°è€Œä¸æ˜¯æ•°æ®åº“æ–‡ä»¶çš„æ–‡ä»¶åã€‚</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ¯ä¸€ä¸ª <code>connect()</code> å‡½æ•°éƒ½ä¼šæ‰“å¼€æ–°å»ºä¸€ä¸ªæ•°æ®åº“å®ä¾‹ï¼Œæ‰€ä»¥åœ¨ä¸€ä¸ªæ•°æ®åº“è¿æ¥ä¸Šçš„ä¿®æ”¹æ˜¯ä¸ä¼šå½±å“å…¶å®ƒçš„è¿æ¥çš„ã€‚</p>
<p>è€Œ <code>iterdump()</code> å‡½æ•°ä¼šè¿”å›ä¸€ä¸ªè¿­ä»£å™¨ï¼Œè¾“å‡ºä¸€ç³»åˆ—å¯¹æ•°æ®åº“ä¿®æ”¹çš„ SQL.</p>
<p>æœ€åéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä½¿ç”¨å†…å­˜å‹çš„æ•°æ®åº“æ˜¯æœ‰é£é™©çš„ï¼Œè¦åˆ‡è®°è¿™ä¸€ç‚¹ã€‚</p>
<h3 id="åœ¨sql-ä½¿ç”¨-python-å‡½æ•°"><span class="section-num">2.3</span> åœ¨SQL ä½¿ç”¨ Python å‡½æ•°</h3>
<p><code>SQLite</code> æ”¯æŒåœ¨æŸ¥è¯¢çš„æ—¶å€™ä½¿ç”¨æ³¨å†Œäº†çš„ Pythonå‡½æ•°çš„ï¼Œè¿™ä¸ªç‰¹æ€§å°±ä½¿æˆ‘ä»¬åœ¨å¯ä»¥è·å–åˆ° æŸ¥è¯¢ç»“æœä¹‹å‰å…ˆå¯¹æ•°æ®è¿›è¡ŒåŠ å·¥ï¼Œæˆ–è€…è°ƒç”¨Python å‡½æ•°å®ç°é‚£äº› çº¯SQL åŠ›æ‰€ä¸èƒ½åŠçš„åŠŸèƒ½</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">codecs</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">sqlite3</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">db_filename</span> <span class="o">=</span> <span class="s1">&#39;sqlite3_demo.db&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">encrypt</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Encrypting </span><span class="si">{!r}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">codecs</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s1">&#39;rot-13&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">decrypt</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Decrypting </span><span class="si">{!r}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">codecs</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s1">&#39;rot-13&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">with</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">conn</span><span class="o">.</span><span class="n">create_function</span><span class="p">(</span><span class="s1">&#39;encrypt&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">encrypt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">conn</span><span class="o">.</span><span class="n">create_function</span><span class="p">(</span><span class="s1">&#39;decrypt&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">decrypt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Raw values</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Original values:&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">query</span> <span class="o">=</span> <span class="s2">&#34;select id, name from user&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">	<span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Encrypting...&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">query</span> <span class="o">=</span> <span class="s2">&#34;update user set name = encrypt(name)&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Raw encrypted values:&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">query</span> <span class="o">=</span> <span class="s2">&#34;select id, name from user&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">	<span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Decrypting in query...&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">query</span> <span class="o">=</span> <span class="s2">&#34;select id, decrypt(name) from user&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">	<span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Decrypting...&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">query</span> <span class="o">=</span> <span class="s2">&#34;update user set name = decrypt(name)&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>é€šè¿‡ <code>create_function()</code> æ³¨å†Œäº†ä¸¤ä¸ªå¯ä¾› SQL ä½¿ç”¨çš„å‡½æ•°ï¼Œè€Œ <code>create_function()</code>
çš„å‚æ•°åˆ†åˆ«æ˜¯å®šä¹‰å‡½æ•°çš„åå­—ï¼Œå‡½æ•°ä¼ é€’çš„å‚æ•°çš„ä¸ªæ•°ï¼Œä»¥åŠæºå‡½æ•°</p>
<h2 id="æ€»ç»“"><span class="section-num">3</span> æ€»ç»“</h2>
<p>è™½è¯´ <code>SQLite</code> åªæ˜¯ä¸€ä¸ªåµŒå…¥å¼çš„è½»é‡æ•°æ®åº“ï¼Œä½†æ˜¯éº»é›€è™½å°ï¼Œäº”è„ä¿±å…¨å˜›ã€‚</p>
<p>å†…ç½®çš„ <code>sqlite3</code> åº“ä¸ºPython å’Œ <code>SQLite</code> çš„æ²Ÿé€šæ„å»ºäº†ä¸€ä¸ªä¾¿æ·çš„æ¡¥æ¢ï¼Œä½†æ˜¯è¿™ä¸ªæ¡¥æ¢åªæ˜¯ä¸ªæœ¨æ¡¥ï¼Œå¦‚æœä½ å¸Œæœ›ä½¿ç”¨æ–œæ‹‰ç´¢è·¨æµ·å¤§æ¡¥çš„è¯ï¼Œä½ å°±éœ€è¦å»äº†è§£ <a href="http://www.sqlalchemy.org/">sqlalchemy</a>, é‚£æ˜¯ä¸€ä¸ªåŠŸèƒ½å®Œå–„çš„ ORM æ¡†æ¶ :)</p>
<h2 id="å‚è€ƒ"><span class="section-num">4</span> å‚è€ƒ</h2>
<ul>
<li><a href="http://www.sqlalchemy.org/">sqlalchemy</a></li>
<li><a href="http://www.sqlite.org/">sqlite</a></li>
<li><a href="https://docs.python.org/3.5/library/sqlite3.html">sqlite3</a></li>
<li><a href="https://pymotw.com/3/index.html">python3 module of week</a></li>
</ul>
<div center class="qr-container">
<img src="/ox-hugo/qrcode_gh_e06d750e626f_1.jpg" alt="qrcode_gh_e06d750e626f_1.jpg" width="160px" height="160px" center="t" class="qr-container" />
å…¬å·åŒæ­¥æ›´æ–°ï¼Œæ¬¢è¿å…³æ³¨ğŸ‘»
</div>
]]></content:encoded>
    </item>
    <item>
      <title>  ä»äº¬ä¸œ&#34;çªƒå–&#34;150&#43;ä¸‡æ¡æ•°æ®
  </title>
      <link>https://ramsayleung.github.io/zh/post/2017/jd_spider/</link>
      <pubDate>Wed, 21 Jun 2017 00:00:00 -0700</pubDate>
      <guid>https://ramsayleung.github.io/zh/post/2017/jd_spider/</guid>
      <description>An spider to crawl jindong item and comments</description>
      <content:encoded><![CDATA[<p>æˆ‘æœ€è¿‘ç¼–å†™äº†ä¸¤åªäº¬ä¸œå•†å“å’Œè¯„è®ºçš„åˆ†å¸ƒå¼çˆ¬è™«æ¥è¿›è¡Œæ•°æ®åˆ†æï¼Œç°åœ¨å°±æ¥åˆ†äº«ä¸€ä¸‹ã€‚</p>
<h2 id="çˆ¬å–ç­–ç•¥"><span class="section-num">1</span> çˆ¬å–ç­–ç•¥</h2>
<p>ä¼—æ‰€å‘¨çŸ¥ï¼Œçˆ¬è™«æ¯”è¾ƒéš¾çˆ¬å–çš„å°±æ˜¯åŠ¨æ€ç”Ÿæˆçš„ç½‘é¡µï¼Œå› ä¸ºéœ€è¦è§£æ JS, å…¶ä¸­æ¯”è¾ƒå…¸å‹çš„ä¾‹å­å°±æ˜¯æ·˜å®ï¼Œå¤©çŒ«ï¼Œäº¬ä¸œï¼ŒQQ ç©ºé—´ç­‰ã€‚</p>
<p>æ‰€ä»¥åœ¨æˆ‘çˆ¬å–äº¬ä¸œç½‘ç«™çš„æ—¶å€™ï¼Œé¦–å…ˆéœ€è¦ç¡®å®šçš„å°±æ˜¯çˆ¬å–ç­–ç•¥ã€‚å› ä¸ºæˆ‘æƒ³è¦çˆ¬å–çš„æ˜¯å•†å“çš„ä¿¡æ¯ä»¥åŠç›¸åº”çš„è¯„è®ºï¼Œå¹¶æ²¡æœ‰çˆ¬å–ç‰¹å®šçš„å•†å“çš„éœ€æ±‚ã€‚æ‰€ä»¥åœ¨åˆ†æäº¬ä¸œçš„ç½‘é¡µçš„ url çš„æ—¶å€™, å†³å®šä½¿ç”¨ç±»ä¼¼å…¨ç«™çˆ¬å–çš„ç­–ç•¥ã€‚ åˆ†æå¦‚å›¾ï¼š</p>

<figure><a href="/ox-hugo/jd_analyze.png">
    
    
    <input type="checkbox" id="zoomCheck-0b0bf" hidden>
    <label for="zoomCheck-0b0bf">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/jd_analyze.png"/> 
    
    
    </label></a>
</figure>

<p>å¯ä»¥çœ‹å‡ºï¼Œäº¬ä¸œä¸åŒçš„å•†å“ç±»åˆ«æ˜¯å¯¹åº”ä¸åŒçš„å­åŸŸåçš„ï¼Œä¾‹å¦‚ <code>book</code> å¯¹åº”çš„æ˜¯å›¾ä¹¦ï¼Œ <code>mvd</code> å¯¹åº”çš„æ˜¯éŸ³åƒï¼Œ <code>shouji</code> å¯¹åº”çš„æ˜¯æ‰‹æœºç­‰ã€‚</p>
<p>å› ä¸ºæˆ‘ä½¿ç”¨çš„æ˜¯è·å– <code>&lt;a href&gt;</code> æ ‡ç­¾é‡Œé¢çš„ url å€¼ï¼Œç„¶åè¿­ä»£çˆ¬å–çš„ç­–ç•¥ã€‚æ‰€ä»¥è¦æŠŠçˆ¬å–çš„ url é™å®šåœ¨åŸŸåä¸º<del>jd.com</del> èŒƒå›´å†…ï¼Œä¸ç„¶å°±æœ‰å¯èƒ½ä¼šå‡ºç°æ— é™å¹¿åº¦ã€‚</p>
<p>æ­¤å¤–ï¼Œæœ‰ç›¸å½“å¤šçš„é¡µé¢æ˜¯ä¸ä¼šåŒ…å«å•†å“ä¿¡æ¯çš„ï¼›ä¾‹å¦‚ï¼š <code>help.jd.com</code>, <code>doc.jd.com</code> ç­‰ï¼Œå› æ­¤ä½¿ç”¨ <code>jd.com</code> è¿™ä¸ªåŸŸåèŒƒå›´å®åœ¨å¤ªå¤§äº†ï¼Œæ‰€ä»¥æŠŠæ‰€éœ€çš„å­åŸŸåéƒ½æ·»åŠ åˆ°ä¸€ä¸ª list :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">jd_subdomain</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;jiadian&#34;</span><span class="p">,</span> <span class="s2">&#34;shouji&#34;</span><span class="p">,</span> <span class="s2">&#34;wt&#34;</span><span class="p">,</span> <span class="s2">&#34;shuma&#34;</span><span class="p">,</span> <span class="s2">&#34;diannao&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;bg&#34;</span><span class="p">,</span> <span class="s2">&#34;channel&#34;</span><span class="p">,</span> <span class="s2">&#34;jipiao&#34;</span><span class="p">,</span> <span class="s2">&#34;hotel&#34;</span><span class="p">,</span> <span class="s2">&#34;trip&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;ish&#34;</span><span class="p">,</span> <span class="s2">&#34;book&#34;</span><span class="p">,</span> <span class="s2">&#34;e&#34;</span><span class="p">,</span> <span class="s2">&#34;health&#34;</span><span class="p">,</span> <span class="s2">&#34;baby&#34;</span><span class="p">,</span> <span class="s2">&#34;toy&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;nong&#34;</span><span class="p">,</span> <span class="s2">&#34;jiu&#34;</span><span class="p">,</span> <span class="s2">&#34;fresh&#34;</span><span class="p">,</span> <span class="s2">&#34;china&#34;</span><span class="p">,</span> <span class="s2">&#34;che&#34;</span><span class="p">,</span> <span class="s2">&#34;list&#34;</span><span class="p">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="æå–æ•°æ®"><span class="section-num">2</span> æå–æ•°æ®</h2>
<p>åœ¨ç¡®å®šäº†çˆ¬å–ç­–ç•¥ä¹‹åï¼Œçˆ¬è™«å°±å¯ä»¥ä¸æ–­åœ°è¿›è¡Œå·¥ä½œäº†ã€‚é‚£ä¹ˆçˆ¬è™«æ€ä¹ˆçŸ¥é“ä»€ä¹ˆæ—¶å€™æ‰æ˜¯å•†å“ä¿¡æ¯çš„é¡µé¢å‘¢ï¼Ÿå†æ¥åˆ†æä¸€ä¸‹äº¬ä¸œçš„å•†å“é¡µé¢ï¼š</p>

<figure><a href="/ox-hugo/jd_item_analyze.png">
    
    
    <input type="checkbox" id="zoomCheck-c8137" hidden>
    <label for="zoomCheck-c8137">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/jd_item_analyze.png"/> 
    
    
    </label></a>
</figure>

<p>ä»ä¸Šé¢çš„ä¿¡æ¯å¯ä»¥çœ‹å‡ºï¼Œæ¯ä¸ªå•†å“çš„é¡µé¢éƒ½æ˜¯ä»¥ <code>item.jd.com/xxxxxxx.html</code> çš„å½¢å¼å­˜ åœ¨çš„ï¼›è€Œ xxxxxxx å°±æ˜¯è¯¥å•†å“çš„ sku-id. æ‰€ä»¥åªéœ€å¯¹ url è¿›è¡Œè§£æï¼Œå­åŸŸåä¸º <code>item</code> å³å•†å“é¡µé¢ï¼Œå°±å¯ä»¥è¿›è¡Œçˆ¬å–ã€‚</p>
<p>é¡µé¢æå–ä½¿ç”¨ Xpath å³å¯ï¼Œä¹Ÿæ— éœ€èµ˜è¨€ã€‚ä¸è¿‡ï¼Œéœ€è¦æ³¨ æ„çš„æ˜¯å¯¹å•†å“è€Œè¨€ï¼Œéå¸¸é‡è¦çš„ä»·æ ¼å°±ä¸æ˜¯å¯ä»¥é€šè¿‡çˆ¬å– HTML é¡µé¢å¾—åˆ°çš„ã€‚</p>
<p>å› ä¸ºä»·æ ¼æ˜¯ç»å¸¸å˜åŠ¨çš„ï¼Œæ‰€ä»¥æ˜¯å¼‚æ­¥å‘åå°è¯·æ±‚çš„ã€‚å¯¹äºè¿™äº›å¼‚æ­¥è¯·æ±‚çš„æ•°æ®ï¼Œæ‰“å¼€æ§åˆ¶å°ï¼Œç„¶ååˆ·æ–°ï¼Œå°±å¯ä»¥çœ‹åˆ°ä¸€å †çš„ JS æ–‡ä»¶ï¼Œç„¶åå¯»æ‰¾ç›¸åº”çš„è¯·æ±‚å¸¦æœ‰ &ldquo;money æˆ–è€…price&rdquo; ä¹‹ç±»å…³ é”®å­—çš„ JS æ–‡ä»¶ï¼Œåº”è¯¥å°±èƒ½æ‰¾åˆ°ã€‚</p>
<p>å¦‚æœè¿˜æ²¡åŠæ³•æ‰¾å‡ºæ¥çš„è¯ï¼ŒFirefox ä¸Šæœ‰ä¸€ä¸ª <a href="https://addons.mozilla.org/en-US/firefox/addon/user-agent-switcher/">user-agent-switcher</a> çš„æ‰©å±•ï¼Œç„¶åé€šè¿‡è¿™ä¸ªæ‰©å±•æŠŠè‡ªå·±çš„æµè§ˆå™¨ä¼ªè£…æˆ IE6, ç›¸ä¿¡æ‰€æœ‰
èŠ±ä¿çš„ JS éƒ½ä¼šæ²¡äº†, åªå‰©ä¸‹é‚£äº›ä¸å¯æˆ–ç¼ºçš„ JS, è¿™æ ·ç»“æœåº”è¯¥ä¸€ç›®äº†ç„¶äº†ï¼Œè¿™ä¹ˆçœ‹æ¥ IE6 è¿˜æ˜¯æœ‰ç”¨æ»´ã€‚æœ€ç»ˆæ‰¾åˆ°çš„URL å¦‚ä¸‹
<code>https://p.3.cn/prices/mgets?callback=jQuery6646724&amp;type=1&amp;area=19_1601_3633_0.137875165&amp;pdtk=9D4RIAHY317A3bZnQNapD7ip5Dg%252F6NXiIXt90Ahk0if2Yyh39PZQCuDBlhN%252FxOch3MpwWpHICu4P%250AVcgcOm11GQ%253D%253D&amp;pduid=14966417675252009727775&amp;pdpin=%25E5%2585%2591%25E9%2587%2591%25E8%25BE%25B0%25E6%2589%258B&amp;pdbp=0&amp;skuIds=J_3356012&amp;ext=10000000&amp;source=item-pc</code></p>
<p>ä¸å¾—ä¸è¯´ï¼ŒURL å®åœ¨æ˜¯å¤ªé•¿äº†ã€‚</p>
<p>æ ¹æ®ç»éªŒï¼Œå¤§éƒ¨åˆ†çš„å‚æ•°åº”è¯¥éƒ½æ˜¯æ²¡ä»€ä¹ˆç”¨çš„ï¼Œåº”è¯¥å¯ä»¥å»æ‰çš„ï¼Œæ‰€ä»¥åœ¨æµè§ˆå™¨å°±ä¸€ä¸ªä¸ªå‚æ•°å»æ‰ï¼Œç„¶åè¯•è¯•è¯·æ±‚æ˜¯å¦æˆåŠŸï¼Œå¦‚æœæˆåŠŸï¼Œè¯´æ˜æ­¤å‚æ•°æ— å…³é‡è¦ï¼Œæœ€åç®€åŒ–æˆï¼š <code>http://p.3.cn/prices/mgets?pduid={}&amp;skuIds=J_{}</code> sku_id å³å•†å“é¡µé¢çš„ URLä¸­åŒ…å«çš„æ•°å­—ï¼Œè€Œ pduid åˆ™æ˜¯ä¸€éšæœºæ•´æ•°è€Œå·²ï¼Œç”¨
<code>random.randint(1, 100000000)</code> å‡½æ•°è§£å†³ã€‚</p>
<h2 id="å•†å“è¯„è®º"><span class="section-num">3</span> å•†å“è¯„è®º</h2>
<p>å•†å“çš„è¯„è®ºä¹Ÿæ˜¯ä»¥ sku-id ä¸ºå‚æ•°é€šè¿‡å¼‚æ­¥çš„æ–¹å¼è¿›è¡Œè¯·æ±‚çš„ï¼Œæ„é€ è¯·æ±‚çš„æ–¹æ³•è·Ÿä»·æ ¼ç±» ä¼¼ï¼Œä¹Ÿä¸éœ€è¿‡å¤šèµ˜è¿°ã€‚</p>
<p>åªæ˜¯æƒ³è¦åå˜ˆä¸€ä¸‹çš„æ˜¯ï¼Œäº¬ä¸œçš„è¯„è®ºæ˜¯åªèƒ½ä¸€é¡µé¡µå‘åç¿»çš„ï¼Œä¸èƒ½è·³è½¬ã€‚è¿˜æœ‰ä¸€ç‚¹å°±æ˜¯ï¼Œå³ä½¿æŸæ ·å•†å“æœ‰ 10+w æ¡è¯„è®ºï¼Œæœ€å¤šä¹Ÿåªæ˜¯è¿”å› 100é¡µçš„æ•°æ®ã€‚
ç•¥å‘</p>
<h2 id="åçˆ¬è™«ç­–ç•¥"><span class="section-num">4</span> åçˆ¬è™«ç­–ç•¥</h2>
<p>å•†å“çš„çˆ¬å–ç­–ç•¥ä»¥åŠæå–ç­–ç•¥éƒ½ç¡®å®šäº†ï¼Œä¸€åªçˆ¬è™«å°±åŸºæœ¬æˆå‹äº†ã€‚</p>
<p>ä½†æ˜¯ä¸€èˆ¬æ¯”è¾ƒå¤§å‹çš„ç½‘ç«™éƒ½æœ‰åçˆ¬è™«æªæ–½çš„ã€‚</p>
<p>æ‰€ä»¥é“é«˜ä¸€å°ºï¼Œé­”é«˜ä¸€ä¸ˆï¼Œçˆ¬è™«ä¹Ÿè¦æœ‰å¯¹åº”çš„ååçˆ¬è™«ç­–ç•¥</p>
<h3 id="ç¦ç”¨-cookie"><span class="section-num">4.1</span> ç¦ç”¨ cookie</h3>
<p>é€šè¿‡ç¦ç”¨ cookie, æœåŠ¡å™¨å°±æ— æ³•æ ¹æ® cookie åˆ¤æ–­å‡ºçˆ¬è™«æ˜¯å¦è®¿é—®è¿‡ç½‘ç«™</p>
<h3 id="è½®è½¬-user-agent"><span class="section-num">4.2</span> è½®è½¬ user-agent</h3>
<p>ä¸€èˆ¬çš„çˆ¬è™«éƒ½ä¼šä½¿ç”¨æµè§ˆå™¨çš„ user-agent æ¥æ¨¡æ‹Ÿæµè§ˆå™¨ä»¥æ¬ºéª—æœåŠ¡å™¨ (å½“ç„¶ï¼Œå¦‚æœä½ æ˜¯ä¸€åªä»€ä¹ˆ user-agentéƒ½ä¸ç”¨è€¿ç›´çš„å°çˆ¬è™«ï¼Œæˆ‘ä¹Ÿæ— è¯å¯è¯´).</p>
<p>ä¸ºäº†æé«˜çªç ´åçˆ¬è™«ç­–ç•¥çš„æˆåŠŸç‡ï¼Œå¯ä»¥å®šä¹‰å¤šä¸ª user-agent, ç„¶åæ¯æ¬¡è¯·æ±‚éƒ½éšæœºé€‰æ‹© user-agentã€‚</p>
<h3 id="ä¼ªè£…æˆæœç´¢å¼•æ“"><span class="section-num">4.3</span> ä¼ªè£…æˆæœç´¢å¼•æ“</h3>
<p>è¦è¯´æœ€è‘—åçš„çˆ¬è™«æ˜¯è°ï¼Ÿè‚¯å®šæ˜¯æœç´¢å¼•æ“ï¼Œå®ƒæœ¬è´¨ä¸Šä¹Ÿæ˜¯çˆ¬è™«ï¼Œè€Œä¸”æ˜¯éå¸¸å¼ºå¤§çš„çˆ¬è™«ã€‚</p>
<p>è€Œä¸”è¿™äº›çˆ¬è™«å¯ä»¥å…‰æ˜æ­£å¤§åœ°å»çˆ¬å–å„å¼ç½‘ç«™ï¼Œç›¸ä¿¡å„å¼ç½‘ç«™ä¹Ÿå¾ˆä¹æ„è¢«å®ƒçˆ¬ã€‚</p>
<p>é‚£ä¹ˆï¼Œ ç°åœ¨å¯ä»¥é€šè¿‡ä¿®æ”¹ user-agent ä¼ªè£…æˆæœç´¢å¼•æ“ï¼Œç„¶åå†ç»“åˆä¸Šé¢çš„è½®è½¬ user-agent,</p>
<p>ä¼ªè£…æˆå„å¼æœç´¢å¼•æ“ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">&#39;Mozilla/5.0 (compatible; Googlebot/2.1; +http://www.google.com/bot.html)&#39;,
</span></span><span class="line"><span class="cl">&#39;Mozilla/5.0 (compatible; Bingbot/2.0; +http://www.bing.com/bingbot.htm)&#39;,
</span></span><span class="line"><span class="cl">&#39;Mozilla/5.0 (compatible; Yahoo! Slurp; http://help.yahoo.com/help/us/ysearch/slurp)&#39;,
</span></span><span class="line"><span class="cl">&#39;DuckDuckBot/1.0; (+http://duckduckgo.com/duckduckbot.html)&#39;,
</span></span><span class="line"><span class="cl">&#39;Mozilla/5.0 (compatible; Baiduspider/2.0; +http://www.baidu.com/search/spider.html)&#39;,
</span></span><span class="line"><span class="cl">&#39;Mozilla/5.0 (compatible; YandexBot/3.0; +http://yandex.com/bots)&#39;,
</span></span><span class="line"><span class="cl">&#39;ia_archiver (+http://www.alexa.com/site/help/webmasters; crawler@alexa.com)&#39;,
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="ä»£ç†-ip"><span class="section-num">4.4</span> ä»£ç† IP</h3>
<p>è™½è¯´å¯ä»¥ä¼ªè£…æˆæœç´¢å¼•æ“ï¼Œä½†æ˜¯å› ä¸º http è¯·æ±‚æ˜¯å»ºç«‹åœ¨ä¸‰æ¬¡æ¡æ‰‹ä¹‹ä¸Šçš„ï¼Œçˆ¬è™«çš„ IP è¿˜æ˜¯ä¼šè¢«è®°å½•ä¸‹æ¥çš„ï¼Œå¦‚æœåŒä¸€ä¸ª IP è®¿é—®å¾—å¤ªé¢‘ç¹ï¼Œé‚£åŸºæœ¬å°±å¯ä»¥ç¡®å®šæ˜¯ä¸€åªçˆ¬è™«äº†ï¼Œç„¶åå°±æŠŠå®ƒçš„ IP å°æ‰ï¼Œæ¸©å’Œä¸€ç‚¹çš„å°±ä¼šå«ä½ è¾“å…¥éªŒè¯ç ï¼Œä¸ç„¶å°±è¿”å› 403.</p>
<p>å¯¹å¾…è¿™ç§æƒ…å†µï¼Œå°±éœ€è¦ä½¿ç”¨ä»£ç† IP äº†ã€‚</p>
<p>åªæ˜¯ä»£ç† IP éƒ½æœ‰ä¸åŒç¨‹åº¦çš„å»¶è¿Ÿï¼Œå¹¶ä¸”å…è´¹çš„ IP å¤§å¤šä¸èƒ½ç”¨ï¼Œæ‰€ä»¥è¿™æ˜¯ä¸å¾—è€Œä¸ºä¹‹äº†</p>
<h2 id="æ‰©å±•æˆåˆ†å¸ƒå¼çˆ¬è™«"><span class="section-num">5</span> æ‰©å±•æˆåˆ†å¸ƒå¼çˆ¬è™«</h2>
<p>ä¸€å°æœºå™¨çš„çˆ¬è™«å¯èƒ½çˆ¬å–ä¸€ä¸ªç½‘ç«™å¯èƒ½éœ€è¦ 100 å¤©ï¼Œè€Œä¸”å¸¦å®½ä¹Ÿåˆ°è¾¾ç“¶é¢ˆäº†ï¼Œé‚£ä¹ˆæ˜¯å¦å¯ä»¥æé«˜çˆ¬å–æ•ˆç‡å‘¢ï¼Ÿ</p>
<p>é‚£å°±ç”¨ 100å°æœºå™¨ï¼Œ1å¤©åº”è¯¥å°±èƒ½çˆ¬å–å®Œ (å½“ç„¶ï¼Œç°å®å¹¶éå¦‚æ­¤ç¾å¥½).</p>
<p>è¿™ä¸ªå°±æ¶‰åŠåˆ°åˆ†å¸ƒå¼çš„çˆ¬è™«çš„é—®é¢˜ã€‚è€Œä¸åŒçš„åˆ†å¸ƒå¼çˆ¬è™«æœ‰ä¸åŒçš„å®ç°æ–¹æ³•ï¼Œè€Œæˆ‘é€‰æ‹©äº† scrapy å’Œ redis æ•´åˆçš„ <a href="https://github.com/rolando/scrapy-redis">scrapy-redis</a> æ¥å®ç°åˆ†å¸ƒå¼ï¼ŒURL çš„å»é‡ä»¥åŠè°ƒåº¦éƒ½æœ‰äº†ç›¸åº”çš„å®ç°äº†ï¼Œä¹Ÿæ— éœ€é¢å¤–çš„æ“å¿ƒ</p>
<h2 id="çˆ¬è™«ç›‘æ§"><span class="section-num">6</span> çˆ¬è™«ç›‘æ§</h2>
<p>æ—¢ç„¶çˆ¬è™«ä»å•æœºå˜æˆäº†åˆ†å¸ƒå¼ï¼Œæ–°çš„é—®é¢˜éšä¹‹è€Œæ¥ï¼šå¦‚ä½•ç›‘æ§åˆ†å¸ƒå¼çˆ¬è™«å‘¢ï¼Ÿåœ¨å•æœºçš„æ—¶å€™ï¼Œæœ€ç®€å•çš„ç›‘æ§ &ndash; ç›´æ¥å°†çˆ¬è™«çš„æ—¥å¿—ä¿¡æ¯è¾“å‡ºåˆ°ç»ˆç«¯å³å¯ã€‚</p>
<p>ä½†æ˜¯å¯¹äºåˆ†å¸ƒå¼çˆ¬è™«ï¼Œè¿™æ ·çš„åšæ³•æ˜¾ç„¶ä¸ç°å®ã€‚æˆ‘æœ€ç»ˆé€‰æ‹©ä½¿ç”¨ <a href="https://graphiteapp.org">graphite</a> è¿™ä¸ªç›‘æ§å·¥å…·ã€‚</p>
<h3 id="scrapy-graphite"><span class="section-num">6.1</span> scrapy-graphite</h3>
<p>å‚è€ƒ Githubä¸Š <a href="https://github.com/gnemoug/distribute_crawler">distributed_crawler</a> çš„ä»£ç ï¼Œå°†å•æœºç‰ˆæœ¬çš„ <a href="https://github.com/noplay/scrapy-graphite">scrapy-graphite</a> æ‰©å±•æˆåŸºäºåˆ†å¸ƒå¼çš„ graphite ç›‘æ§ç¨‹åºï¼Œå¹¶ä¸”å®ç°å¯¹ python3 çš„æ”¯æŒã€‚</p>
<h3 id="docker"><span class="section-num">6.2</span> docker</h3>
<p>ä½†æ˜¯ graphite åªæ˜¯æ”¯æŒ python2, å¹¶ä¸”å®‰è£…è¿‡ç¨‹å¾ˆéº»çƒ¦ï¼Œæˆ‘åœ¨æŠ˜è…¾å¤§åŠå¤©åéƒ½æ— æ³•å®‰è£…æˆåŠŸï¼Œå®åœ¨æœ‰ç‚¹æ²®ä¸§ã€‚æœ€åæƒ³èµ·äº†ä¼Ÿå¤§çš„ docker, å¹¶ä¸”ç›´æ¥æ‰¾åˆ°å·²ç»æ‰“åŒ…å¥½çš„image. æ•°è¡Œå‘½ä»¤å³è§£å†³æ‰€æœ‰çš„å®‰è£…é—®é¢˜ï¼Œä¸å¾—ä¸è¯´ï¼šdocker, ä½ å€¼å¾—æ‹¥æœ‰ã€‚è¿è¡Œæˆªå›¾ï¼š</p>

<figure><a href="/ox-hugo/jd_comment_graphite1.png">
    
    
    <input type="checkbox" id="zoomCheck-cd205" hidden>
    <label for="zoomCheck-cd205">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/jd_comment_graphite1.png"/> 
    
    
    </label></a>
</figure>


<figure><a href="/ox-hugo/jd_comment_graphite2.png">
    
    
    <input type="checkbox" id="zoomCheck-97ae9" hidden>
    <label for="zoomCheck-97ae9">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/jd_comment_graphite2.png"/> 
    
    
    </label></a>
</figure>

<h2 id="çˆ¬è™«æ‹†åˆ†"><span class="section-num">7</span> çˆ¬è™«æ‹†åˆ†</h2>
<p>æœ¬æ¥çˆ¬å–å•†å“ä¿¡æ¯çš„çˆ¬è™«å’Œçˆ¬å–è¯„è®ºçš„çˆ¬è™«éƒ½æ˜¯åŒä¸€åªçˆ¬è™«ï¼Œä½†æ˜¯åæ¥å‘ç°ï¼Œå†ä¸ä½¿ç”¨ä»£ç† IP çš„æƒ…å†µä¸‹ï¼Œçˆ¬å–åˆ° 150000 æ¡å•†å“ä¿¡æ¯çš„æ—¶å€™ï¼Œéœ€è¦è¾“å…¥éªŒè¯ç ã€‚</p>
<p>ä½†æ˜¯çˆ¬å–å•†å“è¯„è®ºçš„çˆ¬è™«å¹¶ä¸å­˜åœ¨è¢«åçˆ¬ç­–ç•¥é™åˆ¶çš„æƒ…å†µã€‚æ‰€ä»¥æˆ‘å°†çˆ¬è™«æ‹†åˆ†æˆä¸¤åªçˆ¬è™«ï¼Œå³ä½¿æ— æ³•çˆ¬å–å•†å“ä¿¡æ¯çš„æ—¶å€™ï¼Œè¿˜å¯ä»¥çˆ¬å–å•†å“çš„è¯„è®ºä¿¡æ¯ã€‚</p>
<h2 id="å°ç»“"><span class="section-num">8</span> å°ç»“</h2>
<p>åœ¨çˆ¬å–ä¸€å¤©ä¹‹åï¼Œçˆ¬è™«æˆæœï¼š</p>
<h3 id="è¯„è®º"><span class="section-num">8.1</span> è¯„è®º</h3>

<figure><a href="/ox-hugo/jd_comment.png">
    
    
    <input type="checkbox" id="zoomCheck-8be27" hidden>
    <label for="zoomCheck-8be27">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/jd_comment.png"/> 
    
    
    </label></a>
</figure>

<h3 id="è¯„è®ºæ€»ç»“"><span class="section-num">8.2</span> è¯„è®ºæ€»ç»“</h3>

<figure><a href="/ox-hugo/jd_comment_summary.png">
    
    
    <input type="checkbox" id="zoomCheck-fc61f" hidden>
    <label for="zoomCheck-fc61f">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/jd_comment_summary.png"/> 
    
    
    </label></a>
</figure>

<h3 id="å•†å“ä¿¡æ¯"><span class="section-num">8.3</span> å•†å“ä¿¡æ¯</h3>

<figure><a href="/ox-hugo/jd_parameters.png">
    
    
    <input type="checkbox" id="zoomCheck-29f68" hidden>
    <label for="zoomCheck-29f68">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/jd_parameters.png"/> 
    
    
    </label></a>
</figure>

<p>å•†å“ä¿¡æ¯åŠ ä¸Šè¯„è®ºæ•°çº¦ 150+w.</p>
<h2 id="å‚è€ƒåŠè‡´è°¢"><span class="section-num">9</span> å‚è€ƒåŠè‡´è°¢</h2>
<ul>
<li><a href="https://github.com/noplay/scrapy-graphite">https://github.com/noplay/scrapy-graphite</a></li>
<li><a href="https://github.com/gnemoug/distribute_crawler">https://github.com/gnemoug/distribute_crawler</a></li>
<li><a href="https://github.com/hopsoft/docker-graphite-statsd">https://github.com/hopsoft/docker-graphite-statsd</a></li>
</ul>
<h2 id="é¡¹ç›®æºç "><span class="section-num">10</span> é¡¹ç›®æºç </h2>
<p><a href="https://github.com/ramsayleung/jd_spider">https://github.com/ramsayleung/jd_spider</a></p>
<div class="qr-container" center>
<img src="/ox-hugo/qrcode_gh_e06d750e626f_1.jpg" alt="qrcode_gh_e06d750e626f_1.jpg" class="qr-container" width="160px" height="160px" center="t" />
å…¬å·åŒæ­¥æ›´æ–°ï¼Œæ¬¢è¿å…³æ³¨ğŸ‘»
</div>
]]></content:encoded>
    </item>
    <item>
      <title>ä½ æ‰€ä¸å¯æˆ–ç¼ºçš„ â€“ logging</title>
      <link>https://ramsayleung.github.io/zh/post/2017/logging/</link>
      <pubDate>Sun, 09 Apr 2017 00:00:00 +0800</pubDate>
      <guid>https://ramsayleung.github.io/zh/post/2017/logging/</guid>
      <description>an introduction about logging</description>
      <content:encoded><![CDATA[<h2 id="é‡è¦æ€§"><span class="section-num">1</span> é‡è¦æ€§</h2>
<p>ç¬”è€…æœ€è¿‘éƒ½åœ¨è´Ÿè´£é¡¹ç›®ä¸­å…³äºæ—¥å¿—çš„éƒ¨åˆ†ï¼Œå› ä¸ºè·Ÿæ—¥å¿—æ‰“äº¤é“æ¯”è¾ƒå¤šï¼Œæ‰€ä»¥æœ‰ä¸€äº›å…³äºæ—¥ å¿—æ„Ÿå—å’ŒæŠ€å·§æƒ³è¦åˆ†äº«ä¸€ä¸‹ã€‚</p>
<p>ç¬”è€…è®¤ä¸ºå¯¹äºå„ç§ç¨‹åºå’Œåº”ç”¨ï¼Œæ—¥å¿—éƒ½æ˜¯éå¸¸é‡è¦çš„ï¼Œå› ä¸ºç¨‹åºåœ¨éƒ¨å±åˆ°æœåŠ¡å™¨ä¹‹åï¼Œå¼€å‘è€…æ˜¯æ²¡åŠæ³•åƒåœ¨æœ¬åœ°å¼€å‘é‚£æ ·å¯ä»¥å……åˆ†äº†è§£ç¨‹åºå‘ç”Ÿçš„çŠ¶å†µï¼Œè€Œä½¿ç”¨æ—¥å¿—å¯ä»¥è®©å¼€å‘è€…äº†è§£è¿è¡Œä¸­çš„ç¨‹åºçš„çŠ¶æ€ï¼Œå³ä½¿å‡ºç°äº†é”™è¯¯ï¼Œæˆ–è€…æ˜¯ç³»ç»ŸæŒ‚äº†ï¼Œä¹Ÿå¯ä»¥ä»æ—¥å¿—ä¸­åˆ†æåŸå› ã€‚</p>
<p>æ‰€ä»¥æ¢å¥è¯è¯´ï¼Œæ—¥å¿—çš„é‡è¦ç¨‹åº¦ç”šè‡³å¯ä»¥ç§°å¾—ä¸Šæ˜¯ä¸å¯æˆ–ç¼ºã€‚æ¥ä¸‹æ¥ï¼Œç¬”è€…å°†ä¼šä»¥ Python ä¸­çš„ <em>logging</em> æ¨¡å—ä¸ºä¾‹é˜è¿°æ—¥å¿—ã€‚</p>
<h2 id="å…³äºæ—¥å¿—"><span class="section-num">2</span> å…³äºæ—¥å¿—</h2>
<h3 id="ä½¿ç”¨-print-å‡½æ•°è¾“å‡º"><span class="section-num">2.1</span> ä½¿ç”¨ print å‡½æ•°è¾“å‡ºï¼Ÿ</h3>
<p>æ—¥å¿—æ˜¯ä¸ºäº†è¾“å‡ºç¨‹åºçš„è¿è¡ŒçŠ¶æ€ï¼Œé‚£ä¹ˆå¯å¦ä½¿ç”¨ <code>print</code> å‡½æ•°è¿›è¡Œ logging çš„å·¥ä½œå‘¢ï¼Ÿ</p>
<p>æˆ‘å¹¶ä¸å»ºè®®æŠŠ <code>print()</code> å‡½æ•°å½“ä½œæ—¥å¿—ä½¿ç”¨ (å½“ç„¶ï¼Œå¦‚æœä½ ä¸€å®šè¦è¿™ä¹ˆç”¨ï¼Œæˆ‘ä¹Ÿæ‹¦ä¸ä½)ï¼›ä¸å»ºè®®ä½¿ç”¨ <strong>print</strong> è¿›è¡Œlogging åŸå› æœ‰ï¼š</p>
<ol>
<li>æ— æ³•åœ¨ä¸ä¿®æ”¹æºä»£ç çš„æƒ…å†µä¸‹ï¼Œæ§åˆ¶æ—¥å¿—çš„è¾“å‡º</li>
<li>æ—¥å¿—ä¿¡æ¯å¯èƒ½è·Ÿç¨‹åºè¾“å‡ºçš„æœ‰ç”¨æ•°æ®æ··æ‚ï¼Œå¯¼è‡´è¾“å‡ºçš„æ•°æ®ä¸å¯è¯»æˆ–è€…éå¸¸éš¾è¯»</li>
<li>print æ— æ³•å°†æ—¥å¿—ä¿¡æ¯è¾“å‡ºåˆ°é™¤æ ‡å‡†è¾“å‡ºä»¥å¤–çš„ç›®æ ‡ (ä¾‹å¦‚æ–‡ä»¶ï¼Œsocket,SMTP æœåŠ¡å™¨ç­‰)</li>
<li>æ— æ³•æ ¹æ®é”™è¯¯ä¿¡æ¯çš„ç­‰çº§è¿›è¡ŒåŠ¨æ€è¾“å‡ºï¼Œå› ä¸º <strong>print</strong> å‡½æ•°çš„ä½œç”¨åªæ˜¯è¾“å‡ºä¿¡æ¯</li>
</ol>
<p>å¯èƒ½å¯¹äºéå¸¸ç®€å•çš„å°ç¨‹åºï¼Œå¼€å‘è€…å¯ä»¥ä½¿ç”¨ print è¿›è¡Œæ—¥å¿—è¾“å‡ºï¼Œä½†æ˜¯å¯¹äºæ¯”è¾ƒå¤§å‹çš„ç¨‹åºï¼Œç³»ç»Ÿå†…ç½®çš„ logging ç±»åº“æˆ–è®¸æ˜¯æ›´å¥½çš„é€‰æ‹©</p>
<h3 id="æ—¥å¿—éœ€è¦è®°å½•çš„æ˜¯ä»€ä¹ˆ"><span class="section-num">2.2</span> æ—¥å¿—éœ€è¦è®°å½•çš„æ˜¯ä»€ä¹ˆ</h3>
<p>Python çš„æ—¥å¿—ç±»åº“ <code>logging</code> å¯ä»¥è®©å¼€å‘è€…æ ¹æ®ä¸åŒåœºæ™¯ä½¿ç”¨ä¸åŒçš„æ—¥å¿—ç­‰çº§ä»¥è¾“å‡º ä¸åŒçš„æ—¥å¿—ä¿¡æ¯ã€‚</p>
<p>è€Œæ—¥å¿—éœ€è¦è®°å½•çš„æœ€åŸºæœ¬çš„ä¿¡æ¯åˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿè¦æƒ³å›ç­”è¿™ä¸ªé—®é¢˜ï¼Œå…ˆå’Œæˆ‘ä¸€èµ·å›é¡¾ä¸€ä¸‹æ—¥å¿—çš„åŠŸèƒ½ï¼šè®°å½•ç¨‹åºçš„çŠ¶æ€ï¼Œä¸ºç¨‹åºçš„å¼€å‘å’Œè°ƒè¯•æä¾›ä¾¿åˆ©ï¼</p>
<p>æ‰€è°“æ–¹ä¾¿è°ƒè¯•ï¼Œéœ€è¦è®°å½•çš„å¿…ç„¶åŒ…æ‹¬å¯ä»¥å¸®åŠ©æ›´å¿«å®šä½åˆ°é”™è¯¯çš„æœ‰ç”¨ä¿¡æ¯ï¼š</p>
<ol>
<li>Logger çš„åå­— (æ¯”è¾ƒå¸¸ç”¨çš„åšæ³•éƒ½æ˜¯ <strong>__name__</strong>,å³å½“å‰æ–‡ä»¶çš„ä¿¡æ¯)</li>
<li>å…·ä½“æ—¥æœŸ (è¿™ä¸ªå¯ä»¥å¸®åŠ©ç¡®å®šå‡ºé”™çš„å…·ä½“åœºæ™¯)</li>
<li>æ–¹æ³•å</li>
<li>æºä»£ç è¡Œæ•°</li>
<li>å¼‚å¸¸çš„ traceback ä¿¡æ¯</li>
</ol>
<p>è¿™åªæ˜¯æœ€åŸºæœ¬çš„ä¿¡æ¯ï¼Œå…·ä½“è¿˜è¦æ ¹æ®åœºæ™¯æ·»åŠ å…¶å®ƒæœ‰ç”¨ä¿¡æ¯ï¼›æ¯”å¦‚å¯¹äºåˆ†å¸ƒå¼çš„ç¨‹åºï¼Œè‚¯å®šè¿˜è¦è®°å½•å…¶å®ƒèŠ‚ç‚¹çš„åå­—ï¼ŒIP ç­‰æœ‰ç”¨ä¿¡æ¯ã€‚</p>
<h2 id="logging-çš„æ­£ç¡®å§¿åŠ¿"><span class="section-num">3</span> Logging çš„æ­£ç¡®å§¿åŠ¿</h2>
<h3 id="ä½¿ç”¨-python-çš„-logging-æ¨¡å—"><span class="section-num">3.1</span> ä½¿ç”¨ Python çš„ logging æ¨¡å—</h3>
<p>æˆ‘è®¤ä¸ºï¼Œä½¿ç”¨ Python çš„æ ‡å‡†æ—¥å¿—åº“æ˜¯æ¯”è¾ƒå¥½çš„å®è·µï¼Œå› ä¸ºæ ‡å‡†åº“å·²ç»æä¾›äº†å¼€ç®±å³ç”¨çš„ç‰¹æ€§ï¼Œæ— éœ€é‡å¤é€ è½®å­ã€‚Python çš„ logging æ¨¡å—ä¹Ÿå¾ˆå®¹æ˜“ä¸Šæ‰‹ï¼Œä¸¾ä¸ªå°ä¾‹å­ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">logging</span>
</span></span><span class="line"><span class="cl"><span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># define a logger</span>
</span></span><span class="line"><span class="cl"><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#Info level msg</span>
</span></span><span class="line"><span class="cl"><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Info level message&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#Debug level msg</span>
</span></span><span class="line"><span class="cl"><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Debug level message&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#Warning level msg</span>
</span></span><span class="line"><span class="cl"><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Warning level message&#39;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ—¥å¿—è¾“å‡ºå¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">INFO:__main__: Info level message
</span></span><span class="line"><span class="cl">DEBUG:__main__: Debug level message
</span></span><span class="line"><span class="cl">WARN:__main__: Warning level message
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="è®°å½•å¼‚å¸¸ä¿¡æ¯"><span class="section-num">3.2</span> è®°å½•å¼‚å¸¸ä¿¡æ¯</h3>
<p>æ—¥å¿—ä¸€ä¸ªéå¸¸é‡è¦çš„ä½œç”¨å°±æ˜¯è°ƒè¯•ï¼Œæ‰€ä»¥è®°å½•å‡ºç°å¼‚å¸¸çš„åœ°æ–¹æ˜¯æœ‰å¿…è¦ï¼Œå¹¶ä¸”éœ€è¦è®°å½•æ ˆçš„è°ƒç”¨ä¿¡æ¯ã€‚ä¾‹å¦‚ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;file_not_exist.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;wt&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Failed to write a file&#39;</span><span class="p">,</span><span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>é€šè¿‡å°† <code>exc_info</code> è®¾ç½®æˆ True, æ ˆçš„è°ƒç”¨ä¿¡æ¯å°±ä¼šè®°å½•åˆ°æ—¥å¿—é‡Œé¢ã€‚è€Œä¹Ÿå¯ä»¥ä½¿ç”¨ <code>logger.exception(message,*args)</code> æ–¹æ³•ï¼Œå®ƒç­‰åŒäº <code>logger.error(msg,exc_info=True,*args)</code> æ–¹æ³•ã€‚</p>
<h3 id="ä½¿ç”¨æ—¥å¿—æ–‡ä»¶è½®è½¬æ§åˆ¶å™¨--rotating-file-handler"><span class="section-num">3.3</span> ä½¿ç”¨æ—¥å¿—æ–‡ä»¶è½®è½¬æ§åˆ¶å™¨ (rotating file handler)</h3>
<p>å¦‚æœä½¿ç”¨æ—¥å¿—æ–‡ä»¶æ§åˆ¶å™¨ (FileHandler), ä¸æ–­åœ°è¿è¡Œç¨‹åºï¼Œå°±ä¼šäº§ç”Ÿè¶Šæ¥è¶Šå¤šçš„æ—¥å¿— ä¿¡æ¯æˆ–è€…æ˜¯æ—¥å¿—æ–‡ä»¶ã€‚</p>
<p>ä¸ºäº†æ§åˆ¶æ—¥å¿—æ–‡ä»¶çš„æ•°é‡ï¼Œå¯ä»¥ä½¿ç”¨ <code>RotatingFileHandler</code> è‡ª åŠ¨æ–°å»ºæ–°çš„æ—¥å¿—æ–‡ä»¶ï¼Œå¹¶ä¸”ä¿ç•™æ—§çš„æ—¥å¿—æ–‡ä»¶ï¼Œå½“äº§ç”Ÿä¸€å®šæ•°é‡çš„æ—¥å¿—æ–‡ä»¶ä¹‹åï¼Œå°±ä¼š è‡ªåŠ¨åˆ é™¤æ‰æœ€æ—§çš„æ—¥å¿—æ–‡ä»¶ã€‚ä¾‹å¦‚ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">RotatingFileHandler</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">LOG_FILENAME</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">maxBytes</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">backupCount</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">my_logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å°±æ˜¯æ—¥å¿—æ–‡ä»¶å¤§å°è¶…è¿‡20ä¸ªå­—èŠ‚ (å½“ç„¶ï¼ŒçœŸå®æƒ…å†µä¸ä¼šé‚£ä¹ˆå°çš„é˜€å€¼)ï¼Œå°±åˆ›å»ºä¸€ä¸ªæ–°çš„æ—¥å¿—æ–‡ä»¶ï¼ŒæŠŠåŸæ¥çš„æ—¥å¿—æ–‡ä»¶ï¼Œä¾‹å¦‚å« <em>example.log</em> é‡å‘½åä¸º <em>example.log.1</em>,ç„¶åæ–°å»ºçš„æ—¥å¿—æ–‡ä»¶å°±ä¼šè¢«å‘½åä¸º_example.log_, ä¸€ç›´åˆ°äº§ç”Ÿäº†6ä¸ªæ—¥å¿—æ–‡ä»¶ï¼Œå³ <em>example.log.5</em>, ç»§ç»­è®°å½•æ—¥å¿—ï¼Œæœ€å¼€å§‹çš„ç¬¬ä¸€ä¸ªæ—¥å¿—å°±ä¼šè¢«åˆ é™¤ã€‚</p>
<h3 id="ä½¿ç”¨æ—¥å¿—æœåŠ¡å™¨"><span class="section-num">3.4</span> ä½¿ç”¨æ—¥å¿—æœåŠ¡å™¨</h3>
<p>å¯¹äºé‚£äº›åˆ†å¸ƒå¼çš„åº”ç”¨ï¼Œæˆ–è€…éƒ¨ç½²å¤šå°æœåŠ¡å™¨ä¸Šæœ‰ä¸åŒæ—¥å¿—çš„ç¨‹åºè€Œè¨€ï¼Œé€ä¸ªæœåŠ¡å™¨æˆ–è€…èŠ‚ç‚¹æŸ¥çœ‹æ—¥å¿—å®åœ¨å¤ªå¯æ€•äº†. è¿™ä¸ªæ—¶å€™ï¼Œå°±å¯ä»¥è®¾ç½®ä¸€ä¸ªæ—¥å¿—æœåŠ¡å™¨ï¼ŒæŠŠé‡è¦çš„æ—¥å¿—ä¿¡æ¯å‘é€åˆ°æ—¥å¿—æœåŠ¡å™¨ï¼Œä½ å°±åœ¨æ—¥å¿—æœåŠ¡å™¨ä¸Šç›‘æ§å„ä¸ªèŠ‚ç‚¹çš„æ—¥å¿—çŠ¶æ€äº†ã€‚</p>
<p><a href="https://docs.python.org/3/howto/logging-cookbook.html">logging-cookbook</a> çš„ä¾‹å­ï¼š</p>
<p>å®¢æˆ·ç«¯æˆ–è€…èŠ‚ç‚¹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">logging</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">logging.handlers</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">rootLogger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">rootLogger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">socketHandler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">SocketHandler</span><span class="p">(</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">						    <span class="n">logging</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">DEFAULT_TCP_LOGGING_PORT</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># don&#39;t bother with a formatter, since a socket handler sends the event as</span>
</span></span><span class="line"><span class="cl"><span class="c1"># an unformatted pickle</span>
</span></span><span class="line"><span class="cl"><span class="n">rootLogger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">socketHandler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Now, we can log to the root logger, or any other logger. First the root...</span>
</span></span><span class="line"><span class="cl"><span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Jackdaws love my big sphinx of quartz.&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Now, define a couple of other loggers which might represent areas in your</span>
</span></span><span class="line"><span class="cl"><span class="c1"># application:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">logger1</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;myapp.area1&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">logger2</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;myapp.area2&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">logger1</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Quick zephyrs blow, vexing daft Jim.&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">logger1</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;How quickly daft jumping zebras vex.&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">logger2</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Jail zesty vixen who grabbed pay from quack.&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">logger2</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;The five boxing wizards jump quickly.&#39;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ—¥å¿—æœåŠ¡å™¨ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">logging</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">logging.handlers</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">pickle</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">socketserver</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">struct</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">LogRecordStreamHandler</span><span class="p">(</span><span class="n">socketserver</span><span class="o">.</span><span class="n">StreamRequestHandler</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Handler for a streaming logging request.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    This basically logs the record using whatever logging policy is
</span></span></span><span class="line"><span class="cl"><span class="s2">    configured locally.
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">	<span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">	Handle multiple requests - each expected to be a 4-byte length,
</span></span></span><span class="line"><span class="cl"><span class="s2">	followed by the LogRecord in pickle format. Logs the record
</span></span></span><span class="line"><span class="cl"><span class="s2">	according to whatever policy is configured locally.
</span></span></span><span class="line"><span class="cl"><span class="s2">	&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	    <span class="n">chunk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">break</span>
</span></span><span class="line"><span class="cl">	    <span class="n">slen</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&gt;L&#39;</span><span class="p">,</span> <span class="n">chunk</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">	    <span class="n">chunk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">slen</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">slen</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="n">chunk</span> <span class="o">=</span> <span class="n">chunk</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">slen</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unPickle</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="n">record</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">makeLogRecord</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="bp">self</span><span class="o">.</span><span class="n">handleLogRecord</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">unPickle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">handleLogRecord</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">	<span class="c1"># if a name is specified, we use the named logger rather than the one</span>
</span></span><span class="line"><span class="cl">	<span class="c1"># implied by the record.</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">logname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	    <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">logname</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	    <span class="n">name</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">name</span>
</span></span><span class="line"><span class="cl">	    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	    <span class="c1"># N.B. EVERY record gets logged. This is because Logger.handle</span>
</span></span><span class="line"><span class="cl">	    <span class="c1"># is normally called AFTER logger-level filtering. If you want</span>
</span></span><span class="line"><span class="cl">	    <span class="c1"># to do filtering, do it at the client end to save wasting</span>
</span></span><span class="line"><span class="cl">	    <span class="c1"># cycles and network bandwidth!</span>
</span></span><span class="line"><span class="cl">	<span class="n">logger</span><span class="o">.</span><span class="n">handle</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">LogRecordSocketReceiver</span><span class="p">(</span><span class="n">socketserver</span><span class="o">.</span><span class="n">ThreadingTCPServer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Simple TCP socket-based logging receiver suitable for testing.
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">allow_reuse_address</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		 <span class="n">port</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">DEFAULT_TCP_LOGGING_PORT</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		 <span class="n">handler</span><span class="o">=</span><span class="n">LogRecordStreamHandler</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">	<span class="n">socketserver</span><span class="o">.</span><span class="n">ThreadingTCPServer</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">),</span> <span class="n">handler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="bp">self</span><span class="o">.</span><span class="n">abort</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">	<span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">	<span class="bp">self</span><span class="o">.</span><span class="n">logname</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">serve_until_stopped</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">	<span class="kn">import</span> <span class="nn">select</span>
</span></span><span class="line"><span class="cl">	<span class="n">abort</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">	<span class="k">while</span> <span class="ow">not</span> <span class="n">abort</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	    <span class="n">rd</span><span class="p">,</span> <span class="n">wr</span><span class="p">,</span> <span class="n">ex</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">fileno</span><span class="p">()],</span>
</span></span><span class="line"><span class="cl">					    <span class="p">[],</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">					    <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	    <span class="k">if</span> <span class="n">rd</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="bp">self</span><span class="o">.</span><span class="n">handle_request</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="n">abort</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abort</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(relativeCreated)5d</span><span class="s1"> </span><span class="si">%(name)-15s</span><span class="s1"> </span><span class="si">%(levelname)-8s</span><span class="s1"> </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">tcpserver</span> <span class="o">=</span> <span class="n">LogRecordSocketReceiver</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;About to start TCP server...&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">tcpserver</span><span class="o">.</span><span class="n">serve_until_stopped</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">main</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>é€šè¿‡ç»™ logger æ·»åŠ ä¸€ä¸ªSocketHandler å°±å¯ä»¥æŠŠæ—¥å¿—äº‹ä»¶å‘é€åˆ°æœåŠ¡å™¨ç«¯</p>
<h3 id="ä½¿ç”¨é…ç½®æ–‡ä»¶"><span class="section-num">3.5</span> ä½¿ç”¨é…ç½®æ–‡ä»¶</h3>
<p>è™½ç„¶å¼€å‘è€…å¯ä»¥ä½¿ç”¨ Python ä»£ç æ¥é…ç½®æ—¥å¿—ç³»ç»Ÿï¼Œä½†æ˜¯è¿™æ ·æ˜¯å¾ˆä¸çµæ´»çš„ï¼Œæ¯æ¬¡ä¿®æ”¹æ—¥å¿—ç­‰çº§è¿˜éœ€è¦å»æ”¹åŠ¨ä»£ç ã€‚</p>
<p>è€Œä½¿ç”¨é…ç½®æ–‡ä»¶æ— ç–‘æ˜¯ä¸€ä¸ªæ›´å¥½çš„é€‰æ‹©ï¼Œä¾‹å¦‚ json æˆ–è€…æ˜¯ yaml æ–‡ä»¶ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨ json/yaml æ–‡ä»¶ä¸­åŠ è½½æ—¥å¿—é…ç½®äº†ã€‚ä»¥ <a href="https://docs.djangoproject.com/en/1.9/topics/logging/#configuring-logging">Django</a> é¡¹ç›®çš„é…ç½®æ–‡ä»¶ä¸ºä¾‹ï¼Œæˆ‘æ”¹æˆäº† json æ ¼å¼ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;version&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;disable_existing_loggers&#34;</span><span class="p">:</span> <span class="err">True</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;formatters&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&#34;verbose&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	    <span class="nt">&#34;format&#34;</span><span class="p">:</span> <span class="s2">&#34;%(levelname)s %(asctime)s %(module)s %(process)d %(thread)d %(message)s&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="p">},</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&#34;simple&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	    <span class="nt">&#34;format&#34;</span><span class="p">:</span> <span class="s2">&#34;%(levelname)s %(message)s&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;filters&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&#34;special&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	    <span class="nt">&#34;()&#34;</span><span class="p">:</span> <span class="s2">&#34;project.logging.SpecialFilter&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	    <span class="nt">&#34;foo&#34;</span><span class="p">:</span> <span class="s2">&#34;bar&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;handlers&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&#34;null&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	    <span class="nt">&#34;level&#34;</span><span class="p">:</span> <span class="s2">&#34;DEBUG&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	    <span class="nt">&#34;class&#34;</span><span class="p">:</span> <span class="s2">&#34;django.utils.log.NullHandler&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">},</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&#34;console&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	    <span class="nt">&#34;level&#34;</span><span class="p">:</span> <span class="s2">&#34;DEBUG&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	    <span class="nt">&#34;class&#34;</span><span class="p">:</span> <span class="s2">&#34;logging.StreamHandler&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	    <span class="nt">&#34;formatter&#34;</span><span class="p">:</span> <span class="s2">&#34;simple&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="p">},</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&#34;mail_admins&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	    <span class="nt">&#34;level&#34;</span><span class="p">:</span> <span class="s2">&#34;ERROR&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	    <span class="nt">&#34;class&#34;</span><span class="p">:</span> <span class="s2">&#34;django.utils.log.AdminEmailHandler&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	    <span class="nt">&#34;filters&#34;</span><span class="p">:</span> <span class="s2">&#34;special&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;loggers&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&#34;django&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	    <span class="nt">&#34;handlers&#34;</span><span class="p">:</span> <span class="s2">&#34;null&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	    <span class="nt">&#34;propagate&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	    <span class="nt">&#34;level&#34;</span><span class="p">:</span> <span class="s2">&#34;INFO&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">},</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&#34;django.request&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	    <span class="nt">&#34;handlers&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;mail_admins&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">	    <span class="nt">&#34;level&#34;</span><span class="p">:</span> <span class="s2">&#34;ERROR&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	    <span class="nt">&#34;propagate&#34;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">},</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&#34;myproject.custom&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	    <span class="nt">&#34;handlers&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;console&#34;</span><span class="p">,</span> <span class="s2">&#34;mail_admins&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">	    <span class="nt">&#34;level&#34;</span><span class="p">:</span> <span class="s2">&#34;INFO&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	    <span class="nt">&#34;filters&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;special&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä»¥åŠåŠ è½½ json æ–‡ä»¶åˆ°æ—¥å¿—é…ç½®ä¸­ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">json</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">logging.config</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">setup_logging</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Setup logging configuration
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;logging_configuration.json&#39;</span><span class="p">,</span> <span class="s1">&#39;rt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="n">config</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">logging</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">dictConfig</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä½¿ç”¨ json è¿˜æœ‰ä¸€ä¸ªå¥½å¤„æ˜¯æ ‡å‡†åº“å·²ç»å†…ç½®äº† json æ¨¡å—ï¼Œæ— éœ€åƒ yaml é‚£æ ·éœ€è¦å®‰è£…é¢å¤–çš„æ¨¡å—ï¼Œä¸è¿‡æˆ‘æ›´æ¨å´‡ yaml, å› ä¸ºæ¸…æ™°ä¹‹ä½™ï¼Œè¿˜å¯ä»¥å°‘æ‰“å¾ˆå¤šå­— :)</p>
<h3 id="å¯¹äºä¸åŒçš„ä»£ç -ä½¿ç”¨ä¸åŒçš„æ—¥å¿—ç­‰çº§"><span class="section-num">3.6</span> å¯¹äºä¸åŒçš„ä»£ç ï¼Œä½¿ç”¨ä¸åŒçš„æ—¥å¿—ç­‰çº§</h3>
<p>å› ä¸ºä¸€ä¸ªé¡¹ç›®ä¸åŒä»£ç è¦æ±‚ä¸ä¸€æ ·ï¼Œä¹Ÿæ— éœ€æŠŠæ¯ä¸€ä¸ªå®ç°ç»†èŠ‚éƒ½è®°å½•åœ¨æ—¥å¿—ï¼Œåªéœ€è¦æ ¹ æ®ä¸åŒçš„å®ç°ï¼Œä½¿ç”¨ä¸åŒçš„æ—¥å¿—ç­‰çº§ï¼Œä¾‹å¦‚ä½¿ç”¨ <code>Debug</code> è®°å½•ç³»ç»Ÿå¯åŠ¨ï¼Œå¤„ç†ä¸šåŠ¡é€»è¾‘ è¯·æ±‚çš„ä¿¡æ¯ï¼Œä½¿ç”¨ <code>Error</code>, è®°å½•ç³»ç»Ÿçš„å‡ºé”™ä¿¡æ¯ï¼Œå¯ä»¥ç»“åˆå †æ ˆåˆ†æåŸå› ï¼Œç­‰ç­‰ã€‚</p>
<p>æ­¤å¤–ï¼ŒLogger å®ä¾‹å¯ä»¥è¢«é…ç½®æˆåŸºäºåå­—çš„æ ‘çŠ¶ç»“æ„ã€‚ æ¯ä¸€ä¸ªéƒ¨ä»¶éƒ½å®šä¹‰äº†ä¸€ä¸ªåŸºç¡€çš„åå­—ï¼Œå¯¹åº”çš„æ¨¡å—è¢«è®¾ç½®æˆå­èŠ‚ç‚¹ã€‚è€Œ root logger æ²¡æœ‰åå­—ã€‚å¦‚å›¾ï¼š</p>

<figure><a href="/ox-hugo/example_logger_tree.png">
    
    
    <input type="checkbox" id="zoomCheck-2c8af" hidden>
    <label for="zoomCheck-2c8af">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/example_logger_tree.png"/> 
    
    
    </label></a>
</figure>

<p>å°±é…ç½® <code>logging</code> è€Œè¨€ï¼Œæˆ‘è®¤ä¸ºæ ‘çŠ¶ç»“æ„æ˜¯éå¸¸æœ‰ç”¨çš„ï¼Œå› ä¸ºæ— éœ€ä¸ºæ¯ä¸€ä¸ª logger éƒ½è®¾ç½®handler. å¦‚æœä¸€ä¸ª logger æ²¡æœ‰ handler çš„è¯ï¼Œå®ƒå°±ä¼šè®©çˆ¶èŠ‚ç‚¹æ¥å¤„ç†ã€‚æ‰€ä»¥ å¯¹äºå¯¹äºå¤§éƒ¨ä»½çš„åº”ç”¨è€Œè¨€ï¼Œåªéœ€é…ç½® root logger, è€Œæ‰€æœ‰çš„ä¿¡æ¯éƒ½ä¼šå‘é€åˆ°åŒä¸€ä¸ª åœ°æ–¹</p>

<figure><a href="/ox-hugo/one_logger_handler.png">
    
    
    <input type="checkbox" id="zoomCheck-e436a" hidden>
    <label for="zoomCheck-e436a">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/one_logger_handler.png"/> 
    
    
    </label></a>
</figure>

<p>è€Œæ ‘çŠ¶ç»“æ„å¯ä»¥å¯¹åº”ç”¨çš„ä¸åŒéƒ¨åˆ†ä½¿ç”¨ä¸åŒçš„æ—¥å¿—ç­‰çº§ï¼Œä¸åŒçš„ handler, ä¸åŒçš„formatter, ä»¥æ›´å¥½åœ°æ§åˆ¶æ—¥å¿—ä¿¡æ¯</p>
<h3 id="ä½¿ç”¨ç»“æ„åŒ–æ—¥å¿—"><span class="section-num">3.7</span> ä½¿ç”¨ç»“æ„åŒ–æ—¥å¿—</h3>
<p>è™½ç„¶å¤§éƒ¨ä»½çš„æ—¥å¿—ä¿¡æ¯å¯¹äºäººç±»éƒ½æ˜¯å¯è¯»çš„ï¼Œä½†æ˜¯å¯¹äºç¨‹åºè€Œè¨€ï¼Œå°±å¾ˆéš¾è¿›è¡Œè§£æäº†ã€‚</p>
<p>è¿™ä¸ªæ—¶å€™ï¼Œä¸ºäº†æ–¹ä¾¿ç¨‹åºè¿›è¡Œè§£æï¼Œæˆ‘å»ºè®®ä½¿ç”¨ç»“æ„åŒ–æ ¼å¼çš„æ—¥å¿—ï¼Œè¿™æ ·å°±ä¸å†éœ€è¦å„ç§å¤æ‚çš„æ­£åˆ™è¡¨è¾¾å¼æ¥è§£ææ—¥å¿—äº†ã€‚å¾—ç›Šäºå†…ç½®çš„ json æ¨¡å—ï¼Œä½¿ç”¨ json å°±å¯ä»¥å¾ˆç®€å•åœ°ç”Ÿæˆçš„åˆ©äºç¨‹åºè§£æç»“æ„åŒ–æ—¥å¿—ï¼Œä»¥ <a href="https://docs.python.org/3/howto/logging-cookbook.html">logging cookbook</a> ä¸­çš„ä¾‹å­è¯´æ˜ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">json</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">logging</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">StructuredMessage</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">	<span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">message</span>
</span></span><span class="line"><span class="cl">	<span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> &gt;&gt;&gt; </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">_</span> <span class="o">=</span> <span class="n">StructuredMessage</span>   <span class="c1"># optional, to improve readability</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;message 1&#39;</span><span class="p">,</span> <span class="n">foo</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">bar</span><span class="o">=</span><span class="s1">&#39;baz&#39;</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">123</span><span class="p">,</span> <span class="n">fnum</span><span class="o">=</span><span class="mf">123.456</span><span class="p">))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ—¥å¿—è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="err">message</span> <span class="mi">1</span> <span class="err">&gt;&gt;&gt;</span> <span class="p">{</span><span class="nt">&#34;fnum&#34;</span><span class="p">:</span> <span class="mf">123.456</span><span class="p">,</span> <span class="nt">&#34;num&#34;</span><span class="p">:</span> <span class="mi">123</span><span class="p">,</span> <span class="nt">&#34;bar&#34;</span><span class="p">:</span> <span class="s2">&#34;baz&#34;</span><span class="p">,</span> <span class="nt">&#34;foo&#34;</span><span class="p">:</span> <span class="s2">&#34;bar&#34;</span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="å‚è€ƒ"><span class="section-num">3.8</span> å‚è€ƒ</h3>
<ul>
<li><a href="https://logmatic.io/blog/python-logging-with-json-steroids/">https://logmatic.io/blog/python-logging-with-json-steroids/</a></li>
<li><a href="https://fangpenlin.com/posts/2012/08/26/good-logging-practice-in-python/">https://fangpenlin.com/posts/2012/08/26/good-logging-practice-in-python/</a></li>
<li><a href="https://docs.python.org/3/howto/logging-cookbook.html">https://docs.python.org/3/howto/logging-cookbook.html</a></li>
<li><a href="https://pymotw.com/3/logging/index.html">https://pymotw.com/3/logging/index.html</a></li>
</ul>
<h3 id="å°ç»“"><span class="section-num">3.9</span> å°ç»“</h3>
<p>è™½ç„¶è¿™æ¬¡çš„æ—¥å¿—é˜è¿°æ˜¯ä»¥ Python çš„æ—¥å¿—æ¨¡å—ä¸¾ä¾‹ï¼Œä½†æ˜¯ç»å¤§éƒ¨åˆ†çš„è¯­è¨€éƒ½å†…ç½®æˆ–è€…æ˜¯æœ‰ç¬¬ä¸‰æ–¹çš„æ—¥å¿—æ”¯æŒï¼Œæ‰€ä»¥æˆ‘åˆ†äº«çš„æŠ€å·§è¿˜æ˜¯å¯ä»¥åº”ç”¨åˆ°å…¶ä»–çš„è¯­è¨€çš„ã€‚</p>
<p>è¿™äº›éƒ½æ˜¯æˆ‘åœ¨æ—¥å¸¸é¡¹ç›®ä¸­çš„ä¸€ç‚¹ä½“ä¼šï¼Œä¸è¯¸å›å…±èµç½¢ã€‚Enjoy :)</p>
<div center class="qr-container">
<img src="/ox-hugo/qrcode_gh_e06d750e626f_1.jpg" alt="qrcode_gh_e06d750e626f_1.jpg" width="160px" height="160px" center="t" class="qr-container" />
å…¬å·åŒæ­¥æ›´æ–°ï¼Œæ¬¢è¿å…³æ³¨ğŸ‘»
</div>
]]></content:encoded>
    </item>
    <item>
      <title>çˆ¬è™«é«˜æ•ˆå»é‡ä¹‹å¸ƒéš†è¿‡æ»¤å™¨</title>
      <link>https://ramsayleung.github.io/zh/post/2017/bloom_filter/</link>
      <pubDate>Sun, 09 Apr 2017 00:00:00 +0800</pubDate>
      <guid>https://ramsayleung.github.io/zh/post/2017/bloom_filter/</guid>
      <description>an dscription about bloom filter</description>
      <content:encoded><![CDATA[<p>ç¬”è€…æœ€è¿‘æ€è€ƒå¦‚ä½•ç¼–å†™é«˜æ•ˆçš„çˆ¬è™«; è€Œåœ¨ç¼–å†™é«˜æ•ˆçˆ¬è™«çš„æ—¶å€™ï¼Œæœ‰ä¸€ä¸ªå¿…éœ€è§£å†³çš„é—®é¢˜å°±æ˜¯ï¼š
url çš„å»é‡ï¼Œå³å¦‚ä½•åˆ¤åˆ« url æ˜¯å¦å·²ç»è¢«çˆ¬å–ï¼Œå¦‚æœè¢«çˆ¬å–ï¼Œé‚£å°±ä¸è¦é‡å¤çˆ¬å–ã€‚</p>
<p>ä¸€èˆ¬å¦‚æœéœ€è¦çˆ¬å–çš„ç½‘ç«™ä¸æ˜¯éå¸¸åºå¤§çš„è¯ï¼Œä½¿ç”¨Python å†…ç½®çš„ set å°±å¯ä»¥å®ç°å»é‡äº†ï¼Œä½†æ˜¯ä½¿ç”¨ set å†…å­˜åˆ©ç”¨ç‡ä¸é«˜ï¼Œæ­¤å¤–å¯¹äºé‚£äº›ä¸åƒPython é‚£æ ·ç”¨ hash å®ç°çš„ set è€Œè¨€ï¼Œæ—¶é—´å¤æ‚åº¦æ˜¯ log(N),å®åœ¨éš¾è¯´é«˜æ•ˆã€‚</p>
<h2 id="bloom-filter"><span class="section-num">1</span> Bloom Filter</h2>
<p>é‚£ä¹ˆå¦‚ä½•å®ç°é«˜æ•ˆçš„å»é‡å‘¢ï¼Ÿ ç¬”è€…æŸ¥é˜…èµ„æ–™ä¹‹åå¾—çŸ¥ï¼šä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨ (Bloom Filter).</p>
<p>å¸ƒéš†è¿‡æ»¤å™¨å¯ä»¥ç”¨äºå¿«é€Ÿæ£€ç´¢ä¸€ä¸ªå…ƒç´ æ˜¯å¦åœ¨ä¸€ä¸ªé›†åˆä¸­ã€‚å¸ƒéš†è¿‡æ»¤å™¨å®é™…ä¸Šæ˜¯ä¸€ä¸ªå¾ˆé•¿çš„äºŒè¿›åˆ¶å‘é‡å’Œä¸€ç³»åˆ—éšæœºæ˜ å°„å‡½æ•°ï¼ˆHashå‡½æ•°ï¼‰ã€‚</p>
<p>è€Œä¸€èˆ¬çš„åˆ¤æ–­ä¸€ä¸ªå…ƒç´ æ˜¯å¦åœ¨ä¸€ä¸ªé›†åˆé‡Œé¢çš„åšæ³•æ˜¯ï¼šç”¨éœ€è¦åˆ¤æ–­çš„å…ƒç´ å’Œé›†åˆä¸­çš„å…ƒç´ è¿›è¡Œæ¯”è¾ƒï¼Œä¸€èˆ¬çš„æ•°æ®ç»“æ„ï¼Œä¾‹å¦‚é“¾è¡¨ï¼Œæ ‘ï¼Œéƒ½æ˜¯è¿™ä¹ˆå®ç°çš„ã€‚</p>
<p>ç¼ºç‚¹æ˜¯ï¼šéšç€é›†åˆå…ƒç´ çš„å¢å¤šï¼Œéœ€è¦æ¯”è¾ƒçš„å…ƒç´ ä¹Ÿå¢å¤šï¼Œæ£€ç´¢é€Ÿåº¦å°±è¶Šæ¥è¶Šæ…¢ã€‚</p>
<p>è€Œä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨åˆ¤é‡å¯ä»¥å®ç°å¸¸æ•°çº§çš„æ—¶é—´å¤æ‚åº¦(æ£€ç´¢æ—¶é—´ä¸éšå…ƒç´ å¢é•¿è€Œå¢åŠ ).é‚£ä¹ˆå¸ƒéš†è¿‡æ»¤å™¨åˆæ˜¯æ€æ ·å®ç°çš„å‘¢</p>
<h3 id="å¸ƒéš†è¿‡æ»¤å™¨å®ç°åŸç†"><span class="section-num">1.1</span> å¸ƒéš†è¿‡æ»¤å™¨å®ç°åŸç†</h3>
<p>ä¸€ä¸ªBloom Filteræ˜¯åŸºäºä¸€ä¸ªmä½çš„ä½å‘é‡ï¼ˆBit Vectorï¼‰ï¼Œè¿™äº›ä½å‘é‡çš„åˆå§‹å€¼ä¸º0, å¹¶ä¸”æœ‰ä¸€ç³»åˆ—çš„ hash å‡½æ•°ï¼Œhash å‡½æ•°å€¼åŸŸä¸º1-m.åœ¨ä¸‹é¢ä¾‹å­ä¸­ï¼Œæ˜¯15ä½çš„ä½å‘é‡ï¼Œåˆå§‹å€¼ä¸º0ä»¥ç©ºç™½è¡¨ç¤ºï¼Œä¸º1ä»¥é¢œè‰²å¡«å……</p>

<figure><a href="/ox-hugo/bit_vector.png">
    
    
    <input type="checkbox" id="zoomCheck-a88b8" hidden>
    <label for="zoomCheck-a88b8">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/bit_vector.png"/> 
    
    
    </label></a>
</figure>

<p>ç°åœ¨æœ‰ä¸¤ä¸ªç®€å•çš„ hash å‡½æ•°ï¼šfnv,murmur.ç°åœ¨æˆ‘è¾“å…¥ä¸€ä¸ªå­—ç¬¦ä¸² &ldquo;whatever&rdquo; ,ç„¶ååˆ†åˆ«ä½¿ç”¨ä¸¤ä¸ª hash å‡½æ•°å¯¹ &ldquo;whatever&rdquo; è¿›è¡Œæ•£åˆ—è®¡ç®—å¹¶ä¸”æ˜ å°„åˆ°ä¸Šé¢çš„ä½å‘é‡ã€‚</p>

<figure><a href="/ox-hugo/whatever.png">
    
    
    <input type="checkbox" id="zoomCheck-395b7" hidden>
    <label for="zoomCheck-395b7">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/whatever.png"/> 
    
    
    </label></a>
</figure>

<p>å¯çŸ¥ï¼Œä½¿ç”¨ fnv å‡½æ•°è®¡ç®—å‡ºçš„ hash å€¼æ˜¯11,ä½¿ç”¨ murmur å‡½æ•°è®¡ç®—å‡ºçš„ hash å€¼æ˜¯4. ç„¶åæ˜ å°„åˆ°ä½å‘é‡ä¸Šï¼š</p>

<figure><a href="/ox-hugo/bit_vector1.png">
    
    
    <input type="checkbox" id="zoomCheck-05bbd" hidden>
    <label for="zoomCheck-05bbd">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/bit_vector1.png"/> 
    
    
    </label></a>
</figure>

<p>å¦‚æœä¸‹ä¸€æ¬¡ï¼Œç¬”è€…è¦åˆ¤æ–­ <strong>whatever</strong> æ˜¯å¦åœ¨å­—ç¬¦ä¸²ä¸­ï¼Œåªéœ€ä½¿ç”¨ fnv å’Œ murmur ä¸¤ä¸ª hash å‡½æ•°å¯¹ <strong>whatever</strong> è¿›è¡Œæ•£åˆ—å€¼è®¡ç®—ï¼Œç„¶åä¸ä½å‘é‡åš &ldquo;ä¸è¿ç®—&rdquo;ï¼Œå¦‚æœç»“æœä¸º0, é‚£ä¹ˆè¯´æ˜ <strong>whatever</strong> æ˜¯ä¸åœ¨é›†åˆä¸­çš„ï¼Œå› ä¸ºåŒæ ·çš„å…ƒç´ ä½¿ç”¨åŒä¸€ä¸ª hash å‡½æ•°äº§ç”Ÿçš„å€¼æ¯æ¬¡éƒ½æ˜¯ç›¸åŒçš„ï¼Œä¸ç›¸åŒå°±è¯´æ˜ä¸æ˜¯åŒä¸€ä¸ªå…ƒç´ ã€‚</p>
<p>ä½†æ˜¯å¦‚æœ &ldquo;ä¸è¿ç®—&rdquo; çš„ç»“æœä¸º1,æ˜¯å¦å¯ä»¥è¯´æ˜ <strong>whatever</strong> å°±åœ¨é›†åˆä¸­å‘¢ï¼Ÿå…¶å®ä¸Šæ˜¯ä¸èƒ½100% ç¡®å®šçš„ï¼Œå› ä¸º hash å‡½æ•°å­˜åœ¨æ•£åˆ—å†²çªç°è±¡ (å³ä¸¤ä¸ªæ•£åˆ—å€¼ç›¸åŒï¼Œä½†ä¸¤ä¸ªè¾“å…¥å€¼æ˜¯ä¸åŒçš„), æ‰€ä»¥å¸ƒéš†è¿‡æ»¤å™¨åªèƒ½è¯´&quot;æˆ‘å¯ä»¥è¯´è¿™ä¸ªå…ƒç´ æˆ‘åœ¨é›†åˆä¸­æ˜¯çœ‹è§è¿‡æ»´ï¼Œåªæ˜¯æˆ‘æœ‰ä¸€å®šçš„ä¸ç¡®å®šæ€§&quot;.</p>
<p>å½“ä½ åœ¨åˆ†é…çš„å†…å­˜è¶³å¤Ÿå¤§ä¹‹åï¼Œä¸ç¡®å®šæ€§ä¼šå˜å¾—å¾ˆå°å¾ˆå°ã€‚</p>
<p>ä½ å¯ä»¥çœ‹åˆ°å¸ƒéš†è¿‡æ»¤å™¨å¯ä»¥æœ‰æ•ˆåˆ©ç”¨å†…å­˜å®ç°å¸¸æ•°çº§çš„åˆ¤é‡ä»»åŠ¡ï¼Œä½†æ˜¯é±¼å’Œç†ŠæŒä¸å¯å¾—å…¼ï¼Œä»˜å‡ºçš„ä»£ä»·å°±æ˜¯ä¸€å®šçš„è¯¯åˆ¤ (æœºç‡å¾ˆå°),æ‰€ä»¥æœ¬è´¨ä¸Šï¼Œå¸ƒéš†è¿‡æ»¤å™¨æ˜¯ &ldquo;æ¦‚ç‡æ•°æ®ç»“æ„ (probabilistic data structure)&rdquo;.</p>
<p>è¿™ä¸ªå°±æ˜¯å¸ƒéš†è¿‡æ»¤å™¨çš„åŸºæœ¬åŸç†ã€‚å½“ç„¶ï¼Œä½å‘é‡ä¸ä¼šåªæ˜¯15ä½ï¼Œhashå‡½æ•°ä¹Ÿä¸ä¼šä»…æ˜¯ä¸¤ä¸ªç®€å•çš„å‡½æ•°. è¿™åªæ˜¯ç®€åŒ–æèŠ‚ï¼Œä¸ºäº†æ¸…æ™°è§£è¿°åŸç†è€Œå·²ã€‚</p>
<h2 id="python-bloomfilter"><span class="section-num">2</span> Python BloomFilter</h2>
<p>ç®—æ³•éƒ½æ˜¯ä¸ºäº†å®é™…é—®é¢˜æœåŠ¡çš„ï¼Œåˆå›åˆ°çˆ¬è™«è¿™ä¸ªè¯é¢˜ä¸Šã€‚åœ¨äº†è§£å¸ƒéš†è¿‡æ»¤å™¨åŸç†ä¹‹åï¼Œå¯ä»¥å¾ˆå®¹æ˜“åœ°å®ç°è‡ªå·±çš„å¸ƒéš†è¿‡æ»¤å™¨ï¼Œä½†æ˜¯æƒ³è¦å®ç°ä¸€ä¸ªé«˜æ•ˆå¥å£®çš„å¸ƒéš†è¿‡æ»¤å™¨å°±éœ€è¦æ¯”è¾ƒå¤šçš„åŠŸå¤«äº†ï¼Œå› ä¸ºéœ€è¦è€ƒè™‘çš„é—®é¢˜ç•¥å¤šã€‚</p>
<p>å¹¸å¥½ï¼Œå¾—ç›ŠPython å¼ºå¤§çš„ç¤¾åŒºï¼Œå·²ç»æœ‰<a href="https://axiak.github.io/pybloomfiltermmap/">Python BloomFilter</a> çš„åº“ã€‚ä¸€ä¸ªæ–‡æ¡£ä¸­çš„ç®€å•ä¾‹å­ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pybloomfilter</span> <span class="kn">import</span> <span class="n">BloomFilter</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">bf</span> <span class="o">=</span> <span class="n">BloomFilter</span><span class="p">(</span><span class="mi">10000000</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="s1">&#39;filter.bloom&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&#34;/usr/share/dict/words&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="n">bf</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">word</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span> <span class="s1">&#39;apple&#39;</span> <span class="ow">in</span> <span class="n">bf</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç»“æœä¸º <strong>True</strong></p>
<h2 id="æ€»ç»“"><span class="section-num">3</span> æ€»ç»“</h2>
<p>åŸç†å°±è¯´å¾—å·®ä¸å¤šäº†ï¼Œè¦æƒ³å¯¹å¸ƒéš†è¿‡æ»¤å™¨æœ‰æ›´æ·±çš„è®¤è¯†ï¼Œè¿˜éœ€è¦æ›´å¤šçš„å®æˆ˜ã€‚å¤šå†™ï¼Œå¤šæ€è€ƒã€‚ Enjoy Python,Enjoy Crawler :)</p>
<h2 id="å‚è€ƒ"><span class="section-num">4</span> å‚è€ƒ</h2>
<ul>
<li><a href="https://llimllib.github.io/bloomfilter-tutorial/">https://llimllib.github.io/bloomfilter-tutorial/</a></li>
<li><a href="https://en.wikipedia.org/wiki/Bloom_filter">https://en.wikipedia.org/wiki/Bloom_filter</a></li>
</ul>
<div center class="qr-container">
<img src="/ox-hugo/qrcode_gh_e06d750e626f_1.jpg" alt="qrcode_gh_e06d750e626f_1.jpg" width="160px" height="160px" center="t" class="qr-container" />
å…¬å·åŒæ­¥æ›´æ–°ï¼Œæ¬¢è¿å…³æ³¨ğŸ‘»
</div>
]]></content:encoded>
    </item>
    <item>
      <title>Pythonå¤šçº¿ç¨‹ç«¯å£æ‰«æå™¨</title>
      <link>https://ramsayleung.github.io/zh/post/2017/port_scanner/</link>
      <pubDate>Sun, 19 Mar 2017 00:00:00 -0700</pubDate>
      <guid>https://ramsayleung.github.io/zh/post/2017/port_scanner/</guid>
      <description>An introduction about port scan</description>
      <content:encoded><![CDATA[<p>è¿‘ä¸¤æ—¥ï¼Œé—²æ¥æ— äº‹ï¼Œå°±å†™äº†äº›ç«¯å£æ‰«æå™¨ï¼Œé‡æ¸©TCP/IPåè®®æ ˆçš„éƒ¨åˆ†åŸç†ã€‚</p>
<h2 id="ç«¯å£æ‰«æå™¨"><span class="section-num">1</span> ç«¯å£æ‰«æå™¨</h2>
<p>æ‰€è°“çš„ç«¯å£æ‰«æå™¨ï¼Œå…¶å®æ˜¯ç”¨æ¥æ£€æµ‹ç›®æ ‡æœåŠ¡å™¨æœ‰å“ªäº›ç«¯å£å¼€æ”¾æ‰€ä½¿ç”¨çš„å·¥å…·ï¼Œä¸€èˆ¬æ˜¯ç®¡ç†å‘˜ç”¨æ¥è¿›è¡Œå®‰å…¨åŠ å›ºï¼Œæ£€æµ‹æ˜¯å¦æœ‰æ— æ„å¼€æ”¾çš„ç«¯å£ï¼›æˆ–è€…æ˜¯æ¶æ„æ”»å‡»çš„äººå‘˜åœ¨è¿›è¡Œæ”»å‡»å‰çš„å‡†å¤‡å·¥ä½œã€‚</p>
<p>æ‰€ä»¥ç»¼è¿°ä¸Šä¸‹ï¼Œç«¯å£æ‰«æå™¨æ˜¯ç”¨æ¥ç¡®å®šç›®æ ‡æœºå™¨ (æœ¬åœ°æœºå™¨æˆ–è€…è¿œç¨‹æœºå™¨)çš„ç‰¹å®šæœåŠ¡çš„å¯ç”¨æ€§</p>
<h2 id="ç«¯å£æ‰«æåŸç†"><span class="section-num">2</span> ç«¯å£æ‰«æåŸç†</h2>
<p>ä¸Šé¢æåˆ°è¿‡ï¼Œç«¯å£æ‰«æå™¨æ˜¯ç”¨æ¥ç¡®å®šç›®æ ‡æœºå™¨çš„æœåŠ¡çš„å¯ç”¨æ€§çš„ï¼›é‚£ä¹ˆå…·ä½“æ˜¯æ€ä¹ˆç¡®å®šçš„å‘¢ï¼Ÿå¦‚æœè¿˜æ²¡æœ‰ç­”æ¡ˆçš„è¯ï¼Œå¯ä»¥æ¢ä¸ªè§’åº¦æ¥æ€è€ƒè¿™ä¸ªé—®é¢˜ã€‚</p>
<p>å‡å¦‚ä½ æƒ³ç¡®å®šé‚»å±…å®¶çš„å¦¹å­æ˜¯å¦åœ¨å®¶ï¼Œä½ ä¼šæ€ä¹ˆåŠï¼Ÿè¿™ä¸ç®€å•ä¹ˆï¼Œé—®ä¸€ä¸‹ä¸å°±æ¸…æ¥šäº†ä¹ˆï¼Ÿå¯¹é˜¿ï¼Œå¯¹äºæœåŠ¡å™¨çš„ç«¯å£ä¹Ÿå¯ä»¥é€‚ç”¨è¿™æ ·çš„æ–¹æ³•å˜›ã€‚ç«¯å£æ‰«æçš„åŸç†éƒ½æ˜¯â€œé—®ä¸€ä¸‹â€ï¼Œåªæ˜¯é—®çš„æ–¹æ³•ä¸ä¸€æ ·è€Œå·²ï¼Œå°±å¥½åƒä½ æ˜¯å†³å®šç›´æ¥è¿‡å»æ•²é‚»å±…é—¨ï¼Œè¿˜æ˜¯æ‰“ç”µè¯è¿‡å»ä¸€æ ·ï¼Œæ®Šé€”åŒå½’ï¼Œæ–¹æ³•æ˜¯æ²¡æœ‰å¯¹é”™çš„ä¹‹åˆ†ï¼Œå·®å¼‚åªæ˜¯æ–¹æ³•çš„ä¼˜åŠ£ã€‚</p>
<h3 id="tcpè¿æ¥æ‰«æ"><span class="section-num">2.1</span> TCPè¿æ¥æ‰«æ</h3>
<p>è¿™æ˜¯æœ€ç®€å•çš„ä¸€ç§æ–¹æ³•ï¼Œä¸€èˆ¬è¢«ç§°ä¸ºè¿æ¥æ‰«æï¼Œå³åˆ©ç”¨ <code>socket</code> å¯¹ç›®æ ‡æœºå™¨è¿›è¡Œè¿æ¥å°è¯•ï¼Œå¦‚æœèƒ½å¤ŸæˆåŠŸå»ºç«‹ä¸‰æ¬¡æ¡æ‰‹è¿æ¥ï¼Œé‚£å°±è¯´æ˜ä½ ç”¨ <code>socket</code> è¿æ¥çš„ç«¯å£æ˜¯å¼€æ”¾çš„ï¼›ç„¶åä½ å°±å¯ä»¥æ–­å¼€è¿æ¥ï¼Œæ‰«æä¸‹ä¸€ä¸ªç›®æ ‡ç«¯å£äº† (å¦‚æœä¸æ–­å¼€è¿æ¥ï¼Œè¿™å°±æ˜¯ä¸€ç§ DDOSæ”»å‡»äº†).</p>
<p>åªä¸è¿‡TCPè¿æ¥æ‰«æä¸æ˜¯å¾ˆå¸¸ç”¨ï¼Œä¸ä»…æ˜¯å› ä¸ºå®¹æ˜“è¢«å‘ç°ï¼Œè€Œä¸”ä½ çš„IPåœ°å€ä¹Ÿå¯èƒ½ä¼šè¢«ç›®æ ‡åœ°å€è®°å½•ä¸‹æ¥çš„(å¯¹äºæ”»å‡»è€…æ¥è¯´ï¼Œéšè—èº«ä»½æ˜¯å¾ˆé‡è¦çš„)</p>
<h4 id="ä»£ç è§£æ"><span class="section-num">2.1.1</span> ä»£ç è§£æï¼š</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">scan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">host</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="n">args</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Create a TCP socket and try to connect</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># AF_INET for ipv4,AF_INET6 for ipv6</span>
</span></span><span class="line"><span class="cl">        <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">sock</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="kc">False</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å› ä¸ºåŸç†å¾ˆç®€å•ï¼Œæ‰€ä»¥æ ¸å¿ƒä»£ç ä¹Ÿæ˜¯å¾ˆç®€æ´çš„ï¼Œåªæ˜¯å»ºç«‹ <code>socket</code> ç„¶åè¿›è¡Œè¿æ¥ï¼Œå¦‚æœè¿æ¥ä¸ä¸Šï¼Œå°±å¾ˆå¤§å‡ ç‡è¯´æ˜ç«¯å£æ˜¯å…³é—­çš„ (å¹¶ä¸æ˜¯ç»å¯¹çš„ï¼Œä¾‹å¦‚socketè¶…æ—¶çš„å¼‚å¸¸å¯èƒ½å°±æ˜¯å› ä¸ºç½‘ç»œå¼‚å¸¸ï¼Œä¸ä¸€å®šæ˜¯ç›®æ ‡æœºå™¨çš„ç¼˜æ•…)</p>
<h3 id="synæ‰«æ"><span class="section-num">2.2</span> SYNæ‰«æ</h3>
<p>å†å›é¡¾ä¸€ä¸‹TCPçš„ä¸‰æ¬¡æ¡æ‰‹ï¼š</p>
<h4 id="tcpä¸‰æ¬¡æ¡æ‰‹"><span class="section-num">2.2.1</span> TCPä¸‰æ¬¡æ¡æ‰‹</h4>
<ol>
<li>TCPå»ºç«‹è¿æ¥æ—¶ï¼Œé¦–å…ˆå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å¤„äºcloseçŠ¶æ€ã€‚</li>
<li>ç„¶åå®¢æˆ·ç«¯å‘é€SYNåŒæ­¥ä½ï¼Œæ­¤æ—¶å®¢æˆ·ç«¯å¤„äºSYN-SENDçŠ¶æ€ï¼ŒæœåŠ¡å™¨å¤„äºlISTENçŠ¶æ€ï¼Œå½“æœåŠ¡å™¨æ”¶åˆ°SYNä»¥åï¼Œå‘å®¢æˆ·ç«¯å‘é€åŒæ­¥ä½SYNå’Œç¡®è®¤ç ACKï¼Œç„¶åæœåŠ¡å™¨å˜ä¸ºSYN-RCVDï¼Œå®¢æˆ·ç«¯æ”¶åˆ°æœåŠ¡å™¨å‘æ¥çš„SYNå’ŒACK åï¼Œå®¢æˆ·ç«¯çš„çŠ¶æ€å˜æˆESTABLISHED(å·²å»ºç«‹è¿æ¥)ï¼Œ</li>
<li>å®¢æˆ·ç«¯å†å‘æœåŠ¡å™¨å‘é€ACKç¡®è®¤ç ï¼ŒæœåŠ¡å™¨æ¥æ”¶åˆ°ä»¥åä¹Ÿå˜æˆESTABLISHEDã€‚ç„¶åæœåŠ¡å™¨å®¢æˆ·ç«¯å¼€å§‹æ•°æ®ä¼ è¾“</li>
</ol>
<p>å¦‚å›¾ï¼š</p>

<figure>
    
    
    <input type="checkbox" id="zoomCheck-61b3c" hidden>
    <label for="zoomCheck-61b3c">
    
    
    <img class="zoomCheck" loading="lazy" src="https://sites.google.com/a/javainterview.net/question/_/rsrc/1425457816649/misc/tcp-ip/3-way-handshake-Intro-to-transport-layer-The-internetworking-Part2.gif"
         alt="Figure 1: å›¾æ¥æºäºGoogle"/> 
    
    
    </label><figcaption>
            <p><span class="figure-number">Figure 1: </span>å›¾æ¥æºäºGoogle</p>
        </figcaption>
</figure>

<h4 id="synæ‰«æåŸç†"><span class="section-num">2.2.2</span> SYNæ‰«æåŸç†</h4>
<!--list-separator-->
<ol>
<li>
<p>SYN+ACK</p>
<p>é‚£ä¹ˆç°åœ¨å†å›åˆ°SYNæ‰«æä¸Šæ¥.å¦‚æœåœ¨å‘é€ç¬¬ä¸€æ¬¡æ¡æ‰‹çš„ <code>SYN</code> flag æ—¶ï¼Œç›®æ ‡æœºå™¨å›å¤äº†=SYN+ACK=,è¿™ä¸å°±è¯´æ˜ç¬”è€…å‘é€çš„TCPåŒ…ä¸­çš„ç›®æ ‡ç«¯å£æ˜¯å¼€æ”¾çš„ä¹ˆï¼å¦‚æœä¸å¼€æ”¾ï¼ŒæœåŠ¡å™¨å°±ä¸ä¼šæœŸå¾…ç¬¬ä¸‰æ¬¡æ¡æ‰‹äº†ï¼Œä¹Ÿä¸ä¼šç»™ç¬”è€…å‘é€ <code>SYN+ACK</code> äº†ï¼›å¦‚å›¾ï¼š</p>

    <figure>
        
        
        <input type="checkbox" id="zoomCheck-69283" hidden>
        <label for="zoomCheck-69283">
        
        
        <img class="zoomCheck" loading="lazy" src="http://2we26u4fam7n16rz3a44uhbe1bq2.wpengine.netdna-cdn.com/wp-content/uploads/101613_1123_PortScannin3.jpg"/> 
        
        
        </label>
    </figure>

<p>å›¾æ¥è‡ª <a href="http://resources.infosecinstitute.com/port-scanning-using-scapy/">http://resources.infosecinstitute.com/port-scanning-using-scapy/</a></p>
</li>
</ol>
<!--list-separator-->
<ol start="2">
<li>
<p>RST</p>
<p>å¦‚æœç¬¬äºŒæ¬¡æ¡æ‰‹çš„æ—¶å€™ï¼Œç›®æ ‡æœºå™¨å›å¤çš„ä¸æ˜¯ <code>SYN+ACK</code>, è€Œæ˜¯ <code>RST</code>, å°±è¯´æ˜TCPåŒ…ä¸­çš„ç›®æ ‡ç«¯å£åœ¨ç›®æ ‡æœºå™¨ä¸Šæ˜¯å…³é—­çš„ï¼›å¦‚å›¾</p>

    <figure>
        
        
        <input type="checkbox" id="zoomCheck-6b7be" hidden>
        <label for="zoomCheck-6b7be">
        
        
        <img class="zoomCheck" loading="lazy" src="http://2we26u4fam7n16rz3a44uhbe1bq2.wpengine.netdna-cdn.com/wp-content/uploads/101613_1123_PortScannin4.jpg"/> 
        
        
        </label>
    </figure>

<p>å›¾æ¥è‡ª <a href="http://resources.infosecinstitute.com/port-scanning-using-scapy/">http://resources.infosecinstitute.com/port-scanning-using-scapy/</a></p>
</li>
</ol>
<!--list-separator-->
<ol start="3">
<li>
<p>Filtered</p>
<p>ä¸Šé¢æåŠäº†ç›®æ ‡ç«¯å£çš„å¼€æ”¾å’Œå…³é—­ä¸¤ç§çŠ¶æ€ï¼Œé‚£ä¹ˆï¼Œè¿˜æœ‰æ²¡æœ‰å…¶ä»–çŠ¶æ€å‘¢ï¼Ÿä»€ä¹ˆï¼Œè¿˜æœ‰å…¶ä»–çŠ¶æ€ï¼Ÿ</p>
<p>å¦‚æœå°±SYNæ‰«æè€Œè¨€ï¼Œå°±è¿˜æœ‰ filteredè¢«è¿‡æ»¤ä¹‹ä¸€è¯´ï¼Œå¦‚æœè¿˜æœ‰åŠ ä¸Šå…¶ä»–æ‰«ææŠ€æœ¯ï¼Œ å°±è¿˜æœ‰å…¶ä»–çŠ¶æ€äº†ã€‚</p>
<p>å›åˆ°SYNæ‰«æï¼Œå½“è¿”å›çš„ä¸æ˜¯æœåŠ¡å™¨æƒ³å»ºç«‹ç¬¬äºŒæ¬¡æ¡æ‰‹çš„åŒ…ï¼Œè€Œæ˜¯ICMPçš„åŒ…å°±æœ‰å¯èƒ½è¢«è¿‡æ»¤ï¼Œä¾‹å¦‚å“åº”ä¿¡æ¯æ˜¯ICMPé”™è¯¯ä¿¡æ¯ç±»å‹3ä»£ç 3(æ— æ³•åˆ°è¾¾ç›®æ ‡ï¼šç«¯å£ä¸å¯è¾¾)è¿™é‡Œå‡ºç°çš„ç«¯å£ä¸å¯è¾¾ï¼Œå¯èƒ½å°±æ˜¯è¢«é˜²ç«å¢™è¿‡æ»¤äº†ï¼Œå¦‚æœæ˜¯ç±»å‹3ä»£ç 13(æ— æ³•åˆ°è¾¾ç›®æ ‡ï¼šé€šä¿¡è¢«ç®¡ç†å‘˜ç¦æ­¢),é‚£ä¹Ÿæ˜¯è¢«è¿‡æ»¤äº†ã€‚</p>
<p>æ›´å¤šä¿¡æ¯å°±è¦æŸ¥è¯¢<a href="https://www.iana.org/assignments/icmp-parameters/icmp-parameters.xhtml">ICMPçš„å®˜æ–¹æ–‡æ¡£</a> äº†</p>
</li>
</ol>
<h4 id="ä»£ç è§£é‡Š"><span class="section-num">2.2.3</span> ä»£ç è§£é‡Š</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">scan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">dst_ip</span><span class="p">,</span> <span class="n">dst_port</span> <span class="o">=</span> <span class="n">args</span>
</span></span><span class="line"><span class="cl">    <span class="n">src_port</span> <span class="o">=</span> <span class="n">RandShort</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">answered</span><span class="p">,</span> <span class="n">unanswered</span> <span class="o">=</span> <span class="n">sr</span><span class="p">(</span><span class="n">IP</span><span class="p">(</span><span class="n">dst</span><span class="o">=</span><span class="n">dst_ip</span><span class="p">)</span> <span class="o">/</span> <span class="n">TCP</span><span class="p">(</span><span class="n">sport</span><span class="o">=</span><span class="n">src_port</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                   <span class="n">dport</span><span class="o">=</span><span class="n">dst_port</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="s2">&#34;S&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                          <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">packet</span> <span class="ow">in</span> <span class="n">unanswered</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">packet</span><span class="o">.</span><span class="n">dst</span><span class="p">,</span> <span class="n">packet</span><span class="o">.</span><span class="n">dport</span><span class="p">,</span> <span class="s2">&#34;Filtered&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">send</span><span class="p">,</span> <span class="n">recv</span><span class="p">)</span> <span class="ow">in</span> <span class="n">answered</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">recv</span><span class="o">.</span><span class="n">haslayer</span><span class="p">(</span><span class="n">TCP</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">            <span class="n">flags</span> <span class="o">=</span> <span class="n">recv</span><span class="o">.</span><span class="n">getlayer</span><span class="p">(</span><span class="n">TCP</span><span class="p">)</span><span class="o">.</span><span class="n">sprintf</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%f</span><span class="s2">lags%&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="p">(</span><span class="n">flags</span> <span class="o">==</span> <span class="s2">&#34;SA&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># set RST to server in case of ddos attack</span>
</span></span><span class="line"><span class="cl">                <span class="n">send_rst</span> <span class="o">=</span> <span class="n">sr</span><span class="p">(</span><span class="n">IP</span><span class="p">(</span><span class="n">dst</span><span class="o">=</span><span class="n">dst_ip</span><span class="p">)</span> <span class="o">/</span> <span class="n">TCP</span><span class="p">(</span><span class="n">sport</span><span class="o">=</span><span class="n">src_port</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                   <span class="n">dport</span><span class="o">=</span><span class="n">dst_port</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="s2">&#34;R&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                          <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">dst_ip</span><span class="p">,</span> <span class="n">dst_port</span><span class="p">,</span> <span class="s2">&#34;Open&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="k">elif</span> <span class="p">(</span><span class="n">flags</span> <span class="o">==</span> <span class="s2">&#34;RA&#34;</span> <span class="ow">or</span> <span class="n">flags</span> <span class="o">==</span> <span class="s2">&#34;R&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">dst_ip</span><span class="p">,</span> <span class="n">dst_port</span><span class="p">,</span> <span class="s2">&#34;Closed&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span><span class="p">(</span><span class="n">recv</span><span class="o">.</span><span class="n">haslayer</span><span class="p">(</span><span class="n">ICMP</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">            <span class="n">icmp_type</span> <span class="o">=</span> <span class="n">recv</span><span class="o">.</span><span class="n">getlayer</span><span class="p">(</span><span class="n">ICMP</span><span class="p">)</span><span class="o">.</span><span class="n">type</span>
</span></span><span class="line"><span class="cl">            <span class="n">icmp_code</span> <span class="o">=</span> <span class="n">recv</span><span class="o">.</span><span class="n">getlayer</span><span class="p">(</span><span class="n">ICMP</span><span class="p">)</span><span class="o">.</span><span class="n">code</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="p">(</span><span class="n">icmp_type</span> <span class="o">==</span> <span class="n">ICMP_TYPE_DESTINATION_UNREACHABLE</span> <span class="ow">and</span> <span class="n">icmp_code</span> <span class="ow">in</span> <span class="n">ICMP_CODE</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">dst_ip</span><span class="p">,</span> <span class="n">dst_port</span><span class="p">,</span> <span class="s2">&#34;Filtered&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">dst_ip</span><span class="p">,</span> <span class="n">dst_port</span><span class="p">,</span> <span class="s2">&#34;CHECK&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ ¸å¿ƒä»£ç å¾ˆç®€å•ï¼Œå°±æ˜¯å‘é€å»ºç«‹è¿æ¥çš„æ¡æ‰‹è¯·æ±‚ï¼Œç„¶åæ ¹æ®ä¸åŒçš„è¿”å›ç»“æœåˆ¤æ–­ä¸åŒçš„çŠ¶æ€ã€‚</p>
<p>å¦‚æœç«¯å£ç¡®å®šæ˜¯å¼€æ”¾ï¼Œé‚£å°±å‘é€ <code>R</code> flagç»™ç›®æ ‡æœºå™¨ç»“æŸæ¡æ‰‹ (å¦‚æœä¸ç»“æŸæ¡æ‰‹çš„è¯ï¼Œé‚£å°±æ˜¯DDOS,è¿™ä¹Ÿæ˜¯DDOSæœ€å¸¸ç”¨çš„æ‰‹æ®µ); å› ä¸ºè¿™æ¬¡ä¸æ˜¯ä½¿ç”¨æ“ä½œç³»ç»ŸåŸç”Ÿçš„ <code>socket</code>, è€Œæ˜¯è‡ªè¡Œæ„é€ å‘é€ IPæ•°æ®åŒ…ï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨ä¸€ä¸ªå¾ˆå¼ºå¤§çš„æ„é€  æ“ä½œå„ç§æ•°æ®åŒ…çš„å·¥å…· &ndash; <a href="https://github.com/phaethon/scapy">scapy</a></p>
<p>(é¡ºä¾¿è¯´ä¸€ä¸‹ï¼Œå¦‚æœåœ¨Windowsä¸‹å®‰è£… scapy,éœ€è¦éå¸¸å¤šçš„æ­¥éª¤ï¼Œå¦‚æœæ˜¯Unix/Linux,åªéœ€å‡ è¡Œå‘½ä»¤:) )</p>
<h2 id="åè¯"><span class="section-num">3</span> åè¯</h2>
<p>ç®€å•çš„æ‰«æå™¨å°±å·²ç»å®Œæˆäº†ï¼ŒåŠ ä¸Šå¤šçº¿ç¨‹çš„åŠŸèƒ½æé«˜æ€§èƒ½ã€‚</p>
<p>å¾ˆæƒ³åå˜ˆä¸€ä¸‹ï¼ŒçœŸçš„å¯¹Python çš„å¤šçº¿ç¨‹æ¨é“ä¸æˆé’¢ï¼Œåªå¥½æ¢æˆå¤šè¿›ç¨‹ï¼›ä¹Ÿç»™ Python2 Python3 APIçš„æ”¹å˜æŠ˜è…¾å¾—å¤Ÿå‘›ï¼Œä¸ç¦è®©ç¬”è€…æ€€å¿µèµ·Java:(</p>
<p>å…¶å®æ­£å¦‚ç¬”è€…å¼€å¤´æ‰€è¨€çš„ï¼Œä½ ç¡®å®šéš”å£å®¶å¦¹å­æ˜¯å¦åœ¨å®¶çš„æ–¹æ³•æœ‰å¾ˆå¤šï¼Œä½ æ‰«æç«¯å£çš„æ–¹æ³•ä¹Ÿæœ‰å¾ˆå¤šï¼šä¾‹å¦‚ XMAS scan(TCPåœ£è¯æ ‘æ‰«æ), FIN scan,Null scan, ACK scan, Window scan, UDP scanç­‰ã€‚</p>
<p>å½“ç„¶ä½ å¦‚æœä¸æƒ³é’ˆå¯¹å„ç§æ‰«æéƒ½å†™ä¸€ä¸ªæ‰«æå™¨ï¼Œä½ å¯ä»¥ä½¿ç”¨ <a href="https://nmap.org/">nmap</a> è¿™ä¸ªåœ°çƒæœ€å¼ºå¤§çš„æ‰«æå™¨ (æ²¡æœ‰ä¹‹ä¸€). åœ¨Pythonä¹Ÿå·²ç»æœ‰ä¸nmapæ•´åˆçš„å¼ºå¤§çš„åŒ… <a href="http://xael.org/pages/python-nmap-en.html">python-nmap</a></p>
<p>æ‰«æå™¨å®Œæ•´ä»£ç åœ°å€ <a href="https://github.com/ramsayleung/PortScanner">https://github.com/ramsayleung/PortScanner</a></p>
<hr>
<p>å‚è€ƒ</p>
<ul>
<li><a href="http://resources.infosecinstitute.com/port-scanning-using-scapy/">http://resources.infosecinstitute.com/port-scanning-using-scapy/</a></li>
</ul>
<div center class="qr-container">
<img src="/ox-hugo/qrcode_gh_e06d750e626f_1.jpg" alt="qrcode_gh_e06d750e626f_1.jpg" width="160px" height="160px" center="t" class="qr-container" />
å…¬å·åŒæ­¥æ›´æ–°ï¼Œæ¬¢è¿å…³æ³¨ğŸ‘»
</div>
]]></content:encoded>
    </item>
    <item>
      <title>flaskç‰›åˆ€å°è¯•ä¹‹å¾®ä¿¡å…¬ä¼—å·å¼€å‘</title>
      <link>https://ramsayleung.github.io/zh/post/2017/weixin_flask/</link>
      <pubDate>Thu, 23 Feb 2017 00:00:00 -0800</pubDate>
      <guid>https://ramsayleung.github.io/zh/post/2017/weixin_flask/</guid>
      <description>An flask project</description>
      <content:encoded><![CDATA[<p><a href="http://flask.pocoo.org/">flask</a> æ˜¯ä¸€ä¸ªè½»é‡çº§çš„python æ¡†æ¶(å®˜ç½‘ç§°ä¸ºå¾®å‹æ¡†æ¶),å¾ˆå®¹æ˜“ä¸Šæ‰‹ï¼Œä¹‹å‰å› ä¸ºç¬”è€…è·Ÿæœ‹å‹å¼€å‘å°ç¨‹åºçš„æ—¶å€™ä½¿ç”¨è¿‡ flask,è¿‡åå°±é—å¿˜äº†ã€‚</p>
<p>ä¸ºäº†é‡æ‹¾flask, ç¬”è€…å†³å®šå†™ç‚¹å°ä¸œè¥¿ï¼Œä¹‹å‰å¼€å‘å°ç¨‹åºï¼Œä¸å¦‚ç°åœ¨å†ç©ç©å…¬ä¼—å·å¼€å‘</p>
<h2 id="éªŒè¯æœåŠ¡å™¨"><span class="section-num">1</span> éªŒè¯æœåŠ¡å™¨</h2>
<p>å¼€å‘å…¬ä¼—å·ä¹‹å‰ï¼Œè¦å…ˆéªŒè¯æœåŠ¡å™¨çš„æœ‰æ•ˆæ€§ï¼Œå®˜ç½‘æœ‰è¯¦ç»†çš„è¯´æ˜ï¼š<a href="https://mp.weixin.qq.com/wiki/8/f9a0b8382e0b77d87b3bcc1ce6fbc104.html">å…¬ä¼—å¼€å‘å¹³å°æ–‡æ¡£</a></p>
<table>
  <thead>
      <tr>
          <th>å‚æ•°</th>
          <th>æè¿°</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>signature</td>
          <td>å¾®ä¿¡åŠ å¯†ç­¾åï¼Œsignatureç»“åˆäº†å¼€å‘è€…å¡«å†™çš„tokenå‚æ•°å’Œè¯·æ±‚ä¸­çš„timestampå‚æ•°ã€nonceå‚æ•°ã€‚</td>
      </tr>
      <tr>
          <td>timestamp</td>
          <td>æ—¶é—´æˆ³</td>
      </tr>
      <tr>
          <td>nonce</td>
          <td>éšæœºæ•°</td>
      </tr>
      <tr>
          <td>echostr</td>
          <td>éšæœºå­—ç¬¦ä¸²</td>
      </tr>
  </tbody>
</table>
<p>æ ¡éªŒæµç¨‹ï¼š
åŠ å¯†/æ ¡éªŒæµç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>å°†tokenã€timestampã€nonceä¸‰ä¸ªå‚æ•°è¿›è¡Œå­—å…¸åºæ’åº</li>
<li>å°†ä¸‰ä¸ªå‚æ•°å­—ç¬¦ä¸²æ‹¼æ¥æˆä¸€ä¸ªå­—ç¬¦ä¸²è¿›è¡Œsha1åŠ å¯†</li>
<li>å¼€å‘è€…è·å¾—åŠ å¯†åçš„å­—ç¬¦ä¸²å¯ä¸signatureå¯¹æ¯”ï¼Œæ ‡è¯†è¯¥è¯·æ±‚æ¥æºäºå¾®ä¿¡</li>
</ol>
<p>æµç¨‹å¹¶ä¸å¤æ‚ï¼Œå®˜ç½‘ç»™å‡ºäº†ä»£ç ç¤ºä¾‹ï¼Œåªä¸è¿‡æ˜¯PHPçš„ï¼Œæ¢æˆpython ä¹Ÿæ˜¯å¾ˆå®¹æ˜“æ»´ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span><span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="k">def</span> <span class="nf">wechat</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="o">==</span><span class="s1">&#39;GET&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">token</span><span class="o">=</span><span class="s1">&#39;your token&#39;</span>
</span></span><span class="line"><span class="cl">            <span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">args</span>
</span></span><span class="line"><span class="cl">            <span class="n">signature</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;signature&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">timestamp</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">nonce</span> <span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nonce&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">echostr</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;echostr&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">s</span><span class="o">=</span><span class="p">[</span><span class="n">timestamp</span><span class="p">,</span><span class="n">nonce</span><span class="p">,</span><span class="n">token</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">s</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">s</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span><span class="o">==</span><span class="n">signature</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">echostr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">rec</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">xml_rec</span><span class="o">=</span><span class="n">ET</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">tou</span> <span class="o">=</span> <span class="n">xml_rec</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;ToUserName&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
</span></span><span class="line"><span class="cl">            <span class="n">fromu</span> <span class="o">=</span> <span class="n">xml_rec</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;FromUserName&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
</span></span><span class="line"><span class="cl">            <span class="n">content</span> <span class="o">=</span> <span class="n">xml_rec</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;Content&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
</span></span><span class="line"><span class="cl">            <span class="n">xml_rep</span> <span class="o">=</span> <span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="n">xml</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="n">ToUserName</span><span class="o">&gt;&lt;</span><span class="err">!</span><span class="p">[</span><span class="n">CDATA</span><span class="p">[</span><span class="o">%</span><span class="n">s</span><span class="p">]]</span><span class="o">&gt;&lt;/</span><span class="n">ToUserName</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="n">FromUserName</span><span class="o">&gt;&lt;</span><span class="err">!</span><span class="p">[</span><span class="n">CDATA</span><span class="p">[</span><span class="o">%</span><span class="n">s</span><span class="p">]]</span><span class="o">&gt;&lt;/</span><span class="n">FromUserName</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="n">CreateTime</span><span class="o">&gt;%</span><span class="n">s</span><span class="o">&lt;/</span><span class="n">CreateTime</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="n">MsgType</span><span class="o">&gt;&lt;</span><span class="err">!</span><span class="p">[</span><span class="n">CDATA</span><span class="p">[</span><span class="n">text</span><span class="p">]]</span><span class="o">&gt;&lt;/</span><span class="n">MsgType</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="n">Content</span><span class="o">&gt;&lt;</span><span class="err">!</span><span class="p">[</span><span class="n">CDATA</span><span class="p">[</span><span class="o">%</span><span class="n">s</span><span class="p">]]</span><span class="o">&gt;&lt;/</span><span class="n">Content</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="n">FuncFlag</span><span class="o">&gt;</span><span class="mi">0</span><span class="o">&lt;/</span><span class="n">FuncFlag</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;/</span><span class="n">xml</span><span class="o">&gt;</span><span class="s2">&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™æ ·æœåŠ¡å™¨å°±æ ¡éªŒæˆåŠŸäº†ï¼Œå°±å¯ä»¥ç¼–å†™ç›¸å…³çš„ä¸šåŠ¡é€»è¾‘äº†</p>
<h2 id="æ­Œè¯æŸ¥è¯¢"><span class="section-num">2</span> æ­Œè¯æŸ¥è¯¢</h2>
<p>ç¬”è€…è‡ªå·±å¹³æ—¶æ˜¯æ‰“å¼€éŸ³ä¹æ’­æ”¾å™¨ï¼Œæˆ´ä¸Šè€³æœºï¼Œå°±å¼€å§‹æ’­æ”¾éŸ³ä¹ï¼›æ‰€ä»¥ç»å¸¸å‡ºç°ç¬”è€…å¬åˆ°æŸé¦–æ­Œæ›²è§‰å¾—æ—‹å¾‹éå¸¸ç†Ÿæ‚‰ï¼Œä½†æ˜¯å°±æ— æ³•æƒ³èµ·æ­Œåçš„æƒ…å†µï¼Œè¿™ç§æ„Ÿè§‰å®åœ¨ä¸å¥½ï¼Œæ‰€ä»¥ç¬”è€…è§‰å¾—å¯ä»¥ç¼–å†™ä¸€ä¸ªé€šè¿‡æ­Œè¯æŸ¥è¯¢æ­Œæ›²ï¼Œå¹¶è¿”å›æ‰€æœ‰æ­Œè¯çš„åŠŸèƒ½ã€‚</p>
<p>æ€è·¯å¤§æ¦‚æ˜¯ç¼–å†™çˆ¬è™«ï¼Œé€šè¿‡æ­Œè¯è¿›è¡ŒæŸ¥è¯¢ï¼Œç„¶åå¯¹è¿”å›çš„html é¡µé¢è¿›è¡Œæ£€ç´¢å’Œä¿¡æ¯æå–ã€‚å‰©ä¸‹çš„äº‹å°±æ˜¯çˆ¬è™«å’Œè§£æé¡µé¢äº†ï¼Œç¬”è€…æ˜¯ä½¿ç”¨<a href="http://www.xiami.com/">è™¾ç±³</a> è¿›è¡Œæ­Œè¯æŸ¥è¯¢çš„ï¼Œä½¿ç”¨ request å‘é€ http è¯·æ±‚ï¼Œä½¿ç”¨ lxmlè¿›è¡Œè§£æï¼Œå…¶ä»–å°±ä¸ä¸€ä¸€ç»†è¡¨äº†</p>
<h2 id="å•è¯æŸ¥è¯¢"><span class="section-num">3</span> å•è¯æŸ¥è¯¢</h2>
<p>æœ‰æ—¶å€™ï¼Œç¬”è€…åœ¨å¾®ä¿¡éœ€è¦æŸ¥è¯¢å•è¯ï¼Œä½†æ˜¯åˆä¸æƒ³é€€å‡ºå¾®ä¿¡ï¼Œæ‰€ä»¥å°±æ‰“ç®—ç”¨å…¬ä¼—å·æ¥æŸ¥å•è¯å…¶å®å¾ˆç®€å•ï¼Œå°±æ˜¯æœåŠ¡è·å–ç”¨æˆ·å‘ç»™å¾®ä¿¡å…¬ä¼—å·çš„æ•°æ®ï¼Œå†å»è¯·æ±‚æœ‰é“ä¹‹ç±»è¯å…¸çš„api,å†æŠŠç»“æœè¿”å›ç»™æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨è½¬å‘ç»™ç”¨æˆ·</p>
<h2 id="ç”µå½±æŸ¥è¯¢"><span class="section-num">4</span> ç”µå½±æŸ¥è¯¢</h2>
<p>æœ‰æ—¶æ— èŠæƒ³å»çœ‹ç”µå½±ï¼Œä½†æ˜¯ä¸çŸ¥é“çœ‹ä»€ä¹ˆç”µå½±ï¼Œå› ä¸ºé€‰æ‹©å¤ªå¤šï¼Œè´¨é‡å‚å·®ä¸é½çš„ç‰‡å¤ªå¤šäº†æ‰€ä»¥ç¬”è€…ä¼šå…ˆå»è±†ç“£çœ‹ä¸€ä¸‹æ–°ä¸Šå½±çš„ç”µå½±ï¼Œçœ‹ä¸€ä¸‹è¯„åˆ†ï¼Œç„¶åå†å†³å®šçœ‹ä»€ä¹ˆç”µå½±ã€‚æ‰€ä»¥ï¼Œç¬”è€…å¯ä»¥æŠŠè¿™ä¸ªåŠŸèƒ½æ¬åˆ°å…¬ä¼—å·æ¥ã€‚å¦‚ä½•å®ç°å‘¢ï¼Ÿè¿˜æ˜¯çˆ¬è™«</p>
<h2 id="æ€»ç»“"><span class="section-num">5</span> æ€»ç»“</h2>
<p>æ„Ÿè§‰è¿™æ¬¡å¼€å‘å…¬ä¼—å·ï¼Œç¬”è€…å°±æ˜¯ç”¨ flask ç¼–å†™ restful api, ç„¶ååšçš„å…¶ä»–äº‹æƒ…å°±æ˜¯ç¼–å†™çˆ¬è™«ã€‚</p>
<p><a href="https://github.com/ramsayleung/SamrayJustForFun">é¡¹ç›®githubåœ°å€</a></p>
<div center class="qr-container">
<img src="/ox-hugo/qrcode_gh_e06d750e626f_1.jpg" alt="qrcode_gh_e06d750e626f_1.jpg" width="160px" height="160px" center="t" class="qr-container" />
å…¬å·åŒæ­¥æ›´æ–°ï¼Œæ¬¢è¿å…³æ³¨ğŸ‘»
</div>
]]></content:encoded>
    </item>
    <item>
      <title>åœ¨Emacsä¸­ä½¿ç”¨Ipython</title>
      <link>https://ramsayleung.github.io/zh/post/2016/emacs_ipython/</link>
      <pubDate>Wed, 03 Aug 2016 00:00:00 -0700</pubDate>
      <guid>https://ramsayleung.github.io/zh/post/2016/emacs_ipython/</guid>
      <description>Use Ipython in Emasc</description>
      <content:encoded><![CDATA[<h2 id="emacs-ipython-è¾“å‡ºé”™è¯¯"><span class="section-num">1</span> Emacs Ipython è¾“å‡ºé”™è¯¯</h2>
<p>åœ¨Emacs è¿è¡Œ <code>run-python</code> çš„æ—¶å€™ï¼ŒæŠ¥é”™äº†ï¼Œå¦‚ä¸‹</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-emacs-lisp" data-lang="emacs-lisp"><span class="line"><span class="cl"><span class="p">[</span><span class="sc">?1</span><span class="nv">2l</span><span class="p">[</span><span class="sc">?2</span><span class="nv">5h2+2</span>
</span></span><span class="line"><span class="cl">      <span class="p">[</span><span class="nv">J</span><span class="p">[</span><span class="sc">?7</span><span class="nv">h</span><span class="p">[</span><span class="sc">?1</span><span class="nv">2l</span><span class="p">[</span><span class="sc">?2</span><span class="nv">5h</span><span class="p">[</span><span class="sc">?2</span><span class="nv">004l</span><span class="p">[</span><span class="sc">?7</span><span class="nv">hOut</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">:</span> <span class="mi">4</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å› ä¸ºæˆ‘çš„ç‰ˆæœ¬æ—¶Ipython5,æŸ¥é˜…æ–‡æ¡£<a href="http://ipython.readthedocs.io/en/stable/whatsnew/version5.html#id1">http://ipython.readthedocs.io/en/stable/whatsnew/version5.html#id1</a>
ä¹‹åï¼Œå‘ç°Ipython5 æœ‰äº†æ–°çš„terminal æ¥å£ï¼Œå’ŒEmacs ç»§æ‰¿çš„shell ä¸å…¼å®¹ï¼Œæ‰€ä»¥
ä¼šå‡ºç°ä¸Šè¿°çš„é”™è¯¯ï¼Œåªè¦ç»™Ipython åŠ ä¸Šè¿è¡Œå‚æ•°å°±èƒ½è§£å†³äº†ï¼Œæ‰€ä»¥åªè¦åœ¨ <strong>.emacs</strong>
æˆ–è€…å¯¹åº”çš„åˆå§‹åŒ–æ–‡ä»¶åŠ ä¸Šä¸‹é¢è¯­å¥</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-emacs-lisp" data-lang="emacs-lisp"><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">python-shell-interpreter</span> <span class="s">&#34;ipython&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="nv">python-shell-interpreter-args</span> <span class="s">&#34;--simple-prompt -i&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h3 id="update-2017-3-15"><span class="section-num">1.1</span> Update 2017-3-15</h3>
<p>åœ¨æ·»åŠ äº† <code>--simple-promp -i</code> å‚æ•°ä»¥åï¼Œè™½è¯´ä¹±ç çš„é—®é¢˜è§£å†³äº†ï¼Œä½†æ˜¯æ–°çš„é—®é¢˜åˆå‡ºç°äº†
åœ¨Ipython é‡Œé¢æ˜¯æ²¡æ³•æ— æ³•è¾“å…¥å¤šè¡Œå†…å®¹çš„ï¼Œå³ä½¿æ˜¯ä¸€ä¸ªç®€å•çš„å¾ªç¯ï¼Œè¯¦æƒ…æŸ¥çœ‹è¿™æ¡issue
<a href="https://github.com/ipython/ipython/issues/9816">https://github.com/ipython/ipython/issues/9816</a>. ç°åœ¨Ipython å¼€å‘ç¤¾åŒºè¿˜æ²¡æœ‰è§£å†³è¿™ä¸ª
é—®é¢˜ï¼Œæ‰€ä»¥ç°åœ¨çš„æƒå®œä¹‹è®¡å°±æ˜¯ä½¿ç”¨ Ipython4,ç­‰åˆ°ç¤¾åŒºè§£å†³äº†è¿™ä¸ªé—®é¢˜åœ¨å‡çº§ä¸º Ipython5</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">pip install --force-reinstall <span class="nv">ipython</span><span class="o">==</span>4.2.1
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="emacs-ipython-çš„ä½¿ç”¨ä¼˜åŒ–"><span class="section-num">2</span> Emacs Ipython çš„ä½¿ç”¨ä¼˜åŒ–</h2>
<h3 id="python-pop"><span class="section-num">2.1</span> python-pop</h3>
<p>å› ä¸ºæˆ‘ä¹‹å‰ä½¿ç”¨Emacsçš„æ—¶å€™ï¼Œæ˜¯ä½¿ç”¨Spacemacsçš„é…ç½®çš„ï¼Œä½†æ˜¯åæ¥è§‰å¾—è¿˜æ˜¯è‡ªå·±çš„ é…ç½®ç”¨çš„æ›´èˆ’æœï¼Œæ‰€ä»¥åˆåˆ‡æ¢å›è‡ªå·±çš„é…ç½®ã€‚</p>
<p>ä½†æ˜¯æˆ‘è¿˜æ˜¯å¾ˆæƒ³å¿µSpacemacsçš„ä¸€äº›ç»‘å®šï¼Œ ä¾‹å¦‚shellåœ¨åº•ä¸‹å¼¹å‡ºï¼Œæˆ–è€…æ˜¯å…³é—­ï¼Œç„¶åæ‰¾åˆ°äº†<a href="https://github.com/kyagi/shell-pop-el">Shell-pop</a> è¿™package,å°±å¯ä»¥ç”¨å›
Spacemacsçš„shellä½¿ç”¨ä¹ æƒ¯ã€‚</p>
<p>ç„¶åæˆ‘è§‰å¾—ï¼ŒIpython shellä¹Ÿå¯ä»¥è¿™æ ·é…ç½®ï¼Œåªä¸è¿‡æˆ‘æ²¡æœ‰å‘ç°ç±»ä¼¼çš„package,åˆå› ä¸ºEmacs Lispçš„å¼ºå¤§ï¼Œæ‰€ä»¥æˆ‘è‡ªå·±å†™äº†ä¸€æ®µå°å‡½æ•°å®ç°
shell-pop çš„åŠŸèƒ½</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-emacs-lisp" data-lang="emacs-lisp"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">samray/python-pop</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Run python and switch to the python buffer.
</span></span></span><span class="line"><span class="cl"><span class="s">similar to shell-pop&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">interactive</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">if</span> <span class="p">(</span><span class="nf">get-buffer</span> <span class="s">&#34;*Python*&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nb">if</span> <span class="p">(</span><span class="nv">string=</span> <span class="p">(</span><span class="nf">buffer-name</span><span class="p">)</span> <span class="s">&#34;*Python*&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nb">if</span> <span class="p">(</span><span class="nv">not</span> <span class="p">(</span><span class="nv">one-window-p</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">              <span class="p">(</span><span class="nb">progn</span> <span class="p">(</span><span class="nv">bury-buffer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                     <span class="p">(</span><span class="nv">delete-window</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nb">progn</span> <span class="p">(</span><span class="nv">switch-to-buffer-other-window</span> <span class="s">&#34;*Python*&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">               <span class="p">(</span><span class="nv">end-of-buffer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">               <span class="p">(</span><span class="nv">evil-insert-state</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">progn</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">run-python</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">switch-to-buffer-other-window</span> <span class="s">&#34;*Python*&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">end-of-buffer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">evil-insert-state</span><span class="p">))))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¦‚æœæ²¡æœ‰ä½¿ç”¨Evil,å¯ä»¥æŠŠ <code>(evil-insert-state)</code> å»æ‰</p>
<h3 id="ipython-history"><span class="section-num">2.2</span> Ipython History</h3>
<p>æˆ‘åœ¨æ™®é€šçš„Shellä½¿ç”¨Ipythonçš„æ—¶å€™ï¼Œå¾ˆè‡ªç„¶åœ°ä½¿ç”¨ä¸Šä¸‹æ–¹å‘é”®ç¿»åˆ°ä¸Šä¸€æ¡/ä¸‹ä¸€æ¡
æ‰§è¡Œçš„å‘½ä»¤ï¼Œå› ä¸ºshellçš„ä½¿ç”¨ä¹ æƒ¯å°±æ˜¯è¿™æ ·æ»´ã€‚</p>
<p>ä½†æ˜¯åœ¨Emacsé‡Œé¢ä½¿ç”¨Ipython,ä¸Šä¸‹ æ–¹å‘é”®æ˜¯å»åˆ°ä¸Šä¸€è¡Œ/ä¸‹ä¸€è¡Œï¼Œå°±å¥½åƒ vim çš„ <code>j</code> <code>k</code>,å¦‚æœè¦ç¿»åˆ°ä¸Šä¸€æ¡å‘½ä»¤ï¼Œå¿«æ·é”®
æ˜¯ <code>M-p</code>,å®åœ¨å¾ˆä¸ä¹ æƒ¯ï¼Œæ‰€ä»¥åœ¨æŸ¥äº†ä¸€ä¸‹Emacs manual åï¼Œæˆ‘æ”¹äº†ä¸€ä¸‹æŒ‰é”®ç»‘å®šå°±å®ç°äº†æˆ‘æƒ³è¦çš„æ•ˆæœ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-emacs-lisp" data-lang="emacs-lisp"><span class="line"><span class="cl"><span class="p">(</span><span class="nf">define-key</span> <span class="nv">comint-mode-map</span> <span class="p">(</span><span class="nv">kbd</span> <span class="s">&#34;&lt;up&gt;&#34;</span><span class="p">)</span> <span class="ss">&#39;comint-previous-input</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nf">define-key</span> <span class="nv">comint-mode-map</span> <span class="p">(</span><span class="nv">kbd</span> <span class="s">&#34;&lt;down&gt;&#34;</span><span class="p">)</span> <span class="ss">&#39;comint-next-input</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Enjoy Emacs :)</p>
<div center class="qr-container">
<img src="/ox-hugo/qrcode_gh_e06d750e626f_1.jpg" alt="qrcode_gh_e06d750e626f_1.jpg" width="160px" height="160px" center="t" class="qr-container" />
å…¬å·åŒæ­¥æ›´æ–°ï¼Œæ¬¢è¿å…³æ³¨ğŸ‘»
</div>
]]></content:encoded>
    </item>
  </channel>
</rss>
