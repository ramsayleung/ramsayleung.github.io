<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>菠萝油与天光墟</title>
    <link>https://ramsayleung.github.io/zh/</link>
    <description>Recent content on 菠萝油与天光墟</description>
    <image>
      <title>菠萝油与天光墟</title>
      <url>https://ramsayleung.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E</url>
      <link>https://ramsayleung.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E</link>
    </image>
    <generator>Hugo -- 0.146.7</generator>
    <language>zh</language>
    <copyright>See this site&amp;rsquo;s source code here, licensed under GPLv3 ·</copyright>
    <lastBuildDate>Wed, 01 Oct 2025 23:15:35 -0700</lastBuildDate>
    <atom:link href="https://ramsayleung.github.io/zh/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>Telegram频道精华贴检索机器人</title>
      <link>https://ramsayleung.github.io/zh/post/2025/telegram%E9%A2%91%E9%81%93%E6%A3%80%E7%B4%A2%E6%9C%BA%E5%99%A8%E4%BA%BA/</link>
      <pubDate>Wed, 01 Oct 2025 21:55:00 -0700</pubDate>
      <guid>https://ramsayleung.github.io/zh/post/2025/telegram%E9%A2%91%E9%81%93%E6%A3%80%E7%B4%A2%E6%9C%BA%E5%99%A8%E4%BA%BA/</guid>
      <description>&lt;h2 id=&#34;引言&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;1&lt;/span&gt; 引言&lt;/h2&gt;
&lt;p&gt;我有时总会觉得自己是个「奇葩」：
在现在各种算法推荐大行其道的当下，我却偏偏不喜欢算法推荐，因为这种「千人千面」的模式，总让我担心自己会陷入「信息茧房」的焦虑之中，此外我也希望可以看到一些我兴趣之外的内容。&lt;/p&gt;</description>
      <content:encoded><![CDATA[<h2 id="引言"><span class="section-num">1</span> 引言</h2>
<p>我有时总会觉得自己是个「奇葩」：
在现在各种算法推荐大行其道的当下，我却偏偏不喜欢算法推荐，因为这种「千人千面」的模式，总让我担心自己会陷入「信息茧房」的焦虑之中，此外我也希望可以看到一些我兴趣之外的内容。</p>
<p>我算是很多年的 Twitter 老用户了，使用 Twitter 已经超过十年了，只是在马斯克收购 Twitter,新增了一个 &ldquo;For You&rdquo; 的推荐流之后，越来越没有兴趣看，不是吵架就是借极端观点/话题引流。</p>
<p>于是，我转向了Telegram频道，并为此打造了一个专属的「挖掘好帖」工具。</p>
<p>在最近的一年时间，我订阅了越来越多的 Telegram 频道，频道主可以向所有的订阅者广播内容，因为 Telegram 频道都是由频道主发布的，这给了我一种主动发现、主动阅读，而非被动接受算法推荐的感觉。</p>
<p>有频道主分享 twitter 上的内容时，也可以算是某种意义的「编辑精选」了。</p>
<p>当我订阅越来越多的频道之后，发现有些频道主太能聊了，一天能发几十个帖子，有些只是碎碎念，有些却是思考和精华。</p>
<p>所以我就在想，是否有个好用的挖宝藏（挖坟）工具，可以把频道的热贴，精华帖都列出来呢？</p>
<h2 id="灵感"><span class="section-num">2</span> 灵感</h2>
<p>另外一个我高频使用的网站就是 <a href="https://old.reddit.com">Reddit</a>, 不了解的 Reddit 的朋友可以理解成它是网站的百度贴吧，可以有不同的子版（subreddit），相当于不同的吧, 然后每个子版都有一个 <code>top</code> 的功能，可以按照过去一小时，过去24小时，过去一周，过去一年，历史全时段按帖子的顶贴数进行排序。</p>
<p>类似 <code>rust</code> 这个子版的历史精华帖：<a href="https://old.reddit.com/r/rust/top/">https://old.reddit.com/r/rust/top/</a></p>
<p>那么，我是否也可以对 Telegram 频道也实现类似的功能呢？</p>
<p>我可以把某个频道所有的帖子都爬下来，然后按点赞数，转发数，点击数按不同的时间段进行排序，</p>
<p>支持不同的时间段：包括一周内，一个月内，一年内，和历史所有帖子</p>
<p>相当于根据频道的订阅者的用手投票，挑选出不同时段最精华的帖子</p>
<h2 id="技术挑战"><span class="section-num">3</span> 技术挑战</h2>
<p>仔细分析之后，我发现检索频道并构建热榜是个相当有趣的技术问题，也与频道帖子本身的产品属性有关。</p>
<p>在我爬取某个频道的所有帖子后，如何与频道的最新动态保持同步更新呢？</p>
<p>毕竟像阅读数，转发数这些数据也是一直会更新的。</p>
<p>但是大部分历史的帖子的阅读数据都是不怎么会变化的，比如半年前的帖子可能就不会有人去翻看，订阅者大多只会关注最新的帖子。</p>
<p>每次都所有帖子都重新爬取一次固然可行，但是效率太低，毕竟绝大部分的帖子的数据都是不怎么变动的，怎么平衡性能与数据的及时性呢？</p>
<p>有点像超简化版本的搜索引擎问题了。</p>
<p>查询的时候要支持不同的时间段，按不同的指标进行排序，如何保证查询的性能呢？</p>
<p>总不能每次查询都重新计算一次吧，这样在帖子非常多的热点频道，就会出现查询的性能瓶颈。</p>
<h2 id="解决方案"><span class="section-num">4</span> 解决方案</h2>
<p>在仔细考量，权衡利弊之后，我取了个折衷的方案：</p>
<ol>
<li>第一次爬取某个频道时，全量爬取并索引</li>
<li>每天定时重新爬取最近30天的帖子数据，作增量更新</li>
<li>每周再爬取和索引一次全量数据</li>
</ol>
<p>就这样兼顾性能，成本以及数据及时性，又不会造成过多的重复爬取。</p>
<p>而对于查询性能，我选择了建立物化视图(material view)的策略, 每次爬取成功之后就重新计算，更新一下 material view, 耗时可能比较长，每个频道更新视图大概需要个十几秒。</p>
<p>但此后所有的查询都直接指向这个预计算好的视图，数据库还可以利用缓存优化，以空间换时间，查询性能因此得到保障</p>
<h2 id="使用示例"><span class="section-num">5</span> 使用示例</h2>
<p>使用方法非常简单：</p>
<ol>
<li>点击链接打开机器人：<a href="https://t.me/tele_ranker_bot">https://t.me/tele_ranker_bot</a></li>
<li>在对话框中输入 <code>/rank &lt;频道链接&gt;=，例如 =/rank https://t.me/pipeapplebun</code></li>
<li>首次检索一个频道时，机器人需要一些时间来建立索引（如下图所示），完成后会通知用户：</li>
</ol>

<figure>
    
    
    <input type="checkbox" id="zoomCheck-ec038" hidden>
    <label for="zoomCheck-ec038">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/first_index.jpg"/> 
    
    
    </label>
</figure>

<p>完成之后就会发消息通知用户</p>

<figure>
    
    
    <input type="checkbox" id="zoomCheck-c3d87" hidden>
    <label for="zoomCheck-c3d87">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/index_finish.jpg"/> 
    
    
    </label>
</figure>

<p>然后用户就可以按照点赞数，转发数，点击数查看帖子</p>

<figure>
    
    
    <input type="checkbox" id="zoomCheck-8afdf" hidden>
    <label for="zoomCheck-8afdf">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/rank1.jpg"/> 
    
    
    </label>
</figure>


<figure>
    
    
    <input type="checkbox" id="zoomCheck-d526d" hidden>
    <label for="zoomCheck-d526d">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/rank2.jpg"/> 
    
    
    </label>
</figure>

<p>通过这个工具，我甚至发现了一些有趣的现象：</p>
<p>某些频道看似有十几万订阅者，但近期帖子的点击数仅有一千多，还不到百分之一，数据真实性令人存疑。</p>
<h2 id="结语"><span class="section-num">6</span> 结语</h2>
<p>有了这个频道检索工具，我终于能在一个频道里高效「挖坟」了，再也不用担心错过沉淀在时间线里的精华。</p>
<p>不管是想回顾精华，还是挖掘隐藏好帖，甚至是做简单的数据挖掘，这个机器人都能搞定，举个例子：</p>
<ul>
<li>找最近一个月点赞最多的帖子</li>
<li>看看历史上点击最高的内容有哪些</li>
</ul>
<p>这次，我总算为自己、也为可能有同样需求的你们，打造了一个称手的工具。</p>
<ul>
<li>立即体验：<a href="https://t.me/tele_ranker_bot">https://t.me/tele_ranker_bot</a></li>
<li>我的频道（菠萝油与天光墟）: <a href="https://t.me/pipeapplebun">https://t.me/pipeapplebun</a></li>
</ul>
<h3 id="推荐阅读">推荐阅读</h3>
<ul>
<li>旅加经历
<ul>
<li><a href="https://ramsayleung.github.io/zh/post/2023/%E8%BF%99%E4%BA%9B%E5%B9%B4%E8%B5%B0%E8%BF%87%E7%9A%84%E8%B7%AF_%E4%BB%8E%E5%B9%BF%E5%B7%9E%E5%88%B0%E6%B8%A9%E5%93%A5%E5%8D%8E/">这些年走过的路：从广州到温哥华</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2023/%E5%8A%A0%E6%8B%BF%E5%A4%A7%E4%B9%8B%E5%88%9D%E4%BD%93%E9%AA%8C/">加拿大之初体验</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2024/%E7%99%BB%E9%99%86%E5%8A%A0%E6%8B%BF%E5%A4%A7%E4%B8%80%E5%B9%B4%E7%9A%84%E4%BD%93%E4%BC%9A/">登陆加拿大一年后的体会</a></li>
</ul>
</li>
<li>工具流分享
<ul>
<li><a href="https://ramsayleung.github.io/zh/post/2024/%E7%AE%80%E6%98%8E%E5%86%99%E4%BD%9C%E6%8C%87%E5%8D%97/">简明写作指南</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2023/%E6%88%91%E7%9A%84%E5%86%99%E4%BD%9C%E6%B5%81/">我的写作流</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2023/%E6%88%91%E7%9A%84%E7%94%BB%E5%9B%BE%E6%B5%81/">我的画图流：画图工具与技巧分享</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2023/%E6%88%91%E7%9A%84%E6%90%9C%E7%B4%A2%E6%B5%81/">我的搜索流：高效搜索经验分享</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2022/feynman_technique/">最好的学习方式：费曼学习法(Feynman Technique)</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2021/%E7%B3%BB%E7%BB%9F%E6%80%9D%E8%80%83/">系统思考：既见树木，又见森林</a></li>
</ul>
</li>
<li>思考感悟
<ul>
<li><a href="https://ramsayleung.github.io/zh/post/2024/%E7%BC%96%E7%A8%8B%E5%8D%81%E5%B9%B4%E7%9A%84%E6%84%9F%E6%82%9F/">编程十年的感悟</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2023/%E4%BB%8E%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98%E7%A6%BB%E7%BA%BF_%E6%88%91%E5%B8%A6%E8%B5%B0%E4%BA%86%E4%BB%80%E4%B9%88/">那些年，我从微信支付学到的东西</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2025/%E6%9D%82%E8%B0%88ai%E5%8F%96%E4%BB%A3%E7%A8%8B%E5%BA%8F%E5%91%98/">杂谈ai取代程序员</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2023/%E7%BD%AE%E8%BA%AB%E4%BA%8B%E5%86%85/">为什么梦想买不起，故乡回不去</a></li>
</ul>
</li>
<li>软件工程
<ul>
<li><a href="https://ramsayleung.github.io/zh/post/2025/a_philosophy_of_software_design/">软件设计的哲学</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2025/structure_and_interpretation_of_computer_programs/">一本读了八年还没读完的书</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2024/%E6%B5%8B%E8%AF%95%E6%8A%80%E8%83%BD%E8%BF%9B%E9%98%B6%E4%B8%80_%E8%BD%AF%E4%BB%B6%E8%B4%A8%E9%87%8F%E8%AE%A4%E7%9F%A5/">测试技能进阶(一): 软件质量认知</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2024/%E6%B5%8B%E8%AF%95%E6%8A%80%E8%83%BD%E8%BF%9B%E9%98%B6%E4%BA%8C_parameterized_tests/">测试技能进阶(二): Parameterized Tests</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2024/%E6%B5%8B%E8%AF%95%E6%8A%80%E8%83%BD%E8%BF%9B%E9%98%B6%E4%B8%89_property_based_testing/">测试技能进阶(三): Property Based Testing</a></li>
</ul>
</li>
</ul>
<div class="qr-container" center>
<img src="/ox-hugo/qrcode_gh_e06d750e626f_1.jpg" alt="qrcode_gh_e06d750e626f_1.jpg" class="qr-container" width="160px" height="160px" center="t" />
公号同步更新，欢迎关注👻
</div>
]]></content:encoded>
    </item>
    <item>
      <title>基于贝叶斯算法的Telegram广告拦截机器人（二）：上线半月的故障、挑战与优化之路</title>
      <link>https://ramsayleung.github.io/zh/post/2025/%E5%9F%BA%E4%BA%8E%E8%B4%9D%E5%8F%B6%E6%96%AF%E7%AE%97%E6%B3%95%E7%9A%84telegram%E5%B9%BF%E5%91%8A%E6%8B%A6%E6%88%AA%E6%9C%BA%E5%99%A8%E4%BA%BA%E4%BA%8C/</link>
      <pubDate>Sat, 13 Sep 2025 14:28:00 -0700</pubDate>
      <guid>https://ramsayleung.github.io/zh/post/2025/%E5%9F%BA%E4%BA%8E%E8%B4%9D%E5%8F%B6%E6%96%AF%E7%AE%97%E6%B3%95%E7%9A%84telegram%E5%B9%BF%E5%91%8A%E6%8B%A6%E6%88%AA%E6%9C%BA%E5%99%A8%E4%BA%BA%E4%BA%8C/</guid>
      <description>&lt;h2 id=&#34;引言&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;1&lt;/span&gt; 引言&lt;/h2&gt;
&lt;p&gt;半个月前，我发布了一个基于贝叶斯算法的Telegram广告拦截机器人 &lt;code&gt;@BayesSpamSniperBot&lt;/code&gt; (&lt;a href=&#34;https://t.me/BayesSpamSniperBot&#34;&gt;https://t.me/BayesSpamSniperBot&lt;/a&gt;)&lt;/p&gt;
&lt;p&gt;项目地址：&lt;a href=&#34;https://github.com/ramsayleung/bayes_spam_sniper&#34;&gt;https://github.com/ramsayleung/bayes_spam_sniper&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;系列文章:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://ramsayleung.github.io/zh/post/2025/%E4%B8%80%E4%B8%AA%E8%87%AA%E5%AD%A6%E4%B9%A0%E7%9A%84telegram%E5%B9%BF%E5%91%8A%E6%8B%A6%E6%88%AA%E6%9C%BA%E5%99%A8%E4%BA%BA/&#34;&gt;基于贝叶斯算法的Telegram广告拦截机器人（一）：从问题到产品&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;尽管项目代码开源，但我始终以产品思维运营它。上线半个月以来，经历了故障、用户反馈与持续优化，现将这段经历分享出来。&lt;/p&gt;</description>
      <content:encoded><![CDATA[<h2 id="引言"><span class="section-num">1</span> 引言</h2>
<p>半个月前，我发布了一个基于贝叶斯算法的Telegram广告拦截机器人 <code>@BayesSpamSniperBot</code> (<a href="https://t.me/BayesSpamSniperBot">https://t.me/BayesSpamSniperBot</a>)</p>
<p>项目地址：<a href="https://github.com/ramsayleung/bayes_spam_sniper">https://github.com/ramsayleung/bayes_spam_sniper</a></p>
<p>系列文章:</p>
<ul>
<li><a href="/zh/post/2025/%E4%B8%80%E4%B8%AA%E8%87%AA%E5%AD%A6%E4%B9%A0%E7%9A%84telegram%E5%B9%BF%E5%91%8A%E6%8B%A6%E6%88%AA%E6%9C%BA%E5%99%A8%E4%BA%BA/">基于贝叶斯算法的Telegram广告拦截机器人（一）：从问题到产品</a></li>
</ul>
<p>尽管项目代码开源，但我始终以产品思维运营它。上线半个月以来，经历了故障、用户反馈与持续优化，现将这段经历分享出来。</p>
<h2 id="上线即故障"><span class="section-num">2</span> 上线即故障</h2>
<p>没想到我的产品的第一个线上故障来得这么快，发布的时候直接不可用，把正常消息都给删了，用户在各种途径都向我反馈：</p>

<figure>
    
    
    <input type="checkbox" id="zoomCheck-c7b58" hidden>
    <label for="zoomCheck-c7b58">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/delete_all_message_1.jpg"/> 
    
    
    </label>
</figure>


<figure>
    
    
    <input type="checkbox" id="zoomCheck-80e7c" hidden>
    <label for="zoomCheck-80e7c">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/delete_all_message_2.jpg"/> 
    
    
    </label>
</figure>

<p>故障的原因是我当时一直在收集垃圾广告的数据，太专注于垃圾广告数据，而忽略了收集的正常数据，
导致垃圾广告数据过多，消息都被认为是垃圾广告，被误删了。</p>
<p>通过补充大量正常消息数据，重新平衡训练集，模型逐渐恢复正常识别能力。</p>
<h2 id="挑战"><span class="section-num">3</span> 挑战</h2>
<h3 id="邮件与即时消息的差异"><span class="section-num">3.1</span> 邮件与即时消息的差异</h3>
<p>我在<a href="/zh/post/2025/%E4%B8%80%E4%B8%AA%E8%87%AA%E5%AD%A6%E4%B9%A0%E7%9A%84telegram%E5%B9%BF%E5%91%8A%E6%8B%A6%E6%88%AA%E6%9C%BA%E5%99%A8%E4%BA%BA/">《基于贝叶斯算法的Telegram广告拦截机器人（一）：从问题到产品》</a>里面提到过：</p>
<blockquote>
<p>常见的 Telegram 广告机器人是大多是基于关键字的，通过匹配关键字进行文本拦截，非常容易被发垃圾广告的人绕过。</p>
<p>这不禁让我想起了保罗.格雷厄姆在《黑客与画家》一书在2002年介绍的情况：</p>
<p>当时电子邮件兴起，也有非常多的垃圾邮件，常见的垃圾广告拦截方式是关键字匹配+邮件地址黑名单，但是既低效也容易被绕过。</p>
<p>保罗.格雷厄姆就创造性地使用贝叶斯算法(Bayes Theorem)实现了一个广告拦截器, 效果竟然出奇地好。</p></blockquote>
<p>但产品上线之后，我发现聊天软件消息和Email虽然都是文字，还是有很大差别的:</p>
<p>Email 大多时候都是长文的，内容较长，并且大多情况，一封邮件上下文本身也很完整，就有较多的内容，较高的准确度来判断是否是广告。</p>
<p>而 Telegram, 微信这类的即时聊天软件，聊天消息大多都不长，可能把内容分成多条消息来发，就没有完整的上下文，比如:</p>
<blockquote>
<p>换U</p></blockquote>
<!--quoteend-->
<blockquote>
<p>找我</p></blockquote>
<p>单条消息很较难准确判断是否是广告，所以对即时消息做广告拦截本身就更难, 「短文本+无上下文」是NLP中的经典难题，也是本项目最大的技术挑战。</p>
<h3 id="漏删与误删"><span class="section-num">3.2</span> 漏删与误删</h3>
<p>漏删与误删是广告拦截中不可避免的矛盾权衡。</p>
<p>若想提高拦截率（召回率），就需降低置信度阈值，将更多疑似广告的消息拦截，但这也会增加误删正常消息的风险。</p>
<p>反之，若想避免误删（提高精确率），则必须提高置信度阈值，但这又会导致更多广告被漏掉。</p>
<p>在即时消息短小、上下文缺失的特性下，想同时实现零误删和零漏删几乎是不可能的。</p>
<p>权衡之下，我选择优先保证用户体验： <strong><strong>宁可漏删，不可误删</strong></strong></p>
<p>因为漏掉的广告，群友可以举报或由管理员手动删除；但误删的正常消息却无法恢复，对用户的伤害更大。</p>
<p>因此，我将拦截阈值设置为95%，即仅当模型有极高把握（&gt;95%概率）判定为广告时才会删除。</p>
<p>这虽然会放过一些疑似广告，但最大程度地保障了正常聊天不被误删。</p>
<h2 id="优化之路"><span class="section-num">4</span> 优化之路</h2>
<h3 id="自动删除消息"><span class="section-num">4.1</span> 自动删除消息</h3>
<p>产品上线之后，很快就有用户来试用了，然后其中一个用户就提了一个非常好的优化建议。</p>

<figure>
    
    
    <input type="checkbox" id="zoomCheck-28a2c" hidden>
    <label for="zoomCheck-28a2c">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/detect_spam_and_ban_user.jpg"/> 
    
    
    </label>
</figure>

<p>这个警告的消息不会自动删除，如果有很多人在群里发广告，那么群里就会有一堆这样的消息，也算是对群消息的污染。</p>
<p>所以用户建议:</p>
<blockquote>
<p>可以发这个提醒，但在几分钟后也把这个提醒消息删除掉</p></blockquote>
<p>我觉得这是个非常好的优化体验，因为就把这个功能给加上了，提醒消息本身会在5分钟后自动删除。</p>

<figure>
    
    
    <input type="checkbox" id="zoomCheck-3c682" hidden>
    <label for="zoomCheck-3c682">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/auto_delete_warning_message.jpg"/> 
    
    
    </label>
</figure>

<p>倾听用户的声音是非常重要的，他们可能就会从他们的角度提出非常好的建议。</p>
<p>但是不要盲目听从用户的建议，比如也有用户建议：</p>
<blockquote>
<p>我觉得还应该有以下功能.</p>
<ol>
<li>恢复消息, 恢复用户. (让管理员恢复误删的消息和用户)</li>
<li>主动投喂正常消息. (让管理员主动投喂一些消息. 比如, 群里面昨天 的消息, 随便选一些正常的, 投喂给机器人)</li>
</ol></blockquote>
<p>恢复消息这个功能没有太大必要，并且也不实用，因为恢复消息这个功能本身就很微妙，是直接恢复被删除的消息呢，还是重新发一条新消息？</p>
<p>如：</p>
<blockquote>
<ul>
<li>2025-09-09 10:01:00 张三: 我今天吃了鸡翅</li>
<li>2025-09-09 10:02:00 李四：鸡翅有啥好的（被误删消息）</li>
<li>2025-09-09 10:03:00 王五：人家就喜欢吃，你管得着嘛</li>
</ul></blockquote>
<p>如果是直接恢复被删除的消息，当前时间是 <code>2025-09-09 11:00:00</code> ，把消息恢复之后，还有人会手动刷历史消息，查找旧消息么？</p>
<p>Telegram客户端不一定支持会跳转被恢复的旧消息，这意味着，你恢复误删的消息，也没人看得到。</p>
<p>假如是重新发一条新消息 <code>鸡翅有啥好的</code>, 因为缺失了上下文，群里的人反而会疑惑，你在说什么。</p>
<p>解决误删问题本质是提高拦截的准确率，而非考虑如何恢复被误删消息，准确率提高了，误删就会减少，
自然就不需要考虑如何恢复消息，用户体验还会更好.</p>
<p>而主动投喂消息这个想法有点理所当然了。</p>
<p>没有任何群管理员有意愿帮忙训练这个机器人，对用户而言，他们只想要一个好用的广告拦截机器人，至于怎么开发，训练出来的，用户并不在乎。</p>
<p>所以用户不会有意愿和动力来优化这个机器人，不好用就再换一个好了，更何况，逐条消息收集的效率实在太慢太慢了，
所以我后面想出了一个比手工收集数据提效至少100倍的主意。</p>
<h3 id="过滤重复消息"><span class="section-num">4.2</span> 过滤重复消息</h3>
<p>发现人难免会有误区，总会以为别人会和自己一样，之前看到发垃圾广告的人的时候，总会觉得他们是正常的用户手工发。</p>
<p>但是最近几天发现了一些规律，有用户把同一条消息反复发，不同的群还是发同样的内容
即使是复制粘贴也难免会多个或者少个空格，然后消息被删了还一直发同样的内容。</p>
<p>此外，还有一些群，内容的聊天内容都是广告，我还很奇怪，大家都在发广告，正常用户不都跑了嘛?</p>

<figure>
    
    
    <input type="checkbox" id="zoomCheck-fc97b" hidden>
    <label for="zoomCheck-fc97b">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/spam_group.jpg"/> 
    
    
    </label>
</figure>

<p>此时，我才意识到，发消息的都是机器人。</p>
<p>所以我加了个优化，计算消息内容的 hash 值，保存到数据库，并为这个字段建立索引。</p>
<p>后面检测消息的时候，先根据 hash 值查询，检查是否存在已有的消息，如果消息已经存在且已经被标记成广告或者正常消息，那么就无需再使用模型检测，可以直接返回之前的检测结果。</p>
<p>这样既提高了准确度，也优化了性能，也减少了人工干预的成本。</p>
<p>同一个用户如果在同一个群发了三条广告，那么就会自动被封禁掉，也就是相同的广告只要发三条，就会马上被自动封禁掉。</p>
<hr>
<p>为什么是计算 hash 值并为该Hash值建立索引而非对完整的文本消息建立索引？</p>
<p>因为文本消息是变长的，并且聊天消息可能会很长，对这样的 <code>TEXT</code> 建立索引会产生非常大的索引结构，占用大量的磁盘空间，每次进入查找，插入和排序操作，速度都会较慢。</p>
<p>而 hash 值是定长且非常短（相对原始消息而言），建立索引速度非常快，此外 hash 函数保证只有相同的输入一定会产生相同的输出，而即使一个字符不一致，其计算出来的 hash 值就会不一致，就能判断内容文本不一致。</p>
<h3 id="自动收集数据"><span class="section-num">4.3</span> 自动收集数据</h3>
<p>使用机器学习算法来实现一个类似的垃圾广告过滤器并不难，困难的持续收集高质量的训练数据，训练数据是非常宝贵的，毕竟数据才是核心资产。</p>
<p>而对于我这个产品来说，最难的是冷启动时的训练数据问题：</p>
<p>因为没有训练数据，模型就不准确，模型不好用就不会有人使用，自然也无法通过用户来收集垃圾广告数据，就无法良性循环，
存在一个鸡生蛋，还是蛋生鸡的问题。</p>
<p>所以冷启动时，我是手动加了非常多的 Telegram大群，然后人工在里面收集垃圾广告.</p>
<p>但是这个效率实在是太低了，我收集了快一周才只有几百条数据，
一个是我无法一直盯着各个群，另外是这种20w的大群，一般都会有几个管理员，会手工删除广告，一会没有看垃圾广告数据就会被删掉了。</p>
<p>这样手工收集数据实在在太痛苦了，我就在想有没有什么办法自动收集数据呢？</p>
<p>我本来想的是直接把我的机器人拉到这些大群里面，即使没有管理员权限无法删除消息，也可以收集数据嘛，后面才意识到 Telegram 有个规定，只有群管理员才有权限加机器人，因为我不是管理员，所以自动没有权限添加机器人。</p>
<p>但是 telegram 的客户端是开源的，他们提供了 <a href="https://github.com/tdlib/td">tdlib</a> <sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>这个跨平台的 C++ 库便于社区构建第三方的 Telegram 客户端，那么我自然可以使用这个库来登录我自己的账号，然后使用我的模型来过滤消息，然后把疑似广告的数据都收集起来，我再人工确认下。</p>
<p>（顺便说一下，tdlib 和 <a href="https://github.com/tdlib/telegram-bot-api">telegram-bot-api</a> <sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup>这两个库竟然都是同一个<a href="https://github.com/levlam">作者 Aliaksei Levin</a> <sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup>在维护，实在是太强了。）</p>
<p>我现在需要做的就是添加各种大群，然后程序就会自动监听并收集数据，我再人工批量确认下。</p>

<figure>
    
    
    <input type="checkbox" id="zoomCheck-b4635" hidden>
    <label for="zoomCheck-b4635">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/spam_group_list.jpg"/> 
    
    
    </label>
</figure>


<figure>
    
    
    <input type="checkbox" id="zoomCheck-153f7" hidden>
    <label for="zoomCheck-153f7">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/telegram_data_collector.jpg"/> 
    
    
    </label>
</figure>


<figure>
    
    
    <input type="checkbox" id="zoomCheck-cbf5b" hidden>
    <label for="zoomCheck-cbf5b">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/maybe_spam_list.jpg"/> 
    
    
    </label>
</figure>

<p>实现起来也不复杂， 200行代码就实现了这个监听消息，分析，并且收集的功能。</p>
<p>得益于这个自动化的数据收集程序，我1周不到就收集了近上万条的高质量训练数据了，效率实在高太多太多了。</p>
<p>懒惰真的是程序员的美德, 这个经历再次证明：自动化工具往往能成倍提升效率，这正是工程师价值的体现.</p>
<h2 id="推广"><span class="section-num">5</span> 推广</h2>
<p>所谓酒香也怕巷子深，没有用户使用，代码写得再好也没有意义。从产品角度，运营推广至关重要。</p>
<p>作为个人开发者，我没有大量粉丝关注，也没有营销预算，因此采用了传统的推广方式：撰写博客并在相关社区分享。</p>
<p>我撰写了两篇双语博客文章，中文版本分享至：</p>
<ul>
<li>V2EX: <a href="https://www.v2ex.com/t/1156542">https://www.v2ex.com/t/1156542</a>]]</li>
<li>Emacs China: <a href="https://emacs-china.org/t/emacs-telegram/30043">https://emacs-china.org/t/emacs-telegram/30043</a></li>
<li>微信公众号「宫孙说」：<a href="https://mp.weixin.qq.com/s/Sgq9vDqpHykwge11bwZJrw">https://mp.weixin.qq.com/s/Sgq9vDqpHykwge11bwZJrw</a></li>
<li>项目被收录到<a href="https://www.ruanyifeng.com/blog/2025/09/weekly-issue-364.html">阮一峰的科技爱好者周刊（第 364 期）</a></li>
</ul>
<p>英文版本发布至：</p>
<ul>
<li>Reddit: <a href="https://old.reddit.com/r/rails/comments/1n6p791/built_my_first_rails_project_a_telegram_spam/">Built my first Rails project: A Telegram spam blocker bot</a> <sup id="fnref:4"><a href="#fn:4" class="footnote-ref" role="doc-noteref">4</a></sup>- 获得一些讨论</li>
<li>HackerNews：<a href="https://news.ycombinator.com/item?id=45105908">https://news.ycombinator.com/item?id=45105908</a></li>
<li>Twitter: <a href="https://x.com/foobar_ramsay/status/1967277792267247916">https://x.com/foobar_ramsay/status/1967277792267247916</a></li>
</ul>
<p>虽然推广效果有限，但这些努力为项目带来了最初的用户关注。</p>
<h2 id="成果与数据"><span class="section-num">6</span> 成果与数据</h2>
<p>上线半个月，截止到目前为止, 已经有超过80个群使用过这个机器人，用户数已经比我预期要多了:</p>
<table>
  <thead>
      <tr>
          <th>指标</th>
          <th>数值</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>GitHub Stars</td>
          <td>106</td>
      </tr>
      <tr>
          <td>使用群组数</td>
          <td>83</td>
      </tr>
      <tr>
          <td>训练数据量</td>
          <td>10543</td>
      </tr>
  </tbody>
</table>
<p>最开心的是看到我自己的程序在这些群成功拦截垃圾广告，就很有成就感，证明我做的东西真的能用户解决问题。</p>

<figure>
    
    
    <input type="checkbox" id="zoomCheck-1fd72" hidden>
    <label for="zoomCheck-1fd72">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/detect_spam_success.jpg"/> 
    
    
    </label>
</figure>

<h2 id="结语"><span class="section-num">7</span> 结语</h2>
<p>这半个月的运营让我深刻体会到：产品不是代码写完就结束，而是从用户反馈中不断迭代的开始。</p>
<p>产品是需要持续运营的，而写代码只是产品生命周期的其中一个环节，甚至不是最耗费时间的环节。</p>
<p>下一步，我计划进一步优化模型准确率，并探索多语言支持，也欢迎关注我的频道或提交Issue一起讨论。</p>
<ul>
<li>开源地址：<a href="https://github.com/ramsayleung/bayes_spam_sniper">https://github.com/ramsayleung/bayes_spam_sniper</a></li>
<li>立即体验：<a href="https://t.me/BayesSpamSniperBot">https://t.me/BayesSpamSniperBot</a></li>
<li>我的频道（菠萝油与天光墟）: <a href="https://t.me/pipeapplebun">https://t.me/pipeapplebun</a></li>
</ul>
<div class="qr-container" center>
<img src="/ox-hugo/qrcode_gh_e06d750e626f_1.jpg" alt="qrcode_gh_e06d750e626f_1.jpg" class="qr-container" width="160px" height="160px" center="t" />
公号同步更新，欢迎关注👻
</div>
<h3 id="推荐阅读">推荐阅读</h3>
<ul>
<li>旅加经历
<ul>
<li><a href="https://ramsayleung.github.io/zh/post/2023/%E8%BF%99%E4%BA%9B%E5%B9%B4%E8%B5%B0%E8%BF%87%E7%9A%84%E8%B7%AF_%E4%BB%8E%E5%B9%BF%E5%B7%9E%E5%88%B0%E6%B8%A9%E5%93%A5%E5%8D%8E/">这些年走过的路：从广州到温哥华</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2023/%E5%8A%A0%E6%8B%BF%E5%A4%A7%E4%B9%8B%E5%88%9D%E4%BD%93%E9%AA%8C/">加拿大之初体验</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2024/%E7%99%BB%E9%99%86%E5%8A%A0%E6%8B%BF%E5%A4%A7%E4%B8%80%E5%B9%B4%E7%9A%84%E4%BD%93%E4%BC%9A/">登陆加拿大一年后的体会</a></li>
</ul>
</li>
<li>工具流分享
<ul>
<li><a href="https://ramsayleung.github.io/zh/post/2024/%E7%AE%80%E6%98%8E%E5%86%99%E4%BD%9C%E6%8C%87%E5%8D%97/">简明写作指南</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2023/%E6%88%91%E7%9A%84%E5%86%99%E4%BD%9C%E6%B5%81/">我的写作流</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2023/%E6%88%91%E7%9A%84%E7%94%BB%E5%9B%BE%E6%B5%81/">我的画图流：画图工具与技巧分享</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2023/%E6%88%91%E7%9A%84%E6%90%9C%E7%B4%A2%E6%B5%81/">我的搜索流：高效搜索经验分享</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2022/feynman_technique/">最好的学习方式：费曼学习法(Feynman Technique)</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2021/%E7%B3%BB%E7%BB%9F%E6%80%9D%E8%80%83/">系统思考：既见树木，又见森林</a></li>
</ul>
</li>
<li>思考感悟
<ul>
<li><a href="https://ramsayleung.github.io/zh/post/2024/%E7%BC%96%E7%A8%8B%E5%8D%81%E5%B9%B4%E7%9A%84%E6%84%9F%E6%82%9F/">编程十年的感悟</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2023/%E4%BB%8E%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98%E7%A6%BB%E7%BA%BF_%E6%88%91%E5%B8%A6%E8%B5%B0%E4%BA%86%E4%BB%80%E4%B9%88/">那些年，我从微信支付学到的东西</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2025/%E6%9D%82%E8%B0%88ai%E5%8F%96%E4%BB%A3%E7%A8%8B%E5%BA%8F%E5%91%98/">杂谈ai取代程序员</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2023/%E7%BD%AE%E8%BA%AB%E4%BA%8B%E5%86%85/">为什么梦想买不起，故乡回不去</a></li>
</ul>
</li>
<li>软件工程
<ul>
<li><a href="https://ramsayleung.github.io/zh/post/2025/a_philosophy_of_software_design/">软件设计的哲学</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2025/structure_and_interpretation_of_computer_programs/">一本读了八年还没读完的书</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2024/%E6%B5%8B%E8%AF%95%E6%8A%80%E8%83%BD%E8%BF%9B%E9%98%B6%E4%B8%80_%E8%BD%AF%E4%BB%B6%E8%B4%A8%E9%87%8F%E8%AE%A4%E7%9F%A5/">测试技能进阶(一): 软件质量认知</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2024/%E6%B5%8B%E8%AF%95%E6%8A%80%E8%83%BD%E8%BF%9B%E9%98%B6%E4%BA%8C_parameterized_tests/">测试技能进阶(二): Parameterized Tests</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2024/%E6%B5%8B%E8%AF%95%E6%8A%80%E8%83%BD%E8%BF%9B%E9%98%B6%E4%B8%89_property_based_testing/">测试技能进阶(三): Property Based Testing</a></li>
</ul>
</li>
</ul>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p><a href="https://github.com/tdlib/td">https://github.com/tdlib/td</a>&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2">
<p><a href="https://github.com/tdlib/telegram-bot-api">https://github.com/tdlib/telegram-bot-api</a>&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:3">
<p><a href="https://github.com/levlam">https://github.com/levlam</a>&#160;<a href="#fnref:3" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:4">
<p><a href="https://old.reddit.com/r/rails/comments/1n6p791/built_my_first_rails_project_a_telegram_spam/">https://old.reddit.com/r/rails/comments/1n6p791/built_my_first_rails_project_a_telegram_spam/</a>&#160;<a href="#fnref:4" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>
]]></content:encoded>
    </item>
    <item>
      <title>基于贝叶斯算法的Telegram广告拦截机器人（一）：从问题到产品</title>
      <link>https://ramsayleung.github.io/zh/post/2025/%E4%B8%80%E4%B8%AA%E8%87%AA%E5%AD%A6%E4%B9%A0%E7%9A%84telegram%E5%B9%BF%E5%91%8A%E6%8B%A6%E6%88%AA%E6%9C%BA%E5%99%A8%E4%BA%BA/</link>
      <pubDate>Thu, 28 Aug 2025 23:45:00 -0700</pubDate>
      <guid>https://ramsayleung.github.io/zh/post/2025/%E4%B8%80%E4%B8%AA%E8%87%AA%E5%AD%A6%E4%B9%A0%E7%9A%84telegram%E5%B9%BF%E5%91%8A%E6%8B%A6%E6%88%AA%E6%9C%BA%E5%99%A8%E4%BA%BA/</guid>
      <description>&lt;p&gt;&lt;a href=&#34;https://ramsayleung.github.io/en/post/2025/a_telegram_spam_blocker_bot_based_on_bayesian/&#34;&gt;English Version&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;系列文章：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://ramsayleung.github.io/zh/post/2025/%E5%9F%BA%E4%BA%8E%E8%B4%9D%E5%8F%B6%E6%96%AF%E7%AE%97%E6%B3%95%E7%9A%84telegram%E5%B9%BF%E5%91%8A%E6%8B%A6%E6%88%AA%E6%9C%BA%E5%99%A8%E4%BA%BA%E4%BA%8C/&#34;&gt;基于贝叶斯算法的Telegram广告拦截机器人（二）：上线半月的故障、挑战与优化之路&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;序言&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;1&lt;/span&gt; 序言&lt;/h2&gt;
&lt;p&gt;我花了一周末时间，写了一个自学习的 Telegram 广告拦截机器人 &lt;code&gt;@BayesSpamSniperBot&lt;/code&gt; (&lt;a href=&#34;https://t.me/BayesSpamSniperBot&#34;&gt;https://t.me/BayesSpamSniperBot&lt;/a&gt;)，项目开源在：&lt;a href=&#34;https://github.com/ramsayleung/bayes_spam_sniper&#34;&gt;https://github.com/ramsayleung/bayes_spam_sniper&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&#34;telegram&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;1.1&lt;/span&gt; Telegram&lt;/h3&gt;
&lt;p&gt;Telegram 是一个流行的即时通讯软件，类似微信，Whatsapp，已有超过10亿用户，支持许多强大的功能，如聊天记录云存储，支持Linux, Mac, Windows, Android, IOS, Web 多个平台，客户端都是开源，类似微信公众号的频道功能(Channel)，还有我见过的最强大的机器人系统。&lt;/p&gt;</description>
      <content:encoded><![CDATA[<p><a href="https://ramsayleung.github.io/en/post/2025/a_telegram_spam_blocker_bot_based_on_bayesian/">English Version</a></p>
<p>系列文章：</p>
<ul>
<li><a href="/zh/post/2025/%E5%9F%BA%E4%BA%8E%E8%B4%9D%E5%8F%B6%E6%96%AF%E7%AE%97%E6%B3%95%E7%9A%84telegram%E5%B9%BF%E5%91%8A%E6%8B%A6%E6%88%AA%E6%9C%BA%E5%99%A8%E4%BA%BA%E4%BA%8C/">基于贝叶斯算法的Telegram广告拦截机器人（二）：上线半月的故障、挑战与优化之路</a></li>
</ul>
<h2 id="序言"><span class="section-num">1</span> 序言</h2>
<p>我花了一周末时间，写了一个自学习的 Telegram 广告拦截机器人 <code>@BayesSpamSniperBot</code> (<a href="https://t.me/BayesSpamSniperBot">https://t.me/BayesSpamSniperBot</a>)，项目开源在：<a href="https://github.com/ramsayleung/bayes_spam_sniper">https://github.com/ramsayleung/bayes_spam_sniper</a></p>
<h3 id="telegram"><span class="section-num">1.1</span> Telegram</h3>
<p>Telegram 是一个流行的即时通讯软件，类似微信，Whatsapp，已有超过10亿用户，支持许多强大的功能，如聊天记录云存储，支持Linux, Mac, Windows, Android, IOS, Web 多个平台，客户端都是开源，类似微信公众号的频道功能(Channel)，还有我见过的最强大的机器人系统。</p>
<h2 id="缘起"><span class="section-num">2</span> 缘起</h2>
<p>平时我跑步和做饭都习惯会听播客，而《<a href="https://podcasts.apple.com/us/podcast/%E8%BD%AF%E4%BB%B6%E9%82%A3%E4%BA%9B%E4%BA%8B%E5%84%BF/id1147186605">软件那些事儿</a>》<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>是我最喜欢的播客之一，主持人是<a href="https://liuyandong.com/sample-page">栋哥</a> <sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup>, 我也因为喜欢栋哥的节目，趁机加了栋哥的电报频道。</p>
<p>栋哥的电报频道<a href="https://t.me/huruanhuying">汗牛充栋</a> <sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup>主要是用来发布播客信息，
之前打开过一段时间的留言功能，没有想到引来了一堆的币圈的用户来发广告，因此将评论功能就关了：</p>

<figure>
    
    
    <input type="checkbox" id="zoomCheck-be4f5" hidden>
    <label for="zoomCheck-be4f5">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/spam_concert.jpg"/> 
    
    
    </label>
</figure>

<p>另外一个我关注的频道 <a href="https://t.me/kaedeharakazuha17">Ray Tracing</a> <sup id="fnref:4"><a href="#fn:4" class="footnote-ref" role="doc-noteref">4</a></sup>也在吐槽币圈的广告，不堪其忧:</p>

<figure>
    
    
    <input type="checkbox" id="zoomCheck-d541b" hidden>
    <label for="zoomCheck-d541b">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/ray_tracing_spam.jpg"/> 
    
    
    </label>
</figure>

<h2 id="黑客与画家"><span class="section-num">3</span> 黑客与画家</h2>
<p>常见的 Telegram 广告机器人是大多是基于关键字的，通过匹配关键字进行文本拦截，非常容易被发垃圾广告的人绕过。</p>

<figure>
    
    
    <input type="checkbox" id="zoomCheck-1401f" hidden>
    <label for="zoomCheck-1401f">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/keyword_based_blocker.jpg"/> 
    
    
    </label>
</figure>

<p>被绕过的话主要是靠管理员人工删除。</p>
<p>这不禁让我想起了保罗.格雷厄姆在《黑客与画家》一书在2002年介绍的情况：</p>
<p>当时电子邮件兴起，也有非常多的垃圾邮件，常见的垃圾广告拦截方式是关键字匹配+邮件地址黑名单，但是既低效也容易被绕过。</p>
<p>保罗.格雷厄姆就创造性地使用贝叶斯算法(Bayesian Theorem)实现了一个<a href="https://paulgraham.com/spam.html">广告拦截器</a> <sup id="fnref:5"><a href="#fn:5" class="footnote-ref" role="doc-noteref">5</a></sup>, 效果竟然出奇地好。</p>
<p>对于 Telegram 的垃圾广告而言，这不是类似的问题嘛？</p>
<p>那我岂不是可以用类似的解决方案来解决 Telegram 广告的问题嘛</p>
<h3 id="贝叶斯定理"><span class="section-num">3.1</span> 贝叶斯定理</h3>
<p>提起概率算法，最经典的例子莫过于「抛硬币」这一古典概率——每次抛掷都是独立事件，前一次的结果不会影响下一次的概率。</p>
<p>然而，现实中的很多场景并不能像抛硬币那样无限重复，事件之间也往往并非相互独立。</p>
<p>这时候，贝叶斯定理就显示出其独特的价值。</p>
<p>它是一种「由果溯因」的概率方法，用于在已知某些证据的条件下，更新我们对某一假设的置信程度。</p>
<p>换句话说，贝叶斯算法能够根据不断出现的新证据，动态调整对某个事件发生概率的估计。</p>
<p>简单来说，就像人脑的学习过程：我们原本有一个初步认知，在获得新信息之后，会据此修正原有的看法，进而调整下一步的行动。</p>
<p>保罗·格雷厄姆就是通过贝叶斯定理，不断地根据已被标记为垃圾广告或者非垃圾广告的邮件，对新出现的邮件进行分类，判断其是否为垃圾广告。</p>
<p>如果想更直观地理解贝叶斯定理，推荐两个讲解清晰、生动易懂的视频：</p>
<ul>
<li>《<a href="https://www.youtube.com/watch?v=Pu675cHJ7bg">Bayes&rsquo; Theorem 贝叶斯定理</a>》<sup id="fnref:6"><a href="#fn:6" class="footnote-ref" role="doc-noteref">6</a></sup>(中文)</li>
<li>《<a href="https://www.youtube.com/watch?v=HZGCoVF3YvM">Bayes theorem, the geometry of changing beliefs</a>》<sup id="fnref:7"><a href="#fn:7" class="footnote-ref" role="doc-noteref">7</a></sup>(英文)</li>
</ul>
<h2 id="架构设计"><span class="section-num">4</span> 架构设计</h2>
<p>Telegram Bot 支持两种与 Telegram 服务器交互的模式，分别是：</p>
<ol>
<li>
<p>Webhook: Telegram 服务器会在 Bot 收到新消息时主动回调此前 Bot 注册的地址，Bot Server 只需要处理回调的消息</p>
</li>
<li>
<p>Long Polling: Bot Server 一直轮询 Telegram 服务器，看是否有新消息，有就处理，本机器人使用的是此模式</p>

    <figure>
        
        
        <input type="checkbox" id="zoomCheck-ca97a" hidden>
        <label for="zoomCheck-ca97a">
        
        
        <img class="zoomCheck" loading="lazy" src="/ox-hugo/webhook_vs_long_polling.jpg"/> 
        
        
        </label>
    </figure>

</li>
</ol>
<h4 id="消息分析"><span class="section-num">4.0.1</span> 消息分析</h4>

<figure>
    
    
    <input type="checkbox" id="zoomCheck-e2518" hidden>
    <label for="zoomCheck-e2518">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/spam_analyze.jpg"/> 
    
    
    </label>
</figure>

<p>Bot Server 收到消息之后，会派发到单独的 <code>telegram_bot_worker</code> 处理，然后根据预训练的模型判断是否是垃圾广告，如果是，调用 Bot API 删除消息。</p>
<h4 id="封禁并训练"><span class="section-num">4.0.2</span> 封禁并训练</h4>

<figure>
    
    
    <input type="checkbox" id="zoomCheck-04d7c" hidden>
    <label for="zoomCheck-04d7c">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/mark_spam_and_ban_user.jpg"/> 
    
    
    </label>
</figure>

<p>Bot Server 收到消息之后，会派发到单独的 <code>telegram_bot_worker</code> 处理， <code>telegram_bot_worker</code> 会调用 bot API 删除消息并封禁用户，并插入一条训练数据，标记为垃圾广告(spam)</p>
<p>保存训练数据会触发 hook, 创建一个训练消息，投递到消息队列 <code>training</code>, 会有另外的 worker <code>classifier_trainer</code> 订阅 <code>training</code> 消息，并使用新消息重新训练和更新模型</p>
<p>使用队列和后台进程 <code>classifier_trainer</code> 来训练任务而非直接使用 <code>telegram_bot_worker</code> 主要是为了返回 Bot请求与训练模型解耦，否则随着模型规模的增大，训练时间会越来越长，响应时间会越来越长。</p>
<p>解耦后就易于水平扩展了，在设计上为后续性能优化和扩展预留空间。</p>
<h2 id="why-rails"><span class="section-num">5</span> Why Rails</h2>
<p>看了我项目源代码的朋友，难免会浮起疑问，为什么使用 Ruby on Rails 实现的?</p>
<p>因为我工作中会有用到JVM系的编程语言(Java/Kotlin/Scala)和 Rust, 所以我对 Java/Rust 相当熟悉，又觉得模型训练可能对性能要求很高，所以最开始的<a href="https://gist.github.com/ramsayleung/5848af0177a70a01d41f624e361b1b5d">原型</a> <sup id="fnref:8"><a href="#fn:8" class="footnote-ref" role="doc-noteref">8</a></sup>我是用 Rust 实现的，大概就花了半个多小时。</p>
<p>但是当我想把原型扩展成 Telegram 机器人时，就发现需要处理相当多与机器人交互的逻辑，主要涉及到 API 与数据库操作，其中大部分都是和模型无关的，因此我又想到了 Ruby on Rails。</p>
<p>论单个工程师做产品原型，就我个人而言，实在是没有比 <code>Ruby on Rails</code> 更高效的框架了，因此我就切换到 Ruby on Rails 去。</p>
<p>Rails 8 的新特性，把 Rails 向所谓的「一人全栈框架」又推进了不少，通过关系型数据库内置对消息队列 <code>Solid Queue</code> 的支持，甚至不再需要类似 Redis 这样的存储来支持队列实现。</p>
<p>架构设计中的队列和后台进程，只需要几行代码就实现了，甚至不需要额外的配置，如果队列不存在，框架会自动创建：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ruby" data-lang="ruby"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ClassifierTrainerJob</span> <span class="o">&lt;</span> <span class="no">ApplicationJob</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># Job to train classifier asynchronously</span>
</span></span><span class="line"><span class="cl">  <span class="n">queue_as</span> <span class="ss">:training</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">def</span> <span class="nf">perform</span><span class="p">(</span><span class="n">group_id</span><span class="p">,</span> <span class="n">group_name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="no">SpamClassifierService</span><span class="o">.</span><span class="n">rebuild_for_group</span><span class="p">(</span><span class="n">group_id</span><span class="p">,</span> <span class="n">group_name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="k">end</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>得益于 Rails 强大的 ORM 框架，内置各种生命周期的 hook, 对新插入训练数据后触发后台进程重新训练模型的代码也只有寥寥几行：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ruby" data-lang="ruby"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">TrainedMessage</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># Automatically train classifier after creating/updating a message</span>
</span></span><span class="line"><span class="cl">  <span class="n">after_create</span> <span class="ss">:retrain_classifier</span>
</span></span><span class="line"><span class="cl">  <span class="n">after_destroy</span> <span class="ss">:retrain_classifier</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">def</span> <span class="nf">retrain_classifier</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># For efficiency, we could queue this as a background job</span>
</span></span><span class="line"><span class="cl">    <span class="no">ClassifierTrainerJob</span><span class="o">.</span><span class="n">perform_later</span><span class="p">(</span><span class="n">group_id</span><span class="p">,</span> <span class="n">group_name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="k">end</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在 Rails 各种内置强大工具的加持下，我只用了一天时间就把整个机器人的功能给实现出来了。</p>
<p>看到这里，有朋友可能会担心性能，觉得 Ruby 性能不行，并且还是动态语言，不好维护。</p>
<p>我持有的观点还是和之前的博文《<a href="https://ramsayleung.github.io/zh/post/2024/%E7%BC%96%E7%A8%8B%E5%8D%81%E5%B9%B4%E7%9A%84%E6%84%9F%E6%82%9F/">编程十年的感悟</a>》<sup id="fnref:9"><a href="#fn:9" class="footnote-ref" role="doc-noteref">9</a></sup>一样：</p>
<p>先跑起来再说，先做个原型跑起来，有用户愿意用你的产品再说，
当运行速度成为瓶颈时，你的业务肯定非常大了，肯定有足够的资源招一打程序员把项目优化成 Rust/C++, 甚至是汇编。</p>
<p>没有用户，谈性能只是个伪命题。</p>
<p>至于动态语言一时爽，代码维护火葬场，我也是相当认同的。</p>
<p>因此我在为团队选型时我绝对不会考虑动态语言，只会上编译型的语言，
甚至是Rust这种强类型，但是现在只有我一个人来做原型，我自己是什么顺手就用什么的。</p>
<h3 id="vibe-coding"><span class="section-num">5.1</span> Vibe Coding?</h3>
<p>Vibe Coding等AI编程概念可谓是铺天盖地，甚嚣尘上，难免会有朋友好奇我这个项目是否 Vibe Coding生成的。</p>
<p>答案是，我尝试了几个小时之后，直接放弃了， Claude 4 和 Gemini 2.5 Pro 都试过了。</p>
<p>开始是使用 Rust + Cloudflare Worker 的技术栈，Rust + Cloudflare Worker 是个相当小众的领域，训练语料少，Vibe Coding 出来的代码编译无法通过</p>
<p>后面换成 Ruby on Rails, 问题还更严重了，Ruby 是弱类型的动态语言，语法写起来和英语一样，Rails 又还有很多黑魔法，所以到运行时才报错，代码生成省下来的开发时间，debug过程全补回来了。</p>
<p>另外一个是 Vibe Coding 生成的代码很多都是没有设计的，比如把 <code>Classifier</code> 和 <code>TrainedMessage</code> 的类耦合在一起，在 <code>Classifier</code> 里面持久化 <code>TrainedMessage</code></p>
<p>又直接在 <code>telegram_bot_worker</code> 进程里面，接收到训练信息马上同步训练新模型，训练完再返回调用命令的结果，完全没考虑解耦接收训练语料和模型训练。</p>
<p>只能说 Vibe Coding 非常适合 Rust 这样的强类型编译型语言，生成的出来的代码起码要编译通过，保证质量的下限。</p>
<p>而对于那些说「一行代码都不用写/改，就能做出一个APP」的言论，此时我脑海不禁升起疑问？</p>
<p>究竟是代码好到一行都不用改？还是开发者看不出症结所在，所以一行都不改？</p>
<h2 id="设计理念"><span class="section-num">6</span> 设计理念</h2>
<p>开发完原型，在机器人整体功能可用之后，脑中又有不少的想法冒出来，当时就马不停蹄地给机器人加上，
因此机器人就支持快十个命令，还支持私聊和群聊的不同模式。</p>
<p>加着加着，连我自己都疑惑起来：这么多的功能，有点像国内的各种大而全的App了，我不禁对此产生疑问：</p>
<p>真的会有用户用这么多功能么？真的有用户会用这些功能嘛？太多功能不是也会有额外的心智负担嘛?</p>
<p>我最喜欢的广告拦截器 <a href="https://ublockorigin.com/">Ublock Origin</a> <sup id="fnref:10"><a href="#fn:10" class="footnote-ref" role="doc-noteref">10</a></sup>拦截效果非常好，但是使用起来却非常简单，易上手。</p>
<p>想起《<a href="https://ramsayleung.github.io/zh/post/2025/a_philosophy_of_software_design/">软件设计的哲学</a>》<sup id="fnref:11"><a href="#fn:11" class="footnote-ref" role="doc-noteref">11</a></sup>里面提到的设计理念，接口应该是简单易用的，但是功能可以是复杂丰富的。</p>
<p>因此我只能忍痛把此前新增的，但与核心功能无关的命令都删掉；</p>
<p>此外考虑到可能绝大多数的用户都没有技术背景，也可能不知道命令怎么用，因此将命令尽可能地优化成按钮，用户可以直接点击，改善易用性:</p>

<figure>
    
    
    <input type="checkbox" id="zoomCheck-e207f" hidden>
    <label for="zoomCheck-e207f">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/start_zh.jpg"/> 
    
    
    </label>
</figure>


<figure>
    
    
    <input type="checkbox" id="zoomCheck-ca4b6" hidden>
    <label for="zoomCheck-ca4b6">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/help_page_zh.jpg"/> 
    
    
    </label>
</figure>

<p>我还希望可以支持多语言，比如根据用户的系统语言，自动切换到中文或者英文，这个就需要不同语言的文案。</p>

<figure>
    
    
    <input type="checkbox" id="zoomCheck-5f8d5" hidden>
    <label for="zoomCheck-5f8d5">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/start_en.jpg"/> 
    
    
    </label>
</figure>


<figure>
    
    
    <input type="checkbox" id="zoomCheck-bc48d" hidden>
    <label for="zoomCheck-bc48d">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/help_en.jpg"/> 
    
    
    </label>
</figure>

<p><a href="https://github.com/ramsayleung/bayes_spam_sniper/blob/master/app/services/telegram_botter.rb">telegram_botter.rb</a> 这个核心服务类里面有超过60%的代码都是为了此类易用性改进而引入的。</p>
<p>简单留给用户，复杂留给开发</p>
<h3 id="如何使用"><span class="section-num">6.1</span> 如何使用</h3>
<p>只需两步，机器人就可以自动工作。</p>
<ul>
<li>将机器人（@BayesSpamSniperBot）<a href="https://t.me/BayesSpamSniperBot?startgroup=true">添加到您的群组</a></li>
<li>给予机器人管理员权限（删除消息(delete message )，封禁用户权限(ban user )）</li>
</ul>
<p>完成这两步后，机器人不仅会自动开始工作，自动识别群内广告，然后删除文本消息，如果发送垃圾广告超过3次，将会被封禁；</p>
<p>还会随着社区的使用（通过 <code>/markspam</code> 和 <code>/feedspam</code> ），变得越来越智能</p>

<figure>
    
    
    <input type="checkbox" id="zoomCheck-28a2c" hidden>
    <label for="zoomCheck-28a2c">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/detect_spam_and_ban_user.jpg"/> 
    
    
    </label>
</figure>

<p>此机器人的设计理念就是最小化打扰管理员与用户，提供简单的操作命令，并最大可能地自动化，
所以本机器人只提供以下三个命令（支持&quot;/&ldquo;开头自动补全）:</p>

<figure>
    
    
    <input type="checkbox" id="zoomCheck-ecf1f" hidden>
    <label for="zoomCheck-ecf1f">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/command_auto_completion.jpg"/> 
    
    
    </label>
</figure>

<h4 id="markspam"><span class="section-num">6.1.1</span> <code>/markspam</code></h4>
<p>删除垃圾消息并封禁用户, 需要管理员权限。</p>
<p>在某条你想封禁的信息下回复 <code>/markspam</code>, 机器人就会自动把该条消息删除被封禁用户.</p>

<figure>
    
    
    <input type="checkbox" id="zoomCheck-14d59" hidden>
    <label for="zoomCheck-14d59">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/markspam_2.jpg"/> 
    
    
    </label>
</figure>

<p>(消息也被删除)
<img loading="lazy" src="/ox-hugo/markspam.jpg"></p>
<p>与常见的群管理机器人不同，这条命令不仅会删除垃圾消息并封禁用户, 因为这条消息还被管理员标记成垃圾广告，有非常高的置信度，所以系统就会以这条垃圾广告为训练数据，对模型进行实时更新。</p>
<p>下次类似的发言不仅会被识别，所有使用本机器人的群组都会受益，也会把类似的文本标记成垃圾广告</p>
<h4 id="listbanuser"><span class="section-num">6.1.2</span> <code>/listbanuser</code></h4>
<p>查看封禁账户列表, 需要管理员权限。</p>

<figure>
    
    
    <input type="checkbox" id="zoomCheck-7751e" hidden>
    <label for="zoomCheck-7751e">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/listbanuser.jpg"/> 
    
    
    </label>
</figure>

<p>查看已封禁的用户列表，并主动解封。</p>
<h4 id="listspam"><span class="section-num">6.1.3</span> <code>/listspam</code></h4>
<p>查看广告消息列表, 需要管理员权限。</p>

<figure>
    
    
    <input type="checkbox" id="zoomCheck-d0038" hidden>
    <label for="zoomCheck-d0038">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/listspam.jpg"/> 
    
    
    </label>
</figure>

<p>查看被标记为广告的消息列表，并可标记为正常。</p>
<h4 id="feedspam"><span class="section-num">6.1.4</span> <code>/feedspam</code></h4>
<p>投喂垃圾信息来训练，无任何权限要求，可私聊投喂或在群组内投喂.</p>

<figure>
    
    
    <input type="checkbox" id="zoomCheck-2a139" hidden>
    <label for="zoomCheck-2a139">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/feedspam.jpg"/> 
    
    
    </label>
</figure>


<figure>
    
    
    <input type="checkbox" id="zoomCheck-1fc12" hidden>
    <label for="zoomCheck-1fc12">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/feedspam2.jpg"/> 
    
    
    </label>
</figure>

<h2 id="eating-your-own-dog-food"><span class="section-num">7</span> Eating your own dog food</h2>
<p>在软件开发领域，有这么一句俗话，Eating your own dog food(吃你自己的狗粮)，大意是你自己的开发的东西，要自己先用起来。</p>
<p>因此我建了一个自己的频道：<a href="https://t.me/pipeapplebun">菠萝油与天光墟</a> <sup id="fnref:12"><a href="#fn:12" class="footnote-ref" role="doc-noteref">12</a></sup>用于测试，可惜订阅者寥寥，
就吸引不来太多的发垃圾广告的用户，所以欢迎大家订阅或者进来发广告，以吸引更多的发垃圾广告的用户。</p>
<p>在我这个频道，每个人都有自由发言的权利(美中不足只是次数受限)</p>
<p>既然没有人来我的频道发广告，苦于没有训练数据，我只能主动出击，赤膊上阵，割肉喂鹰去加了各种币圈群，黄色群，主动去看各种广告了：</p>

<figure>
    
    
    <input type="checkbox" id="zoomCheck-3779e" hidden>
    <label for="zoomCheck-3779e">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/telegram_group1.jpg"/> 
    
    
    </label>
</figure>


<figure>
    
    
    <input type="checkbox" id="zoomCheck-35262" hidden>
    <label for="zoomCheck-35262">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/telegram_group2.jpg"/> 
    
    
    </label>
</figure>


<figure>
    
    
    <input type="checkbox" id="zoomCheck-b0b9b" hidden>
    <label for="zoomCheck-b0b9b">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/spam_sample.jpg"/> 
    
    
    </label>
</figure>

<p>自从开发了这个机器人之后，我对广告的看法就变了，以前在别的群看到广告就烦，现在在别的群看到广告就很开心，
这都是宝贵的训练数据，要趁着还没被删，赶紧记录下来。</p>

<figure>
    
    
    <input type="checkbox" id="zoomCheck-511dc" hidden>
    <label for="zoomCheck-511dc">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/feedspam3.jpg"/> 
    
    
    </label>
</figure>

<h3 id="八仙过海的垃圾广告"><span class="section-num">7.1</span> 八仙过海的垃圾广告</h3>
<p>别人故事里的算法效果总是出奇的好，到自己实际运行的时候，总是发现会有这样那样的 case 没有覆盖，总有各种意外惊喜</p>
<p>许多在 Telegram 发广告的用户都是久经考验的反拦截器斗士了。</p>
<p>虽然关键词封禁效率不高，但是那些能让我们见到的广告说明已经是绕过关键词拦截的。</p>
<p>比如:</p>
<blockquote>
<p>在 币圈 想 赚 钱，那 你 不关 注 这 个 王 牌 社 区，真的太可惜了，真 心 推 荐，每 天 都 有 免 费 策 略</p></blockquote>
<p>又或者</p>
<blockquote>
<p>这人简-介挂的 合-约-报单群组挺牛的ETH500点，大饼5200点！ + @BTCETHl6666</p></blockquote>
<p>前者通过空格分隔来绕过关键词，后者通过添加标点符号来绕过关键词。</p>
<p>与英文等基于拉丁字母的语言天然通过空格分词不同，中文使用贝叶斯算法进行统计时，需要先进行分词</p>
<blockquote>
<p>the fox jumped over the lazy dog</p>
<p>我们的中文就不一样了</p></blockquote>
<p>「我们的中文就不一样了」就会被分词成「我们 | 的 | 中文 | 就 | 不 | 一样 | 了」, 然后才能对词频进行统计。</p>
<p>但是像广告 <code>在 币圈 想 赚 钱，那 你 不关 注 这 个 王 牌 社 区，真的太可惜了，真 心 推 荐，每 天 都 有 免 费 策 略</code> , 空格除了会影响关键字匹配，也会影响分词，这句话的分词结果就会变成:</p>
<p><code>在 | | 币圈 | | 想 | | 赚 | | 钱 | ， | 那 | | 你 | | 不 | 关 | | 注 | | 这 | | 个 | | 王 | | 牌 | | 社 | | 区 | ， | 真的 | 太 | 可惜 | 了 | ， | 真 | | 心 | | 推 | | 荐 | ， | 每 | | 天 | | 都 | | 有 | | 免 | | 费 | | 策 | | 略</code></p>
<p><code>这人简-介挂的 合-约-报单群组挺牛的ETH500点，大饼5200点！ + @BTCETHl6666</code> 也会被分词成：</p>
<p><code>这人简 | - | 介挂 | 的 | | 合 | - | 约 | - | 报单 | 群组 | 挺 | 牛 | 的 | ETH500 | 点 | ， | 大饼 | 5200 | 点 | ！ | | + | | @ | BTCETHl6666</code></p>
<p>未经处理的训练数据就会影响模型的结果，可见训练数据的质量也非常重要，因此我就对训练语料做了相应的预处理：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ruby" data-lang="ruby"><span class="line"><span class="cl"><span class="c1"># Step 1: 处理 anti-spam 分隔符</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 把中英文之间的非中英文及数字去掉，即 &#34;合-约&#34; -&gt; &#34;合约&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">previous</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">while</span> <span class="n">previous</span> <span class="o">!=</span> <span class="n">cleaned</span>
</span></span><span class="line"><span class="cl">  <span class="n">previous</span> <span class="o">=</span> <span class="n">cleaned</span><span class="o">.</span><span class="n">dup</span>
</span></span><span class="line"><span class="cl">  <span class="n">cleaned</span> <span class="o">=</span> <span class="n">cleaned</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/([一-龯A-Za-z0-9])[^一-龯A-Za-z0-9\s]+([一-龯A-Za-z0-9])/</span><span class="p">,</span> <span class="s1">&#39;\1\2&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Step 2: 处理中文字符 anti-spam 空格</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 处理 &#34;想 赚 钱&#34; -&gt; &#34;想赚钱&#34; case</span>
</span></span><span class="line"><span class="cl"><span class="n">previous</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">while</span> <span class="n">previous</span> <span class="o">!=</span> <span class="n">cleaned</span>
</span></span><span class="line"><span class="cl">  <span class="n">previous</span> <span class="o">=</span> <span class="n">cleaned</span><span class="o">.</span><span class="n">dup</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># 匹配中文汉字之间的一个或多个空格，然后删除掉</span>
</span></span><span class="line"><span class="cl">  <span class="n">cleaned</span> <span class="o">=</span> <span class="n">cleaned</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/([一-龯])(\s+)([一-龯])/</span><span class="p">,</span> <span class="s1">&#39;\1\3&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Step 3: 增加汉字与英文之间的空格</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 以及帮助分词算法如(jieba)更好地分词, e.g., &#34;社区ETH&#34; -&gt; &#34;社区 ETH&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">cleaned</span> <span class="o">=</span> <span class="n">cleaned</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/([一-龯])([A-Za-z0-9])/</span><span class="p">,</span> <span class="s1">&#39;\1 \2&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">cleaned</span> <span class="o">=</span> <span class="n">cleaned</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/([A-Za-z0-9])([一-龯])/</span><span class="p">,</span> <span class="s1">&#39;\1 \2&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Step 4: 删除多余的空格(多个空格缩减个一个)</span>
</span></span><span class="line"><span class="cl"><span class="n">cleaned</span> <span class="o">=</span> <span class="n">cleaned</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/\s+/</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>预处理之后， <code>在 币圈 想 赚 钱，那 你 不关 注 这 个 王 牌 社 区，真的太可惜了，真 心 推 荐，每 天 都 有 免 费 策 略</code> 就会变成 <code>在币圈想赚钱那你不关注这个王牌社区真的太可惜了真心推荐每天都有免费策略</code> (这里把合法的逗号也去掉了，我觉得相较过多标点符号对分词的影响，把标点去掉分词结果反而是能接受的), 分词结果是:</p>
<p><code>在 | 币圈 | 想 | 赚钱 | 那 | 你 | 不 | 关注 | 这个 | 王牌 | 社区 | 真的 | 太 | 可惜 | 了 | 真心 | 推荐 | 每天 | 都 | 有 | 免费 | 策略</code></p>
<p><code>这人简-介挂的 合-约-报单群组挺牛的ETH500点，大饼5200点！ + @BTCETHl6666</code> 就会变成 <code>这人简介挂的合约报单群组挺牛的 ETH500 点大饼 5200 点！ + @BTCETHl6666</code> ,分词结果是：</p>
<p><code>这 | 人 | 简介 | 挂 | 的 | 合约 | 报单 | 群组 | 挺 | 牛 | 的 | | ETH500 | | 点 | 大饼 | | 5200 | | 点 | ！ | | + | | @ | BTCETHl6666</code></p>
<h4 id="广告新花样"><span class="section-num">7.1.1</span> 广告新花样</h4>
<p>广告看多了，不得不感慨发广告的人的创造力。</p>
<p>因为在消息发垃圾广告会被广告拦截器拦截，他们创新性地玩出了新花样：</p>

<figure>
    
    
    <input type="checkbox" id="zoomCheck-fe0e1" hidden>
    <label for="zoomCheck-fe0e1">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/spam_by_username.jpg"/> 
    
    
    </label>
</figure>

<p>消息发的都是正常的文本，但是头像和用户名都是广告，这样广告拦截器就无法工作了，真的是太有创意了。</p>
<p>对手这么有创意，我也因地制宜地建立对用户名的训练模型，检测的时候消息文本的模型和用户名的模型都过一次，
只要有任何一个认为是垃圾广告，那就禁掉。</p>
<p>更进一步的可以对头像做OCR提取文本，再增加一个对头像的训练模型，不过OCR成本挺高的，就先不搞了。</p>
<h3 id="优化"><span class="section-num">7.2</span> 优化</h3>
<p>没有用户的话，做啥优化也没有必要，毕竟过早的优化是万恶之源，
因此我就把想法先做成原型，搞出来再说，但这不意味着这个原型没有优化的空间。</p>
<p>脑海中还是有不少优化的点的：</p>
<ol>
<li>jieba 分词的效果可能不是最好的，后续可以使用效果更好的分词器进行优化；或者是添加自己的词库。</li>
<li>每次有训练消息都进行重新训练，效率稍低，可以增加 batching 机制：有新消息时，等待5分钟或者等到100条消息再处理</li>
<li>现在整个模型都是在内存中计算，计算完就持久化成 DB, 可以在内存和数据库之间增加一层缓存来优化性能</li>
<li>贝叶斯算法可能效果不够好，换个复杂的机器学习模型</li>
</ol>
<p>但是这些优化点都算是 Good to have, 不是 Must have, 后面遇到实际问题再进行优化好了。</p>
<h2 id="实战效果"><span class="section-num">8</span> 实战效果</h2>
<p>使用变换之后的垃圾广告词进行发送:</p>

<figure>
    
    
    <input type="checkbox" id="zoomCheck-cdd9f" hidden>
    <label for="zoomCheck-cdd9f">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/spam_messge_2.jpg"/> 
    
    
    </label>
</figure>

<p>成功被检测出来，自动删除了:</p>

<figure>
    
    
    <input type="checkbox" id="zoomCheck-78c5f" hidden>
    <label for="zoomCheck-78c5f">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/deleted_spam.jpg"/> 
    
    
    </label>
</figure>

<p>有朋友可能会说，这只是卖家秀，为什么别人在我群里发的广告还是没有被识别？</p>
<p>因为贝叶斯算法本质是个概率算法，如果它没有见过类似的广告，那么它就没法判断是否垃圾广告 :(</p>
<p>稍安勿躁，你需要做只是使用 <code>/markspam</code> 删除消息并封禁用户，就可以帮助训练这个bot, 所有使用这个 bot 的用户都会因此受益</p>
<h2 id="结语"><span class="section-num">9</span> 结语</h2>
<p>我相当享受这种从发现问题、灵光一现，到构建原型，再到最终打磨出一个完整项目的创造过程。</p>
<p>虽然这完全是「用爱发电」——代码开源，还得自掏腰包租服务器，物质上毫无回报。</p>
<p>但每当看到机器人成功拦截广告的那一刻，那种创造的喜悦，就足以令我回味无穷。</p>
<ul>
<li>开源地址：<a href="https://github.com/ramsayleung/bayes_spam_sniper">https://github.com/ramsayleung/bayes_spam_sniper</a></li>
<li>立即体验：<a href="https://t.me/BayesSpamSniperBot">https://t.me/BayesSpamSniperBot</a></li>
<li>我的频道（菠萝油与天光墟）: <a href="https://t.me/pipeapplebun">https://t.me/pipeapplebun</a></li>
</ul>
<h3 id="推荐阅读">推荐阅读</h3>
<ul>
<li>旅加经历
<ul>
<li><a href="https://ramsayleung.github.io/zh/post/2023/%E8%BF%99%E4%BA%9B%E5%B9%B4%E8%B5%B0%E8%BF%87%E7%9A%84%E8%B7%AF_%E4%BB%8E%E5%B9%BF%E5%B7%9E%E5%88%B0%E6%B8%A9%E5%93%A5%E5%8D%8E/">这些年走过的路：从广州到温哥华</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2023/%E5%8A%A0%E6%8B%BF%E5%A4%A7%E4%B9%8B%E5%88%9D%E4%BD%93%E9%AA%8C/">加拿大之初体验</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2024/%E7%99%BB%E9%99%86%E5%8A%A0%E6%8B%BF%E5%A4%A7%E4%B8%80%E5%B9%B4%E7%9A%84%E4%BD%93%E4%BC%9A/">登陆加拿大一年后的体会</a></li>
</ul>
</li>
<li>工具流分享
<ul>
<li><a href="https://ramsayleung.github.io/zh/post/2024/%E7%AE%80%E6%98%8E%E5%86%99%E4%BD%9C%E6%8C%87%E5%8D%97/">简明写作指南</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2023/%E6%88%91%E7%9A%84%E5%86%99%E4%BD%9C%E6%B5%81/">我的写作流</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2023/%E6%88%91%E7%9A%84%E7%94%BB%E5%9B%BE%E6%B5%81/">我的画图流：画图工具与技巧分享</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2023/%E6%88%91%E7%9A%84%E6%90%9C%E7%B4%A2%E6%B5%81/">我的搜索流：高效搜索经验分享</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2022/feynman_technique/">最好的学习方式：费曼学习法(Feynman Technique)</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2021/%E7%B3%BB%E7%BB%9F%E6%80%9D%E8%80%83/">系统思考：既见树木，又见森林</a></li>
</ul>
</li>
<li>思考感悟
<ul>
<li><a href="https://ramsayleung.github.io/zh/post/2024/%E7%BC%96%E7%A8%8B%E5%8D%81%E5%B9%B4%E7%9A%84%E6%84%9F%E6%82%9F/">编程十年的感悟</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2023/%E4%BB%8E%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98%E7%A6%BB%E7%BA%BF_%E6%88%91%E5%B8%A6%E8%B5%B0%E4%BA%86%E4%BB%80%E4%B9%88/">那些年，我从微信支付学到的东西</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2025/%E6%9D%82%E8%B0%88ai%E5%8F%96%E4%BB%A3%E7%A8%8B%E5%BA%8F%E5%91%98/">杂谈ai取代程序员</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2023/%E7%BD%AE%E8%BA%AB%E4%BA%8B%E5%86%85/">为什么梦想买不起，故乡回不去</a></li>
</ul>
</li>
<li>软件工程
<ul>
<li><a href="https://ramsayleung.github.io/zh/post/2025/a_philosophy_of_software_design/">软件设计的哲学</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2025/structure_and_interpretation_of_computer_programs/">一本读了八年还没读完的书</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2024/%E6%B5%8B%E8%AF%95%E6%8A%80%E8%83%BD%E8%BF%9B%E9%98%B6%E4%B8%80_%E8%BD%AF%E4%BB%B6%E8%B4%A8%E9%87%8F%E8%AE%A4%E7%9F%A5/">测试技能进阶(一): 软件质量认知</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2024/%E6%B5%8B%E8%AF%95%E6%8A%80%E8%83%BD%E8%BF%9B%E9%98%B6%E4%BA%8C_parameterized_tests/">测试技能进阶(二): Parameterized Tests</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2024/%E6%B5%8B%E8%AF%95%E6%8A%80%E8%83%BD%E8%BF%9B%E9%98%B6%E4%B8%89_property_based_testing/">测试技能进阶(三): Property Based Testing</a></li>
</ul>
</li>
</ul>
<div class="qr-container" center>
<img src="/ox-hugo/qrcode_gh_e06d750e626f_1.jpg" alt="qrcode_gh_e06d750e626f_1.jpg" class="qr-container" width="160px" height="160px" center="t" />
公号同步更新，欢迎关注👻
</div>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p><a href="https://podcasts.apple.com/us/podcast/%E8%BD%AF%E4%BB%B6%E9%82%A3%E4%BA%9B%E4%BA%8B%E5%84%BF/id1147186605">https://podcasts.apple.com/us/podcast/%E8%BD%AF%E4%BB%B6%E9%82%A3%E4%BA%9B%E4%BA%8B%E5%84%BF/id1147186605</a>&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2">
<p><a href="https://liuyandong.com/sample-page">https://liuyandong.com/sample-page</a>&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:3">
<p><a href="https://t.me/huruanhuying">https://t.me/huruanhuying</a>&#160;<a href="#fnref:3" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:4">
<p><a href="https://t.me/kaedeharakazuha17">https://t.me/kaedeharakazuha17</a>&#160;<a href="#fnref:4" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:5">
<p><a href="https://paulgraham.com/spam.html">https://paulgraham.com/spam.html</a>&#160;<a href="#fnref:5" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:6">
<p><a href="https://www.youtube.com/watch?v=Pu675cHJ7bg">https://www.youtube.com/watch?v=Pu675cHJ7bg</a>&#160;<a href="#fnref:6" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:7">
<p><a href="https://www.youtube.com/watch?v=HZGCoVF3YvM">https://www.youtube.com/watch?v=HZGCoVF3YvM</a>&#160;<a href="#fnref:7" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:8">
<p><a href="https://gist.github.com/ramsayleung/5848af0177a70a01d41f624e361b1b5d">https://gist.github.com/ramsayleung/5848af0177a70a01d41f624e361b1b5d</a>&#160;<a href="#fnref:8" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:9">
<p><a href="https://ramsayleung.github.io/zh/post/2024/%E7%BC%96%E7%A8%8B%E5%8D%81%E5%B9%B4%E7%9A%84%E6%84%9F%E6%82%9F/">https://ramsayleung.github.io/zh/post/2024/%E7%BC%96%E7%A8%8B%E5%8D%81%E5%B9%B4%E7%9A%84%E6%84%9F%E6%82%9F/</a>&#160;<a href="#fnref:9" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:10">
<p><a href="https://ublockorigin.com/">https://ublockorigin.com/</a>&#160;<a href="#fnref:10" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:11">
<p><a href="https://ramsayleung.github.io/zh/post/2025/a_philosophy_of_software_design/">https://ramsayleung.github.io/zh/post/2025/a_philosophy_of_software_design/</a>&#160;<a href="#fnref:11" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:12">
<p><a href="https://t.me/pipeapplebun">https://t.me/pipeapplebun</a>&#160;<a href="#fnref:12" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>
]]></content:encoded>
    </item>
    <item>
      <title>一本读了八年还没读完的书</title>
      <link>https://ramsayleung.github.io/zh/post/2025/structure_and_interpretation_of_computer_programs/</link>
      <pubDate>Mon, 04 Aug 2025 10:00:00 -0700</pubDate>
      <guid>https://ramsayleung.github.io/zh/post/2025/structure_and_interpretation_of_computer_programs/</guid>
      <description>&lt;h2 id=&#34;缘起&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;1&lt;/span&gt; 缘起&lt;/h2&gt;
&lt;p&gt;正如我在之前博客文章《&lt;a href=&#34;https://ramsayleung.github.io/zh/post/2023/%E8%BF%99%E4%BA%9B%E5%B9%B4%E8%B5%B0%E8%BF%87%E7%9A%84%E8%B7%AF_%E4%BB%8E%E5%B9%BF%E5%B7%9E%E5%88%B0%E6%B8%A9%E5%93%A5%E5%8D%8E/&#34;&gt;这些年走过的路：从广州到温哥华&lt;/a&gt;》&lt;sup id=&#34;fnref:1&#34;&gt;&lt;a href=&#34;#fn:1&#34; class=&#34;footnote-ref&#34; role=&#34;doc-noteref&#34;&gt;1&lt;/a&gt;&lt;/sup&gt;提到的那样，我在大二暑假的时候因缘际会，获得了去一家在深圳的初创公司实习的 Offer。&lt;/p&gt;
&lt;p&gt;实习的两个多月时间也快就过去了，我也顺利拿到了 Return Offer，公司也非常有人情味地给实习生办了个欢送典礼。&lt;/p&gt;
&lt;p&gt;当时实习的导师，也是这家公司的副总裁，加州州立大学的&lt;a href=&#34;https://www.linkedin.com/in/yingliu37&#34;&gt;刘颖&lt;/a&gt;教授&lt;sup id=&#34;fnref:2&#34;&gt;&lt;a href=&#34;#fn:2&#34; class=&#34;footnote-ref&#34; role=&#34;doc-noteref&#34;&gt;2&lt;/a&gt;&lt;/sup&gt;，在欢送典礼上给我们几个实习生每人都赠送了一本书作为临别礼物。（可惜换了几次手机，已经找不回当初手捧着书的合照了）&lt;/p&gt;</description>
      <content:encoded><![CDATA[<h2 id="缘起"><span class="section-num">1</span> 缘起</h2>
<p>正如我在之前博客文章《<a href="https://ramsayleung.github.io/zh/post/2023/%E8%BF%99%E4%BA%9B%E5%B9%B4%E8%B5%B0%E8%BF%87%E7%9A%84%E8%B7%AF_%E4%BB%8E%E5%B9%BF%E5%B7%9E%E5%88%B0%E6%B8%A9%E5%93%A5%E5%8D%8E/">这些年走过的路：从广州到温哥华</a>》<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>提到的那样，我在大二暑假的时候因缘际会，获得了去一家在深圳的初创公司实习的 Offer。</p>
<p>实习的两个多月时间也快就过去了，我也顺利拿到了 Return Offer，公司也非常有人情味地给实习生办了个欢送典礼。</p>
<p>当时实习的导师，也是这家公司的副总裁，加州州立大学的<a href="https://www.linkedin.com/in/yingliu37">刘颖</a>教授<sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup>，在欢送典礼上给我们几个实习生每人都赠送了一本书作为临别礼物。（可惜换了几次手机，已经找不回当初手捧着书的合照了）</p>
<p>他说这是一本可以帮助我们了解程序本质，以及学习抽象的好书，这本书就叫《<a href="https://book.douban.com/subject/1148282/">计算机程序的构造和解释</a>》<sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup>（Structure and Interpretation of Computer Programs, 简称 SICP，下文使用 SICP 代称）</p>
<p>收到这本书时，我并未料到它会成为一场长达八年的拉锯战。</p>
<h2 id="好书不愉悦"><span class="section-num">2</span> 好书不愉悦</h2>
<p>我在2016年收到这本书，从2017年开始阅读，中间中断了好几次又重新拾起，而时至今日也只读了一半，即五个章节中的前三章。</p>
<p>翻看自己一直以来阅读这本书的日记，总有种看胡适先生一直在打牌的留学日记一样的感受：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-org" data-lang="org"><span class="line"><span class="cl"><span class="gu">**</span> DOING Read The Structure And Interpretation of Computer Programs
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   Read SICP everyday, at least 1 hour
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c">   :LOGBOOK:
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="cs">   CLOCK: [2017-04-03 Mon 20:26]--[2017-04-03 Mon 21:25] =&gt;  0:59
</span></span></span><span class="line"><span class="cl"><span class="cs">   CLOCK: [2017-03-14 Tue 23:15]--[2017-03-14 Tue 23:40] =&gt;  0:25
</span></span></span><span class="line"><span class="cl"><span class="cs">   CLOCK: [2017-03-14 Tue 22:45]--[2017-03-14 Tue 23:10] =&gt;  0:25
</span></span></span><span class="line"><span class="cl"><span class="cs">   CLOCK: [2017-03-12 Sun 15:46]--[2017-03-12 Sun 16:11] =&gt;  0:25
</span></span></span><span class="line"><span class="cl"><span class="cs">   CLOCK: [2017-03-12 Sun 15:13]--[2017-03-12 Sun 15:38] =&gt;  0:25
</span></span></span><span class="line"><span class="cl"><span class="cs"></span><span class="c">   :END:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   &lt;<span class="s">2022-10-08 Sat</span>&gt;
</span></span><span class="line"><span class="cl"><span class="c">   #+begin_comment
</span></span></span><span class="line"><span class="cl"><span class="c">   读了6年了，还是没有读完，重新开始读
</span></span></span><span class="line"><span class="cl"><span class="c">   #+end_comment</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   &lt;<span class="s">2025-05-25 Sun</span>&gt;
</span></span><span class="line"><span class="cl">   读了8年，还是没有读完，又开始读
</span></span></code></pre></td></tr></table>
</div>
</div><p>看到这里，可能没有读过 SICP 可能会奇怪，为什么读一本书要这么久，如果蜻蜓点水，水过鸭背那样子读完一本书，自然只需要不停地翻页即可。</p>
<p>而 SICP 为了帮助你掌控书中讲解的知识和要点，会有大量的习题，并且把非常多额外的知识点都嵌入到习题中，以练带学。</p>
<p>就数量而言，章节一有46道习题，章节二有97道习题，章节三有82道习题。
如果跳过这些习题，这本书的内容不仅少了一半，而且也失去其精髓，可谓是买椟还珠。</p>
<p>此外，习题不仅数量多，还有相当难度，我每天花一到两个小时阅读，只能完成1-2道习题。</p>
<p>习题完成情况:</p>
<ul>
<li>章节一: 43/46</li>
<li>章节二: 88/97</li>
<li>章节三: 72/82</li>
<li>章节四: TODO</li>
<li>章节五: TODO</li>
</ul>
<p>我把所有的题解都放到了 GitHub 项目: <a href="https://github.com/ramsayleung/sicp_solution">https://github.com/ramsayleung/sicp_solution</a>, 并为大部分的题解都配套了单元测试，以验证其正确性，还加上了 GitHub Action 作 CI.</p>
<p>经年累月，我的题解代码和笔记都接近一万行了，这也能侧面说明我为什么读得这么慢了：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">&gt; tokei .
</span></span><span class="line"><span class="cl"><span class="o">===============================================================================</span>
</span></span><span class="line"><span class="cl">Language            Files        Lines         Code     Comments       <span class="nv">Blanks</span>
</span></span><span class="line"><span class="cl"><span class="o">===============================================================================</span>
</span></span><span class="line"><span class="cl">Markdown                <span class="m">1</span>           <span class="m">65</span>            <span class="m">0</span>           <span class="m">46</span>           <span class="m">19</span>
</span></span><span class="line"><span class="cl">Org                    <span class="m">70</span>         <span class="m">2757</span>         <span class="m">2163</span>            <span class="m">0</span>          <span class="m">594</span>
</span></span><span class="line"><span class="cl">Racket                 <span class="m">71</span>         <span class="m">3976</span>         <span class="m">3086</span>          <span class="m">256</span>          <span class="m">634</span>
</span></span><span class="line"><span class="cl">Scheme                 <span class="m">77</span>         <span class="m">2479</span>         <span class="m">1898</span>          <span class="m">110</span>          <span class="nv">471</span>
</span></span><span class="line"><span class="cl"><span class="o">===============================================================================</span>
</span></span><span class="line"><span class="cl">Total                 <span class="m">219</span>         <span class="m">9277</span>         <span class="m">7147</span>          <span class="m">412</span>         <span class="nv">1718</span>
</span></span><span class="line"><span class="cl"><span class="o">===============================================================================</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>毕竟大部分真正让人进步的阅读，读起来都不是愉悦的：</p>
<blockquote>
<p>世之奇伟、瑰怪、非常之观，常在于险远，而人之所罕至焉，故非有志者不能至也。</p>
<p>&mdash;-王安石《游褒禅山记》</p></blockquote>
<h2 id="主旨"><span class="section-num">3</span> 主旨</h2>
<p>如果笼统地概括整本书，“无非”是「抽象」，通过使用一门非常简单的语言 <code>Scheme</code>, 以及几个非常简单的操作 <code>cons(构造一个序对)</code>, <code>car(取出序对的第一个值)</code>, <code>cdr(取出序对的第二个值)</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-scheme" data-lang="scheme"><span class="line"><span class="cl"><span class="nv">&gt;</span> <span class="p">(</span><span class="nb">cons </span><span class="mi">1</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">&#39;</span><span class="p">(</span><span class="mi">1</span> <span class="o">.</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nv">&gt;</span> <span class="p">(</span><span class="nb">car </span><span class="p">(</span><span class="nb">cons </span><span class="mi">1</span> <span class="mi">2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="nv">&gt;</span> <span class="p">(</span><span class="nb">cdr </span><span class="p">(</span><span class="nb">cons </span><span class="mi">1</span> <span class="mi">2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="mi">2</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>构造出各种数据结构，如链表，队列，哈希表以及更复杂的组合数据结构; 探寻各种概念，如递归，闭包，高阶函数，赋值，流，程序优化等；</p>
<p>而后两章更进一步，第四章介绍如何实现一个 Scheme 简单的解释器，一个简单的 Prolog 解释器；而第五章介绍计算机体系结构的 CPU 设计，编译器，垃圾回收等。</p>
<p>从括号中的几个简单函数，到最后造出整个计算机体系，有种《道德经》里道生万物的感觉：</p>
<blockquote>
<p>道生一，一生二，二生三，三生万物。</p></blockquote>
<h2 id="计算机科学与工程"><span class="section-num">4</span> 计算机科学与工程</h2>
<p>我本科专业读的是软件工程(Software Engineering )，翻看当初的专业培养计划，从计算机导论开始入门，到程序设计基础，面向对象程序设计基础，数据结构，操作系统，计算机组成原理，再到计算机网络，汇编与编译原理，数据库原理到软件工程等。</p>
<p>学习完这些课程，可以成为一个合格的软件工程师，但广义的计算机专业还有一门专业，叫计算机科学(Computer Science)，我一直很疑惑两者之间的差别是什么，就我所见过的不同学校的培养计划里面，两者的课程都非常相似。</p>
<p>而在阅读这本1984年麻省理工就出版的计算机科学的教材时，我找到了我想要的答案。</p>
<p>最初的计算机科学是数学，电子工程和软件设计的交叉学科，计算机科学的学生需要兼备这三者的专业知识。</p>
<p>而三位作者也是高屋建瓴，在数学，电子工程和软件领域旁征博引，各种知识信手拈来，
如练习3.59关于微积分的内容，通过流来处理幂等数积分，练习3.60-3.62都是关于积分的内容。</p>
<p>如3.5章里面，通过流来描述信号处理系统中的「信号」，
练习3.73用程序的流(stream)来表示电流或者电压在时间序列上的值，用以模拟电子线路。</p>
<p>如 3.3章里面，通过程序来建立数字电路的反门，与门，或门，再通过这样的电子元件建立起半加器，
再通过多个半加器实现全加器，实现二进制的加法，从程序到模拟电路，再用模拟电路来构造计算机的处理器。</p>
<p>不同学科的知识在一本书中融会贯通，再配合这个 <code>eval-apply</code> 表达式的配图，总有一种太极的感觉，难免让我有种读计算机哲学书的感觉:</p>

<figure>
    
    
    <input type="checkbox" id="zoomCheck-28ab8" hidden>
    <label for="zoomCheck-28ab8">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/apply_eval.jpg"/> 
    
    
    </label>
</figure>

<h2 id="优美的括号"><span class="section-num">5</span> 优美的括号</h2>
<p>书中那些非常有趣或者优美的代码</p>
<h3 id="图形构造-从点到面的抽象"><span class="section-num">5.1</span> 图形构造：从点到面的抽象</h3>
<p>第二章介绍了复合的数据结构时，就提到了如何去画图，先画点，再画线，然后要求完成习题连线成面，构造出图形。</p>

<figure>
    
    
    <input type="checkbox" id="zoomCheck-91228" hidden>
    <label for="zoomCheck-91228">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/exercise-2-52-wave.png"/> 
    
    
    </label>
</figure>

<p>新的习题再要求通过变换，组合图形，构造新的复杂图形:</p>

<figure>
    
    
    <input type="checkbox" id="zoomCheck-f815c" hidden>
    <label for="zoomCheck-f815c">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/wave-square-limit.png"/> 
    
    
    </label>
</figure>

<p>最后把类似的变换应用到图片上:</p>

<figure>
    
    
    <input type="checkbox" id="zoomCheck-93de8" hidden>
    <label for="zoomCheck-93de8">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/square-limit-einstein.png"/> 
    
    
    </label>
</figure>

<h3 id="蒙特卡罗模拟来计算-π"><span class="section-num">5.2</span> 蒙特卡罗模拟来计算 π</h3>
<p>所谓的蒙特卡罗模拟（Monte Carlo Simulation）是一种通过随机采样和统计计算来求解的数值方法，通过大量随机实验模拟不确定性，从而估算复杂系统的可能结果。</p>
<p>用人话来说就是不断地试，在试错的过程中逼近确定解，试的次数越多，结果越准确。</p>
<p>书中就介绍了一种通过蒙特卡罗模拟来计算 π 的方法, 就像通过随机撒豆子估算圆的面积，概率统计将抽象的π转化为可计算的实验：</p>
<blockquote>
<p>举例来说，6/π^2 是随机选取的两个整数之间没有公因子（也就是说，它们的最大公因子是1）的概率。我们可以利用这一事实做出π的近似值。</p></blockquote>
<p>完全读不懂这段话，没理解是怎么可以算出π的近似值的。</p>
<p>查阅资料后得知:</p>
<p>随机选取两个正整数，它们互质（即最大公约数GCD为1）的概率是 \(\frac{6}{\pi^2}\) , 所谓的 互质指两个数没有公共因子（如8和15互质，但8和12不互质，因为公约数为4）。</p>
<p>这一结论源自数论中的经典定理（涉及黎曼ζ函数），我们只需利用其概率公式反推π即可。</p>
<p>而用蒙特卡罗模拟步骤来计算 \({\pi}\):</p>
<p>随机实验：重复多次随机选取两个整数，检查它们的GCD是否为1。</p>
<p>例如：</p>
<ul>
<li>(3, 5) → GCD=1（计数+1）</li>
<li>(4, 6) → GCD=2（不计数）</li>
</ul>
<p>统计概率：</p>
<p>若总实验次数为 N，其中 k 次GCD=1，则互质概率的估计值为 \(\frac{k}{N}\)</p>
<p>关联π：</p>
<p>根据数论结论 \(\frac{k}{N} \approx \frac{6}{\pi^2}\)，解得 \(\pi \approx \sqrt{\frac{6N}{k}}\)。</p>
<p>当直接计算π困难时，可通过概率实验间接逼近。</p>
<p>这里利用了数论中的概率规律，将π与随机事件联系起来。(高等数学对于我来说已是雪泥鸿爪，更遑论数论的知识了)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-racket" data-lang="racket"><span class="line"><span class="cl"><span class="kn">#lang </span><span class="nn">racket</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="n">estimate-pi</span> <span class="n">trials</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">sqrt</span> <span class="p">(</span><span class="nb">/</span> <span class="mi">6</span> <span class="p">(</span><span class="n">monte-carlo</span> <span class="n">trials</span> <span class="n">cesaro-test</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="n">cesaro-test</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">=</span> <span class="p">(</span><span class="nb">gcd</span> <span class="p">(</span><span class="n">rand</span><span class="p">)</span> <span class="p">(</span><span class="n">rand</span><span class="p">))</span> <span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="n">monte-carlo</span> <span class="n">trials</span> <span class="n">experiment</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="n">iter</span> <span class="n">trials-remaining</span> <span class="n">trial-passed</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="k">cond</span> <span class="p">((</span><span class="nb">=</span> <span class="n">trials-remaining</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">           <span class="p">(</span><span class="nb">/</span> <span class="n">trials-passed</span> <span class="n">trials</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">          <span class="p">((</span><span class="n">experiment</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">           <span class="p">(</span><span class="n">iter</span> <span class="p">(</span><span class="nb">-</span> <span class="n">trials-remaining</span> <span class="mi">1</span><span class="p">)</span> <span class="p">(</span><span class="nb">+</span> <span class="n">trials-passed</span> <span class="mi">1</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="k">else</span>
</span></span><span class="line"><span class="cl">           <span class="p">(</span><span class="n">iter</span> <span class="p">(</span><span class="nb">-</span> <span class="n">trials-remaining</span> <span class="mi">1</span><span class="p">)</span> <span class="n">trials-passed</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="n">iter</span> <span class="n">trials</span> <span class="mi">0</span><span class="p">))</span><span class="err">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>这里的蒙特卡罗实现真的是优雅，它将数学理论（互质概率）转化为寥寥数行的递归实验。</p>
<p>而基于流的实现更是优美:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-scheme" data-lang="scheme"><span class="line"><span class="cl"><span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">monte-carlo</span> <span class="nv">experiment-stream</span> <span class="nv">passed</span> <span class="nv">failed</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">next</span> <span class="nv">passed</span> <span class="nv">failed</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nf">cons-stream</span>
</span></span><span class="line"><span class="cl">     <span class="p">(</span><span class="nb">/ </span><span class="nv">passed</span> <span class="p">(</span><span class="nb">+ </span><span class="nv">passed</span> <span class="nv">failed</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">     <span class="p">(</span><span class="nf">monte-carlo</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nf">stream-cdr</span> <span class="nv">experiment-stream</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="nv">passed</span>
</span></span><span class="line"><span class="cl">      <span class="nv">failed</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nf">stream-car</span> <span class="nv">experiment-stream</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nf">next</span> <span class="p">(</span><span class="nb">+ </span><span class="nv">passed</span> <span class="mi">1</span><span class="p">)</span> <span class="nv">failed</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nf">next</span> <span class="nv">passed</span> <span class="p">(</span><span class="nb">+ </span><span class="nv">failed</span> <span class="mi">1</span><span class="p">))))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="尾声-括号里的计算机哲学"><span class="section-num">6</span> 尾声：括号里的计算机哲学</h2>
<p>直到今天，我也只读完前三章。有时我会问自己：这本书究竟给了我什么？</p>
<p>它没有教我实用的编程技巧，也无关面试刷题。</p>
<p>但是我好像又抓住了一些东西，尤如用手拢过一团烟雾，张开手，并未见留下什么，但是手上还残留着它的气味。</p>
<p>如今，MIT 的课程已用 Python 替代 Scheme，但 SICP 的价值从未褪色。</p>
<p>SICP 不是一本教你「如何编程」的书，而是一把钥匙，是一座桥，连接着工程的实用与科学的纯粹。</p>
<p>那些括号中的表达式，最终在我脑中化成了某种朦胧却持久的气味：</p>
<p><strong><strong>一种对抽象本质的直觉</strong></strong></p>
<h3 id="推荐阅读">推荐阅读</h3>
<ul>
<li>旅加经历
<ul>
<li><a href="https://ramsayleung.github.io/zh/post/2023/%E8%BF%99%E4%BA%9B%E5%B9%B4%E8%B5%B0%E8%BF%87%E7%9A%84%E8%B7%AF_%E4%BB%8E%E5%B9%BF%E5%B7%9E%E5%88%B0%E6%B8%A9%E5%93%A5%E5%8D%8E/">这些年走过的路：从广州到温哥华</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2023/%E5%8A%A0%E6%8B%BF%E5%A4%A7%E4%B9%8B%E5%88%9D%E4%BD%93%E9%AA%8C/">加拿大之初体验</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2024/%E7%99%BB%E9%99%86%E5%8A%A0%E6%8B%BF%E5%A4%A7%E4%B8%80%E5%B9%B4%E7%9A%84%E4%BD%93%E4%BC%9A/">登陆加拿大一年后的体会</a></li>
</ul>
</li>
<li>工具流分享
<ul>
<li><a href="https://ramsayleung.github.io/zh/post/2024/%E7%AE%80%E6%98%8E%E5%86%99%E4%BD%9C%E6%8C%87%E5%8D%97/">简明写作指南</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2023/%E6%88%91%E7%9A%84%E5%86%99%E4%BD%9C%E6%B5%81/">我的写作流</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2023/%E6%88%91%E7%9A%84%E7%94%BB%E5%9B%BE%E6%B5%81/">我的画图流：画图工具与技巧分享</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2023/%E6%88%91%E7%9A%84%E6%90%9C%E7%B4%A2%E6%B5%81/">我的搜索流：高效搜索经验分享</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2022/feynman_technique/">最好的学习方式：费曼学习法(Feynman Technique)</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2021/%E7%B3%BB%E7%BB%9F%E6%80%9D%E8%80%83/">系统思考：既见树木，又见森林</a></li>
</ul>
</li>
<li>思考感悟
<ul>
<li><a href="https://ramsayleung.github.io/zh/post/2024/%E7%BC%96%E7%A8%8B%E5%8D%81%E5%B9%B4%E7%9A%84%E6%84%9F%E6%82%9F/">编程十年的感悟</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2023/%E4%BB%8E%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98%E7%A6%BB%E7%BA%BF_%E6%88%91%E5%B8%A6%E8%B5%B0%E4%BA%86%E4%BB%80%E4%B9%88/">那些年，我从微信支付学到的东西</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2025/%E6%9D%82%E8%B0%88ai%E5%8F%96%E4%BB%A3%E7%A8%8B%E5%BA%8F%E5%91%98/">杂谈ai取代程序员</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2023/%E7%BD%AE%E8%BA%AB%E4%BA%8B%E5%86%85/">为什么梦想买不起，故乡回不去</a></li>
</ul>
</li>
<li>软件工程
<ul>
<li><a href="https://ramsayleung.github.io/zh/post/2025/a_philosophy_of_software_design/">软件设计的哲学</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2024/%E6%B5%8B%E8%AF%95%E6%8A%80%E8%83%BD%E8%BF%9B%E9%98%B6%E4%B8%80_%E8%BD%AF%E4%BB%B6%E8%B4%A8%E9%87%8F%E8%AE%A4%E7%9F%A5/">测试技能进阶(一): 软件质量认知</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2024/%E6%B5%8B%E8%AF%95%E6%8A%80%E8%83%BD%E8%BF%9B%E9%98%B6%E4%BA%8C_parameterized_tests/">测试技能进阶(二): Parameterized Tests</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2024/%E6%B5%8B%E8%AF%95%E6%8A%80%E8%83%BD%E8%BF%9B%E9%98%B6%E4%B8%89_property_based_testing/">测试技能进阶(三): Property Based Testing</a></li>
</ul>
</li>
</ul>
<div class="qr-container" center>
<img src="/ox-hugo/qrcode_gh_e06d750e626f_1.jpg" alt="qrcode_gh_e06d750e626f_1.jpg" class="qr-container" width="160px" height="160px" center="t" />
公号同步更新，欢迎关注👻
</div>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p><a href="https://ramsayleung.github.io/zh/post/2023/%E8%BF%99%E4%BA%9B%E5%B9%B4%E8%B5%B0%E8%BF%87%E7%9A%84%E8%B7%AF_%E4%BB%8E%E5%B9%BF%E5%B7%9E%E5%88%B0%E6%B8%A9%E5%93%A5%E5%8D%8E/">https://ramsayleung.github.io/zh/post/2023/%E8%BF%99%E4%BA%9B%E5%B9%B4%E8%B5%B0%E8%BF%87%E7%9A%84%E8%B7%AF_%E4%BB%8E%E5%B9%BF%E5%B7%9E%E5%88%B0%E6%B8%A9%E5%93%A5%E5%8D%8E/</a>&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2">
<p><a href="https://www.linkedin.com/in/yingliu37">https://www.linkedin.com/in/yingliu37</a>&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:3">
<p><a href="https://book.douban.com/subject/1148282/">https://book.douban.com/subject/1148282/</a>&#160;<a href="#fnref:3" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>
]]></content:encoded>
    </item>
    <item>
      <title>从在加拿大退货失败的一件小事思考系统设计</title>
      <link>https://ramsayleung.github.io/zh/post/2025/%E4%BB%8E%E5%9C%A8%E5%8A%A0%E6%8B%BF%E5%A4%A7%E9%80%80%E8%B4%A7%E5%A4%B1%E8%B4%A5%E7%9A%84%E4%B8%80%E4%BB%B6%E5%B0%8F%E4%BA%8B%E6%80%9D%E8%80%83%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/</link>
      <pubDate>Sat, 31 May 2025 11:00:00 -0700</pubDate>
      <guid>https://ramsayleung.github.io/zh/post/2025/%E4%BB%8E%E5%9C%A8%E5%8A%A0%E6%8B%BF%E5%A4%A7%E9%80%80%E8%B4%A7%E5%A4%B1%E8%B4%A5%E7%9A%84%E4%B8%80%E4%BB%B6%E5%B0%8F%E4%BA%8B%E6%80%9D%E8%80%83%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/</guid>
      <description>&lt;h2 id=&#34;前言&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;1&lt;/span&gt; 前言&lt;/h2&gt;
&lt;p&gt;前天刚写完《&lt;a href=&#34;https://ramsayleung.github.io/zh/post/2025/a_philosophy_of_software_design/&#34;&gt;软件设计的哲学&lt;/a&gt;》，满脑子还萦绕着模块耦合和接口抽象，
结果昨天就撞上一个现实中的“设计陷阱”——一次耗时数小时却无解的「退货」噩梦。&lt;/p&gt;
&lt;p&gt;今天趁着周末，决定把这场荒诞遭遇拆解出来，既当吐槽，也当案例分析.&lt;/p&gt;</description>
      <content:encoded><![CDATA[<h2 id="前言"><span class="section-num">1</span> 前言</h2>
<p>前天刚写完《<a href="https://ramsayleung.github.io/zh/post/2025/a_philosophy_of_software_design/">软件设计的哲学</a>》，满脑子还萦绕着模块耦合和接口抽象，
结果昨天就撞上一个现实中的“设计陷阱”——一次耗时数小时却无解的「退货」噩梦。</p>
<p>今天趁着周末，决定把这场荒诞遭遇拆解出来，既当吐槽，也当案例分析.</p>
<h2 id="来龙去脉"><span class="section-num">2</span> 来龙去脉</h2>
<p>前段时间搬了家，自然就需要重新办理宽带，一直用的是 <a href="https://www.telus.com/">Telus</a> 家的家庭宽带服务，他们家的宽带服务也支持从一个住址迁移到另外一个住址, 就预约了 Telus 技术人员上门安装。</p>
<p>技术人员上门安装完宽带之后，就需要测试一下 WI-FI 能否正常使用，就问我们的路由器在哪，他接上处理一下。</p>
<p>问题就来了：</p>
<p>我们的路由器之前是舍友设置的，还不是常见的一体路由器，而是分体式路由器，有三个不同的组件。</p>
<p>而舍友在搬完家后就回国休假了，我还真不知道怎么搞这路由器，各个接口尝试了小半个小时也没反应，师傅也没见识过，自然也不晓得弄。</p>
<p>这个又是一个非常经典的软件开发问题：</p>
<p>「在我的机器上能跑，换个环境就挂了」</p>
<p>但是一直没网也不是办法，然后师傅建议我可以把他随身带的 Telus 路由器买下来，等我舍友回来后把网络设置好，再把路由器还回来，Telus支持30天无理由退货。</p>
<p>听起来也只能这么搞了。</p>
<p>舍友休了几周假回来之后，几分钟不到，很快就把这个路由器就设置起来了:</p>

<figure>
    
    
    <input type="checkbox" id="zoomCheck-1ade0" hidden>
    <label for="zoomCheck-1ade0">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/mesh_router.jpg"/> 
    
    
    </label>
</figure>

<p>剩下的就是把路由器还给 Telus, 已经过了几周，30天的免责退货时间所剩不多了。</p>
<h2 id="退货流程"><span class="section-num">3</span> 退货流程</h2>
<p>因为设备不是通过网购买的，没法直接在网上退单，也不是门店买的，无法直接拿去门店退，退货的流程是打电话给 Telus 的客服，问他们要退货指引。</p>
<p>我就给 Telus 的客服打电话，解释清楚情况后，客服说给我账户对应的邮箱发个邮件，里面有指引和退货码，我需要去 Canada Post（加拿大邮政）把路由器寄回去。</p>
<p>电话里客服说已经给我发邮件了，但是我说没有收到（此处为后面埋下伏笔），于是我提供另外一个邮箱，成功收到了。</p>

<figure>
    
    
    <input type="checkbox" id="zoomCheck-77eeb" hidden>
    <label for="zoomCheck-77eeb">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/telus_return_equipment_instruction.jpg"/> 
    
    
    </label>
</figure>

<p>因为 Canada Post 最近在为涨薪闹罢工，客服提到我需要去另外一家快递公司 Purolator 寄快递。</p>
<p>剩下要做就是把路由器打包，然后寄出来(这么容易就好了), 再把快递单号告知 Telus, 退货流程就算结束了。</p>
<h2 id="坑来了"><span class="section-num">4</span> 坑来了</h2>
<h3 id="邮政罢工"><span class="section-num">4.1</span> 邮政罢工</h3>
<p>因为加拿大邮政罢工，所以只能去 Purolator 寄，但是去到 Purolator后，人家反馈:</p>
<blockquote>
<p>你这个退货码是给加拿大邮政的，我们不认哦，你要给个我们家的退货码。</p></blockquote>
<p>我只能去再打电话给 Telus 客服要退货码，花费了15分钟，终于打通了，解释完一番之后，他们说给我的邮箱发了新的 Puralator 退货码，我等了一分钟，说没有收到，然后让给我另外的一个邮箱也发一次指引，还是没有收到，然后客服说邮件会在24-48小时内到达..</p>
<p>但挂电话后再等了一个小时还是没有收到.</p>
<h3 id="邮箱收不到email"><span class="section-num">4.2</span> 邮箱收不到email</h3>
<p>只能再打电话给 Telus 的客服，又等了10几分钟终于接通了，这次换了个客服，这位客服说我们不支持 Purolator，你可以等加拿大邮政罢工结束之后再寄。</p>
<p>我也很无语，怎么你们的回复还不一致的，就和客服说，我怎么知道罢工什么时候结束呢，30天马上就要到了嘛。</p>
<p>客服说，的确很有道理，这样吧，你可以去尝试使用用加拿大邮政寄下，然后我把情况记录一下，到时超过30天也可以免责退款。</p>
<p>然后我追问到，那罢工结束时退货也是用相同的退货码么？这个退货码有过期时间么？邮件没写哦。</p>
<p>客服说，那以防万一，我再给你邮箱发个新的退货码吧。</p>
<p>我着实是怕了，不知道为什么一直没有收到邮件，就让客服把我账号对应的邮箱地址读出来, 客服就把我邮箱的逐个地址读出来。</p>
<p>前面部分听着没问题嘛，我还在寻思是什么问题，只是听着听着，怎么我邮箱还有我不认识的部分，就打开 Telus 的APP 修改, 然后被气得差点要吐血了:</p>

<figure>
    
    
    <input type="checkbox" id="zoomCheck-53734" hidden>
    <label for="zoomCheck-53734">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/telus_email_address.jpg"/> 
    
    
    </label>
</figure>

<p>我的邮箱地址是 <code>ramsayleung@gmail.com</code>, 然后为了标记不同的公司，我用了<a href="https://ramsayleung.github.io/zh/post/2023/gmail%E5%9C%B0%E5%9D%80%E7%9A%84%E9%9A%90%E8%97%8F%E6%8A%80%E5%B7%A7/">《两个鲜为人知的Gmail地址技巧》</a> 提到的加号技巧来注册 Telus 账号:</p>
<p><code>ramsayleung+telus@gmail.com</code></p>
<p>之前用了一年多还是好好的，不然我也无法注册和验证邮箱成功。</p>
<p>但是现在 Telus 作了变更，直接把邮箱地址中的加号去掉了，变成了 <code>ramsayleungtelus@gmail.com</code>, 变成一个完全不同的邮箱, 肯定是不可能收到邮件的。</p>
<p>花费了近一下午，打了5-6次电话，和不同的客服沟通和练习口语，最后的结果就是隔天再去加拿大邮政试试，不行就等他们罢工结束再寄。</p>
<h2 id="糟糕设计的代价"><span class="section-num">5</span> 糟糕设计的代价</h2>
<p>这次经历虽然令人沮丧，但也印证了软件工程的一条铁律：</p>
<p><strong><strong>糟糕的设计最终会让所有人付出代价——无论是用户还是开发者。</strong></strong></p>
<p>讽刺的是，人们总希望通过「学习别人的错误」来避免踩坑，但现实中，我们往往被迫为别人的设计缺陷买单。</p>
<h3 id="单点故障与-happy-path-陷阱"><span class="section-num">5.1</span> 单点故障与「Happy Path」陷阱</h3>
<p>电话退货这个操作虽然看似落后，但是总体来说还是可以用的，在不出问题的前提下。</p>
<p>Telus 的退货流程设计暴露了一个典型的系统脆弱性：</p>
<p><strong><strong>强依赖单一服务提供商（Canada Post）</strong></strong> ，且未设计降级方案（如备用物流或线下门店退货）。</p>
<p>这种「Happy Path Only」的思维，本质上是对分布式系统设计原则的违背：</p>
<p><strong><strong>任何外部服务都可能失败，而系统必须对此容错。</strong></strong></p>
<p>让快递直接成为业务系统的「单点」故障，只考虑 Happy Path, 没有考虑异常场景，甚至发过来的退货邮件指引，都可以看出他们是把 <strong><strong>Canada Post</strong></strong> 写死在邮件。</p>
<h3 id="向后兼容性-一个被忽视的底线"><span class="section-num">5.2</span> 向后兼容性：一个被忽视的底线</h3>
<p>退货强依赖加拿大邮政这个还可以说成是产品设计的问题，但是直接把我邮箱地址给改掉这个，就一定是程序员的锅了。</p>
<p>此外，我的邮箱地址在 APP 中显示的是 <code>ramsayleung@gmail.com</code>, 只有在修改邮箱地址的时候，才会显示出 <code>ramsayleungtelus@gmail.com</code> 这也是我一直没有发现的原因。</p>
<p>但最令人匪夷所思的是邮箱地址的非兼容性变更：系统直接静默移除了存量用户邮箱中的加号:</p>
<p><code>ramsayleung+telus@gmail.com</code> -&gt; <code>ramsayleungtelus@gmail.com</code> ，导致邮件发送失败。</p>
<p>这种粗暴的修改方式违反了最基本的向后兼容性原则，而问题的暴露方式（APP显示与修改界面不一致）进一步说明：</p>
<p>其系统内部还存在的数据状态不一致性问题</p>
<p>合理的变更方式应该是：</p>
<ol>
<li>增量控制：
<ul>
<li>禁止新用户注册或修改时使用特殊符号，但保留存量数据, 保证增量用户地址正确</li>
<li>存量用户修改邮箱地址时，禁止使用带特殊符号的邮箱地址</li>
</ul>
</li>
<li>存量迁移：
<ul>
<li>通过离线数仓，查询出所有带特殊符号的邮箱地址，通过异步任务批量通知受影响用户（避免阻塞主流程）</li>
<li>提供自动清理特殊符号的“一键修复”功能（需用户确认）。</li>
</ul>
</li>
<li>监控兜底：
<ul>
<li>建立异常邮箱地址的监控或者报表，直到存量问题归零。</li>
</ul>
</li>
</ol>
<p>虽然这做法非常繁琐，但是却可以保证系统升级绝对不影响用户。</p>
<p>系统设计与维护就是如此：开始做的时候成本很低，越到后期成本越高。</p>
<h2 id="个人感悟"><span class="section-num">6</span> 个人感悟</h2>
<p>除去别人的设计错误之外，我还有些额外的个人感悟:</p>
<p>虽然 Gmail 支持邮箱地址中增加一个 <code>+</code> 这样的功能，但是并不是所有的公司都支持这特性的，重要的邮件还是不能使用这个「奇技淫巧」。</p>
<p>此外，我另外提供的邮箱也无法收到邮件，可能是我的邮箱太长了，导致客服没有拼对我的邮箱，所以最好还是准备一个短的，包含数字的备用邮箱地址，方便电话沟通时提供给对方。</p>
<p>整个故事再次印证了《<a href="https://ramsayleung.github.io/zh/post/2025/a_philosophy_of_software_design/">软件设计的哲学</a>》中的道理：</p>
<p><strong><strong>所有偷懒的设计，终将以更高的成本偿还</strong></strong></p>
<p>当然, 谁来还就是后话了</p>
<div class="qr-container" center>
<img src="/ox-hugo/qrcode_gh_e06d750e626f_1.jpg" alt="qrcode_gh_e06d750e626f_1.jpg" class="qr-container" width="160px" height="160px" center="t" />
公号同步更新，欢迎关注👻
</div>
]]></content:encoded>
    </item>
    <item>
      <title>软件设计的哲学</title>
      <link>https://ramsayleung.github.io/zh/post/2025/a_philosophy_of_software_design/</link>
      <pubDate>Fri, 30 May 2025 00:39:00 -0700</pubDate>
      <guid>https://ramsayleung.github.io/zh/post/2025/a_philosophy_of_software_design/</guid>
      <description>&lt;h2 id=&#34;前言&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;1&lt;/span&gt; 前言&lt;/h2&gt;
&lt;p&gt;知道这本书是因为在 Hacker News 上有人提问：&lt;a href=&#34;https://news.ycombinator.com/item?id=31713756&#34;&gt;你读过最好的技术书是什么&lt;/a&gt; &lt;sup id=&#34;fnref:1&#34;&gt;&lt;a href=&#34;#fn:1&#34; class=&#34;footnote-ref&#34; role=&#34;doc-noteref&#34;&gt;1&lt;/a&gt;&lt;/sup&gt;?&lt;/p&gt;
&lt;p&gt;最高赞的书是 Design Data Intensive Application(DDIA, 即《&lt;a href=&#34;https://book.douban.com/subject/30329536/&#34;&gt;数据密集型应用系统设计&lt;/a&gt;》&lt;sup id=&#34;fnref:2&#34;&gt;&lt;a href=&#34;#fn:2&#34; class=&#34;footnote-ref&#34; role=&#34;doc-noteref&#34;&gt;2&lt;/a&gt;&lt;/sup&gt;), 我觉得 DDIA 也担得起这个赞誉，然后最高赞的回答顺势提到了 &lt;a href=&#34;https://book.douban.com/subject/30218046/&#34;&gt;A Philosophy Of Software Design&lt;/a&gt; &lt;sup id=&#34;fnref:3&#34;&gt;&lt;a href=&#34;#fn:3&#34; class=&#34;footnote-ref&#34; role=&#34;doc-noteref&#34;&gt;3&lt;/a&gt;&lt;/sup&gt;, 想来能与 DDIA 齐名的书，肯定不会差得哪里去。&lt;/p&gt;</description>
      <content:encoded><![CDATA[<h2 id="前言"><span class="section-num">1</span> 前言</h2>
<p>知道这本书是因为在 Hacker News 上有人提问：<a href="https://news.ycombinator.com/item?id=31713756">你读过最好的技术书是什么</a> <sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>?</p>
<p>最高赞的书是 Design Data Intensive Application(DDIA, 即《<a href="https://book.douban.com/subject/30329536/">数据密集型应用系统设计</a>》<sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup>), 我觉得 DDIA 也担得起这个赞誉，然后最高赞的回答顺势提到了 <a href="https://book.douban.com/subject/30218046/">A Philosophy Of Software Design</a> <sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup>, 想来能与 DDIA 齐名的书，肯定不会差得哪里去。</p>
<p>作者是 John Ousterhout, 斯坦福大学的教授，TCL 编程语言的创造者(Redis 的初始化版本就是用 TCL 写的)，共识算法 Raft 的作者之一.</p>
<p>这本书并不厚，全书只有200多页，读起来也并不费劲。</p>
<p>而这本书的主旨，开篇就点出来了:</p>
<blockquote>
<p>This book is about how to design software systems to minimize their complexity.</p>
<p>本书讲述如何设计软件系统以最小化其复杂度</p></blockquote>
<p>而软件工程的本质就是如何管理复杂度，全书围绕如何降低软件复杂性提出的思考和解决方案，
主要围绕抽象，异常，文档，一致性，设计原则这五个方向。</p>
<p>许多原则我看着都深有共鸣，尤其在设计过相当多的系统之后，犯过许多错误之后，才会意识到这些原则的重要之处。</p>
<p>很多原则看上去说的和没说一样，但只有踩过坑，实践起来都知道是金科玉律, 除了道出「软件设计」的真谛之外, 这本书其他论点也可谓字字珠玑.</p>
<p>关于谨慎暴露过多的配置给用户，尽量让程序动态计算各种参数值，尽量提供默认参数。</p>
<blockquote>
<p>开发软件时，开发者主动承担一些额外痛苦，从而减少用户的痛苦。</p>
<p>When developing a module, look for opportunities to take a little bit of extra suffering upon yourself in order to reduce the suffering of your users.</p></blockquote>
<p>关于接口设计的原则:</p>
<blockquote>
<p>模块拥有简单的接口比简单的实现更重要。</p>
<p>it&rsquo;s more important for a module to have simple interface than a simple implementation</p></blockquote>
<p>关于异常处理的洞见:</p>
<blockquote>
<p>解决问题的最好方式是避免出现问题。</p>
<p>The best way to eliminate exception handling complexity is to define your APIs so that there are no exceptions to handle: <strong><strong>define errors out of existence</strong></strong></p>
<p>归根结底，减少 Bug 的最佳方法是让软件更简单(少即是多)</p>
<p><strong><strong>Overall, the best way to reduce bugs is to make software simpler.</strong></strong></p></blockquote>
<h2 id="抽象"><span class="section-num">2</span> 抽象</h2>
<p>所谓的抽象，用我自己的话来说的就是把复杂的东西简单地呈现出来。</p>
<h3 id="模块深度"><span class="section-num">2.1</span> 模块深度</h3>
<p>为了直观地感受一个模块设计是否足够抽象，作者提出一个模块深度的概念:</p>

<figure>
    
    
    <input type="checkbox" id="zoomCheck-ff3dd" hidden>
    <label for="zoomCheck-ff3dd">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/deep_module.jpg"/> 
    
    
    </label>
</figure>

<p>矩形的表层长度即是接口的复杂程度，而矩形的面积代表模块实现的功能，好的模块应该是深的(deep), 这意味着它有简单的接口，但是内部有复杂且丰富的实现.</p>
<p>例如 Unix 的文件读写接口:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">open</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">path</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">mode_t</span> <span class="n">permissions</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">ssize_t</span> <span class="nf">read</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span> <span class="n">buffer</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">ssize_t</span> <span class="nf">write</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span><span class="o">*</span> <span class="n">buffer</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">off_t</span> <span class="nf">lseek</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">off_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">referencePosition</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">close</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>接口非常简单，但是其内部的实现可能需要成千上万行的代码，
需要支持文件目录的读写，文件权限，读写缓冲区，磁盘读写等等功能，这就是「深的」模块。</p>
<p>与其相反的就是浅的模块(shallow), 接口很复杂，但是功能却很简单。</p>
<h3 id="信息的漏与藏"><span class="section-num">2.2</span> 信息的漏与藏</h3>
<p>实现抽象的关键手段就是辨别出信息的重要程度，对于不重要的信息，就要对用户隐藏起来，关键的信息，就要暴露给用户, 实现「去粗存精，开箱即用」。</p>
<p>一个典型的例子就是参数配置，把参数暴露给用户，除非用户非常熟悉这个系统，不然他也不知道怎么算，
不需要用户关注的参数就提供默认值，能程序动态计算就由程序自己来算.</p>
<p>我很反感的一种设计就是引入一个配置系统，系统的运行参数都要由工程师配置，美其名是提供灵活度。</p>
<p>但这不仅引入额外的系统依赖（须知复杂度的根源就来自依赖与不明确），还大大增加了的运维成本，
更何况这样的配置还无法自适应，换种机型又要重新配置，导致配置越来越复杂。</p>
<p>除非是业务的黑名单或者白名单，系统的运行参数能用默认的就用默认，能动态计算就动态计算。</p>
<p>想想TCP/IP 的重试延迟时长如果不是动态计算，那么配置什么值比较合适，网络畅通和网络延迟又该是什么值，
开始恢复时和开始堵塞时又应该是什么值的呢?</p>
<h2 id="异常"><span class="section-num">3</span> 异常</h2>
<p>异常处理是系统复杂度的关键来源之一，异常就是一种特殊的分支，系统为了处理特殊 case难免需要写很多额外的逻辑。</p>
<p>而作者提出的降低异常处理来系统复杂度影响的方法，就是优化设计，减少必须处理异常的地方。</p>
<p>解决一个问题最好的方法是避免其发生，听起来很空洞或者是很不可思议，作者举出来的例子就是 Java 的 <code>substring(int beginIndex, int endIndex)</code> 用于截取子字符串的接口, 如果 <code>endIndex</code> 超出字符长度，Java 就会抛出一个 <code>IndexOutOfBoundException</code>, 调用方就是需要考虑越界的问题。</p>
<p>但是如果 Java 的 <code>substring</code> 接口本身可以像 Python 那样支持越界，返回一个空字符串，那么调用方就完全不需要考虑越界导致的异常</p>
<p>另外一个例子是作者设计的TCL脚本中的 <code>unset</code> 指令，原意是用来删除一个变量，因为他最初的设想是变量如果不存在，用户不可能调用 <code>unset</code> 的，那么当 <code>unset</code> 操作的变量不存在，那么就会抛出异常。</p>
<p>但是很多用户就是用 <code>unset</code> 来清理可能被初始化或者未初始化的变量，现在的设计就意味用户还需要包一层 <code>try/catch</code> 才能使用 <code>unset</code>.</p>
<p>意识到这个设计错误之后，作者对 <code>unset</code> 的语义作了稍微的修正，用 <code>unset</code> 来确保指定的变量不再存在(如果变量本身不存在，那么它什么都不需要做)</p>
<p>更经典的例子就是 Windows 下面删除一个文件，相信使用过 Windows 的朋友尝试删除文件时都会遇到这样的弹窗：「文件已被打开，无法删除，请重试」</p>

<figure>
    
    
    <input type="checkbox" id="zoomCheck-bbb1b" hidden>
    <label for="zoomCheck-bbb1b">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/windows_delete_opening_file.png"/> 
    
    
    </label>
</figure>

<p>用户只能费尽心思去找打开这个文件的进程，然后把它杀掉再尝试删除，甚至只能通过关机重启来尝试删除文件。</p>
<p>但是 Unix 的处理方式就更优雅，它允许用户删除已经被其他进程打开的文件，它会对该文件做标记，让用户看来它已经被删除了，但是在打开它的进程结束前文件对应的数据都会一直存在。</p>
<p>只有在进程结束后，文件数据才会被删除掉，这样用户在删除文件时就不需要担心文件是否被使用。</p>
<p>通过优化以上的设计，减少需要用户处理的异常，这也是一个「去粗留精」的过程, 减少用户需要感知的内容。</p>
<h2 id="注释"><span class="section-num">4</span> 注释</h2>
<p>本书用了好几个章节来介绍文档与注释的重要性，命名的重要性，如何写好注释和起好名字。</p>
<p>好的文档可以大幅改善一个系统的设计，因为文档的作用就是把「对用户重要的，但是无法直接从代码中得知的关键信息告知用户」, 相当于帮用户把一个系统的关键信息给找出来。</p>
<p>不是有这么一句话： <strong><strong>程序员都讨厌写文档，但是更痛恨其他程序员不写文档。</strong></strong></p>
<p><strong><strong>而注释就是离源码最近的文档.</strong></strong></p>
<p>程序员不写注释的借口大概有这么几个（可惜它们都是不成立的）, 常见的借口与它们不成立的原因可见:</p>
<h3 id="好的代码是自解释的"><span class="section-num">4.1</span> 好的代码是自解释的</h3>
<p>如果用户必须阅读方法源码才能使用它，那就没有抽象，你相当于把实现的所有复杂度都直接暴露给用户。</p>
<p>若想通过抽象隐藏复杂性，注释必不可少</p>
<h3 id="我没有时间写注释"><span class="section-num">4.2</span> 我没有时间写注释</h3>
<p>如果你一直把写代码的优先级置于写注释之上，那么你会一直没有时间写注释，
因为一个项目结束之后总会有新的项目到来，如果你一直把写注释的优先级放在代码之后，那么你永远都不会去写注释。</p>
<p>写注释实际并不需要那么多的时间</p>
<h3 id="注释都会过期的啦"><span class="section-num">4.3</span> 注释都会过期的啦</h3>
<p>注释虽然难免会过期，但是保持与代码一致也并不会花费太多时间。</p>
<p>只有大幅需要修改代码时才需要更新注释，更何况，只有每次都不更新注释，注释才会难免过期</p>
<h3 id="我见过的注释都很烂-我为啥还要写"><span class="section-num">4.4</span> 我见过的注释都很烂，我为啥还要写</h3>
<p>别人的注释写得不好，那不正说明你可以写出好的注释嘛。</p>
<p>不能用别人的低标准来要求自己嘛。</p>
<h3 id="注释的原则"><span class="section-num">4.5</span> 注释的原则</h3>
<p>说起接口注释和文档，我一直觉得我描述下接口功能和使用场景，已经比绝大多数的同行做得好了。</p>
<p>在和现在的 L7 大佬一起工作之后，着实被他的文档所震撼。</p>
<p>不知道是因为其对代码质量和文档都有非常高的要求，还是读博士时训练出来的写作能力，
其对接口的功能，使用场景以及异常的描述都非常详尽，甚至包括代码使用示例，质量与 JDK 源码的注释不相上下, 原来真的有程序员花这么多精力写代码注释的。</p>
<h4 id="注释应当描述代码中不明显的内容"><span class="section-num">4.5.1</span> 注释应当描述代码中不明显的内容</h4>
<p><strong><strong>注释应当描述代码中不明显的内容</strong></strong>,</p>
<p>简单来说，就是要描述代码为什么要这么做，而不是描述代码是怎么做的，这相当于是把代码换成注释再写一次。</p>
<h4 id="注释先行"><span class="section-num">4.5.2</span> 注释先行</h4>
<p>很多程序员都习惯在写完代码之后才写注释，作者反其道而行， 作者推荐在定义完函数或者模块接口之后，不要马上动手写实现，
而是在这个时候在接口上把接口注释写下来，这相当于是在脑海把模块的设计再过一次。</p>
<p>写完代码再写注释，设计思路已经记不大清了，脑中更多的是实现细节，既容易把实现写成注释，又容易陷入「写完代码就不写注释」的陷阱。</p>
<h2 id="一致性"><span class="section-num">5</span> 一致性</h2>
<p>前文提到，系统的复杂度来自于两个方面「依赖」与「不明确」，
而「一致性」就是让系统的行为更加清晰明确。</p>
<p><strong><strong>它意味着相似的事情以相似的方式处理，不同的事情以不同的方式处理。</strong></strong></p>
<p>即所谓的「规圆矩方」，通过规范约束降低随意性，以及「一法通，万法通」，统一模式提升可维护性，让行为可预期。</p>
<p>一个系统的一致性一般体现在以下方面：</p>
<ol>
<li>命名(驼峰还是下划线)</li>
<li>代码风格(缩进，空格还是tab)</li>
<li>设计模式(使用特定的设计模式解决特定的问题)</li>
</ol>
<p>当然，还有通过「一致性」降低系统复杂度，走得比较极端的:</p>
<p>之前还在微信支付的时候，除上述的要求外，还要求后端只能使用一种语言(C++, Golang/JavaScript就别想了), 存储组件只能使用微信内部研发的KV(使用MySql需要向总经理申请)等等的要求.</p>
<h2 id="设计原则"><span class="section-num">6</span> 设计原则</h2>
<h3 id="通用设计"><span class="section-num">6.1</span> 通用设计</h3>
<p>好的设计应该是通用的，优先采用通用设计而非特殊场景的定制化方案，这个是减少复杂度和改善软件系统的根本原则。</p>
<p>过度定制通常是成为软件复杂度增加的首要诱因。</p>
<p>通用设计可以降低系统的整体复杂度(更少处理特殊分支的逻辑), 更深的模块(接口简单，功能丰富), 隐藏非关键信息.</p>
<p>文中提到的例子就是文本编辑器的文字插入与删除操作:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// 反例：过度定制（绑定特殊场景）, 实现删除键功能</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">class</span> <span class="nc">TextEditor</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">handleBackspaceKey</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// 耦合UI事件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cursorPosition</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">text</span><span class="p">.</span><span class="na">deleteCharAt</span><span class="p">(</span><span class="n">cursorPosition</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">cursorPosition</span><span class="o">--</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// 正例：通用设计（解耦核心逻辑）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">class</span> <span class="nc">Text</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">delete</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">end</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// 纯文本操作</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">content</span><span class="p">.</span><span class="na">delete</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">class</span> <span class="nc">UI</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">onBackspacePressed</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">text</span><span class="p">.</span><span class="na">delete</span><span class="p">(</span><span class="n">cursor</span><span class="p">.</span><span class="na">position</span><span class="p">(),</span><span class="w"> </span><span class="n">cursor</span><span class="p">.</span><span class="na">position</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">1</span><span class="p">);</span><span class="w"> </span><span class="c1">// 调用通用API</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">cursor</span><span class="p">.</span><span class="na">moveLeft</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>通过 <code>delete(int start, int end)</code> 既可以实现删除键功能，也可以实现选中并删除的功能。</p>
<h3 id="性能"><span class="section-num">6.2</span> 性能</h3>
<p>在设计系统的时候，一般不需要太多地考虑性能的问题，因为简单，通用的系统要做性能优化通常都是比较容易；
相反而言，深度定制的系统因为耦合了定义逻辑，要优化性能并没有那么容易。</p>
<h3 id="设计两次"><span class="section-num">6.3</span> 设计两次</h3>
<p>Design it twice</p>
<p>因为很难一次就把事情做到极致, 那就再来一次, 设计时把能想到的选项都列下来.</p>
<p>反直觉的是，第一直觉通常不是最优的, 所以不要只考虑一种设计方案，无论它看起来多么合理，多对比下其他方案总没有害处的。</p>
<p>只用第一直觉的方案，其实你是在低估自己的潜力，你错失了找到更好方案的机会。</p>
<p>这也是我在写设计方案时候的做法，把自己能想到的，和同事讨论出来的所有方案都写上，然后分析各种方案的优劣, 最好的方案可能并不在原有方案列表里面，而是其中几个方案的合体。</p>
<h3 id="大局观"><span class="section-num">6.4</span> 大局观</h3>
<p>做任何事都要有大局观, 编程也不例外，战略编程优于战术编程(Strategic Programming over Tactical Programming);</p>
<p>虽然我们一直说「又不是不能跑」，但是我们对代码的要求，不能是「能跑就行啦」.</p>
<p>再者就是要和扁鹊他大哥治病一样，把功夫都做在前期，防范于未然，修补错误成本往往也越往后越高，病入膏肓之后，扁鹊来了也要提桶跑路:</p>
<blockquote>
<p>治不了，等死吧，告辞</p></blockquote>
<h2 id="代码整洁之道vs软件设计哲学"><span class="section-num">7</span> 代码整洁之道vs软件设计哲学</h2>
<p>本书的作者对<a href="https://book.douban.com/subject/34986245/">《代码整洁之道》</a>(Clean Code)<sup id="fnref:4"><a href="#fn:4" class="footnote-ref" role="doc-noteref">4</a></sup> 的作者(Robert C. Martin, 即 Uncle Bob)的诸多观点作了反驳</p>
<h3 id="函数拆分"><span class="section-num">7.1</span> 函数拆分</h3>
<p>比如关于什么时候应该拆分一个函数，Uncle Bob 的观点是，基于函数的代码行数，一个函数需要相当短，甚至10行都有太长了。</p>
<p>Uncle Bob 原话:</p>
<blockquote>
<p>In the book Clean Code1, Robert Martin argues that functions should be broken up on length alone. He says that functions should be extremely short, and that even 10 lines is too long.</p></blockquote>
<p>而本书作者 John 的观点是: <strong><strong>每个函数应只做一件事，并完整地做好</strong></strong></p>
<p>函数的接口应当简洁，这样调用者无需记住大量信息就能正确使用它。</p>
<p>函数应当具备深度：其接口应远比实现更简单。如果一个函数满足以上所有特性，那么它的长度通常并不重要。</p>
<p><strong><strong>除非能让整个系统更简单，否则不应拆分函数</strong></strong></p>
<h3 id="文档注释"><span class="section-num">7.2</span> 文档注释</h3>
<p>Uncle Bob 认为需要给函数「注释始终是一种失败(<strong><strong>Comments are always failures</strong></strong>)」</p>
<p>如果我们的编程语言足够富有表现力，或者如果我们有能力用好这些语言来传达意图，那么我们就不太需要注释——甚至可能完全不需要.</p>
<p><strong><strong>注释的正确用途，是弥补我们无法用代码清晰表达的缺陷……注释始终是一种失败</strong></strong></p>
<blockquote>
<p>If our programming languages were expressive enough, or if we had the talent to subtly wield those languages to express our intent, we would not need comments very much — perhaps not at all.</p>
<p>he proper use of comments is to compensate for our failure to express ourselves in code&hellip;. Comments are always failures.</p></blockquote>
<p>而 John 的观点是</p>
<p>但注释并非失败的表现。</p>
<p><strong><strong>它们提供的信息与代码截然不同，而这些信息目前无法通过代码本身来表达。</strong></strong></p>
<p><strong><strong>注释的作用之一，正是让人无需阅读代码即可理解其含义</strong></strong></p>
<p>甚至直接反驳其观点:</p>
<blockquote>
<p>I worry that Martin’s philosophy encourages a bad attitude in programmers, where they avoid comments so as not to seem like failures.</p></blockquote>
<h3 id="网上对线"><span class="section-num">7.3</span> 网上对线</h3>
<p>所以也难怪 Uncle Bob 和 John Ousterhout 几个月前直接在网上论坛来了一次 <del>对线</del> (<a href="https://news.ycombinator.com/item?id=43166362">辩论)</a> <sup id="fnref:5"><a href="#fn:5" class="footnote-ref" role="doc-noteref">5</a></sup></p>
<p>然后有看热闹不嫌事大的播主，把两人邀请到直播上，让他们直接面对面再来了一次对线</p>
<p>对应的Youtube视频: <a href="https://www.youtube.com/watch?v=3Vlk6hCWBw0">https://www.youtube.com/watch?v=3Vlk6hCWBw0</a></p>
<p>两位的书我都看过，我个人的感觉是《代码整洁之道》更适合入门的工程师，它可以教你如何写出好的「代码片段」；
而《软件设计的哲学》更适合需要做系统设计的工程师，它指导你如何设计好的「软件」。</p>
<p>考虑到两位作者的背景和作品，我可以说两位的差别可以说是 <strong><strong>以编程为生的人与以写编程相关的东西为生的人</strong></strong></p>
<h2 id="总结"><span class="section-num">8</span> 总结</h2>
<p>全书读完，我觉得《软件设计的哲学》绝对是配得上最好的技术书籍之一的赞誉。</p>
<p>但是不同的人读起来可能会有不同的感觉，其中的许多原则真的是做过设计，踩过坑才会有所共鸣, 否则会觉得其泛泛其谈。</p>
<p>当然，我也不是完全同意书中的所有观点的。</p>
<p>比如书中提到的会导致代码意图不「明显」的其中一种做法是声明的类型与初始化的类型不一致的情况:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&gt;</span><span class="w"> </span><span class="n">incomingMessageList</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">incomingMessageList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&gt;</span><span class="p">();</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>上面声明的是 <code>List&lt;Message&gt;</code>, 实际使用的 <code>ArrayList&lt;Message&gt;</code>, 这可能会误导用户，因为意图不清晰，阅读代码的人可能不确定是否需要使用 <code>List</code> 或者 <code>ArrayList</code>, 最好是声明和初始化都换成相同的类型。</p>
<p>但是 <code>List</code> 是接口, <code>ArrayList</code> 是接口的具体实现，这个就是非常标准的面向对象编程中的多态，这并不什么问题。</p>
<p>但瑕不掩瑜，全书读完，把书盖上后，我有种齿颊留香, 余音绕梁的感觉，书里有很多「熟悉的味道」，总是让我想起经手过的项目中种种的好代码和「坏」代码.</p>
<h2 id="推荐阅读">推荐阅读</h2>
<ul>
<li>旅加经历
<ul>
<li><a href="https://ramsayleung.github.io/zh/post/2023/%E8%BF%99%E4%BA%9B%E5%B9%B4%E8%B5%B0%E8%BF%87%E7%9A%84%E8%B7%AF_%E4%BB%8E%E5%B9%BF%E5%B7%9E%E5%88%B0%E6%B8%A9%E5%93%A5%E5%8D%8E/">这些年走过的路：从广州到温哥华</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2023/%E5%8A%A0%E6%8B%BF%E5%A4%A7%E4%B9%8B%E5%88%9D%E4%BD%93%E9%AA%8C/">加拿大之初体验</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2024/%E7%99%BB%E9%99%86%E5%8A%A0%E6%8B%BF%E5%A4%A7%E4%B8%80%E5%B9%B4%E7%9A%84%E4%BD%93%E4%BC%9A/">登陆加拿大一年后的体会</a></li>
</ul>
</li>
<li>工具流分享
<ul>
<li><a href="https://ramsayleung.github.io/zh/post/2024/%E7%AE%80%E6%98%8E%E5%86%99%E4%BD%9C%E6%8C%87%E5%8D%97/">简明写作指南</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2023/%E6%88%91%E7%9A%84%E5%86%99%E4%BD%9C%E6%B5%81/">我的写作流</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2023/%E6%88%91%E7%9A%84%E7%94%BB%E5%9B%BE%E6%B5%81/">我的画图流：画图工具与技巧分享</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2023/%E6%88%91%E7%9A%84%E6%90%9C%E7%B4%A2%E6%B5%81/">我的搜索流：高效搜索经验分享</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2022/feynman_technique/">最好的学习方式：费曼学习法(Feynman Technique)</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2021/%E7%B3%BB%E7%BB%9F%E6%80%9D%E8%80%83/">系统思考：既见树木，又见森林</a></li>
</ul>
</li>
<li>思考感悟
<ul>
<li><a href="https://ramsayleung.github.io/zh/post/2024/%E7%BC%96%E7%A8%8B%E5%8D%81%E5%B9%B4%E7%9A%84%E6%84%9F%E6%82%9F/">编程十年的感悟</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2023/%E4%BB%8E%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98%E7%A6%BB%E7%BA%BF_%E6%88%91%E5%B8%A6%E8%B5%B0%E4%BA%86%E4%BB%80%E4%B9%88/">那些年，我从微信支付学到的东西</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2025/%E6%9D%82%E8%B0%88ai%E5%8F%96%E4%BB%A3%E7%A8%8B%E5%BA%8F%E5%91%98/">杂谈ai取代程序员</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2023/%E7%BD%AE%E8%BA%AB%E4%BA%8B%E5%86%85/">为什么梦想买不起，故乡回不去</a></li>
</ul>
</li>
<li>软件工程
<ul>
<li><a href="https://ramsayleung.github.io/zh/post/2025/structure_and_interpretation_of_computer_programs/">一本读了八年还没读完的书</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2024/%E6%B5%8B%E8%AF%95%E6%8A%80%E8%83%BD%E8%BF%9B%E9%98%B6%E4%B8%80_%E8%BD%AF%E4%BB%B6%E8%B4%A8%E9%87%8F%E8%AE%A4%E7%9F%A5/">测试技能进阶(一): 软件质量认知</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2024/%E6%B5%8B%E8%AF%95%E6%8A%80%E8%83%BD%E8%BF%9B%E9%98%B6%E4%BA%8C_parameterized_tests/">测试技能进阶(二): Parameterized Tests</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2024/%E6%B5%8B%E8%AF%95%E6%8A%80%E8%83%BD%E8%BF%9B%E9%98%B6%E4%B8%89_property_based_testing/">测试技能进阶(三): Property Based Testing</a></li>
</ul>
</li>
</ul>
<div class="qr-container" center>
<img src="/ox-hugo/qrcode_gh_e06d750e626f_1.jpg" alt="qrcode_gh_e06d750e626f_1.jpg" class="qr-container" width="160px" height="160px" center="t" />
公号同步更新，欢迎关注👻
</div>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p><a href="https://news.ycombinator.com/item?id=31713756">https://news.ycombinator.com/item?id=31713756</a>&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2">
<p><a href="https://book.douban.com/subject/30329536/">https://book.douban.com/subject/30329536/</a>&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:3">
<p><a href="https://book.douban.com/subject/30218046/">https://book.douban.com/subject/30218046/</a>&#160;<a href="#fnref:3" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:4">
<p><a href="https://book.douban.com/subject/34986245/">https://book.douban.com/subject/34986245/</a>&#160;<a href="#fnref:4" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:5">
<p><a href="https://news.ycombinator.com/item?id=43166362">https://news.ycombinator.com/item?id=43166362</a>&#160;<a href="#fnref:5" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>
]]></content:encoded>
    </item>
    <item>
      <title>重新造轮子系列(六)：构建工具</title>
      <link>https://ramsayleung.github.io/zh/post/2025/reinvent_build_manager/</link>
      <pubDate>Sun, 20 Apr 2025 18:18:00 -0700</pubDate>
      <guid>https://ramsayleung.github.io/zh/post/2025/reinvent_build_manager/</guid>
      <description>&lt;p&gt;项目 GitHub 地址: &lt;a href=&#34;https://github.com/ramsayleung/reinvent/tree/master/build_manager&#34;&gt;Build Manager&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&#34;前言&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;1&lt;/span&gt; 前言&lt;/h2&gt;
&lt;p&gt;以 C 语言为例，一个程序通常由多个源文件 &lt;code&gt;.c&lt;/code&gt; 组成, 每个源文件需要先编译成目标文件 &lt;code&gt;.o&lt;/code&gt;, 再链接成最终的可执行文件。&lt;/p&gt;

&lt;figure&gt;
    
    
    &lt;input type=&#34;checkbox&#34; id=&#34;zoomCheck-63797&#34; hidden&gt;
    &lt;label for=&#34;zoomCheck-63797&#34;&gt;
    
    
    &lt;img class=&#34;zoomCheck&#34; loading=&#34;lazy&#34; src=&#34;https://ramsayleung.github.io/ox-hugo/c_program_build_phase.jpg&#34;/&gt; 
    
    
    &lt;/label&gt;
&lt;/figure&gt;

&lt;p&gt;如果只改动了其中一个源文件的内容，理想情况只需要重新编译并重新链接改动文件，而非从头构建整个项目(所谓的增量编译)。&lt;/p&gt;</description>
      <content:encoded><![CDATA[<p>项目 GitHub 地址: <a href="https://github.com/ramsayleung/reinvent/tree/master/build_manager">Build Manager</a></p>
<h2 id="前言"><span class="section-num">1</span> 前言</h2>
<p>以 C 语言为例，一个程序通常由多个源文件 <code>.c</code> 组成, 每个源文件需要先编译成目标文件 <code>.o</code>, 再链接成最终的可执行文件。</p>

<figure>
    
    
    <input type="checkbox" id="zoomCheck-63797" hidden>
    <label for="zoomCheck-63797">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/c_program_build_phase.jpg"/> 
    
    
    </label>
</figure>

<p>如果只改动了其中一个源文件的内容，理想情况只需要重新编译并重新链接改动文件，而非从头构建整个项目(所谓的增量编译)。</p>
<p>但是如果手动管理这些依赖关系，随着源文件的增多，很容易就会变得无法维护。</p>
<p>类似的问题在软件开发中比比皆是，以我们此前实现的<a href="/zh/post/2025/reinvent_page_template/">「模板引擎」</a>为例，如果我们正使用静态网站生成器来构建个人博客(Hugo 或者 Jekyll),
当我们修改了某篇文章时，系统只需要重新生成该页面，而不必重新编译整个网站。</p>
<p>但如果我们调整了调整了网站的模板，那么所有依赖该模板的页面都需要重新渲染，而手动处理这些依赖关系既繁琐又容易出错。</p>
<p>因此我们需要一个构建工具(build tool或者叫 build maanger).</p>
<h2 id="需求"><span class="section-num">2</span> 需求</h2>
<p>构建工具的核心理念就是自动化上述的操作：</p>
<ol>
<li>定义依赖关系, 比如 <code>main.o</code> 依赖于 <code>main.c</code> 和 <code>header.h</code></li>
<li>检测变更，可以通过时间戳或者内容的哈希来判断文件是否「过时」</li>
<li>按需执行，只重新生成受影响的目标</li>
</ol>
<p>从经典的 <a href="https://www.gnu.org/software/make/">make</a>, 到现代构建系统如 <a href="https://bazel.build">Bazel</a>, 尽管它们的实现方式各异，但是基本都遵循着这一思路。</p>
<p>所以我们会参考 <code>make</code>, 从零实现一个类 <code>make</code> 的构建工具，核心功能包括：</p>
<ol>
<li>构建规则(rule)：描述目标(target), 依赖(dependency)和生成命令(recipe)</li>
<li>依赖图(DAG): 避免循环依赖并确定构建顺序</li>
<li>增量编译：仅重新生成「过期」的目标</li>
<li>变量与通配符（如 <code>@TARGET</code> 和 <code>%</code> ） 以提高灵活性.</li>
</ol>
<h2 id="设计"><span class="section-num">3</span> 设计</h2>
<h3 id="构建规则"><span class="section-num">3.1</span> 构建规则</h3>
<p>构建工具的输入是一系列的规则，每个规则必需包含三个关键要素，分别是：</p>
<ol>
<li>目标，即构建命令生成的最终结果</li>
<li>依赖，即目标依赖于哪些文件</li>
<li>生成命令：具体的命令，用于描述如何将依赖生成出目标。</li>
</ol>
<p>以 <code>make</code> 的规则文件 <code>Makefile</code> 举例:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-makefile" data-lang="makefile"><span class="line"><span class="cl"><span class="nf">target</span><span class="o">:</span> <span class="n">dependencies</span>
</span></span><span class="line"><span class="cl">    recipe
</span></span></code></pre></td></tr></table>
</div>
</div><p>以一个 C 语言程序的构建规则为例:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-makefile" data-lang="makefile"><span class="line"><span class="cl"><span class="nf">hello</span><span class="o">:</span> <span class="n">utils</span>.<span class="n">c</span> <span class="n">main</span>.<span class="n">c</span> <span class="n">utils</span>.<span class="n">h</span>
</span></span><span class="line"><span class="cl">        gcc main.c utils.c -o hello
</span></span></code></pre></td></tr></table>
</div>
</div><p>其中 <code>hello</code> 是构建目标， <code>utils.c main.c utils.h</code> 是多个依赖文件, <code>gcc main.c utils.c -o hello</code> 是生成命令.</p>
<p><code>Makefile</code> 是 <code>make</code> 专属的配置文件格式，我们可以使用 JSON 或者 YAML 作为配置文件，避免重复造轮子，只要要表达列表和嵌套关系。</p>
<p>那么为什么 <code>make</code> 不使用 JSON 或者 YAML 作为配置文件呢？因为 <code>make</code> 被造出来的时候(1976年)，JSON 和 YAML 离诞生还有几十年呢.</p>
<h3 id="依赖图"><span class="section-num">3.2</span> 依赖图</h3>
<p>以前学数据结构的时候，难免会觉得图(graph) 这个数据结构真的没有什么用，除了刷题和面试会被问到.</p>
<p>但是在开发这个构建工具的时候，会发现图是必不可少的数据结构，准确来说是有向无环图(directed acyclic graph, DAG).</p>
<p>在构建工具中，每个构建规则（target: dependencies）定义了文件之间的依赖关系，这些关系天然形成一个有向无环图（DAG）。</p>
<p>例如：</p>
<ul>
<li>A 依赖于 B 和 C（ <code>A → B, A → C</code> ）</li>
<li>B 依赖于 D（ <code>B → D</code> ）</li>
</ul>
<p>此时，*构建顺序必须满足依赖的先后关系*：D 必须在 B 之前构建，B 和 C 必须在 A 之前构建。</p>
<p>而拓扑排序的作用，正是将图中的节点排序，保证每个节点在其依赖之后被执行。</p>
<p>而如果依赖图中存在环（例如 A → B → A），拓扑排序会失败.</p>
<p>拓扑排序的经典算法有 <a href="https://www.youtube.com/watch?v=cIBFEhD77b4">Kahn</a> 算法(基于入度)与 DFS 算法, 以 Kahn 算法为例, 步骤如下:</p>
<ol>
<li>先初始化一个队列，存入所有入度(in degree)为0的节点（无依赖节点）</li>
<li>依次处理队列中的节点，并将其人图中「移除」，更新后续节点的入度</li>
<li>若最终未处理所有节点，则说明存在环</li>
</ol>

<figure>
    
    
    <input type="checkbox" id="zoomCheck-9b93b" hidden>
    <label for="zoomCheck-9b93b">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/build_dependencies.png"/> 
    
    
    </label>
</figure>

<p>我曾经写过一篇关于拓扑排序的<a href="https://ramsayleung.github.io/en/post/2022/topological_sorting/">英文博客</a>，有兴趣可以移步阅读.</p>
<h3 id="过期检测"><span class="section-num">3.3</span> 过期检测</h3>
<p>增量编译的关键是仅重建「过期 」的目标，那么要怎么找到「过期」的目标呢？</p>
<p>最简单方式就是使用时间来作为判断标准，假如我们的源文件在上一次构建之后发生了修改，
那么我们就可以认为其对应的目标「过期」了，需要重新构建。</p>
<p>那么我们就需要记录上一次是什么时候构建的，然后再把文件最近的修改时间(last modification timestamp)作为比较, 用额外的文件来记录也太繁琐了，为此我们可以取一下巧：</p>
<p>把目标的生成时间作为上一次的构建时间，那么只要依赖的 <code>last modification timestamp</code> 大于目标的 <code>last modification timestamp</code>, 那么我们就可以认为其「过期」了。</p>
<p>这个就是 <code>make</code> 的实现方式，但是时间并不是总是可靠的，尤其是在网络环境下。</p>
<p>所以像 <code>bazel</code> 这样的现代构建系统，使用的就是源文件的哈希值来作为比较的标识：
即文件内容哈希值发生了变化，那么就认为发生内容变更，目标「过期」，需要重新生成。</p>
<h3 id="设计模式"><span class="section-num">3.4</span> 设计模式</h3>
<p>上文已经提到，我们构建工具的核心功能是解析构建规则, 构建依赖图，增量编译，变量与通配符匹配，那么我们可以很容易地写出对应的实现原型:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="nx">loadConfig</span><span class="p">()</span><span class="o">:</span> <span class="nx">rules</span>
</span></span><span class="line"><span class="cl"><span class="nx">buildGraph</span><span class="p">(</span><span class="nx">rules</span><span class="p">)</span><span class="o">:</span> <span class="nx">graph</span>
</span></span><span class="line"><span class="cl"><span class="nx">variableExpand</span><span class="p">(</span><span class="nx">graph</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nx">incrementalBuild</span><span class="p">(</span><span class="nx">graph</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>那么要如何实现上面的原型呢？在面向对象的编程思路里，要不使用继承，或者是组合，而两者对应的设计模式分别对应<a href="https://refactoring.guru/design-patterns/template-method">模板方法(Template Method)</a> 与 <a href="https://refactoring.guru/design-patterns/strategy">策略模式 (Strategy Pattern)</a></p>
<p>模板方法的核心思想是继承与流程固化，在父类中定义算法的整体骨架（不可变的执行流程），将某些步骤的具体实现延迟到子类，通过 <strong><strong>继承</strong></strong> 扩展行为。</p>
<p>而策略模式核心思想是组合 + 运行时替换，将算法的每个可变部分抽象为独立策略（接口），通过 <strong><strong>组合</strong></strong> 的方式注入到主类中。</p>
<p><a href="https://third-bit.com/sdxjs/build-manager/">System Design By Example</a> 原书使用的是模板方法，其实现可谓是充分展示了继承的不足：紧耦合，新增功能需要创建新子类，导致类爆炸，各种类变量在继承链传递，真的是无法维护，最后甚至「丧心病狂」地实现了八层继承，真的是完美诠释了 <a href="https://en.wikipedia.org/wiki/Fragile_base_class">Fragile base class</a> 的 code smell.</p>

<figure>
    
    
    <input type="checkbox" id="zoomCheck-8a381" hidden>
    <label for="zoomCheck-8a381">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/reinvent_template_method_inheritance_chain.png"/> 
    
    
    </label>
</figure>

<p>在体现到维护与扩展 <code>template method</code> 代码的痛苦之后，我最终选择了策略模式，因为其可以实现不同策略之间的松耦合，每个策略可以独立修改和扩展，不影响其他组件；易于测试，每个策略可被单独测试。</p>
<p>此外，构建工具需求可能会很多样，比如支持不同的增量编译算法（时间戳与内容哈希），支持不同的配置格式(Makefile/JSON/YAML), 策略模式不需要改写核心代码即可支持这些变体，并且支持不同策略的组合。</p>
<p>为了方便对比两者实现的差别，我把 <a href="https://github.com/ramsayleung/reinvent/tree/master/build_manager/template_method">template method</a> 和 <a href="https://github.com/ramsayleung/reinvent/tree/master/build_manager/strategy">strategy pattern</a> 的实现都保留了。</p>
<h3 id="自动变量"><span class="section-num">3.5</span> 自动变量</h3>
<p><code>make</code> 支持在 <code>Makefile</code> 中使用自动变量(Automatic Variables)来指代目标或者依赖，而无需显示将目标或者依赖名写出来，其变量含义如下:</p>
<p>假设目标是 <code>output: main.o utils.o</code></p>
<table>
  <thead>
      <tr>
          <th>变量</th>
          <th>含义</th>
          <th>示例</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>%</code></td>
          <td>通配符, 表示匹配任意非空字符串，通常用于模式规则（Pattern Rules）中</td>
          <td><code>%.o: %.c</code> 匹配任意 <code>.c</code> 文件生成 <code>.o</code></td>
      </tr>
      <tr>
          <td><code>$@</code></td>
          <td>目标文件名</td>
          <td><code>output</code></td>
      </tr>
      <tr>
          <td><code>$^</code></td>
          <td>所有依赖文件</td>
          <td><code>main.o utils.o</code></td>
      </tr>
      <tr>
          <td><code>$&lt;</code></td>
          <td>第一个依赖文件</td>
          <td><code>main.o</code></td>
      </tr>
  </tbody>
</table>
<p>这些自动变量可以极大简化 Makefile 的编写，避免重复输入文件名, 只不过 <code>$@</code> 这样的格式有点难以理解，我们可以定义自己的自动变量:</p>
<table>
  <thead>
      <tr>
          <th>我们的自动变量</th>
          <th><code>make</code> 变量</th>
          <th>含义</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>%</code></td>
          <td><code>%</code></td>
          <td>通配符, 表示匹配任意非空字符串</td>
      </tr>
      <tr>
          <td><code>@TARGET</code></td>
          <td><code>$@</code></td>
          <td>目标文件名</td>
      </tr>
      <tr>
          <td><code>@DEPENDENCIES</code></td>
          <td><code>$^</code></td>
          <td>所有依赖文件</td>
      </tr>
      <tr>
          <td><code>@DEP[0]</code></td>
          <td><code>$&lt;</code></td>
          <td>第一个依赖文件</td>
      </tr>
      <tr>
          <td><code>@DEP[n-1]</code></td>
          <td></td>
          <td>第 <code>n</code> 个依赖文件</td>
      </tr>
  </tbody>
</table>
<h2 id="实现"><span class="section-num">4</span> 实现</h2>
<p>在介绍完设计细节，实现就没有太多需要提及的内容，根据<a href="https://github.com/ramsayleung/reinvent/blob/master/build_manager/strategy/driver.ts">入口函数</a>以及<a href="https://github.com/ramsayleung/reinvent/tree/master/__tests__/build_manager/strategy">单元测试</a>就能理解个七七八八了。</p>
<h2 id="示例"><span class="section-num">5</span> 示例</h2>
<p>假设我们的 <a href="https://github.com/ramsayleung/reinvent/tree/master/build_manager/strategy/src">src</a> 目录有如下的文件:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">&gt; tree src
</span></span><span class="line"><span class="cl">src
</span></span><span class="line"><span class="cl">├── Makefile
</span></span><span class="line"><span class="cl">├── main.c
</span></span><span class="line"><span class="cl">├── utils.c
</span></span><span class="line"><span class="cl">└── utils.h
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>main.c</code> 内容如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;utils.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nf">print_message</span><span class="p">(</span><span class="s">&#34;Hello from Makefile!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>Makefile</code> 的内容如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-makefile" data-lang="makefile"><span class="line"><span class="cl"><span class="nf">hello</span><span class="o">:</span> <span class="n">utils</span>.<span class="n">c</span> <span class="n">main</span>.<span class="n">c</span> <span class="n">utils</span>.<span class="n">h</span>
</span></span><span class="line"><span class="cl">        gcc main.c utils.c -o hello
</span></span><span class="line"><span class="cl"><span class="nf">varexpand_hello</span><span class="o">:</span> <span class="n">utils</span>.<span class="n">c</span> <span class="n">main</span>.<span class="n">c</span>
</span></span><span class="line"><span class="cl">        gcc $^ -o <span class="nv">$@</span>
</span></span><span class="line"><span class="cl"><span class="nf">clean</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">        rm -f hello
</span></span><span class="line"><span class="cl"><span class="nf">cleanvar</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">        rm -rf varexpand_hello
</span></span></code></pre></td></tr></table>
</div>
</div><p>通过 <code>hello</code> 和 <code>varexpand_hello</code> 目标可分别生成 <code>hello</code> 与 <code>varexpand_hello</code> 的目标文件:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">&gt; make hello
</span></span><span class="line"><span class="cl">gcc main.c utils.c -o hello
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&gt; ./hello
</span></span><span class="line"><span class="cl">Message: Hello from Makefile!
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&gt; make varexpand_hello
</span></span><span class="line"><span class="cl">gcc utils.c main.c -o varexpand_hello
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&gt; ./varexpand_hello
</span></span><span class="line"><span class="cl">Message: Hello from Makefile!
</span></span></code></pre></td></tr></table>
</div>
</div><p>与 <code>Makefile</code> 相同含义的构建规则 <code>build_c_app.yml</code> 如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl">- <span class="nt">target</span><span class="p">:</span><span class="w"> </span><span class="l">hello</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">depends</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">src/utils.c</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">src/utils.h</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">src/main.c</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">recipes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="s2">&#34;gcc src/main.c src/utils.c -o hello&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">target</span><span class="p">:</span><span class="w"> </span><span class="l">varexpand_hello</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">depends</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">src/utils.c</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">src/main.c</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">recipes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="s2">&#34;gcc @DEPENDENCIES -o @TARGET&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">target</span><span class="p">:</span><span class="w"> </span><span class="l">clean</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">depends</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">recipes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="s2">&#34;rm -rf hello&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">target</span><span class="p">:</span><span class="w"> </span><span class="l">cleanvar</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">depends</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">recipes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="s2">&#34;rm -rf varexpand_hello&#34;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">&gt; npx tsx driver.ts build_c_app.yml <span class="c1"># 未指定目标，构建第一个目标，对齐 make</span>
</span></span><span class="line"><span class="cl">gcc src/main.c src/utils.c -o hello
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&gt; npx tsx driver.ts build_c_app.yml hello <span class="c1"># 生成 hello</span>
</span></span><span class="line"><span class="cl">target: hello is up to date, skipping execute the recipe
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&gt; ./hello
</span></span><span class="line"><span class="cl">Message: Hello from Makefile!
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&gt; npx tsx driver.ts build_c_app.yml varexpand_hello <span class="c1"># 生成 varexpand_hello</span>
</span></span><span class="line"><span class="cl">gcc src/utils.c src/main.c -o varexpand_hello
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&gt; ./varexpand_hello
</span></span><span class="line"><span class="cl">Message: Hello from Makefile!
</span></span></code></pre></td></tr></table>
</div>
</div><p>测试增量编译，重新构建 hello 目标</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">&gt; npx tsx driver.ts build_c_app.yml hello
</span></span><span class="line"><span class="cl">target: hello is up to date, skipping execute the recipe
</span></span></code></pre></td></tr></table>
</div>
</div><p>修改 <code>main.c</code> 源码:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;utils.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nf">print_message</span><span class="p">(</span><span class="s">&#34;Hello from build_c_app.yml!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>重新编译及运行 <code>hello</code> 目标:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">&gt; npx tsx driver.ts build_c_app.yml hello
</span></span><span class="line"><span class="cl">gcc src/main.c src/utils.c -o hello
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&gt; ./hello
</span></span><span class="line"><span class="cl">Message: Hello from build_c_app.yml!
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="总结"><span class="section-num">6</span> 总结</h2>
<p>终于又造了一个轮子，完成了这个类 <code>make</code> 的构建工具:</p>
<p>除了核心的依赖管理和增量编译，还实现了自动变量替换(如 <code>@TARGET</code>)、通配符规则和策略模式的灵活扩展。</p>
<p>写到这里总会忍不住地想起Unix的 KISS 原则, 即 <em>Keep it simple, stupid</em>, <strong>复杂的工具往往由简单的概念组合而成</strong></p>
<p><a href="/zh/post/2025/reinvent_project/">回到本系列的目录</a></p>
<h2 id="参考"><span class="section-num">7</span> 参考</h2>
<ul>
<li><a href="https://third-bit.com/sdxjs/build-manager/">https://third-bit.com/sdxjs/build-manager/</a></li>
</ul>
]]></content:encoded>
    </item>
    <item>
      <title>重新造轮子系列(五)：模板引擎</title>
      <link>https://ramsayleung.github.io/zh/post/2025/reinvent_page_template/</link>
      <pubDate>Mon, 14 Apr 2025 22:59:00 -0700</pubDate>
      <guid>https://ramsayleung.github.io/zh/post/2025/reinvent_page_template/</guid>
      <description>&lt;p&gt;项目 GitHub 地址: &lt;a href=&#34;https://github.com/ramsayleung/reinvent/tree/master/page_templates&#34;&gt;Page Template&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&#34;前言&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;1&lt;/span&gt; 前言&lt;/h2&gt;
&lt;p&gt;在现代网站开发里，内容与表现的分离已经成为基本准则(Separation of content and presentation),
比如 HTML 就是负责内容展现，而 CSS 就是负责页面的样式。&lt;/p&gt;</description>
      <content:encoded><![CDATA[<p>项目 GitHub 地址: <a href="https://github.com/ramsayleung/reinvent/tree/master/page_templates">Page Template</a></p>
<h2 id="前言"><span class="section-num">1</span> 前言</h2>
<p>在现代网站开发里，内容与表现的分离已经成为基本准则(Separation of content and presentation),
比如 HTML 就是负责内容展现，而 CSS 就是负责页面的样式。</p>
<p>而手动更新和编写 HTML 也是一件费时费力并且容易出错的工作，尤其是需要同时修改多个页面的时候，
因此有聪明的程序员就发明了名为静态网页生成器(static site generator)的技术，可以按需生成网页。</p>
<p>事实上，互联网上的大多数页面都是通过某种形式的静态网页生成器生成出来的。</p>
<p>而静态网页生成器的核心就是「模板引擎」，在过去三十年，诞生过无数的模板引擎，
甚至有位加拿大的程序员为了更方便记录谁访问了他的简历，他还发明了一门编程语言来做模板引擎的活，这就是「世界上最好的编程语言：PHP」。</p>
<p>PHP 可以算是 Web时代的王者之一，凭借着 <code>LAMP(Linux, Apache, MySql, PHP)</code> 架构不断开疆扩土，攻城掠地，而PHP本身也不断有新的框架被造出来，为谁是最好的「模板引擎」打得头破血流。</p>
<p>虽然关于「模板引擎」的战争至今仍未停歇，但细分下来，「模板引擎」可以分成三个主要的流派：</p>
<h3 id="嵌入式语法"><span class="section-num">1.1</span> 嵌入式语法</h3>
<p>在 Markdown/HTML 这样的标识语言里面嵌入编程语言，使用 <code>&lt;% %&gt;</code> 等符号来标记代码与文本内容，其中的代表包括 Javascript 的 <a href="https://ejs.co/">EJS</a>, Ruby 的 <a href="https://docs.ruby-lang.org/en/2.3.0/ERB.html">ERB</a>, 以及 Python 的 <a href="https://jinja.palletsprojects.com/en/stable/">Jinja</a>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="c">&lt;!--</span> <span class="nx">用特殊标记混合JavaScript与HTML</span> <span class="o">--&gt;</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;%</span> <span class="k">if</span> <span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span> <span class="o">%&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="o">&lt;</span><span class="nx">h1</span><span class="o">&gt;&lt;%=</span> <span class="nx">user</span><span class="p">.</span><span class="nx">name</span> <span class="o">%&gt;&lt;</span><span class="err">/h1&gt;</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;%</span> <span class="p">}</span> <span class="o">%&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>其优点就是可以直接使用嵌入的编程语言，功能强大，学习成本低，缺点就是模板很容易变成混杂内容和逻辑的「屎山」代码</p>
<h3 id="自定义语法"><span class="section-num">1.2</span> 自定义语法</h3>
<p>不嵌入现成的编程语言，而是自己开发一套 mini 编程语言，或者叫 DSL(domain specifc language), 代表有 <a href="https://pages.github.com/">GitHub Page</a> 用到的 <a href="https://jekyllrb.com/">Jekyll</a>, 还有 Golang 开发的著名静态网页生成器 <a href="https://gohugo.io/">Hugo</a>, 都是使用自定义的语法：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="p">{</span><span class="o">%</span> <span class="nx">comment</span> <span class="o">%</span><span class="p">}</span> <span class="nx">自创模板语法</span> <span class="p">{</span><span class="o">%</span> <span class="nx">endcomment</span> <span class="o">%</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span><span class="o">%</span> <span class="k">for</span> <span class="nx">post</span> <span class="nx">in</span> <span class="nx">posts</span> <span class="o">%</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">{{</span> <span class="nx">post</span><span class="p">.</span><span class="nx">title</span> <span class="p">|</span> <span class="nx">truncate</span><span class="p">:</span> <span class="mi">30</span> <span class="p">}}</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span><span class="o">%</span> <span class="nx">endfor</span> <span class="o">%</span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>优点就是语法简洁，缺点就是发展下去，可以又是自己造了一个新的编程语言，功能还不如通用的编程语言强大</p>
<h3 id="html指令"><span class="section-num">1.3</span> HTML指令</h3>
<p>不再在 HTML 中嵌入编程语言或DSL，取而代之的是直接给 HTML 定义特定的属性，不同的属性代表不同的含义，但是使用的还是标准 HTML.</p>
<p>最著名的就是 <a href="https://vuejs.org/">Vuejs</a>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="c">&lt;!-- 用特殊属性实现逻辑 --&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">div</span> <span class="na">v-if</span><span class="o">=</span><span class="s">&#34;user&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>{{ user.name }}<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>优点是保持HTML的合法性与简洁，不需要额外的 parser, 缺点就是指令功能受限，不如内嵌编程语言强大，生态工具较少, 灵活性差。</p>
<p>本文的模板引擎就会以这个流派为范式进行开发。</p>
<h3 id="特例之php"><span class="section-num">1.4</span> 特例之PHP</h3>
<p>分析完三种流派，就会奇怪 PHP 究竟是属于哪个流派呢？</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;</span><span class="nx">h1</span><span class="o">&gt;&lt;?</span><span class="nx">php</span> <span class="k">echo</span> <span class="nv">$title</span><span class="p">;</span> <span class="cp">?&gt;</span><span class="err">&lt;/h1&gt;
</span></span></span><span class="line"><span class="cl"><span class="err">&lt;ul&gt;
</span></span></span><span class="line"><span class="cl"><span class="err">  &lt;?php foreach ($items as $item) { ?&gt;
</span></span></span><span class="line"><span class="cl"><span class="err">    &lt;li&gt;&lt;?php echo $item; ?&gt;&lt;/li&gt;
</span></span></span><span class="line"><span class="cl"><span class="err">  &lt;?php } ?&gt;
</span></span></span><span class="line"><span class="cl"><span class="err">&lt;/ul&gt;
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>其实 PHP 本质就是流派二，只是这门专门用于「模板引擎」的 mini 语言，最后演化成了一门专门的编程语言，只是这个编程语言最擅长的还是网页开发，即是做「模板引擎」。</p>
<p>所以 PHP 是从流派二演化成流派一。</p>
<h2 id="目标"><span class="section-num">2</span> 目标</h2>
<p>可能不是所有的朋友都了解 Vue，所以在设计我们的模板引擎之前，先来明确一下需求与目标(scope).</p>
<p>假设我们有如下的 JSON 数据:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">names</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;Johnson&#39;</span><span class="p">,</span> <span class="s1">&#39;Vaughan&#39;</span><span class="p">,</span> <span class="s1">&#39;Jackson&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果有如下的模板:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>Expect three items<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">ul</span> <span class="na">z-loop</span><span class="o">=</span><span class="s">&#34;item:names&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">span</span> <span class="na">z-var</span><span class="o">=</span><span class="s">&#34;item&#34;</span><span class="p">/&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>那么 <code>names</code> 就会被赋值给 <code>item</code>, 然后每一个变量都会被展开成 <code>&lt;span&gt;{item}&lt;/span&gt;</code>, 所以上面的模板就会被展开成:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>Expect three items<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">span</span><span class="p">&gt;</span>Johnson<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">span</span><span class="p">&gt;</span>Vaughan<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">span</span><span class="p">&gt;</span>Jackson<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>而不同的指令会有不同的效果，如上的 <code>z-loop</code> 就是遍历一个数组，而 <code>z-if</code> 就是判断一个变量是否为 <code>true</code>, 为 <code>true</code> 则输出，否则则不输出.</p>
<p>如有数据:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;showThis&#34;</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;doNotShowThis&#34;</span><span class="o">:</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>和模板:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">p</span> <span class="na">z-if</span><span class="o">=</span><span class="s">&#34;showThis&#34;</span><span class="p">&gt;</span>This should be shown.<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">p</span> <span class="na">z-if</span><span class="o">=</span><span class="s">&#34;doNotShowThis&#34;</span><span class="p">&gt;</span>This should <span class="p">&lt;</span><span class="nt">em</span><span class="p">&gt;</span>not<span class="p">&lt;/</span><span class="nt">em</span><span class="p">&gt;</span> be shown.<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>就会被渲染成:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>This should be shown.<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们可以先支持以下的指令集:</p>
<table>
  <thead>
      <tr>
          <th>指令集</th>
          <th>含义</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>z-loop</code></td>
          <td>循环遍历数组生成元素内容</td>
      </tr>
      <tr>
          <td><code>z-if</code></td>
          <td>条件渲染，值为false时移除元素</td>
      </tr>
      <tr>
          <td><code>z-var</code></td>
          <td>将变量值输出到元素内容</td>
      </tr>
      <tr>
          <td><code>z-num</code></td>
          <td>直接输出数字值到元素内容</td>
      </tr>
  </tbody>
</table>
<h2 id="设计思路"><span class="section-num">3</span> 设计思路</h2>
<h3 id="stack-frame"><span class="section-num">3.1</span> stack frame</h3>
<p>模板引擎的核心是将「数据」+「模板」渲染成页面，那么数据要如何保存呢？以什么数据结构和变量形式来处理呢？</p>
<p>最简单的方式肯定就是使用全局变量的 HashMap 来保存所有的变量，但是如果存在两个同名的变量，那么 HashMap 这种数据结构就不适用。</p>
<p>更何况，可变的全局变量可谓是万恶之源，不知道有多少 bug 都是源自可变的全局变量。</p>
<p>在编译原理，保存变量的标准做法就是使用 stack frame, 每次进入一个函数就创建一个新的栈(<code>stack</code>), 每次函数调用都有自己的独立的栈，可以理解成每个栈就是一个 <code>HashMap</code>, 而每创建一个栈就是向 <code>List</code> 里面 <code>push</code> 一个新的 <code>HashMap</code>, 同一个函数里面不能有同名的变量，那能保证栈里面的值是唯一。</p>

<figure>
    
    
    <input type="checkbox" id="zoomCheck-338dd" hidden>
    <label for="zoomCheck-338dd">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/reinvent_stack_frame.jpg"/> 
    
    
    </label>
</figure>

<p>谈及变量和 stack frame, 编程语言中有个 <code>作用域(scoping)</code> 的概念, 定义了变量会怎么被程序访问到。</p>
<p>主要有两种作用域，分别被称为：</p>
<p>词法作用域(<a href="https://en.wikipedia.org/wiki/Scope_%28computer_science%29">Lexical/Static Scoping</a>): 在编译时就将变量给解析确定了下来，大部分编程语言使用的都是语法作用域，比如 Javascript, C/C++, Rust, Golang, Swift, Java 这个名单还可以很长.</p>
<p>因为其性能更优，并且行为是相当明确的，不需要分析运行时代码再来确定，如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">x</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> <span class="c1">// 全局变量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">foo</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">x</span><span class="p">);</span> <span class="c1">// 词法作用域，问题绑定全局变量 x
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">bar</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">let</span> <span class="nx">x</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span> <span class="c1">// 局部变量，不会影响 foo 中的 x
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">foo</span><span class="p">();</span> <span class="c1">// 调用 foo(), 仍然需要访问全局变量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">foo</span><span class="p">();</span> <span class="c1">// 输出: 10 (全局变量)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">bar</span><span class="p">();</span> <span class="c1">// 输出: 10 (还是全局变量，而非局部变量)
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>另外一种作用域是动态作用域(Dynamic Scoping): 在运行时通过遍历调用栈来确定变量的值，现在已经很少有编程语言使用了，比如是 Perl4, Bash, 或者是 Emacs Lisp:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="cp">#!/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="nv">x</span><span class="o">=</span><span class="s2">&#34;global&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">foo<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$x</span><span class="s2">&#34;</span>  <span class="c1"># x 的值取决于谁来调用 `foo`, 运行时决定</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">bar<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="nb">local</span> <span class="nv">x</span><span class="o">=</span><span class="s2">&#34;local&#34;</span>  <span class="c1"># 动态作用域: 会影响 foo 的值</span>
</span></span><span class="line"><span class="cl">  foo
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">foo  <span class="c1"># 输出: &#34;global&#34; (x 是全局变量)</span>
</span></span><span class="line"><span class="cl">bar  <span class="c1"># 输出: &#34;local&#34;  (x 是 bar 函数的局部变量)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>也就是 <code>foo</code> 中 <code>x</code> 的值还取决于调用方的栈，因为在 <code>bar</code> 里面调用 <code>foo</code> 时， bash 解释器会把 <code>bar</code> 的栈一并传给 <code>foo</code>, 所以 <code>foo</code> 就以最近栈中 <code>x</code> 的值为准。</p>
<p>这种作用域实现方式虽然简单，但是对于程序员 debug 来说简直是噩梦，所以在现代编程语言基本绝迹了。</p>
<p>话虽如此，但是对于模板引擎而言，动态作用域却是主流选择，主要是因为：</p>
<ol>
<li>模板的特性需求：循环/条件语句需要运行时创建临时变量</li>
<li>隔离性要求：避免不同模板间的变量污染</li>
<li>异常处理：未定义变量可返回 <code>undefined/null</code> 而非报错</li>
</ol>
<p>因此我们的模板引擎也会使用动态作用域来保存变量，即 <code>List&lt;HashMap&lt;String, String&gt;&gt;</code> 的数据结构.</p>
<h3 id="vistor-pattern"><span class="section-num">3.2</span> vistor pattern</h3>
<p>确定好如何保存变量之后，下一个问题就是如何遍历并且生成模板。</p>
<p>解析HTML之后生成的是 DOM(Document Object Model) 结构, 本质是多叉树遍历，按照指令处理栈的变量，然后再把 HTML 输出, 如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">traverse</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;text&#39;</span><span class="p">)</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&lt;</span><span class="si">${</span><span class="nx">node</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="sb">&gt;`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">node</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">traverse</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&lt;/</span><span class="si">${</span><span class="nx">node</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="sb">&gt;`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>实现是很简单，但是我们把「遍历逻辑」和「不同指令对应的逻辑」耦合在一起了，很难维护。</p>
<p>并且我们现在只支持4个指令，或者未来要增加其他指令，只要在 <code>traverse</code> 里面再增加 if-else 逻辑，基本没有扩展性。</p>
<p>所以我们需要优化的点就是，把「遍历逻辑」和「指令逻辑」分开，这样就易于我们扩展新指令。</p>
<p>要解耦，想想有啥设计模式合适，遍寻23种设计模式，<a href="https://refactoring.guru/design-patterns/visitor">访问者(Vistor)模式 </a>就很合适用来做解耦遍历逻辑和指令逻辑.</p>

<figure>
    
    
    <input type="checkbox" id="zoomCheck-9802c" hidden>
    <label for="zoomCheck-9802c">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/reinvent_vistor_pattern.jpg"/> 
    
    
    </label>
</figure>

<p>不了解 Vistor 模式的同学可以先看下这篇<a href="https://refactoring.guru/design-patterns/visitor">文章</a>, 而Rust 非常著名的序列化框架 <a href="https://serde.rs">Serde</a> 就通过 <a href="https://serde.rs/impl-deserialize.html">Vistor</a> 模式可以让用户自定义如何序列化或反序列化某种类型的数据。</p>
<h3 id="接口设计"><span class="section-num">3.3</span> 接口设计</h3>
<p>既然选定了 <code>Vistor</code> 模式，那么就让我们来设计具体的接口。</p>
<p><code>Vistor</code> 接口类，接受某个 DOM 元素作为根节点，然后通过 <code>walk</code> 函数遍历给定的节点，或者节点为空则遍历根节点:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">Node</span><span class="p">,</span> <span class="nx">NodeWithChildren</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&#34;domhandler&#34;</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">abstract</span> <span class="kr">class</span> <span class="nx">Visitor</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">private</span> <span class="nx">root</span><span class="o">:</span> <span class="nx">Node</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">constructor</span><span class="p">(</span><span class="nx">root</span><span class="o">:</span> <span class="nx">Node</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">root</span> <span class="o">=</span> <span class="nx">root</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">walk</span><span class="p">(</span><span class="nx">node</span><span class="o">:</span> <span class="nx">Node</span> <span class="o">=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">node</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">node</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">root</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="nx">node</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">node</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">child</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">walk</span><span class="p">(</span><span class="nx">child</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">close</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// handler to be called when first arrive at a node
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kr">abstract</span> <span class="nx">open</span><span class="p">(</span><span class="nx">node</span><span class="o">:</span> <span class="nx">Node</span><span class="p">)</span><span class="o">:</span> <span class="kr">boolean</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// handler to be called when finished with a node
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kr">abstract</span> <span class="nx">close</span><span class="p">(</span><span class="nx">node</span><span class="o">:</span> <span class="nx">Node</span><span class="p">)</span><span class="o">:</span> <span class="k">void</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>其中的 <code>open</code> 函数用于在进入一个节点时被调用，相当于是在前序位置被调用，返回值来表现是否需要遍历其子节点；而 <code>close</code> 函数在离开一个节点前，即相当于后序位置被调用。</p>
<p>关于二叉树的前序位置和后序位置，可见这篇讲解二叉树算法的<a href="https://labuladong.online/algo/essential-technique/binary-tree-summary/#%E4%BA%8C%E5%8F%89%E6%A0%91%E7%9A%84%E9%87%8D%E8%A6%81%E6%80%A7">文章</a></p>
<p><code>Vistor</code> 算法里面的关键即是实现「遍历逻辑」与「每个节点处理逻辑」的解耦，遍历逻辑我们已经实现在 <code>Vistor</code> 基类了，现在就需要实现一个具体的子类来表示节点的处理逻辑:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">enum</span> <span class="nx">HandlerType</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">If</span> <span class="o">=</span> <span class="s1">&#39;z-if&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">Loop</span> <span class="o">=</span> <span class="s1">&#39;z-loop&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">Num</span> <span class="o">=</span> <span class="s1">&#39;z-num&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">Var</span> <span class="o">=</span> <span class="s1">&#39;z-var&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">HANDLERS</span><span class="o">:</span> <span class="nx">Record</span><span class="o">&lt;</span><span class="nx">HandlerType</span><span class="p">,</span> <span class="nx">NodeHandler</span><span class="o">&gt;</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nx">HandlerType</span><span class="p">.</span><span class="nx">If</span><span class="p">]</span><span class="o">:</span> <span class="k">new</span> <span class="nx">IfHandler</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nx">HandlerType</span><span class="p">.</span><span class="nx">Loop</span><span class="p">]</span><span class="o">:</span> <span class="k">new</span> <span class="nx">LoopHandler</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nx">HandlerType</span><span class="p">.</span><span class="nx">Num</span><span class="p">]</span><span class="o">:</span> <span class="k">new</span> <span class="nx">NumHandler</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nx">HandlerType</span><span class="p">.</span><span class="nx">Var</span><span class="p">]</span><span class="o">:</span> <span class="k">new</span> <span class="nx">VarHandler</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">class</span> <span class="nx">Expander</span> <span class="kr">extends</span> <span class="nx">Visitor</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">public</span> <span class="nx">env</span><span class="o">:</span> <span class="nx">Env</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kr">private</span> <span class="nx">handlers</span><span class="o">:</span> <span class="nx">Record</span><span class="o">&lt;</span><span class="nx">HandlerType</span><span class="p">,</span> <span class="nx">NodeHandler</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="kr">private</span> <span class="nx">result</span><span class="o">:</span> <span class="nx">string</span><span class="p">[]</span>
</span></span><span class="line"><span class="cl">  <span class="nx">constructor</span><span class="p">(</span><span class="nx">root</span><span class="o">:</span> <span class="nx">Node</span><span class="p">,</span> <span class="nx">vars</span><span class="o">:</span> <span class="nb">Object</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">super</span><span class="p">(</span><span class="nx">root</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">env</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Env</span><span class="p">(</span><span class="nx">vars</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">handlers</span> <span class="o">=</span> <span class="nx">HANDLERS</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">result</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">open</span><span class="p">(</span><span class="nx">node</span><span class="o">:</span> <span class="nx">Node</span><span class="p">)</span><span class="o">:</span> <span class="kr">boolean</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;text&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">textNode</span> <span class="o">=</span> <span class="nx">node</span> <span class="nx">as</span> <span class="nx">Text</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">this</span><span class="p">.</span><span class="nx">output</span><span class="p">(</span><span class="nx">textNode</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">hasHandler</span><span class="p">(</span><span class="nx">node</span> <span class="nx">as</span> <span class="nx">Element</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">getHandler</span><span class="p">(</span><span class="nx">node</span> <span class="nx">as</span> <span class="nx">Element</span><span class="p">).</span><span class="nx">open</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">node</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">this</span><span class="p">.</span><span class="nx">showTag</span><span class="p">(</span><span class="nx">node</span> <span class="nx">as</span> <span class="nx">Element</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">close</span><span class="p">(</span><span class="nx">node</span><span class="o">:</span> <span class="nx">Node</span><span class="p">)</span><span class="o">:</span> <span class="kr">boolean</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;text&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;tag&#39;</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">hasHandler</span><span class="p">(</span><span class="nx">node</span> <span class="nx">as</span> <span class="nx">Element</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">this</span><span class="p">.</span><span class="nx">getHandler</span><span class="p">(</span><span class="nx">node</span> <span class="nx">as</span> <span class="nx">Element</span><span class="p">).</span><span class="nx">close</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">node</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">this</span><span class="p">.</span><span class="nx">showTag</span><span class="p">(</span><span class="nx">node</span> <span class="nx">as</span> <span class="nx">Element</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 判断是否有 z-* 属性对应的指令处理器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">hasHandler</span><span class="p">(</span><span class="nx">node</span><span class="o">:</span> <span class="nx">Element</span><span class="p">)</span><span class="o">:</span> <span class="kr">boolean</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">name</span> <span class="k">in</span> <span class="nx">node</span><span class="p">.</span><span class="nx">attribs</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nx">name</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">handlers</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">getHandler</span><span class="p">(</span><span class="nx">node</span><span class="o">:</span> <span class="nx">Element</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">possible</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">attribs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">name</span> <span class="p">=&gt;</span> <span class="nx">name</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">handlers</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">assert</span><span class="p">(</span><span class="nx">possible</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Should be exactly one handler&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">handlers</span><span class="p">[</span><span class="nx">possible</span><span class="p">[</span><span class="mi">0</span><span class="p">]];</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 将 tag 标签及属性输出到 output 去，但排除 `z-` 开头的指令
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">showTag</span><span class="p">(</span><span class="nx">node</span><span class="o">:</span> <span class="nx">Element</span><span class="p">,</span> <span class="nx">closing</span><span class="o">:</span> <span class="kr">boolean</span><span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">output</span><span class="p">(</span><span class="nx">text</span><span class="o">:</span> <span class="nx">string</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">((</span><span class="nx">text</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;UNDEF&#39;</span> <span class="o">:</span> <span class="nx">text</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>Expander</code> 的逻辑也并不复杂，每次遍历到一个 <code>DOM</code> 元素的时候，通过元素类似执行对应的操作，如果是 <code>z-</code> 开头的指令，就看下能否找到对应指令的处理器:</p>

<figure>
    
    
    <input type="checkbox" id="zoomCheck-e5861" hidden>
    <label for="zoomCheck-e5861">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/reinvent_expander_design.png"/> 
    
    
    </label>
</figure>

<p>仔细观察代码会发现，不同的指令对应的处理器实现了 <code>NodeHandler</code> 接口，定义在前序位置和后序位置处理节点的逻辑，并按指令名保存在 <code>HANDLER</code> 中：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">interface</span> <span class="nx">NodeHandler</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">open</span><span class="p">(</span><span class="nx">expander</span><span class="o">:</span> <span class="nx">Expander</span><span class="p">,</span> <span class="nx">node</span><span class="o">:</span> <span class="nx">Element</span><span class="p">)</span><span class="o">:</span> <span class="kr">boolean</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">close</span><span class="p">(</span><span class="nx">expander</span><span class="o">:</span> <span class="nx">Expander</span><span class="p">,</span> <span class="nx">node</span><span class="o">:</span> <span class="nx">Element</span><span class="p">)</span><span class="o">:</span> <span class="k">void</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这就意味着，如果需要增加一个新的指令，该指令处理器只需要实现 <code>NodeHandler</code> 接口，并添加到 <code>HANDLER</code> 即可，不需要改动其他的已有代码，我们就实现了「遍历逻辑」与「指令逻辑」的解耦。</p>
<h2 id="实现"><span class="section-num">4</span> 实现</h2>
<h3 id="支持的指令集"><span class="section-num">4.1</span> 支持的指令集</h3>
<p>不同的指令集的差别只是如何实现 <code>open</code> 和 <code>close</code> 逻辑，我就不一一赘述了，已支持的指令集及实现列表如下：</p>
<table>
  <thead>
      <tr>
          <th>指令</th>
          <th>作用</th>
          <th>实现</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>z-if</code></td>
          <td>条件渲染，值为false时移除元素</td>
          <td><a href="https://github.com/ramsayleung/reinvent/blob/master/page_templates/z-if.ts">z-if.ts</a></td>
      </tr>
      <tr>
          <td><code>z-include</code></td>
          <td>引入外部HTML文件内容</td>
          <td><a href="https://github.com/ramsayleung/reinvent/blob/master/page_templates/z-include.ts">z-include.ts</a></td>
      </tr>
      <tr>
          <td><code>z-iteration</code></td>
          <td>数字迭代，生成序列内容</td>
          <td><a href="https://github.com/ramsayleung/reinvent/blob/master/page_templates/z-iteration.ts">z-iteration.ts</a></td>
      </tr>
      <tr>
          <td><code>z-literal</code></td>
          <td>保留元素原始属性不解析</td>
          <td><a href="https://github.com/ramsayleung/reinvent/blob/master/page_templates/z-literal.ts">z-literal.ts</a></td>
      </tr>
      <tr>
          <td><code>z-loop</code></td>
          <td>循环遍历数组生成元素内容</td>
          <td><a href="https://github.com/ramsayleung/reinvent/blob/master/page_templates/z-loop.ts">z-loop.ts</a></td>
      </tr>
      <tr>
          <td><code>z-num</code></td>
          <td>直接输出数字值到元素内容</td>
          <td><a href="https://github.com/ramsayleung/reinvent/blob/master/page_templates/z-num.ts">z-num.ts</a></td>
      </tr>
      <tr>
          <td><code>z-snippet</code></td>
          <td>定义可复用的HTML片段</td>
          <td><a href="https://github.com/ramsayleung/reinvent/blob/master/page_templates/z-snippet.ts">z-snippet.ts</a></td>
      </tr>
      <tr>
          <td><code>z-trace</code></td>
          <td>打印变量值到控制台（调试用）</td>
          <td><a href="https://github.com/ramsayleung/reinvent/blob/master/page_templates/z-trace.ts">z-trace.ts</a></td>
      </tr>
      <tr>
          <td><code>z-var</code></td>
          <td>将变量值输出到元素内容</td>
          <td><a href="https://github.com/ramsayleung/reinvent/blob/master/page_templates/z-var.ts">z-var.ts</a></td>
      </tr>
  </tbody>
</table>
<h3 id="示例"><span class="section-num">4.2</span> 示例</h3>
<p>假设有数据如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">vars</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;firstVariable&#34;</span><span class="o">:</span> <span class="s2">&#34;firstValue&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;secondVariable&#34;</span><span class="o">:</span> <span class="s2">&#34;secondValue&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;variableName&#34;</span><span class="o">:</span> <span class="s2">&#34;variableValue&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;showThis&#34;</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;doNotShowThis&#34;</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;names&#34;</span><span class="o">:</span> <span class="p">[</span><span class="s2">&#34;Johnson&#34;</span><span class="p">,</span> <span class="s2">&#34;Vaughan&#34;</span><span class="p">,</span> <span class="s2">&#34;Jackson&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="z-num"><span class="section-num">4.2.1</span> z-num</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;&lt;</span><span class="nt">span</span> <span class="na">z-num</span><span class="o">=</span><span class="s">&#34;123&#34;</span><span class="p">/&gt;&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>模板展开如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;&lt;</span><span class="nt">span</span><span class="p">&gt;</span>123<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="z-var"><span class="section-num">4.2.2</span> z-var</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;&lt;</span><span class="nt">span</span> <span class="na">z-var</span><span class="o">=</span><span class="s">&#34;variableName&#34;</span><span class="p">/&gt;&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>模板展开如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;&lt;</span><span class="nt">span</span><span class="p">&gt;</span>variableValue<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="z-if"><span class="section-num">4.2.3</span> z-if</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">p</span> <span class="na">z-if</span><span class="o">=</span><span class="s">&#34;showThis&#34;</span><span class="p">&gt;</span>This should be shown.<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">p</span> <span class="na">z-if</span><span class="o">=</span><span class="s">&#34;doNotShowThis&#34;</span><span class="p">&gt;</span>This should <span class="p">&lt;</span><span class="nt">em</span><span class="p">&gt;</span>not<span class="p">&lt;/</span><span class="nt">em</span><span class="p">&gt;</span> be shown.<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>模板展开如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>This should be shown.<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="z-loop"><span class="section-num">4.2.4</span> z-loop</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>Expect three items<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">ul</span> <span class="na">z-loop</span><span class="o">=</span><span class="s">&#34;item:names&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">span</span> <span class="na">z-var</span><span class="o">=</span><span class="s">&#34;item&#34;</span><span class="p">/&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>模板展开如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>Expect three items<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">span</span><span class="p">&gt;</span>Johnson<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">span</span><span class="p">&gt;</span>Vaughan<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">span</span><span class="p">&gt;</span>Jackson<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="z-include"><span class="section-num">4.2.5</span> z-include</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;&lt;</span><span class="nt">span</span> <span class="na">z-var</span><span class="o">=</span><span class="s">&#34;variableName&#34;</span><span class="p">/&gt;&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">z-include</span><span class="o">=</span><span class="s">&#34;simple.html&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>simple.html</code> :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>First<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>Second<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>模板展开如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;&lt;</span><span class="nt">span</span><span class="p">&gt;</span>variableValue<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>First<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>Second<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>更多的<a href="https://github.com/ramsayleung/reinvent/blob/master/__tests__/page_template/expander-test.ts">示例可见</a></p>
<h2 id="总结"><span class="section-num">5</span> 总结</h2>
<p>模板引擎的本质，是帮我们把重复的页面结构抽离出来，而内容与表现的分离(Separation of content and presentation)，可以让我们以数据来填充变化的内容。</p>
<p>这是程序员对「Don&rsquo;t Repeat Yourself」原则最直观的践行。</p>
<p>三十年来，开发者们创造了无数种实现方案，但核心思路始终围绕着前文提到的三种基本模式。</p>
<p>如今即便在最流行的 Vue 或 React 框架中，无论你写的是 <code>JSX</code> 或是 <code>v-*</code> 指令，背后的思路仍万变不离其宗，本质上仍在沿用模板引擎的思想。</p>
<p>而这种「结构复用，数据驱动」的理念，也早已成为Web开发的根基。</p>
<p><a href="/zh/post/2025/reinvent_project/">回到本系列的目录</a></p>
<h2 id="参考"><span class="section-num">6</span> 参考</h2>
<ul>
<li><a href="https://refactoring.guru/design-patterns/visitor">https://refactoring.guru/design-patterns/visitor</a></li>
<li><a href="https://serde.rs/impl-deserialize.html">https://serde.rs/impl-deserialize.html</a></li>
<li><a href="https://third-bit.com/sdxjs/page-templates/">https://third-bit.com/sdxjs/page-templates/</a></li>
</ul>
]]></content:encoded>
    </item>
    <item>
      <title>《过河卒》: 比特币雏形之父之父的故事</title>
      <link>https://ramsayleung.github.io/zh/post/2025/%E8%BF%87%E6%B2%B3%E5%8D%92/</link>
      <pubDate>Wed, 09 Apr 2025 23:08:00 -0700</pubDate>
      <guid>https://ramsayleung.github.io/zh/post/2025/%E8%BF%87%E6%B2%B3%E5%8D%92/</guid>
      <description>&lt;h2 id=&#34;缘起&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;1&lt;/span&gt; 缘起&lt;/h2&gt;
&lt;p&gt;在《软件那些事儿》播客采访听众故事的系列里面，有一期名为《&lt;a href=&#34;https://podcasts.apple.com/us/podcast/no-502-%E8%B7%9F35%E5%B2%81%E7%9A%84%E7%A8%8B%E5%BA%8F%E5%91%98%E8%81%8A%E8%81%8A%E6%AF%94%E7%89%B9%E5%B8%81/id1147186605?i=1000697534091&#34;&gt;No.502 跟35岁的程序员聊聊比特币&lt;/a&gt;》&lt;sup id=&#34;fnref:1&#34;&gt;&lt;a href=&#34;#fn:1&#34; class=&#34;footnote-ref&#34; role=&#34;doc-noteref&#34;&gt;1&lt;/a&gt;&lt;/sup&gt; 长达三个多小时的播客，主人公分享自己与比特币的故事，还谈到其在2020年卖房买比特币的故事。&lt;/p&gt;</description>
      <content:encoded><![CDATA[<h2 id="缘起"><span class="section-num">1</span> 缘起</h2>
<p>在《软件那些事儿》播客采访听众故事的系列里面，有一期名为《<a href="https://podcasts.apple.com/us/podcast/no-502-%E8%B7%9F35%E5%B2%81%E7%9A%84%E7%A8%8B%E5%BA%8F%E5%91%98%E8%81%8A%E8%81%8A%E6%AF%94%E7%89%B9%E5%B8%81/id1147186605?i=1000697534091">No.502 跟35岁的程序员聊聊比特币</a>》<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup> 长达三个多小时的播客，主人公分享自己与比特币的故事，还谈到其在2020年卖房买比特币的故事。</p>
<p>既钦佩这位仁兄知行合一的投资理念，也羡慕他卖房买比特币的财力，胆识与机遇。</p>
<p>这位同行在节目结束前分享了一本名为《过河卒》<sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup>的书籍，其作者戴习为是文革前就读于中国科技大学电子系的高材生。</p>
<p>为什么他会在聊比特币故事的播客节目中提及这位书呢？</p>
<p>因为比特币的作者中本聪的第一封<a href="https://www.bitcoin.com/satoshi-archive/emails/wei-dai/1/">已知公开的邮件</a><sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup>，即讨论比特币白皮书草稿的邮件，就是发给戴习为之子，<a href="http://www.weidai.com/">戴维</a> <sup id="fnref:4"><a href="#fn:4" class="footnote-ref" role="doc-noteref">4</a></sup>的:</p>
<p>戴维的项目 <a href="http://www.weidai.com/bmoney.txt">b-money</a> <sup id="fnref:5"><a href="#fn:5" class="footnote-ref" role="doc-noteref">5</a></sup>与比特币有诸多的相似之处，甚至可以称为比特币的雏形, 所以中本聪在白本书中引用了 b-money , 原文:</p>
<blockquote>
<p>I was very interested to read your b-money page.  I&rsquo;m getting ready to release a paper that expands on your ideas into a complete working system.</p></blockquote>
<p>而戴维是著名的密码学专家，在大一的时候就写出了被诸多公司和开源项目使用的支持多种加密算法的C++加密库 <a href="https://cryptopp.com/">Cryptocpp</a> <sup id="fnref:6"><a href="#fn:6" class="footnote-ref" role="doc-noteref">6</a></sup></p>
<p>虽然错过了买比特币的致富之路，但是多读点书，多学点知识终究是不会晚的，所以对《过河卒》这本书产生了浓厚的兴趣，不到一周就读完了。</p>
<h2 id="太平洋两岸"><span class="section-num">2</span> 太平洋两岸</h2>
<h3 id="年少时分"><span class="section-num">2.1</span> 年少时分</h3>
<p>戴习为（下文称老戴）生于1947年，比共和国还要年长2岁，其祖父为武汉名医，
父亲亦师承其父，学得一手好医术，又学过高能物理，还是少数能扣操流利英语和日语的人材，母亲为中学教师。</p>
<p>老戴说起来是湖北人，但实际并没有在湖北生活过，满月不久就随父母迁居湖南长沙, 到1956年，老戴独自一人离开了父母，到北京投奔了奶奶。</p>
<p>年少时的老戴对一切都充满好奇心，9岁的时候，他决定做一个属于自己的矿石收音机，
费尽九牛二虎之力终于成功，当他在自制的收音机里面听到《杨家将》的评书时，心中那份得意就别提了。</p>
<p>初中时候，老戴通过杂志，自制了一台有两个直流电子管的再生式便携式收音机，
不久后他凭借同龄人中明显的技术优势考进了北海公园内的中国少年科技馆，拥有了帝王才可免费享用的北海公园。</p>
<p>1964年，毛主席再次发出以阶级斗争为纲的路线指引，教育界在批判了1962年，1963年以「智育第一」的错误招生倾向后，
提出了1964年的高考招生要优先选拔工人，贫下中农的子弟，教育要为无产阶级政治服务。</p>
<p>而对那些非红五类家庭出身的考生而言，如果又不是党团员，
那么他们只有表现得格外优秀才可能赢得本属于你的权利。</p>
<p>而对于家境殷实的老戴家庭而言，虽然没有被打为「地主阶级」之类的黑五类，但也被毕业鉴定上写上了「学习目的不明确」的标语。</p>
<p>但偏偏不信邪的老戴除了刻苦学习，还把目标放在了中国科技大学，因为班主任每次和他谈话结束都要加句：
「像你这样的表现科技大学能收你吗？」，在当时，中科大专业设置和毕业后的去向对家庭出身的要求要比清华，北大更苛刻。</p>
<p>发榜之后，他如愿考上了中国科技大学的电子系，1964年的中科大，含金量可见一斑。</p>
<h3 id="大学时光"><span class="section-num">2.2</span> 大学时光</h3>
<p>在中科大读了两年大学之后，阅读了各种书籍之后，文革爆发。</p>
<p>在文革初期，红卫兵们流行「大串联」，即大中学生红卫兵组织或个人为主体，在全国范围内免费乘车，接待（食宿），
互相串联，交流和宣传造反的活动。</p>
<p>但老戴作为「逍遥派」，对政治活动并没有太多兴趣，他却利用了「大串联」的机会，游历起了祖国的大江南北：
从北京到广州，从广州到杭州，再从杭州到上海。</p>
<p>又尝试过「星火燎原」之行，从北京步行到上海。</p>
<h3 id="走进社会"><span class="section-num">2.3</span> 走进社会</h3>
<p>毕业之后，老戴和其同学兼女友被分配到商丘的军队参军两年，而后复业在商丘无线电厂参加了三年工作, 机缘巧合之下被调至中科院天文台，参加天文台的建设。</p>
<p>后来，为了解决北京户口问题，老戴与妻子借调到了新组建的科学院空间科学技术中心，
没想到困扰无数北漂的户口问题，在上世纪七十年代的时候，也同样困扰着像老戴之样的高材生。</p>
<p>老戴在任期间，陪同妻子，完成了新部门「地面部」的搭建，并出色地完成密云遥感卫星地面接收站的选址与建设，至今仍发光发热。</p>
<p>1977年，中国恢复了高考，1978年，中国恢复了研究生招考，1979年，第一批留学生选派出国。</p>
<p>1981年，时年34岁，担任快视课题组组长的老戴决定出国，申请了东北大学应用数学系公派自费的博士，并「幸运」被录取。</p>
<h3 id="留学美利坚"><span class="section-num">2.4</span> 留学美利坚</h3>
<p>仅身揣20美元的老戴，在美国举目无亲的老戴，登上飞往美国的飞机。</p>
<p>按照老戴的说法，像他这一拨在举国上下一穷二白的大旗下长大的一代，没钱的好处就是做任何决定时，钱的分量也不重。</p>
<p>他在波士顿的第一晚，是在美国「派出所」的沙发上度过了，虽然东北大学减免了学费，但并未提供任何的生活费的。</p>
<p>因此在「朋友的朋友的朋友」的介绍下，
老戴在名为「杭州楼」的餐馆后来做起了包食住，无工资的工作，过上了白天上课读书，晚上工作帮厨的生活, 老戴称之为「洋插队」.</p>
<p>34岁的老戴在东北大学攻读博士，先在应用数学系研究数学，后转向计算机系，研究并行计算，但历经4年都未有突破性进展，
也未有影响力的论文发表，老戴陷入进退两难的局面。</p>
<p>因此39岁的时候，老戴不想再等待了，于东北大学博士缀学, 重新步入社会，自个刨食。</p>
<h3 id="创业种种"><span class="section-num">2.5</span> 创业种种</h3>
<p>老戴先是与朋友合伙，为华人公司定制中文系统，却不料受朋友坑骗，公司破产，还牵涉到一桩官司；</p>
<p>后来老戴与一名博士合并开发并行电脑，但历时一年未果，最后净身离开；后又与朋友合作于加拿大，结果不欢而散。</p>
<p>鉴于种种与人合作的失败经历，老戴决定自己单干，开发模式识别系统，用于电脑识别手写的文字与语音，后被仅此于IBM的第二大电脑公司 DEC 赏识，重金招募至麾下。</p>
<p>90年代，PC电脑风起云涌，日新月异，以Window + Intel 的Wintel 联盟强势崛起，以小型机为主的 DEC 不得不裁员应对，老戴也恰逢时分，离开 DEC，创立自己的 DTech 公司单干，专注手写文字与语音识别。</p>
<p>而当时华尔街正吹起了「笔电脑」的风，使用「笔」作为输入设备的电脑，而识别输入文字自然成为「笔电脑」必不可少的功能，老戴的 DTech 凭借其技术优势，成为了「风口上的猪」，苹果，微软，IBM纷纷递来橄榄枝。</p>
<p>最后，在比尔盖茨的亲自决策下，以「x位数」的价格收购了 DTech, 老戴也就顺势入职微软，成为总经理，后来领导了打赢IBM与苹果的笔电脑战役。</p>
<p>虽然老戴未透露「x位数」的具体数额，但是相信肯定是超过千万美元级别，90年代的千万美元也足以一辈子生活富足无忧了。</p>
<p>在1994年，比尔盖茨首次访华，老戴作为唯一的随员相随，陪同比尔盖茨会见了中国相关的领导人。</p>
<h2 id="感悟"><span class="section-num">3</span> 感悟</h2>
<h3 id="将相本无种-书成自有神"><span class="section-num">3.1</span> 将相本无种，书成自有神</h3>
<p>读完老戴的同事，让我总是会想起之前读的一本书：<a href="https://ramsayleung.github.io/zh/post/2024/%E8%B5%B0%E5%87%BA%E6%88%88%E5%A3%81/">《走出戈壁》：从沙漠苦力到常青藤教授</a> <sup id="fnref:7"><a href="#fn:7" class="footnote-ref" role="doc-noteref">7</a></sup>, 作者从小学未毕业戈壁的苦力，一直努力到成为常青藤的教授，老戴也是类似的经历。</p>
<p>虽然努力并不一定能成功，毕竟汗水，才华，运气都是成功不可或缺的因素，但是没有能力，机会即使飞到你面前，你也无法抓住。</p>
<p>读完全书，令我印象深刻的是两件关于读书的事:</p>
<p>1970年，在河南商丘无线电厂工作的老戴，工作之余，仍不忘学习，不断收集在那个时代与那个环境能够找到的新技术书籍，
不久，一门新的技术「数字电路与计算机」开始吸引并迷住了老戴。</p>
<p>作为一个学习过程，老戴争取机会，在一个与河南省的轻工技术研究所合作改造商丘市一个玻璃瓶厂的程序控制的工程中，
担当了数字电子技术这一部分的技术骨干，并出色完成了这一项目。</p>
<p>从此，老戴从一个学习模拟电子技术的工程师开始走进了数字时代。</p>
<p>在1988年，老戴在并行公司创业失败离开时，他充满了苦涩，他开始怀疑自己，对自己的命运是否期许过高，他不断地问自己，
或许他是那只在田地里不断掰玉米的狗熊? 是那只饶有兴致在水中捞着月亮的猴子?</p>
<p>他想起自己在美国学了4年的数学，学习了并行计算机的理论与算法，他还想起了自己在1976年唐山大地震的时候，
他还住在北京地震棚时，苦读过一番的《数字图像处理》，《傅里叶光学》与《模式识别理论》​。</p>
<p>他决定凭借曾经苦读的知识，使用模式识别来识别手写文字与语音, 最终成就了 DTech 公司.</p>
<p>「狐狸固然吃不到高架上的葡萄，但它可以在矮架上种上一棵」，来自「吃不了葡萄说葡萄酸」故事的启发。</p>
<h3 id="家庭的影响"><span class="section-num">3.2</span> 家庭的影响</h3>
<p>对于老戴的成功，其努力自然不容置喙, 但是我现在越发觉得个人的成就不仅和个人的努力及才华相关，还与其家庭息息相关，环境对个人成长太重要了。</p>
<p>古人也是类似的看法，不然孟母又何必三迁呢。</p>
<p>而作为被中本聪引用的论文作者戴维(下称小戴)，身为中国第一代程序员的父母对其影响不可谓不大。</p>
<p>小戴80年代就能接触并学习编程，以至于在小学时期，就能帮一个台湾来美的研究生做数据结构的作业；</p>
<p>初二时，小戴与大多数孩子一样，开始了暑假打工生涯，不同的是，在其他同龄人只能选择在社区送报纸，擦洗车之类的工作时。</p>
<p>小戴跑到了妈妈正在工作的，一个为全球几大石油公司提供油井数据分析的石油软件公司当程序员。</p>
<p>小戴用C语言写了一个子程序：</p>
<p>将公司软件产品中正在使用的，因不同类的客户机器而使用的不同格式的浮点数据转换成IEEE规定的标准格式浮点数据，
使本公司产品与其他公司产品的数据衔接更方便。</p>
<p>高一时，小戴即被学生推荐到哈佛大学计算机系选修课程，并计入学分，被由中学（实际是州政府）支付学费，
理论上，小戴可以在高中毕业的同时在哈佛大学毕业，类似国内的少年班。</p>
<p>在高中毕业后，小戴非常轻松地被华盛顿州立大学的计算机系录取，华大的计算系可以在全美排前十的。</p>
<p>小戴在大一的时候，用 C++ 实现了一个涵盖已公开发表过的主要加密与解密算法的软件库，
成为北美第一个被全民共享，而已至今仍被全世界（包括中国）广泛使用的加解密算法库。</p>
<p>读过计算机专业的同学应该听过一句名言：不要实现你自己的加解密算法库（和共识算法库），因为非常难实现正确，一旦出问题后果又非常严重。</p>
<p>所以小戴的水平可想而知。</p>
<h3 id="大厂感悟"><span class="section-num">3.3</span> 大厂感悟</h3>
<p>书中还有不少篇幅是描写在微软的工作体验，这让我这个从毕业起就在国内外大厂后辈非常有感悟，其实都是一样的。</p>
<p>微软有着非常好的员工福利，有着委托给星级酒店的食堂，弹性的上下班时间，
有非常优美的园区，非常自由和充满活力的文化氛围。</p>
<p>除不考勤上下班时间之外，公司还从早10点到下午2点，每一小时一趟的班车，在园区内与园区边设备豪华的健身俱乐部间穿梭。</p>
<p>公司支付健身的一切费用，员工可游泳，或网球……，活动筋骨，锻炼身体;一年四季，或小组，或大组，或整个公司，三日一小宴，五日一大宴。</p>
<p>美食美酒，Party不断; 新上影的电影、热门棒球赛、NBA篮球赛、橄榄球大赛、歌星演唱会，公司赠票给员工全家，请你务必赏光。</p>
<p>一年三百六十五天，公司开满了各式各样的进修课程，鼓励诸位踊跃参加。</p>
<p>如诸位能大体上不影响日常工作，而学校又肯收你，读博士、读硕士，公司均乐于为你支付学费。</p>
<p>听起来真是神仙过的日子。</p>
<p>甚至过年的时候包下了几百英亩的地方来搞年会，把加拿大马术队，奥林匹克跳伞队也请过来表演。</p>
<p>但是公司终究不是疗养院，公司更不可能养大爷，任务已经明确了，只是为了让工程师们能赶上 milestone (也就是 deadline)</p>
<p>好酒好饭无非是让你上阵时精力充沛、生龙活虎罢了。就如同那第一流的奶牛场，请你听音乐，给你做按摩，为的是请你多出牛奶。</p>
<p>更何况，羊毛出自羊身上，微软给的薪资只有同期硅谷同行的一半略多，直到现在也是如此，也难怪人送外号「花生厂」(薪水相对较低的戏称).</p>
<p>而弹性上下班，就可以加班不给加班费了。</p>
<p>更何况，现在不流行给奶牛弹音乐，做按摩来多产奶了，现在流行用鞭子抽奶牛，还威胁奶牛，不多产奶就以绩效差把你开了，让你自生自灭。</p>
<p>对于 milestone, 弹性加班之类的「资本主义把戏」，我是再熟悉不过了。</p>
<p>我在<a href="https://ramsayleung.github.io/zh/post/2023/%E4%BB%8E%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98%E7%A6%BB%E7%BA%BF_%E6%88%91%E5%B8%A6%E8%B5%B0%E4%BA%86%E4%BB%80%E4%B9%88/">微信支付</a> <sup id="fnref:8"><a href="#fn:8" class="footnote-ref" role="doc-noteref">8</a></sup>的时候，微信支付推行的是所谓的「精益迭代」研发模式，
大意每两周作为一个周期，把任务拆分到能两周内完成的颗粒度，
在第二周的周五进行「复盘」，由领导（或是经理，或是总监）开会对着需求单与工程师逐个核对进度。</p>
<p>也就意味着每两周就有一次 deadline, 完成这两周的任务并不能影响下一个两周的任务的轮转，迭代总是周而复始，直到你被滚动的车轮碾碎。</p>
<p>任务太大怎么办，总能拆小的，两周总要交付什么东西的。</p>
<p>没有完成怎么办？不用担心，你总可以想办法完成的, 不然要怎么向领导交待呢, 这些都是数据和指标。</p>
<p>这样洗礼了三年后，现在无论多少任务，都有种羽扇纶巾，谈笑间，需求灰飞烟灭的淡定从容了。</p>
<h3 id="better-than-before"><span class="section-num">3.4</span> Better than before</h3>
<p>老戴通过自己的经历告诉我们:</p>
<p>无论是白人，黑人，黄种人，无论在农村还是城市，也无论是出生在穷家还是富户，追求成功的人们，只要你努力，只要你执着，做得到的。</p>
<p>社会对成功的定义往往固化,「出将入相」「成名成家」「腰缠万贯」，但「将相本无种」，真正的成功，是超越昨天的自己。</p>
<p>过好每一个今天，就是通往成功的路。 立足当下，辨明方向，踮起脚尖，哪怕只比昨天前进一寸。</p>
<p>这或许像「鸡汤」，但真理往往朴素，从翻开一本书、迈出第一步开始，让身体或思想始终在路上。</p>
<p>秉持「Better than before」的信念，「卒子」一步步向前，直到跨过那条「河」，化身为「车」.</p>
<p>如卒过河，日拱一卒，终有一日，平凡亦可蜕变为非凡。</p>
<h2 id="推荐阅读">推荐阅读</h2>
<ul>
<li>旅加经历
<ul>
<li><a href="https://ramsayleung.github.io/zh/post/2023/%E8%BF%99%E4%BA%9B%E5%B9%B4%E8%B5%B0%E8%BF%87%E7%9A%84%E8%B7%AF_%E4%BB%8E%E5%B9%BF%E5%B7%9E%E5%88%B0%E6%B8%A9%E5%93%A5%E5%8D%8E/">这些年走过的路：从广州到温哥华</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2023/%E5%8A%A0%E6%8B%BF%E5%A4%A7%E4%B9%8B%E5%88%9D%E4%BD%93%E9%AA%8C/">加拿大之初体验</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2024/%E7%99%BB%E9%99%86%E5%8A%A0%E6%8B%BF%E5%A4%A7%E4%B8%80%E5%B9%B4%E7%9A%84%E4%BD%93%E4%BC%9A/">登陆加拿大一年后的体会</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2024/%E5%A4%8F%E6%97%A5%E6%8D%95%E8%9F%B9%E8%AE%B0/">夏日捕蟹记</a></li>
</ul>
</li>
<li>历史思考
<ul>
<li><a href="https://ramsayleung.github.io/zh/post/2023/%E7%BD%AE%E8%BA%AB%E4%BA%8B%E5%86%85/">为什么梦想买不起，故乡回不去</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2023/%E9%97%B2%E8%81%8A%E5%86%99%E4%BD%9C/">闲聊写作的好处</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2024/%E9%87%91%E6%A6%9C%E9%A2%98%E5%90%8D%E4%B9%8B%E5%90%8E/">金榜题名之后</a></li>
</ul>
</li>
<li>工具流分享
<ul>
<li><a href="https://ramsayleung.github.io/zh/post/2024/%E7%AE%80%E6%98%8E%E5%86%99%E4%BD%9C%E6%8C%87%E5%8D%97/">简明写作指南</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2023/%E6%88%91%E7%9A%84%E5%86%99%E4%BD%9C%E6%B5%81/">我的写作流</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2023/%E6%88%91%E7%9A%84%E7%94%BB%E5%9B%BE%E6%B5%81/">我的画图流：画图工具与技巧分享</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2023/%E6%88%91%E7%9A%84%E6%90%9C%E7%B4%A2%E6%B5%81/">我的搜索流：高效搜索经验分享</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2022/feynman_technique/">最好的学习方式：费曼学习法(Feynman Technique)</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2021/%E7%B3%BB%E7%BB%9F%E6%80%9D%E8%80%83/">系统思考：既见树木，又见森林</a></li>
</ul>
</li>
<li>职场思考
<ul>
<li><a href="https://ramsayleung.github.io/zh/post/2024/%E7%BC%96%E7%A8%8B%E5%8D%81%E5%B9%B4%E7%9A%84%E6%84%9F%E6%82%9F/">编程十年的感悟</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2023/%E4%BB%8E%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98%E7%A6%BB%E7%BA%BF_%E6%88%91%E5%B8%A6%E8%B5%B0%E4%BA%86%E4%BB%80%E4%B9%88/">那些年，我从微信支付学到的东西</a></li>
<li><a href="https://ramsayleung.github.io/zh/post/2025/%E6%9D%82%E8%B0%88ai%E5%8F%96%E4%BB%A3%E7%A8%8B%E5%BA%8F%E5%91%98/">杂谈AI取代程序员</a></li>
</ul>
</li>
</ul>
<div center class="qr-container">
<img src="/ox-hugo/qrcode_gh_e06d750e626f_1.jpg" alt="qrcode_gh_e06d750e626f_1.jpg" width="160px" height="160px" center="t" class="qr-container" />
公号同步更新，欢迎关注👻
</div>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p><a href="https://podcasts.apple.com/us/podcast/no-502-%E8%B7%9F35%E5%B2%81%E7%9A%84%E7%A8%8B%E5%BA%8F%E5%91%98%E8%81%8A%E8%81%8A%E6%AF%94%E7%89%B9%E5%B8%81/id1147186605?i=1000697534091">https://podcasts.apple.com/us/podcast/no-502-%E8%B7%9F35%E5%B2%81%E7%9A%84%E7%A8%8B%E5%BA%8F%E5%91%98%E8%81%8A%E8%81%8A%E6%AF%94%E7%89%B9%E5%B8%81/id1147186605?i=1000697534091</a>&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2">
<p><a href="https://book.douban.com/subject/1106247/">https://book.douban.com/subject/1106247/</a>&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:3">
<p><a href="https://www.bitcoin.com/satoshi-archive/emails/wei-dai/1/">https://www.bitcoin.com/satoshi-archive/emails/wei-dai/1/</a>&#160;<a href="#fnref:3" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:4">
<p><a href="http://www.weidai.com/">http://www.weidai.com/</a>&#160;<a href="#fnref:4" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:5">
<p><a href="http://www.weidai.com/bmoney.txt">http://www.weidai.com/bmoney.txt</a>&#160;<a href="#fnref:5" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:6">
<p><a href="https://cryptopp.com/">https://cryptopp.com/</a>&#160;<a href="#fnref:6" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:7">
<p><a href="https://ramsayleung.github.io/zh/post/2024/%E8%B5%B0%E5%87%BA%E6%88%88%E5%A3%81/">https://ramsayleung.github.io/zh/post/2024/%E8%B5%B0%E5%87%BA%E6%88%88%E5%A3%81/</a>&#160;<a href="#fnref:7" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:8">
<p><a href="https://ramsayleung.github.io/zh/post/2023/%E4%BB%8E%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98%E7%A6%BB%E7%BA%BF_%E6%88%91%E5%B8%A6%E8%B5%B0%E4%BA%86%E4%BB%80%E4%B9%88/">https://ramsayleung.github.io/zh/post/2023/%E4%BB%8E%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98%E7%A6%BB%E7%BA%BF_%E6%88%91%E5%B8%A6%E8%B5%B0%E4%BA%86%E4%BB%80%E4%B9%88/</a>&#160;<a href="#fnref:8" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>
]]></content:encoded>
    </item>
    <item>
      <title>重新造轮子系列(四)：正则表达式引擎</title>
      <link>https://ramsayleung.github.io/zh/post/2025/reinvent_regex/</link>
      <pubDate>Sat, 15 Mar 2025 11:01:00 -0700</pubDate>
      <guid>https://ramsayleung.github.io/zh/post/2025/reinvent_regex/</guid>
      <description>&lt;p&gt;项目 GitHub 地址: &lt;a href=&#34;https://github.com/ramsayleung/reinvent/tree/master/regular_expression&#34;&gt;Regex&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&#34;前言&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;1&lt;/span&gt; 前言&lt;/h2&gt;
&lt;p&gt;所谓的正则表达式，指的是由一系列字符和特殊字符组成的模式，用于描述要匹配的文本。&lt;/p&gt;
&lt;p&gt;最开始是一位叫 &lt;a href=&#34;https://en.wikipedia.org/wiki/Stephen_Cole_Kleene&#34;&gt;Stephen Cole Kleene&lt;/a&gt; 的数学家用被他称为 Regular Events 的数学表达式来描述这一模型，在 1968 年，由C语言之父 Ken Tompson 将这个表达式引入到行编辑器 &lt;a href=&#34;https://en.wikipedia.org/wiki/QED_%28text_editor%29&#34;&gt;QED&lt;/a&gt;, 随后是 Unix 上的编辑器 &lt;a href=&#34;https://en.wikipedia.org/wiki/Ed_%28software%29&#34;&gt;ed&lt;/a&gt; (vi 的前身) ，并最终引入到 &lt;a href=&#34;https://en.wikipedia.org/wiki/Grep&#34;&gt;grep&lt;/a&gt;.&lt;/p&gt;</description>
      <content:encoded><![CDATA[<p>项目 GitHub 地址: <a href="https://github.com/ramsayleung/reinvent/tree/master/regular_expression">Regex</a></p>
<h2 id="前言"><span class="section-num">1</span> 前言</h2>
<p>所谓的正则表达式，指的是由一系列字符和特殊字符组成的模式，用于描述要匹配的文本。</p>
<p>最开始是一位叫 <a href="https://en.wikipedia.org/wiki/Stephen_Cole_Kleene">Stephen Cole Kleene</a> 的数学家用被他称为 Regular Events 的数学表达式来描述这一模型，在 1968 年，由C语言之父 Ken Tompson 将这个表达式引入到行编辑器 <a href="https://en.wikipedia.org/wiki/QED_%28text_editor%29">QED</a>, 随后是 Unix 上的编辑器 <a href="https://en.wikipedia.org/wiki/Ed_%28software%29">ed</a> (vi 的前身) ，并最终引入到 <a href="https://en.wikipedia.org/wiki/Grep">grep</a>.</p>
<p>我一直很好奇正则表达式 (regular expression, 即 <code>Regex</code> ) 是怎么实现的，自正则表达式被引入编程语言之后 之后，可谓说有字符串的地方就基本有正则表达式。</p>
<p>想起个关于 <code>Regex</code> 的经典笑话:</p>
<blockquote>
<p>程序员A：我有个问题，想用正则表达式解决。</p>
<p>程序员B：现在你有两个问题了。</p></blockquote>
<h2 id="需求"><span class="section-num">2</span> 需求</h2>
<p>完整版本的正则表达式非常复杂，我们的实现不会覆盖所有的规则，所以先来看下我们要支持的正则表达式规则：</p>
<table>
  <thead>
      <tr>
          <th>含义</th>
          <th>字符</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>任意的字符 <code>c</code></td>
          <td><code>c</code></td>
      </tr>
      <tr>
          <td>任意的单个字符</td>
          <td><code>.</code></td>
      </tr>
      <tr>
          <td>匹配开头的字符</td>
          <td><code>^</code></td>
      </tr>
      <tr>
          <td>匹配结尾的字符</td>
          <td><code>$</code></td>
      </tr>
      <tr>
          <td>匹配零个或多个的字符</td>
          <td><code>*</code></td>
      </tr>
  </tbody>
</table>
<p>虽然这五条原则看起来不是很多，但是已经覆盖日常开发绝大多数的场景了。</p>
<p>比如 <code>^ab*c</code> 就意味着匹配以 <code>a</code> 开头，并且0到无数个的 <code>b</code>, 再接一个字符 <code>c</code>, 所以它能匹配:
<code>ac</code>, <code>abc</code> 以及 <code>abbbbbc</code></p>
<h2 id="初始版本"><span class="section-num">3</span> 初始版本</h2>
<p>根据上面的需求，可以使用40行不到的代码就实现一个简单的递归版本的正则表达式引擎：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">match</span> <span class="o">=</span> <span class="p">(</span><span class="nx">pattern</span><span class="o">:</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">text</span><span class="o">:</span> <span class="nx">string</span><span class="p">)</span><span class="o">:</span> <span class="kr">boolean</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// &#39;^&#39; at start of pattern matches start of next.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nx">pattern</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;^&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">matchHere</span><span class="p">(</span><span class="nx">pattern</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">text</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Try all possible starting points for pattern.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">let</span> <span class="nx">iText</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">do</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">matchHere</span><span class="p">(</span><span class="nx">pattern</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">text</span><span class="p">,</span> <span class="nx">iText</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">iText</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="nx">iText</span> <span class="o">&lt;</span> <span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Nothing worked.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">matchHere</span> <span class="o">=</span> <span class="p">(</span><span class="nx">pattern</span><span class="o">:</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">patternIndex</span><span class="o">:</span> <span class="nx">number</span><span class="p">,</span> <span class="nx">text</span><span class="o">:</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">textIndex</span><span class="o">:</span> <span class="nx">number</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// There is no more pattern to match.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nx">patternIndex</span> <span class="o">===</span> <span class="nx">pattern</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// &#39;$&#39; at end of pattern matches end of text.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">((</span><span class="nx">patternIndex</span> <span class="o">===</span> <span class="p">(</span><span class="nx">pattern</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">pattern</span><span class="p">[</span><span class="nx">patternIndex</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;$&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">textIndex</span> <span class="o">===</span> <span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// &#39;*&#39; following current character means zero or more.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(((</span><span class="nx">pattern</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="nx">patternIndex</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">pattern</span><span class="p">[</span><span class="nx">patternIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;*&#39;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Try matching zero occurences(skip the current char and the &#39;*&#39;)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">matchHere</span><span class="p">(</span><span class="nx">pattern</span><span class="p">,</span> <span class="nx">patternIndex</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">text</span><span class="p">,</span> <span class="nx">textIndex</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Try matching one or more occurences
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">while</span> <span class="p">((</span><span class="nx">textIndex</span> <span class="o">&lt;</span> <span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">pattern</span><span class="p">[</span><span class="nx">patternIndex</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;.&#39;</span> <span class="o">||</span> <span class="nx">text</span><span class="p">[</span><span class="nx">textIndex</span><span class="p">]</span> <span class="o">===</span> <span class="nx">pattern</span><span class="p">[</span><span class="nx">patternIndex</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Try to match the rest of pattern after consuming this
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// character
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="nx">matchHere</span><span class="p">(</span><span class="nx">pattern</span><span class="p">,</span> <span class="nx">patternIndex</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">text</span><span class="p">,</span> <span class="nx">textIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="nx">textIndex</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// if there is any match, it will return early in the while loop,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// so when reach this statement, it means nothing found.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Match a single chacater.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nx">textIndex</span> <span class="o">&lt;</span> <span class="nx">text</span><span class="p">.</span><span class="nx">length</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">pattern</span><span class="p">[</span><span class="nx">patternIndex</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">pattern</span><span class="p">[</span><span class="nx">patternIndex</span><span class="p">]</span> <span class="o">===</span> <span class="nx">text</span><span class="p">[</span><span class="nx">textIndex</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">matchHere</span><span class="p">(</span><span class="nx">pattern</span><span class="p">,</span> <span class="nx">patternIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">text</span><span class="p">,</span> <span class="nx">textIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Nothing worked.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>实现思路如下图:</p>

<figure>
    
    
    <input type="checkbox" id="zoomCheck-26048" hidden>
    <label for="zoomCheck-26048">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/reinvent_simple_regex_design.png"/> 
    
    
    </label>
</figure>

<p>好的，我们的正则表达式引擎完工了，正则表达式看起来也没有那么难嘛。</p>
<p>只是用是能用的，但是看起来不同含义的字符都耦合在 <code>matchHere</code> 函数了，想要支持新的字符匹配(例如 <code>+</code>, 或者 <code>|</code> )很难扩展。</p>
<h2 id="面向对象版本"><span class="section-num">4</span> 面向对象版本</h2>
<h3 id="接口"><span class="section-num">4.1</span> 接口</h3>
<p>再来思考一下版本1的问题:</p>
<p>我们把不同模式的符号都耦合在同一个函数中。</p>
<p>在讨论解耦方式之前，先来观察下每个模式的共同点，以便我们抽象接口。</p>
<p>以最简单的 <code>^c</code> 模式为例，我们需要将 <code>c</code> 与给定的文本 <code>abc</code> 和 <code>cde</code> 作比较，首先匹配第一个字符，如果匹配失败(如 <code>abc</code>)，则直接结束； 如果匹配第一个字符成功（=cde=）, 那么就匹配剩余的其他字符, 直到模式匹配结束.</p>
<p>那么对于精确匹配字符的模式 <code>Literal</code> 而言，入参就是字符 <code>c</code> 和文本 <code>text</code>, 返回结果就是true/false, 用来表示是否匹配成功.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">literal_match</span> <span class="o">=</span> <span class="p">(</span><span class="nx">pattern</span><span class="o">:</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">text</span><span class="o">:</span> <span class="nx">string</span><span class="p">)</span><span class="o">:</span> <span class="kr">boolean</span> <span class="p">=&gt;</span> <span class="p">{}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果不同的模式匹配都使用这个函数签名的话，每次匹配之后，都需要把剩下需要匹配的文本给复制出来，频繁拷贝字符串可能会导致性能开销很大。</p>
<p>我们可以做个小优化, 通过下标 <code>start</code> 来指定需要匹配的文本, 就可以在不同的模式中都只使用同一份的字符串，避免了多次拷贝的开销。</p>
<p>而返回结果也不再是 boolean, 而是下一个模式需要匹配的下标。</p>
<p>比如 <code>^c</code> 来匹配 <code>cde</code> ，匹配成功之后就返回 <code>1</code>, 就意味着下个模式从 <code>1</code>, 也就是 <code>d</code> 开始匹配.</p>
<p>那匹配失败要怎么表示？这个也很简单，返回一个不合法的下标，比如 <code>-1</code> 即可，那么我们的模式的函数接口就变成:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">literal_match</span> <span class="o">=</span> <span class="p">(</span><span class="nx">pattern</span><span class="o">:</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">text</span><span class="o">:</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">index</span><span class="o">:</span> <span class="nx">number</span><span class="p">)</span><span class="o">:</span> <span class="nx">number</span> <span class="p">=&gt;</span> <span class="p">{}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="模板设计模式"><span class="section-num">4.2</span> 模板设计模式</h3>
<p>既然版本一提到了 <code>matchHere</code> 实现耦合在一起，那么有什么方式可以实现解耦呢？</p>
<p>其中的一个经典解决方式就是面向对象编程(Object Oriented Programming)，这也是面向对象编程的设计初衷。</p>
<p>既然前面实现的缺点是不同的模式耦合在一起，那么我们可以把每种模式实现成一个函数或者一个类，然后再通过某种模式给组合起来。</p>
<p>既然用到 OOP, 那么自然少不了设计模式了。如果使用一种模式表示成一个类，那么会是哪种设计模式呢？</p>
<p>要不就是<a href="https://refactoring.guru/design-patterns/strategy">策略模式(strategy)</a>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ConcreteAlgorithm</span> <span class="o">:</span> <span class="n">IAlgorithm</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">DoAlgorithm</span><span class="p">(</span><span class="kt">int</span> <span class="n">datum</span><span class="p">)</span> <span class="p">{...}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Strategy</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Strategy</span><span class="p">(</span><span class="n">IAlgorithm</span> <span class="n">algo</span><span class="p">)</span> <span class="p">{...}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">run</span><span class="p">(</span><span class="kt">int</span> <span class="n">datum</span><span class="p">)</span> <span class="p">{</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">algo</span><span class="p">.</span><span class="n">DoAlgorithm</span><span class="p">(</span><span class="n">datum</span><span class="p">);</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>要么就是<a href="https://refactoring.guru/design-patterns/template-method">模板方法(template method)</a>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ConcreteAlgorithm</span> <span class="o">:</span> <span class="n">AbstractTemplate</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">DoAlgorithm</span><span class="p">(</span><span class="kt">int</span> <span class="n">datum</span><span class="p">)</span> <span class="p">{...}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">AbstractTemplate</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">run</span><span class="p">(</span><span class="kt">int</span> <span class="n">datum</span><span class="p">)</span> <span class="p">{</span> <span class="n">DoAlgorithm</span><span class="p">(</span><span class="n">datum</span><span class="p">);</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">DoAlgorithm</span><span class="p">()</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// abstract
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看起来好像都可以，那不如就使用模板方式吧。</p>
<h3 id="单向链表"><span class="section-num">4.3</span> 单向链表</h3>
<p>那么就让我们来定义个基类 <code>RegexBase</code> :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">INVALID_INDEX</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">abstract</span> <span class="kr">class</span> <span class="nx">RegexBase</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// index to continue matching at or -1 indicating that matching failed
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kr">abstract</span> <span class="nx">_match</span><span class="p">(</span><span class="nx">text</span><span class="o">:</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">start</span><span class="o">:</span> <span class="nx">number</span><span class="p">)</span><span class="o">:</span> <span class="nx">number</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kr">abstract</span> <span class="nx">rest</span><span class="o">:</span> <span class="nx">RegexBase</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">match</span><span class="p">(</span><span class="nx">text</span><span class="o">:</span> <span class="nx">string</span><span class="p">)</span><span class="o">:</span> <span class="kr">boolean</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// check if the pattern matches at the start of the string
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_match</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!==</span> <span class="nx">INVALID_INDEX</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_match</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>细看之下, 函数签名与我们上文讨论的有所不同，那是因为我们把模式 <code>pattern</code> 作为每个模式类的成员变量了，就不需要显式定义在 <code>_match</code> 函数中了。</p>
<p>再来看下我们精确匹配字符的 <code>Lit</code> 模式类的实现:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kr">class</span> <span class="nx">RegexLit</span> <span class="kr">extends</span> <span class="nx">RegexBase</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">private</span> <span class="nx">chars</span><span class="o">:</span> <span class="nx">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">rest</span><span class="o">:</span> <span class="nx">RegexBase</span>
</span></span><span class="line"><span class="cl">  <span class="nx">constructor</span><span class="p">(</span><span class="nx">chars</span><span class="o">:</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">rest</span><span class="o">:</span> <span class="nx">RegexBase</span> <span class="o">|</span> <span class="kc">null</span> <span class="o">=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">super</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">chars</span> <span class="o">=</span> <span class="nx">chars</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">rest</span> <span class="o">=</span> <span class="nx">rest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">_match</span><span class="p">(</span><span class="nx">text</span><span class="o">:</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">start</span><span class="o">:</span> <span class="nx">number</span><span class="p">)</span><span class="o">:</span> <span class="nx">number</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">nextIndex</span> <span class="o">=</span> <span class="nx">start</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">chars</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">nextIndex</span> <span class="o">&gt;</span> <span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nx">INVALID_INDEX</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">text</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">start</span><span class="p">,</span> <span class="nx">nextIndex</span><span class="p">)</span> <span class="o">!==</span> <span class="k">this</span><span class="p">.</span><span class="nx">chars</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nx">INVALID_INDEX</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">rest</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nx">nextIndex</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">rest</span><span class="p">.</span><span class="nx">_match</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span> <span class="nx">nextIndex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>实现很简单, 但 <code>rest</code> 又是什么呢?</p>
<p>还是以 <code>^c</code> 为例, 现在改复杂一点, 模式变成 <code>^cd</code> 来匹配 <code>cde</code> ，模式 <code>^c</code> 匹配完 <code>c</code> 之后, 就要使用剩下的模式(<code>rest</code>) <code>d</code> 来匹配剩下的文本 <code>de</code>, 剩下的模式可能也会再包含剩下的模式，用来匹配再被剩下的文本，依此类推.</p>

<figure>
    
    
    <input type="checkbox" id="zoomCheck-2d2c9" hidden>
    <label for="zoomCheck-2d2c9">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/reinvent_regex_rest_pointer.jpg"/> 
    
    
    </label>
</figure>

<p>相当于 <code>rest</code> 就是指向下一个模式类的单向指针，用来表示下一个模式需要匹配剩余的文本，直到所有的模式匹配完成，即 <code>rest</code> 指针指向 <code>null</code></p>
<p>所以模式 <code>cde</code> 就可以表示成 <code>Lit('c', Lit('d', Lit('e')))</code></p>
<p>而所有的模式组合在一起，本质就是一条单向链条，而正则表达式就是判断是否存在依次匹配链表中所有模式的文本。</p>
<h3 id="any-模式"><span class="section-num">4.4</span> Any 模式</h3>
<p>Any 模式即 <code>*</code> 匹配 0到任意个前一个字符，与其类似的还有 Plus 模式，即 <code>+</code> 匹配1到任意个前一个字符字符；以及 <code>?</code> 表示匹配0到1个前一个字符，Any算是最有代表性和最难实现的模式。</p>
<p>即 <code>a*b</code> 表示可以匹配0到任意个 <code>a</code> ，再匹配一个 <code>b</code> , 所以 <code>b</code>, <code>ab</code>, <code>aaaaaab</code> 它都可以匹配上。</p>
<p>那么问题就来了，既然它可以匹配0到任意个字符，那么匹配的时候我要匹配几个字符呢？</p>
<p>理论上有 <code>N</code> 个的可能性, N = 待匹配文本 <code>text</code> 的长度。</p>
<p>既然不知道要匹配几个字符，那不如我们把所有可能性都穷举一次呗，而这种穷举算法，则被称为是<a href="https://labuladong.online/algo/essential-technique/backtrack-framework/#%E5%85%A8%E6%8E%92%E5%88%97%E9%97%AE%E9%A2%98%E8%A7%A3%E6%9E%90">回溯算法</a>(<a href="https://en.wikipedia.org/wiki/Backtracking">backtracking</a>)</p>
<p>我们知道穷举的上界是 N(<code>N=len(text)</code>), 下界是 0, 那么是从 0 穷举到 <code>N</code>, 还是从 <code>N</code> 穷举到 <code>0</code> 呢？</p>
<p>两种方法都可以解决问题，计算机科学家们还给这两种做法起了个洋气的名字， <code>N</code> -&gt; <code>0</code>, 因为是先开始匹配所有的字符，所以就被称为贪婪匹配 greedy(eager) matching.</p>
<p>而从 <code>0</code> -&gt; <code>N</code>, 因为是从0开始，所以又被称为是惰性匹配 lazy matching。</p>
<p>从性能的角度来说，是 <code>lazy matching</code> 更优，因为它尽可能地去掉了不必要的匹配了。</p>
<p>我们可以先来看下贪婪匹配的实现，再看下惰性匹配：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kr">class</span> <span class="nx">RegexAny</span> <span class="kr">extends</span> <span class="nx">RegexBase</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">private</span> <span class="nx">child</span><span class="o">:</span> <span class="nx">RegexBase</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kr">private</span> <span class="nx">rest</span><span class="o">:</span> <span class="nx">RegexBase</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">constructor</span><span class="p">(</span><span class="nx">child</span><span class="o">:</span> <span class="nx">RegexBase</span><span class="p">,</span> <span class="nx">rest</span><span class="o">:</span> <span class="nx">RegexBase</span> <span class="o">|</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">super</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">child</span> <span class="o">=</span> <span class="nx">child</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">rest</span> <span class="o">=</span> <span class="nx">rest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">_match</span><span class="p">(</span><span class="nx">text</span><span class="o">:</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">start</span><span class="o">:</span> <span class="nx">number</span><span class="p">)</span><span class="o">:</span> <span class="nx">number</span> <span class="o">|</span> <span class="kc">null</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">maxPossible</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="nx">start</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">num</span> <span class="o">=</span> <span class="nx">maxPossible</span><span class="p">;</span> <span class="nx">num</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">num</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">afterMany</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_matchMany</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">num</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nx">afterMany</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">afterMany</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">undefined</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">_matchMany</span><span class="p">(</span><span class="nx">text</span><span class="o">:</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">start</span><span class="o">:</span> <span class="nx">number</span><span class="p">,</span> <span class="nx">num</span><span class="o">:</span> <span class="nx">number</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">num</span><span class="p">;</span> <span class="nx">i</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">start</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">child</span><span class="p">.</span><span class="nx">_match</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span> <span class="nx">start</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nx">start</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">undefined</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">rest</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">rest</span><span class="p">.</span><span class="nx">_match</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span> <span class="nx">start</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">start</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>a*b</code> 会被解析成, <code>Any(Lit('a'), Lit('b'))</code>, 因为 <code>*</code> 表示匹配0到任意个前一个字符，前一个字符还可能另外一种模式，所以我们可以把前一个字符也解析成模式，作为 <code>child</code> 传入到 <code>Any</code>.</p>
<p><code>_matchMany</code> 是从 <code>start</code> 匹配到 <code>start+num</code> 位置，看是否匹配，而 <code>maxPossible</code> 表示当前剩余文本中可能的最大匹配次数.</p>
<p>以 <code>text = &quot;aab&quot;</code>, <code>start = 0</code>, <code>pattern = a*b</code> 为例， <code>maxPossible = len(text) = 3</code>,</p>
<ol>
<li>
<p>第一轮尝试(<code>num=3</code>):</p>
<ul>
<li>尝试匹配 3 个 <code>a</code> -&gt; 失败(只有 2 个 <code>a</code>)</li>
</ul>
</li>
<li>
<p>第二轮尝试(<code>num=2</code>):</p>
<ul>
<li>匹配 2 个 =a=(位置 <code>0-&gt;1-&gt;2</code>)</li>
<li>然后匹配 rest(b 在位置 <code>2-&gt;3</code>): 成功！</li>
<li>返回 3</li>
</ul>

    <figure>
        
        
        <input type="checkbox" id="zoomCheck-c2c3c" hidden>
        <label for="zoomCheck-c2c3c">
        
        
        <img class="zoomCheck" loading="lazy" src="/ox-hugo/reinvent_regex_match_aab.png"/> 
        
        
        </label>
    </figure>

</li>
</ol>
<p>以及使用模式 <code>a*ab</code> 来匹配文本 <code>ab</code> 的过程:
<img loading="lazy" src="/ox-hugo/reinvent_regex_match_ab.jpg"></p>
<h3 id="支持的模式"><span class="section-num">4.5</span> 支持的模式</h3>
<p>每种模式对应一个单独的类之后，再通过 <code>rest</code> 指针进行关联，现在的实现就非常易于扩展了，我们可以很容易地支持其他的模式，具体列表如下：</p>
<table>
  <thead>
      <tr>
          <th>含义</th>
          <th>字符</th>
          <th>例子</th>
          <th>对应实现</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>任意的字符 <code>c</code></td>
          <td><code>c</code></td>
          <td><code>c</code> 匹配字符c</td>
          <td><a href="https://github.com/ramsayleung/reinvent/blob/master/regular_expression/regex-lit.ts">Lit</a></td>
      </tr>
      <tr>
          <td>任意的单个字符</td>
          <td><code>.</code></td>
          <td><code>.</code> 匹配任意字符</td>
          <td></td>
      </tr>
      <tr>
          <td>匹配开头的字符</td>
          <td><code>^</code></td>
          <td><code>^c</code> 匹配以 <code>c</code> 开头的字符串</td>
          <td><a href="https://github.com/ramsayleung/reinvent/blob/master/regular_expression/regex-start.ts">Start</a></td>
      </tr>
      <tr>
          <td>匹配结尾的字符</td>
          <td><code>$</code></td>
          <td><code>c$</code> 匹配以 <code>c</code> 结尾的字符串</td>
          <td><a href="https://github.com/ramsayleung/reinvent/blob/master/regular_expression/regex-end.ts">End</a></td>
      </tr>
      <tr>
          <td>匹配零个或多个的字符</td>
          <td><code>*</code></td>
          <td><code>a*</code> 匹配0-任意个a的字符串, 贪婪匹配</td>
          <td><a href="https://github.com/ramsayleung/reinvent/blob/master/regular_expression/regex-any.ts">GreedyAny</a></td>
      </tr>
      <tr>
          <td>匹配零个或多个的字符</td>
          <td><code>*</code></td>
          <td><code>a*</code> 匹配0-任意个a的字符串, 惰性匹配</td>
          <td><a href="https://github.com/ramsayleung/reinvent/blob/master/regular_expression/regex-lazy-any.ts">LazyAny</a></td>
      </tr>
      <tr>
          <td>匹配一个或多个的字符</td>
          <td><code>+</code></td>
          <td><code>a+</code> 匹配1-任意个a的字符串</td>
          <td><a href="https://github.com/ramsayleung/reinvent/blob/master/regular_expression/regex-plus.ts">Plus</a></td>
      </tr>
      <tr>
          <td>匹配零个或一个的字符</td>
          <td><code>?</code></td>
          <td><code>a?</code> 匹配0-1个a的字符串</td>
          <td><a href="https://github.com/ramsayleung/reinvent/blob/master/regular_expression/regex-opt.ts">Opt</a></td>
      </tr>
      <tr>
          <td>多选一匹配</td>
          <td><code>❘</code></td>
          <td><code>a❘b</code> 匹配a或b的字符串</td>
          <td><a href="https://github.com/ramsayleung/reinvent/blob/master/regular_expression/regex-alt.ts">Alt</a></td>
      </tr>
      <tr>
          <td>序列匹配</td>
          <td><code>()</code></td>
          <td><code>(ab)</code> 匹配 ab 的字符串</td>
          <td><a href="https://github.com/ramsayleung/reinvent/blob/master/regular_expression/regex-group.ts">Group</a></td>
      </tr>
      <tr>
          <td>匹配方括号内的任意单个字符</td>
          <td><code>[]</code></td>
          <td><code>[abcd]</code> 匹配a或b或c或d的字符串</td>
          <td><a href="https://github.com/ramsayleung/reinvent/blob/master/regular_expression/regex-charclass.ts">CharClass</a></td>
      </tr>
  </tbody>
</table>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;Regex testsuite&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">it</span><span class="p">.</span><span class="nx">each</span><span class="p">([</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)],</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)],</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="s1">&#39;ab&#39;</span><span class="p">,</span> <span class="s1">&#39;ba&#39;</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;ab&#39;</span><span class="p">)],</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="s1">&#39;^a&#39;</span><span class="p">,</span> <span class="s1">&#39;ab&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">Start</span><span class="p">(</span><span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">))],</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="s1">&#39;^b&#39;</span><span class="p">,</span> <span class="s1">&#39;ab&#39;</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">Start</span><span class="p">(</span><span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">))],</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="s1">&#39;a$&#39;</span><span class="p">,</span> <span class="s1">&#39;ab&#39;</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="nx">End</span><span class="p">())],</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="s1">&#39;a$&#39;</span><span class="p">,</span> <span class="s1">&#39;ba&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="nx">End</span><span class="p">())],</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="s1">&#39;a*&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">Any</span><span class="p">(</span><span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">))],</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="s1">&#39;a*&#39;</span><span class="p">,</span> <span class="s1">&#39;baac&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">Any</span><span class="p">(</span><span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">))],</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="s1">&#39;ab*c&#39;</span><span class="p">,</span> <span class="s1">&#39;ac&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="nx">Any</span><span class="p">(</span><span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">),</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">)))],</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="s1">&#39;ab*c&#39;</span><span class="p">,</span> <span class="s1">&#39;acc&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="nx">Any</span><span class="p">(</span><span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">),</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">)))],</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="s1">&#39;ab*c&#39;</span><span class="p">,</span> <span class="s1">&#39;abc&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="nx">Any</span><span class="p">(</span><span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">),</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">)))],</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="s1">&#39;ab*c&#39;</span><span class="p">,</span> <span class="s1">&#39;abbbc&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="nx">Any</span><span class="p">(</span><span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">),</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">)))],</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="s1">&#39;ab*c&#39;</span><span class="p">,</span> <span class="s1">&#39;abxc&#39;</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="nx">Any</span><span class="p">(</span><span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">),</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">)))],</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="s1">&#39;ab*c&#39;</span><span class="p">,</span> <span class="s1">&#39;ac&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="nx">LazyAny</span><span class="p">(</span><span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">),</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">)))],</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="s1">&#39;ab*c&#39;</span><span class="p">,</span> <span class="s1">&#39;acc&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="nx">LazyAny</span><span class="p">(</span><span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">),</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">)))],</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="s1">&#39;ab*&#39;</span><span class="p">,</span> <span class="s1">&#39;ab&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="nx">LazyAny</span><span class="p">(</span><span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)))],</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="s1">&#39;ab+c&#39;</span><span class="p">,</span> <span class="s1">&#39;ac&#39;</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="nx">Plus</span><span class="p">(</span><span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">),</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">)))],</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="s1">&#39;ab+c&#39;</span><span class="p">,</span> <span class="s1">&#39;abc&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="nx">Plus</span><span class="p">(</span><span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">),</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">)))],</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="s1">&#39;a(b|c)d&#39;</span><span class="p">,</span> <span class="s1">&#39;xabdy&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="nx">Alt</span><span class="p">(</span><span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">),</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">),</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">)))],</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="s1">&#39;a(b|c)d&#39;</span><span class="p">,</span> <span class="s1">&#39;xabady&#39;</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="nx">Alt</span><span class="p">(</span><span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">),</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">),</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">)))],</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="s1">&#39;ab?c&#39;</span><span class="p">,</span> <span class="s1">&#39;abc&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="nx">Opt</span><span class="p">(</span><span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">),</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">)))],</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="s1">&#39;ab?c&#39;</span><span class="p">,</span> <span class="s1">&#39;acc&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="nx">Opt</span><span class="p">(</span><span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">),</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">)))],</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="s1">&#39;ab?c&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="nx">Opt</span><span class="p">(</span><span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">),</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">)))],</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="s2">&#34;[abcd]&#34;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">CharClass</span><span class="p">([</span><span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">),</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">),</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">),</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">)])],</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="s2">&#34;[abcd]&#34;</span><span class="p">,</span> <span class="s1">&#39;ab&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">CharClass</span><span class="p">([</span><span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">),</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">),</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">),</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">)])],</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="s2">&#34;[abcd]&#34;</span><span class="p">,</span> <span class="s1">&#39;xhy&#39;</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">CharClass</span><span class="p">([</span><span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">),</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">),</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">),</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">)])],</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="s2">&#34;c[abcd]&#34;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="nx">CharClass</span><span class="p">([</span><span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">),</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">),</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">),</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">)]))],</span>
</span></span><span class="line"><span class="cl">    <span class="p">])(</span><span class="s1">&#39;Regex base test (&#34;%s&#34; &#34;%s&#34; &#34;%p&#34;)&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">_pattern</span><span class="p">,</span> <span class="nx">text</span><span class="p">,</span> <span class="nx">expected</span><span class="p">,</span> <span class="nx">matcher</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">actual</span> <span class="o">=</span> <span class="nx">matcher</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">text</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">expect</span><span class="p">(</span><span class="nx">actual</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">expected</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>顺便一提的是，这种相同的验证逻辑, 但是输入多个不同的参数以验证不同case的做法，叫做 <code>Parameterized Test</code></p>
<p>我在《<a href="https://ramsayleung.github.io/zh/categories/%E6%B5%8B%E8%AF%95%E6%8A%80%E8%83%BD%E8%BF%9B%E9%98%B6/">测试技能进阶系列</a>》的第二篇也曾经介绍过： <a href="https://ramsayleung.github.io/zh/post/2024/%E6%B5%8B%E8%AF%95%E6%8A%80%E8%83%BD%E8%BF%9B%E9%98%B6%E4%BA%8C_parameterized_tests/">Parameterized Tests</a></p>
<p>这样我们就完成了一个功能较完整的正则表达式引擎了。</p>
<h2 id="表达式解析"><span class="section-num">5</span> 表达式解析</h2>
<p>虽然我们已经完成了一个正则表达式引擎，只不过我们平时用表达式是 <code>a*bc</code> ，现在要写成 <code>Any(Lit('a'), Lib('b', Lib('c')))</code> 多个类的实例也太烦琐了。</p>
<p>让我们再来分析下正则表达式，以 <code>^(a|b|$)*z$</code> 为例，以任意数量的 <code>a</code>, <code>b</code>, 或 <code>$</code> 开头, 再紧接一个 <code>z</code>, 然后结束。</p>
<p>我们可以创建一个树来表达这个表达式:</p>

<figure>
    
    
    <input type="checkbox" id="zoomCheck-4379e" hidden>
    <label for="zoomCheck-4379e">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/reinvent_regex_express_as_tree.jpg"/> 
    
    
    </label>
</figure>

<p>在考虑如何把表达式变成上面那棵树之前，我们可以先从最简单的步骤开始：分割字符串</p>
<p>正如物理学家给不可再分的元素称之为「原子」(atom), 计算机科学家也给不可再分割的文本起了一个名字，称之为 <strong>token</strong>, 类似 <code>a</code>, <code>b</code>, <code>$</code>, <code>*</code> 这些都是 token，而把文本切分成 token 的过程，即为 <em>tokenize</em> 。</p>
<p>不同的token可能代表不同的含义，像 <code>a</code>, <code>b</code>, <code>c</code> 这类，所以它们的值不同，但是它们都可以被称为字面量(Literal), 而像 <code>*</code>, <code>+</code>, <code>|</code>, <code>(</code>, <code>)</code> 这样的字符又各种其代表的含义, 如:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">SYMBOL_TOKEN_TYPE_MAP</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="s1">&#39;*&#39;</span><span class="o">:</span> <span class="nx">TokenKind</span><span class="p">.</span><span class="nx">Any</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="s1">&#39;|&#39;</span><span class="o">:</span> <span class="nx">TokenKind</span><span class="p">.</span><span class="nx">Alt</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="s1">&#39;(&#39;</span><span class="o">:</span> <span class="nx">TokenKind</span><span class="p">.</span><span class="nx">GroupStart</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="s1">&#39;)&#39;</span><span class="o">:</span> <span class="nx">TokenKind</span><span class="p">.</span><span class="nx">GroupEnd</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>定义好 token 类型之后， <code>tokenize</code> 跃然纸上了：</p>
<p>直接按照字符作匹配，如果能匹配上的就是特殊类型的 <code>Token</code> ，不然就是字面量:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">interface</span> <span class="nx">Token</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">kind</span><span class="o">:</span> <span class="nx">TokenKind</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">location</span><span class="o">:</span> <span class="nx">number</span>
</span></span><span class="line"><span class="cl">  <span class="nx">value</span><span class="o">?:</span> <span class="nx">string</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">tokenize</span> <span class="o">=</span> <span class="p">(</span><span class="nx">text</span><span class="o">:</span> <span class="nx">string</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">result</span><span class="o">:</span> <span class="nx">Token</span><span class="p">[]</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">c</span> <span class="o">=</span> <span class="nx">text</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">c</span> <span class="k">in</span> <span class="nx">SIMPLE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span> <span class="nx">kind</span><span class="o">:</span> <span class="nx">SIMPLE</span><span class="p">[</span><span class="nx">c</span><span class="p">],</span> <span class="nx">location</span><span class="o">:</span> <span class="nx">i</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="nx">c</span> <span class="o">===</span> <span class="s1">&#39;^&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">i</span> <span class="o">===</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span> <span class="nx">kind</span><span class="o">:</span> <span class="nx">TokenKind</span><span class="p">.</span><span class="nx">Start</span><span class="p">,</span> <span class="nx">location</span><span class="o">:</span> <span class="nx">i</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="nx">c</span> <span class="o">===</span> <span class="s1">&#39;$&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">i</span> <span class="o">===</span> <span class="p">(</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span> <span class="nx">kind</span><span class="o">:</span> <span class="nx">TokenKind</span><span class="p">.</span><span class="nx">End</span><span class="p">,</span> <span class="nx">location</span><span class="o">:</span> <span class="nx">i</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span> <span class="nx">kind</span><span class="o">:</span> <span class="nx">TokenKind</span><span class="p">.</span><span class="nx">Lit</span><span class="p">,</span> <span class="nx">location</span><span class="o">:</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="nx">c</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>^(a|b|$)*z$</code> 就会被解析成如下的结果:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="p">[</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;kind&#34;</span><span class="o">:</span> <span class="s2">&#34;Start&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;location&#34;</span><span class="o">:</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;kind&#34;</span><span class="o">:</span> <span class="s2">&#34;GroupStart&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;location&#34;</span><span class="o">:</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;kind&#34;</span><span class="o">:</span> <span class="s2">&#34;Lit&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;location&#34;</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;value&#34;</span><span class="o">:</span> <span class="s2">&#34;a&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;kind&#34;</span><span class="o">:</span> <span class="s2">&#34;Alt&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;location&#34;</span><span class="o">:</span> <span class="mi">3</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;kind&#34;</span><span class="o">:</span> <span class="s2">&#34;Lit&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;location&#34;</span><span class="o">:</span> <span class="mi">4</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;value&#34;</span><span class="o">:</span> <span class="s2">&#34;b&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;kind&#34;</span><span class="o">:</span> <span class="s2">&#34;Alt&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;location&#34;</span><span class="o">:</span> <span class="mi">5</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;kind&#34;</span><span class="o">:</span> <span class="s2">&#34;Lit&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;location&#34;</span><span class="o">:</span> <span class="mi">6</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;value&#34;</span><span class="o">:</span> <span class="s2">&#34;$&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;kind&#34;</span><span class="o">:</span> <span class="s2">&#34;GroupEnd&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;location&#34;</span><span class="o">:</span> <span class="mi">7</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;kind&#34;</span><span class="o">:</span> <span class="s2">&#34;Any&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;location&#34;</span><span class="o">:</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;kind&#34;</span><span class="o">:</span> <span class="s2">&#34;Lit&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;location&#34;</span><span class="o">:</span> <span class="mi">9</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;value&#34;</span><span class="o">:</span> <span class="s2">&#34;z&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;kind&#34;</span><span class="o">:</span> <span class="s2">&#34;End&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;location&#34;</span><span class="o">:</span> <span class="mi">10</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="组装抽象语法树"><span class="section-num">6</span> 组装抽象语法树</h2>
<p><code>tokenize</code> 的结果是一个包含 Token 的列表，我们要如何组装成树状数据结构呢？</p>
<p>顺带一提，这树状数据结构全称是抽象语法树(Abstract syntax tree, AST), 是一种用来表示程序结构的数据结构，如:</p>

<figure>
    
    
    <input type="checkbox" id="zoomCheck-7b55c" hidden>
    <label for="zoomCheck-7b55c">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/Abstract_syntax_tree_for_Euclidean_algorithm.svg.png"/> 
    
    
    </label>
</figure>

<p>我们可以分情况来讨论，因为不同的模式有不同的组装方式，组装完之后的 AST 的输出是一个 <code>output</code>, 包含组装后的 <code>token</code> 列表:</p>
<p>对于表达式 <code>a</code>, 我们可以创建一个 <code>Lit</code> 类型的 <code>token</code> (为了便于理解，「创建」指创建一个 <code>token</code>, 然后插入到 <code>output</code>.)</p>
<p>对于表达式 <code>a*</code> 呢？我们可以先创建一个 <code>Lit('a')</code> 的 <code>token</code>, 当遇到 <code>*</code> 时，因为 <code>*</code> 表示匹配0至任意的前一个字符, 所以我们可以创建一个 <code>Any</code> 类型的 token, 然后把 <code>output</code> 最后一个元素 <code>pop</code> 出来，作为 <code>Any</code> 的 <code>child</code> 元素.</p>

<figure>
    
    
    <input type="checkbox" id="zoomCheck-63031" hidden>
    <label for="zoomCheck-63031">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/reinvent_regex_construct_ast_any.jpg"/> 
    
    
    </label>
</figure>

<p>对于表达式 <code>(ab)</code>, 情况就变得复杂一些:
当遇到 <code>(</code> 括号的时候，我们可以创建一个 <code>Group</code> ，但是问题在于，我们不知道这个 <code>Group</code> 什么时候结束，即不知道什么时候才会遇上 <code>)</code>.</p>
<p>所以我们需要换种解决思路：当遇到 <code>(</code>, 创建一个 <code>GroupStart</code> 类型的 <code>token</code>, 然后再继续处理 <code>a</code>, <code>b</code>, 当遇到 <code>)</code> 时，创建一个 <code>Group</code> 类型的 <code>token</code>, 然后一直调用 <code>pop</code> 函数直到把 <code>GroupStart</code> 也 <code>pop</code> 出来, 然后把过程中 <code>pop</code> 出来的 <code>token</code> 都当作是 <code>Group</code> 的 <code>children</code> 列表，而 <code>GroupStart</code> 相当于起到一个标记符的作用。</p>
<p>这种思路就自动处理了 <code>(a*)</code> 和 <code>(a(b*)c)</code> 的差异:</p>

<figure>
    
    
    <input type="checkbox" id="zoomCheck-49c57" hidden>
    <label for="zoomCheck-49c57">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/reinvent_regex_ast_group.jpg"/> 
    
    
    </label>
</figure>

<p>对于表达式 <code>a|b</code>, 我们是否可以参考 <code>Any</code> 的做法呢?</p>
<p>遇到 <code>a</code> 的时候先创建一个 <code>Lit('a')</code>, 遇到 <code>|</code> 时再创建一个 <code>Alt</code>, 然后把 <code>Lit('a')</code> 从 <code>output</code> pop 出来作为 <code>left</code> 节点， 再遇到下一个字符 <code>b</code> 的时候，再把 <code>Alt</code> 从 output pop 出来，把 <code>b</code> 作为 <code>right</code> 节点。</p>
<p>听起来没问题，但是上面的算法无法正确解析 <code>a|b*</code>, 它表示匹配一个 <code>a</code> 或者是任意数量的 <code>b</code>, 但是我们的做法会把它解析成 <code>(a|b)*</code>, 即任意数量的 <code>a</code> 或 <code>b</code>.</p>
<p>更合理的做法是先部分组装 Alt 的 <code>left</code> 节点，等解析完所有字符之后，再重新解析一次，把 <code>right</code> 节点给组装上。</p>
<p>以 <code>a|b*</code> 为例子:</p>
<ol>
<li>创建一个 <code>Lit('a')</code> token</li>
<li>当遇到 <code>|</code> 的时候，创建一个 <code>Alt</code>, 并将 <code>Lit('a')</code> pop 出来作为 <code>left</code> 节点</li>
<li>创建一个 <code>Lit('b')</code> token</li>
<li>创建一个 <code>Any</code> token, 并将 <code>Lit('b')</code> pop 出来作为 <code>child</code> 节点.</li>
<li>当解析完所有字符后, 再遍历一次 <code>output</code>, 如果遇到 <code>Alt</code> token, 那么就把它的下一个 <code>token</code> (即 <code>Any</code>) 作为它的 <code>right</code> 节点.</li>
</ol>

<figure>
    
    
    <input type="checkbox" id="zoomCheck-11542" hidden>
    <label for="zoomCheck-11542">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/reinvent_regex_ast_alt.jpg"/> 
    
    
    </label>
</figure>

<p>实现代码如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">parse</span> <span class="o">=</span> <span class="p">(</span><span class="nx">text</span><span class="o">:</span> <span class="nx">string</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">result</span><span class="o">:</span> <span class="nx">Token</span><span class="p">[]</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">allTokens</span> <span class="o">=</span> <span class="nx">tokenize</span><span class="p">(</span><span class="nx">text</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">allTokens</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">allTokens</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">isLast</span> <span class="o">=</span> <span class="nx">i</span> <span class="o">===</span> <span class="nx">allTokens</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">handle</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span> <span class="nx">token</span><span class="p">,</span> <span class="nx">isLast</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">compress</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">handle</span> <span class="o">=</span> <span class="p">(</span><span class="nx">result</span><span class="o">:</span> <span class="nx">Token</span><span class="p">[],</span> <span class="nx">token</span><span class="o">:</span> <span class="nx">Token</span><span class="p">,</span> <span class="nx">isLast</span><span class="o">:</span> <span class="kr">boolean</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">kind</span> <span class="o">===</span> <span class="nx">TokenKind</span><span class="p">.</span><span class="nx">Lit</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">kind</span> <span class="o">===</span> <span class="nx">TokenKind</span><span class="p">.</span><span class="nx">Start</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">assert</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;Should not have start token after other tokens&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">kind</span> <span class="o">===</span> <span class="nx">TokenKind</span><span class="p">.</span><span class="nx">End</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">assert</span><span class="p">(</span><span class="nx">isLast</span><span class="p">,</span> <span class="sb">`Should not have end token before other tokens`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">kind</span> <span class="o">===</span> <span class="nx">TokenKind</span><span class="p">.</span><span class="nx">GroupStart</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">kind</span> <span class="o">===</span> <span class="nx">TokenKind</span><span class="p">.</span><span class="nx">GroupEnd</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">groupEnd</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span> <span class="nx">token</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">kind</span> <span class="o">===</span> <span class="nx">TokenKind</span><span class="p">.</span><span class="nx">Any</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">assert</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="sb">`No Operand for &#39;*&#39; (location </span><span class="si">${</span><span class="nx">token</span><span class="p">.</span><span class="nx">location</span><span class="si">}</span><span class="sb">)`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">token</span><span class="p">.</span><span class="nx">child</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">token</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">kind</span> <span class="o">===</span> <span class="nx">TokenKind</span><span class="p">.</span><span class="nx">Alt</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">assert</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="sb">`No Operand for &#39;|&#39; (location </span><span class="si">${</span><span class="nx">token</span><span class="p">.</span><span class="nx">location</span><span class="si">}</span><span class="sb">)`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">token</span><span class="p">.</span><span class="nx">left</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nx">token</span><span class="p">.</span><span class="nx">right</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">token</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">assert</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span> <span class="sb">`UNIMPLEMENTED`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">groupEnd</span> <span class="o">=</span> <span class="p">(</span><span class="nx">result</span><span class="o">:</span> <span class="nx">Token</span><span class="p">[],</span> <span class="nx">token</span><span class="o">:</span> <span class="nx">Token</span><span class="p">)</span><span class="o">:</span> <span class="nx">Token</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">group</span><span class="o">:</span> <span class="nx">Token</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">kind</span><span class="o">:</span> <span class="nx">TokenKind</span><span class="p">.</span><span class="nx">Group</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">location</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">end</span><span class="o">:</span> <span class="nx">token</span><span class="p">.</span><span class="nx">location</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">children</span><span class="o">:</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">assert</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="sb">`Unmatched end parenthesis (location </span><span class="si">${</span><span class="nx">token</span><span class="p">.</span><span class="nx">location</span><span class="si">}</span><span class="sb">)`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">child</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">child</span><span class="p">.</span><span class="nx">kind</span> <span class="o">===</span> <span class="nx">TokenKind</span><span class="p">.</span><span class="nx">GroupStart</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">group</span><span class="p">.</span><span class="nx">location</span> <span class="o">=</span> <span class="nx">child</span><span class="p">.</span><span class="nx">location</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">group</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">child</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">group</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// go through the output list to fill in the right side of Alts:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="nx">compress</span> <span class="o">=</span> <span class="p">(</span><span class="nx">raw</span><span class="o">:</span> <span class="nx">Token</span><span class="p">[])</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">cooked</span><span class="o">:</span> <span class="nx">Token</span><span class="p">[]</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="nx">raw</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">raw</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">kind</span> <span class="o">===</span> <span class="nx">TokenKind</span><span class="p">.</span><span class="nx">Alt</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">assert</span><span class="p">(</span><span class="nx">cooked</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="sb">`No right operand for alt (location </span><span class="si">${</span><span class="nx">token</span><span class="p">.</span><span class="nx">location</span><span class="si">}</span><span class="sb">)`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nx">token</span><span class="p">.</span><span class="nx">right</span> <span class="o">=</span> <span class="nx">cooked</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">cooked</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">cooked</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>对于表达式 <code>a|(bc)</code>, 输出的 AST 如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">kind</span><span class="o">:</span> <span class="nx">TokenKind</span><span class="p">.</span><span class="nx">Alt</span><span class="p">,</span> <span class="nx">location</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">left</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">kind</span><span class="o">:</span> <span class="nx">TokenKind</span><span class="p">.</span><span class="nx">Lit</span><span class="p">,</span> <span class="nx">location</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="s1">&#39;a&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nx">right</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">kind</span><span class="o">:</span> <span class="nx">TokenKind</span><span class="p">.</span><span class="nx">Group</span><span class="p">,</span> <span class="nx">location</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">end</span><span class="o">:</span> <span class="mi">5</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">children</span><span class="o">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span> <span class="nx">kind</span><span class="o">:</span> <span class="nx">TokenKind</span><span class="p">.</span><span class="nx">Lit</span><span class="p">,</span> <span class="nx">location</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="s1">&#39;b&#39;</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span> <span class="nx">kind</span><span class="o">:</span> <span class="nx">TokenKind</span><span class="p">.</span><span class="nx">Lit</span><span class="p">,</span> <span class="nx">location</span><span class="o">:</span> <span class="mi">4</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="s1">&#39;c&#39;</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="实例化"><span class="section-num">7</span> 实例化</h2>
<p>既然抽象语法树 AST 已经就绪了，我们就差最后一步了，把 AST 转变为我们的类实例.</p>
<p>还记得上文提到过, 不同的模式对应不同的类，然后通过 <code>rest</code> 指针指向下一个模式类，以此串成一个链表。</p>
<p>那么我们对于 <code>output</code> 这个包含多个 token 的列表，我们可以抽象成两个 token, 当前 token 和下一个 token:</p>
<p>假如我们有函数 <code>f</code> 可以把当前 <code>token</code> 初始化对应的模式类，我们只需要再把剩下的 token 列表初始化成 <code>rest</code>, 那么 <code>rest</code> 要怎么初始化呢？</p>
<p>只需要再调用 <code>f</code> 即可.</p>
<p>这不就是递归嘛! 是的，通过递归就很简单地把实例化也实现出来了:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">compile</span> <span class="o">=</span> <span class="p">(</span><span class="nx">text</span><span class="o">:</span> <span class="nx">string</span><span class="p">)</span><span class="o">:</span> <span class="nx">RegexBase</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">tokens</span><span class="o">:</span> <span class="nx">Token</span><span class="p">[]</span> <span class="o">=</span> <span class="nx">parse</span><span class="p">(</span><span class="nx">text</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">createObjectByAST</span><span class="p">(</span><span class="nx">tokens</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// return instances of classes derived from RegexBase by abstract syntax tree
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="nx">createObjectByAST</span> <span class="o">=</span> <span class="p">(</span><span class="nx">tokens</span><span class="o">:</span> <span class="nx">Token</span><span class="p">[])</span><span class="o">:</span> <span class="nx">RegexBase</span> <span class="o">|</span> <span class="kc">null</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nx">tokens</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">tokens</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">kind</span> <span class="o">===</span> <span class="nx">TokenKind</span><span class="p">.</span><span class="nx">Lit</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">Lit</span><span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span> <span class="nx">createObjectByAST</span><span class="p">(</span><span class="nx">tokens</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">kind</span> <span class="o">===</span> <span class="nx">TokenKind</span><span class="p">.</span><span class="nx">Start</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">Start</span><span class="p">(</span><span class="nx">createObjectByAST</span><span class="p">(</span><span class="nx">tokens</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">kind</span> <span class="o">===</span> <span class="nx">TokenKind</span><span class="p">.</span><span class="nx">End</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">assert</span><span class="p">(</span><span class="nx">tokens</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">,</span> <span class="sb">`Should not have end token before other tokens`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">End</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">kind</span> <span class="o">===</span> <span class="nx">TokenKind</span><span class="p">.</span><span class="nx">Alt</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">Alt</span><span class="p">(</span><span class="nx">createObjectByAST</span><span class="p">([</span><span class="nx">token</span><span class="p">.</span><span class="nx">left</span><span class="p">]),</span> <span class="nx">createObjectByAST</span><span class="p">([</span><span class="nx">token</span><span class="p">.</span><span class="nx">right</span><span class="p">]),</span> <span class="nx">createObjectByAST</span><span class="p">(</span><span class="nx">tokens</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">kind</span> <span class="o">===</span> <span class="nx">TokenKind</span><span class="p">.</span><span class="nx">Group</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">Group</span><span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">childToken</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">createObjectByAST</span><span class="p">([</span><span class="nx">childToken</span><span class="p">])),</span> <span class="nx">createObjectByAST</span><span class="p">(</span><span class="nx">tokens</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">kind</span> <span class="o">===</span> <span class="nx">TokenKind</span><span class="p">.</span><span class="nx">Any</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">Any</span><span class="p">(</span><span class="nx">createObjectByAST</span><span class="p">([</span><span class="nx">token</span><span class="p">.</span><span class="nx">child</span><span class="p">]),</span> <span class="nx">createObjectByAST</span><span class="p">(</span><span class="nx">tokens</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">assert</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span> <span class="sb">`UNKNOWN token type </span><span class="si">${</span><span class="nx">token</span><span class="p">.</span><span class="nx">kind</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="总结"><span class="section-num">8</span> 总结</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="nx">it</span><span class="p">.</span><span class="nx">each</span><span class="p">([</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)],</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="s1">&#39;^a&#39;</span><span class="p">,</span> <span class="s1">&#39;ab&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">Start</span><span class="p">(</span><span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">))],</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="s1">&#39;a$&#39;</span><span class="p">,</span> <span class="s1">&#39;ab&#39;</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="nx">End</span><span class="p">())],</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="s1">&#39;a*&#39;</span><span class="p">,</span> <span class="s1">&#39;baac&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">Any</span><span class="p">(</span><span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">))],</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="s1">&#39;ab+c&#39;</span><span class="p">,</span> <span class="s1">&#39;abc&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="nx">Plus</span><span class="p">(</span><span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">),</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">)))],</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="s1">&#39;ab+c&#39;</span><span class="p">,</span> <span class="s1">&#39;abxc&#39;</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="nx">Plus</span><span class="p">(</span><span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">),</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">)))],</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="s1">&#39;(ab)|(cd)&#39;</span><span class="p">,</span> <span class="s1">&#39;xaby&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">Alt</span><span class="p">(</span><span class="nx">Group</span><span class="p">([</span><span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">),</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)]),</span> <span class="nx">Group</span><span class="p">([</span><span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">),</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">)]))],</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="s1">&#39;a(b|c)d&#39;</span><span class="p">,</span> <span class="s1">&#39;xabdy&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="nx">Group</span><span class="p">([</span><span class="nx">Alt</span><span class="p">(</span><span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">),</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">))],</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">)))],</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="s1">&#39;ab?c&#39;</span><span class="p">,</span> <span class="s1">&#39;ac&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="nx">Opt</span><span class="p">(</span><span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">),</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">)))],</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="s1">&#39;ab?c&#39;</span><span class="p">,</span> <span class="s1">&#39;acc&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="nx">Opt</span><span class="p">(</span><span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">),</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">)))],</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="s2">&#34;[abcd]c&#34;</span><span class="p">,</span> <span class="s1">&#39;ac&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">CharClass</span><span class="p">([</span><span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">),</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">),</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">),</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">)],</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">))],</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="s2">&#34;c[abcd]&#34;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="nx">CharClass</span><span class="p">([</span><span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">),</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">),</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">),</span> <span class="nx">Lit</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">)]))],</span>
</span></span><span class="line"><span class="cl"><span class="p">])(</span><span class="s1">&#39;parse, compile and matcher test (&#34;%s&#34; &#34;%s&#34; &#34;%p&#34;)&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">pattern</span><span class="p">,</span> <span class="nx">text</span><span class="p">,</span> <span class="nx">expected</span><span class="p">,</span> <span class="nx">expectedMatcher</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">actualMatcher</span> <span class="o">=</span> <span class="nx">compile</span><span class="p">(</span><span class="nx">pattern</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nx">expect</span><span class="p">(</span><span class="nx">actualMatcher</span><span class="p">).</span><span class="nx">toStrictEqual</span><span class="p">(</span><span class="nx">expectedMatcher</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">actual</span> <span class="o">=</span> <span class="nx">actualMatcher</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">text</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nx">expect</span><span class="p">(</span><span class="nx">actual</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">expected</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>大功告成，终于将所有的功能都组装起来实现这个正则表达式引擎了, 除去前文提到的功能之外，还实现了 <code>\*</code> 转义特殊字符， <code>[xya]</code> 匹配 <code>x</code>, <code>y</code>, <code>z</code> 其中任意字符，以及 <code>*?</code> 实现惰性匹配的功能。</p>
<p>完整功能集的测试 case 可见 <a href="https://github.com/ramsayleung/reinvent/blob/master/__tests__/regular_expression/parser-test.ts">parser_test.ts</a></p>
<p>日常使用正则表达式的场景非常多，因为其强大的功能和表达能力，总会下意识觉得很难实现（当然，高性能的完整版本的确是非常有挑战性的）。</p>
<p>但是当自己把正则表达式引擎这个轮子拆开，再重新造一个出来之后，才感悟到：</p>
<p>「没有启程的路才会遥不可及」，很多时候，困难只是我们给自己设下的心理障碍。</p>
<p><a href="/zh/post/2025/reinvent_project/">回到本系列的目录</a></p>
<h2 id="参考"><span class="section-num">9</span> 参考</h2>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Stephen_Cole_Kleene">https://en.wikipedia.org/wiki/Stephen_Cole_Kleene</a></li>
<li><a href="https://en.wikipedia.org/wiki/Ed_%28software%29">https://en.wikipedia.org/wiki/Ed_(software)</a></li>
<li><a href="https://en.wikipedia.org/wiki/Grep">https://en.wikipedia.org/wiki/Grep</a></li>
<li><a href="https://third-bit.com/sdxjs/regex-parser/">https://third-bit.com/sdxjs/regex-parser/</a></li>
<li><a href="https://third-bit.com/sdxjs/pattern-matching/">https://third-bit.com/sdxjs/pattern-matching/</a></li>
</ul>
]]></content:encoded>
    </item>
  </channel>
</rss>
