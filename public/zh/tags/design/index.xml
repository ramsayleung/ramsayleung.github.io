<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>Design on è¿‡æ²³å’</title>
    <link>http://localhost:1313/zh/tags/design/</link>
    <description>Recent content in Design on è¿‡æ²³å’</description>
    <image>
      <title>è¿‡æ²³å’</title>
      <url>http://localhost:1313/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E</url>
      <link>http://localhost:1313/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E</link>
    </image>
    <generator>Hugo -- 0.146.7</generator>
    <language>zh</language>
    <copyright>See this site&amp;rsquo;s source code here, licensed under GPLv3 Â·</copyright>
    <lastBuildDate>Thu, 09 Jan 2025 19:10:19 -0800</lastBuildDate>
    <atom:link href="http://localhost:1313/zh/tags/design/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>The Non-designer&#39;s design book</title>
      <link>http://localhost:1313/zh/post/2021/the_nondesigners_design_book/</link>
      <pubDate>Sun, 17 Oct 2021 15:16:36 +0000</pubDate>
      <guid>http://localhost:1313/zh/post/2021/the_nondesigners_design_book/</guid>
      <description>&lt;h2 id=&#34;design-principle&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;1&lt;/span&gt; Design principle&lt;/h2&gt;
&lt;p&gt;åœ¨è°ˆè®ºå››ä¸ªè®¾è®¡çš„åŸºæœ¬å‡†åˆ™å‰, ä½œè€…å¼ºè°ƒäº†å…³äºå‘½åçš„é‡è¦æ€§.&lt;/p&gt;
&lt;p&gt;ä½œè€…ä¸¾äº†ä¸€ä¸ªä¾‹å­, åœ¨åœ£è¯èŠ‚, ä»–æ”¶åˆ°ä¸€æœ¬ä¹¦ä»‹ç»æ ‘æœ¨çš„åˆ†ç±», ä»–æ³¨æ„åˆ°ä¸€ç§å«Joshua treeçš„æ ‘, é€ å‹å¥‡ç‰¹. ä»–æƒ³, å¦‚æœæˆ‘çœ‹è¿‡, æˆ‘è‚¯å®šä¼šè®°å¾—, æ¯•ç«Ÿå½¢çŠ¶ç‰¹åˆ«. å½“ä»–èµ°å‡ºå®¶é—¨æ—¶, å‘ç°ç¤¾åŒº80%çš„é™¢å­éƒ½æœ‰è¿™ç§æ ‘, ä½†ä»–æ­¤å‰ä»æœªæ³¨æ„åˆ°. &lt;strong&gt;&lt;strong&gt;ä¸€æ—¦ä½ å¯ä»¥å«å‡ºå®ƒçš„åå­—, ä½ å°±å‘ç°å®ƒéšå¤„å¯è§&lt;/strong&gt;&lt;/strong&gt;&lt;/p&gt;</description>
      <content:encoded><![CDATA[<h2 id="design-principle"><span class="section-num">1</span> Design principle</h2>
<p>åœ¨è°ˆè®ºå››ä¸ªè®¾è®¡çš„åŸºæœ¬å‡†åˆ™å‰, ä½œè€…å¼ºè°ƒäº†å…³äºå‘½åçš„é‡è¦æ€§.</p>
<p>ä½œè€…ä¸¾äº†ä¸€ä¸ªä¾‹å­, åœ¨åœ£è¯èŠ‚, ä»–æ”¶åˆ°ä¸€æœ¬ä¹¦ä»‹ç»æ ‘æœ¨çš„åˆ†ç±», ä»–æ³¨æ„åˆ°ä¸€ç§å«Joshua treeçš„æ ‘, é€ å‹å¥‡ç‰¹. ä»–æƒ³, å¦‚æœæˆ‘çœ‹è¿‡, æˆ‘è‚¯å®šä¼šè®°å¾—, æ¯•ç«Ÿå½¢çŠ¶ç‰¹åˆ«. å½“ä»–èµ°å‡ºå®¶é—¨æ—¶, å‘ç°ç¤¾åŒº80%çš„é™¢å­éƒ½æœ‰è¿™ç§æ ‘, ä½†ä»–æ­¤å‰ä»æœªæ³¨æ„åˆ°. <strong><strong>ä¸€æ—¦ä½ å¯ä»¥å«å‡ºå®ƒçš„åå­—, ä½ å°±å‘ç°å®ƒéšå¤„å¯è§</strong></strong></p>
<blockquote>
<p>Once you can name something, you&rsquo;re conscious of it. You have power over it. You&rsquo;re in control. You own it.</p></blockquote>
<p>æ·±æœ‰ä½“ä¼š. æ ‘å°¤å¦‚æ­¤, è®¾è®¡å‡†åˆ™äº¦å¦‚æ˜¯.</p>
<p><strong><strong>Good design</strong></strong> is as easy as:</p>
<ul>
<li>Learn the basic principles: They&rsquo;re simpler than you might think</li>
<li>Recognize when you&rsquo;re not using them: Put it into words - name the problem</li>
<li>Apply the principles: Be amazed</li>
</ul>
<h3 id="proximity"><span class="section-num">1.1</span> Proximity</h3>
<p>The principle of Proximity states: <strong><strong>Group related item together</strong></strong>. æœ‰å…³è”çš„å…ƒç´ , ä½ç½®ä¸Šè®©å®ƒä»¬æ›´æ¥è¿‘, ä»¥è¡¨ç¤ºå®ƒä»¬æœ‰å…³è”çš„ä¸€ä¸ªç¾¤ç»„è€Œä¸æ˜¯è‹¥å¹²ä¸ªæ— å…³è”æ•£è½çš„å…ƒç´ </p>
<p>å½“ç„¶, æœ‰å…³è”æ‰æ”¾åœ¨ä¸€èµ·, æ²¡å…³è”å°±ä¸è¦ç¡¬æŒ¤è¿‡æ¥. ç•™ä¸‹è§†è§‰è·ç¦»è®©è¯»è€…å¯ä»¥åˆ¤åˆ«å‡ºä»–ä»¬çš„å…³ç³». è¿™ä¹Ÿå’Œç”Ÿæ´»ç»éªŒå»åˆ, å¯ä»¥ä»ä¸¤äººçš„ç‰©ç†è·ç¦»åˆ¤åˆ«å‡ºä»–ä»¬çš„å…³ç³»</p>

<figure><a href="/ox-hugo/mon_and_son_1.png">
    
    
    <input type="checkbox" id="zoomCheck-ffc82" hidden>
    <label for="zoomCheck-ffc82">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/mon_and_son_1.png"/> 
    
    
    </label></a>
</figure>


<figure><a href="/ox-hugo/mon_and_son_2.png">
    
    
    <input type="checkbox" id="zoomCheck-66d20" hidden>
    <label for="zoomCheck-66d20">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/mon_and_son_2.png"/> 
    
    
    </label></a>
</figure>

<p>å¦‚ä¸‹ä¾‹å­:</p>

<figure><a href="/ox-hugo/card_1.png">
    
    
    <input type="checkbox" id="zoomCheck-bcda1" hidden>
    <label for="zoomCheck-bcda1">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/card_1.png"/> 
    
    
    </label></a>
</figure>


<figure><a href="/ox-hugo/card_2.png">
    
    
    <input type="checkbox" id="zoomCheck-a9945" hidden>
    <label for="zoomCheck-a9945">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/card_2.png"/> 
    
    
    </label></a>
</figure>


<figure><a href="/ox-hugo/post_card_1.png">
    
    
    <input type="checkbox" id="zoomCheck-a7d75" hidden>
    <label for="zoomCheck-a7d75">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/post_card_1.png"/> 
    
    
    </label></a>
</figure>


<figure><a href="/ox-hugo/post_card_2.png">
    
    
    <input type="checkbox" id="zoomCheck-73eee" hidden>
    <label for="zoomCheck-73eee">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/post_card_2.png"/> 
    
    
    </label></a>
</figure>


<figure><a href="/ox-hugo/poster_1.png">
    
    
    <input type="checkbox" id="zoomCheck-d830e" hidden>
    <label for="zoomCheck-d830e">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/poster_1.png"/> 
    
    
    </label></a>
</figure>


<figure><a href="/ox-hugo/poster_2.png">
    
    
    <input type="checkbox" id="zoomCheck-a99e9" hidden>
    <label for="zoomCheck-a99e9">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/poster_2.png"/> 
    
    
    </label></a>
</figure>

<p>The idea of proximity doesn&rsquo;t mean that <em>everything</em> is closer together; it means elements that are <em>ntellectually connected</em>, those that have some sort of communication relationship, should also be <em>visually connected</em>.</p>
<p>It&rsquo;s all about space. The principle of Proximity helps you focus on space and what it can do for communication</p>
<h3 id="alignment"><span class="section-num">1.2</span> Alignment</h3>
<p>The Principle of Alighment states: <strong><strong>Nothing should be placed on the page arbitrarily. Every item should have a visual connection with something else on the page.</strong></strong> The principle of alignment forces you to be conscious &ndash; no longer can you just throw things on the page and see where they stick</p>
<p>é€šè¿‡å¯¹é½, å¯ä»¥è®©å…ƒç´ ä¹‹é—´äº§ç”Ÿè”ç³», ä½¿æ‚ä¹±çš„è®¾è®¡å˜å¾—æœ‰æ¡ç†, é€šè¿‡å¸ƒå±€æ¥å±•ç°å…³è”. å¦‚ä¸‹å›¾åˆ†æ</p>

<figure><a href="/ox-hugo/card_1.png">
    
    
    <input type="checkbox" id="zoomCheck-bcda1" hidden>
    <label for="zoomCheck-bcda1">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/card_1.png"/> 
    
    
    </label></a>
</figure>


<figure><a href="/ox-hugo/card_2.png">
    
    
    <input type="checkbox" id="zoomCheck-a9945" hidden>
    <label for="zoomCheck-a9945">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/card_2.png"/> 
    
    
    </label></a>
</figure>


<figure><a href="/ox-hugo/card_3.png">
    
    
    <input type="checkbox" id="zoomCheck-6f7c8" hidden>
    <label for="zoomCheck-6f7c8">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/card_3.png"/> 
    
    
    </label></a>
</figure>

<p>åˆæˆ–è€…æ˜¯:</p>

<figure><a href="/ox-hugo/report_cover_1.png">
    
    
    <input type="checkbox" id="zoomCheck-a755d" hidden>
    <label for="zoomCheck-a755d">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/report_cover_1.png"/> 
    
    
    </label></a>
</figure>


<figure><a href="/ox-hugo/report_cover2.png">
    
    
    <input type="checkbox" id="zoomCheck-d12c2" hidden>
    <label for="zoomCheck-d12c2">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/report_cover2.png"/> 
    
    
    </label></a>
</figure>

<p>é€šå¸¸æ¥è¯´, å·¦å¯¹é½æˆ–è€…å³å¯¹é½ä¼šæ¯”å±…ä¸­å¯¹é½æœ‰æ›´å¼ºçƒˆçš„è§†è§‰æ•ˆæœ, å› ä¸ºå±…ä¸­å¯¹é½ä¸¤è¾¹ä¸å¯¹é½, å°±ä¼šè®©æˆ‘æœ‰ç§æœªå¯¹é½çš„æ„Ÿè§‰</p>

<figure><a href="/ox-hugo/center_align.png">
    
    
    <input type="checkbox" id="zoomCheck-25559" hidden>
    <label for="zoomCheck-25559">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/center_align.png"/> 
    
    
    </label></a>
</figure>

<p>å¯¹äºé¡µé¢, å¯åˆ†æå…¶é¡µé¢å…ƒç´ çš„å¯¹é½, ç„¶åä¿®æ­£æˆç»Ÿä¸€çš„å¯¹é½æ–¹å¼. è€Œä¸‹å›¾çš„ä¹¦é¡µ, å·¦å³éƒ½å¯¹é½äº†, è¿˜å¢åŠ äº†ç¼©è¿›å’Œè¡Œåˆ†éš”, çœ‹èµ·æ¥å°±æ¸…æ™°å¤šäº†.</p>

<figure><a href="/ox-hugo/book_page_1.png">
    
    
    <input type="checkbox" id="zoomCheck-50800" hidden>
    <label for="zoomCheck-50800">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/book_page_1.png"/> 
    
    
    </label></a>
</figure>


<figure><a href="/ox-hugo/book_page_2.png">
    
    
    <input type="checkbox" id="zoomCheck-7bdb3" hidden>
    <label for="zoomCheck-7bdb3">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/book_page_2.png"/> 
    
    
    </label></a>
</figure>

<p>I am giving you a number of rules here, and it&rsquo;s true that rules are made to be broken. But remember the <strong><strong>Rule about Breaking Rules: You must know what the rule is before you can break it</strong></strong></p>
<h3 id="repetition"><span class="section-num">1.3</span> Repetition</h3>
<p>The Principle of Pepetition States: <strong><strong>Repeat some aspect of the design throught the entire piece</strong></strong>. The repetitive element may be a bold font, a thick rule(line), a certain bullet, design element, color, format, spatial relationships, etc. It can be anything that a reader will visually recognize</p>
<p>é‡å¤æ˜¯ä¸€è‡´æ€§çš„ä¸€ç§å®ç°, ä½†é‡å¤å¹¶ä¸æ­¢äºä¸€è‡´æ€§, å®ƒè¿˜æ˜¯ä¸€ç§ç»Ÿä¸€è®¾è®¡ä¸­å„ä¸ªå…ƒç´ çš„æœ‰åŠ›æ‰‹æ®µ. è¿˜æ˜¯ç†Ÿæ‚‰çš„åç‰‡:</p>

<figure><a href="/ox-hugo/card_1.png">
    
    
    <input type="checkbox" id="zoomCheck-bcda1" hidden>
    <label for="zoomCheck-bcda1">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/card_1.png"/> 
    
    
    </label></a>
</figure>


<figure><a href="/ox-hugo/card_2.png">
    
    
    <input type="checkbox" id="zoomCheck-a9945" hidden>
    <label for="zoomCheck-a9945">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/card_2.png"/> 
    
    
    </label></a>
</figure>

<h3 id="contrast"><span class="section-num">1.4</span> Contrast</h3>
<p>The Principle of Contrast states: <strong><strong>Contrast Various elements of the piece to draw a reader&rsquo;s eye itno the page</strong></strong>. If two items are not exactly the same, then make them different. Really different</p>
<p>å¯¹æ¯”æœ‰å¾ˆå¤šæ‰‹æ³•, è¯¸å¦‚å¤§ä¸å°, å¤å¤ä¸æ–°æ½®, å¼ºä¸å¼±, æ˜ä¸æš—, ç²—ç³™ä¸ç»†æ»‘, æ°´å¹³ä¸å‚ç›´ç­‰ç­‰.</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯, å¦‚æœä¸¤ä¸ªå…ƒç´ æœ‰åŒºåˆ†, ä½†æœ¬è´¨æ— å·®åˆ«, é‚£å°±ä¸æ˜¯ <em>contrast</em>, è€Œæ˜¯ <em>conflict</em>.</p>

<figure><a href="/ox-hugo/conflict.png">
    
    
    <input type="checkbox" id="zoomCheck-dd672" hidden>
    <label for="zoomCheck-dd672">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/conflict.png"/> 
    
    
    </label></a>
</figure>


<figure><a href="/ox-hugo/contrast.png">
    
    
    <input type="checkbox" id="zoomCheck-be993" hidden>
    <label for="zoomCheck-be993">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/contrast.png"/> 
    
    
    </label></a>
</figure>


<figure><a href="/ox-hugo/newsletter1.png">
    
    
    <input type="checkbox" id="zoomCheck-8517b" hidden>
    <label for="zoomCheck-8517b">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/newsletter1.png"/> 
    
    
    </label></a>
</figure>


<figure><a href="/ox-hugo/newsletter2.png">
    
    
    <input type="checkbox" id="zoomCheck-b2445" hidden>
    <label for="zoomCheck-b2445">
    
    
    <img class="zoomCheck" loading="lazy" src="/ox-hugo/newsletter2.png"/> 
    
    
    </label></a>
</figure>

<p>There is one more general guiding principle of Design(and of Life):
<strong><strong>Don&rsquo;t be wimp</strong></strong></p>
<p>çªç„¶æ„è¯†åˆ°, æœ¬ä¹¦çš„PDF ç‰ˆæœ¬çš„æ’ç‰ˆå’Œå­—æ®µ, å›¾ç‰‡ä¹Ÿæ˜¯ç›¸å½“èˆ’æœçš„</p>
<h2 id="design-with-type"><span class="section-num">2</span> Design with Type</h2>
<p>æ¥ä¸‹æ¥å¤§éƒ¨åˆ†å†…å®¹éƒ½å…³äºType, å…³äºå°åˆ·, å…³äºå­—ä½“ç§ç±», ä¸æ˜¯å¾ˆæ„Ÿå…´è¶£, æ‰€ä»¥å°±è‰è‰æ¶‰çŒè¿‡.</p>
<div center class="qr-container">
<img src="/ox-hugo/qrcode_gh_e06d750e626f_1.jpg" alt="qrcode_gh_e06d750e626f_1.jpg" width="160px" height="160px" center="t" class="qr-container" />
å…¬å·åŒæ­¥æ›´æ–°ï¼Œæ¬¢è¿å…³æ³¨ğŸ‘»
</div>
]]></content:encoded>
    </item>
    <item>
      <title>å…³äºåˆ†å¸ƒå¼ç³»ç»Ÿå”¯ä¸€IDçš„æ¢ç©¶</title>
      <link>http://localhost:1313/zh/post/2017/distributed_system_unique_id/</link>
      <pubDate>Tue, 23 May 2017 00:00:00 -0700</pubDate>
      <guid>http://localhost:1313/zh/post/2017/distributed_system_unique_id/</guid>
      <description>An discussion about unique id in distributed system</description>
      <content:encoded><![CDATA[<p>æœ€è¿‘æˆ‘éœ€è¦ä¸ºè¿è¡Œçš„åˆ†å¸ƒå¼ç³»ç»ŸæŸéƒ¨åˆ†æ¨¡å—æ„é€ ç³»ç»Ÿå”¯ä¸€çš„ID, è€Œ ID éœ€è¦æ˜¯æ•°å­—çš„å½¢å¼ï¼Œå¹¶åº”è¯¥å°½é‡çš„çŸ­ã€‚ä¸å¾—ä¸è¯´ï¼Œè¿™æ˜¯ä¸€ä¸ªæœ‰è¶£çš„é—®é¢˜</p>
<h2 id="è‹¥å¹²å®ç°ç­–ç•¥"><span class="section-num">1</span> è‹¥å¹²å®ç°ç­–ç•¥</h2>
<p>æŸ¥é˜…å®Œç›¸å…³çš„èµ„æ–™ï¼Œå‘ç°ä¸ºåˆ†å¸ƒå¼ç³»ç»Ÿç”Ÿæˆå”¯ä¸€ ID æ–¹æ³•æŒºå¤šçš„ï¼Œä¾‹å¦‚ï¼š</p>
<ul>
<li>UUID</li>
<li>ä½¿ç”¨ä¸€ä¸ª ticket server, å³ä¸­å¤®çš„æœåŠ¡å™¨ï¼Œå„ä¸ªèŠ‚ç‚¹éƒ½ä»ä¸­å¤®æœåŠ¡å™¨å– ID</li>
<li>Twitter çš„ Snowflake ç®—æ³•</li>
<li>Boundary çš„ flake ç®—æ³•</li>
</ul>
<p>å…¶ä¸­ UUID ç”Ÿæˆçš„ ID æ˜¯å­—ç¬¦ä¸²ï¼‹æ•°å­—ï¼Œä¸é€‚ç”¨ï¼› ticket server çš„åšæ³•ç•¥éº»çƒ¦ï¼Œæˆ‘
å¹¶ä¸æƒ³ä¸ºäº†ä¸ª ID è¿˜è¦å»è®¿é—®ä¸­å¤®æœåŠ¡å™¨ï¼›å‰©ä¸‹å°±æ˜¯ Snowflake å’Œ flake ç®—æ³•ï¼Œ
flake ç®—æ³•ç”Ÿæˆçš„æ˜¯ 128 ä½çš„ ID, ç•¥é•¿ï¼›æ‰€ä»¥æœ€åæˆ‘é€‰æ‹©äº† Snowflake ç®—æ³•ã€‚</p>
<h2 id="snowflake-ç®—æ³•å®ç°"><span class="section-num">2</span> Snowflake ç®—æ³•å®ç°</h2>
<p>æœ¬æ¥ Twitter çš„ç®—æ³•æ˜¯æœ‰ç›¸åº”å®ç°çš„ï¼Œä¸è¿‡åæ¥åˆ é™¤äº†ï¼›æˆ‘å°±åªå¥½è‡ªå·±å·èµ·è¢–å­è‡ªå·± å®ç°äº†:(</p>
<p>è™½è¯´ Twitter æ²¡æœ‰äº†ç›¸åº”çš„å®ç°ï¼Œä½†æ˜¯ Snowflake ç®—æ³•åŸç†å¾ˆç®€å•ï¼Œå®ç°èµ·æ¥å¹¶ä¸éš¾.</p>
<h3 id="snowflake-ç®—æ³•"><span class="section-num">2.1</span> Snowflake ç®—æ³•</h3>
<p>Snowflake ç®—æ³•ç”Ÿæˆ 64 ä½çš„ ID, ID çš„æ ¼å¼æ˜¯ 41 ä½çš„æ—¶é—´æˆ³ + 10 ä½çš„æˆªæ–­çš„ mac åœ°å€ + 12 ä½é€’å¢åºåˆ—ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;id format =&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">timestamp | machineId|sequence
</span></span></span><span class="line"><span class="cl"><span class="s2">41        | 10       |12
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="snowflake-å®ç°"><span class="section-num">2.2</span> Snowflake å®ç°</h3>
<h4 id="ç”Ÿæˆæ—¶é—´æˆ³"><span class="section-num">2.2.1</span> ç”Ÿæˆæ—¶é—´æˆ³</h4>
<p>Java å†…ç½®äº†ç”Ÿæˆç²¾ç¡®åˆ°æ¯«ç§’çš„æ—¶é—´æˆ³çš„æ–¹æ³•ï¼Œéå¸¸ä¾¿åˆ©ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kt">long</span><span class="w"> </span><span class="n">timestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="ç”Ÿæˆé€’å¢åºåˆ—"><span class="section-num">2.2.2</span> ç”Ÿæˆé€’å¢åºåˆ—</h4>
<p>12 bits çš„æœ€å¤§å€¼æ˜¯ 2**12=4096, æ‰€ä»¥ç”Ÿæˆé€’å¢åºåˆ—ä¹Ÿéå¸¸ç®€å•ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">sequenceMax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">4096</span><span class="p">;</span><span class="w"> </span><span class="c1">//2**12</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">private</span><span class="w"> </span><span class="kd">volatile</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">sequence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0L</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">generateId</span><span class="p">(){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//do something</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">sequence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">sequence</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">1</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">sequenceMax</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//do something</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="è·å–-mac-åœ°å€"><span class="section-num">2.2.3</span> è·å– Mac åœ°å€</h4>
<p>æˆ‘ä»¬é€šè¿‡è·å–å½“å‰æœºå™¨çš„ IP åœ°å€ä»¥è·å–å¯¹åº”çš„ç‰©ç†åœ°å€ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">protected</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="nf">getMachineId</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">GetHardwareIdFailedException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">InetAddress</span><span class="w"> </span><span class="n">ip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">InetAddress</span><span class="p">.</span><span class="na">getLocalHost</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">NetworkInterface</span><span class="w"> </span><span class="n">network</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NetworkInterface</span><span class="p">.</span><span class="na">getByInetAddress</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="n">id</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">network</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">mac</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">network</span><span class="p">.</span><span class="na">getHardwareAddress</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">((</span><span class="n">0x000000FF</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="w"> </span><span class="n">mac</span><span class="o">[</span><span class="n">mac</span><span class="p">.</span><span class="na">length</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">1</span><span class="o">]</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                 </span><span class="p">(</span><span class="n">0x0000FF00</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(((</span><span class="kt">long</span><span class="p">)</span><span class="w"> </span><span class="n">mac</span><span class="o">[</span><span class="n">mac</span><span class="p">.</span><span class="na">length</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">2</span><span class="o">]</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">8</span><span class="p">)))</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">6</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">id</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">SocketException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">GetHardwareIdFailedException</span><span class="p">(</span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">UnknownHostException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">GetHardwareIdFailedException</span><span class="p">(</span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>åˆå› ä¸º Mac åœ°å€æ˜¯6 ä¸ªå­—èŠ‚ (48 bits)ï¼Œè€Œéœ€è¦çš„åªæ˜¯ 10 bit, æ‰€ä»¥éœ€è¦å–æœ€ä½ä½çš„ 2ä¸ªå­—èŠ‚ (16 bits)ï¼Œç„¶åå³ç§» 6 bits ä»¥è·å– 10 ä¸ª bits çš„ Macåœ°å€</p>
<h3 id="snowflake-å®Œæ•´ä»£ç "><span class="section-num">2.3</span> Snowflake å®Œæ•´ä»£ç </h3>
<p>ä¸‹é¢æ˜¯ Snowflake çš„ Java å®ç°ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">IdGenerator</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//   id format  =&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//   timestamp |datacenter | sequence</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//   41        |10         |  12</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">sequenceBits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">12</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">machineIdBits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">10L</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">MaxMachineId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">1L</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="p">(</span><span class="o">-</span><span class="n">1L</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">machineIdBits</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">machineIdShift</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sequenceBits</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestampLeftShift</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sequenceBits</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">machineIdBits</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">lock</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">twepoch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">1288834974657L</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">machineId</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">sequenceMax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">4096</span><span class="p">;</span><span class="w"> </span><span class="c1">//2**12</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">volatile</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">lastTimestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">1L</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">volatile</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">sequence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0L</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">volatile</span><span class="w"> </span><span class="n">IdGenerator</span><span class="w">  </span><span class="n">instance</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">IdGenerator</span><span class="w"> </span><span class="nf">getInstance</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">IdGenerator</span><span class="w"> </span><span class="n">generator</span><span class="o">=</span><span class="n">instance</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">instance</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">synchronized</span><span class="p">(</span><span class="n">lock</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">generator</span><span class="o">=</span><span class="n">instance</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">if</span><span class="p">(</span><span class="n">generator</span><span class="o">==</span><span class="kc">null</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">generator</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">IdGenerator</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">instance</span><span class="o">=</span><span class="n">generator</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">generator</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="nf">IdGenerator</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">machineId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getMachineId</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">machineId</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MaxMachineId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">machineId</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&#34;machineId &gt; MaxMachineId&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">synchronized</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="nf">generateLongId</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="n">timestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">timestamp</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">lastTimestamp</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                </span><span class="s">&#34;Clock moved backwards.  Refusing to generate id for &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                                                                          </span><span class="n">lastTimestamp</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">timestamp</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34; milliseconds.&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lastTimestamp</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">timestamp</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">sequence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">sequence</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">1</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">sequenceMax</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sequence</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">timestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tillNextMillis</span><span class="p">(</span><span class="n">lastTimestamp</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">sequence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">lastTimestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">timestamp</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Long</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">timestamp</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">twepoch</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">timestampLeftShift</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">(</span><span class="n">machineId</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">machineIdShift</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">sequence</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">id</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="nf">tillNextMillis</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">lastTimestamp</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="n">timestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">timestamp</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">lastTimestamp</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">timestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">timestamp</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="nf">getMachineId</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">GetHardwareIdFailedException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">InetAddress</span><span class="w"> </span><span class="n">ip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">InetAddress</span><span class="p">.</span><span class="na">getLocalHost</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">NetworkInterface</span><span class="w"> </span><span class="n">network</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NetworkInterface</span><span class="p">.</span><span class="na">getByInetAddress</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kt">long</span><span class="w"> </span><span class="n">id</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">network</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">mac</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">network</span><span class="p">.</span><span class="na">getHardwareAddress</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">((</span><span class="n">0x000000FF</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="w"> </span><span class="n">mac</span><span class="o">[</span><span class="n">mac</span><span class="p">.</span><span class="na">length</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">1</span><span class="o">]</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                     </span><span class="p">(</span><span class="n">0x0000FF00</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(((</span><span class="kt">long</span><span class="p">)</span><span class="w"> </span><span class="n">mac</span><span class="o">[</span><span class="n">mac</span><span class="p">.</span><span class="na">length</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">2</span><span class="o">]</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">8</span><span class="p">)))</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">6</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">id</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">SocketException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">GetHardwareIdFailedException</span><span class="p">(</span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">UnknownHostException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">GetHardwareIdFailedException</span><span class="p">(</span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>æ­£å¦‚æˆ‘æ‰€è¨€ï¼Œç®—æ³•å¹¶ä¸éš¾ï¼Œå°±æ˜¯åˆ†åˆ«è·å–æ—¶é—´æˆ³ï¼Œ mac åœ°å€ï¼Œå’Œé€’å¢åºåˆ—å·ï¼Œç„¶åç§»ä½å¾—åˆ° ID. ä½†æ˜¯åœ¨å…·ä½“çš„å®ç°ä¸­è¿˜æ˜¯æœ‰ä¸€äº›éœ€è¦æ³¨æ„çš„ç»†èŠ‚çš„ã€‚</p>
<h4 id="çº¿ç¨‹åŒæ­¥"><span class="section-num">2.3.1</span> çº¿ç¨‹åŒæ­¥</h4>
<p>å› ä¸ºç®—æ³•ä¸­ä½¿ç”¨åˆ°é€’å¢çš„åºåˆ—å·æ¥ç”Ÿæˆ ID,è€Œåœ¨å®é™…çš„å¼€å‘æˆ–è€…ç”Ÿäº§ç¯å¢ƒä¸­å¾ˆå¯èƒ½ä¸æ­¢ä¸€ä¸ªçº¿ç¨‹åœ¨ä½¿ç”¨ IdGenerator è¿™ä¸ªç±»ï¼Œå¦‚æœè¿™æ ·å°±å¾ˆå®¹æ˜“å‡ºç°ä¸åŒçº¿ç¨‹çš„ç«äº‰é—®é¢˜ï¼Œæ‰€ä»¥æˆ‘ä½¿ç”¨äº†å•ä¾‹æ¨¡å¼æ¥ç”Ÿæˆ ID, ä¸€æ–¹é¢æ›´ç¬¦åˆç”Ÿæˆå™¨çš„è®¾è®¡ï¼Œå¦ä¸€æ–¹é¢å› ä¸ºå¯¹ç”Ÿæˆ IDçš„æ–¹æ³•è¿›è¡Œäº†åŒæ­¥ï¼Œå°±ä¿è¯äº†ä¸ä¼šå‡ºç°ç«äº‰é—®é¢˜ã€‚</p>
<h4 id="åŒä¸€æ¯«ç§’ç”Ÿæˆå¤šä¸ª-id"><span class="section-num">2.3.2</span> åŒä¸€æ¯«ç§’ç”Ÿæˆå¤šä¸ª ID</h4>
<p>å› ä¸ºåºåˆ—å·é•¿åº¦æ˜¯ 12ä¸ª bit, é‚£ä¹ˆåºåˆ—å·æœ€å¤§å€¼å°±æ˜¯2**12=4096äº†ï¼Œæ­¤å¤–æ—¶é—´æˆ³æ˜¯ç²¾ç¡®åˆ°æ¯«ç§’çš„ï¼Œè¿™å°±æ˜¯æ„å‘³ç€ï¼Œå½“ä¸€æ¯«ç§’å†…ï¼Œäº§ç”Ÿè¶…è¿‡ 4096 ä¸ª ID çš„æ—¶å€™å°±ä¼šå‡ºç°é‡å¤çš„ID.</p>
<p>è¿™æ ·çš„æƒ…å†µå¹¶ä¸æ˜¯ä¸å¯èƒ½å‘ç”Ÿï¼Œæ‰€ä»¥è¦å¯¹æ­¤è¿›è¡Œå¤„ç†ï¼›æ‰€ä»¥åœ¨ <em>generateId()</em> å‡½æ•°ä¸­ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lastTimestamp</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">timestamp</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">sequence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">sequence</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">1</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">sequenceMax</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sequence</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">timestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tillNextMillis</span><span class="p">(</span><span class="n">lastTimestamp</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>æœ‰ä»¥ä¸Šçš„ä¸€æ®µä»£ç ã€‚å½“ç°åœ¨çš„æ—¶é—´æˆ³ä¸ä¹‹å‰çš„æ—¶é—´æˆ³ä¸€è‡´ï¼Œé‚£ä¹ˆå°±æ„å‘³ç€è¿˜æ˜¯åŒä¸€æ¯«ç§’ï¼Œå¦‚æœåºåˆ—å·ä¸º 0, å°±è¯´æ˜å·²ç»äº§ç”Ÿäº† 4096 ä¸ª IDäº†ï¼Œç»§ç»­äº§ç”Ÿ ID,å°±ä¼šå‡ºç°é‡å¤ ID, æ‰€ä»¥è¦ç­‰å¾…ä¸€æ¯«ç§’ï¼Œè¿™ä¸ªå°±æ˜¯ <em>tillNextMills()</em> å‡½æ•°çš„ä½œç”¨äº†ã€‚</p>
<h2 id="å°ç»“"><span class="section-num">3</span> å°ç»“</h2>
<p>ç®—æ³•è™½ç„¶ç®€å•ï¼Œä½†æ˜¯åœ¨æ‰¾åˆ° Snowflake ç®—æ³•ä¹‹å‰ï¼Œæˆ‘å°è¯•äº†æŒºå¤šçš„ç®—æ³•ï¼Œä½†æ˜¯éƒ½æ˜¯å› ä¸ºä¸ç¬¦åˆè¦æ±‚è€Œè¢«ä¸€ä¸€å¦å†³ï¼Œ è€Œ Snowflake ç®—æ³•è™½ç„¶ç®€å•ï¼Œä½†æ˜¯èƒœåœ¨å®ç”¨ã€‚</p>
<p>æœ€åé™„ä¸Šæˆ‘å†™çš„ snowflake ç®—æ³•çš„ Python å®ç°ï¼š <a href="https://github.com/ramsayleung/snowflake">Snowfloke</a></p>
<div center class="qr-container">
<img src="/ox-hugo/qrcode_gh_e06d750e626f_1.jpg" alt="qrcode_gh_e06d750e626f_1.jpg" width="160px" height="160px" center="t" class="qr-container" />
å…¬å·åŒæ­¥æ›´æ–°ï¼Œæ¬¢è¿å…³æ³¨ğŸ‘»
</div>
]]></content:encoded>
    </item>
  </channel>
</rss>
